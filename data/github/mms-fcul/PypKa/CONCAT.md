[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/mms-fcul/PypKa/blob/master/examples/notebook/pypka.ipynb) [![CircleCI](https://circleci.com/gh/mms-fcul/PypKa.svg?style=svg)](https://circleci.com/gh/mms-fcul/PypKa) [![Codacy Badge](https://app.codacy.com/project/badge/Grade/59a058e4bf0846f18d9d1f6b16a4a0e5)](https://www.codacy.com/gh/mms-fcul/PypKa/dashboard?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=mms-fcul/PypKa&amp;utm_campaign=Badge_Grade) [![Documentation Status](https://readthedocs.org/projects/pypka/badge/?version=latest)](https://pypka.readthedocs.io/en/latest/?badge=latest)

[![PyPI version](https://badge.fury.io/py/pypka.svg)](https://badge.fury.io/py/pypka)  [![PyPI - Downloads](https://img.shields.io/pypi/dm/pypKa)](https://badge.fury.io/py/pypKa)

# PypKa

A python module for flexible Poisson-Boltzmann based pKa calculations with proton tautomerism
DOI: <a href="https://doi.org/10.1021/acs.jcim.0c00718">10.1021/acs.jcim.0c00718</a>

```bibtex
@article{reis2020jcim,
author = {Reis, Pedro B. P. S. and Vila-Viçosa, Diogo and Rocchia, Walter and Machuqueiro, Miguel},
title = {PypKa: A Flexible Python Module for Poisson–Boltzmann-Based pKa Calculations},
journal = {Journal of Chemical Information and Modeling},
volume = {60},
number = {10},
pages = {4442-4448},
year = {2020},
doi = {10.1021/acs.jcim.0c00718}
}
```

## Documentation

  Documentation can be found [here](https://pypka.readthedocs.io/en/latest/)

  Starting templates for the the API and CLI usage can be found [here](https://pypka.readthedocs.io/en/latest/example.html) while a online notebook is hosted at [Google Colab](https://colab.research.google.com/github/mms-fcul/PypKa/blob/master/pypka/example/notebook/pypka.ipynb)


## Contributing

Contributions are encouraged, and they are greatly appreciated!

You can contribute in many ways:

* Report Bugs
* Fix Bugs
* Implement Features
* Write Documentation
* Submit Feedback

For more info check [CONTRIBUTING](./CONTRIBUTING.rst)

## License

  pypka is distributed under a [LGPL-3.0](./LICENSE), however delphi4py depends on
  DelPhi which is proprietary. To use DelPhi the user is required to
  download the DelPhi license
  [here](https://honiglab.c2b2.columbia.edu/software/cgi-bin/software.pl?input=DelPhi)

## Contacts

  Please submit a github issue to report bugs and to request new features.
  Alternatively you may find the developer [here](mailto:pdreis@fc.ul.pt). Please visit ou [website](http://mms.rd.ciencias.ulisboa.pt/) for more information.
# Adding extra residues

For demonstration purposes, we will add an FMOC residue to the CHARMM36m FF for which the parameters have been kindly supplied by Alexander van Teijlingen.

DataBaseT.crg and DataBaseT.siz are the main files where the charges and radii of atoms have to be added.

The new DataBaseT files will be generated by extend_db.py (tmp.crg and tmp.siz) provided one follows the steps describe below.

If you believe your residue could benefit other users please create a pull request on GitHub or send the new parameters to the developers directly.


### Add residue block to ffG54a7pHt.rtp file

The lines should adhere to GROMACS .rtp file logic. Please use unique atom types to describe your residues in order to avoid clashes with previously declared atoms.

```
# EXTRA RESIDUES

[ CHO ] ; - adapted from ATB entry M81X
 [ atoms ]
     H3'  H       0.450 0
      O3  OAlc   -0.710 0
      C3  C       0.230 0
      H3  HC      0.040 0
      C1  CH2     0.080 0
      C2  CH2    -0.080 0
      C4  CH2    -0.010 0
```


### Add atom types to ffG54a7pHtnb.itp

Any new atom types must also be added to the nonbonded parameters file under the section "nonbond_params". Only the interaction with OW is necessary, in order to calculate radii.

```
  OW     OAlc 1  0.002155371     1.7853e-06      ; ATB entry M81X
```


### Add placeholder info in DataBaseT_old.crg and DataBaseT_old.siz

```
H3'   CHO       X.XXX
O3    CHO       X.XXX
C3    CHO       X.XXX
H3    CHO       X.XXX
C1    CHO       X.XXX
C2    CHO       X.XXX
C4    CHO       X.XXX
```


### Run extend_db

```
python3 extend_db.py
```

New tmp.crg and tmp.siz have been generated. Please inspect them to check the new residue has been added at the bottom correctly. After the visual inspection, rename them DataBaseT.crg and DataBaseT.siz, respectively.

```
mv tmp.crg DataBaseT.crg
mv tmp.siz DataBaseT.siz
```


### Add residue to pdb2pqr

The residue also needs to be added to PDB2PQR's database of residues, so that is not discarded on the preprocessing step.

/pdb2pqr/dat/CHARMM.DAT
```

# FMOC - Alexander van Teijlingen 07-12-2020
FMO     C1    0.01  0.01    C1
FMO     H1    0.01  0.01    H1
FMO     C2    0.01  0.01    C2
FMO     H2    0.01  0.01    H2
```# Adding extra residues

For demonstration purposes, we will add an FMOC residue to the CHARMM36m FF for which the parameters have been kindly supplied by Alexander van Teijlingen.

DataBaseT.crg and DataBaseT.siz are the main files where the charges and radii of atoms have to be added.

The new DataBaseT files will be generated by extend_db.py (tmp.crg and tmp.siz) provided one follows the steps describe below.

If you believe your residue could benefit other users please create a pull request on GitHub or send the new parameters to the developers directly.


### Add residue block to aa.rtp file

The lines should adhere to GROMACS .rtp file logic. Please use unique atom types to describe your residues in order to avoid clashes with previously declared atoms.
Adding the suffix _RESIDUE to the intended atom type should be enough.

```
# EXTRA RESIDUES

[ FMO ] ; - Alexander van Teijlingen 07-12-2020
 [ atoms ]
	C1	C1_FMO	-0.11	0
	H1	H1_FMO	0.135	1
	C2	C2_FMO	-0.11	2
	H2	H2_FMO	0.135	3
```


### Add atom types to ffnonbonded.itp

```
;
; EXTRA RESIDUES
; FMOC - Alexander van Teijlingen 07-12-2020
H1_FMO    1      1.0080  0.000  A  0.242003727796  0.12552
H2_FMO    1      1.0080  0.000  A  0.242003727796  0.12552
H3_FMO    1      1.0080  0.000  A  0.242003727796  0.12552
H4_FMO    1      1.0080  0.000  A  0.242003727796  0.12552
H7_FMO    1      1.0080  0.000  A  0.242003727796  0.12552
```


### Add placeholder info on DataBaseT_old.crg and DataBaseT_old.siz

```
  H1  FMO X.XXX
  H2  FMO X.XXX
  H3  FMO X.XXX
  H4  FMO X.XXX
  H7  FMO X.XXX
  H8  FMO X.XXX
```


### Run extend_db

```
python3 extend_db.py
```

New tmp.crg and tmp.siz have been generated. Please inspect them to check the new residue has been added at the bottom correctly. After the visual inspection, rename them DataBaseT.crg and DataBaseT.siz, respectively.

```
mv tmp.crg DataBaseT.crg
mv tmp.siz DataBaseT.siz
```


### Add residue to pdb2pqr

The residue also needs to be added to PDB2PQR's database of residues, so that is not discarded on the preprocessing step.

/pdb2pqr/dat/CHARMM.DAT
```

# FMOC - Alexander van Teijlingen 07-12-2020
FMO     C1    0.01  0.01    C1
FMO     H1    0.01  0.01    H1
FMO     C2    0.01  0.01    C2
FMO     H2    0.01  0.01    H2
```.. highlight:: shell

============
Contributing
============

Contributions are welcome, and they are greatly appreciated! Every little bit
helps, and credit will always be given.

You can contribute in many ways:

Types of Contributions
----------------------

Report Bugs
~~~~~~~~~~~

Report bugs at https://github.com/mms-fcul/pypka/issues.

If you are reporting a bug, please include:

* Your operating system name and version.
* PypKa's version and parameters used for the calculation
* Origin of the input structure:  Protein Data Bank or simulation (please specify the FF)

Fix Bugs
~~~~~~~~

Look through the GitHub issues for bugs. Anything tagged with "bug" and "help
wanted" is open to whoever wants to implement it.

Implement Features
~~~~~~~~~~~~~~~~~~

Look through the GitHub issues for features. Anything tagged with "enhancement"
and "help wanted" is open to whoever wants to implement it.

Write Documentation
~~~~~~~~~~~~~~~~~~~

PypKa could always use more documentation, whether as part of the
official PypKa docs, in docstrings, or even on the web in blog posts,
articles, and such.

Submit Feedback
~~~~~~~~~~~~~~~

The best way to send feedback is to file an issue at https://github.com/mms-fcul/pypka/issues.

If you are proposing a feature:

* Explain in detail how it would work.
* Keep the scope as narrow as possible, to make it easier to implement.

Get Started!
------------

Ready to contribute? Here's how to set up `pypka` for local development.

1. Fork the `pypka` repo on GitHub.
2. Clone your fork locally::

    $ git clone git@github.com:your_name_here/pypka.git

3. Install your local copy into a virtualenv. Assuming you have pipenv installed, this is how you set up your fork for local development::
    
    $ cd pypka/
    $ pipenv install pypka

4. Create a branch for local development::

    $ git checkout -b name-of-your-bugfix-or-feature

   Now you can make your changes locally.

5. When you're done making changes, check that your changes pass the tests::

    $ make tests

6. Commit your changes and push your branch to GitHub::

    $ git add .
    $ git commit -m "Your detailed description of your changes."
    $ git push origin name-of-your-bugfix-or-feature

7. Submit a pull request through the GitHub website.

Pull Request Guidelines
-----------------------

Before you submit a pull request, check that it meets these guidelines:

1. The pull request should include tests.
2. If the pull request adds functionality, the docs should be updated. Put
   your new functionality into a function with a docstring, and add the
   feature to the list in README.rst.
3. The pull request should work for Python 3.5, 3.6, 3.7 and 3.8, and for PyPy.


Deploying
---------

A reminder for the maintainers on how to deploy.
Make sure all your changes are committed.
Then run::

$ bump2version patch # possible: major / minor / patch
$ git push
$ git push --tags

pypka.mc package
================

Submodules
----------

pypka.mc.mc module
------------------

.. automodule:: pypka.mc.mc
   :members:
   :undoc-members:
   :show-inheritance:

pypka.mc.mc module
------------------

.. automodule:: pypka.mc.mc
   :members:
   :undoc-members:
   :show-inheritance:

pypka.mc.mc module
------------------

.. automodule:: pypka.mc.mc
   :members:
   :undoc-members:
   :show-inheritance:

pypka.mc.mc module
------------------

.. automodule:: pypka.mc.mc
   :members:
   :undoc-members:
   :show-inheritance:

pypka.mc.mc module
------------------

.. automodule:: pypka.mc.mc
   :members:
   :undoc-members:
   :show-inheritance:

pypka.mc.mc module
------------------

.. automodule:: pypka.mc.mc
   :members:
   :undoc-members:
   :show-inheritance:

pypka.mc.mc\_setup module
-------------------------

.. automodule:: pypka.mc.mc_setup
   :members:
   :undoc-members:
   :show-inheritance:

Module contents
---------------

.. automodule:: pypka.mc
   :members:
   :undoc-members:
   :show-inheritance:
pypka.delphi4py.rundelphi package
=================================

Submodules
----------

pypka.delphi4py.rundelphi.rundelphi module
------------------------------------------

.. automodule:: pypka.delphi4py.rundelphi.rundelphi
   :members:
   :undoc-members:
   :show-inheritance:

pypka.delphi4py.rundelphi.rundelphi module
------------------------------------------

.. automodule:: pypka.delphi4py.rundelphi.rundelphi
   :members:
   :undoc-members:
   :show-inheritance:

pypka.delphi4py.rundelphi.rundelphi module
------------------------------------------

.. automodule:: pypka.delphi4py.rundelphi.rundelphi
   :members:
   :undoc-members:
   :show-inheritance:

pypka.delphi4py.rundelphi.rundelphi module
------------------------------------------

.. automodule:: pypka.delphi4py.rundelphi.rundelphi
   :members:
   :undoc-members:
   :show-inheritance:

pypka.delphi4py.rundelphi.rundelphi module
------------------------------------------

.. automodule:: pypka.delphi4py.rundelphi.rundelphi
   :members:
   :undoc-members:
   :show-inheritance:

Module contents
---------------

.. automodule:: pypka.delphi4py.rundelphi
   :members:
   :undoc-members:
   :show-inheritance:
pypka
=====

.. toctree::
   :maxdepth: 4

   pypka
pypka package
=============

Submodules
----------

pypka.cli module
----------------

.. automodule:: pypka.cli
   :members:
   :undoc-members:
   :show-inheritance:

pypka.concurrency module
------------------------

.. automodule:: pypka.concurrency
   :members:
   :undoc-members:
   :show-inheritance:

pypka.config module
-------------------

.. automodule:: pypka.config
   :members:
   :undoc-members:
   :show-inheritance:

pypka.constants module
----------------------

.. automodule:: pypka.constants
   :members:
   :undoc-members:
   :show-inheritance:

pypka.log module
----------------

.. automodule:: pypka.log
   :members:
   :undoc-members:
   :show-inheritance:

pypka.main module
-----------------

.. automodule:: pypka.main
   :members:
   :undoc-members:
   :show-inheritance:

pypka.molecule module
---------------------

.. automodule:: pypka.molecule
   :members:
   :undoc-members:
   :show-inheritance:

pypka.tautomer module
---------------------

.. automodule:: pypka.tautomer
   :members:
   :undoc-members:
   :show-inheritance:

pypka.titsite module
--------------------

.. automodule:: pypka.titsite
   :members:
   :undoc-members:
   :show-inheritance:

Module contents
---------------

.. automodule:: pypka
   :members:
   :undoc-members:
   :show-inheritance:
pypka.delphi4py package
=======================

Subpackages
-----------

.. toctree::
   :maxdepth: 4

   pypka.delphi4py.readFiles
   pypka.delphi4py.rundelphi

Submodules
----------

pypka.delphi4py.delphi4py module
--------------------------------

.. automodule:: pypka.delphi4py.delphi4py
   :members:
   :undoc-members:
   :show-inheritance:

Module contents
---------------

.. automodule:: pypka.delphi4py
   :members:
   :undoc-members:
   :show-inheritance:
pypka.clean package
===================

Submodules
----------

pypka.clean.checksites module
-----------------------------

.. automodule:: pypka.clean.checksites
   :members:
   :undoc-members:
   :show-inheritance:

pypka.clean.cleaning module
---------------------------

.. automodule:: pypka.clean.cleaning
   :members:
   :undoc-members:
   :show-inheritance:

pypka.clean.ffconverter module
------------------------------

.. automodule:: pypka.clean.ffconverter
   :members:
   :undoc-members:
   :show-inheritance:

pypka.clean.formats module
--------------------------

.. automodule:: pypka.clean.formats
   :members:
   :undoc-members:
   :show-inheritance:

pypka.clean.pdb\_out module
---------------------------

.. automodule:: pypka.clean.pdb_out
   :members:
   :undoc-members:
   :show-inheritance:

Module contents
---------------

.. automodule:: pypka.clean
   :members:
   :undoc-members:
   :show-inheritance:
pypka.delphi4py.readFiles package
=================================

Submodules
----------

pypka.delphi4py.readFiles.memalloc module
-----------------------------------------

.. automodule:: pypka.delphi4py.readFiles.memalloc
   :members:
   :undoc-members:
   :show-inheritance:

pypka.delphi4py.readFiles.readFiles module
------------------------------------------

.. automodule:: pypka.delphi4py.readFiles.readFiles
   :members:
   :undoc-members:
   :show-inheritance:

pypka.delphi4py.readFiles.readFiles module
------------------------------------------

.. automodule:: pypka.delphi4py.readFiles.readFiles
   :members:
   :undoc-members:
   :show-inheritance:

pypka.delphi4py.readFiles.readFiles module
------------------------------------------

.. automodule:: pypka.delphi4py.readFiles.readFiles
   :members:
   :undoc-members:
   :show-inheritance:

pypka.delphi4py.readFiles.readFiles module
------------------------------------------

.. automodule:: pypka.delphi4py.readFiles.readFiles
   :members:
   :undoc-members:
   :show-inheritance:

pypka.delphi4py.readFiles.readFiles module
------------------------------------------

.. automodule:: pypka.delphi4py.readFiles.readFiles
   :members:
   :undoc-members:
   :show-inheritance:

Module contents
---------------

.. automodule:: pypka.delphi4py.readFiles
   :members:
   :undoc-members:
   :show-inheritance:
Development
===========

.. toctree::
   :maxdepth: 2
   
   development/newresidues
   development/contributing
   development/futureExamples
========
Usage
===========

.. toctree::
   :maxdepth: 2
   
   usage/methods
   usage/parameters


====================
Mandatory Parameters
====================

.. object:: structure
	    
   :type: str

   the PDB filename

.. object:: epsin
	    
   :type: float

   internal dielectric to be used in the PB calculations.

.. object:: ionicstr
	    
   :type: float

   ionic strength of the medium

.. object:: pbc_dimensions
	    
   :type: int

   number of dimensions with periodic boundaries. 0 for solvated proteins and 2 for lipidic systems

.. object:: ncpus
	    
   :type: int

   number of CPUs to use in the calculations (-1 to use all available)
Useful Links
=============


- `Online Server <https://pypka.org>`_: Run PypKa online with a simple interface and no installation requirements
   
- `PypKa Article <https://doi.org/10.1021/acs.jcim.0c00718>`_: Read PypKa's application note on JCIM
   
- `GitHub Project <https://github.com/mms-fcul/PypKa>`_: Review and/or fork PypKa's codeGetting Started
===============

.. toctree::
   :maxdepth: 2
   
   getting_started/installation
   getting_started/example_basic
   getting_started/example_structureoutput
   getting_started/example_mdinput
   getting_started/example_full
   getting_started/features
API Reference
=============

.. toctree::
   :maxdepth: 1

   api/titration
   api/molecule
   api/site
   api/tautomer
.. toctree::
   :maxdepth: 2
   :caption: Content
   :hidden:

   self
   getting_started   
   development
   pypka
   useful

Pypka
=================================

A python module for flexible Poisson-Boltzmann based p\ :emphasis:`K`\
:sub:`a` calculations.

We have implemented a flexible tool to predict Poisson-Boltzmann-based
p\ :emphasis:`K`\ :sub:`a` values of biomolecules. This is a free and
open source project that provides a simple, reusable and extensible
python API and CLI for p\ :emphasis:`K`\ :sub:`a` calculations with a
valuable trade-off between fast and accurate predictions. With PypKa
one can enable p\ :emphasis:`K`\ :sub:`a` calculations, including
optional proton tautomerism, within existing protocols by adding a few
extra lines of code. PypKa supports CPU parallel computing on
anisotropic (membrane) and isotropic (protein) systems and allows the
user to find a balance between accuracy and speed.

PypKa is written in Python and Cython and it is integrated with the
Poisson-Boltzmann solver DelPhi Fortran77.

If you use PypKa in your research please cite the following `paper <https://doi.org/10.1021/acs.jcim.0c00718>`_:

Reis, P. B. P. S., Vila-Viçosa, D., Rocchia, W., & Machuqueiro, M. (2020). 
PypKa: A Flexible Python Module for Poisson–Boltzmann-Based pKa Calculations. 
Journal of Chemical Information and Modeling, 60(10), 4442–4448.

.. code-block:: bibtex

   @article{reis2020jcim,
   author = {Reis, Pedro B. P. S. and Vila-Viçosa, Diogo and Rocchia, Walter and Machuqueiro, Miguel},
   title = {PypKa: A Flexible Python Module for Poisson–Boltzmann-Based pKa Calculations},
   journal = {Journal of Chemical Information and Modeling},
   volume = {60},
   number = {10},
   pages = {4442-4448},
   year = {2020},
   doi = {10.1021/acs.jcim.0c00718}
   }



=================
Availability
=================

PypKa can be `easily installed <gettings_started/installation.html>`_ using the pip
package manager.

Source code is freely available at `GitHub <https://github.com/mms-fcul/PypKa>`_
under the LGPL-3.0 license. The package can be installed from `PyPi
<https://pypi.org/project/pypka/>`_.

=================
Contacts
=================

Please `submit a github issue  <https://github.com/mms-fcul/PypKa/issues/new>`_ to report bugs and to request new features.

Alternatively you may find the developer `here <mailto:pdreis@ciencias.ulisboa.pt>`_ . Please visit our `website <http://mms.rd.ciencias.ulisboa.pt/>`_ for more information.


.. include:: ../../../CONTRIBUTING.rstFuture Work
===========

.. |sb| raw:: html

   <strike>

.. |se| raw:: html

   </strike>

We have built PypKa with a clear focus on three things:

* Usability

* Speed

* Accuracy


Naturaly our development path also reflects these concerns.

=================================
Greater Usability
=================================

- |sb| Provide a Webserver Interface and platform |se|

- |sb| More in-deepth user documentation |se|
  
- Improve code-level documentation

- Create a series of tutorials

- Implement a proper logging system to give the users more info

- Expand our test suite

=================================
Faster Calculations
=================================

- Allow the titration of a single site and all titrable residues within a cutoff radius

- Implement an asynchronous algorithm to manage the Monte Carlo
  runs with a dynamic step and automatic pH range

- |sb| Porting the code to python3 |se|

=================================
Accuracy Improvement
=================================

- |sb| Support structures with multiple chains |se|

- Improve preprocessing guess of tautomer position guess

- |sb| Extensive benchmark and further optimization of parameters |se|

- Support for |sb| CHARMM |se|, AMBER and PARSE based charges and radii

- Support more lipids

- |sb| Support Nucleic Acids |se|
FF Extension
============

=====================
Adding extra residues
=====================

PypKa supports canonical amino acids and DNA bases, as well as some lipid molecules and ions. However, for many studies these are not sufficient and one might need to manually add these extra residues/molecules. PypKa supports out-of-the-box GROMOS54a7 and CHARMM36m FFs, but this recipe is transferable to other FFs as well.

For demonstration purposes, we will add an FMOC residue to the CHARMM36m FF for which the parameters have been kindly supplied by Alexander van Teijlingen.
DataBaseT.crg and DataBaseT.siz are the main files where the charges and radii of atoms need to be added.
The new DataBaseT files will be generated by extend_db.py (tmp.crg and tmp.siz) provided one follows the steps describe below.
If you believe your residue could benefit other users please create a pull request on GitHub or send the new parameters to the developers directly.

================================
Add residue block to aa.rtp file
================================

The lines should adhere to GROMACS .rtp file logic. Please use unique atom types to describe your residues in order to avoid clashes with previously declared atoms. Adding the suffix _RESIDUE to the intended atom type should be enough.


.. code-block:: text
   :caption: aa.rtp

   # EXTRA RESIDUES

   [ FMO ] ; - Alexander van Teijlingen 07-12-2020
    [ atoms ]
   	C1	C1_FMO	-0.11	0
   	H1	H1_FMO	0.135	1
   	C2	C2_FMO	-0.11	2
   	H2	H2_FMO	0.135	3

=================================
Add atom types to ffnonbonded.itp
=================================

.. code-block:: text
   :caption: ffnonbonded.itp

   ; EXTRA RESIDUES
   ; FMOC - Alexander van Teijlingen 07-12-2020
   H1_FMO    1      1.0080  0.000  A  0.242003727796  0.12552
   H2_FMO    1      1.0080  0.000  A  0.242003727796  0.12552
   H3_FMO    1      1.0080  0.000  A  0.242003727796  0.12552
   H4_FMO    1      1.0080  0.000  A  0.242003727796  0.12552
   H7_FMO    1      1.0080  0.000  A  0.242003727796  0.12552


===============================================================
Add placeholder info on DataBaseT_old.crg and DataBaseT_old.siz
===============================================================

The X.XXX placeholder marks the atom as a new addition.

.. code-block:: text
   :caption: DataBaseT_old.crg and DataBaseT_old.siz

   H1  FMO X.XXX
   H2  FMO X.XXX
   H3  FMO X.XXX
   H4  FMO X.XXX
   H7  FMO X.XXX
   H8  FMO X.XXX


=============
Run extend_db
=============

.. code-block:: bash

   python3 extend_db.py


New tmp.crg and tmp.siz have been generated. Please inspect them to check the new residue has been added at the bottom correctly. After the visual inspection, rename them DataBaseT.crg and DataBaseT.siz, respectively.

.. code-block:: bash

   mv tmp.crg DataBaseT.crg
   mv tmp.siz DataBaseT.siz


======================
Add residue to pdb2pqr
======================

The residue also needs to be added to PDB2PQR's database of residues, so that is not discarded on the preprocessing step.

.. code-block:: text
   :caption: /pdb2pqr/dat/CHARMM.DAT

   # FMOC - Alexander van Teijlingen 07-12-2020
   FMO     C1    0.01  0.01    C1
   FMO     H1    0.01  0.01    H1
   FMO     C2    0.01  0.01    C2
   FMO     H2    0.01  0.01    H2
Input Parameters
=================================

============================
General Parameters
============================

.. object:: structure (str)

   :optional: No

   The input filename in Protein Data Bank or GROMACS formats

.. object:: ncpus (int)

   :optional: No

   Number of CPUs to use in the calculations

.. object:: ionicstr (float)

   :optional: No

   Ionic strength of the medium

.. object:: ffinput='GROMOS' (str)

   :allowed values: ('GROMOS', 'AMBER', 'CHARMM')

   Forcefield of the input :py:data:`structure`. GROMOS is
   also valid for experimentally obtained strucutures
		    
.. object:: ffID='G54a7' (str)

   :allowed values: ('G54A7')
      
   For the time being, only GROMOS54a7 based charged and radii are
   allowed.  In the future more forcefields will be added.
		    

.. object:: sites='all' (str)

   CLI Syntax:
   sites_A  = all
   sites_A  = 1N, 18, 35, 48, 66, 129C

   API Syntax:
   sites = 'all'
   sites = {'A': ('1N', '18', '35', '48', '66', '129C')}
   Titration(parameters, sites=sites)

.. object:: clean_pdb=True (boolean)

   The input :py:data:`structure` files are preprocessed with
   PDB2PQR. To skip this step set :py:data:`clean_pdb` to False.
	     
   CLI Syntax: yes or no
   
   
============================
Poisson-Boltzmann Parameters
============================

.. object:: epsin (float)

   :optional: No

   Internal dielectric to be used in the PB calculations.

.. object:: pbc_dimensions (int)

   :optional: No
   :allowed values: (0, 2)

   Number of dimensions with periodic boundaries. Use 0 for solvated
   proteins and 2 for lipidic systems.

.. object:: gsize=81 (int)

   DelPhi number of grid points per side of the cubic lattice.
    
.. object:: epssol=80.0 (float)

   Solvent dielectric to be used in the PB calculations.

.. object:: relpar=0.75 (float)

   DelPhi relaxation parameter in non-linear iteration convergence process.
   
.. object:: relfac=0.75 (float)

   DelPhi spectral radius.
   
.. object:: nonit=0 (float)

   DelPhi number of non-linear iterations.

.. object:: nlit=500 (float)

   DelPhi number of linear iterations.
   
.. object:: convergence=0.01 (float)

   DelPhi convergence threshold for maximum change of potential.
    
.. object:: scaleM=4 (float)

   DelPhi reciprocal of one grid spacing for the finer grid.
    
.. object:: scaleP=1 (float)

   DelPhi reciprocal of one grid spacing for the coarse grid used in the focusing step.
    
.. object:: slice=0.05 (float)

   Only used when :py:data:`pbc_dimensions` is 2. Fraction of the
   exterior of the lipid bilayer to be replicated with periodic
   boundary conditions.
   
.. object:: pbx=False (boolean)

   DelPhi periodic boundary conditions for the x edge of the grid

.. object:: pby=False (boolean)

   DelPhi periodic boundary conditions for the y edge of the grid

.. object:: bndcon=4 (int)

   :allowed values: (1, 2, 3, 4)

   DelPhi type of boundary condition.

   1. Zero
   2. Dipolar
   3. Focusing
   4. Coulombic
		    
.. object:: precision='single' (str)

   :allowed values: ('single', 'double')

   Precision of the compiled DelPhi version being used.


============================
Monte Carlo Parameters
============================
.. object:: seed (int)

   Seed for the MC random generator

.. object:: pH='0,14' (str)

   pH value of the calculation. It can be a single value or a range.
	  
   CLI syntax:
	  
   pH = 0, 14

   
   API syntax:
   
   'pH': '0, 14'


.. object:: pHstep=0.25 (float)

   In case a pH range was provided :py:data:`pH`, the pH step of said
   range is :py:data:`pHstep`
    
Main Methods
=================================

.. py:function:: getTitrableSites(pdb)

	Gets the all titrable sites from the pdb

   :param pdb: The filename a PDB file   
   :type pdb: string

   :return: All titrable sites residue numbers found in the pdb file
   :rtype: list


.. py:class:: Titration

	Main pypka class

	.. py:method:: getAverageProt(self, site, pH)
        
        Calculates the average protonation of a site at a given pH value

        :param site: Residue number of the site with the suffix 'N'
        			or 'C' to indicate a N-ter or C-ter, respectively.
        :type site: string

        :param pH: pH value
        :type pH: float 
        
        :returns: Average protonation of the site at the selected pH value
        :rtype: float

	.. py:method:: getProtStategetProtState(self, site, pH)
        
        Indicates the most probable protonation state of a site at a given pH value

       	:param site: Residue number of the site with the suffix 'N'
            or 'C' to indicate a N-ter or C-ter, respectively.
       	:type site:  str
        :param pH: pH value 
        :type pH:  float

        :returns: A tuple with two elements. Example: ('protonated', 0.9)

            The first element is a string indicating the most probable
            state of the site. It can be either 'protonated',
            'deprotonated' or 'undefined'. The 'undefined' state is
            prompted if the average protonation state is between 0.1 and 0.9.
          
            The second element is a float of the average protonation of the site
        :rtype: tuple

	.. py:method:: getParameters()

		Get the parameters used in the calculations

		:returns: Current state of DelPhi parameters
		:rtype: stringTautomer
========

.. autoclass:: tautomer.Tautomer
   :members:
Titration
=========

.. autoclass:: pypka.Titration
   :members:
Site
====

.. autoclass:: titsite.Titsite
   :members:
Molecule
========

.. autoclass:: molecule.Molecule
   :members:
p\ :emphasis:`K`\ \ :sub:`a`\  Calculation
==========================================

In this example we are estimating the p\ :emphasis:`K`\ \ :sub:`a`\  values for all titrable sites of a hen egg-white lysozyme.

The structure may be downloaded from the Protein Data Bank::

   wget https://files.rcsb.org/download/4lzt.pdb


PypKa features a API and a CLI. Both interfaces provide the same amount of features.

API
---

.. code-block:: python
   
   from pypka import Titration
   
   params = {
    'structure'     : '4lzt.pdb', # Input structure file name
    'ncpus'         : -1,         # Number of processes (-1 for maximum allowed)
    'epsin'         : 15,         # Dielectric constant of the protein
    'ionicstr'      : 0.1,        # Ionic strength of the medium (M)
    'pbc_dimensions': 0           # PB periodic boundary conditions (0 for solvated proteins and 2 for lipidic systems)
   }
   
   tit = Titration(params)
      
   pH = 7.0
   for site in tit:
       state = site.getProtState(pH)[0]    
       print(site.res_name, site.res_number, site.pK, state)   
   
   
You may also try it out on a `online notebook.
<https://colab.research.google.com/github/mms-fcul/PypKa/blob/master/pypka/example/notebook/pypka.ipynb>`_ 



CLI
---

The same calculation can be done via CLI by resorting to a input
parameter file.

.. code-block:: text
   :caption: parameters.dat
      
   structure       = 4lzt.pdb      # Input structure file name
   ncpus           = -1            # Number of processes (-1 for maximum allowed)
   epsin           = 15            # Dielectric constant of the protein
   ionicstr        = 0.1           # Ionic strength of the medium (M)
   pbc_dimensions  = 0             # PB periodic boundary conditions (0 for solvated proteins and 2 for lipidic systems)
   sites           = all           # Titrate all available sites
   output          = pKas.out      # pKa values output file

To run the simulation execute the following command:

.. code-block:: bash

   python3 -m pypka parameters.dat

Main Features
=============


Easy to Install
---------------

As seen in the `installation page <installation.html>`_, PypKa is
easilly installed from the command line.


Easy to Use
-----------

The `basic example <example.html>`_ provided can be effortlessly
adjusted to your system. Although many `parameters <parameters.html>`_
can be modified by an advanced user, simple users can confidently use
the default values.


API & CLI
---------

Every interface has its pros and cons. With PypKa you can choose to
run you calculations via a python API or from the command-line. In the
future we will present a webserver interface as well. 


Fast and accurate
-----------------

As a Poisson-Boltzmann-based pKa predictor, PypKa provides an
interesting trade-off between speed and accuracy. You can also
manually set some input parameters such as :py:data:`convergence`,
:py:data:`gsize` or :py:data:`sites`, to adjust the balance between
accuracy and speed as you please. Further speed gains can be achieved
by taking advantage of the highly scalable multiprocessing
capabilities (:py:data:`ncpus`).


Flexibility of Input Structures
-------------------------------

PypKa supports both the Protein Data Bank and GROMACS input format and
the most popular atomistic force-fields (AMBER, CHARMM & GROMOS) as
well as experimentally determined structures. These structures are
preprocessed using a modified version of PDB2PQR according to the
defined :py:data:`ffinput`.


Lipidic Systems Support
-----------------------

It is possible to run calculations on membrane proteins, and in the
future, on lipids.  Currently only some lipids are supported (DMPC,
POPC, POPE and cholesterol) but more will be added. To use this
feature the user is required to name the lipids in their structures
according to the PypKa definition.MD Structure Preparation
========================

In this example we are preparing a structure for molecular dynamics by assigning the most likely protonation state to all titrable sites.

In order to output this structure we need to add the argument :code:`structure_output`. Since we aren't interested in calculating p\ :emphasis:`K`\ \ :sub:`a`\  values, we can speed up the simulation by setting :code:`ph` to the single pH value of the desired output structure.


.. code-block:: text
   :caption: parameters.dat
      
   structure       = 4lzt.pdb      # Input structure file name
   ncpus           = -1            # Number of processes (-1 for maximum allowed)
   epsin           = 15            # Dielectric constant of the protein
   ionicstr        = 0.1           # Ionic strength of the medium (M)
   pbc_dimensions  = 0             # PB periodic boundary conditions (0 for solvated proteins and 2 for lipidic systems)
   sites           = all           # Titrate all available sites
   output          = pKas.out      # pKa values output file
   structure_output = out.pdb, 7, amber  # Output structure with the most likely protonation state at a given pH value
   # filename, pH value, force field ("gromos_cph", "amber")
   ph = 7                          # pH range

To run the simulation execute the following command:

.. code-block:: bash

   python3 -m pypka parameters.dat

Installation
============

There are three ways to install pypka:

- with pip. Preferred for Linux & Windows (with WSL) users.

- with Docker.

- with no installation, by using the online server at `pypka.org <https://pypka.org>`_. Recommended when only a few calculations are going to be performed.




Via pip
-------

To install the latest stable release with pip do::

   pip3 install pypka


Required Software
~~~~~~~~~~~~~~~~~

Pypka depends on the following software:

* python2.6>= & python3.5>=
* libgfortran4
* gawk

These can all be installed via apt in Debian based systems::

  apt install gawk gcc gfortran libgfortran4 python2

Via Docker
----------

Run the following command on a local directory which contains the cli parameters file (<PARAMETERS_FILE>) and input structure::

   docker run -v ${PWD}:/home/ -w /home -t pedrishi/pypka:latest python3.9 -m pypka <PARAMETERS_FILE>
Using a MD structure
========================

In this example we are calculating the p\ :emphasis:`K`\ \ :sub:`a`\  values for all titrable residues using a molecular dynamics generated structure.
The argument :code:`ffinput` needs to be set to the appropriate nomenclature scheme.


.. code-block:: text
   :caption: parameters.dat
      
   structure       = amber.pdb     # Input structure file name
   ncpus           = -1            # Number of processes (-1 for maximum allowed)
   epsin           = 15            # Dielectric constant of the protein
   ionicstr        = 0.1           # Ionic strength of the medium (M)
   pbc_dimensions  = 0             # PB periodic boundary conditions (0 for solvated proteins and 2 for lipidic systems)
   sites           = all           # Titrate all available sites
   output          = pKas.out      # pKa values output file
   ffinput         = AMBER         # Input structure nomenclature scheme ("AMBER", "CHARMM", "GROMOS")

To run the simulation execute the following command:

.. code-block:: bash

   python3 -m pypka parameters.dat

Complete Parameters File Template
=================================

.. code-block:: text
   :caption: parameters.dat
      
   # Mandatory
   structure = 4lzt.pdb    # Input structure file name
   epsin = 15              # Dielectric constant of the protein
   ionicstr = 0.1          # Ionic strength of the medium (M)
   pbc_dimensions = 0      # PB periodic boundary conditions (0 for solvated proteins and 2 for lipidic systems)
   ncpus = -1              # Number of processes (-1 for maximum allowed)
   sites = all             # Titrate all available sites
   
   # Output
   output = pKas.txt                     # pKa values output file
   titration_output = titration.txt      # Titration curves output file
   isoelectric_point = yes               # Calculate isoelectric point
   save_pdb = pb_input.pdb               # save PB input file
   structure_output = out.pdb, 7, amber  # Output structure with the most likely protonation state at a given pH value
   # filename, pH value, force field ("gromos_cph", "amber")
   
   
   # Force Field
   # f_crg = /home/user/database.crg     # DelPhi charges database file path
   # f_siz = /home/user/database.siz     # DelPhi radii database file path
   # path to search for .st files -> $ffs_dir/$ffID/$/sts
   # ffs_dir = /home/user/database # default value is an internal folder
   # ffID = G54A7 # built-in options: G54A7, CHARMM36m
   # sts = sts
   
   
   # Preprocessing
   ffinput = GROMOS          # Input structure nomenclature scheme ("GROMOS", "AMBER", "CHARMM")
   clean_pdb = True          # Clean the input structure
   pdb2pqr_h_opt = True      # Allow pdb2pqr to optimize the hydrogen positions
   remove_hs = True          # Remove hydrogens in the input structure
   keep_ions = False         # Keep NA+ and CL- ions in the structure
   ser_thr_titration = True  # Titrate SER and THR residues
   
   
   # Poisson-Boltzmann
   gsize = 81           # number of grid nodes
   scaleP = 1           # inverse grid size of big grid
   scaleM = 4           # inverse grid size of small grid
   bndcon = 3           # DelPhi type of boundary condition for the big grid. 3 for Coulombic
   convergence = 0.01   # PB convergence criterion
   nlit = 500           # Number of linear iterations
   nonit = 0            # Number of non-linear iterations
   relfac = 0.75        # DelPhi spectral radius
   relpar = 0.75        # DelPhi relaxation parameter in non-linear iteration convergence process.
   epssol = 80.0        # Solvent dielectric constant value
   
   # Monte Carlo
   pH = 0,14        # pH range: pH minimum, pH maximum OR single pH value
   pHstep = 0.25    # pH range step
   seed = 1234567   # random number generator seed number
   mcsteps = 200000 # number of production monte carlo steps
   eqsteps = 1000   # number of equilibration monte carlo steps