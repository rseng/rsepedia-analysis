englishreadmemd 中文版 transbigdata 针对交通时空大数据处理的python包 img srchttpsgithubcomniotransbigdatarawmaindocssource_staticlogowordmarkdarkpng stylewidthpx document statushttpsreadthedocsorgprojectstransbigdatabadgeversionlatesthttpstransbigdatareadthedocsioenlatestbadgelatest pypi versionhttpsbadgefuryiopytransbigdatasvghttpsbadgefuryiopytransbigdata downloadshttpspepytechbadgetransbigdatahttpspepytechprojecttransbigdata github commit activityhttpsimgshieldsiogithubcommitactivitymniotransbigdata bilibilihttpsimgshieldsiobadgebilibiliecebeebfeadeadaebfgreensvghttpsspacebilibilicom statushttpsjosstheojorgpapersdfedfadcffcbcabstatussvghttpsjosstheojorgpapersdfedfadcffcbcab binderhttpsmybinderorgbadge_logosvghttpsmybinderorgvghniotransbigdataddfaffbabddcffffabdurlpathlabftreefexamplefexampletaxigpsdataprocessingipynb testshttpsgithubcomniotransbigdataactionsworkflowstestsymlbadgesvghttpsgithubcomniotransbigdataactionsworkflowstestsyml codecovhttpscodecovioghniotransbigdatabranchmaingraphbadgesvgtokenglavyycdlhttpscodecovioghniotransbigdata doihttpszenodoorgbadgesvghttpszenodoorgbadgelatestdoi gitterhttpsbadgesgitterimtransbigdatacommunitysvghttpsgitterimtransbigdatacommunityutm_sourcebadgeutm_mediumbadgeutm_campaignprbadg transbigdata是一个为交通时空大数据处理分析和可视化而开发的python包transbigdata为处理常见的交通时空大数据如出租车gps数据共享单车数据和公交车gps数据提供了快速而简洁的方法transbigdata为交通时空大数据分析的各个阶段提供了多种处理方法代码简洁高效灵活易用可以用简洁的代码实现复杂的数据任务 对于一些特定类型的数据transbigdata还提供了针对特定需求的工具如从出租车gps数据中提取出租车行程的起点和终点信息od从公交车gps数据中识别到离站信息该包的最新稳定版本可以通过pip安装完整的文档可以查看transbigdata的说明文档httpstransbigdatareadthedocsiozh_cnlatest 技术特点 面向交通时空大数据分析不同阶段的处理需求提供不同处理功能 代码简洁高效灵活易用通过简短的代码即可实现复杂的数据任务 主要功能 目前transbigdata主要提供以下方法 数据质量分析 提供快速获取数据集一般信息的方法包括数据量时间段和采样间隔 数据预处理 提供清洗多种类型的数据错误的方法 数据栅格化 提供在研究区域内生成多种类型的地理网格矩形网格六角形网格的方法提供快速算法将gps数据映射到生成的网格上 数据聚合集计 提供将gps数据和od数据聚合到地理多边形的方法 数据可视化 内置的可视化功能利用可视化包keplergl用简单的代码在jupyter笔记本上交互式地可视化数据 轨迹数据处理 提供处理轨迹数据的方法包括从gps点生成轨迹线型轨迹增密等 地图底图 提供在matplotlib上显示mapbox地图底图的方法 安装 用pypi安装 在安装 transbigdata之前请确保已经安装了可用的geopandas包httpsgeopandasorgindexhtml 如果你已经安装了geopandas则直接在命令提示符中运行下面代码即可安装 pip instal u transbigdata 用condaforge安装 你也可以用condaforge安装 transbigdata这种方式会自动解决环境依赖不过国内可能需要更换conda源运行下面代码即可安装 conda instal c condaforg transbigdata 可视化示例 可视化轨迹基于keplergl gifimagestbdexamplegif 可视化数据分布基于keplergl gifimagestbdexamplegif 可视化od基于keplergl gifimagestbdexamplegif 使用示例 下面例子展示如何使用 transbigdata工具快速处理出租车gps数据实现数据栅格化数据聚合集计与数据可视化 python import transbigdata tbd import panda pd 读取出租车gps数据 data pdread_csvtaxidatasamplecsvhead none datacolumn vehiclenumtimelonlatopenstatusspe data div tabl border classdatafram thead tr styletextalign right thth thvehiclenumth thtimeth thlonth thlatth thopenstatusth thspeedth tr thead tbodi tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tbodi tabl p row columnsp div 数据预处理 首先定义研究范围并使用 tbdclean_outofbounds剔除研究范围外的数据 python 定义研究范围 bound 剔除研究范围外的数据 data tbdclean_outofboundsdatabound boundscol lonlat 数据栅格化 以栅格形式表达数据分布是最基本的表达方法gps数据经过栅格化后每个数据点都含有对应的栅格信息采用栅格表达数据的分布时其表示的分布情况与真实情况接近如果要使用 transbigdata工具进行栅格划分首先需要确定栅格化的参数可以理解为定义了一个栅格坐标系参数可以帮助我们快速进行栅格化 python 获取栅格化参数 param tbdarea_to_paramsboundsaccuraci param slon slat deltalon deltalat theta method rect gridsiz 取得栅格化参数后将gps对应至栅格使用 tbdgps_to_grid方法该方法会生成 loncol列与 latcol列并由这两列共同指定一个栅格 python 将gps数据对应至栅格 dataloncoldatalatcol tbdgps_to_gridsdatalondatalatparam 聚合集计栅格内数据量并为栅格生成几何图形 python 聚合集计栅格内数据量 grid_agg datagroupbyloncollatcolvehiclenumcountreset_index 生成栅格的几何图形 grid_agggeometri tbdgridid_to_polygongrid_aggloncolgrid_agglatcolparam 转换为geodatafram import geopanda gpd grid_agg gpdgeodataframegrid_agg 绘制栅格 grid_aggplotcolumn vehiclenumcmap autumn_r pngimagesoutput__png 三角形六边形网格 旋转角度 transbigdata支持三角形六边形网格也支持为网格赋予旋转角度我们可以通过以下方式改变栅格参数来进行设定 python 设置为六边形网格 paramsmethod hexa 设置为三角形网格 paramsmethod tri 设置旋转角度单位为度 paramstheta 然后我们可以再次进行匹配集计 python 三角形和六边形网格要求三列存储栅格id信息 dataloncol_dataloncol_dataloncol_ tbdgps_to_griddatalondatalatparam 聚合集计栅格内数据量 grid_agg datagroupbyloncol_loncol_loncol_vehiclenumcountreset_index 生成栅格的几何图形 grid_agggeometri tbdgrid_to_polygongrid_aggloncol_grid_aggloncol_grid_aggloncol_param 转换为geodatafram import geopanda gpd grid_agg gpdgeodataframegrid_agg 绘制栅格 grid_aggplotcolumn vehiclenumcmap autumn_r pnghttpsgithubcomniotransbigdatarawmainimagereadmepng 数据可视化在matplotlib中绘制地图底图 对于一个正式的数据可视化图来说我们还需要添加底图色条指北针和比例尺 用 tbdplot_map加载地图底图并用 tbdplotscale添加指北针和比例尺 python import matplotlibpyplot plt fig pltfiguredpi ax pltsubplot pltscaax 加载地图底图 tbdplot_mappltboundszoom style 定义色条位置 cax pltax plttitledata count pltscaax 绘制数据 grid_aggplotcolumn vehiclenumcmap autumn_rax axcax caxlegend true 添加指北针和比例尺 tbdplotscaleaxbound boundstexts compasss accuraci rect zorder pltaxisoff pltxlimboundsbound pltylimboundsbound pltshow pnghttpsgithubcomniotransbigdatarawmainimagereadmepng transbigdata提供的栅格化的框架 下图显示了transbigdata提供的栅格化方法框架 pnghttpsgithubcomniotransbigdatarawmainimagereadmepng 具体用法可以参考这个案例httpsgithubcomniotransbigdatablobmainexampletbd_core_functionsipynb 相关链接 小旭学长的b站 httpsspacebilibilicom 小旭学长的七天入门交通时空大数据分析课程零基础免费课 httpswwwlifangshujucomintroduc 小旭学长的交通时空大数据分析课程 httpswwwlifangshujucomintroduc 小旭学长的数据可视化课程 httpswwwlifangshujucomintroduc 本项目的github页面 httpsgithubcomniotransbigdata 有bug请在这个页面提交 httpsgithubcomniotransbigdataissu 引用信息 如果你想要引用 transbigdata请引用这个doihttpsdoiorgzenodo引用信息在这个文件中citationcffhttpsgithubcomniotransbigdatablobmaincitationcff 介绍视频 bilibilihttpswwwbilibilicomvideobvnqyui youtubehttpswwwyoutubecomwatchvv_khfvw_w contribut transbigdata whether novic experienc softwar develop contribut suggest welcom get start look contribut transbigdata codebas best place start github issu tabhttpsgithubcomniotransbigdataissu also great place file bug report make suggest way improv code document stepbystep instruct contribut code host githubhttpsgithubcomniotransbigdata need use githttpgitscmcom clone project make chang codebas fork transbigdata repositoryhttpsgithubcomniotransbigdata creat new branch transbigdata master branch within fork copi sourc code transbigdata locat srchttpsgithubcomniotransbigdatatreemainsrc folder make test chang sourc code submit chang review make sure check chang break test run pytest test locat testshttpsgithubcomniotransbigdatatreemainsrctransbigdatatest folder readi submit contribut rais pull requestpr finish pr github test workflowhttpsgithubcomniotransbigdataactionsworkflowstestsyml test code review chang might ask make addit chang final readi merg howev readi merg success contribut codebas 为transbigdata贡献代码 无论您是新手还是经验丰富的软件开发人员欢迎您提供所有意见和建议 开始 如果你想为transbigdata代码库做贡献最好从github issueshttpsgithubcomniotransbigdataissues开始你可以在这里提交bug报告并提出改进代码和文档的方法和建议 如何贡献代码 代码托管在githubhttpsgithubcomniotransbigdata所以你需要使用githttpgitscmcom克隆项目并对代码做出更改具体方法如下 fork transbigdata仓库httpsgithubcomniotransbigdata 以transbigdata的main分支为基础创建新分支 在您的分支仓库中transbigdata的源代码位于srchttpsgithubcomniotransbigdatatreemainsrc文件夹您可以在源代码中进行和测试更改如果你使用的是jupyt notebook可以在src文件夹下建立ipynb文件进行调试这样修改transbigdata的源码时可以直接读取到 在提交更改以供审阅之前请运行pytest来测试代码确保您对代码的更改不会破坏任何测试结果测试代码位于testshttpsgithubcomniotransbigdatatreemainsrctransbigdatatests文件夹中 当你准备好提交你的贡献时提交pull requestpr完成pr后github提供的测试工作流httpsgithubcomniotransbigdataactionsworkflowstestsyml将测试您的代码并将测试结果做出分析 test分两部分一部分是旧的代码会test保证输出一致另一部分是你增加的方法需要自己写个test文件增加test这样后面贡献的人要改你代码时也会test确保不会更变你的程序功能transbigdata的测试结果在codecovhttpscodecovioghniotransbigdatabranchmaingraphbadgesvgtokenglavyycdlhttpscodecovioghniotransbigdata这里可以看到其中的百分比表示单元测试覆盖率表明有多少比例的代码通过了测试 测试成功后我们将检查您的更改并可能要求您在最终准备合并之前进行其他更改如果成功我们将merge到main分支中贡献就成功啦 如何贡献代码的视频介绍 bilibilihttpswwwbilibilicomvideobvkyhml youtubehttpswwwyoutubecomwatchvocjztpak contributor coven code conduct pledg member contributor leader pledg make particip commun harassmentfre experi everyon regardless age bodi size visibl invis disabl ethnic sex characterist gender ident express level experi educ socioeconom statu nation person appear race religion sexual ident orient pledg act interact way contribut open welcom divers inclus healthi commun standard exampl behavior contribut posit environ commun includ demonstr empathi kind toward peopl respect differ opinion viewpoint experi give grace accept construct feedback accept respons apolog affect mistak learn experi focus best us individu overal commun exampl unaccept behavior includ use sexual languag imageri sexual attent advanc kind troll insult derogatori comment person polit attack public privat harass publish other privat inform physic email address without explicit permiss conduct could reason consid inappropri profession set enforc respons commun leader respons clarifi enforc standard accept behavior take appropri fair correct action respons behavior deem inappropri threaten offens harm commun leader right respons remov edit reject comment commit code wiki edit issu contribut align code conduct commun reason moder decis appropri scope code conduct appli within commun space also appli individu offici repres commun public space exampl repres commun includ use offici email address post via offici social media account act appoint repres onlin offlin event enforc instanc abus harass otherwis unaccept behavior may report commun leader respons enforc tongjieducn complaint review investig promptli fairli commun leader oblig respect privaci secur report incid enforc guidelin commun leader follow commun impact guidelin determin consequ action deem violat code conduct correct commun impact use inappropri languag behavior deem unprofession unwelcom commun consequ privat written warn commun leader provid clariti around natur violat explan behavior inappropri public apolog may request warn commun impact violat singl incid seri action consequ warn consequ continu behavior interact peopl involv includ unsolicit interact enforc code conduct specifi period time includ avoid interact commun space well extern channel like social media violat term may lead temporari perman ban temporari ban commun impact seriou violat commun standard includ sustain inappropri behavior consequ temporari ban sort interact public commun commun specifi period time public privat interact peopl involv includ unsolicit interact enforc code conduct allow period violat term may lead perman ban perman ban commun impact demonstr pattern violat commun standard includ sustain inappropri behavior harass individu aggress toward disparag class individu consequ perman ban sort public interact within commun attribut code conduct adapt contributor covenanthomepag version avail httpswwwcontributorcovenantorgversioncode_of_conducthtml commun impact guidelin inspir mozilla code conduct enforc ladderhttpsgithubcommozilladivers homepag httpswwwcontributorcovenantorg answer common question code conduct see faq httpswwwcontributorcovenantorgfaq translat avail httpswwwcontributorcovenantorgtransl english 中文版readmezh_cnmd transbigdata img srchttpsgithubcomniotransbigdatarawmaindocssource_staticlogowordmarkdarkpng stylewidthpx document statushttpsreadthedocsorgprojectstransbigdatabadgeversionlatesthttpstransbigdatareadthedocsioenlatestbadgelatest downloadshttpspepytechbadgetransbigdatahttpspepytechprojecttransbigdata conda downloadshttpsimgshieldsiocondadncondaforgetransbigdatasvghttpsanacondaorgcondaforgetransbigdata binderhttpsmybinderorgbadge_logosvghttpsmybinderorgvghniotransbigdataddfaffbabddcffffabdurlpathlabftreefexamplefexampletaxigpsdataprocessingipynb testshttpsgithubcomniotransbigdataactionsworkflowstestsymlbadgesvghttpsgithubcomniotransbigdataactionsworkflowstestsyml codecovhttpscodecovioghniotransbigdatabranchmaingraphbadgesvgtokenglavyycdlhttpscodecovioghniotransbigdata introduct transbigdata python packag develop transport spatiotempor big data process analysi visual transbigdata provid fast concis method process common transport spatiotempor big data taxi gp data bicycl share data bu gp data transbigdata provid varieti process method stage transport spatiotempor big data analysi code transbigdata clean effici flexibl easi use allow complex data task achiev concis code specif type data transbigdata also provid target tool specif need extract origin destinationod taxi trip taxi gp data identif arriv departur inform bu gp data latest stabl releas softwar instal via pip full document found httpstransbigdatareadthedocsioenlatest introduct ppt found herehttpsgithubcomniotransbigdatablobmainintroductionintroductionoftransbigdatapdf herein chinesehttpsgithubcomniotransbigdatablobmainintroductiongridbasedframeworkpdf target audienc target audienc transbigdata includ data scienc research data engin field transport big data smart transport system urban comput particularli want integr innov algorithm intellig trasnport system govern enterpris entiti expect effici reliabl manag decis support transport spatiotempor data analysi technic featur provid varieti process method stage transport spatiotempor big data analysi code transbigdata clean effici flexibl easi use allow complex data task achiev concis code main function current transbigdata mainli provid follow method data qualiti provid method quickli obtain gener inform dataset includ data amount time period sampl interv data preprocess provid method clean multipl type data error data grid provid method gener multipl type geograph grid rectangular grid hexagon grid research area provid fast algorithm map gp data gener grid data aggreg provid method aggreg gp data od data geograph polygon data visual builtin visual capabl leverag visual packag keplergl interact visual data jupyt notebook simpl code trajectori process provid method process trajectori data includ gener trajectori linestr gp point trajectori densif etc basemap load provid method display mapbox basemap matplotlib figur instal recommend use python use pypi pypi versionhttpsbadgefuryiopytransbigdatasvghttpsbadgefuryiopytransbigdata transbigdata instal use pip instal instal transbigdata make sure instal avail geopanda packagehttpsgeopandasorgenstablegetting_startedinstallhtml alreadi geopanda instal run follow code directli command prompt instal transbigdata pip instal transbigdata use condaforg conda versionhttpsimgshieldsiocondavncondaforgetransbigdatasvghttpsanacondaorgcondaforgetransbigdata also instal transbigdata condaforg automaticali solv depend instal conda instal c condaforg transbigdata contribut transbigdata github contributorshttpsimgshieldsiogithubcontributorsniotransbigdatasvghttpsgithubcomniotransbigdatagraphscontributor join chat httpsgitterimtransbigdatacommunityhttpsbadgesgitterimtransbigdatacommunitysvghttpsgitterimtransbigdatacommunityutm_sourcebadgeutm_mediumbadgeutm_campaignprbadgeutm_contentbadg github commit activityhttpsimgshieldsiogithubcommitactivitymniotransbigdata contribut bug report bug fix document improv enhanc idea welcom detail overview contribut found contribut guidehttpsgithubcomniotransbigdatablobmastercontributingmd github exampl exampl data visual visual trajectori keplergl gifhttpsgithubcomniotransbigdatarawmainimagestbdexamplegif visual data distribut keplergl gifhttpsgithubcomniotransbigdatarawmainimagestbdexamplegif visual od keplergl gifhttpsgithubcomniotransbigdatarawmainimagestbdexamplegif exampl taxi gp data process follow exampl show use transbigdata perform data grid data aggreg data visual taxi gp data read data python import transbigdata tbd import panda pd read taxi gp data data pdread_csvtaxidatasamplecsvhead none datacolumn vehiclenumtimelonlatopenstatusspe data div tabl border classdatafram thead tr styletextalign right thth thvehiclenumth thtimeth thlonth thlatth thopenstatusth thspeedth tr thead tbodi tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tbodi tabl p row columnsp div data preprocess defin studi area use tbdclean_outofbound method delet data studi area python defin studi area bound delet data studi area data tbdclean_outofboundsdatabound boundscol lonlat data grid basic way express data distribut form geograp grid transbigdata provid method gener multipl type geograph grid rectangular grid hexagon grid research area rectangular grid need determin grid paramet first interpret defin grid coordin system python obtain grid paramet param tbdarea_to_paramsboundsaccuraci param slon slat deltalon deltalat theta method rect gridsiz grid paramet store inform initi posit size angl grid system next step map gp data correspond grid use tbdgps_to_grid gener loncol column latcol column rectangular grid two column togeth specifi grid python map gp data grid dataloncoldatalatcol tbdgps_to_griddatalondatalatparam count amount data grid gener geometri grid transform geodatafram python aggreg data grid grid_agg datagroupbyloncollatcolvehiclenumcountreset_index gener grid geometri grid_agggeometri tbdgrid_to_polygongrid_aggloncolgrid_agglatcolparam chang type geodatafram import geopanda gpd grid_agg gpdgeodataframegrid_agg plot grid grid_aggplotcolumn vehiclenumcmap autumn_r pnghttpsgithubcomniotransbigdatarawmainimagesoutput__png triangl hexagon grid rotat angl transbigdata also support triangl hexagon grid also support given rotat angl grid alter grid paramet python set hexagon grid paramsmethod hexa set triangl grid paramsmethod tri set rotat angl degre paramstheta gp data match python triangl hexagon grid requir three column store id dataloncol_dataloncol_dataloncol_ tbdgps_to_griddatalondatalatparam aggreg data grid grid_agg datagroupbyloncol_loncol_loncol_vehiclenumcountreset_index gener grid geometri grid_agggeometri tbdgrid_to_polygongrid_aggloncol_grid_aggloncol_grid_aggloncol_param chang type geodatafram import geopanda gpd grid_agg gpdgeodataframegrid_agg plot grid grid_aggplotcolumn vehiclenumcmap autumn_r pnghttpsgithubcomniotransbigdatarawmainimagereadmepng data visualizationwith basemap geograph data visual figur still add basemap colorbar compass scale use tbdplot_map load basemap tbdplotscal add compass scale matplotlib figur python import matplotlibpyplot plt fig pltfiguredpi ax pltsubplot pltscaax load basemap tbdplot_mappltboundszoom style defin colorbar cax pltax plttitledata count pltscaax plot data grid_aggplotcolumn vehiclenumcmap autumn_rax axcax caxlegend true add scale tbdplotscaleaxbound boundstexts compasss accuraci rect zorder pltaxisoff pltxlimboundsbound pltylimboundsbound pltshow pnghttpsgithubcomniotransbigdatarawmainimagereadmepng gride framework offer transbigdata overview grid framework offer transbigdata pnghttpsgithubcomniotransbigdatarawmainimagereadmepng see examplehttpsgithubcomniotransbigdatablobmainexampletbd_core_functionsipynb detail citat inform doihttpszenodoorgbadgesvghttpszenodoorgbadgelatestdoi statushttpsjosstheojorgpapersdfedfadcffcbcabstatussvghttpsjosstheojorgpapersdfedfadcffcbcab pleas cite thishttpsdoiorgjoss use transbigdata research citat inform found citationcffhttpsgithubcomniotransbigdatablobmaincitationcff introduc video chines bilibilihttpsimgshieldsiobadgebilibiliecebeebfeadeadaebfgreensvghttpsspacebilibilicom bilibilihttpswwwbilibilicomvideobvnaisd youtubehttpswwwyoutubecomwatchvynqjwmpiq titl transbigdata python packag transport spatiotempor big data process analysi visual tag python transport spatiotempor data geospati data gi data qualiti analysi data preprocess data visual taxi gp data bu gp data bike share data author name qing yu orcid affili name jian yuancorrespond author orcid affili affili name key laboratori road traffic engin ministri educ tongji univers caoan road shanghai peopl republ china index date novemb bibliographi paperbib summari recent year data gener field transport begun explod individu continu track data mobil phone data ic smart card data taxi gp data bu gp data bicycl share order data also known spatiotempor big data track trace data harrison great potenti applic datadriven transport research spatiotempor big data typic requir three aspect inform zhang character high data qualiti larg collect scope finegrain spatiotempor inform fulli captur daili activ individu travel behavior citi tempor spatial dimens emerg data provid new way opportun potenti transport demand analysi travel mechan understand support urban transport plan manag chen zhang howev process multisourc spatiotempor big data usual requir seri similar process procedur eg data qualiti assess data preprocess data clean data grid data aggreg data visual urgent need onesizefitsal tool adapt variou process demand differ transport data field state art typic process spatiotempor data analysi involv multipl procedur includ data acquisit data preprocess data analysi data visual etc current exist sever open sourc packag domain data acquisit aspect exist softwar mainli provid data acquisit basic geospati data osmnx boeingosmnx python packag download geospati data openstreetmap packag provid tool gener synthet mobil data use standard mathemat model scikitmobl scikitmobl librari allow manag gener mobil data variou format data preprocess data analysi spatiotempor data field transport involv multipl sourc data exist tool develop specif type data trajectori data air traffic data etc movingpanda grasermovingpanda provid trajectori data structur function data explor visual ptrail haidriptrail librari mobil data preprocess especi featur gener trajectori interpol traffic oliv toolbox process analyz air traffic data trackintel axhausendefinit framework spatiotempor analysi track data focus human mobil pysal pysal rey famili packag allow advanc geospati data scienc support develop highlevel applic data visual apart data process movingpanda also support trajectori visual movevi movevi provid tool visual movement data tempor chang environment data creat video anim travia siebinga provid tool visual annot movement data interact approach abovement librari provid preprocess geometr analysi function sepcif aspect howev much remain done deal task transform raw spatiotempor data valuabl insight librari provid singl solut thu librari compat exist tool provid analysi framework transport spatiotempor big data effect facilit research progress field statement need transbigdata python packag develop transport spatiotempor big data process analysi visual provid fast concis method process taxi gp data bicycl share data bu gp data exampl varieti process method stage transport spatiotempor big data analysi includ code base transbigdata provid clean effici flexibl easi use api allow complex data task achiev concis code alreadi use number scientif public yu yu litaxi yupartit type data transbigdata also provid target tool specif need extract origin destin od taxi trip taxi gp data identif arriv departur inform bu gp data current transbigdata mainli provid follow method data qualiti provid method quickli obtain gener inform dataset includ data amount time period sampl interv data preprocess provid method fix multipl type data error data grid provid method gener multipl type geograph grid rectangular hexagon research area provid fast algorithm map gp data gener grid autoreffigfig data aggreg provid method aggreg gp od data geograph polygon trajectori process provid quick method reorgan data structur implement data augment variou data format includ gener trajectori linestr gp point trajectori densif etc data visual builtin visual capabl leverag visual packag keplergl interact visual data jupyt notebook simpl code basemap load provid method display mapbox basemap matplotlib figur autoreffigfig target audienc transbigdata includ data scienc research data engin field transport big data smart transport system urban comput particularli want integr innov algorithm intellig trasnport system govern enterpris entiti expect effici reliabl manag decis support transport spatiotempor data analysi latest stabl releas softwar instal via pip full document found httpstransbigdatareadthedocsioenlatest transbigdatacodecodecodecodecodecodecodecod gener rectangular grid aggreg gp data gridslabelfigfigimagesfigurepng width transbigdatacodecodecodecodecodecodecodecod visual taxi trip od display basemap matplotlibcodecodecodecodecodecodecodecodelabelfigfigimagesfigurepng width refer name featur request suggest idea project titl label assigne featur request relat problem pleas describ clear concis descript problem ex im alway frustrat describ solut youd like clear concis descript want happen describ altern youv consid clear concis descript altern solut featur youv consid addit context add context screenshot featur request name bug report creat report help us improv titl label assigne describ bug clear concis descript bug reproduc step reproduc behavior go click scroll see error expect behavior clear concis descript expect happen screenshot applic add screenshot help explain problem desktop pleas complet follow inform os eg io browser eg chrome safari version eg smartphon pleas complet follow inform devic eg iphon os eg io browser eg stock browser safari version eg addit context add context problem _bikedata 共享单车数据处理 function transbigdatabikedata_to_oddatacol bike_iddata_timelongitudelatitudelock_statusstartend none 输入共享单车订单数据只在开关锁时产生数据指定列名提取其中的骑行与停车信息 输入 data datafram 共享单车订单数据只在开关锁时产生数据 col list 列名顺序不能变分别为单车id时间经度纬度锁状态例如bike_iddata_timelongitudelatitudelock_statu startend list 传入的为开始时间结束时间如 如传入则考虑观测时段开始时到单车第一次出现与单车最后一次出现到观测时段结束的骑行与停车情况 输出 move_data datafram 骑行订单数据 stop_data datafram 停车数据 公交地铁网络拓扑建模 function transbigdatasplit_subwaylinelinestop 用公交地铁站点对公交地铁线进行切分得到断面 输入 line geodatafram 公交地铁线路 stop geodatafram 公交地铁站点 输出 metro_line_split geodatafram 生成的断面线型 function transbigdatametro_networkstoptraveltim transfertim nxgraph true 输入站点信息输出网络信息该方法依赖于networkx 输入 stop geodatafram 公交站点 traveltim number 每个轨道断面的出行时长 transfertim number 每个轨道换乘的时长 nxgraph bool 默认true如果true则直接输出由networkx构建的网络g如果为false则输出网络的边edgeedge和节点nod 输出 g networkxclassesgraphgraph networkx构建的网络gnxgraph参数为true时只输出这个 edg datafram 轨道断面的边nxgraph参数为false时输出这个 edg datafram 轨道换乘的边nxgraph参数为false时输出这个 node list 网络节点nxgraph参数为false时输出这个 数据可视化 在jupyter中显示可视化的设置 transbigdata包也依托于keplergl提供的可视化插件提供了一键数据整理与可视化的方法 使用此功能请先安装python的keplergl包 pip instal keplergl 如果要在jupyt notebook中显示可视化则需要勾选jupyterjswidgets可能需要另外安装和keplergljupyter两个插件 imag _staticjupytersettingspng 数据点分布可视化 function transbigdatavisualization_datadatacol lonlataccuraci height maptyp pointzoom auto 输入数据点集计并可视化 输入 data datafram 数据点分布 col list 列名可输入不带权重的od按经度纬度的顺序此时会自动集计 也可输入带权重的od按经度纬度数量的顺序 zoom number 地图缩放等级默认auto自动选择 height number 地图图框高度 accuraci number 集计的栅格大小 maptyp str 出图类型point或者heatmap 输出 vmap keplerglkeplerglkeplergl keplergl提供的可视化 使用方法 import transbigdata tbd import panda pd 读取数据 data pdread_csvtaxidatasamplecsvhead none datacolumn vehiclenumtimelnglatopenstatusspe 可视化数据点分布 tbdvisualization_datadatacol lnglataccuraci imag exampletaxidatavispng 轨迹可视化 function transbigdatavisualization_triptrajdatacol lnglatidtimezoom height 输入轨迹数据与列名生成kepler的可视化 输入 trajdata datafram 轨迹点数据 col list 列名按经度纬度轨迹编号时间的顺序 zoom number 地图缩放等级 height number 地图图框高度 输出 vmap keplerglkeplerglkeplergl keplergl提供的可视化 使用方法 import transbigdata tbd import panda pd 读取数据 data pdread_csvtaxidatasamplecsvhead none datacolumn vehiclenumtimelnglatopenstatusspe 轨迹数据可视化 tbdvisualization_tripdatacol lng lat vehiclenum time imag exampletaxikeplertrajpng od可视化 function transbigdatavisualization_ododdatacol slonslatelonelatzoom autoheightaccuraci mincount 输入od数据与列名生成kepler的可视化 输入 oddata datafram od数据 col list 列名可输入不带权重的od按起点经度起点纬度终点经度终点纬度的顺序此时会自动集计 也可输入带权重的od按起点经度起点纬度终点经度终点纬度数量的顺序 zoom number 地图缩放等级默认auto自动选择 height number 地图图框高度 accuraci number 集计的栅格大小 mincount number 最小的od数少于这个的od就不显示了 输出 vmap keplerglkeplerglkeplergl keplergl提供的可视化 使用方法 import transbigdata tbd import panda pd 读取数据 data pdread_csvtaxidatasamplecsvhead none datacolumn vehiclenumtimelnglatopenstatusspe 提取od oddata tbdtaxigps_to_oddatacol vehiclenumtimelnglatopenstatu od可视化 tbdvisualization_ododdata imag exampletaxiodvisualizationpng _getting_start 安装依赖 安装 transbigdata依赖geopandas在安装transbigdata前需要根据 这个链接 httpsgeopandasorgenstablegetting_startedhtmlinstallation_ 中的方法安装geopanda 如果你已经安装了geopandas则直接在命令提示符中运行下面代码即可安装 pip instal u transbigdata 在python中运行下面代码 import transbigdata tbd 依赖包 transbigdata依赖如下包 panda shape rtree geopanda scipi matplotlib plot_map coordinatesconvert networkx option igraph option osmnx option seaborn option keplergl option leuvenmapmatch option _traj 轨迹处理 停留与出行识别 function transbigdatatraj_stay_movedataparamscol iddatatimelongitudelatitudeactivitytim 输入轨迹数据与栅格化参数识别活动与出行 输入 data datafram 轨迹数据集 param list 栅格化参数 col list 数据的列名个体时间经度纬度顺序 activitytim number 多长时间识别为停留 输出 stay datafram 个体停留信息 move datafram 个体移动信息 function transbigdataplot_activitydatacol stimeetimeloncollatcol 输入个体的活动数据单一个体绘制活动图 输入 data datafram 活动数据集 col list 列名分别为活动开始时间活动结束时间活动所在栅格经度编号活动所在栅格纬度编号 轨迹线型生成 function transbigdatapoints_to_trajtraj_pointscol lnglatidtimecol none 输入轨迹点生成轨迹线型的geodatafram 输入 traj_point datafram 轨迹点数据 col list 列名按经度纬度轨迹编号的顺序 timecol str 可选时间列的列名如果给了则输出带有经度纬度高度时间的geojson可放入kepler中可视化轨迹 输出 traj geodataframe或json 生成的轨迹数据如果timecol没定义则为geodataframe否则为json 轨迹增密与稀疏化 function transbigdatatraj_densifydatacol vehicleidtimelnglattimegap 轨迹点增密确保每隔timegap秒会有一个轨迹点 输入 data datafram 数据 col list 列名按车辆id时间经度纬度的顺序 timegap number 单位为秒每隔多长时间插入一个轨迹点 输出 data datafram 处理后的数据 function transbigdatatraj_sparsifydatacol vehicleidtimelnglattimegap 轨迹点稀疏化轨迹数据采样间隔过高的时候数据量太大不便于分析这个函数可以将采样间隔扩大缩减数据量 输入 data datafram 数据 col list 列名按车辆id时间经度纬度的顺序 timegap number 单位为秒每隔多长时间一个轨迹点 method str 可选interpolate插值或subsample子采样 输出 data datafram 处理后的数据 使用方法 import transbigdata tbd import panda pd 读取数据 data pdread_csvtaxidatasamplecsvhead none datacolumn vehicleidtimelnglatopenstatusspe datatim pdto_datetimedatatim 轨迹增密前的采样间隔 tbddata_summarydatacol vehicleidtimelnglatshow_sample_durationtru 数据量 数据总量 条 个体总量 个 个体数据量均值 条 个体数据量上四分位 条 个体数据量中位数 条 个体数据量下四分位 条 数据时间段 开始时间 结束时间 个体采样间隔 均值 秒 上四分位 秒 中位数 秒 下四分位 秒 进行轨迹增密设置秒一条数据 data tbdtraj_densifydatatimegap 轨迹增密后的采样间隔 tbddata_summarydatashow_sample_durationtru 数据量 数据总量 条 个体总量 个 个体数据量均值 条 个体数据量上四分位 条 个体数据量中位数 条 个体数据量下四分位 条 数据时间段 开始时间 结束时间 个体采样间隔 均值 秒 上四分位 秒 中位数 秒 下四分位 秒 增密后的效果 imag exampletaxidensifypng 两辆车的数据测试 tmp datailoc tmp datailoc tmp tmpappendtmp 增密前数据 import geopanda gpd tmpgeometri gpdpoints_from_xytmplngtmplat tmp gpdgeodataframetmp tmptmpvehicleidplot 进行轨迹增密设置秒一条数据 tmp tbdtraj_densifytmptimegap import geopanda gpd tmpgeometri gpdpoints_from_xytmplngtmplat tmp gpdgeodataframetmp tmptmpvehicleidplot 轨迹稀疏化秒一条数据 tmp tbdtraj_sparsifytmptimegap import geopanda gpd tmpgeometri gpdpoints_from_xytmplngtmplat tmp gpdgeodataframetmp tmptmpvehicleidplot imag exampletaxisparsifypng _gisprocess gis处理 近邻匹配 下面的案例展示如何用transbigdata包进行点与点点与线的近邻匹配该方法使用的是kdtree算法可查看wikihttpsenwikipediaorgwikikd_tree算法复杂度为ologn 点与点匹配dataframe与datafram 导入transbigdata包 import transbigdata tbd 生成两个geodataframe表但它们只有经纬度列 import panda pd import geopanda gpd shapelygeometri import linestr dfa gpdgeodatafram column lonlat dfb gpdgeodataframecolumn lonlat 使用tbdckdnearest进行点与点匹配如果是dataframe与dataframe匹配不含有地理信息则需要指定前后两个表的经纬度列 function transbigdatackdnearestdfa_origindfb_originanam lonlatbnam lonlat 输入两个dataframe分别指定经纬度列名为表a匹配表b中最近点并计算距离 输入 dfa_origin datafram 表a dfb_origin datafram 表b anam list 表a中经纬度列字段 bname list 表b中经纬度列字段 输出 gdf datafram 为a匹配到b上最近点的表 tbdckdnearestdfadfbanamelonlatbnamelonlat 此时计算出的距离为经纬度换算实际距离 raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thlonth thlatth thindexth thlonth thlatth thdistth tr thead tbodi tr thth tdtd tdtd tdtd tdtd tdtd tdetd tr tr thth tdtd tdtd tdtd tdtd tdtd tdetd tr tr thth tdtd tdtd tdtd tdtd tdtd tdetd tr tr thth tdtd tdtd tdtd tdtd tdtd tdetd tr tr thth tdtd tdtd tdtd tdtd tdtd tdetd tr tr thth tdtd tdtd tdtd tdtd tdtd tdetd tr tr thth tdtd tdtd tdtd tdtd tdtd tdetd tr tbodi tabl div 点与点匹配geodataframe与geodatafram 将a表b表变为含有点信息的geodatafram dfageometri gpdpoints_from_xydfalondfalat dfbgeometri gpdpoints_from_xydfblondfblat 使用tbdckdnearest_point进行点与点匹配 function transbigdatackdnearest_pointgda gdb 输入两个geodataframegdfagdfb均为点该方法会为gdfa表连接上gdfb中最近的点并添加距离字段dist 输入 gda geodatafram 表a点要素 gdb geodatafram 表b点要素 输出 gdf geodatafram 为a匹配到b上最近点的表 tbdckdnearest_pointdfadfb 此时计算出的距离为经纬度距离 raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thlonth thlatth thgeometry_xth thdistth thindexth thlonth thlatth thgeometry_yth tr thead tbodi tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdpoint td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdpoint td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdpoint td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdpoint td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdpoint td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdpoint td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdpoint td tr tbodi tabl div 点与线匹配geodataframe与geodatafram 将a表变为地理点b表为线 dfageometri gpdpoints_from_xydfalondfalat dfbgeometri linestr linestr linestr dfbplot imag _staticoutput__png function transbigdatackdnearest_linegdfa gdfb 输入两个geodataframe其中gdfa为点gdfb为线该方法会为gdfa表连接上gdfb中最近的线并添加距离字段dist 输入 gda geodatafram 表a点要素 gdb geodatafram 表b线要素 输出 gdf geodatafram 为a匹配到b中最近的线 用tbdckdnearest_line可以实现点匹配线其原理是将线中的折点提取然后使用点匹配点 tbdckdnearest_linedfadfb 此时计算出的距离为经纬度距离 raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thlonth thlatth thgeometry_xth thdistth thindexth thlonth thlatth thgeometry_yth tr thead tbodi tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdlinestr td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdlinestr td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdlinestr td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdlinestr td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdlinestr td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdlinestr td tr tr thth tdtd tdtd tdpoint td tdtd tdtd tdtd tdtd tdlinestr td tr tbodi tabl div 打断线 在实际应用中我们可能会需要把很长的线打断为很多子线段每一条线段不要超过一定的最大长度此时则可以使用transbigdata包中的splitline_with_length方法 function transbigdatasplitline_with_lengthcenterlinemaxlength 输入线geodataframe要素打断为最大长度maxlength的小线段 输入 centerlin geodatafram 线要素 maxlength number 打断的线段最大长度 输出 splitedlin geodatafram 打断后的线 下面演示如何将线打断为米一段的线段 读取线要素 import geopanda gpd centerlin gpdread_filertest_linesjson centerlineplot imag splitlineoutput__png 转换线为投影坐标系 centerlinecr initepsg centerlin centerlineto_crsepsg 计算线的长度 centerlinelength centerlinelength centerlin raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thidth thgeometryth thlengthth tr thead tbodi tr thth tdtd tdlinestr td tdtd tr tr thth tdtd tdlinestr td tdtd tr tr thth tdtd tdlinestr td tdtd tr tr thth tdtd tdlinestr td tdtd tr tr thth tdtd tdlinestr td tdtd tr tr thth tdtd tdlinestr td tdtd tr tr thth tdtd tdlinestr td tdtd tr tr thth tdtd tdlinestr td tdtd tr tr thth tdtd tdlinestr td tdtd tr tr thth tdtd tdlinestr td tdtd tr tbodi tabl div 将线打断为最长米的线段 import transbigdata tbd splitedlin tbdsplitline_with_lengthcenterlinemaxlength 打断后线型不变 splitedlineplot imag splitlineoutput__png 但内容已经变成一段一段了 splitedlin raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thgeometryth thidth thlengthth tr thead tbodi tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tr thth tdlinestr td tdtd tdtd tr tbodi tabl div 面要素处理 面合并 function transbigdatamerge_polygondatacol 输入多边形geodataframe数据以及分组列名col对不同组别进行分组的多边形进行合并 输入 data geodatafram 多边形数据 col str 分组列名 输出 data geodatafram 合并后的面 对面取外边界构成新多边形 function transbigdatapolyon_exteriordataminarea 输入多边形geodataframe数据对多边形取外边界构成新多边形 输入 data geodatafram 多边形数据 minarea number 最小面积小于这个面积的面全部剔除 输出 data geodatafram 处理后的面 置信椭圆 置信椭圆参数估计 function transbigdataellipse_paramsdatacol lonlatconfid epsg none 输入点数据获取置信椭圆的参数 输入 data datafram 点数据 confid number 置信度可选 epsg number 如果给了则将原始坐标从wgs转换至给定epsg坐标系下进行置信椭圆参数估计 col list 以经度纬度形式存储的列名 输出 param list 质心椭圆参数分别为poswidthheightthetaareaalpha 对应中心点坐标短轴长轴角度面积方向性 置信椭圆绘制 function transbigdataellipse_plotellip_paramsaxkwarg 输入置信椭圆的参数绘制置信椭圆 输入 ellip_param list ax matplotlibaxes_subplotsaxessubplot 画板 用法 import panda pd import transbigdata tbd import numpi np 生成测试用数据 data nprandomuniform data datanprandomuniform data pddataframedatacolumn xy 绘制数据分布 import matplotlibpyplot plt pltfigur 绘制数据点 pltscatterdataxdatay 绘制坐标轴 pltplotc k pltplotc k pltxlim pltylim pltshow imag gisprocessoutput__png 输入数据与xy坐标所在列名置信度估计椭圆参数 分别代表中心点坐标短轴长轴角度面积扁率 ellip_param tbdellipse_paramsdataconfidencecol xy ellip_param parsedliter array 再用tbdellipse_plot绘制置信椭圆 绘制数据分布 import matplotlibpyplot plt pltfigur ax pltsubplot 绘制数据点 pltscatterdataxdatay 获取置信椭圆参数并绘制椭圆 置信椭圆 ellip_param tbdellipse_paramsdataconfidencecol xy tbdellipse_plotellip_paramsaxfil falseedgecolor rlinewidth 置信椭圆 ellip_param tbdellipse_paramsdataconfidencecol xy tbdellipse_plotellip_paramsaxfil falseedgecolor blinewidth 置信椭圆 ellip_param tbdellipse_paramsdataconfidencecol xy tbdellipse_plotellip_paramsaxfil falseedgecolor klinewidth 绘制坐标轴 pltplotc k pltplotc k pltxlim pltylim pltshow imag gisprocessoutput__png _preprocess 数据预处理 各类数据通用的预处理 function transbigdataclean_samedatacol vehiclenumtimelnglat 删除信息与前后数据相同的数据以减少数据量 如某个体连续n条数据除了时间以外其他信息都相同则可以只保留首末两条数据 输入 data datafram 数据 col list 列名按个体id时间经度纬度的顺序可以传入更多列会以时间排序再判断除了时间以外其他列的信息 输出 data datafram 清洗后的数据 function transbigdataclean_driftdatacol vehiclenumtimelnglatspeedlimit 删除漂移数据条件是此数据与前后的速度都大于speedlimit但前后数据之间的速度却小于speedlimit 传入的数据中时间列如果为datetime格式则计算效率更快 输入 data datafram 数据 col list 列名按个体id时间经度纬度的顺序 输出 data datafram 研究范围内的数据 function transbigdataclean_outofboundsdataboundscol lnglat 输入研究范围的左下右上经纬度坐标剔除超出研究范围的数据 输入 data datafram 数据 bound list 研究范围的左下右上经纬度坐标顺序为lonlatlonlat col list 经纬度列名 输出 data datafram 研究范围内的数据 function transbigdataclean_outofshapedatashapecol lnglataccuraci 输入研究范围的geodataframe剔除超出研究区域的数据 输入 data datafram 数据 shape geodatafram 研究范围的geodatafram col list 经纬度列名 accuraci number 计算原理是先栅格化后剔除这里定义栅格大小越小精度越高 输出 data datafram 研究范围内的数据 function transbigdataid_reindexdatacolnew falsetimegap nonetimecol nonesuffix _newsampl none 对数据的id列重新编号 输入 data datafram 数据 col str 要重新编号的id列名 new bool false相同id的新编号相同true依据表中的顺序id再次出现则编号不同 timegap number 如果个体在一段时间内没出现timegap为时间阈值则编号为新的个体此参数与timecol同时设定才有效果 timecol str 时间字段名称此参数与timegap同时设定才有效果 suffix str 新编号列名的后缀设置为false时替代原有列名 sampl int 传入数值对重新编号的个体进行抽样 输出 data datafram 重新编号的数据 function transbigdataid_reindex_disgapdatacol uidlonlatdisgapsuffix _new 对数据的id列重新编号如果相邻两条记录超过距离则编号为新id 输入 data datafram 数据 col str 要重新编号的id列名 disgap number 如果个体轨迹超过一定距离则编号为新的个体 suffix str 新编号列名的后缀 输出 data datafram 重新编号的数据 数据格式转换 function transbigdatadumpjsondatapath 输入json数据存储为文件这个方法主要是解决numpy数值型无法兼容json包报错的问题 输入 data json 要储存的json数据 path str 保存的路径 轨迹数据清洗 function transbigdataclean_trajdatacol uidstr_timelonlattripgap disgap speedlimit 轨迹数据清洗组合拳 输入 data datafram 轨迹数据 col list 列名以个体id时间经度纬度排列 tripgap number 多长的时间视为新的出行 disgap number 多长距离视为新的出行 speedlimit number 车速限制 输出 data datafram 清洗后的数据 出租车数据的预处理 function transbigdataclean_taxi_statusdatacol vehiclenumtimeopenstatustimelimit none 删除出租车数据中载客状态瞬间变化的记录这些记录的存在会影响出行订单判断 判断条件为如果对同一辆车上一条记录与下一条记录的载客状态都与本条记录不同则本条记录应该删去 输入 data datafram 数据 col list 列名按车辆id时间载客状态的顺序 timelimit number 可选单位为秒上一条记录与下一条记录的时间小于该时间阈值才予以删除 输出 data datafram 清洗后的数据 _grid 数据栅格化 栅格时空数据处理框架 function transbigdataarea_to_gridloc accuraci methodrect paramsauto 从研究范围生成栅格 输入 locat boundslist shapegeodatafram 在哪生成栅格 如果是生成范围的边界bounds则内容为lonlatlonlat wgs坐标系 其中lonlat是左下角坐标lonlat是右上角坐标 如果是面要素则必须是geodatafram accuraci number 栅格大小米 method str rect方形 tri三角形或hexa六边形 param list dict 栅格参数如果给定了栅格参数accuracy参数将不起作用 输出 grid geodatafram 栅格的geodatafram param list dict 栅格参数 function transbigdataarea_to_paramsloc accuraci methodrect 从研究范围生成栅格参数 输入 locationboundslist shapegeodatafram 在哪生成栅格 如果是生成范围的边界bounds则内容为lonlatlonlat wgs坐标系 其中lonlat是左下角坐标lonlat是右上角坐标 如果是面要素则必须是geodatafram accuraci number 栅格大小米 method str rect方形 tri三角形或hexa六边形 输出 param list dict 栅格参数 function transbigdatagps_to_gridlon lat param gps数据对应栅格编号输入数据的经纬度列与栅格参数输出对应的栅格编号 输入 lon seri 经度列 lat seri 纬度列 param list dict 栅格参数 输出 方形栅格输出 loncollatcol list 栅格编号两列 三角形六边形栅格输出 loncol_loncol_loncol_ list 栅格编号三列 function transbigdatagrid_to_centregridid param 栅格编号对应栅格中心点经纬度输入数据的栅格编号与栅格参数输出对应的栅格中心点 输入 gridid list 方形栅格 loncollatcol list 栅格编号两列 三角形六边形栅格 loncol_loncol_loncol_ list 栅格编号三列 param list dict 栅格参数 输出 hblon seri 栅格中心点经度列 hblat seri 栅格中心点纬度列 function transbigdatagrid_to_polygongridid param 栅格编号生成栅格的地理信息列输入数据的栅格编号与栅格参数输出对应的地理信息列 输入 gridid list 方形栅格 loncollatcol list 栅格编号两列 三角形六边形栅格 loncol_loncol_loncol_ list 栅格编号三列 param list dict 栅格参数 输出 geometri seri 栅格的矢量图形列 function transbigdatagrid_to_areadata shape param colloncol latcol 输入数据带有栅格经纬度编号两列矢量图形与栅格化参数输出数据栅格并对应矢量图形 输入 data datafram 数据带有栅格经纬度编号列 shape geodatafram 矢量图形 param list dict 栅格参数 col list 列名方型栅格下为loncollatcol 三角形六边形栅格为loncol_loncol_loncol_ 输出 data datafram 数据对应至矢量图形 function transbigdatagrid_to_paramsgrid 从栅格数据重新生成栅格参数目前仅支持方形栅格 输入 grid geodatafram transbigdata中生成的方形栅格 输出 param list dict 栅格参数 栅格参数的优化 function transbigdatagrid_params_optimizedatainitialparamscoluidlonlatoptmethodcenterdistprintlogfalsesampl 提供了三种优化栅格化参数的方法 输入 data datafram 轨迹数据 initialparam list 初始栅格化参数 col list 列名 uidlonlat optmethod str 优化方法 centerdist gini gridscount printlog bool 是否打印日志 sampl int 抽样数据量设置为则不抽样 输出 params_optim list 优化后的栅格化参数 geohash编码 geohash是一种公共域地理编码系统它的作用是将经纬度地理位置编码为字母和数字组成的字符串字符串也可解码为经纬度每个字符串代表一个网格编号字符串的长度越长则精度越高根据 wiki httpsenwikipediaorgwikigeohash__ geohash字符串长度对应精度表格如下 geohash lengthprecis lat bit lng bit lat error lng error km error transbigdata包中也提供了geohash的处理功能主要包括三个函数 function transbigdatageohash_encodelonlatprecis 输入经纬度与精度输出geohash编码 输入 lon seri 经度列 lat seri 纬度列 precis number geohash精度 输出 lon seri 经度列 lat seri 纬度列 function transbigdatageohash_decodegeohash 输入经纬度与精度输出geohash编码 输入 geohash seri geohash编码列 输出 geohash seri geohash编码列 function transbigdatageohash_togridgeohash 输入geohash编码输出geohash网格的地理信息图形series列 输入 geohash seri geohash编码列 输出 poli seri geohash的栅格列 相比transbigdata包中提供的方形栅格处理方法geohash更慢也无法提供自由定义的栅格大小下面的示例展示如何利用这三个函数对数据进行geohash编码集计并可视化 import transbigdata tbd import panda pd import geopanda gpd 读取数据 data pdread_csvtaxidatasamplecsvhead none datacolumn vehiclenumtimeslonslatopenstatusspe 依据经纬度geohash编码精确度选时栅格大小约为km datageohash tbdgeohash_encodedataslondataslatprecis datageohash parsedliter wsbtw wsbtz wsbtz wsbtz wsbi wsq ws wsf ws wstq name geohash length dtype object 基于geohash编码集计 dataagg datagroupbygeohashvehiclenumcountreset_index geohash编码解码为经纬度 dataagglon_geohashdataagglat_geohash tbdgeohash_decodedataagggeohash geohash编码生成栅格矢量图形 dataagggeometri tbdgeohash_togriddataagggeohash 转换为geodatafram dataagg gpdgeodataframedataagg dataagg raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thgeohashth thvehiclenumth thlon_geohashth thlat_geohashth thgeometryth tr thead tbodi tr thth tdwufxtd tdtd tdtd tdtd tdpolygon td tr tr thth tdwebzztd tdtd tdtd tdtd tdpolygon td tr tr thth tdwebzztd tdtd tdtd tdtd tdpolygon td tr tr thth tdwebzzdtd tdtd tdtd tdtd tdpolygon td tr tr thth tdwebzzftd tdtd tdtd tdtd tdpolygon td tr tr thth tdtd tdtd tdtd tdtd tdtd tr tr thth tdwsdutd tdtd tdtd tdtd tdpolygon td tr tr thth tdwsddhtd tdtd tdtd tdtd tdpolygon td tr tr thth tdwsddjtd tdtd tdtd tdtd tdpolygon td tr tr thth tdwsddmtd tdtd tdtd tdtd tdpolygon td tr tr thth tdwsddqtd tdtd tdtd tdtd tdpolygon td tr tbodi tabl p row columnsp div 设定绘图边界 bound 创建图框 import matplotlibpyplot plt import plot_map fig pltfiguredpi ax pltsubplot pltscaax 添加地图底图 tbdplot_mappltboundszoom style 绘制colorbar cax pltax plttitlecount pltscaax 绘制geohash的栅格集计 dataaggplotax axcolumn vehiclenumcax caxlegend true 添加比例尺和指北针 tbdplotscaleaxbound boundstexts compasss accuraci rect zorder pltaxisoff pltxlimboundsbound pltylimboundsbound pltshow imag geohashoutput__png 旧方法 function transbigdatarect_gridslocationaccuraci paramsauto 该方法已经更名为area_to_grid httpstransbigdatareadthedocsioenlatestgridshtmltransbigdataarea_to_grid_ 生成研究范围内的方形栅格 输入 locat boundslist shapegeodatafram 在哪生成栅格 如果是生成范围的边界bounds则内容为lonlatlonlat wgs坐标系 其中lonlat是左下角坐标lonlat是右上角坐标 如果是面要素则必须是geodatafram accuraci number 栅格大小米 param list 栅格参数lonstartlatstartdeltalondeltalat或lonstartlatstartdeltalondeltalattheta其中lonstartlatstart分别为栅格左下角坐标deltalondeltalat为单个栅格的经纬度长宽theta为栅格的角度不给则默认为 默认值为auto自动生成当给定栅格参数时栅格大小将从栅格参数中计算得到 输出 grid geodatafram 栅格的geodataframe其中loncol与latcol为栅格的编号hblon与hblat为栅格的中心点坐标 param list 栅格参数lonstartlatstartdeltalondeltalat或lonstartlatstartdeltalondeltalattheta其中lonstartlatstart分别为栅格左下角坐标deltalondeltalat为单个栅格的经纬度长宽theta为栅格的角度不给则默认为 设定范围 bound lonlatlonlat gridparam tbdrect_gridsboundsaccuraci function transbigdatagrid_paramsboundsaccuraci 该方法已经更名为area_to_param httpstransbigdatareadthedocsioenlatestgridshtmltransbigdataarea_to_params_ 栅格参数获取 输入 bound list 生成范围的边界lonlatlonlat wgs坐标系 其中lonlat是左下角坐标lonlat是右上角坐标 accuraci number 栅格大小米 输出 param list 栅格参数lonstartlatstartdeltalondeltalat或lonstartlatstartdeltalondeltalattheta其中lonstartlatstart分别为栅格左下角坐标deltalondeltalat为单个栅格的经纬度长宽theta为栅格的角度不给则默认为 bound tbdgrid_paramsboundsaccuraci function transbigdatagps_to_gridslonlatparam 该方法已经更名为gps_to_grid httpstransbigdatareadthedocsioenlatestgridshtmltransbigdatagps_to_grid_ gps数据对应栅格编号输入数据的经纬度列与栅格参数输出对应的栅格编号 输入 lon seri 经度列 lat seri 纬度列 param list 栅格参数lonstartlatstartdeltalondeltalat或lonstartlatstartdeltalondeltalattheta其中lonstartlatstart分别为栅格左下角坐标deltalondeltalat为单个栅格的经纬度长宽theta为栅格的角度不给则默认为 输出 loncol seri 经度栅格编号列 latcol seri 纬度栅格编号列 dataloncoldatalatcol tbdgps_to_gridsdatalngdatalatparam function transbigdatagrids_centreloncollatcolparam 该方法已经更名为grid_to_centr httpstransbigdatareadthedocsioenlatestgridshtmltransbigdatagrid_to_centre_ 栅格编号对应栅格中心点经纬度输入数据的栅格编号与栅格参数输出对应的栅格中心点 输入 loncol seri 经度栅格编号列 latcol seri 纬度栅格编号列 param list 栅格参数lonstartlatstartdeltalondeltalat或lonstartlatstartdeltalondeltalattheta其中lonstartlatstart分别为栅格左下角坐标deltalondeltalat为单个栅格的经纬度长宽theta为栅格的角度不给则默认为 输出 hblon seri 栅格中心点经度列 hblat seri 栅格中心点纬度列 datahblondatahblat tbdgrids_centredataloncoldatalatcolparam function transbigdatagridid_to_polygonloncollatcolparam 该方法已经更名为grid_to_polygon httpstransbigdatareadthedocsioenlatestgridshtmltransbigdatagrid_to_polygon_ 栅格编号生成栅格的地理信息列输入数据的栅格编号与栅格参数输出对应的地理信息列 输入 loncol seri 经度栅格编号列 latcol seri 纬度栅格编号列 param list 栅格参数lonstartlatstartdeltalondeltalat或lonstartlatstartdeltalondeltalattheta其中lonstartlatstart分别为栅格左下角坐标deltalondeltalat为单个栅格的经纬度长宽theta为栅格的角度不给则默认为 输出 geometri seri 栅格的矢量图形列 datageometri tbdgridid_to_polygondataloncoldatalatcolparam function transbigdatagridid_sjoin_shapedatashapeparamscol loncollatcol 该方法已经更名为grid_to_area httpstransbigdatareadthedocsioenlatestgridshtmltransbigdatagrid_to_area_ 输入数据带有栅格经纬度编号两列矢量图形与栅格化参数输出数据栅格并对应矢量图形 输入 data datafram 数据带有栅格经纬度编号两列 shape geodatafram 矢量图形 param list 栅格化参数 col list 列名经度栅格编号纬度栅格编号 输出 data datafram 数据栅格并对应矢量图形 function transbigdataregenerate_paramsgrid 该方法已经更名为grid_to_param httpstransbigdatareadthedocsioenlatestgridshtmltransbigdatagrid_to_params_ 从栅格数据重新生成栅格参数 输入 grid geodatafram transbigdata中生成的grid 输出 param list 栅格参数lonstartlatstartdeltalondeltalat或lonstartlatstartdeltalondeltalattheta其中lonstartlatstart分别为栅格左下角坐标deltalondeltalat为单个栅格的经纬度长宽theta为栅格的角度不给则默认为 function transbigdatagps_to_grids_trilon lat param gps数据对应栅格编号输入数据的经纬度列与栅格参数输出对应的三角边形栅格编号 输入 lon seri 经度列 lat seri 纬度列 param list 栅格参数与方形栅格一致生成栅格参数指定的距离将成为三角形的边长 栅格参数lonstartlatstartdeltalondeltalat或lonstartlatstartdeltalondeltalattheta其中lonstartlatstart分别为栅格左下角坐标deltalondeltalat为单个栅格的经纬度长宽theta为栅格的角度不给则默认为 输出 gridid seri 三角边形栅格编号 function transbigdatagridid_to_polygon_trigridid param 栅格编号生成栅格的地理信息列输入数据的栅格编号与栅格参数输出对应的地理信息列 输入 gridid seri 栅格编号列 param list 栅格参数与方形栅格一致生成栅格参数指定的距离将成为三角形的边长 栅格参数lonstartlatstartdeltalondeltalat或lonstartlatstartdeltalondeltalattheta其中lonstartlatstart分别为栅格左下角坐标deltalondeltalat为单个栅格的经纬度长宽theta为栅格的角度不给则默认为 输出 geometri seri 栅格的矢量图形列 将gps数据匹配至三角形栅格 datagridid tbdgps_to_grids_tridatalondatalatparam 生成几何图形 grid_agggeometri tbdgridid_to_polygon_trigrid_agggrididparam imag _staticwechatimgjpeg height function transbigdatagps_to_grids_hexalon lat param gps数据对应栅格编号输入数据的经纬度列与栅格参数输出对应的六边形栅格编号 输入 lon seri 经度列 lat seri 纬度列 param list 栅格参数与方形栅格一致生成栅格参数指定的距离将成为六边形的边长 栅格参数lonstartlatstartdeltalondeltalat或lonstartlatstartdeltalondeltalattheta其中lonstartlatstart分别为栅格左下角坐标deltalondeltalat为单个栅格的经纬度长宽theta为栅格的角度不给则默认为 输出 gridid seri 六边形栅格编号 function transbigdatagridid_to_polygon_hexagridid param 栅格编号生成栅格的地理信息列输入数据的栅格编号与栅格参数输出对应的地理信息列 输入 gridid seri 六边形栅格编号 param list 栅格参数与方形栅格一致生成栅格参数指定的距离将成为六边形的边长 栅格参数lonstartlatstartdeltalondeltalat或lonstartlatstartdeltalondeltalattheta其中lonstartlatstart分别为栅格左下角坐标deltalondeltalat为单个栅格的经纬度长宽theta为栅格的角度不给则默认为 输出 geometri seri 栅格的矢量图形列 将gps数据匹配至六边形栅格 datagridid tbdgps_to_grids_hexadatalondatalatparam 生成几何图形 grid_agggeometri tbdgridid_to_polygon_hexagrid_agggrididparam imag _staticwechatimgjpeg height _qualiti 数据质量分析 function transbigdatadata_summarydatacol vehicleidtimeshow_sample_dur fals 输入数据打印数据概况 输入 data datafram 轨迹点数据 col list 列名按个体id时间的顺序 show_sample_dur bool 是否输出个体采样间隔信息 roundnum number 小数点取位数 使用方法 import transbigdata tbd import panda pd read data data pdread_csvtaxidatasamplecsvhead none datacolumn vehicleidtimelnglatopenstatusspe datatim pdto_datetimedatatim sampl interv tbddata_summarydatacol vehicleidtimeshow_sample_durationtru amount data total number data item total number individu data volum individualsmean data volum individualsupp quartil data volum individualsmedian data volum individualslow quartil data time period start time end time sampl interv mean upper quartil median lower quartil function transbigdatasample_durationdatacol vehicleidtim 统计数据采样间隔 输入 data datafram 数据 col list 列名按个体id时间的顺序 输出 sample_dur datafram 一列的数据表列名为duration内容是数据的采样间隔单位秒 _odprocess 数据聚合集计 数据集计 function transbigdatadataaggdatashapecol lnglatcountaccuraci 数据集计至小区 输入 data datafram 数据 shape geodatafram 小区 col list 可传入经纬度两列如lnglat此时每一列权重为也可以传入经纬度和计数列三列如lnglatcount accuraci number 计算原理是先栅格化后集计这里定义栅格大小越小精度越高 输出 aggresult geodatafram 小区其中count列为统计结果 data datafram 数据对应上了小区 od集计 function transbigdataodagg_gridoddataparamscol slonslatelonelatarrow fals od集计与地理信息生成栅格输入od数据每一行数据是一个出行栅格化od并集计后生成od的geodatafram 输入 oddata datafram od数据 col list 起终点列名slonslatelonelat此时每一列权重为 也可以传入权重列如slonslatelonelatcount param list 栅格参数lonstartlatstartdeltalondeltalat分别为栅格左下角坐标与单个栅格的经纬度长宽 arrow bool 生成的od地理线型是否包含箭头 输出 oddata geodatafram 集计后生成od的geodatafram function transbigdataodagg_shapeoddatashapecol slonslatelonelatparam noneround_accuraci arrow fals od集计与地理信息生成小区集计输入od数据每一行数据是一个出行栅格化od并集计后生成od的geodatafram 输入 oddata datafram od数据 shape geodatafram 集计小区的geodatafram col list 起终点列名slonslatelonelat此时每一列权重为 也可以传入权重列如slonslatelonelatcount param list 栅格化参数如果传入则先栅格化后以栅格中心点匹配小区如果不传入则直接以经纬度匹配在数据量大时用栅格化进行匹配速度会极大提升 round_accuraci number 集计时经纬度取小数位数 arrow bool 生成的od地理线型是否包含箭头 输出 oddata geodatafram 集计后生成od的geodatafram transbigdata document master file creat sphinxquickstart thu oct adapt file complet like least contain root toctre direct transbigdata 为交通时空大数据而生 imag _staticlogowordmarkdarkpng 主要功能 transbigdata工具针对时空大数据处理而开发依托于geopandastransbigdata集成了交通时空大数据处理过程中常用的方法包括栅格化数据质量分析数据预处理数据集计轨迹分析gis处理地图底图加载坐标与距离计算数据可视化等通用方法transbigdata也针对出租车gps数据共享单车数据公交gps数据等多种常见交通时空大数据提供了快速简洁的处理方法 技术特点 面向交通时空大数据分析不同阶段的处理需求提供不同处理功能 代码简洁高效灵活易用通过简短的代码即可实现复杂的数据任务 transbigdata简介 快速入门 在安装transbigdata之前请确保已经安装了可用的geopandas包httpsgeopandasorgindexhtml 如果你已经安装了geopandas则直接在命令提示符中运行下面代码即可安装 pip instal u transbigdata 下面例子展示如何使用transbigdata工具快速地从出租车gps数据中提取出行od 导入transbigdata包 import transbigdata tbd 读取数据 import panda pd data pdread_csvtaxidatasamplecsvhead none datacolumn vehiclenumtimeslonslatopenstatusspe data imag _staticwxxpng height 使用tbdtaxigps_to_od方法传入对应的列名即可提取出行od 从gps数据提取od oddata tbdtaxigps_to_oddatacol vehiclenumtimeslonslatopenstatu oddata imag _staticwxxpng height 对提取出的od进行od的栅格集计 定义研究范围 bound 输入研究范围边界bounds与栅格宽度accuracy获取栅格化参数 param tbdgrid_paramsbound boundsaccuraci 栅格化od并集计 od_gdf tbdodagg_gridoddataparam od_gdfplotcolumn count imag _staticwxxpng height 使用示例 raw html file galleryhtmlgridhtml 相关链接 小旭学长的b站 httpsspacebilibilicom 小旭学长的七天入门交通时空大数据分析课程零基础免费课 httpswwwlifangshujucomintroduc 小旭学长的交通时空大数据分析课程 httpswwwlifangshujucomintroduc 小旭学长的数据可视化课程 httpswwwlifangshujucomintroduc 本项目的github页面 httpsgithubcomniotransbigdata 有bug请在这个页面提交 httpsgithubcomniotransbigdataissu 安装 toctre caption 安装 maxdepth getting_startedrst 使用示例 toctre caption 使用示例 maxdepth exampletaxiexampletaxirst examplebusgpsexamplebusgpsrst metromodelmetromodelrst examplepneumaexamplepneumarst examplebikesharingexamplebikesharingrst 通用方法 toctre caption 通用方法 maxdepth qualityrst preprocessrst gridsrst odprocessrst visualizationrst getbusdatarst trajrst gisprocessrst plot_maprst coordinatesconverterrst 各类数据处理方法 toctre caption 各类数据处理方法 maxdepth taxigpsrst bikedatarst busgpsrst metrolinerst 数据获取 获取公交线路 function transbigdatagetbusdatacitykeywordsaccuratetru 通过输入城市与关键词获取公交线路的线型与站点 输入 citi str 城市 keyword str或list 关键词线路名称支持单个关键词或多个关键词 accur bool 是否精确匹配默认true 输出 data geodatafram 生成的公交线路 stop geodatafram 生成的公交站点 获取行政区划 function transbigdatagetadminkeywordakjscodesubdistrict fals 输入关键词与高德ak抓取行政区划gi 输入 keyword str 关键词可以是名称如深圳市或行政区划编号如 ak str 高德ak jscode str 安全密钥自年月日升级升级之后所申请的 key 必须配备安全密钥 jscode 一起使用 subdistrict bool 是否输出子行政区划的信息 输出 admin geodatafram 行政区划信息 district datafram 子行政区划的信息利用这个可以进一步抓下一级的行政区划 获取等时圈 function transbigdataget_isochrone_amaplonlatreachtimeakjscodemod 获取高德地图等时圈支持公交地铁公交地铁三种模式 输入 lon float 起点经度wg lat float 起点纬度wg reachtim number 等时圈时间 ak str 高德地图ak jscode str 安全密钥自年月日升级升级之后所申请的 key 必须配备安全密钥 jscode 一起使用 mode int str 出行方式公交地铁公交地铁 输出 isochron geodatafram 等时圈的geodataframewg function transbigdataget_isochrone_mapboxlonlatreachtimeaccess_tokenautomod drive 获取mapbox地图等时圈支持驾车步行骑行 输入 lon float 起点经度wg lat float 起点纬度wg reachtim number 等时圈时间 access_token str mapbox的access token如果设置为 auto则会自动读取已经保存的access token mode bool 出行方式取值为 drive walk 或 cycl 输出 isochron geodatafram 等时圈的geodataframewg _taxigp 出租车gps数据处理 function transbigdatataxigps_to_oddatacol vehiclenumstimelnglatopenstatu 出租车od提取算法输入出租车gps数据提取od 输入 data datafram 出租车gps数据清洗好的 col list 数据中各列列名需要按顺序车辆id时间经度纬度载客状态 function transbigdatataxigps_traj_pointdataoddatacolvehicleid time lng lat openstatu 输入出租车数据与od数据提取载客与空载的行驶路径点 输入 data datafram 出租车gps数据字段名由col变量指定 oddata datafram 出租车od数据 col list 列名按车辆id时间经度纬度载客状态的顺序 输出 data_deliv datafram 载客轨迹点 data_idl datafram 空载轨迹点 _coordinatesconvert 坐标距离 火星坐标系互转 坐标互转方法 transbigdata包提供了gcjbdbdmcwgs坐标系互转 function transbigdatagcjtobdlng lat function transbigdatabdtogcjbd_lon bd_lat function transbigdatawgstogcjlng lat function transbigdatagcjtowgslng lat function transbigdatawgstobdlonlat function transbigdatabdtowgslonlat function transbigdatabdmctobdlonlat 坐标互转基于numpy列运算 datalngdatalat tbdwgstobddatalngdatalat datalngdatalat tbdwgstogcjdatalngdatalat datalngdatalat tbdgcjtobddatalngdatalat datalngdatalat tbdgcjtowgsdatalngdatalat datalngdatalat tbdbdtogcjdatalngdatalat datalngdatalat tbdbdtowgsdatalngdatalat datalngdatalat tbdbdmctobddatalngdatalat 对地理要素转换坐标 function transbigdatatransform_shapegdfmethod 输入地理要素的geodataframe对整体做坐标转换 输入 gdf geodatafram 地理要素 method function 坐标转换函数 输出 gdf geodatafram 转换后结果 读取线要素 import geopanda gpd centerlin gpdread_filertest_linesjson centerlineplot imag transform_shapeoutput__png 整体进行坐标转换 import transbigdata tbd centerline_transform tbdtransform_shapecenterlinetbdbdtowg centerline_transformedplot imag transform_shapeoutput__png 经纬度计算距离 function transbigdatagetdistancelon lat lon lat 按经度纬度经度纬度 十进制度数顺序输入起终点经纬度为dataframe的列获取距离米基于numpy列运算 datadist tbdgetdistancedatalngdatalat datalngdatalat _busgp 公交车gps数据处理 function transbigdatabusgps_arriveinfodatalinestopcol vehicleidgpsdatetimelonlatstopnamestopbuff mintim project_epsg timegap method projectprojectoutput fals 输入公交gps数据公交线路与站点的geodataframe该方法能够识别公交的到离站信息 输入 data datafram 公交gps数据单一公交线路且需要含有车辆idgps时间经纬度wg line geodatafram 公交线型的geodataframe数据单一公交线路 stop geodatafram 公交站点的geodataframe数据 col list 列名按车辆id时间经度纬度站点名称字段的顺序 stopbuff number 米站点的一定距离范围车辆进入这一范围视为到站离开则视为离站 mintim number 秒短时间内公交再次到站则需要与前一次的到站数据结合一起计算到离站时间该参数设置阈值 project_epsg number 匹配时会将数据转换为投影坐标系以计算距离这里需要给定投影坐标系的epsg代号 timegap number 秒清洗数据用多长时间车辆不出现就视为新的车辆 method str 公交运行图匹配方法可选project或dislimit project为直接匹配线路上最近点匹配速度快 dislimit则需要考虑前面点位置加上距离限制匹配速度慢 projectoutput bool 是否输出投影后的数据 输出 arrive_info datafram 公交到离站信息 function transbigdatabusgps_onewaytimearrive_infostartendcol vehicleidstopnamearrivetimeleavetim 输入到离站信息表arrive_info与站点信息表stop计算单程耗时 输入 arrive_info datafram 公交到离站数据 stop geodatafram 公交站点的geodataframe数据 start str 起点站名字 end str 终点站名字 col list 字段列名车辆id站点名称到站时间离站时间 输出 onewaytim datafram 公交单程耗时 _plot_map 底图加载 使用前的设置 transbigdata包提供了在matplotlib上绘制地图底图的功能底图由mapbox提供坐标系为wgs如果你要使用该功能首先需要点击 这个链接 httpsaccountmapboxcomauthsigninroutetohttpsaccountmapboxcom__ 注册一个mapbox的账号mapbox上注册成为开发者并获取到一个mapbox token 这个链接 httpsdocsmapboxcomhelpgettingstartedaccesstokenshowaccesstokenswork__ 介绍了mapbox token的作用 如果你已经得到了mapbox token可以用以下代码为transbigdata设置mapbox token只需要设置一次后面重新打开python也不需要再重新设置了 import transbigdata tbd 用下面代码设置你的mapboxtoken tbdset_mapboxtokenpkeyxxxxxxxxxxxxxxxxxxx必须在里面设置你申请的token直接复制此行代码无效 另外还需要设置一个地图底图的存储位置下一次显示同一个位置时地图会从本地读取加载 设置你的地图底图存储路径 如果你是linux或者mac系统路径是这么写注意最后有一个反斜杠 tbdset_imgsavepathrusersxxxxxxxx 如果是windows系统路径这么写最后注意要两个斜杠以防转义 tbdset_imgsavepathrepythonscriptxxx 设置好后下次绘制底图时会在你设置的路径下创建一个tileimg文件夹底图都放在里面 尝试一下下面的代码看看能否成功绘制底图 定义显示范围范围 bound 创建图框 import matplotlibpyplot plt fig pltfiguredpi ax pltsubplot pltscaax 添加地图底图 tbdplot_mappltboundszoom style 添加比例尺和指北针 tbdplotscaleaxbound boundstexts compasss accuraci rect zorder pltaxisoff pltxlimboundsbound pltylimboundsbound pltshow imag plot_mapoutput__png 地图底图加载 transbigdata包的底图绘制功能由plot_map包提供首先确保你的plot_map包在版本以上 pip instal u plotmap function transbigdataplot_mappltboundszoomautostyleprintlog falsestyleid dark 添加地图底图 输入 bound list 底图的绘图边界lonlatlonlat wgs坐标系 其中lonlat是左下角坐标lonlat是右上角坐标 zoom number 底图的放大等级默认为auto自动选取越大越精细加载的时间也就越久一般单个城市大小的范围这个参数选取到之间 printlog bool 是否显示日志 style number 地图底图的样式可选对应分别如下需要plot_map包在版本以上 底图样式street imag plot_mappng 底图样式outdoor imag plot_mappng 底图样式satellit imag plot_mappng 底图样式light imag plot_mappng 底图样式dark imag plot_mappng 底图样式lightch中文 imag plot_mappng 底图样式ice creem imag plot_mappng 底图样式night imag plot_mappng 底图样式terrain imag plot_mappng 底图样式basic blue imag plot_mappng 用法 设定显示范围 bound lonlatlonlat tbdplot_mappltboundszoom style 指北针和比例尺 function transbigdataplotscaleaxboundstextcolor ktextsiz compasss accuraci autorectunit kmstyle kwarg 为底图添加指北针和比例尺 输入 bound list 底图的绘图边界lonlatlonlat wgs坐标系 其中lonlat是左下角坐标lonlat是右上角坐标 textsiz number 标注文字大小 compasss number 标注的指北针大小 accuraci number 标注比例尺的长度米 unit str kmkmmm 比例尺的单位 style number 或比例尺样式 rect list 比例尺在图中的大致位置如则在右上角 tbdplotscaleaxbound boundstexts compasss accuraci rect 共享单车数据社区发现 这个案例的jupyt notebook 点击这里 httpsgithubcomniotransbigdatablobmainexampleexamplecommunitydetectionforbikesharingdataipynb__ 对于共享单车的出行每一次出行都可以被看作是一个从起点行动到终点的出行过程当我们把起点和终点视为节点把它们之间的出行视为边时就可以构建一个网络通过分析这个网络我们可以得到关于城市的空间结构共享单车需求的宏观出行特征等信息 社区发现也可以叫图分割帮助我们揭示网络中节点之间的隐藏关系在这个例子中我们将介绍如何将transbigdata整合到共享单车数据的社区发现分析过程中 import panda pd import numpi np import geopanda gpd import transbigdata tbd 数据预处理 在社区发现之前我们首先需要对数据进行预处理从共享单车订单中提取出行od并剔除异常出行并以清洗好的数据作为研究对象 读取共享单车数据 bikedata pdread_csvrdatabikedatasamplecsv bikedatahead raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thbike_idth thdata_timeth thlock_statusth thlongitudeth thlatitudeth tr thead tbodi tr thth tdtd td td tdtd tdtd tdtd tr tr thth tdtd td td tdtd tdtd tdtd tr tr thth tdtd td td tdtd tdtd tdtd tr tr thth tdtd td td tdtd tdtd tdtd tr tr thth tdtd td td tdtd tdtd tdtd tr tbodi tabl div 读取研究区域的边界并用tbdclean_outofshape方法剔除研究区域以外的数据 读取上海行政区划边界 shanghai_admin gpdread_filerdatashanghaijson 剔除研究范围外的数据 bikedata tbdclean_outofshapebikedata shanghai_admin collongitud latitud accuraci 用tbdbikedata_to_od方法从单车数据中识别出行od信息 识别单车出行od move_datastop_data tbdbikedata_to_odbikedata col bike_iddata_timelongitudelatitudelock_statu move_datahead raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thbike_idth thstimeth thslonth thslatth thetimeth thelonth thelatth tr thead tbodi tr thth tdtd td td tdtd tdtd td td tdtd tdtd tr tr thth tdtd td td tdtd tdtd td td tdtd tdtd tr tr thth tdtd td td tdtd tdtd td td tdtd tdtd tr tr thth tdtd td td tdtd tdtd td td tdtd tdtd tr tr thth tdtd td td tdtd tdtd td td tdtd tdtd tr tbodi tabl div 我们需要剔除过长与过短的共享单车出行用tbdgetdistance获取起终点之间的直线距离并筛选删除直线距离小于米与大于千米的出行 计算骑行直线距离 move_datadist tbdgetdistancemove_dataslonmove_dataslatmove_dataelonmove_dataelat 清洗骑行数据删除过长与过短的出行 move_data move_datamove_datadistancemove_datadist 接下来我们以米米的栅格为最小分析单元用tbdgrid_params方法获取栅格划分参数再将参数输入tbdodagg_grid方法对od进行栅格集计 获取栅格划分参数 bound param tbdgrid_paramsboundsaccuraci 集计od od_gdf tbdodagg_gridmove_data param colslon slat elon elat od_gdfhead raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thsloncolth thslatcolth theloncolth thelatcolth thcountth thshblonth thshblatth thehblonth thehblatth thgeometryth tr thead tbodi tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdlinestr td tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdlinestr td tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdlinestr td tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdlinestr td tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdlinestr td tr tbodi tabl div 对od集计的结果在地图上可视化用tbdplot_map加载地图底图并用tbdplotscale添加比例尺与指北针 创建图框 import matplotlibpyplot plt import plot_map fig pltfiguredpi ax pltsubplot pltscaax 添加地图底图 tbdplot_mappltboundszoom style 绘制colorbar cax pltax plttitledata count pltscaax 绘制od od_gdfplotax axcolumn countcmap blues_rlinewidth vmax cax caxlegend true 添加比例尺和指北针 tbdplotscaleaxbound boundstexts compasss textcolor whiteaccuraci rect zorder pltaxisoff pltxlimboundsbound pltylimboundsbound pltshow imag output__png 提取节点信息 使用igraph包构建网络在python中igraph与networkx功能类似都提供了网络分析的功能仅在部分算法的支持上有所区别 构建网络时我们需要向igraph提供网络的节点与边的信息以od数据中出现过的每个栅格作为节点构建节点的信息时需要为节点创建从开始的数字编号代码如下 把起终点的经纬度栅格编号变为一个字段 od_gdf od_gdfsloncolastypestr od_gdfslatcolastypestr od_gdf od_gdfeloncolastypestr od_gdfelatcolastypestr 提取节点集合 node setod_gdfssetod_gdf 把节点集合变成datafram node pddataframenod 重新编号节点 nodeid rangelennod node raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thth thidth tr thead tbodi tr thth tdtd tdtd tr tr thth tdtd tdtd tr tr thth tdtd tdtd tr tr thth tdtd tdtd tr tr thth tdtd tdtd tr tr thth tdtd tdtd tr tr thth tdtd tdtd tr tr thth tdtd tdtd tr tr thth tdtd tdtd tr tr thth tdtd tdtd tr tr thth tdtd tdtd tr tbodi tabl p row columnsp div 提取边信息 将新的编号连接到od信息表上以提取新id之间的出行量构成边 把新编号连接到od数据上 nodecolumn ss_id od_gdf pdmergeod_gdfnodeon nodecolumn ee_id od_gdf pdmergeod_gdfnodeon e 提取边信息 edg od_gdfs_ide_idcount edg raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth ths_idth the_idth thcountth tr thead tbodi tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tbodi tabl p row columnsp div 构建网络 导入igraph包创建网络添加节点并将边数据输入网络同时为每一条边添加相应的权重 import igraph 创建网络 g igraphgraph 在网络中添加节点 gadd_verticeslennod 在网络中添加边 gadd_edgesedges_ide_idvalu 提取边的权重 edge_weight edgecountvalu 给边添加权重 rangelenedge_weight gesiweight edge_weightsi 社区发现 在构建好的网络上应用社区发现算法其中我们使用igraph包自带的gcommunity_multilevel方法实现fast unfolding社区发现算法前面我们介绍过fast unfolding算法将社区逐层迭代合并直至模块度最优而在gcommunity_multilevel方法中可以设定return_levels返回迭代的中间结果这里我们设定return_levels为false只返回最终结果进行分析 社区发现 g_cluster gcommunity_multilevelweight edge_weight return_levelsfals 社区发现的结果存储在g_clustered变量中可以用内置方法直接计算模块度 模块度 g_clusteredmodular parsedliter 一般来说模块度在以上已经属于较高值而这一结果的模块度达到表明网络的社区结构非常明显社区划分结果也能够很好地划分网络接下来我们将社区划分结果赋值到节点信息表上为后面的可视化做准备代码如下 将结果赋值到节点上 nodegroup g_clusteredmembership 重命名列 nodecolumn gridnode_idgroup node raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thgridth thnode_idth thgroupth tr thead tbodi tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tr tbodi tabl p row columnsp div 社区可视化 在社区发现的结果中可能会存在部分社区中只存在少量的节点无法形成规模较大的社区这些社区为离群点在可视化之前应该删去这里我们保留包含个栅格以上的社区 统计每个社区的栅格数量 group nodegroupvalue_count 提取大于个栅格的社区 group groupgroup 只保留这些社区的栅格 node nodenodegroupapplylambda rr groupindex 将栅格编号复原再用tbdgridid_to_polygon方法从栅格编号生成栅格的地理几何图形 切分获取栅格编号 nodeloncol nodegridapplylambda rrsplitastypeint nodelatcol nodegridapplylambda rrsplitastypeint 生成栅格地理图形 nodegeometri tbdgridid_to_polygonnodeloncolnodelatcolparam 转为geodatafram import geopanda gpd node gpdgeodataframenod node raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thgridth thnode_idth thgroupth thloncolth thlatcolth thgeometryth tr thead tbodi tr thth tdtd tdtd tdtd tdtd tdtd tdpolygon td tr tr thth tdtd tdtd tdtd tdtd tdtd tdpolygon td tr tr thth tdtd tdtd tdtd tdtd tdtd tdpolygon td tr tr thth tdtd tdtd tdtd tdtd tdtd tdpolygon td tr tr thth tdtd tdtd tdtd tdtd tdtd tdpolygon td tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdpolygon td tr tr thth tdtd tdtd tdtd tdtd tdtd tdpolygon td tr tr thth tdtd tdtd tdtd tdtd tdtd tdpolygon td tr tr thth tdtd tdtd tdtd tdtd tdtd tdpolygon td tr tr thth tdtd tdtd tdtd tdtd tdtd tdpolygon td tr tbodi tabl p row columnsp div 在这一步中我们将每一个节点复原为栅格标记上节点所属的社区编号生成了每个栅格的地理信息并将其转换为geodataframe可以用如下代码绘制栅格测试是否生成成功 nodeplotgroup imag output__png 这里我们将group字段的分组编号映射到颜色上进行初步可视化不同分组的颜色不同从结果的图中可以看到相同颜色的栅格在地理空间上大多聚集在一起表明共享单车的空间联系可以将地理空间上接近的区域紧密地联系在一起 前面的结果可视化的效果并不明显我们并不能从图中清晰地看出分区的情况接下来我们可以对分区结果进行一定的调整与可视化可视化的调整主要有以下思路 比较合适的分区结果应该是每个区域都为空间上连续的区域在初步的可视化结果中有不少的栅格在空间上为孤立存在这些点应该予以剔除 在可视化结果中我们可以将同一个组别的栅格合并为每个分区形成面要素这样在下一步可视化中就可以绘制出分区的边界 在分区结果中有些区域的内部可能会存在其他区域的飞地即隶属于本分区却被其他分区所包围只能飞过其他分区的属地才能到达自己的飞地这种分区在共享单车的实际运营中也是难以管理的应该避免这种情况的出现 解决上述问题我们可以使用transbigdata所提供的两个gis处理方法tbdmerge_polygon和tbdpolyon_exterior其中tbdmerge_polygon能够将同一个组别的面要素进行合并而tbdpolyon_exterior则可以对多边形取外边界后再构成新的多边形以此剔除飞地同时也可以设定最小面积对小于此面积的面要素进行剔除代码如下 以group字段为分组将同一组别的面要素合并 node_commun tbdmerge_polygonnodegroup 输入多边形geodataframe数据对多边形取外边界构成新多边形 设定最小面积minarea小于该面积的面全部剔除避免大量离群点出现 node_commun tbdpolyon_exteriornode_communityminarea 处理好社区的面要素后接下来需要对面要素进行可视化我们希望对不同的面赋予不同的颜色在可视化章节中我们提到在显示的要素没有数值上的大小区别时颜色的选择上需要保持它们各自的颜色具有相同的亮度与饱和度而用seaborn的调色盘方法即可快速地生成同一亮度与饱和度下的多种颜色 生成调色盘 import seaborn sn l 亮度 饱和度 cmap snshls_paletten_colorslennode_commun l snspalplotcmap imag output__png 对社区结果进行可视化 创建图框 import matplotlibpyplot plt import plot_map fig pltfiguredpi ax pltsubplot pltscaax 添加地图底图 tbdplot_mappltboundszoom style 设定colormap matplotlibcolor import listedcolormap 打乱社区的排列顺序 node_commun node_communitysamplefrac 绘制社区 node_communityplotcmap listedcolormapcmapax axedgecolor alpha 添加比例尺和指北针 tbdplotscaleaxbound boundstexts compasss textcolor k accuraci rect zorder pltaxisoff pltxlimboundsbound pltylimboundsbound pltshow imag output__png 至此我们就已经成功地可视化出共享单车社区并绘制出每一个社区的边界在用社区发现模型进行分区时并没有往模型中输入任何地理空间信息模型对研究区域的分割也仅仅依靠共享单车出行需求所构成的网络联系 公交gps的到离站信息匹配 这个案例的jupyt notebook 点击这里 httpsgithubcomniotransbigdatablobmainexampleexampleidentifyingarrivalanddepartureinformationfrombusgpsdataipynb__ 可以点击 这个链接 httpsmybinderorgvghniotransbigdatadecabefdaabaaaurlpathlabftreefexamplefexampleidentifyingarrivalanddepartureinformationfrombusgpsdataipynb__ 在线编辑器中尝试 下面的案例展示如何用transbigdata包处理公交gps数据以内置方法计算公交车辆的到离站信息统计公交单程耗时与运营车速 import transbigdata tbd import panda pd import geopanda gpd 读取数据 读取gps数据 bus_gp pdread_csvrbusgpscsvhead none bus_gpscolumn gpsdatetim lineid linenam nextlevel prevlevel strlatlon todir vehicleid vehicleno unknow 时间转换为datetime格式 bus_gpsgpsdatetim pdto_datetimebus_gpsgpsdatetim 经纬度坐标转换 切分经纬度的字符串 bus_gpslon bus_gpsstrlatlonapplylambda rrsplit bus_gpslat bus_gpsstrlatlonapplylambda rrsplit 坐标系转换 bus_gpslonbus_gpslat tbdgcjtowgsbus_gpslonastypefloatbus_gpslatastypefloat bus_gpshead raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thgpsdatetimeth thlineidth thlinenameth thnextlevelth thprevlevelth thstrlatlonth thtodirth thvehicleidth thvehiclenoth thunknowth thlonth thlatth tr thead tbodi tr thth td td tdtd tdtd tdtd tdtd tdtd tdtd td沪drtd tdzatd tdtd tdtd tdtd tr tr thth td td tdtd tdtd tdtd tdtd tdtd tdtd td沪drtd tdzatd tdtd tdtd tdtd tr tr thth td td tdtd tdtd tdtd tdtd tdtd tdtd td沪drtd tdzatd tdtd tdtd tdtd tr tr thth td td tdtd tdtd tdtd tdtd tdtd tdtd td沪drtd tdzatd tdtd tdtd tdtd tr tr thth td td tdtd tdtd tdtd tdtd tdtd tdtd td沪dttd tdzatd tdtd tdtd tdtd tr tbodi tabl div 读取公交线数据 shp rbuslinejson linegdf gpdgeodataframefrom_fileshpencod gbk line linegdfiloccopi lineplot imag output__png 读取公交站点数据 shp rbusstopjson stop gpdgeodataframefrom_fileshpencod gbk stop stopstoplinenam 路延安东路外滩申昆路枢纽站 stopplot imag output__png 到离站信息匹配 arriveinfo tbdbusgps_arriveinfobus_gpslinestop 数据清洗中 运行位置匹配中 匹配到离站信息 arriveinfo raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth tharrivetimeth thleavetimeth thstopnameth thvehicleidth tr thead tbodi tr thth td td td td td延安东路外滩td tdtd tr tr thth td td td td td延安东路外滩td tdtd tr tr thth td td td td td西藏中路td tdtd tr tr thth td td td td td西藏中路td tdtd tr tr thth td td td td td西藏中路td tdtd tr tr thth tdtd tdtd tdtd tdtd tr tr thth td td td td td吴宝路td tdtd tr tr thth td td td td td吴宝路td tdtd tr tr thth td td td td td申昆路枢纽站td tdtd tr tr thth td td td td td申昆路枢纽站td tdtd tr tr thth td td td td td申昆路枢纽站td tdtd tr tbodi tabl p row columnsp div 单程耗时 onewaytim tbdbusgps_onewaytimearriveinfo start 延安东路外滩 end 申昆路枢纽站col vehicleidstopnam 绘制耗时分布箱型图 import numpi np import matplotlibpyplot plt import seaborn sn pltrcparamsfontsansserifsimhei pltrcparamsfontserif simhei pltrcparamsaxesunicode_minusfals fig pltfiguredpi ax pltsubplot snsboxplotx shouri onewaytimedurationhu 方向data onewaytim pltylabel始发站至终点站耗时分钟 pltxlabel小时 pltylim pltshow imag output__png 运营车速 转换坐标系为投影坐标系方便后面计算距离 linecr initepsg line_ lineto_crsepsg 公交线路数据里面的geometri lineshp line_geometryiloc linenam line_nameiloc lineshp parsedliter optanacondalibpythonsitepackagespyprojcrscrspi futurewarn initauthoritycod syntax deprec authoritycod prefer initi method make chang mind axi order chang httpspyprojgithubiopyprojstablegotchashtmlaxisorderchangesinproj return _prepare_from_str joinpjarg imag output__png 筛选去掉车速过快的 车速单位转换为kmh onewaytimespe lineshplengthonewaytimedur onewaytim onewaytimeonewaytimespe 车速分布 import numpi np import matplotlibpyplot plt import seaborn sn pltrcparamsfontsansserifsimhei pltrcparamsfontserif simhei pltrcparamsaxesunicode_minusfals fig pltfiguredpi ax pltsubplot snsboxplotx shouri speedhu 方向data onewaytim pltylabel运营速度kmh pltxlabel小时 pltylim pltshow imag output__png 出租车数据处理 这个案例的jupyt notebook 点击这里 httpsgithubcomniotransbigdatablobmainexampleexampletaxigpsdataprocessingipynb__ 可以点击 这个链接 httpsmybinderorgvghniotransbigdataddfaffbabddcffffabdurlpathlabftreefexamplefexampletaxigpsdataprocessingipynb__ 在线编辑器中尝试 使用示例中的样例数据集在github仓库中链接为httpsgithubcomniotransbigdatatreemainexampl 下面我们介绍如何使用transbigdata包调用其中的函数实现对出租车gps数据的快速处理 首先我们引入transbigdata包并读取数据 import transbigdata tbd import panda pd import geopanda gpd 读取数据 data pdread_csvtaxidatasamplecsvhead none datacolumn vehiclenumtimelnglatopenstatusspe data raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thvehiclenumth thtimeth thlngth thlatth thopenstatusth thspeedth tr thead tbodi tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tr tbodi tabl p row columnsp div 读取区域信息 import geopanda gpd sz gpdread_filerszszshp szcr none szplot imag output__png 数据预处理 transbigdata包也集成了数据预处理的常用方法其中tbdclean_outofshape方法输入数据和研究范围区域信息筛选剔除研究范围外的数据而tbdclean_taxi_status方法则可以剔除的载客状态瞬间变化的记录在使用预处理的方法时需要传入相应的列代码如下 数据预处理 剔除研究范围外的数据 data tbdclean_outofshapedata sz collng lat accuraci 剔除出租车数据中载客状态瞬间变化的记录 data tbdclean_taxi_statusdata colvehiclenum time openstatu 数据栅格化 以栅格形式表达数据分布是最基本的表达方法gps数据经过栅格化后每个数据点都含有对应的栅格信息采用栅格表达数据的分布时其表示的分布情况与真实情况接近如果要使用transbigdata工具进行栅格划分首先需要确定栅格化的参数可以理解为定义了一个栅格坐标系参数可以帮助我们快速进行栅格化 栅格化 定义范围获取栅格化参数 bound param tbdgrid_paramsboundsaccuraci param 取得栅格化参数后将gps对应至栅格由loncol与latcol两列共同指定一个栅格 将gps栅格化 dataloncoldatalatcol tbdgps_to_gridsdatalngdatalatparam 统计每个栅格的数据量 集计栅格数据量 datatest datagroupbyloncollatcolvehiclenumcountreset_index 生成栅格的地理图形并将它转化为geodatafram 生成栅格地理图形 datatestgeometri tbdgridid_to_polygondatatestloncoldatatestlatcolparam 转为geodatafram import geopanda gpd datatest gpdgeodataframedatatest 绘制栅格测试是否成功 绘制 datatestplotcolumn vehiclenum imag output__png 出行od提取与集计 使用tbdtaxigps_to_od方法传入对应的列名即可提取出行od 从gps数据提取od oddata tbdtaxigps_to_oddatacol vehiclenumtimelnglatopenstatu oddata raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thvehiclenumth thstimeth thslonth thslatth thetimeth thelonth thelatth thidth tr thead tbodi tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tbodi tabl p row columnsp div 对提取出的od进行od的栅格集计并生成geodatafram 栅格化od并集计 od_gdf tbdodagg_gridoddataparam od_gdfplotcolumn count imag output__png 出行od小区集计 transbigdata包也提供了将od直接集计到小区的方法 od集计到小区在不传入栅格化参数时直接用经纬度匹配 od_gdf tbdodagg_shapeoddataszround_accuraci od_gdfplotcolumn count imag output__png od集计到小区传入栅格化参数时先栅格化后匹配可加快匹配速度数据量大时建议使用 od_gdf tbdodagg_shapeoddataszparam param od_gdfplotcolumn count imag output__png 基于matplotlib的地图绘制 tbd中提供了地图底图加载和比例尺指北针的功能使用这个方法之前首先需要设置mapboxtoken和底图存放位置详情看 这个链接 httpstransbigdatareadthedocsiozh_cnlatestplot_maphtml__ plot_map方法添加地图底图plotscale添加比例尺和指北针 创建图框 import matplotlibpyplot plt import plot_map fig pltfiguredpi ax pltsubplot pltscaax 添加地图底图 tbdplot_mappltboundszoom style 绘制colorbar cax pltax plttitlecount pltscaax 绘制od od_gdfplotax axvmax column countcax caxlegend true 绘制小区底图 szplotax axedgecolor facecolor linewidth 添加比例尺和指北针 tbdplotscaleaxbound boundstexts compasss accuraci rect zorder pltaxisoff pltxlimboundsbound pltylimboundsbound pltshow imag output__png 出租车轨迹的提取 使用tbdtaxigps_traj_point方法输入数据和od数据可以提取出轨迹点 data_deliverdata_idl tbdtaxigps_traj_pointdataoddatacolvehiclenum time lng lat openstatu data_deliv raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thvehiclenumth thtimeth thlngth thlatth thopenstatusth thspeedth thloncolth thlatcolth thidth thflagth tr thead tbodi tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tbodi tabl p row columnsp div data_idl raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thvehiclenumth thtimeth thlngth thlatth thopenstatusth thspeedth thloncolth thlatcolth thidth thflagth tr thead tbodi tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tr thth tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tdtd tr tbodi tabl p row columnsp div 对轨迹点生成载客与空载的轨迹 traj_deliv tbdpoints_to_trajdata_deliv traj_deliverplot imag output__png traj_idl tbdpoints_to_trajdata_idl traj_idleplot imag output__png 轨迹可视化 transbigdata包也依托于keplergl提供的可视化插件提供了一键数据整理与可视化的方法 使用此功能请先安装python的keplergl包 pip instal keplergl 将轨迹数据进行可视化 tbdvisualization_tripdata_deliv imag keplertrajpng pneuma轨迹数据处理 这个案例的jupyt notebook 点击这里 httpsgithubcomniotransbigdatablobmainexampleexamplepneumatrajectorydatasetprocessingipynb__ 在这个例子中我们将示例如何将transbigdata融入到雅典pneuma轨迹数据集的处理与可视化中 请注意样本数据已经被经过了一定的处理原始版本的数据集可以在这里下载 websit httpsopentrafficepflch__ import transbigdata tbd import panda pd import geopanda gpd import matplotlibpyplot plt 读取数据 轨迹数据 读取数据 data pdread_csvdatapneuma_tbd_samplecsv 将时间戳转换为时间格式 datatim pdto_datetimedatatim unit datahead raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thtrack_idth thlonth thlatth thspeedth thtimeth tr thead tbodi tr thth tdtd tdtd tdtd tdtd td td tr tr thth tdtd tdtd tdtd tdtd td td tr tr thth tdtd tdtd tdtd tdtd td td tr tr thth tdtd tdtd tdtd tdtd td td tr tr thth tdtd tdtd tdtd tdtd td td tr tbodi tabl div 输出数据大小信息 datainfo parsedliter class pandascoreframedatafram rangeindex entri data column total column column nonnul count dtype track_id nonnul int lon nonnul float lat nonnul float speed nonnul float time nonnul datetimen dtype datetimen float int memori usag mb osm路网数据获取 你可以直接从data文件夹加载道路数据或者使用osmnx下载路网 osmnx httpsosmnxreadthedocsioenstable__ 从osmnx中获取路网数据 osm graph import osmnx ox bound north south east west bound bound bound bound g oxgraph_from_bboxnorth south east west network_typedr 获取点和边 node edg oxgraph_to_gdfsg nodestru edgestru 存储路网数据 filepath datapneuma_networkgraphml oxsave_graphmlg filepath 如果你没有osmnx可以运行下面代码读取已经现成的数据 读取osm数据 import osmnx ox filepath datapneuma_networkgraphml g oxload_graphmlfilepath 获取点和边 node edg oxgraph_to_gdfsg nodestru edgestru 地图底图加载 将地图底图加载并可视化 可视化地图底图 tbdplot_map bound fig pltfigur dpi ax pltsubplot pltscaax tbdplot_mapplt bound zoom style map edgesplotaxax lw colorgrey edg nodesplotaxax markers color node pltaxisoff ax pltsubplot pltscaax tbdplot_mapplt bound zoom style map edgesplotaxax lw colorgrey edg nodesplotaxax markers color node pltaxisoff imag output__png 数据清洗 数据稀疏化 数据集的采样间隔为 math 秒 非常小不便于处理 然而一些宏观层面的研究不需要如此高的采样间隔在这种情况下数据可以使用tbdtraj_sparsify进行稀疏化 原始数据 datainfo parsedliter class pandascoreframedatafram rangeindex entri data column total column column nonnul count dtype track_id nonnul int lon nonnul float lat nonnul float speed nonnul float time nonnul datetimen dtype datetimen float int memori usag mb 轨迹稀疏化 data_sparsifi tbdtraj_sparsifydata coltrack_id time lon lattimegapmethodsubsampl data_sparsifyinfo parsedliter class pandascoreframedatafram intindex entri data column total column column nonnul count dtype track_id nonnul int lon nonnul float lat nonnul float speed nonnul float time nonnul datetimen dtype datetimen float int memori usag mb 冗余数据剔除 在车辆停止运行时位置没有发生移动但仍然会产生大量gps点这些静止的gps点除第一和最后一个点外的都可以删除 用 tbdclean_sam 删除冗余数据 data_sparsify_clean tbdclean_samedata_sparsifi coltrack_id time lon lat data_sparsify_cleaninfo parsedliter class pandascoreframedatafram intindex entri data column total column column nonnul count dtype track_id nonnul int lon nonnul float lat nonnul float speed nonnul float time nonnul datetimen dtype datetimen float int memori usag kb data_sparsify_cleanhead raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thtrack_idth thlonth thlatth thspeedth thtimeth tr thead tbodi tr thth tdtd tdtd tdtd tdtd td td tr tr thth tdtd tdtd tdtd tdtd td td tr tr thth tdtd tdtd tdtd tdtd td td tr tr thth tdtd tdtd tdtd tdtd td td tr tr thth tdtd tdtd tdtd tdtd td td tr tbodi tabl div 数据可视化 gdf_data gpdgeodataframedata_sparsify_clean geometrygpdpoints_from_xydata_sparsify_cleanlon data_sparsify_cleanlat cr gdf_datahead raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thtrack_idth thlonth thlatth thspeedth thtimeth thgeometryth tr thead tbodi tr thth tdtd tdtd tdtd tdtd td td tdpoint td tr tr thth tdtd tdtd tdtd tdtd td td tdpoint td tr tr thth tdtd tdtd tdtd tdtd td td tdpoint td tr tr thth tdtd tdtd tdtd tdtd td td tdpoint td tr tr thth tdtd tdtd tdtd tdtd td td tdpoint td tr tbodi tabl div 获取有最多数据点的车辆 gdf_count gdf_datagroupbytrack_idloncountrenamecountsort_valuesascendingfalsereset_index printlistgdf_countiloctrack_id parsedliter 可视化车辆 fig pltfigur dpi ax pltsubplot pltscaax map tbdplot_mapplt bound zoom style map edgesplotaxax lw colorgrey edg nodesplotaxax markers color node trajectori gdf_dataplotcolumnspe axax markers pltaxisoff imag output__png 可视化单辆车并显示最短路径 select vehicl tmpgdf_data gdf_datagdf_datatrack_id origin destin locat o_point tmpgdf_datailoclon tmpgdf_datailoclat d_point tmpgdf_datailoclon tmpgdf_datailoclat get nearest node point map tmpgdf_data tbdckdnearest_pointtmpgdf_data node extract od node o_index d_index tmpgdf_datailocindex tmpgdf_datailocindex o_node_id d_node_id listnodesnodesindexo_indexindex listnodesnodesindexd_indexindex printo_node_id d_node_id tmpgdf_datahead parsedliter raw html div style scope datafram tbodi tr thonlyoftyp verticalalign middl datafram tbodi tr th verticalalign top datafram thead th textalign right style tabl border classdatafram thead tr styletextalign right thth thtrack_idth thlonth thlatth thspeedth thtimeth thgeometry_xth thdistth thindexth thyth thxth thstreet_countth thhighwayth thgeometry_yth tr thead tbodi tr thth tdtd tdtd tdtd tdtd td td tdpoint td tdtd tdtd tdtd tdtd tdtd tdnantd tdpoint td tr tr thth tdtd tdtd tdtd tdtd td td tdpoint td tdtd tdtd tdtd tdtd tdtd tdnantd tdpoint td tr tr thth tdtd tdtd tdtd tdtd td td tdpoint td tdtd tdtd tdtd tdtd tdtd tdnantd tdpoint td tr tr thth tdtd tdtd tdtd tdtd td td tdpoint td tdtd tdtd tdtd tdtd tdtd tdnantd tdpoint td tr tr thth tdtd tdtd tdtd tdtd td td tdpoint td tdtd tdtd tdtd tdtd tdtd tdnantd tdpoint td tr tbodi tabl div parsedliter fig pltfigur dpi ax pltsubplot pltscaax map tbdplot_mapplt bound zoom style map edgesplotaxax lw colorgrey edg nodesplotaxax markers color node trajectori gdf_datagdf_datatrack_idplotaxax markers color pltaxisoff imag output__png 我们可以将轨迹数据与最短路径做比对 shortest path option ax pltsubplot pltscaax rout oxshortest_pathg o_node_id d_node_id weightlength plt ax oxplot_graph_routeg rout route_colorgreen route_linewidth node_s imag output__png 地铁网络拓扑建模 这个案例的jupyt notebook 点击这里 httpsgithubcomniotransbigdatablobmainexampleexamplemodelingforsubwaynetworktopologyipynb__ 可以点击 这个链接 httpsmybinderorgvghniotransbigdatadecabefdaabaaaurlpathlabftreefexamplefexamplemodelingforsubwaynetworktopologyipynb__ 在线编辑器中尝试 下面的案例展示如何用transbigdata包抓取地铁线路并构建地铁线网的拓扑网络模型 爬取地铁线路 首先爬取地铁线路使用tbdgetbusdata方法输入城市跟公交或地铁线路名称的关键词即可获取到线路数据坐标系为wg import transbigdata tbd linestop tbdgetbusdata厦门号线号线号线 获取城市id 厦门成功 号线成功 号线成功 号线成功 lineplot imag output__png stopplot imag output__png 轨道断面信息获取 tbdsplit_subwayline方法可以用轨道站点切分轨道线路得到轨道断面信息这一步骤主要在地铁客流可视化中有用 metroline_split tbdsplit_subwaylinelinestop metroline_splitedplotcolumn o_project imag output__png 轨道网络拓扑模型构建 同时我们也可以直接使用站点数据构建地铁网络的拓扑结构模型方便后续地铁出行路径的识别这一功能依赖于networkx包 构建拓扑模型 import networkx nx g tbdmetro_networkstop nxdrawg imag output__png