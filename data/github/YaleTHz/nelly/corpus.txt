toc overview nelli packag numer extract complex refract indic materi timedomain terahertz thz spectroscopi td timeresolv thz spectroscopi trt data typic extract refract index accomplish make one sever assumpt materi eg assum absorpt contribut signal assumpt limit accuraci result restrict analysi certain type sampl nelli hand requir assumpt process data wide rang sampl geometri accur td trt dataset typic consist two measur thz puls pass sampl terahertz puls pass known refer pictur depict gener setup thz puls pass layer refer layer well character well sampl contain layer whose refract index wed like measurefig docsfigpng gener principl measur relat differ sampl refer puls unknown refract index specif fourier transform puls see amplitud phase spectral compon chang pass sampl compar refer express transfer function fractildee_stildee_romega ie complex ratio sampl refer chang amplitud phase relat function layer refract index thick ie fractildee_stildee_romega tfomega tilden_textsolv tilden_ d_ tilden_ n_textsolv unknown refract index transfer function tfomega tilden_textsolv function consist fresnel coeffici propag term written succinctli tfomega tilden_textsolv sinc n_i except n_solv known d_i complex ratio fractildee_stildee_romega measur experiment transfer function go frequencybyfrequ find refract index tilden_textsolv best reproduc experiment valuethat valu tilden_solv bring tfomega tilden_solv closest measur valu fractildee_stildee_romega mind packag perform follow task given geometri construct appropri transfer function loop rang frequenc run optim routin find refract index close match transfer function experiment valu quick start matlab quickest way get start edit sampl script input file sample_fil folder fit need edit script sample_filessample_script replac data file path eg test_datacell_ref_emptytim path data file built importdata method work characterdelimit data file import method work long end matlab vector time point correspond vector amplitud time edit input file input file specifi geometri sampl well paramet fourier transform sample_filessample_inputjson chang paramet geometri necessari match sampl refer file edit text editor paramet explain comment format geometri specif python python librari depend freeli avail matlab runtim instal follow instruct matlab websitehttpswwwmathworkscomproductscompilermatlabruntimehtml anoth option linux system navig nelly_mainfor_redistribut within main packag folder run instal commandmyappinstaller_webinstal matlab runtim instal python librari instal navig nelly_mainfor_redistribution_files_onli within main packag folder run python setuppi instal test instal tri run sampl script sampl folder python example_scriptpi exampl script also edit suit need caveat troubleshoot hint may manual add matlab runtim directori ld_library_path done run command export ld_library_pathld_library_pathmatlab runtim path matlab runtim path shown matlab runtim instal process exampl found add_to_pathsh instal process success test linux ubuntu ran issu file permiss get correct path instal window run nelli main interfac program nelly_main function nelly_main take input file timedomain data output extract refract index along variou diagnost variabl run follow freq n_fit freq_ful tf_full tf_spec tf_pred func spec_smp spec_ref nelly_maininput t_smp a_smp t_ref a_ref see detail explan input output argument briefli input path name input file t_smp a_smp time point amplitud sampl t_ref a_ref refer input file broadli input file two part set control variou data process paramet sampl specif give inform materi make sampl specifi order come ie geometri input file follow jsonhttpsenwikipediaorgwikijson format except comment allow begin sampl input file includ packag json file test_data folder file edit text editor set set part input file control amplitud cutoff frequenc rang space paramet fourier transform exampl part transfer function includ comment explain line json set a_cut e amplitud cutoff reflect see build_transfer_function_tre section specifi frequenc rang refract index calcul frequenc freq_lo freq_hi step size freq_step freq_lo freq_step freq_hi specifi fft set fft windowing_typ none specifi type window use suppress nois time domain trace option gauss squar none see td_windowm info sinc packag design handl reflect featur may remov window window discourag windowing_width width window squar window width gauss window std dev pad base log pad ie pad time domain data length prior perform fft geometri specif next portion input file give geometri sampl refer geometri consist array layer contain field name layer thick layer micromet complex refract index layer n name includ clarityit use program number option specifi refract index solv denot layer whose refract index solv number includ complex valu path file contain frequencybyfrequ refract index code accept file csv format first column denot frequenc thz second column give real part option third column give imaginari part format may work well provid follow gener format compat matlab importdata function refer specifi assum air thick sampl exampl show geometri specif experi measur refract index water quartz cell empti cell refer json sampl name air n name quartz n quartzcsv name water n solv name quartz n quartzcsv name air n refer name air n name quartz n quartzcsv name air n name quartz n quartzcsv name air n function class section describ function class packag function descript expect input given import primari function fuller descript function given well give sens overal architectur librari relationship function shown diagram arrow point function call function although user call nelly_main explan function may help diagnos bug use user want custom code particular purpos time picosecond ps frequenc thz img srcdocsfunction_mappng altfunction_map stylezoom primari function nelly_main take input file name two time trace return vector extract refract index conceptu code broken follow step load process experiment data load set geometri input file load_input process experiment data pad time_pad fourier transform fft_func use result calcul experiment transfer function exp_tf build transfer function take geometri load input file hand build_transfer_function_tre function fit loop frequenc specifi input file find refract index n predict transfer function best reproduc experiment transfer function frequenc ie minim error defin erroromega leftlogtfomegalogtf_expomegaright leftangl tfomega angl tf_expomega pi mod pi pi right optim done matlab fminsearch function argument input give input geometri set calcul either filenam json file see specif matlab struct variabl contain inform t_smp array contain time point sampl time domain trace ps a_smp array contain sampl puls amplitud point correspond t_smp t_ref array contain time point refer time domain trace ps a_ref array contain refer puls amplitud point correspond t_ref output freq array contain frequenc thz refract index calcul n_fit array complex valu refract index ith element correspond ith element freq imaginari part posit valu correspond loss freq_ful array contain finer mesh frequenc point directli pad fourier transform tf_full array contain transfer function frace_smpe_ref ith element correspond ith element freq_ful tf_spec array contain transfer function frace_smpe_ref coarser space ith element correspond ith element freq tf_pred array contain transfer function predict base extract refract index valu ie tftilden_extractedomega compar experiment transfer function assess accuraci extract refract index ith element correspond ithel freq func function take two argument frequenc thz valu unknown refract indexand return predict transfer function valu frequenc assum unknown refract index valu given spec_smp spectrum ie fourier coeffici sampl puls ie e_smpomega ithel correspond ith element freq spec_ref spectrum ie fourier coeffici refer puls ie e_refomega element correspond ith element freq build_transfer_function_tre take layer inform return transfer function use refract index extract briefli consid everi possibl path puls take sampl interfac puls either reflect transmit repres tree split interfac illustr diagram docsfigpng tree start interfac layer air layer pass layer puls reach interfac either reflect transmit tree split r branch process continu branch given node tree correspond particular path geometri exampl node black box correspond path shown error diagram tree ie pass though layer reflect back forth layer transmit layer final leav sampl path correspond particular time delay time requir travers path well chang amplitud loss due absorpt interfac keep track termin branch time delay would place outsid measur window amplitud less a_cut specifi input detail found main text paper function build_transfer_function_tre take struct variabl contain geometri geom well time amplitud cutoff t_cut a_cut return two function tf_func take frequenc valu unknown refract index return predict frace_smpe_refomega tree_func take frequenc valu unknown refract index return object repres tree puls path use debug eg visual tree auxiliari functionsclass estimate_n give estim real part unknown refract index base sampl refer geometri delay peak sampl puls peak refer puls argument delay time delay ps peak sampl puls peak refer puls input struct variabl contain frequenc rang sampl geometri creat call load_input input file creat struct variabl requir field manual output n_est estim real part unknown refract index exp_tf pad window fourier transform raw time trace argument t_smp array contain time point sampl time domain trace ps a_smp array contain sampl puls amplitud point correspond t_smp t_ref array contain time point sampl time domain trace ps a_ref array contain refer amplitud point correspond t_ref input struct variabl contain frequenc rang sampl geometri creat call load_input input file creat struct variabl requir field manual output freq array contain frequenc thz refract index calcul tf_spec array contain transfer function frace_smpe_ref coarser space ith element correspond ith element freq freq_ful array contain finer mesh frequenc point directli pad fourier transform tf_full array contain transfer function frace_smpe_ref ith element correspond ith element freq_ful spec_smp spectrum ie fourier coeffici sampl puls ie e_smpomega ithel correspond ith element freq spec_ref spectrum ie fourier coeffici refer puls ie e_refomega element correspond ith element freq fft_func fourier transform timedomain trace take time amplitud vector argument well struct object contain option fourier transform eg zero pad window return frequenc vector thz correspond complex fourier coeffici argument time time point tdstrt trace fourier transform ps amplitud amplitud time trace fourier transform correspond time point time option struct variabl follow field windowing_typ string specifi type window perform time domain data either squar gauss none sinc nelli model reflect window suppress later reflect typic recommend use window ie none windowing_width width window ps gaussian window gauss valu give twice standard deviat squar window squar valu give full width window case window center around maximum amplitud time trace output amplitude_window revis amplitud appli window faxi function determin appropri frequenc scale discret fourier transform gener array contain frequenc point thz input time axi ps argument time point ps trace fourier transform n number point discret fourier transform output f array frequenc valu thz df frequenc step size thz nt length input time vector dt time step assum uniform load_input load input file return structur contain relev data also check input error add air term geometri structur gener function retriev refract index layer argument sourc sourc input data either filenam point json file discuss input file section matlab struct contain inform output input matlab struct contain data process paramet geometri well function retriev refract index layer td_window window time domain trace suppress etalon argument time time axi trace window ps amplitud amplitud point trace window type string specifi type window perform time domain data either squar gauss none sinc nelli model reflect window suppress later reflect typic recommend use window ie none width width window ps gaussian window gauss valu give twice standard deviat squar window squar give full width window case window center around peak amplitud time trace output amplitude_window amplitud point appli window time_pad pad two trace match time point differ space accommod interpol trace finer space differ end point ie one trace goe longer time accommod pad shorter trace zero argument t_smp time point first trace ps a_smp amplitud first trace t_ref time point second trace ps a_ref amplitud second trace output result pad time axi a_smp_pad revis amplitud interpol pad first trace a_ref_pad revis amplitud interpol pad second trace tf_node class use handl tree node two type node layer interfac handl two class inherit tf_node layer_nod andinterface_nod respect constructor class follow layer_nod argument index index layer structur first layer dir direct puls travel layer valu travel forward ie away first layer travel toward first layer t_prev time accumul upon reach node ps use check time cutoff amp_prev amplitud puls upon reach node use check amplitud cutoff geom struct array contain geometri materi question usual gener load_input function freq frequenc construct transfer function n_solv trial valu unknown refract index t_cut time cutoff ps measur rel puls imping first layer path would take longer termin a_cut amplitud cutoff rel amplitud puls imping upon first layer exampl valu e would termin path amplitud less one thousandth initi amplitud parent contain refer parent node interface_nod argument index layer puls travel reach current interfac first layer index index layer puls would travel transmit interfac type specifi whether puls transmit reflect current interfac reflect transmit t_acc time accumul upon reach node ps use check time cutoff amp_prev amplitud puls upon reach node use check amplitud cutoff geom struct array contain geometri materi question usual gener load_input function freq frequenc construct transfer function n_solv trial valu unknown refract index t_cut time cutoff ps measur rel puls imping first layer path would take longer termin a_cut amplitud cutoff rel amplitud puls imping upon first layer exampl valu e would termin path amplitud less one thousandth initi amplitud parent contain refer parent node util sever post process debug util found util folder function use process extract refract index obtain properti permitt conduct etc well debug drude_fit fit given conduct drude model conduct calcul refract index output n_to_photocond function discuss argument freq frequenc point conduct trace thz cond conduct frequenc specifi freq sm output x array contain fit paramet first element give dc conduct sm second give scatter time ps func function take drude fit paramet return predict conduct exampl fit plot command plotfreq funcx drude_smith_fit fit given conduct drudesmith model argument freq frequenc point conduct trace thz cond conduct frequenc specifi freq sm output x array contain fit paramet first element give dc conduct sm second give scatter time ps third give c paramet persist veloc func function take drudesmith fit paramet return predict conduct exampl fit plot command plotfreq funcx error_map take transfer function experiment transfer function rang real imaginari part refract index gener error map show deviat experiment valu transfer function predict refract index rang given use check minim landscap local minima exampl error given erroromega leftlogtfomegalogtf_expomegaright leftangl tfomega angl tf_expomega pi mod pi pi right argument func transfer function assess tf_exp experiment transfer function compar func tf_freq frequenc point correspond data tf_exp n array contain valu real part refract index test func compar tf_exp valu ofni ikj k array contain valu imaginari part refract index test func compar tf_exp valu ofni ikj output map cell array matric one frequenc tf_freq matrix contain error func tf_exp refract index valu test word mapsiiindex_k index_n contain error refract index nindex_n ikindex_k frequenc tf_freqii visual map imagesc command help eg imagescmapsii row matric correspond differ valu imaginari part refract index column correspond differ valu real part just_propag extract refract index experiment transfer function assum chang amplitud phase due propag unknown layer ie reflect use rough check simpl case argument freq frequenc point given experiment transfer function tf_spec experiment transfer function correspond frequenc point freq thick micromet layer unknown refract index default refract index materi unknown layer replac assum would case refer simpli air refer empti cuvett fill sampl substanc sampl replac nonair materi refract index must provid addit argument just_propag n_off replac refract index output freq simpli echo input freq ref_index extract refract index phase unwrap phase use extract real part refract index use debug n_to_photocond take refract index photoexcit materi along nonphotoexcit index give photoconduct argument freq frequenc correspond specifi refract index n_photo array contain refract index photoexcit materi frequenc specifi freq n_non nonphotoexcit refract index materi given scalar materi static refract index array output sig array contain photoconduct sm tinkham extract conduct experiment transfer function use assumpt made tinkham glover argument tf_spec array contain experiment transfer function thick unknown layer micromet nn scalar array contain refract index substrat nonphotoexcit materi output cond conduct sm test packag suit test run order ensur code work properli run test run command runtest get help detail function type help function name matlab command window troubleshoot suggest suggest dont resolv issu feel free reach uriel dot tayvah yale dot edu question also submit issu github repositori httpsgithubcomyalethznellyissu troubleshoot suggest mani case best troubleshoot approach use error_map function gener map deviat predict transfer function experiment error function rang refract indic discuss common issu show characterist error map use diagnos root caus problem abrupt jump extract refract index caus pi jump ambigu propag term eik_dn sinc term take valu n_i n_j k_dn_i k_dn_j npi integ n particular problem thick layer higher frequenc indistinguish valu lie closer togeth n_i n_j npik_d seen plot gener error_map function exampl error map system suscept pi jump shown error_map_pidocserror_map_pipng see close space local minima error function caus abrupt jump optim success frequenc find differ local minima solut elimin thick layer referenc mani case thick layer caus pi jump substrat layer thick layer elimin calcul referenc substrat instead air decreas frequenc space refract index optim routin start optim valu previou frequenc caus problem refract index rapidli chang eg near reson case start valu may lie differ local minimum true valu avoid lower frequenc space minim chang refract index success frequenc point increas frequenc space anoth factor push optim incorrect local minima nois mani frequenc point must calcul fine frequenc space fewer data point averag per frequenc point lead higher nois address increas frequenc space aggress amplitud cutoff amplitud cutoff set high observ reflect erron ignor amplitud reflect differ frequenc may cutoff frequenc cutoff other abrupt chang inclusionexclus reflect lead abrupt chang extract refract index seen error map shown ridg a_cut e disappear lower a_cut error_maps_a_cutdocserror_maps_a_cutpng solut lower a_cut input done gradual sinc small valu take quit time run refer main text accompani paper neu j schmuttenma c tutori introduct terahertz time domain spectroscopi thztd journal appli physic httpsdoiorg glover r e tinkham conduct superconduct film photon energi kt_c phi rev httpsdoiorgphysrev nelly_mainm freq n_fit freq_ful tf_full tf_spec tf_pred func spec_smp spec_ref nelly_maininput t_smp a_smp t_ref a_ref input argument input contain input specif includ data process paramet like window zeropad geometri specif give thick refract index layer variabl either structur string point json file t_smp a_smp vector contain timedomain trace sampl geometri t_ref a_ref give timedomain trace refer geometri output argument freq vector contain frequenc point result n_fit vector contain refract indic extract correspond frequenc point found freq freq_ful full rang frequenc point creat zeropad fourier transform tf_full vector contain transfer functioni e_samplee_refat frequenc point freq_ful tf_spec vector contain transfer functionat frequenc point freq tf_pred transfer function predict extract refract index valu correspond freq func handl anonym function take two argumentsa frequenc valu unknown refract indexand return valu transfer function frequenc spec_smp complex spectrum sampl geometri point correspond freq spec_ref complex spectrum refer geometri point correspond freq fft_funcm freq spec fft_functim amplitud option input argument time amplitud vector give time domain trace fourier transform option structur give pad use structur match found fft portion set section exampl input file ie field windowing_typ etc