# PypeIt
[![PyPI](https://img.shields.io/pypi/v/pypeit?label=PyPI&logo=pypi&logoColor=white)](https://pypi.org/project/pypeit/)
[![Conda Version](https://img.shields.io/conda/vn/conda-forge/pypeit?label=conda%20version)](https://anaconda.org/conda-forge/pypeit)
[![Conda Downloads](https://img.shields.io/conda/dn/conda-forge/pypeit?label=conda%20downloads)](https://anaconda.org/conda-forge/pypeit)

[![CI Tests](https://github.com/pypeit/PypeIt/workflows/CI%20Tests/badge.svg)](https://github.com/pypeit/PypeIt/actions?query=workflow%3A"CI+Tests")
[![Coverage (release)](https://codecov.io/gh/PypeIt/pypeit/branch/release/graph/badge.svg)](https://codecov.io/gh/PypeIt/pypeit)
[![Coverage (develop)](https://codecov.io/gh/PypeIt/pypeit/branch/develop/graph/badge.svg)](https://codecov.io/gh/PypeIt/pypeit)
[![Documentation Status](https://readthedocs.org/projects/pypeit/badge/?version=latest)](https://pypeit.readthedocs.io/en/latest/?badge=latest)
[![astropy](http://img.shields.io/badge/powered%20by-AstroPy-orange.svg?style=flat)](http://www.astropy.org/)

The Python Spectroscopic Data Reduction Pipeline.  For
documentation visit:

http://pypeit.readthedocs.io

and/or see our HOWTO:

https://tinyurl.com/pypeit-howto

and/or join our PypeIt Users Slack
(the invite is recorded in this Issue:
https://github.com/pypeit/PypeIt/issues/676)

# Citation:

If you use ``PypeIt`` in your research, please cite the following
publications (BibTeX entries are provided below):

[![DOI](https://joss.theoj.org/papers/10.21105/joss.02308/status.svg)](https://doi.org/10.21105/joss.02308)
[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.3743493.svg)](https://doi.org/10.5281/zenodo.3743493)

If there is no place to include the relevant citations in the text of
the publication, please include the following acknowledgement
(provided in latex and using the provided BibTeX entries):

    This research made use of \ttfamily{PypeIt},\footnote{\url{https://pypeit.readthedocs.io/en/latest/}}
    a Python package for semi-automated reduction of astronomical slit-based spectroscopy
    \citep{pypeit:joss_pub, pypeit:zenodo}.

## BibTeX

    @ARTICLE{pypeit:joss_arXiv,
           author = {{Prochaska}, J. Xavier and {Hennawi}, Joseph F. and {Westfall}, Kyle B. and
             {Cooke}, Ryan J. and {Wang}, Feige and {Hsyu}, Tiffany and
             {Davies}, Frederick B. and {Farina}, Emanuele Paolo},
            title = "{PypeIt: The Python Spectroscopic Data Reduction Pipeline}",
          journal = {arXiv e-prints},
         keywords = {Astrophysics - Instrumentation and Methods for Astrophysics},
             year = 2020,
            month = may,
              eid = {arXiv:2005.06505},
            pages = {arXiv:2005.06505},
    archivePrefix = {arXiv},
           eprint = {2005.06505},
     primaryClass = {astro-ph.IM},
           adsurl = {https://ui.adsabs.harvard.edu/abs/2020arXiv200506505P},
          adsnote = {Provided by the SAO/NASA Astrophysics Data System}
    }

    @article{pypeit:joss_pub,
        doi = {10.21105/joss.02308},
        url = {https://doi.org/10.21105/joss.02308},
        year = {2020},
        publisher = {The Open Journal},
        volume = {5},
        number = {56},
        pages = {2308},
        author = {J. Xavier Prochaska and Joseph F. Hennawi and Kyle B. Westfall and Ryan J. Cooke and Feige Wang and Tiffany Hsyu and Frederick B. Davies and Emanuele Paolo Farina and Debora Pelliccia},
        title = {PypeIt: The Python Spectroscopic Data Reduction Pipeline},
        journal = {Journal of Open Source Software}
    }

    @MISC{pypeit:zenodo,
           author = {{Prochaska}, J. Xavier and {Hennawi}, Joseph and {Cooke}, Ryan and
             {Westfall}, Kyle and {Wang}, Feige and {EmAstro} and {Tiffanyhsyu} and
             {Wasserman}, Asher and {Villaume}, Alexa and {Marijana777} and
             {Schindler}, JT and {Young}, David and {Simha}, Sunil and
             {Wilde}, Matt and {Tejos}, Nicolas and {Isbell}, Jacob and
             {Fl{\"o}rs}, Andreas and {Sandford}, Nathan and {Vasovi{\'c}}, Zlatan and
             {Betts}, Edward and {Holden}, Brad},
            title = "{pypeit/PypeIt: Release 1.0.0}",
             year = 2020,
            month = apr,
              eid = {10.5281/zenodo.3743493},
              doi = {10.5281/zenodo.3743493},
          version = {v1.0.0},
        publisher = {Zenodo},
           adsurl = {https://ui.adsabs.harvard.edu/abs/2020zndo...3743493P},
          adsnote = {Provided by the SAO/NASA Astrophysics Data System}
    }

# Funding

`PypeIt` receives direct funding from the following sources:

* NASA (ADAP-A20-0412)
* W.M. Keck Observatory
* University of California Observatories

We also rely on important in-kind contributions from individuals at
Caltech, the Multiple Mirror Observatory, and elsewhere.

# Contribute

We encourage anyone to help us develop the `PypeIt` code base to better
suit your needs and to improve its algorithms. If you do so, please
follow our [Development
Guidlines](https://pypeit.readthedocs.io/en/latest/development.html)

In particular, please note our [Code of
Conduct](https://pypeit.readthedocs.io/en/latest/codeconduct.html).


# Instruments Served
* Bok/B&C
* Gemini/GNIRS
* Gemini/GMOS
* Gemini/FLAMINGOS 2
* GTC/OSIRIS
* Lick/Kast
* Magellan/MagE
* Magellan/Fire
* MMT/BinoSpec (270 and 600 tested)
* MMT/MMIRS (HK_zJ, J_zJ, and K_K tested)
* MMT/Blue Channel (300 tested)
* MDM/OSMOS
* Keck/DEIMOS (600ZD, 830G, 1200G)
* Keck/KCWI
* Keck/LRIS
* Keck/MOSFIRE  (J and Y gratings tested)
* Keck/NIRES
* Keck/NIRSPEC (low-dispersion)
* LBT/Luci-I, Luci-II
* LBT/MODS (beta)
* LDT/DeVeny
* Lick/APF (planned)
* NOT/ALFOSC (grism4)
* VLT/X-Shooter
* VLT/FORS2  (300I, 300V)
* WHT/ISIS
* P200/DBSP (316/7500 on red arm, 600/4000 on blue arm)
* P200/TripleSpec

# Requirements

(see `setup.cfg` or `environment.yml`)

* python
* numpy
* scipy
* matplotlib
* astropy
* ginga
* h5py
* future
* PyYAML
* linetools
* IPython
* scikit-learn
* configobj


# License (BSD-3)

(see `LICENSE.rst`)

Copyright (c) 2018-2019, PypeIt Developers All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

 - Redistributions of source code must retain the above copyright
   notice, this list of conditions and the following disclaimer.

 - Redistributions in binary form must reproduce the above copyright
   notice, this list of conditions and the following disclaimer in the
   documentation and/or other materials provided with the distribution.

 - Neither the name of the Astropy Team nor the names of its
   contributors may be used to endorse or promote products derived from
   this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
---
title: 'PypeIt: The Python Spectroscopic Data Reduction Pipeline'
tags:
  - Python
  - astronomy
  - data reduction
  - spectroscopy
authors:
  - name: J. Xavier Prochaska
    orcid: 0000-0002-7738-6875
    affiliation: "1, 2" # (Multiple affiliations must be quoted)
  - name: Joseph F. Hennawi
    orcid: 0000-0002-7054-4332
    affiliation: 3
  - name: Kyle B. Westfall
    orcid: 0000-0003-1809-6920
    affiliation: 4
  - name: Ryan J. Cooke
    orcid: 0000-0001-7653-5827
    affiliation: 5
  - name: Feige Wang
    orcid: 0000-0002-7633-431X
    affiliation: "2, 6"
  - name: Tiffany Hsyu
    orcid: 0000-0002-0462-3139
    affiliation: 1
  - name: Frederick B. Davies 
    orcid: 0000-0003-0821-3644
    affiliation: "2, 7"
  - name: Emanuele Paolo Farina
    orcid: 0000-0002-6822-2254
    affiliation: "2, 8"
  - name: Debora Pelliccia
    orcid: 0000-0002-3007-0013
    affiliation: 4
affiliations:
 - name: University of California, Santa Cruz
   index: 1
 - name: Kavli Institute for the Physics and Mathematics of the Universe
   index: 2
 - name: University of California, Santa Barbara
   index: 3
 - name: University of California Observatories
   index: 4
 - name: Durham University, UK
   index: 5
 - name: Steward Observatory, University of Arizona
   index: 6
 - name: Lawrence Berkeley National Laboratory
   index: 7
 - name: Max Planck Institut f\"{u}r Astrophysik
   index: 8
date: 12 August 2020
bibliography: paper.bib
---

# Summary

``PypeIt`` is a Python package for semi-automated reduction of
astronomical, spectroscopic data. Its algorithms build on
decades-long development of previous data reduction pipelines by the
developers [@mike; @mase]. The reduction procedure - including a
complete list of the input parameters and available functionality -
is provided as online documentation hosted by [Read the
Docs](https://pypeit.readthedocs.io), which is regularly updated.
It is a set of commands designed to perform the reduction without
any additional coding.
In what follows, we provide a brief description of the algorithms,
but refer the interested reader to the online documentation for
the most up-to-date information. 

Release v1.3 serves the following spectrographs:
Gemini/GNIRS,
    Gemini/GMOS,
    Gemini/FLAMINGOS 2,
    Lick/Kast,
    Magellan/MagE,
    Magellan/Fire,
    MDM/OSMOS,
    Keck/DEIMOS (600ZD, 830G, 1200G),
    Keck/KCWI (BM, BH2),
    Keck/LRIS,
    Keck/MOSFIRE (Y, J, K gratings tested),
    Keck/NIRES,
    Keck/NIRSPEC (low-dispersion; old detector),
    LBT/Luci-I,
    LBT/Luci-II,
    LBT/MODS,
    MDM/OSMOS,
    MMT/MMIRS,
    MMT/binospec,
    NOT/ALFOSC,
    P200/DBSP,
    P200/TripleSpec,
    VLT/X-Shooter (VIS, NIR),
    VLT/FORS2 (300I, 300V)


This v1.3 release of ``PypeIt`` is designed to be used by both advanced
spectroscopists with prior data reduction expertise and astronomers with
no prior experience of data reduction. It is highly configurable and
designed to be applied to any standard slit-imaging spectrograph, and
can accomodate longslit, multislit, as well as cross-dispersed echelle
spectra. It has already enabled several scientific publications
[@hsyu2018; @eilers2018; @eilers2020; @wang2020; @yang2020a; @yang2020b; @pelliccia2020].

In order to successfully reduce your data with ``PypeIt``, we recommend that
you obtain the following calibration frames as a minimum, using these
guidelines:

(i) Flat frames (at least 1 frame, and ideally more than 5) to be used for slit/order edge tracing and relative
pixel efficiency correction. These frames should be acquired with the same slit width and setup as your science frames.

(ii) Arc frames (at least 1 frame, and ideally ~3 to improve S/N of weak lines) to be used for wavelength calibration.  Please see the online ``PypeIt`` documentation for suggestions about the choice of lamps that you should use for your instrument/setup. These frames should be acquired with the same slit width and setup as your science frames.
For the near-IR PypeIt uses sky lines for wavelength calibration so arcs are not required. 

Depending on your science goal, and the instrument being used, you may
also require the following optional frames:

(iii) Bias or dark frames (ideally 10 frames) should be acquired with a 0 second exposure
with the shutter closed, while dark frames (ideally 3 frames) should be acquired
with the shutter closed, ideally with an exposure time of equal
duration to your science frames.

(iv) Twilight sky frames (ideally 3 frames) using a slit width of equal size to your
science frames. These frames are used to construct slit illumination functions for situations where the internal or dome flats: either produce a different illumination function than the sky (i.e. often for internals) or suffer from insufficient counts (often an issue in the blue). 

(v) Pixel flat frames (ideally more than 3) which are taken with the
detectors uniformly illuminated (or, with a slit width larger than that
taken with the science frames).

(vi) Standard star frames (at least 1 frame, ideally 3) to calibrate your spectrum (depending on your science goal, this may be a flux, telluric, color, or velocity standard).

After the creation of a custom input/configuration file, the pipeline
runs end-to-end to convert raw spectroscopic images into calibrated,
science-ready spectra. In what follows, we describe several key steps
of the data reduction procedure:

(1) The pipeline automatically characterises the raw input frames
based on header information. We have also developed a SPectral Image
Typing (SPIT) tool [@spit] to classify images based on the pixel data.
The output of this classification procedure is an input ``PypeIt`` file
that allows the user to specify the parameters of their reduction and
manually update the classification of the input raw images.

(2) The reduction procedure consists of a script that automatically
applies a series of algorithms to the raw data frames. All raw images
are first overscan subtracted, and optionally corrected for the bias
and dark current. A bad pixel mask is generated internally, or can
be constructed using the bias or dark frames, if available. All
frames of the same type are robustly combined to construct master
calibration frames.

(3) The edges of the slit are typically traced using frames where the
slit is uniformly illuminated by either a halogen lamp or a spectrum
of the twilight sky (especially for blue setups).

(4) A master arc frame (or the science data in the near-IR) is used for wavelength calibration and to
generate a map of the wavelength solution across the entire detector.
This accounts for the spectral tilt across the slit. ``PypeIt`` contains
an archive of wavelength solutions that are used to determine the
wavelength solution of your data. If the automated wavelength
calibration technique does not succeed, ``PypeIt`` includes a
script with a graphical user interface that allows the user
to calibrate their spectra. If you perform a wavelength
calibration, we kindly request that you share your solution, and
we will make this available to the community.

(5) ``PypeIt`` generates a 2D model of the flat frame, which is
used to construct a pixelflat, and to determine the spatial
slit profile. Throughout the reduction procedure, the slit
trace image is also used to calculate the spatial flexure of
each frame relative to the master flat frame.

(6) The above calibrations are applied to every science and standard star frame.
``PypeIt`` jointly performs the object extraction and b-spline [@kelson2003] sky
subtraction.  A two-dimensional model of the sky is first constructed using the spectral
tilt map, including a robust fit to separate the signal of the
science target from the sky background emission. This sky
model is locally refined around the science target during
spectrum extraction. The algorithm we have developed for ``PypeIt``
achieves Poisson limited sky-subtraction (see \autoref{fig:skysub}).
``PypeIt`` then performs a boxcar and an
optimal extraction to generate 1D science spectra. The final
output of this procedure is a series of fully reduced one- and
two-dimensional spectra. 

![PypeIt sky subtraction reaches the Poisson limit. This image shows several two-dimensional
Keck/DEIMOS spectra (1200G grating). From left to right:
(1) Raw science frame,
(2) Processed science frame after a model of the sky emission has been removed,
(3) Same as previous, but relative to the noise to highlight object spectrum and sky residuals,
(4) Same as previous, but a model of the object is also removed. This produces a final processed 2D frame at the Poisson limit.
\label{fig:skysub}](skysub.png)

(7) As a final step, the wavelength solution of the one-dimensional
extracted spectra are corrected for spectral flexure with
reference to the sky emission lines. The wavelength solution
can then be transformed to the user-spectified frame of
reference (usually heliocentric or barycentric).

Finally, ``PypeIt`` also includes scripts to flux calibrate and
combine multiple one- and two-dimensional exposures, as well as software for
performing telluric corrections. ``PypeIt`` produces a series of
calibration-related outputs and includes scripts and automatically
generated plots for quality assurance inspection. The final outputs
are FITS files with rigid well-documented data models that hold the two-dimensional
(includes spatial information) and one-dimensional spectral
extractions.

It is our plan to expand ``PypeIt`` to include the majority of
spectrographs on the largest ground-based optical and near-infrared
telescopes, ideally with help from the broader community. We are
currently working towards implementing the following additional
spectrographs:
Keck/DEIMOS (all gratings)
Keck/KCWI,
Keck/MOSFIRE (all setups),
Keck/NIRSPEC (new detector + high resolution),
Keck/ESI, 
Keck/HIRES, 
Magellan/IMACS,
MMT/BinoSpec,
VLT/UVES.
We are also open to receiving requests to support additional
spectroscopic instrumentation.
Join us [on GitHub](https://github.com/pypeit/PypeIt). We ask those interested in developing and 
enhancing PypeIt to agree to our [code of
conduct](https://pypeit.readthedocs.io/en/latest/codeconduct.html).

# Acknowledgements

We acknowledge intellectual contributions from Scott Burles, Rob Simcoe, and David Schlegel.

``PypeIt`` has been financially supported by the University of California
Observatories. J. F. H. also acknowledges support from 
the University of California, Santa Barbara. During work on 
``PypeIt``,  R. J. C. was supported by a Royal Society University Research Fellowship, 
and acknowledges support from STFC (ST/P000541/1, ST/T000244/1).

# References


1.7.0 (19 Nov 2021)
-------------------

- Introduces pypeit_parse_calib_id script
- Throw a warning if the chosen spectrograph has a header which does not
  match expectation
- Pypeit can now read (currently for Keck DEIMOS only) the list of arc
  lamps from the header and use it for wavelength calibration.
- Allow one to restrict the wavelength range of the arxiv template
- Set DEIMOS FWHM default to 10 pixels
- Fixed a bug in HolyGrail that did not allow for sigdetect and
  rms_wavelength to be slit dependent lists.
- Improvements for MOSFIRE:
    - uses slitmask info in the slit edge tracing
    - associates RA, Dec and Object name to each extracted object
    - extracts undetected objects using the predicted position from
      slitmask info
    - uses dither offeset recorded in the header as default
      slitmask_offset, but the user can provide the maskdef_id of a slit
      with a bright object that can trace the offset.
    - improvements in the frame typing
- Implements new Mark4 detector for Keck/LRISr (aka keck_lris_red_mark4)

1.6.0 (1 Oct 2021)
------------------

- Modifications to reduce header crashes
- Added `image_proc.rst` doc, which includes a table with the primary parameters
  that affect the control flow of the image processing.
- Added exptime and units to the PypeItImage data model.
- Made bias subtraction available to the dark image processing (i.e., if people
  request bias subtraction for darks, the bias needs to be passed).  Similarly,
  added dark to the buildimage calls in get_arc and get_tiltimage.
- Streamlining of the operations in pypeit.core.flat.flatfield.
- Digitization noise no longer added to readnoise calculation by default.
- Include "processing error" in error budget.  Accounts for, e.g., readnoise in
  dark image, etc.
- Include error calculation in overscan subtraction.  The error estimate is the
  standard error in the median, which will be an overestimate for the savgol
  method.
- Allow for pinhole and sky frames in buildimage_fromlist.
- In pypeit.images.rawimage.RawImage:
    - Conversion from ADU to counts is now the first step for all processing.
    - Added an `empirical_rn` parameter that allows the users to use the
      overscan region to estimate the detector readnoise for each image
      processed, and this estimation of the readnoise is now in its own method.
    - Subtraction of the dark is now done after the conversion of the image to
      counts.
    - Dark subtraction is now always performed using the tabulated values for
      each detector.  A warning is thrown if the dark frames are provided and
      the measured dark-current from a dark image is more than 50% different
      from the tabulated value.
    - Whether or not you add the shot noise and a noise floor to the variance
      image are now optional and controlled by parameters in ProcessImagesPar.
    - Changes to default ProcessImagesPar parameters: use_specillum = False for
      all frame types; shot_noise = False and noise_floor = 0 for biases; and
      use_overscan=True, use_biasimage=True, noise_floor=0., and mask_cr=True
      for darks.  Adjustments propagated to individual spectrographs.
    - BPM is not recalculated after applying the flat-field correction because
      it is not longer changed by that function.
    - The code keeps track of the image scaling via the flat-field correction,
      and propagates this to the noise model.
    - Compute and save a "base-level variance" that includes readnoise, dark
      current, and processing error as part of the PypeItImage datamodel.
    - Added `base_var` and `img_scale` to the datamodel of PypeItImage, as well
      as the noise_floor and shot_noise booleans.  All of these are used by
      pypeit.core.procimg.variance_model to construct the error model.
    - Added BADSCALE bit to ImageBitMask to track when flat-field corrections
      are <=0.
- Added `update_mask` and `select_flag` methods to PypeItImage as convenience
  methods used to update and extract information from the fullmask bitmask
  attribute.
- CombineImage now re-calculates the variance model using the stacked estimate
  of the counts instead of propagating the estimates from the individual
  exposures.
- CombineImage performs a masked median when combine_method = 'median', and the
  error is the standard error in the median.
- Simplifies stacking of bits in CombineImage.
- Calculation of the variance in processed images separated into two functions,
  pypeit.core.procimg.base_variance and pypeit.core.procimg.variance_model.
  These replace variance_frame.
- Added a "detectors" doc, and an automatically generated table with relevant
  detector parameters (including the dark current) used for instrument.
- Improved fidelity of bspline timing tests using timeit.
- Added inverse variance images to MasterBias and MasterDark frames so that they
  are available for re-use.

1.5.0 (11 Aug 2021)
-------------------

- Doc updates, including reorganization of the installation doc, fluxing and
  telluric docs, and automatic construction of the package dependencies.
- Add new pixelflat_min_wave parameter below which the mspixelflat is set to 1.
- Add `pypeit_install_telluric` and `pypeit_install_ql_masters` scripts.  The
  latter creates a symlink to the directory with the QL masters that will be
  used if the QL_MASTERS environmental variable does not exist.
- Improved `edgetrace.maskdesign_matching` to always return syncronized traces.
- Pypeit can now deal with dithered observations (only for DEIMOS for now), by
  finding the offset of the observed slitmask from the expected position in the design file.
- There are three options the user can use to find the slitmask offset: bright objects,
  selected slit, or alignment boxes.
- Pypeit run object finding for the alignment boxes but it does not extract them.
- `reduce.run` is now split in two methods: `run_objfind` and `run_extraction`.
- There are now 2 loops over the detectors in `pypeit.reduce_exposure`: the first
  one runs calibrations and object finding for all the detectors and the second one
  runs the extraction. In between the two loops, the slitmask offset is computed.
- A script (`get_telescope_offset`) to determine the telescope pointing offsets is
  added to `pypeit/spectrographs/keck_deimos.py`
- Improve SOAR Goodman fluxing


1.4.2 (06 Jul 2021)
-------------------

- Added a common base class for all scripts
- Script methods now included in Sphinx documentation
- Updated `pypeit.scripts.scriptbase.SmartFormatter` to enable wrapping
  long lines and specify lines with a fixed format using `F|`.
- Made `pypeit.core.telluric.Telluric` subclass from
  `pypeit.datamodel.DataContainer`, and added some basic unit tests.
  This led to some changes in the existing datamodel.
- Made `pypeit.sensfunc.SensFunc` subclass from
  `pypeit.datamodel.DataContainer`, and added some basic unit tests.
  This led to some changes in the existing datamodel.
- Allowed `pypeit.datamodel.DataContainer` parsing methods to used
  pseudonyms for HDU extension names and base classes to read the
  datamodels of subclasses.  Both added new keywords that default to
  previous behavior.
- Moved some functions to avoid circular imports
    - `pypeit.coadd1d.OneSpec` -> `pypeit.onespec.OneSpec`
    - `pypeit.core.coadd.get_wave_grid` ->
      `pypeit.core.wavecal.wvutils.get_wave_grid`
    - `pypeit.core.coadd.sensfunc_weights` ->
      `pypeit.sensfunc.sensfunc_weights`
- Add LDT/DeVeny spectrograph
- Add 6440.25A CdI line (LDT/DeVeny)
- Modify SOAR to read their (truly) raw files
- GMOS doc updates


1.4.1 (11 Jun 2021)
-------------------

- Adds SOAR/Goodman red camera
- Update to Gemini-S telescope info
- Make PypeIt ISO 8160 (more) compliant
- Address an Identify bug
- Add blocking filter to DEIMOS config
- NOT/Alfosc updates
- A pair of fixes for shane_kast_red
- Add NTT EFOSC2 spectrograph
- Add standard stars CD-34241 and CD-329927 to esofil
- Add wavelength solution for keck_lris_red 600/10000
- `pypeit_show_2dspec` shows traces of forced extraction and manual
  extraction with different colors
- Updated docs about extraction and DEIMOS
- Implement multi-detector flexure estimates
- Fix error in variance for numpy fitting routines
- Introduce HOWTO for DEIMOS
- Method for slupring in a standard observed and reduced by WMKO


1.4.0 (23 Apr 2021)
-------------------

- Include a fix for when no edges are detected in `EdgeTraceSet` by
  adding the `bound_detector` parameter.  Most instruments have a
  default of `bound_detector = False` meaning that the code will skip
  processing any detector where no slit edges are found.  Some
  instuments set the default to be `bound_detector = True` because the
  slit edges always or often fall off the edge of the detector (i.e.,
  the detector is fully illuminated).  These instruments are currently
  `mmt_mmirs`, `mmt_bluechannel`, `not_alfosc`, and `shane_kast`; note
  that some `gemini_gmos` data in the DevSuite require
  `bound_detector=True`, as well.
- Improved wavelength template for DEIMOS gratings: 600ZD, 830G.
- Added new ArI, KrI, NeI, XeI arc lines.
- PypeIt can now compute arc line FWHM from the lines themselves. This
  is controlled by a new parset, ``fwhm_fromlines``, which is set to
  False by default, except for DEIMOS.
- Added a development document about the DEIMOS wavelength calibration.
- Limit reduction to detectors 3 and 7 when DEIMOS LVM mask is used
  (other detectors are empty)
- Add `pypeit_obslog` script that simple compiles and prints metadata
  from a set of fits files needed by pypeit to run.
- Change `PypeItSetup.from_file_root` to *require* the output path to
  write the vanilla pypeit file.  If no path is provided, the object is
  instatiated without creating any output.
- Fixed bug in sensitivity function code adressing issue #747. Revamped
  sensitivity function completely to compute zeropoints and throughput.
  Enhanced sensfunc.py QA.
- Added MOSFIRE QL script.
- Added support for VLT/SINFONI K 25mas (0.8x0.8 arcsec FOV) platescale
- Updated docs for differencing imaging sky subtraction.
- Added "sky" frametype for difference imaging sky subtraction
  addressing issue # 1068
- Improved and sped up sensitivity function telluric codes.
- Fixed bugs in ArchiveReid automatic wavelength identification.
- Removed numba dependency.
- Improved pypeit_view_fits script.
- Fixed ginga bugs in display.py and added automatic cuts to show_2dspec
- Added latin hypercube sampler to pypeit.utils which is required for
  differential evolution optimizations.
- Improved GMOS R400 wavelength solution
- Turned off GMOS-S binning restriction
- Add GTC OSIRIS spectrograph
- Updates for docs on adding new spectrographs.  And a bok test
- Added a new ``pypeit_collate_1d`` tool to automatically group 1D
  Spectra from multiple files by group and coadd them.
- PypeIt will now add HISTORY keyword entries to FITS files.
- `use_maskdesign` is turned off for DEIMOS LVM masks
- a new parameter `use_user_fwhm` is added in `ExtractionPar` to allow
  the user to set their preferred fwhm
- Improved `slittrace.assign_maskinfo`
- PypeIt can now force extractions of DEIMOS non detected objects at the
  location expected from slitmask design.
- SpecObj and SlitTrace datamodel versions updated

1.3.3 (24 Feb 2021)
-------------------

- (Hotfix) Command-line argument bug in `pypeit_coadd_1dspec` script.
- (Hotfix) Bug fix in `pypeit_obslog` script.
- (Hotfix) X-Shooter bits


1.3.2 (08 Feb 2021)
-------------------

- (Hotfix) Bug in content type of README file that prevented upload to
  PyPI

1.3.1 (01 Feb 2021)
-------------------

- pypeit_chk_wavecalib script
- Option to limit channels shown for pypeit_show_2dspec
- sigdetect on in full_template
- Added new ArI, ArII lines
- Improved 1Dfit QA
- Final wavelength template for DEIMOS 900ZD
- Fix a bug in `pypeit/core/arc.py` and `pypeit/core/wavecal/autoid.py` due
  to the padding to the arc frames
- Added a new XeI line
- Turn off sigma clipping for DEIMOS arc frames.
- Refactor setup.py to use setup.cfg to define package configuration
- Refactor version handling to use setuptools_scm to grab version info from git tags
- Add support for testing within isolated environments via tox
- Refactor CI to use tox to run tests
- Add cron-scheduled tests to CI
- Add tests to CI to cover macos, windows, and conda installations
- Refactor wrapper scripts in bin/ to be entry_points defined in setup.cfg
- Deprecate check_requirements now that dependencies are handled by the installation



1.3.0 (13 Dec 2020)
-------------------

- DATE-OBS, UTC, AMPMODE, and MOSMODE added to metadata for DEIMOS, and
  the first three are now included in the auto-generated pypeit files.
- DEIMOS AMPMODE is now included in the list of metadata used to
  determine the DEIMOS configuration (setup).
- Frames ignored by
  `pypeit.metadata.PypeItMetaData.unique_configurations` used to
  establish the unique configurations are now set by
  `pypeit.spectrographs.spectrograph.Spectrograph.config_independent_frames`.
  These default to 'bias' and 'dark' frames.
- `pypeit.spectrographs.spectrograph.Spectrograph.config_independent_frames`
  can also return a *single* keyword selecting the metadata column used
  to match these frames to a given configuration.  For DEIMOS, this is
  used to match bias and dark frames to a configuration observed on the
  same date.  Currently these frames can only be set to a single
  configuration.
- Added `pypeit.metadata.PypeItMetaData.clean_configurations` that
  ignores frames that cannot be reduced by pypeit, as set by
  `pypeit.spectrographs.spectrograph.Spectrograph.valid_configuration_values`.
  For DEIMOS, this is used to ignore frames that are taken in
  direct-imaging mode or using anything except the B amplifier to read
  the data.  The ignored frames are removed from the metadata table
  (`fitstbl`).
- `update_docs` script now builds the html as well as the api rst files.
  It also prints a pass/fail comment.
- Added tests to `pypeit/tests/test_setups.py` to test that PypeIt
  correctly and automatically identifies frames from multiple DEIMOS
  configurations and that `pypeit.pypeitsetup.PypeItSetup` correctly
  produces separate pypeit files for each configuration.
- Added a development document reporting that PypeIt now satisfies the
  `PD-3` requirement Keck outlined for the DEIMOS PypeIt pipeline.
- Building the docs now dynamically generates an example pypeit and
  sorted file for inclusion in the PypeIt documentation.
- The setup block is now a simple listing of the keywords and values
  used to identify the instrument configuration.
- Refactor identify GUI and improve its docs
- Modest refactoring of templates.py
- Construction of wavelength arxiv files for DEIMOS 1200B and blue 1200G
- Pypeit now adds DEIMOS slits that are expected from the slitmask design
  but not found in the tracing process.
- PypeIt now flags as “BOXSLT” DEIMOS slits that are expected to be
  alignment boxes from slitmask design.
- Added a table with DEIMOS slitmask design and objects info to the
  SlitTraceSet datamodel
- Add support for MMTO Blue Channel Spectrograph
- Add GitHub Actions CI workflow
- Incorporates a procedure to enable GMOS Nod and Shuffle observations
- New GMOS wavelength solutions
- Remove Travis CI config
- General housecleaning of spectrographs
    - Documentation improvements
    - Dynamically builds table of available spectrographs; see
      `pypeit.spectrographs.available_spectrographs`
    - `pypeit.defs` is now deprecated
    - Removed usage from `pypeit.pypmsgs` and moved it to `run_pypeit.py`
    - Many Spectrograph instance attributes are now class attributes; in
      particular, previous instance attribute `spectrograph` is now `name`.
    - Added class attributes that set if the spectrograph is supported and any
      comments for the summary table.
    - `default_pypeit_par` is now a class method, which allows the name of the
      spectrograph to be defined in a single place
    - Valid spectrographs are no longer checked by
      `pypeit.par.pypeitpar.ReduxPar`.  This caused a circular import in the
      new strucuture.  The parameter `par['rdx']['spectrograph']` is virtually
      always checked by `load_spectrograph`, so I don't think this is a
      problem.
- Kastr 300 grating solutions
- Hotfix to include the solutions!
- Improved DEIMOS slitmask design matching
- Assign RA/DEC to DEIMOS extractions
- DEIMOS object RA, Dec, and name returned when running `pypeit_show_1d --list` and saved in
  the .txt file with the list of 1d spectra.
- DEIMOS object name and `maskdef_id` visible in ginga when running `pypeit_show_2d`
- Fix sigma clipping bug!

1.2.0 (15 Oct 2020)
-------------------

- Frame-typing tweaks for DEIMOS
    - Exposure-time ranges removed
    - All frame types now key off OBSTYPE
- Added more detail on citation policy to main page on readthedocs
- Added docs for BitMasks
- Altered scripts interface to allow for dynamically making the help doc
  files
- full spatial/spectral flexure and heliocentric corrections implemented
  for IFU reductions
- optimal weights in datacube generation
- Docs for skysub, extraction, flat fielding
- New skysub options for masking and suppressing local
- Added `pypeit/core/convert_DEIMOSsavfiles.py` to convert .sav files
  into fits files
- Added "amap" and "bmap" fits files in
  `pypeit/data/static_calibs/keck_deimos/` for DEIMOS optical model
- Added `pypeit/core/slitdesign_matching.py` and `maskdesign_matching`
  to `EdgeTraceSet`
- Added ParSet for switching ON the slit-mask design matching. Default
  is ON for `keck_deimos`
- Pypeit registers `maskdef_id` in SlitTraceSet if instrument is
  `keck_deimos`
- Fix assignment bug in fitting bspline

1.1.1 (10 Sep 2020)
-------------------

- (Hotfix) Fluxing doc edits
- (Hotfix) Fix sdist pip installation

1.1.0 (8 Sep 2020)
------------------

- Fixed a bug for IR reductions for cases where only negative object
  traces are identified.  These were accidentally being written to the
  spec1d file.
- Fixed a bug fixes a bug in full_template wavelength reidentification
  for situations where extreme wavelength coverage slits results in
  reidentification with a purely zero-padded array.
- Fixed a bug fixes a bug in full_template wavelength reidentification
  for situations where extreme wavelength coverage slits results in
  reidentification with a purely zero-padded array.
- Fixed another such bug arising from these zero-padded arrays.
- (Hotfix) Deal with chk_calibs test
- Script to generate combined datacubes for IFU data.
- Changed numpy (> 1.18.0) and scipy (> 1.4.0) version requirements
- Allow show2d_spec, chk_edges, chk_flats to load older Spec2DObj
  datamodel versions
- Implemented a plugin kindly provided by the ginga developers to
  display images with a secondary wavelength image WCS.
    - Removes dependency on @profxj's ginga fork, and avoids a bug when
      using WCS image registration in that fork.
    - `pypeit/ginga.py` moved to `pypeit/display/display.py` and ginga
      plugin added to `pypeit/diplay` directory.
    - ginga plugin registered as an entry point in `setup.py`
    - Added a script to check that the plugins are all available.
    - Installation docs updated.  Both `ginga` and `linetools` are now
      installed via pip.
- Deprecated `pypeit/debugger.py` and `pypeit/data/settings`
- Removed h5py as a dependency
- `linetools` is now listed in `pypeit/requirements.txt` until I can
  check if it still causes readthedocs to fail...
- Modify Spec2DObj 2D model for float32 images
- `pypeit.tracepca.TracePCA` and `pypeit.edgetrace.EdgeTraceSet` now
  subclass from `pypeit.datamodel.DataContainer`
- Refactor WaveCalib into a DataContainer
- Refactor fitting + PypeItFit DataContainer
- Coadd2D bug fixes
- Coadd2D without spec1d files
- Coadd2D offsets
- Some Coadd2D docs
- Manual extraction
- Improve LBT/LUCI
- Add MMT/MMIRS
- QL script for Keck/MOSFIRE (beta version)
- Correct det bug in keck_lris
- Modifications to allow for flailing LRISr detector
- Modifications for parse LRIS LAMPS prior to 2010 upgrade
- Added support for P200/DBSP and P200/TripleSpec

1.0.6 (22 Jul 2020)
-------------------

- (Hotfix) Deal with wavecalib crash
- Fix class and version check for DataContainer objects.
- Script to check for calibration files
- No longer require bias frames as default for DEIMOS
- Implement grism19 for NOT/ALFOSC
- Introduced another parameter used to identify box slits, as opposed to
  erroneous "slits" found by the edge tracing algorithms.  Any slit that
  has `minimum_slit_length < length < minimum_slit_length_sci` is
  considered a `BOXSLIT`, any slit with `length < minimum_slit_length`
  is considered a `SHORTSLIT`; the latter are always ignored.
- Introduced order matching code into EdgeTraceSet.
    - This helps fix an issue for GNIRS_10L caused by the orders
      shifting.
    - Introduces two paramters in `EdgeTraceSetPar` to assist the
      matching: `order_match` and `order_offset`
    - Echelle spectrographs should now always have `ech_order` defined
      in the SlitTraceSet object.
    - Removes the need for `Spectrograph.slit2order` and
      `Spectrograph.order_vec`.  Changes propagated, primarily in
      `wavecalib.py`, `autoid.py`, and `reduce.py`.
- Adds in Keck/LRISr with the original detector
- Adds in Keck/LRISb with the FITS format

1.0.5 (23 Jun 2020)
-------------------

- Add median combining code
- Make biasframes median combine by default
- Implemented IFU reduction hooks
- KCWI reduction complete up to spec2D frames
- Implemented new flatfield DataContainer to separate pixelflat and
  illumflat

1.0.4 (27 May 2020)
-------------------

- Add a script (pypeit_flux_setup) for creating fluxing, coadd1d and
  tellfit pypeit files
- Add telluric fitting script, pypeit_tellfit

1.0.3 (04 May 2020)
-------------------

- Add illumflat frametype
- Enable dark image subtraction
- Refactor of Calibrations (remove cache, add get_dark)
- Enable calibration-only run
- Clean up flat, bias handling
- Make re-use masters the default mode of run_pypeit
- Require Python 3.7
- Fixed a bug in NIRES order finding.
- Add NOT/ALFOSC
- Fluxing docs
- Fix flexure and heliocentric bugs
- Identify GUI updates

1.0.2 (30 Apr 2020)
-------------------

- Various doc hotfixes
- wavelength algorithm hotfix, such that they must now generate an entry
  for every slit, bad or good.

1.0.1 (13 Apr 2020)
-------------------

- Various hot fixes

1.0.0 (07 Apr 2020)
-------------------

- Replaces usage of the `tslits_dict` dictionary with
  `pypeit.slittrace.SlitTraceSet` everywhere.  This `SlitTraceSet`
  object is now the main master file used for passing around the slit
  edges once the edges are determined by `EdgeTraceSet`.
- Removes usage of `pypeit.pixels.tslits2mask` and replaces it with
  `pypeit.slittrace.SlitTraceSet.slit_img`.
- Significant changes to flat-fielding control flow.
    - Added `rej_sticky`, `slit_trim`, `slit_pad`, `illum_iter`,
      `illum_rej`, `twod_fit_npoly` parameters to FlatFieldPar.
    - Illumination flat no longer removed if the user doesn't want to
      apply it to the data.  The flat was always created, but all that
      work was lost if the illumination correction wasn't requested.
    - Replaced tweak edges method with a more direct algorithm.
    - `pypeit.core.flat.fit_flat` moved to
      `pypeit.flatfield.FlatField.fit`.
- Reoriented trace images in the `EdgeTraceSet` QA plots.  Added the
  sobel image to the ginga display.
- Added `bspline_profile_qa` for generic QA of a bspline fit.
- Eliminate MasterFrame class
- Masks handled by a DataContainer
- Move DetectorPar into a DataContainer (named DetectorContainer) which
  enables frame-level construction
- Advances to DataContainer (array type checking; nested DataContainers;
  to_master_file)
- Dynamic docs for calibration images
- Every calibration output to disk is help within a DataContainer,
  separate from previous classes.  Exception is WaveCalib (this needsd a
  fit DataContainer first)
- Substantial refactoring of Calibrations
- Add MDM OSMOS spectrograph
- Moved pypeit.core.pydl.bspline into its own module, `pypeit.bspline`
- Introduced C backend functions to speed up bspline fitting
    - now require `extension_helpers` package to build pypeit and
      necessary files/code in `setup.py` to build the C code
    - C functions will be used by default, but code will revert to pure
      python, if there's some problem importing the C module
    - Added tests and pre-cooked data to ensure identical behavior
      between the pure python and C functions.
- Moved some basis function builders to pypeit.core.basis
- Release 1.0 doc
- Lots of new docs
- pypeit_chk_2dslits script
- DataContainer's for specobj, bspline
- Introduction of Spec2DObj, AllSpec2DObj, and OneSpec (for Coadd1D)
- Added bitmask to SlitTraceSet
- Introduced SlitTraceSet.spat_id and its usage throughout the code
- Spatial flexure corrections
    - Significant refactor of flatfield.BuildFlatField.fit()
    - Spatial flexure measuring code
    - PypeItPar control
    - Modifications to SlitTraceSet methods
    - Illumflat generated dynamically with different PypeIt control
    - waveimage generated dynamicall and WaveImage deprecated
- Moved RawImage into ProcessRawImage and renamed the latter to the
  former
- Continued refactoring of Calibrations
- Initial code for syncing SpecObjs across exposures
- Option to ignore profile masking during extraction
- Additional code in DataContainer related to MasterFrames
- Eliminated WaveImage
- Updates to QL scripts
- Lots of new tests



0.13.2 (17 Mar 2020)
--------------------

- Added PypeIt identify GUI script for manual wavelength calibration
- Add bitmask tests and print bitmask names that are invalid when
  exception raised.
- Parameter set keywords now sorted when exported to an rst table.
- Enable user to scale flux of coadded 1D spectrum to a filter magnitude
- Hold RA/DEC as float (decimal degrees) in PypeIt and knock-on effects
- Add more cards to spec1d header output
- Fixes a few sensfunc bugs
- Added template for LRIS 600/7500
- Deal with non-extracted Standard
- docs docs and more docs
- A QA fix too

0.13.1 (07 Mar 2020)
--------------------

- Missed a required merge with master before tagging 0.13.0.

0.13.0 (07 Mar 2020)
--------------------

- Refactored sensitivity function, fluxing, and coadding scripts and
  algorithms.
- Added support for additional near-IR spectrographs.
- Restrict extrapolation in tilt fitting
- Implemented interactive sky region selection

0.12.3 (13 Feb 2020)
--------------------

- Implemented DataContainer
- Added fits I/O methods
- Implemented SlitTraceSet
- Setup of `pypeit.par.pypeitpar` parameter sets should now fault if the
  key is not valid for the given parameter set.  NOTE: The check may
  fail if there are identical keys for different parameter sets.
- Modification to add_sobj() for numpy 18

0.12.2 (14 Jan 2020)
--------------------

- Introduces quick look scripts for MOS and NIRES
- Bumps dependencies including Python 3.7
- Modest refactoring of reduce/extraction/skysub codes
- Refactor of ScienceImage Par into pieces
- Finally dealt with 'random' windowing of Shane_kast_red
- Dynamic namp setting for LRISr when instantiating Spectrograph

0.12.1 (07 Jan 2020)
--------------------

- Hotfixes: np.histogram error in core/coadd1d.py, np.linspace using
  float number of steps in core/wave.py, and sets numpy version to 1.16

0.12.0 (23 Dec 2019)
--------------------

- Implemented MOSFIRE and further implemented NIRSPEC for Y-band
  spectroscopy.
- Fixed bug in coadd2d.
- Add VLT/FORS filters to our database
- Improved DEIMOS frame typing
- Brings Gemini/GMOS into the suite (R400)
- Also an important change for autoid.full_template()
- Fixed trace extrapolation, to fix bugs in object finding. Tweaks to
  object finding algorithm.
- Major improvements to echelle object finding.
- Improved outlier rejection and coefficient fitting in pca_trace
- Major improvements to coadd routines in coadd1d
- Introduced telluric module and telluric correction routines
- Implemented tilt image type which is now a required frame type
- Streamlined and abstracted echelle properties and echelle routine in
  spectrograph classes.
- Revamped 2-d coadding routines and introduced 2-d coadding of
  MultiSlit data
- Improved ginga plotting routines.
- Fixed bug associated with astropy.stats.sigma_clipped_stats when
  astropy.stats.mad_std is used.
- Refactor BPM generation
- Merge raw_image loading with datasec_img and oscansec_img generation
- Sync datasec_img to image in ProcessRawImage
- Started (barely) on a path to having calibration images in counts and
  not ADU
- Refactors GMOS for get_rawimage method
- Enables GMOS overscan subtraction
- Adds R400 wavelength solution for old E2V chip
- Revises simple_calib() method for quick and dirty wavelength
  calibration
- Adds a related show_wvcalib script
- Changes to ech_combspec to better treat filenames
- Fixed bug when bias was set to 'force' which was not bias subtracting
- Implemented changes to vlt_xshooter_nir to now require darks taken
  between flats
- Made flat fielding code a bit more robust against hot pixels at edge
  of orders
- Added pypeit_chk_flat script to view flat images
- Refactored image objects into RawImage, ProcessRawImage, PypeItImage,
  BuildImage
- Moved load() and save() methods from MasterFrame to the individual
  calibration objects
- Converted ArcImage and FlatImages into counts
- Added code to allow for IVAR and RN2 image generation for calibs
- Added several from_master_file() instantiation methods
- Use coadd2d.weighted_combine() to stack calibration images
- Major refactor of slit edge tracing
- Added 'Identify' tool to allow manual identification and calibration
  of an arc spectrum
- Added support for WHT/ISIS
- Added 'Object Tracing' tool to allow interactive object tracing
- Added code of conduct
- Deprecated previous tracing code: `pypeit.traceslits` and
  `pypeit.core.trace_slits`, as well as some functions in
  `pypeit.core.extract` that were replaced by
  `pypeit.core.moment.moment1d` and functions in `pypeit.core.trace`.
- PCA now saved to MasterEdges file; added I/O methods
- Improved CuAr linelists and archives for Gemini wavelength solutions
- New data model for specobj and specobsj objects (spec1d)
- Started some improvements to Coadd2D, TBC
- Allow for the continuum of the arc image to be modeled and subtracted
  when tracing the line-centroid tilts
- Include a mask in the line detection in extracted central arc spectrum
  of each slit/order.  For VLT XShooter NIR, this was needed to ensure
  the sigma calculation didn't include the off-order spectral positions.
- Added a staticmethed to :class:`pypeit.edgetrace.EdgeTraceSet` that
  constructs a ``tslits_dict`` object directly from the Master file.

0.11.0.1
---------

- Add DOI

0.11.0 (22 Jun 2019)
--------------------

- Add magellan_mage, including a new ThAr linelist and an archived
  solution
- Polish several key echelle methods
- Modify create_linelist to default to vacuum
- Update Xshooter, NIRES, and GNIRS
- Refactor ProcessImages into ProcessRawImage, PypeItImage,
  CalibrationImage, ScienceImage, and ImageMask
- Refactor ScienceImage into SciImgStack
- Fix arc tilts bug
- Started an X-Shooter doc and introduced a [process][bias] parameter
- Modified processing steps for bias + overscan subtraction
- Started notes on how to generate a new spectrograph in PypeIt
- Refactoring of reduce to take a ScienceImage object for the images and
  the mask
- Updates to many spectrograph files to put datasec, oscansec in the raw
  frame
- Add find_trim_edge and std_prof_nsigma parameters
- A bit of tuning for MagE
- Fixes for Echelle in fluxspec
- Writes a chosen set of header cards to the spec1D and coadd files
- Updates for FORS2
- Introduced new coadd1d module and some new coadd functinality.
- modified interface to robust_polyfit_djs, robust_optimize, and
  djs_reject.
- Added utility routine cap_ivar for capping the noise level.
- Fixed a bug in optimal extraction which was causing hot pixels when a
  large fraction of the pixels on the object profile were masked.
- Major bug fixes and improvements to echelle object finding. Orders
  which did not cover the entire detector were not being treated
  properly.

0.10.1 (22 May 2019)
--------------------

- Minor bug fix to allow for `None` exposure times when typing frames.

0.10.0 (21 May 2019)
--------------------

- Enable PyPI
- Streamline some of the instantiation at the beginning of
  PypeIt.__init__.
    - Moves the call to default_pypeit_par into config_specific_par.
    - Adds a finalize_usr_build() function to PypeItMetaData to
      consolidate the few opaque steps when finishing the meta data
      build.
- Hack for Kastr
- Turn on Shane Kastb grism wavelength solutions (not tested)
- Started splitting Arc Line Templates Notebook into pieces
- Allows for slice like syntax when defining calibration groups.
- Introduce 'tilt' frame type.  Not used yet.  Everything that's typed
  as an 'arc' is now also typed as a 'tilt'.
- Use matplotlib 'agg' backend to the top-level `__init__.py` to allow
  for running the code under a screen; may need a better approach.
- Numerous doc and style fixes
- Add `master_type` to `MasterFrame` (and derived classes), which is
  used to set the name of the master frame output file.
- Significant edits to `MasterFrame` to streamline IO for derived
  classes.  Lead to significant changes to `Calibrations`.
- Main paths now set in `PypeIt`.
- Allow `connect_to_ginga` to start up the ginga viewer.
- Add a pytest `skipif` that checks if the Cooked directory exists in
  the dev-suite.  Use this to run the tests that only need the raw image
  data or don't need the dev-suite at all.
- Move wavelength calibration save/load out of `pypeit.wavecalib` into
  `pypeit.core.wavecal.waveio.py`
- Rename default directory for calibration masters to `Masters` and
  removed inclusion of spectrograph name.
- Fix oscan sec in read_lris()
- Fix bad return in tracewave.tilts_find_lines()
- Several doc edits
- Fix handling of maskslits
- Fix flexure crashing
- Change `pypeit.spectrographs.spectrograph.get_image_section` to
  *always* return the sections ordered spectral then spatial to match
  the PypeIt convention to match how binning is returned.  Propagated to
  get_datasec_img.
- Changed all functions related to binning to ensure that binning is
  always ordered spectral vs. spatial with the PypeIt convention that
  images have shape (nspec,nspat).  Includes associated documentation.
- Allow `pypeit.bitmask.BitMask` and `pypeit.par.parset.ParSet` to save
  and load from fits file headers.
- Force BitMask definitions in framematch.py and processimages.py to use
  and OrderedDict.  They need to be an OrderedDicts for now to ensure
  that the bits assigned to each key is always the same. As of python
  3.7, normal dict types are guaranteed to preserve insertion order as
  part of its data model. When/if we require python 3.7, we can remove
  this (and other) OrderedDict usage in favor of just a normal dict.
- Changed default for add and rm slits parameters.
- Doc improvements and removal of old, commented methods.
- Edited function that replaces bad columns in images and added tests.
- Added `pypeit.io` with routines to:
    - manipulate `numpy.recarray` objects and converting them into
      `astropy.fits.BinTableHDU` objects.
    - gzip compress a file
    - general parser to pull lists of items from fits headers
- Added metadata to `MasterFrame` objects written to fits files.
- Added `'observed'` option for wavelength reference frame that skips
  any relative motion corrections.

0.9.3 (28 Feb 2019)
-------------------
- Fixed a bug that was introduced when the binning was switched to the
  PypeIt convention.
- Fixed a bug whereby 2d images were not being saved if no objects were
  detected.
- Revamped the naming convention of output files to have the original
  filename in it.

0.9.2 (25 Feb 2019)
-------------------

- Many doc string updates in top level routines (not core)
- Updates to install and cookbook docs
- Continued the process of requiring spectrograph and par in each base
  class
- More doc + cleaning at top level, e.g. base classes
- Eliminates BPM base class
- Hot fix for flatfield;  illumflat was getting divided into the
  pixelflatnrm image
- Implementation of 2d coadds including a script to perform them.
- Fixed bug in extract.fit_profile that was introduced when implementing
  2d coadds
- Polynomial order for object finding is now part of parset.
- Improved X-shooter object tracing by increasing order.
- Improved determination of threshold determination regions for object
  finding.
- Added S/N floor to ivar determination for image procing.
- Reworked master output for traceslits
- Fixed a bug associated with binned images being proc'd incorrectly.
- Fixed master_key outputs in headers to deal with different detectors.
- Modify -c in pypeit_setup to require a setup (or all) be specified
  when writing, e.g. 'all' or 'A,C'
- Generated a new spectrograph child for LRISr in long-slit read-out
  mode (only 2 amps, 1 per detector)
- Require astropy >=3.1  [required for coadding at the least]
- Fixed a circular import which required move qa from wavecal into
  autoid.
- Fixed a bug in LRIS-R that spectrograph which was not using binning
  for wavelength fwhm.
- Updated docs on add/rm slits.
- Fixed and tuned up fluxing script and fluxing routines.
- Introduce sky_sigrej parameter
- Better handling of ManualExtraction
- Add template for LRISr 600/5000 wavelengths
- PYDL LICENSE and licenses folder
- Updates for new Cooked (v1.0)

0.9.1 (4 Feb 2019)
------------------

- Move write method for sensitivity function
- Modify I/O for detnum parameter
- Modify idx code in SpecObj
- Fixed a bug on datatype formatting
- Reworked masteframe and all base classes to be more homogenous so that
  one only ever overloads the save_master and load_master methods.
- Many changes fixes wavecal/autoid.py to make the lines being used
  explicitly clear. This fixed many bugs in the the wavelength fitting
  that were recently introduced.
- Introduced reidentification algorithm for wavelengths and many
  associated algorithms. Reidentification is now the default for
  x-shooter and NIRES. Other changes to the wavelength interface and
  routines to make them more compatible with echelle.
- Tweaked LA cosmics defaults. Add instrument specific parameters in
  spectrograh classes along with routines that check binning and decide
  on best params for LRIS-RED
- Now updating cosmic ray masking after each global sky subtraction
- Major developments for echelle functionality, including object
  wavelengths, and reduction control flow.
- Introduced wavemodel.py to simulate/extract/ID sky and ThAr spectral
  emission lines.
- Significant refactor of tracing slit/edge orders and new docs+tests
- Changed back BPM image to be aligned with datasec *not* the raw image
  shape (without trimming)
- Renabled ability to add user supplied slits
- Miscellaneious echelle-related advances
- PNGs of X-Shooter fits
- Sped up trace plotting in ginga
- Fussed again with how time is handled in PypeIt.  Hopefully the last
  time..
- dispaxis renamed specaxis and dispflip to specflip
- Lots of VLT/X-Shooter development
- Removed a number of files that had been mistakingly added into the
  repo
- Now running on cooked v=0.92
- Allow for multiple paths to be defined in the pypeit file
- Changed the procedure used to identify instrument configurations and
  identify which frames to use when calibrating science exposures.
- Added configurations, calibration groups, and background index to
- Total revamp of Tilts. Arc line tracing significantly improved.
- Fixes to trace_crude_init, trace_fweight, and trace_gweight.
- Many other small bug fixes and modifications particularly in the
  fitting routines.
- Lots of development related to echelle functionality.
- Major enhancements to fitting routines (in utils)
- Make GMOS south works and update OH line lists, and also add LBT/MODS.
- Introduce calib groups
- Removes setup designation.  Largely replaced with master_key
- Refactor Calibrations class to handle new calib groups
- Refactor QA to handle new calib groups
- Refactor tests to handle new calib groups
- Pushed pieces of run_pypeit into the PypeIt class
- Removed future as a dependency
- Change point step size to 50 pixels in show_slits and show_trace for
  major speed up
- Implemented difference imaging for near-IR reductions for both
  Multislit and Echelle
- Fixed a bug in echelle object finding algorithm.
- Fixed bug in object finding associated with defining the background
  level for bright telluric standards and short slits.
- Implemented using standard stars as crutches for object tracing.
- Reworked the implementation of reuse_masters in the PypeIt class and
  in the Calibrations class.
- New behavior associated with the -o overwrite feature in run_pypeit.
  User prompting feature has been disabled. Existing science files will
  not be re-created unless the -o option is set.
- Fixed a bug where local sky subtraction was crashing when all the
  pixels get masked.
- Nearly resurrected simple_calib
- New method to build the fitstbl of meta data
- Refactor handling of meta data including a data model defining core
  and additional meta data
- Replaces metadata_keys with pypeit_file_keys for output to PypeIt file
- Updates new metadata approach for VLT, Keck, Lick, Gemini instruments
- Remove PypeItSetup call from within PypeIt
- Remove lacosmic specific method in Spectrograph;  replaced with
  config_specific_par
- setup block now required when running on a PypeIt file
- Introduced a new method of determining breakpoint locations for local
  sky subtraction which takes the sampling set by the wavelength tilts
  into account.
- Fixed a major bug in the near-IR difference imaging for the case of
  A-B, i.e. just two images.
- Introduced routines into core.procimg that will be used in 2-d
  co-adding.
- Tweaks to VLT X-SHOOTER spectrograph class to improve reductions.
- Moved methods for imaging processing from scienceimage class to
  processimages class.
- Introduce full_template() method for multi-slit wavelength
  calibrations; includes nsnippet parameter
- Generate full template files for LRIS, DEIMOS, Kastb
- Added a few new Arc lines for DEIMOS in the blue
- Introduce mask_frac_thresh and smash_range parameters for slit
  tracing; modified LRISb 300 defaults
- Updated slit tracing docs
- Introduced --show command in pypeit_chk_edges
- Added echelle specific local_skysub_extract driver.
- Refactored PypeIt and ScienceImage classes and introduced Reduce
  class. ScienceImage now only does proc-ing whereas reduction
  operations are done by Reduce. Reduce is now subclassed in an
  instrument specific way using instantiate_me instead of PypeIt. This
  was necessary to enable using the same reduction functionality for 2d
  coadds.
- Added and improved routines for upcoming coadd2d functionality.
- Fixed bug in weight determination for 1d spectral coadds.
- Major fixes and improvements to Telluric corrections and fluxing
  routines.
- Fluxing now implemented via a script.
- Turned flexure back on for several instruments
- Introduced VLT/FORS2 spectrograph
- Swapped binspec and binspat in parse binning methods
- Extended LRISr 1200_900 arc template
- Modified add/rm slit methods to be spec,spat
- Add an option in coadding to scale the coadded spectrum to a given
  magnitude in a given filter
- Extended DEIMOS 1200G template

0.9.0
-----

- Major refactor to rename most modules and incorporate the PYPIT ->
  PypeIt switch
- Add SlitMask, OpticalModel, and DetectorMap classes.  Implemented
  DEIMOSOpticalModel based on DEEP2 IDL code.
- Improved treatment of large offsets in
  pypeit.core.trace_slits.trace_gweight to be symmetric with
  trace_fweight. Large outlying pixels were breaking object tracing.
- Added thresholding in pypeit.core.tracewave to ensure that tilts are
  never crazy values due to extrapolation of fits which can break sky
  subtraction.
- Turn off 2.7 Travis testing
- Integrated arclines into PypeIt
- Added KDTree algorithm to the wavelength calibration routines
- Modified debug/developer modes
- Update SpecObjs class; ndarray instead of list;  set() method
- Completely revamped object finding, global sky subtraction and local
  sky subtraction with new algorithms.
- Added -s option to run_pypeit for interactive outputs.
- Improved pypeit_show_spec2d script.
- Fixed bug whereby -m --use_master was not being used by run_pypeit
  script.
- Overhaul of general algorithm for wavelength calibration
- Hot fix for bspline + requirements update
- Fixed issue with biases being written to disk as untrimmed.
- Completely reworked flat fielding algorithm.
- Fixed some parsing issues with the .pypeit file for cases where there
  is a whitepsace in the path.
- Implemented interactive plots with the -s option which allow the
  reduction to continue running.
- Modified global sky subtraction significantly to now do a polynomial
  fit. This greatly improves results for large slits.
- Updated loading of spectra and pypeit_show_1dspec script to work with
  new output data model.
- Implemeneted a new peak finding algorithm for arc lines which
  significantly improved wavelength fits.
- Added filtering of saturated arc lines which fixed issues with
  wavelength fits.
- Added algorithms and data files for telluric correction of near-IR
  spectra.
- Revamped flat field roiutine to tweak slit boundaries based on slit
  illumination profile. Reworked calibrations class to accomodate the
  updated slit boundaries and tilts images as well as update the master
  files.
- Include BitMask class from MaNGA DAP.
- Change the way frame types are include in PypeItSetup.fitstbl
- Edited KeckLRISSpectrograph header keywords
- Edited how headers are read from the provided files
- Created metadata.PypeItMetaData class to handle what was previously
  `fitstbl`
- Fussed with date/time driven by GMOS;  date is no longer required in
  `fitstbl`
- Initial work on GMOS;  this is still work-in-progress
- Pushed several arcparam items into the Wavelengths parset
- Series of hacks for when binning is missing from the fitstbl
- CuAr line lists for GMOS
- New option to reduce only 1 det at a time
- Data provided in pypeit file overwrites anything read from the fits
  file headers.
- Filled in fits table reading data for GNIRS
- Demand frametype column in fits table is U8 format
- Further improvements to detect_lines arcline detection algorithm.
- Got rid of arcparam and added info and docs to wavelengths parset.
- Improved and commented autoid.py arclines code.
- Added utilities to wavecalib to compute shift,stretch of two spectra.
- Completely revamped cross-correlation algorithm in wavecalib to give
  roburt results.

0.8.1
-----
- Figuring out how to tag releases

0.8.0
-----

- First major steps on ARMED echelle data reduction pipeline
- APF/Levy and Keck/HIRES implemented
- Updates to blaze function and slit profile fitting
- Initial support for multislit reduction
- Coadding; including docs; and tests
- Now requiring astropy >= v1.3
- raw_input handling for Python 3
- coadd handling of bad input
- coadd bug fix on obj name
- Init local (i.e. object dependent) parameters in coadding
- fix local background logic error in slit masking
- Refactor QA PDF to PNG+HTML
- Add nminima object finding
- Add new parameters for object finding, reduce specific detectors
- Add slit profile QA
- Begin writing header (e.g. RA/DEC) info to spec1d files
- Fix bug in applying BPM for finding slit edges
- Update Ginga hooks
- Enable archiving/loading sensitivity function
- Add new cosmic ray algorithms for coadding (especially pairs of
  spectra)
- Added support for TNG+Dolores long slit spectrograph
- Started removing cython code
- Update line detection algorithm
- Updated flexure and tilt tracing documentation
- Updated docs:added standards.rst, and make a small correction in using
  script pypit_setup in setup.rst
- Fixed travis
- Updated slit trace algorithm
- Improved arc line detection algorithm
- Added functionality for fully automated wavelength calibration with
  arclines
- Switched settings files to allow IRAF style data sections to be
  defined
- Allowed data sections to be extracted from header information
- Significant refactor of routines related to pypit_setup
- Various small improvements, primarly to handle Gemini/GMOS data [not
  yet fully supported in PYPIT]
- Removed majority of cython functionality
- Moved logging to be a package object using the main __init__.py file
- Begin to adhere to PEP8 (mostly)
- setup.py rewritten.  Modeled after
  https://github.com/sdss/marvin/blob/master/setup.py .  Added
  requirements.txt with the package versions required.
- Updates archeck
- Loads NIST arclines from arclines instead of PYPIT
- DEIMOS reduction!
- Bug fix for bspline with bkspace
- Enable loading a sensitivity function with YAML
- Allow for multiple detectors when using `reduce detnum`
- Moved all imports to the start of every file to catch and avoid
  circular imports, removed most `import ... as ...` constructs
- dummy_* removed from arutils as necessary and propagated changes to
  tests
- remove dependency of ararclines functions on slf
- change requirements for astropy to >=1.3.0 so that `overwrite` is
  valid
- include numba in requirements, but actually a requirement of arclines
- Improve cookbook and setup docs
- Faster algorithm for defining object and background regions
- Restore armsgs -d functionality
- Finished cython to python conversions, but more testing needed
- Introduce maskslits array
- Enable multi-slit reduction
- Bug fixes in trace_slits
- Fixes what appears to be a gross error in slit bg_subtraction
  (masking)
- Turns off PCA tilt QA for now [very slow for each slit]
- Several improvements for coadding
- Modify lacosmic to identify tiny CR's
- Enabled writing Arc_fit QA for each slit/order
- Refactored comb_frames
- Refactored load_frames
- Refactored save_master
- Refactored get_datasec_trimmed, get_datasec, pix_to_amp
- Refactored slit_pixels
- Refactored sub_overscan
- Refactored trace_slits (currently named driver_trace_slits) and many
  of its dependencies
- Added parameter trace_slits_medrep for optional smoothing of the trace
  slits image
- Updated a few settings for DEIMOS and LRIS related to tracing slits
- Added a replace_columns() method to arproc.py
- Fixed a bug in new_match_edges()
- Moved tracing docs -> slit_tracing and edited extensively
- Updated docs on DEIMOS, LRIS
- Added the pypit_chk_edges script
- Added BPM for DEIMOS
- Added the code for users to add slits [edgearr_from_users()] but have
  not documented nor made it accessible from the PYPIT file
- Generated tcrude_edgearr() method for using trace crude on the slit
  edges
- Added trace_crude() method that I ported previously for DESI
- Added multi_sync() method for ARMLSD slit synchronization
- Have somewhat deprecated the maxgap method
- Refactored the gen_pixloc() method
- Generate arpixels.py module for holding pixel level algorithms
- Move all methods related to TraceSlits to artraceslits.py
- Introduce the TraceSlits class
- Update armlsd accordingly
- Remove driver_trace_slits and refctor_trace_slits methods
- Making Ginga a true dependency of PYPIT
- Have TraceSlits write/load MasterFrames
- Introduce SetupClass object
- Replace armbase.setup_science() with SetupClass.run()
- Move setup acitivites to inside pypit.py
- doc updates in setup.rst
- Refactor fitsdict -> fitstbl  (variable name not updated everywhere)
- Removed slurped headers from fitsdict (and therefore fitstbl)
- Include SetupClass Notebook
- Move ftype_list from armeta.py to arsort.py
- Bug fix related to fluxing
- Substantial refactor of arsort.py
- Substantial refactor of arsetup.py
- Introduced base-level ProcessImages class
- Introduced abstract MasterFrame class
- Introduced BiasFrame, BPMImage, ArcImage, and TraceImage classes
- Started NormPixelFlat class but have not yet implemented it
- Substantial refactoring of armasters
- Moved arlris, ardeimos to core/
- Moved image processing methods to arprocimg in core/
- Introduced calib_dict to hold calibration frames in armlsd (instead of
  slf)
- Modified ardeimos to load only a single image (if desired)
- Turned off fluxing in this branch;  is 'fixed' in the one that follows
- Moved get_slitid() to artraceslits
- Deprecates ['trace']['combine']['match'] > 0.0 option
- Deprecates ['arc']['combine']['match'] > 0.0 option
- Refactoring of settings and slf out of core methods continues
- Removed _msbias, _msarc, _datasec, _bpix from slf
- New tests and Notebooks
- Introduced FluxSpec class
- Introduce pypit_flux_spec script (and docs)
- Added FluxSpec Notebook
- armlsd has reappeared (momentarily) but is not being used;  it goes
  away again in a future branch
- Added a dict (std_dict) in arms.py to hold standard star extractions
- Reducing standard stars in the main arms loop
- Modified save_1d_spectra to handle loaded SpecObj in addition to
  internally generated ones
- Moved arflux to core and stripped out slf, settings
- Really restricting to nobj when user requests it
- New tests
- Introduces WaveCalib class
- Push ararc.py to core/ after removing slf and settings dependencies
- Further refactor masters including MasterFrame; includes addressing
  previous comment from RC
- Removed armlsd.py again
- Strips wv_calib from ScienceExposure
- Push get_censpec() to ararc.py
- New tests; limited docs
- TraceSlits load method pushed outside the class
- Introduces WaveTilts class
- Significant modification to tilt recipe including deprecation of PCA
- Moved tilt tracing algorithms from artrace.py to artracewave.py in
  core/
- Added 2D Legendre fitting to polyfit2d_general
- New trace slits tilts  settings (for 2D fitting)
- New QA plot
- New pypit_chk_tilts script
- New docs
- New tests
- Introduces FlatField class
- Adds FlatField Notebook, tests
- Pushes flat field algorithms into core/arflat.py
- Main flatfield method broken into a few pieces
- Further refactoring of armasters
- Further refactoring related to settings and ScienceExposure
- WaveImage class
- Strip mswave from ScienceExposure
- New tests
- Push get_calib methods into the individual classes
- Significant refactoring in arms.py followed
- Rename slits_dict -> tslits_dict
- Use tslits_dict in wavetilts.py
- Introduce ScienceImage class
- Substantial refactoring in arms.py followed
- Notebook too
- Reversed exposure/det loops for the (last?) time
- Generated arskysub.py in core/
- Significant portions of arproc.py are now superfluous
- Moved flexure_qa to arwave.py
- Significant refactoring of arsave.py (also moved to core/)
- Removed settings and slf from arspecobj.py
- Refactored trace_objects_in_slit()
- Refactoring of flexure algorithms
- Adds build_crmask() and flat_field() methods to ProcessImages
- Completed the deprecation of arsciexp (RIP)
- Many test updates
- Doc strings improved but no new main docs
- Completed armasters refactor and moved to core/
- Adds bspline_profile() method;  Used here for skysub but will also
  show up in extraction
- Introduces new skysub method;  still a bspline but now the new one
- Adds several methods from the PYDL repository into a pydl.py module
  including bspline Class
- Adds method to generate ximg and edgemask frames
- Adds new trace_slits_trim settings
- Small install edits
- Fixes Travis failure that crept into the previous PR
- Fix bug in bspline
- Adds a demo Notebook for LRISr redux
- Other odds and ends including code flow doc
- Introduce pypit/par and pypit/config directories
- Introduce PypitPar as an initial step toward refactoring the front end
- Final nail in the coffin for cython
- Add API docs
- Add bumpversion
- Adds a demo Notebook for LRISr redux
- Other odds and ends including code flow doc
- Introduce pypit/par and pypit/config directories
- Introduce PypitPar as an initial step toward refactoring the front end
- Move spectrograph specific code into spectographs/ folder
- Introduces the Spectrographs class
- Introduces the Calibrations class with Notebook
- Bug fix in view_fits script
- Handle no-slits-found condition
- Added NIRES to spectrographs folder
- Fixed logic in ArcImage class related to settings and user settings
- Added user settings to some of the other classes.
- Enabled load_raw_frame to take a negative dispersion axis indicating
  flips.
- Major bug fixed in bspline_profile where it was producing gargabe
  results when breakpoints were being rejected.
- Edits to Spectrograph class
- Removed all use of settings in ARMS and its subsequent calls.  ARMS
  now uses PypitPar and its sub parameter sets
- propagated ParSet changes into run_pypit and pypit_setup
- settings/parameters for pypit now set in the pypit file using a
  configuration parameter set
- rewrote pypit file parser
- Included automatically generated documentation of PypitPar when
  running make html in doc/ directory
- Checked orientation of array correct for DATASEC and OSCANSEC in
  DetectorPar for each Spectrograph
- Add SpecObjs class
- Add from_dict and to_dict methods to pydl bspline and update docs
- Updated from_dict method in pydl bspline

0.7 (2017-02-07)
----------------

This file enters the scene.
.. _coadd1d:

================
Coadd 1D Spectra
================

Overview
========

This document will describe how to combine the 1D spectra
from multiple exposures of the same object.

PypeIt currently only offers the coadding of spectra in
1D and must be done outside of the data reduction pipeline,
i.e. PypeIt will *not* coadd your spectra as
part of the data reduction process.

The current defaults use the Optimal extraction
and fluxed data.

See below for the `Current Coadd1D Data Model`_.

pypeit_coadd_1dspec
===================

The primary script is called `pypeit_coadd_1dspec`_ which takes
an input file to guide the process.

coadd1d file
------------

The format of that file
is described in the *usage* of the script, i.e. type
*pypeit_coadd_1dspec -h*.  Here is an example from the Dev Suite
for the *shane_kast_blue* instrument::

    # User-defined coadding parameters
    [coadd1d]
       coaddfile = 'J1217p3905_coadd.fits'

    # Read in the data
    coadd1d read
      Science/spec1d_b27-J1217p3905_KASTb_2015May20T045733.560.fits SPAT0176-SLIT0000-DET01
      Science/spec1d_b28-J1217p3905_KASTb_2015May20T051801.470.fits SPAT0175-SLIT0000-DET01
    coadd1d end

The opening block sets parameters for the process, including
the output file name.  See `Parameters`_ for common choices.

**Note:** if you are using an Echelle :doc:`spectrographs`
(e.g. keck_nires), you must specify a *sensfuncfile*
generated by :doc:`fluxing` a standard star.

The data block provides a list of :doc:`out_spec1D` files
and the object name in each to be coadded.
See :doc:`out_spec1D` for a discussion of the naming.

For instruments with multiple detectors along the spectral dimension
(e.g. keck_deimos), give a separate entry for each extraction to generate
a final, spliced spectrum.


The list of object identifiers in a given spec1d file can be
output with the *pypeit_show_1dspec* script, e.g.::

    pypeit_show_1dspec spec1d-filename.fits --list

These can also be recovered from the object info files
in the Science/folder (one per exposure).


run
---

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_coadd_1dspec.rst

An example execution looks like this::

    pypeit_coadd_1dspec FRB190714_LRISr_coadd1d_file.txt --show

A substantial set of output are printed to the screen, and
if successful the final spectrum is written to disk.
See below for the `Current Coadd1D Data Model`_.



The parameters that guide the coadd process are also written
to disk for your records. The default location is *coadd1d.par*.
You can choose another location with the `--par_outfile`_
option.

Command Line Options
--------------------

--show
++++++

At the end of the process, this will launch a *matplotlib* window
showing the stacked spectrum on the bottom.  The top panel
illustrates the number of pixels included in the stack.

--par_outfile
+++++++++++++

This input filename will hold a listing of the parameters
used to run the coadd1d process.

Parameters
==========

Fluxing
-------

The default parameters assume your spectra have gone
through :doc:`fluxing`.  If not you should set::

    flux_value = False

If the data were fluxed, then the output *flux* spectrum
will have units of erg/s/cm^2/Ang multiplied by 1e17.


Flux Scale
++++++++++

If your data has been fluxed, you may scale the coadded
spectrum to a chosen value (typically a photometric
measurement) in one of many filter curves.

To do so, you need to add the *filter* and *magnitude*
to the [coadd1d] block of the `coadd1d file`_.

Here is an example::

    [coadd1d]
       coaddfile = 'J121555.09-130116.0_LRISr_A.fits'
       filter = PS1-R
       filter_mag = 20.85
       filter_mask = 7187:7376


The call here will convolve the coadded spectrum with the
PS1 r-band filter,
and then scale the flux to give an AB magnitude of 20.85.
Furthermore, the spectral wavelengths from 7187-7376A
are masked in the analysis.

Filters
+++++++

The list of filters is provided in
`this file <https://github.com/pypeit/PypeIt/blob/master/pypeit/data/filters/filter_list.ascii>`_.

Cosmic Ray Cleaning
-------------------



Scaling
-------

==================   =======================  ==================================================
Parameter            Option                   Description
==================   =======================  ==================================================
scale_method         default: auto            scale the flux arrays based on the root mean
                                              square value (RMS) of the S/N^2 value for all
                                              spectra; if this RMS value is less than the
                                              minimum median scale value, no scaling is applied.
                                              If the RMS value is greater than the minimum but
                                              smaller than the maximum median scale value, the
                                              applied method is the median, as described below
--                   hand                     scale the flux arrays using values specified by
                                              the user in the input parameter 'hand_scale'. Must
                                              have one value per spectrum
--                   median                   scale the flux arrays by the median flux value
                                              of each spectra
==================   =======================  ==================================================

Wave Method
-----------
You may want to specify the method used to construct the wavelength grid for coadding your spectra.  This is done by modifying ``wave_method`` in the [coadd1d] block of your `coadd1d file`_.  The default method is ``linear``, which uses a fixed linear grid in lambda.  However, this may not be ideal depending on your instrument set-up and observations.  Here is an example of some Keck LRISb data.  After coadding the 1D spectra, you may see a noise pattern like this:

.. image:: figures/noise_linear.png

(this figure was obtained by plotting the quantity :math:`\frac{1}{\sqrt{\texttt{ivar}}}` using the ``ivar`` array in the second extension of the `coadd1d file`_), which, while still correct, may not be desirable.  This noise pattern occurs because ``pypeit_coadd_1dspec`` does not interpolate the spectra, in order to guarantee that neighbouring pixels do not have correlated noise.  However, if your wavelength grid is such that multiple values land in one re-binned pixel, this pattern will appear.

To avoid this noise pattern, you can modify the value of ``wave_method``.  For example, if we use the ``iref`` option instead, the above example becomes:

.. image:: figures/noise_iref.png

The ``iref`` option uses the grid of one of the spectra that you are coadding as the wavelength grid.  The reason why this works is because, in general, the wavelength solution of a slit will be non-linear, so the pixel spacing will be different between different ``wave_method`` options.  For a linear grid, the number of exposures contributing to a given pixel in the final grid is varying because of how non-linear grids overlap with the linear grid.  By using the ``iref`` option or a linear grid with wider spacing, this effect can be reduced.  If your data contains exposures that aren't dithered, the ``iref`` option will coadd your exposures on the native wavelength grid, which will avoid the fluctuations in the noise vector. 

If your data contains exposures that are dithered a lot, ``iref`` will probably give you similar noise fluctuations, so using a linear grid with wider spacing may give you a better result.  To change the spacing of the wavelength grid, you can modify ``samp_fact`` in the [coadd1d] block of your `coadd1d file`_.  The default value is 1.0.  Setting ``samp_fact`` > 1.0 over-samples (finer grid), while setting ``samp_fact`` < 1.0 under-samples (coarser grid).


Current Coadd1D Data Model
==========================

Internally, the data are held in
:class:`pypeit.coadd1d.OneSpec`.

The data model is:

.. include:: include/datamodel_onespec.rst

The Coadd1D spectrum may be viewed with the *lt_xspec* script which loads the data
and launches a GUI from the linetools package. e.g.::

    lt_xspec J1217p3905_coadd.fits

.. _instruments:

=============
Spectrographs
=============

Overview
========

Below we describe all of the spectrographs with existing code infrastructure
that enables ``PypeIt`` to reduce the data. Most of these spectrographs are
"supported," meaning that the reduction of the relevant data has been
well-vetted by ``PypeIt`` developers. "Unsupported" spectrographs are
in-development; however, the development timescale is undefined.

For instructions on how to add a new spectrograph see:
:doc:`new_spectrograph`.


.. include:: include/spectrographs_table.rst


.. _spec_details:

Instrument-specific Details
===========================

The following links provide documentation with additional,
instrument-specific details for running ``PypeIt``.

.. toctree::
   :caption: Spectrographs
   :maxdepth: 1

   new_spectrograph
   deimos
   mosfire
   gemini_gmos
   gtc_osiris
   keck_kcwi
   lris
   mage
   ntt_efosc2
   shane_kast
   xshooter
   
============
Calibrations
============

Overview
========

This doc briefly summarizes the main calibrations performed
by PypeIt.  As per standard spectroscopic
reduction, there are a series of calibrations files generated
to correct the detector and perform wavelength calibration.
We consider :doc:`fluxing` to be a separate process.

This page links to docs dedicated to specific aspects
of Calibraions.

Here are main calibration steps (in order
of execution for multislit and echelle calibrations):

* :doc:`bias_dark`
* :doc:`slit_tracing`
* :doc:`flexure`
* :doc:`wave_calib`
* :doc:`flat_fielding`

Products
========

The main products of calibrations are :doc:`masters` which
are placed in the Masters/ folder.  Here are the full set
that may be created (not all are required; depends on the
instrument):

.. toctree::
   :maxdepth: 1

   masters
   master_align
   master_arc
   master_bias
   master_edges
   master_slits
   master_flat
   master_tilt
   master_tilts
   master_wvcalib

Modifications
=============

Here are the global modifications one may make
for calibrations:

* Add/Suppress bias/dark frame generation. See :doc:`bias_dark`
* Add/Suppress flexure correction.  See :doc:`flexure`
* Add/Suppress aspects of flat fielding.  See :doc:`flat_fielding`
.. _extraction:

==========
Extraction
==========

Overview
========

This document describes how PypeIt performs object extraction.
The standard run will perform a boxcar and optimal extraction
of every object discovered with the :doc:`object_finding` algorithm.

Boxcar
======
The boxcar extraction is based on the `boxcar_radius` set in
:ref:`pypeit_par:ExtractionPar Keywords`.


Optimal
=======

The optimal extraction is the standard Horne algorithm.

Customizing
===========

The following are some tips for customizing extractions.

Suppress Masking
----------------

If you are extracting a source with bright emission lines
which differ spatially from the continuum (e.g. a galaxy),
the code may *reject* a set of the related pixels.  These
will, by default, *not* be extracted.

You can, however, turn off the rejection of these pixels
based on their different spatial profile
by setting the use_2dmodel_mask paramter in
:ref:`pypeit_par:ExtractionPar Keywords` to False, e.g. add
the following to your :doc:`pypeit_file`::

    [reduce]
        [[extraction]]
             use_2dmodel_mask = False

This may lead to a few additional CRs entering your
extraction.

And when viewing the 2D spectrum using the
:ref:`out_spec2D:pypeit_show_2dspec` script,
you should use the *--ignore_extract_mask* option.

For very extended, bright emission lines you may need
to use *no_local_sky* to avoid poor local sky subtraction.
See :doc:`skysub` for further details.


Manual
------

If you need to extract an object that is too faint to be
detected with the :doc:`object_finding` algorithm, even
by adjusting its parameters, then you may do a
:doc:`manual`.

Custom FWHM for optimal extraction
----------------------------------

If you want to perform an optimal extraction using a defined FWHM
(i.e., not letting PypeIt to compute it from the flux profile), you can
set the parameter **use_user_fwhm** in :ref:`pypeit_par:ExtractionPar Keywords`
to **True**. In this case, PypeIt will assume for the object a Gaussian profile
with a FWMH equal to **find_fwhm** (see :ref:`pypeit_par:FindObjPar Keywords`).

It may be occasionally necessary to set **no_local_sky = True**
in :ref:`pypeit_par:SkySubPar Keywords` to avoid a bad local sky subtraction.


Additional Reading
==================

Here are additional docs on somewhat common edits that
PypeIt users make:

.. toctree::
   :maxdepth: 1

   manual
   flexure

.. include:: include/links.rst

.. _coadd3d:

================
Coadd 3D Spectra
================

Overview
========

This document will describe how to combine a set of
fully reduced 2D spectra from multiple exposures into
a single 3D datacube (this is only relevant for IFU
spectrographs).

This must be done outside of the data reduction pipeline,
i.e. PypeIt will *not* coadd your spectra as
part of the data reduction process.

pypeit_coadd_datacube
=====================

The primary script is called `pypeit_coadd_datacube`_ which takes
an input file to guide the process.

usage
-----

Here is the current usage for the script::

    usage: pypeit_coadd_datacube [-h] [-o] [--det DET] file

    Parse

    optional arguments:
      -h, --help            show this help message and exit
      -o, --overwrite       Overwrite any existing files/directories (default: False)
      --det DET             Only coadd this detector number
      file                  coadd3d file (see below)


coadd3d file
------------

The format of this file is very similar to a :doc:`pypeit_file`.
In the following example for `keck_kcwi`, the coadd3d file will be
saved as `BB1245p4238.coadd3d`::

    # User-defined execution parameters
    [rdx]
      spectrograph = keck_kcwi
      detnum = 1
    [reduce]
      [[cube]]
        output_filename = BB1245p4238_datacube.fits
        save_whitelight = True

    # Read in the data
    spec2d read
    Science/spec2d_KB.20191219.56886-BB1245p4238_KCWI_2019Dec19T154806.538.fits
    Science/spec2d_KB.20191219.57662-BB1245p4238_KCWI_2019Dec19T160102.755.fits
    spec2d end


The opening block sets parameters for the reduction steps

The spec2d block provides a list of :doc:`out_spec2D` files.

run
---

Then run the script::

    pypeit_coadd_datacube BB1245p4238.coadd3d -o

Flux calibration
================

If you would like to flux calibrate your datacube, you need to
produce your standard star datacube first, and when generating
the datacube of the science frame you must pass in the name of
the standard star cube so that the relative scales of all the
slits are correct. If you want to also flux calibrate, you
will also need to set the flux calibrate argument to True.
You can specify the standard star cube in your coadd3d file
as follows::

    [reduce]
      [[cube]]
        standard_datacube = standard_star_cube.fits
        flux_calibrate = True


Astrometric correction
======================

If you would like to perform an astrometric correction, you
need to install scikit-image (version > 0.17). The default
option is to perform the astrometric correction, is a Master
Alignment frame has been computed. To disable the astrometric
correction, set the following keyword argument in your coadd3d
file::

    [reduce]
      [[cube]]
        astrometric = False


Spatial alignment with different setups
=======================================

If you have multiple setups that you want to align so that all
pixels are spatially coincident, you must first produce the
datacube that you wish to use as a reference. Then, define the
WCS parameters using the keyword arguments in your coadd3d file::

    [reduce]
      [[cube]]
        reference_image = reference_cube_whitelight.fits
        ra_min = 191.398441
        ra_max = 191.401419
        dec_min = 42.634352
        dec_max = 42.639988
        spatial_delta = 0.339462

where these values are printed as terminal output after
reference_cube.fits is generated.

Note that PypeIt is not currently setup to stitch together
cubes covering different wavelength range, but it can coadd
multiple spec2D files into a single datacube if the wavelength
setup overlaps.

Current Coadd3D Data Model
==========================

The output is a single fits file that contains the combined
datacube, and a cube with the same shape that stores the variance.
Here is a short python script that will allow you to read in and
plot a wavelength slice of the cube::

    from matplotlib import pyplot as plt
    from astropy.visualization import ZScaleInterval, ImageNormalize
    import astropy.io.fits as fits
    from astropy.wcs import WCS

    filename = "datacube.fits"
    cube = fits.open(filename)
    hdu_sci = cube['FLUX']
    hdu_var = cube['VARIANCE']
    wcs = WCS(hdu_sci.header)
    wave_slice = 1000
    norm = ImageNormalize(hdu_sci.data[wave_slice,:,:], interval=ZScaleInterval())
    fig = plt.figure()
    fig.add_subplot(111, projection=wcs, slices=('x', 'y', wave_slice))
    plt.imshow(hdu_sci.data[wave_slice,:,:], origin='lower', cmap=plt.cm.viridis, norm=norm)
    plt.xlabel('RA')
    plt.ylabel('Dec')
    plt.show()


****************
Wavelength Tilts
****************

Overview
========

To construct a wavelength image that assigns a wavelength
value to every pixel in the science frame, one must measure
the tilts of the arc lines (or sky lines) across the slits/orders.

This process is organized by the
:class:`pypeit.wavetilts.BuildWaveTilts` class
which is primarily a wrapper to methods in the tracewave.py module.

Here is the code flow:

    1. Extract an arc spectrum down the center of each slit/order

    2. Loop on slits/orders

        i.   Trace the arc lines (fweight is the default)

        ii.  Fit the individual arc lines

        iii.  2D Fit to the offset from pixcen

        iv. Save

See this `WaveTilts <https://github.com/pypeit/pypeit/blob/master/doc/nb/WaveCalib.ipynb>`_
Notebook for some examples.

QA
==

The code will output a residual plot of the 2D fit to offsets.
It should be possible to achieve an RMS < 0.05 pixels.


Settings
========

Threshold
---------

Significance threshold of an arc or sky
line for analysis.  The default is 20.
You may wish to lower this parameter to include more lines, especially if you
are short on lines near the spectral edges of the slit/order, e.g.::

    [calibrations]
       [[tilts]]
            tracethresh = 10.

We tune this parameter for the various instruments.

Spatial Order
-------------

Order of the function (default is Legendre) that is fit to each arc line
across the slit/order (spatial).  Very long slits will likely require order=4 or higher,
e.g.::

    [calibrations]
       [[tilts]]
            spat_order = 4


=========
PypeIt QA
=========

As part of the standard reduction, PypeIt generates a series
of Quality Assurance (QA) files. This documentation describes
the typical outputs, in the typical order that they appear.

The basic arrangement is that individual PNG files are created
and then a set of HTML files are generated to organize
viewing of the PNGs.


HTML
====

When the code completes (or crashes out), a set of
HTML files are generated in the *QA/* folder.  There
is one HTML file per MasterFrame set and one
HTML file per science exposure.  Example names are
*MF_A.html*.

Open in your browser and have at em.
Quick links are provided to allow one to jump between
the various files.


Calibration QA
==============

The first QA PNG files generated are related
to calibration processing.  There is a unique
one generated for each setup and detector and
(possibly) calibration set.

Generally, the title describes the type of QA and the
sub-title indicates the user who ran PypeIt and the
date of the processing.


Wavelength Fit QA
-----------------

See :doc:`master_wvcalib` for a discussion of this QA.


Wavelength Tilts QA
-------------------

There are generally a series of PNG files describing the analysis of the
tilts of the arc lines.

See :doc:`master_tilts` for a discussion of this QA.


Exposure QA
===========

For each processed, science exposure there are a series of
PNGs generated, per detector and (sometimes) per slit.


Flexure QA
----------

If a flexure correction was performed (default), the fit to the
correlation lags per object
is shown and the adopted shift is listed.  Here is
an example:

.. figure:: qa/flex_corr_armlsd.jpg
   :align: center


There is then a plot showing several sky lines
for the analysis of a single object (brightest)
from the data compared against an archived sky spectrum.
These should coincide well in wavelength.
Here is an example:

.. figure:: qa/flex_sky_armlsd.jpg
   :align: center


.. include:: include/links.rst

=============
Spec1D Output 
=============

Overview
========

A primary data product for PypeIt are 1D, calibrated spectra
for extracted sources.  The most fundamental spectrum may be
described by two arrays: flux, wavelength (in vacuum).  These together
with an error array are the minimal output for even the 
Quick reduction mode.  There are, however, several methods
of extraction, calibration, etc. which yield various data
products. Additionally, a `.txt` file with `Extraction Information`_ for
each extracted 1D spectrum is also produced.

.. _spec1d-output-arrays:


Naming
======

File
----

The 1D spectra files have names like::

    spec1d_b27-J1217p3905_KASTb_2015May20T045733.560.fits

The model is::

    Prefix_frame-objname_spectrograph_timestamp.fits


Objects
-------

Each object is named by its:

 - spatial position (pixel number) on the reduced image [SPAT]
 - the slit position (pixel number) on the reduced image [SLIT]
 - the detector number [DET]

For example::

    SPAT0176-SLIT0185-DET01


Extraction
==========

Because there are several modes of extraction in PypeIt, there may
be multiple outputs of the spectral arrays.  These are then prefixed
by the extraction mode.

+-----------------+------------------------------------------------------------+
| Extraction Mode | Description                                                |
+=================+============================================================+
| BOXCAR          | Top-hat extraction around the trace.  The precise window   |
|                 | used is defined by the BOXCAR_APERTURE, in pixels.         |
+-----------------+------------------------------------------------------------+
| OPTIMAL         | Standard Horne algorithm for extraction using the fitted   |
|                 | spatial profile.  An estimate of this profile is given by  |
|                 | OBJ_FWHM                                                   |
+-----------------+------------------------------------------------------------+

Therefore, the integrated counts for a boxcar extraction are given by the
BOXCAR_COUNTS array with variance BOXCAR_VAR.

.. _pypeit_show_1dspec:

pypeit_show_1dspec
==================

The spectra may be viewed with the `pypeit_show_1dspec`_ script
which loads the data and launches a GUI from the *linetools* package.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_show_1dspec.rst

Here is a typical call::

    pypeit_show_1dspec Science/spec1d_b27-J1217p3905_KASTb_2015May20T045733.560.fits --exten 1

This should launch an `XSpecGUI <https://linetools.readthedocs.io/en/latest/xspecgui.html>`_
on your screen from the *linetools* package.

Options
-------

Here are the typical options you will use:

--list
++++++

This prints a list to the screen of all the objects extracted.  An example::

    EXT0000001 = SPAT0351-SLIT0000-DET01
    EXT0000002 = SPAT0392-SLIT0001-DET01
    EXT0000003 = SPAT0463-SLIT0003-DET01
    EXT0000004 = SPAT0556-SLIT0004-DET01
    EXT0000005 = SPAT0621-SLIT0005-DET01
    EXT0000006 = SPAT0731-SLIT0006-DET01
    EXT0000007 = SPAT0824-SLIT0007-DET01
    EXT0000008 = SPAT0865-SLIT0007-DET01
    EXT0000009 = SPAT0910-SLIT0008-DET01
    EXT0000010 = SPAT0962-SLIT0009-DET01
    EXT0000011 = SPAT0073-SLIT0000-DET02
    EXT0000012 = SPAT0093-SLIT0000-DET02
    EXT0000013 = SPAT0130-SLIT0001-DET02

This indicates the extension of the object with this :ref:`out_spec1D:Naming`.

--exten
+++++++

This is a short-cut of sorts to pull the object you want without
typing in its name.

--obj
+++++

Plot this object.

--extract
+++++++++

Choice of :ref:`out_spec1D:Extraction` method

--flux
++++++

Show the fluxed spectrum (only if it has been fluxed!)

Extraction Information
======================

A `.txt` file with the same name as the 1D spectra `File`_ is also produced by PypeIt.
This file lists the main extraction information for each 1D spectrum. It looks like::

    | slit |                    name | spat_pixpos | spat_fracpos | box_width | opt_fwhm |   s2n | wv_rms |
    |   69 | SPAT0071-SLIT0069-DET02 |        70.9 |        0.504 |      3.00 |    1.911 |  7.06 |  0.025 |
    |  178 | SPAT0186-SLIT0178-DET02 |       186.1 |        0.570 |      3.00 |    1.264 |  2.60 |  0.020 |
    |  275 | SPAT0271-SLIT0275-DET02 |       270.5 |        0.434 |      3.00 |    1.317 |  1.89 |  0.021 |
    |  371 | SPAT0383-SLIT0371-DET02 |       383.3 |        0.578 |      3.00 |    0.425 |  2.98 |  0.022 |
    |  469 | SPAT0461-SLIT0469-DET02 |       461.0 |        0.392 |      3.00 |    0.873 |  0.55 |  0.026 |

where:

- ``slit`` is the slit position in pixels on the reduced image;
- ``name`` is the object name (see `Objects`_);
- ``spat_pixpos`` is the object spatial position in pixels on the reduced image;
- ``spat_fracpos`` is the fractional location of the object on the slit;
- ``box_width`` is the width in arcsec of the boxcar;
- ``opt_fwhm`` is the spatial FWHM in arcsec of the optimally extracted object;
- ``s2n`` is the Signal-to-Noise ratio (SNR) of the optimally extracted object. If optimal extraction is not
  performed, the reported SNR is for the boxcar extracted object;
- ``wv_rms`` is the RMS in pixels of the wavelength solution.


In addition, if reducing :doc:`deimos` or :doc:`mosfire` data and slit-mask design matching is performed,
``maskdef_id``, ``objname``, ``objra``, ``objdec``, and ``maskdef_extract``  are also provided
for each spectrum (see :ref:`radec_object_report`).

Current Data Model
==================

Internally, the spectrum for a single object is held by the
:class:`~pypeit.specobj.SpecObj` class. Here is its datamodel, which
is written as an `astropy.io.fits.BinTableHDU`_ in the `spec1d*` fits
file with this `Naming`_. In addition, one
:class:`~pypeit.images.detector_container.DetectorContainer` is
written to a fits extension --- named, e.g., ``DET01-DETECTOR`` ---
for each detector with at least one spectrum extracted.

All wavelengths are in vacuum.

Multiple :class:`~pypeit.specobj.SpecObj` objects are held interally
by a :class:`~pypeit.specobjs.SpecObjs` object.

.. include:: include/datamodel_specobj.rst


==========
MasterTilt
==========

Overview
========

This file describes the data model for the `MasterTilt`_ image.
For optical spectrographs, it is typically
the combination of all input arc frames.
For near-IR spectrographs, it is likely
one or more science frames.

The image is written to disk as a multi-extension FITS file
prefixed by `MasterTilt`_ in the Masters/ folder.
See :ref:`masters:Masters Naming` for the naming convention.


Inspecting
==========

The first extension is the combined image.
You can view it with any standard image viewer, e.g.::

    ginga Masters/MasterTilt_A_1_01.fits

Most often you use only one tilt frame and this appears
very similar to the raw image.  If you do stack several,
the output could be quite different.

The image will also be a trimmed portion of the
raw image and also re-oriented
so that vertical is the spectral dimension with blue at the bottom.

Here is an screen shot of a `ginga` view
for an example from the `shane_kast_red` spectrograph.

.. image:: figures/arc_image.png

Actually, I cheated. This is an :doc:`master_arc` image.
But, they are identical for this instrument.

Trouble Shooting
================

If your image appears to be in err, here are the things to consider:

 - Is one or more of your input tilt frames junk?
 - Is one or more of your input tilt frames mis-labeled?

Current TiltImage Data Model
============================

Internally, the image is held in
:class:`pypeit.tiltimage.TiltImage`
which is a :class:`pypeit.images.pypeitimage.PypeItImage` and
:class:`pypeit.datamodel.DataContainer`.
The datamodel written to disk is:

.. include:: include/datamodel_tiltimage.rst


.. include:: include/links.rst

.. _installing:

============
Installation
============

.. DO WE HAVE A RELEVANT LINK FOR THE PYPEIT USERS SLACK?

Below, we provide detailed instructions for installing ``PypeIt``.  For
troubleshooting, please consult our ``PypeIt`` user community via our PypeIt
Users Slack and/or `submit an issue <https://github.com/pypeit/PypeIt/issues>`__
on GitHub.

.. contents:: Table of Contents
    :depth: 1
    :local:

----

.. _user:

User Installation
=================

.. _environment:

Setup a clean python environment
--------------------------------

Both methods discussed below for installing ``PypeIt`` (via `pip`_ or `conda`_)
also install or upgrade its :ref:`dependencies`.  For this reason, we highly
(!!) recommended you first set up a clean python environment in which to install
``PypeIt``.  This mitigates any possible dependency conflicts with other
packages you use.

You can setup a new python environment using `virtualenv`_:

.. code-block:: console

    virtualenv pypeit
    source pypeit/bin/activate

or `conda`_:

.. code-block:: console

    conda create -n pypeit python=3.8
    conda activate pypeit

See the `Virtualenv documentation <https://virtualenv.pypa.io/en/latest/>`_
and/or `Managing Environments with Conda
<https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html>`_
for more details. See also `virtualenvwrapper
<https://virtualenvwrapper.readthedocs.io/en/latest/>`_ as an option for more
easily managing `virtualenv`_ environments.

Install via ``pip`` (recommended)
---------------------------------

To install the latest release of ``PypeIt`` and its required dependencies, execute
either

.. code-block:: console

    pip install "pypeit[pyqt5]"

to select the ``PyQT5`` QT bindings or

.. code-block:: console

    pip install "pypeit[pyside2]"

to select ``PySide2``; see :ref:`interactive`.

If you are generating datacubes (and performing an astrometric correction), you
will also need the `scikit-image`_ package. It can be installed by including it
in the optional dependencies, e.g.:

.. code-block:: console

    pip install "pypeit[pyside2,scikit-image]"

.. note::

    Whether or not it is correct syntax to use the quotes in the commands above
    depends on your shell.  The above commands are specific to ZShell, whereas
    you don't need the quotes in Bash.  But, in any case, you should avoid
    copying these commands from your browser since the unicode for quotation
    marks may not be correct, leading to errors when they are directly pasted
    into a terminal window.

Install via ``conda``
---------------------

`conda`_ is a popular and widely-used package and environment manager. We
provide a yaml file that can be used to setup a conda environment called
``pypeit`` that contains all of the required dependencies.  To use this:

    #. Download `environment.yml
       <https://github.com/pypeit/PypeIt/blob/release/environment.yml>`__.

    #. Create the conda environment:

        .. code-block:: console

            conda env create -f environment.yml

    #. Activate it:

        .. code-block:: console

            conda activate pypeit

    #. Verify that the new environment was installed correctly:

        .. code-block:: console

            conda env list

    #. Install latest ``pypeit`` via ``pip`` as above or perform a developer
       install as below or install the latest release from ``conda-forge``:

        .. code-block:: console

            conda install -c conda-forge pypeit

    #. Install the preferred QT binding either via ``pip`` as above or via
       conda:

        .. code-block:: console

            conda install -c conda-forge pyqt

       or

        .. code-block:: console

            conda install -c conda-forge pyside2

Upgrading to a new version
--------------------------

Upgrading ``PypeIt`` should simply be a matter of executing:

.. code-block:: console

    pip install pypeit --upgrade

or 

.. code-block:: console

    conda install pypeit --upgrade

depending on how you first installed ``PypeIt``.  If this causes problems (e.g.,
a new ``PypeIt`` script is unavailable or you encounter script errors), first
try uninstalling (e.g., ``pip uninstall pypeit``) and then reinstalling.

----

.. _data_installation:

Additional Data
===============

Some data used by ``PypeIt`` is not kept in the GitHub repository or distributed
via `pip`_ because of its large size.  These include:

 - Raw data included in our development suite used for extensive testing of the code base,
 - Atmospheric model grids used for telluric correction and flux calibration, and
 - Canned data-reduction products used by quick-look scripts.

These are all located in our open-access `PypeIt dev-suite Google Drive`_.

.. note::

    We continue to work on cleaner installation solutions for these data
    products, particularly for the telluric grids and the quick-look master
    files.  In the meantime, note that you will likely need to re-run the
    data-specific installation scripts described below every time you upgrade
    your installation (via `pip`_ or `conda`_).

Raw Data
--------

Example raw data for all supported spectrographs are used in extensive testing
of the code base during development; see :ref:`dev-suite`.  General users should
not need access to these data; however, they may be useful for learning how to
use ``PypeIt`` before running it on your own data from the same instrument.
These data are stored in the ``RAW_DATA`` directory in the `PypeIt dev-suite
Google Drive`_, divided into subdirectories for each instrument and instrument
setup.  See also the `PypeIt-development-suite`_ GitHub repository, which
includes a :doc:`pypeit_file` for each instrument and setup used during
development testing.

.. _install_atmosphere:

Atmospheric Model Grids
-----------------------

Calculation of the sensitivity functions for IR instruments and general fitting
of telluric absorption uses a grid of model atmosphere spectra.  These model
grids are provided in the ``Telluric`` directory in the `PypeIt dev-suite Google
Drive`_ and range in size from 3.5-7.7 GB.  Each file provides model spectra for
atmospheric conditions specific to an observatory; however, a model grid is not
provided for all observatories with spectrographs supported by ``PypeIt``.  If
you do not find models for your observatory, you can use the Maunakea model as
an approximation. It includes a large grid of different parameters and should be
good enough for most purposes.

To install the model grids:

    #. Download the relevant file(s) from the Telluric directory in the `PypeIt
       dev-suite Google Drive`_.

    #. Run the ``pypeit_install_telluric`` script.  For example, if you've
       downloaded ``TelFit_MaunaKea_3100_26100_R200000.fits`` to ``my_path``,
       then you would execute:

        .. code-block:: console

            pypeit_install_telluric --path my_path

       or

        .. code-block:: console

            cd my_path
            pypeit_install_telluric

The ``pypeit_install_telluric`` script simply searches for all the ``TelFit*``
files in the path it is provided and creates symlinks to those files in the
``pypeit/data/telluric/atm_grids`` directory in your installation of ``PypeIt``.

.. warning::

    The installation script simply creates symlinks to the downloaded data.
    This means that if you move the original data, the symlinks will become
    broken **and you will need to rerun the installation script.**


Quick-look Master Files
-----------------------

Some of the quick-look reductions provided by ``PypeIt`` require canned master
files to speed up the data-reduction process, as appropriate for a quick-look
result.  These files are hosted in the ``QL_MASTERS`` directory in the `PypeIt
dev-suite Google Drive`_.

To install the quick-look master files:

    #. Right-click on the ``QL_MASTERS`` folder in the `PypeIt dev-suite
       Google Drive`_ and select the "Download" option from the drop-down menu.
       This will download a zip file containing the full directory contents.
       Its current size (as of 22 July 2021) is about 35 MB.

    #. Run the ``pypeit_install_ql_masters`` script.  E.g.:

        .. code-block:: console

            pypeit_install_ql_masters --zip ~/Downloads/QL_MASTERS-20210722T162355Z-001.zip --odir my_path

The ``pypeit_install_ql_masters`` script will unzip the downloaded file in the
``my_path`` directory and create a symlink to the extracted directory in the
``pypeit/data/`` directory of your ``PypeIt`` installation.  The script can
automatically delete the zip file using the ``--rmzip`` option.  If you already
have the ``QL_MASTERS`` directory, you can also use the script to simply create
the symlink using the ``--ql_path`` option.

.. warning::

    The installation script simply creates symlinks to the downloaded data.
    This means that if you move the original data, the symlinks will become
    broken **and you will need to rerun the installation script.**

----

.. _notes:

Important Package Notes
=======================

.. _interactive:

Interactive Tools
-----------------

Interactive tools in ``PypeIt`` are built using the `QT
<https://www.qt.io/>`_ windowing toolkit. The ``qtpy`` package is used to
provide an abstract interface to the two most widely used QT bindings for
Python (see :ref:`dependencies`):

* `pyqt5 <https://riverbankcomputing.com/software/pyqt/intro>`_ 
* `PySide2 <https://wiki.qt.io/Qt_for_Python>`_ 

At least one of those bindings must be installed for the interative GUIs to
work. **Do not install both!**  These two packages do not play nicely together.
We strongly recommend that you use ``pyqt5``, unless you are attracted to the
more flexible licensing that ``PySide2`` provides.  ``PySide2`` can occasionally
cause GUIs to crash because of conflicts with other packages in your environment
that use ``pyqt5`` (all the more reason to isolate your ``PypeIt`` installation
in its own environment).

C code
------

Significant speed gains in ``PypeIt`` can be enabled via compilation of the C
versions of the b-spline fitting code. Compilation of the C code should happen
automatically when you install ``PypeIt``.  However, you can check that the C
code was compiled successfully by running the ``pypeit_c_enabled`` script. What
you should see is:

.. code-block:: console

    $ pypeit_c_enabled
    Successfully imported bspline C utilities.

If no message is printed, the C code could not be imported.

Some notes if you have problems installing the C code:

    - the code will still run successfully by falling back to slower,
      pure-python implementations

    - to successfully compile the C code, you may need to update ``gcc`` and/or
      ``Xcode`` for Mac users
    
    - for some Mac users, you may also need to update your OS if you're using a
      particularly old version (e.g., 10.10 Yosemite)

ginga Plugins
-------------

``PypeIt`` requires the ``ginga`` viewer and uses at least one ``ginga`` plugin
to enable specific display functionality. No special considerations are needed
to have these plugins installed; however, you can check that they're enabled by
running the following script with the following result::

    $ pypeit_chk_plugins
    [INFO]    :: All required plugins found: SlitWavelength

If the check is unsuccessful, you will see an error message listing
the missing plugins. If you have a problem, please `submit an issue
<https://github.com/pypeit/PypeIt/issues>`__.

----

.. _dependencies:

Package Dependencies
====================

All ``PypeIt`` dependencies are installed along with the installation of
``PypeIt`` itself.  Beware this means that packages in your current environment
may be updated depending on the ``PypeIt`` version requirements (which is why we
recommend you :ref:`environment` for ``PypeIt``).  The current version
requirements for both users and developers are:

.. include:: include/dependencies_table.rst

Dependency Caveats
------------------

Some users have run into the following complications when installing the
``PypeIt`` dependencies.  If you run into any more, please `submit an issue
<https://github.com/pypeit/PypeIt/issues>`__.

.. IS THIS FIRST ITEM STILL TRUE?

- At the moment, an implicit dependency on QT bindings remains (either PyQT5 or
  PySide2) because of our dependence on ``linetools``.

- Note that ``shapely`` is provided as an optional dependency, but is only
  currently used by one method that calculates the spaxel area for KCWI output
  datacubes.

----

.. _developer_install:

Developer Installation
======================

We, of course, welcome and encourage community development of ``PypeIt``.
Please see our :ref:`codeconduct` and the :ref:`development`.

Install via ``pip``
-------------------

Install pre-release or development versions of ``PypeIt`` directly from `GitHub
<https://github.com/pypeit/PypeIt>`_ using ``pip`` as follows. If you already
have a ``pypeit`` environment setup, run:

.. code-block:: console

    pip install --upgrade "git+https://github.com/pypeit/PypeIt#egg=pypeit"

If you're installing in a clean environment, be sure to include the optional
dependencies as well:

.. code-block:: console

    pip install --upgrade "git+https://github.com/pypeit/PypeIt#egg=pypeit[pyqt5,shapely]"

These commands will install the default branch, ``release``. You can also
specify a different branch, such as the main ``develop`` branch:

.. code-block:: console

    pip install --upgrade "git+https://github.com/pypeit/PypeIt.git@develop#egg=pypeit[pyqt5,shapely]"

Commit hashes, tag names, or git refs can also be specified; see the `VCS
Support documentation
<https://pip.pypa.io/en/stable/reference/pip_install/#vcs-support>`_ for details
and examples.

Install from source
-------------------

Developers doing code development will likely want to set up an "editable"
install that points to a locally checked out copy of the GitHub repository.  We 
highly recommended using ``pip`` to install the repository and to
:ref:`environment` for code development.

To install from source (after setting up the python enviroment), first clone the
repository:

.. code-block:: console

    git clone https://github.com/pypeit/PypeIt.git

Then install the code, include the development dependencies:

.. code-block:: console

    cd PypeIt
    pip install -e ".[dev,pyqt5]"

An "editable" install means that any changes you make in the repository
directory tree will become immediately available the next time the code is
imported. Including the ``[dev]`` set of optional dependencies ensures that all
of the tools you need to test and build ``PypeIt`` are installed. The ``pyqt5``
installation option instructs the script to use the PyQt5 Qt backend. (Again,
note that you may or may not need the quotes above depending on your shell, and
that you should avoid cutting and pasting these commands into a terminal
window.)

Finally, you may want to add lines to your relevant shell configuration file
(e.g., ``.zshrc`` or ``.bashrc``) that activate the relevant environment
whenever you start up a new shell.  For example:

.. code-block:: console

    conda activate pypeit

Otherwise you will need to always type this command at the terminal prompt to
activate the pypeit environment.

----

.. _test_installation:

Test Your Installation
======================

Tagged versions of ``PypeIt`` are extensively tested before distribution.
However, it is worth testing that your installation has been successful, as
follows.

User Tests
----------

The most basic tests that ``PypeIt`` has been properly installed is to get the
help dialog for one of its main executables.  I.e., from a terminal widow, type:

.. code-block:: console

    run_pypeit -h

A second basic test is to try to import ``PypeIt`` from within a python session.
For example:

.. code-block:: console

    python
    >>> import pypeit

Developer Tests
---------------

If you performed a developer installation by cloning the repository into a local
directory (e.g., ``~/PypeIt``), you can run the standard unit tests within the
``PypeIt`` environment by executing:

.. code-block:: console

    cd ~/PypeIt
    pytest

.. WHO AMONG THE CORE DEVELOPERS USE TOX?  WE USE IT FOR CI TESTS, BUT SHOULD WE BE RECOMMENDING IT FOR USERS?

To test within isolated environments and against different versions of various
dependencies, we recommend using ``tox``:

.. code-block:: console

    cd PypeIt
    tox -e test

or, e.g.:

.. code-block:: console

    tox -e test-astropydev

Run ``tox -a`` to see a list of available test environemts.

In either case, over 100 tests should pass, nearly 100 will be skipped and none
should fail. The skipped tests only run if the PypeIt development is installed
and configured; see :ref:`dev-suite`.


===============
PypeIt Cookbook
===============

Overview
========

This document gives an overview on
how to run PypeIt, i.e. minimal detail is provided.
And you should have already dealt with :doc:`installing`.

The following outlines the standard steps for running
PypeIt on a batch of data.  There are alternate ways to
run these steps, but non-experts should adhere to the
following approach.

A few points to note before getting started:

  - If your spectrograph is an echelle, every place you read *slit* think *order*
  - We also tend to use spectrograph and instrument interchangeably
  - And `setup` and `configuration` too.
  - Specific advice on :doc:`spectrographs` is provided in their own doc page (for only a few)
  - Invariably something will be out of date.  When you see an egregious example, holler on GitHub or Slack

Grab a buff computer
====================

We recommend one with at least 32Gb of RAM and this might
not be enough for many-detector instruments (e.g. :doc:`deimos`).

Multi-processors are good too, although only a portion of
the code runs in parallel.

0. Organize/Prepare your data
=============================

A word on Calibration data
--------------------------

PypeIt, as with any DRP, will work most smoothly
if you have taken data with a good set of calibrations, e.g.

  - Bias frames (optional)
  - Flats without saturation
  - Arcs with most/all of the lamps on (and without substantial saturation)
  - Slitmasks designed without overlapping slits
  - Sensible detector binning and windowing

Data with poor calibration frames will *always* be hard to reduce.
Please take extra care to insure you are not trying to reduce data
with bad calibrations.  This is the primary "failure mode" of PypeIt.

And heaven help you if you mixed binning, grating tilt, etc. between your
calibrations and science (although this is supported for some instruments,
by necessity).


Organize your Raw data
----------------------

While PypeIt can handle one or more nights of data with a mix of gratings,
tilts, and masks, you will probably find it easier to isolate one set of files
at a time.  This includes mask by mask for multi-slit observations.  Here is
what we recommend:

 - Place the science + calibrations in one folder.
 - Copy bias (and dark) frames into each folder as needed.
 - We will refer to that folder as RAWDIR

The raw images can be gzip-compressed although the Python FITS reader
works much more slowly on gzipped files.

1. Setup
========

The first scripts you will run with PypeIt are :ref:`pypeit_obslog` and
:ref:`pypeit_setup`, which examines your raw files and generates a sorted list
of files.  Specifically, :ref:`pypeit_setup` will (if instructed) create one
:doc:`pypeit_file` per instrument configuration.  The :doc:`pypeit_file` is a
required input file for ``PypeIt`` to reduce your data.

Complete instructions are provided in :doc:`setup`.

2. Edit your PypeIt file
========================

At the end of setup, you will enter one of the generated sub-folders,
namely the configuration that you wish to reduce, e.g.::

    cd keck_lris_blue_A

Within that folder is a :doc:`pypeit_file` (e.g. `keck_lris_blue_A.pypeit`)
which guides the main reduction by PypeIt.

See the :doc:`pypeit_file` docs for
tips on checking and editing that file.


3. Run the Reduction
====================

PypeIt is intended (and currently only able) to do
an end-to-end run from calibrations through to
2D and 1D spectra for each science and standard star frame.

The :doc:`running` doc describes the process in a bit
more detail.

There are details below as regards calibrations and
outputs.  See :doc:`object_finding` and :doc:`extraction`
for tips/customizing those.

4. Examine Calibrations
=======================

As the code runs, when a new calibration is generated the
default is to write it to disk as a :doc:`masters` file.
And for some of these, additional files are written to the
:doc:`qa` folder for inspection.

We encourage you to inspect these calibration outputs
as they come.

The term :doc:`masters` refers to the output files for
calibration data.  These appear in the Masters/ folder;
see :ref:`master-naming` for details on the naming
convention.

Here is the order they tend to be created
with a separate doc for how to view each, what they should
look like, and how to troubleshoot:

  - View the :doc:`master_bias` image (if you produced one)
  - View the :doc:`master_arc` image
  - Check slit edges with the :doc:`master_edges` file
  - View the :doc:`master_tilt` image
  - Check the 1D wavelength solution in the :doc:`master_wvcalib` output
  - Check the 2D wavelength solution in the :doc:`master_tilts` output
  - Check the :doc:`master_flat` images

Note that only a subset of these files may be made.
It depends on your spectrograph and the calibration files input.

5. Examine Spectra
==================

Eventually (be patient), the code will start
generating 2D and 1D spectra outputs.  One per standard
and science frame, located in the *Science/* folder.

  - Examine the 2D spectral images :doc:`out_spec2D`
  - Examine the extracted 1D spectra :doc:`out_spec1D`

If you are missing 1D spectra, this means that PypeIt did not find any objects in the corresponding frame.  You may need to modify some of the parameters in your :doc:`pypeit_file`.

Here are some :doc:`reduction_tips` for tuning parameters
related to extraction and sky subtraction for your spectra.

6. Fluxing
==========

PypeIt provides routines for :doc:`fluxing` your spectra.
These are run separately from and after the main run.

Note that this is a two-stage process.  One to generate
a sensitivity function and one to apply it.

7. Coadding
===========

There are scripts for coadding both the 2D spectra
(undocumented) and to :doc:`coadd1d`. In the case of
IFU reductions, there are scripts to coadd the reduced
spec2d files into combined 3D datacubes (see :doc:`coadd3d`).
These are all run separately from and after the main run.





.. highlight:: rest

.. _configobj: http://configobj.readthedocs.io/en/latest/

.. _pypeitpar:

=================
PypeIt Parameters
=================

PypeIt allows you to customize its execution without having to change the
code directly.

Although not ubiquitous, most optional arguments of PypeIt's algorithms
are contained within the :class:`pypeit.par.pypeitpar.PypeItPar`
superset.  PypeIt uses the `configobj`_ class to parse the user-supplied
arguments  in the :ref:`pypeit_file` into an instance of
:class:`pypeit.par.pypeitpar.PypeItPar` that is passed to all of
PypeIt's main modules.  The syntax used to set parameters using the
:ref:`pypeit_file` is important and the nesting of the parameter changes
must match the `Current PypeItPar Parameter Hierarchy`_.

Importantly, each instrument served provides its own default values for
:class:`pypeit.par.pypeitpar.PypeItPar` as defined by its
``default_pypeit_par`` method; e.g.,
:func:`pypeit.spectrographs.shane_kast.ShaneKastSpectrograph.default_pypeit_par`.
Only those parameters that the user wishes to be different from the
default *as set by their specified instrument* need to be changed via
the :ref:`pypeit_file`.  The `Instrument-Specific Default
Configuration`_ are listed below.

.. warning::

 * Default values of parameters that actually point to data files
   provided by PypeIt (e.g. the ``spectrum`` parameter for
   :class:`pypeit.par.pypeitpar.FlexurePar`) in its root directory will
   point to the relevant location on disk of whoever generated the
   documentation, which will be different for your installation.

.. _change_par:

How to change a parameter
=========================

To change a parameter, set its value at the beginning of your pypeit
file.  The *syntax* of the configuration block is important, but the
indentation is not.  The indentation will just make the block easier to
read.  All PypeIt files begin with the lines that set the spectrograph::

    [rdx]
        spectrograph = keck_deimos

The nesting of the PypeIt parameters is as illustrated in the `Current
PypeItPar Parameter Hierarchy`_ section below.  Here are a few examples
of how to change various parameters; for additional examples see the
`Instrument-Specific Default Configuration`_ section.

 * To change the threshold used for detecting slit/order edges, add::

    [calibrations]
        [[slitedges]]
            edge_thresh = 100

 * To change the exposure time range used to identify an arc and
   flat-field frames and to increase the LA Cosmic sigma-clipping
   threshold for arc frames, add::

    [calibrations]
        [[arcframe]]
            exprng = None,10
            [[process]]
                sigclip = 6.
        [[pixelflatframe]]
            exprng = 11,30

How to change the image processing parameters for all frame types
=================================================================

To change the base-level image processing parameters that will be
applied to *all* frame types, you can use the ``baseprocess`` parameter
group.  This allows you to set these parameters once instead of having
to include lines in your PypeIt file for each frame type.  Any
frame-type-specific alterations can still be made and will overwrite the
base-level processing parameters.  For example, to change the
sigma-clipping level used by the LA Cosmic routine to default to 3.0 but
to use a value of 6.0 for arc frames, you can add the following to your
PypeIt file::

    [baseprocess]
        sigclip = 3.0
    [calibrations]
        [[arcframe]]
            [[[process]]]
                sigclip = 6.0


Current PypeItPar Parameter Hierarchy
+++++++++++++++++++++++++++++++++++++

`PypeItPar Keywords`_

    ``[rdx]``: `ReduxPar Keywords`_

    ``[calibrations]``: `CalibrationsPar Keywords`_

        ``[[biasframe]]``: `FrameGroupPar Keywords`_

            ``[[[process]]]``: `ProcessImagesPar Keywords`_

        ``[[darkframe]]``: `FrameGroupPar Keywords`_

            ``[[[process]]]``: `ProcessImagesPar Keywords`_

        ``[[arcframe]]``: `FrameGroupPar Keywords`_

            ``[[[process]]]``: `ProcessImagesPar Keywords`_

        ``[[tiltframe]]``: `FrameGroupPar Keywords`_

            ``[[[process]]]``: `ProcessImagesPar Keywords`_

        ``[[pixelflatframe]]``: `FrameGroupPar Keywords`_

            ``[[[process]]]``: `ProcessImagesPar Keywords`_

        ``[[pinholeframe]]``: `FrameGroupPar Keywords`_

            ``[[[process]]]``: `ProcessImagesPar Keywords`_

        ``[[alignframe]]``: `FrameGroupPar Keywords`_

            ``[[[process]]]``: `ProcessImagesPar Keywords`_

        ``[[alignment]]``: `AlignPar Keywords`_

        ``[[traceframe]]``: `FrameGroupPar Keywords`_

            ``[[[process]]]``: `ProcessImagesPar Keywords`_

        ``[[illumflatframe]]``: `FrameGroupPar Keywords`_

            ``[[[process]]]``: `ProcessImagesPar Keywords`_

        ``[[skyframe]]``: `FrameGroupPar Keywords`_

            ``[[[process]]]``: `ProcessImagesPar Keywords`_

        ``[[standardframe]]``: `FrameGroupPar Keywords`_

            ``[[[process]]]``: `ProcessImagesPar Keywords`_

        ``[[flatfield]]``: `FlatFieldPar Keywords`_

        ``[[wavelengths]]``: `WavelengthSolutionPar Keywords`_

        ``[[slitedges]]``: `EdgeTracePar Keywords`_

        ``[[tilts]]``: `WaveTiltsPar Keywords`_

    ``[scienceframe]``: `FrameGroupPar Keywords`_

        ``[[process]]``: `ProcessImagesPar Keywords`_

    ``[reduce]``: `ReducePar Keywords`_

        ``[[findobj]]``: `FindObjPar Keywords`_

        ``[[skysub]]``: `SkySubPar Keywords`_

        ``[[extraction]]``: `ExtractionPar Keywords`_

            ``[[[manual]]]``: `ManualExtractionPar Keywords`_

        ``[[cube]]``: `CubePar Keywords`_

        ``[[slitmask]]``: `SlitMaskPar Keywords`_

    ``[flexure]``: `FlexurePar Keywords`_

    ``[fluxcalib]``: `FluxCalibratePar Keywords`_

    ``[coadd1d]``: `Coadd1DPar Keywords`_

    ``[coadd2d]``: `Coadd2DPar Keywords`_

    ``[sensfunc]``: `SensFuncPar Keywords`_

        ``[[UVIS]]``: `SensfuncUVISPar Keywords`_

        ``[[IR]]``: `TelluricPar Keywords`_

    ``[telluric]``: `TelluricPar Keywords`_

    ``[collate1d]``: `Collate1DPar Keywords`_


----

PypeItPar Keywords
------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.PypeItPar`

================  ==============================================  =======  ============================  ======================================================================================================================================================================================================================================================================================
Key               Type                                            Options  Default                       Description                                                                                                                                                                                                                                                                           
================  ==============================================  =======  ============================  ======================================================================================================================================================================================================================================================================================
``calibrations``  :class:`pypeit.par.pypeitpar.CalibrationsPar`   ..       `CalibrationsPar Keywords`_   Parameters for the calibration algorithms                                                                                                                                                                                                                                             
``coadd1d``       :class:`pypeit.par.pypeitpar.Coadd1DPar`        ..       `Coadd1DPar Keywords`_        Par set to control 1D coadds.  Only used in the after-burner script.                                                                                                                                                                                                                  
``coadd2d``       :class:`pypeit.par.pypeitpar.Coadd2DPar`        ..       `Coadd2DPar Keywords`_        Par set to control 2D coadds.  Only used in the after-burner script.                                                                                                                                                                                                                  
``collate1d``     :class:`pypeit.par.pypeitpar.Collate1DPar`      ..       `Collate1DPar Keywords`_      Par set to control collating 1d spectra.  Only used in the after-burner script.                                                                                                                                                                                                       
``flexure``       :class:`pypeit.par.pypeitpar.FlexurePar`        ..       `FlexurePar Keywords`_        Parameters used by the flexure-correction procedure.  Flexure corrections are not performed by default.  To turn on, either set the parameters in the 'flexure' parameter group or set 'flexure = True' in the 'rdx' parameter group to use the default flexure-correction parameters.
``fluxcalib``     :class:`pypeit.par.pypeitpar.FluxCalibratePar`  ..       `FluxCalibratePar Keywords`_  Parameters used by the flux-calibration procedure.  Flux calibration is not performed by default.  To turn on, either set the parameters in the 'fluxcalib' parameter group or set 'fluxcalib = True' in the 'rdx' parameter group to use the default flux-calibration parameters.    
``rdx``           :class:`pypeit.par.pypeitpar.ReduxPar`          ..       `ReduxPar Keywords`_          PypeIt reduction rules.                                                                                                                                                                                                                                                               
``reduce``        :class:`pypeit.par.pypeitpar.ReducePar`         ..       `ReducePar Keywords`_         Parameters determining sky-subtraction, object finding, and extraction                                                                                                                                                                                                                
``scienceframe``  :class:`pypeit.par.pypeitpar.FrameGroupPar`     ..       `FrameGroupPar Keywords`_     The frames and combination rules for the science observations                                                                                                                                                                                                                         
``sensfunc``      :class:`pypeit.par.pypeitpar.SensFuncPar`       ..       `SensFuncPar Keywords`_       Par set to control sensitivity function computation.  Only used in the after-burner script.                                                                                                                                                                                           
``telluric``      :class:`pypeit.par.pypeitpar.TelluricPar`       ..       `TelluricPar Keywords`_       Par set to control telluric fitting.  Only used in the pypeit_sensfunc and pypeit_telluric after-burner scripts.                                                                                                                                                                      
================  ==============================================  =======  ============================  ======================================================================================================================================================================================================================================================================================


----

CalibrationsPar Keywords
------------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.CalibrationsPar`

===================  ===================================================  =======  =================================  =========================================================================================================================================================================================
Key                  Type                                                 Options  Default                            Description                                                                                                                                                                              
===================  ===================================================  =======  =================================  =========================================================================================================================================================================================
``alignframe``       :class:`pypeit.par.pypeitpar.FrameGroupPar`          ..       `FrameGroupPar Keywords`_          The frames and combination rules for the align frames                                                                                                                                    
``alignment``        :class:`pypeit.par.pypeitpar.AlignPar`               ..       `AlignPar Keywords`_               Define the procedure for the alignment of traces                                                                                                                                         
``arcframe``         :class:`pypeit.par.pypeitpar.FrameGroupPar`          ..       `FrameGroupPar Keywords`_          The frames and combination rules for the wavelength calibration                                                                                                                          
``biasframe``        :class:`pypeit.par.pypeitpar.FrameGroupPar`          ..       `FrameGroupPar Keywords`_          The frames and combination rules for the bias correction                                                                                                                                 
``bpm_usebias``      bool                                                 ..       False                              Make a bad pixel mask from bias frames? Bias frames must be provided.                                                                                                                    
``darkframe``        :class:`pypeit.par.pypeitpar.FrameGroupPar`          ..       `FrameGroupPar Keywords`_          The frames and combination rules for the dark-current correction                                                                                                                         
``flatfield``        :class:`pypeit.par.pypeitpar.FlatFieldPar`           ..       `FlatFieldPar Keywords`_           Parameters used to set the flat-field procedure                                                                                                                                          
``illumflatframe``   :class:`pypeit.par.pypeitpar.FrameGroupPar`          ..       `FrameGroupPar Keywords`_          The frames and combination rules for the illumination flat                                                                                                                               
``master_dir``       str                                                  ..       ``Masters``                        If provided, it should be the name of the folder to write master files. NOT A PATH.                                                                                                      
``pinholeframe``     :class:`pypeit.par.pypeitpar.FrameGroupPar`          ..       `FrameGroupPar Keywords`_          The frames and combination rules for the pinholes                                                                                                                                        
``pixelflatframe``   :class:`pypeit.par.pypeitpar.FrameGroupPar`          ..       `FrameGroupPar Keywords`_          The frames and combination rules for the pixel flat                                                                                                                                      
``raise_chk_error``  bool                                                 ..       True                               Raise an error if the calibration check fails                                                                                                                                            
``setup``            str                                                  ..       ..                                 If masters='force', this is the setup name to be used: e.g., C_02_aa .  The detector number is ignored but the other information must match the Master Frames in the master frame folder.
``skyframe``         :class:`pypeit.par.pypeitpar.FrameGroupPar`          ..       `FrameGroupPar Keywords`_          The frames and combination rules for the sky background observations                                                                                                                     
``slitedges``        :class:`pypeit.par.pypeitpar.EdgeTracePar`           ..       `EdgeTracePar Keywords`_           Slit-edge tracing parameters                                                                                                                                                             
``standardframe``    :class:`pypeit.par.pypeitpar.FrameGroupPar`          ..       `FrameGroupPar Keywords`_          The frames and combination rules for the spectrophotometric standard observations                                                                                                        
``tiltframe``        :class:`pypeit.par.pypeitpar.FrameGroupPar`          ..       `FrameGroupPar Keywords`_          The frames and combination rules for the wavelength tilts                                                                                                                                
``tilts``            :class:`pypeit.par.pypeitpar.WaveTiltsPar`           ..       `WaveTiltsPar Keywords`_           Define how to trace the slit tilts using the trace frames                                                                                                                                
``traceframe``       :class:`pypeit.par.pypeitpar.FrameGroupPar`          ..       `FrameGroupPar Keywords`_          The frames and combination rules for images used for slit tracing                                                                                                                        
``wavelengths``      :class:`pypeit.par.pypeitpar.WavelengthSolutionPar`  ..       `WavelengthSolutionPar Keywords`_  Parameters used to derive the wavelength solution                                                                                                                                        
===================  ===================================================  =======  =================================  =========================================================================================================================================================================================


----

AlignPar Keywords
-----------------

Class Instantiation: :class:`pypeit.par.pypeitpar.AlignPar`

===============  =============  =======  =============  ================================================================================================================================================================================================================================================================================
Key              Type           Options  Default        Description                                                                                                                                                                                                                                                                     
===============  =============  =======  =============  ================================================================================================================================================================================================================================================================================
``locations``    list, ndarray  ..       0.0, 0.5, 1.0  Locations of the bars, in a list, specified as a fraction of the slit width                                                                                                                                                                                                     
``sig_thresh``   int, float     ..       1.0            Significance threshold for finding an alignment trace. This should be a lownumber to ensure that the algorithm finds all bars. The algorithm willthen only use the N most significant detections, where N is the numberof elements specified in the "locations" keyword argument
``trace_npoly``  int            ..       4              Order of the polynomial to use when fitting the trace of a single bar                                                                                                                                                                                                           
``trim_edge``    list           ..       0, 0           Trim the slit by this number of pixels left/right before finding alignment bars                                                                                                                                                                                                 
===============  =============  =======  =============  ================================================================================================================================================================================================================================================================================


----

FlatFieldPar Keywords
---------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.FlatFieldPar`

=======================  =================  =================================  ===========  =========================================================================================================================================================================================================================================================================================================================================
Key                      Type               Options                            Default      Description                                                                                                                                                                                                                                                                                                                              
=======================  =================  =================================  ===========  =========================================================================================================================================================================================================================================================================================================================================
``illum_iter``           int                ..                                 0            The number of rejection iterations to perform when constructing the slit-illumination profile.  No rejection iterations are performed if 0.  WARNING: Functionality still being tested.                                                                                                                                                  
``illum_rej``            int, float         ..                                 5.0          The sigma threshold used in the rejection iterations used to refine the slit-illumination profile.  Rejection iterations are only performed if ``illum_iter > 0``.                                                                                                                                                                       
``method``               str                ``bspline``, ``skip``              ``bspline``  Method used to flat field the data; use skip to skip flat-fielding.  Options are: None, bspline, skip                                                                                                                                                                                                                                    
``pixelflat_file``       str                ..                                 ..           Filename of the image to use for pixel-level field flattening                                                                                                                                                                                                                                                                            
``pixelflat_max_wave``   int, float         ..                                 ..           All values of the normalized pixel flat are set to 1 for wavelengths above this value.                                                                                                                                                                                                                                                   
``pixelflat_min_wave``   int, float         ..                                 ..           All values of the normalized pixel flat are set to 1 for wavelengths below this value.                                                                                                                                                                                                                                                   
``rej_sticky``           bool               ..                                 False        Propagate the rejected pixels through the stages of the flat-field fitting (i.e, from the spectral fit, to the spatial fit, and finally to the 2D residual fit).  If False, pixels rejected in each stage are included in each subsequent stage.                                                                                         
``saturated_slits``      str                ``crash``, ``mask``, ``continue``  ``crash``    Behavior when a slit is encountered with a large fraction of saturated pixels in the flat-field.  The options are: 'crash' - Raise an error and halt the data reduction; 'mask' - Mask the slit, meaning no science data will be extracted from the slit; 'continue' - ignore the flat-field correction, but continue with the reduction.
``slit_illum_pad``       int, float         ..                                 5.0          The number of pixels to pad the slit edges when constructing the slit-illumination profile. Single value applied to both edges.                                                                                                                                                                                                          
``slit_illum_ref_idx``   int                ..                                 0            The index of a reference slit (0-indexed) used for estimating the relative spectral sensitivity (or the relative blaze). Thisparameter is only used if ``slit_illum_relative = True``.                                                                                                                                                   
``slit_illum_relative``  bool               ..                                 False        Generate an image of the relative spectral illuminationfor a multi-slit setup.  If you set ``use_slitillum = True`` for any of the frames that use the flat-field model, this *must* be set to True.                                                                                                                                     
``slit_trim``            int, float, tuple  ..                                 3.0          The number of pixels to trim each side of the slit when selecting pixels to use for fitting the spectral response function.  Single values are used for both slit edges; a two-tuple can be used to trim the left and right sides differently.                                                                                           
``spat_samp``            int, float         ..                                 5.0          Spatial sampling for slit illumination function. This is the width of the median filter in pixels used to determine the slit illumination function, and thus sets the minimum scale on which the illumination function will have features.                                                                                               
``spec_samp_coarse``     int, float         ..                                 50.0         bspline break point spacing in units of pixels for 2-d bspline-polynomial fit to flat field image residuals. This should be a large number unless you are trying to fit a sky flat with lots of narrow spectral features.                                                                                                                
``spec_samp_fine``       int, float         ..                                 1.2          bspline break point spacing in units of pixels for spectral fit to flat field blaze function.                                                                                                                                                                                                                                            
``tweak_slits``          bool               ..                                 True         Use the illumination flat field to tweak the slit edges. This will work even if illumflatten is set to False                                                                                                                                                                                                                             
``tweak_slits_maxfrac``  float              ..                                 0.1          If tweak_slit is True, this sets the maximum fractional amount (of a slits width) allowed for trimming each (i.e. left and right) slit boundary, i.e. the default is 10% which means slits would shrink or grow by at most 20% (10% on each side)                                                                                        
``tweak_slits_thresh``   float              ..                                 0.93         If tweak_slits is True, this sets the illumination function threshold used to tweak the slit boundaries based on the illumination flat. It should be a number less than 1.0                                                                                                                                                              
``twod_fit_npoly``       int                ..                                 ..           Order of polynomial used in the 2D bspline-polynomial fit to flat-field image residuals. The code determines the order of these polynomials to each slit automatically depending on the slit width, which is why the default is None. Alter this paramter at your own risk!                                                              
=======================  =================  =================================  ===========  =========================================================================================================================================================================================================================================================================================================================================


----

EdgeTracePar Keywords
---------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.EdgeTracePar`

===========================  ================  ===========================================  ==============  ======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Key                          Type              Options                                      Default         Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
===========================  ================  ===========================================  ==============  ======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
``add_slits``                str, list         ..                                           ..              Add one or more user-defined slits.  The syntax to define a slit to add is: 'det:spec:spat_left:spat_right' where det=detector, spec=spectral pixel, spat_left=spatial pixel of left slit boundary, and spat_righ=spatial pixel of right slit boundary.  For example, '2:2000:2121:2322,3:2000:1201:1500' will add a slit to detector 2 passing through spec=2000 extending spatially from 2121 to 2322 and another on detector 3 at spec=2000 extending from 1201 to 1500.                                                                                                                           
``auto_pca``                 bool              ..                                           True            During automated tracing, attempt to construct a PCA decomposition of the traces. When True, the edge traces resulting from the initial detection, centroid refinement, and polynomial fitting must meet a set of criteria for performing the pca; see :func:`pypeit.edgetrace.EdgeTraceSet.can_pca`.  If False, the ``sync_predict`` parameter *cannot* be set to ``pca``; if it is not, the value is set to ``nearest`` and a warning is issued when validating the parameter set.                                                                                                                  
``bound_detector``           bool              ..                                           False           When the code is ready to synchronize the left/right trace edges, the traces should have been constructed, vetted, and cleaned. This can sometimes lead to *no* valid traces. This parameter dictates what to do next. If ``bound_detector`` is True, the code will artificially add left and right edges that bound the detector; if False, the code identifies the slit-edge tracing as being unsuccessful, warns the user, and ends gracefully. Note that setting ``bound_detector`` to True is needed for some long-slit data where the slit edges are, in fact, beyond the edges of the detector.
``clip``                     bool              ..                                           True            Remove traces flagged as bad, instead of only masking them.  This is currently only used by :func:`~pypeit.edgetrace.EdgeTraceSet.centroid_refine`.                                                                                                                                                                                                                                                                                                                                                                                                                                                   
``det_buffer``               int               ..                                           5               The minimum separation between the detector edges and a slit edge for any added edge traces.  Must be positive.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
``det_min_spec_length``      int, float        ..                                           0.33            The minimum spectral length (as a fraction of the detector size) of a trace determined by direct measurements of the detector data (as opposed to what should be included in any modeling approach; see fit_min_spec_length).                                                                                                                                                                                                                                                                                                                                                                         
``edge_detect_clip``         int, float        ..                                           ..              Sigma clipping level for peaks detected in the collapsed, Sobel-filtered significance image.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
``edge_thresh``              int, float        ..                                           20.0            Threshold for finding edges in the Sobel-filtered significance image.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
``exclude_regions``          list, str         ..                                           ..              User-defined regions to exclude from the slit tracing. To set this parameter, the text should be a comma separated list of pixel ranges (in the x direction) to be excluded and the detector number. For example, the following string 1:0:20,1:300:400  would select two regions in det=1 between pixels 0 and 20 and between 300 and 400.                                                                                                                                                                                                                                                           
``filt_iter``                int               ..                                           0               Number of median-filtering iterations to perform on sqrt(trace) image before applying to Sobel filter to detect slit/order edges.                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
``fit_function``             str               ``polynomial``, ``legendre``, ``chebyshev``  ``legendre``    Function fit to edge measurements.  Options are: polynomial, legendre, chebyshev                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
``fit_maxdev``               int, float        ..                                           5.0             Maximum deviation between the fitted and measured edge position for rejection in spatial pixels.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
``fit_maxiter``              int               ..                                           25              Maximum number of rejection iterations during edge fitting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
``fit_min_spec_length``      float             ..                                           0.6             Minimum unmasked spectral length of a traced slit edge to use in any modeling procedure (polynomial fitting or PCA decomposition).                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
``fit_niter``                int               ..                                           1               Number of iterations of re-measuring and re-fitting the edge data; see :func:`pypeit.core.trace.fit_trace`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
``fit_order``                int               ..                                           5               Order of the function fit to edge measurements.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
``follow_span``              int               ..                                           20              In the initial connection of spectrally adjacent edge detections, this sets the number of previous spectral rows to consider when following slits forward.                                                                                                                                                                                                                                                                                                                                                                                                                                            
``fwhm_gaussian``            int, float        ..                                           3.0             The `fwhm` parameter to use when using Gaussian weighting in :func:`pypeit.core.trace.fit_trace` when refining the PCA predictions of edges.  See description :func:`pypeit.core.trace.peak_trace`.                                                                                                                                                                                                                                                                                                                                                                                                   
``fwhm_uniform``             int, float        ..                                           3.0             The `fwhm` parameter to use when using uniform weighting in :func:`pypeit.core.trace.fit_trace` when refining the PCA predictions of edges.  See description of :func:`pypeit.core.trace.peak_trace`.                                                                                                                                                                                                                                                                                                                                                                                                 
``gap_offset``               int, float        ..                                           5.0             Offset (pixels) used for the slit edge gap width when inserting slit edges (see `sync_center`) or when nudging predicted slit edges to avoid slit overlaps.  This should be larger than `minimum_slit_gap` when converted to arcseconds.                                                                                                                                                                                                                                                                                                                                                              
``left_right_pca``           bool              ..                                           False           Construct a PCA decomposition for the left and right traces separately.  This can be important for cross-dispersed echelle spectrographs (e.g., Keck-NIRES)                                                                                                                                                                                                                                                                                                                                                                                                                                           
``length_range``             int, float        ..                                           ..              Allowed range in slit length compared to the median slit length.  For example, a value of 0.3 means that slit lengths should not vary more than 30%.  Relatively shorter or longer slits are masked or clipped.  Most useful for echelle or multi-slit data where the slits should have similar or identical lengths.                                                                                                                                                                                                                                                                                 
``maskdesign_maxsep``        int, float        ..                                           50              Maximum allowed offset in pixels between the slit edges defined by the slit-mask design and the traced edges.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
``maskdesign_sigrej``        int, float        ..                                           3               Number of sigma for sigma-clipping rejection during slit-mask design matching.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
``maskdesign_step``          int, float        ..                                           1               Step in pixels used to generate a list of possible offsets (within +/- `maskdesign_maxsep`) between the slit edges defined by the mask design and the traced edges.                                                                                                                                                                                                                                                                                                                                                                                                                                   
``match_tol``                int, float        ..                                           3.0             Same-side slit edges below this separation in pixels are considered part of the same edge.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
``max_nudge``                int               ..                                           ..              If parts of any (predicted) trace fall off the detector edge, allow them to be nudged away from the detector edge up to and including this maximum number of pixels.  If None, no limit is set; otherwise should be 0 or larger.                                                                                                                                                                                                                                                                                                                                                                      
``max_shift_abs``            int, float        ..                                           0.5             Maximum spatial shift in pixels between an input edge location and the recentroided value.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
``max_shift_adj``            int, float        ..                                           0.15            Maximum spatial shift in pixels between the edges in adjacent spectral positions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
``max_spat_error``           int, float        ..                                           ..              Maximum error in the spatial position of edges in pixels.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
``minimum_slit_gap``         int, float        ..                                           ..              Minimum slit gap in arcsec.  Gaps between slits are determined by the median difference between the right and left edge locations of adjacent slits.  Slits with small gaps are merged by removing the intervening traces.If None, no minimum slit gap is applied.  This should be smaller than `gap_offset` when converted to pixels.                                                                                                                                                                                                                                                                
``minimum_slit_length``      int, float        ..                                           ..              Minimum slit length in arcsec.  Slit lengths are determined by the median difference between the left and right edge locations for the unmasked trace locations.  This is used to identify traces that are *erroneously* matched together to form slits.  Short slits are expected to be ignored or removed (see  ``clip``).  If None, no minimum slit length applied.                                                                                                                                                                                                                                
``minimum_slit_length_sci``  int, float        ..                                           ..              Minimum slit length in arcsec for a science slit.  Slit lengths are determined by the median difference between the left and right edge locations for the unmasked trace locations.  Used in combination with ``minimum_slit_length``, this parameter is used to identify box or alignment slits; i.e., those slits that are shorter than ``minimum_slit_length_sci`` but larger than ``minimum_slit_length`` are box/alignment slits.  Box slits are *never* removed (see ``clip``), but no spectra are extracted from them.  If None, no minimum science slit length is applied.                    
``niter_gaussian``           int               ..                                           6               The number of iterations of :func:`pypeit.core.trace.fit_trace` to use when using Gaussian weighting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
``niter_uniform``            int               ..                                           9               The number of iterations of :func:`pypeit.core.trace.fit_trace` to use when using uniform weighting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
``order_match``              int, float        ..                                           ..              For echelle spectrographs, this is the tolerance allowed for matching identified "slits" to echelle orders. Must be in the fraction of the detector spatial scale (i.e., a value of 0.05 means that the order locations must be within 5% of the expected value).  If None, no limit is used.                                                                                                                                                                                                                                                                                                         
``order_offset``             int, float        ..                                           ..              Offset to introduce to the expected order positions to improve the match for this specific data. This is an additive offset to the measured slit positions; i.e., this should minimize the difference between the expected order positions and ``self.slit_spatial_center() + offset``. Must be in the fraction of the detector spatial scale. If None, no offset is applied.                                                                                                                                                                                                                         
``pad``                      int               ..                                           0               Integer number of pixels to consider beyond the slit edges when selecting pixels that are 'on' the slit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
``pca_function``             str               ``polynomial``, ``legendre``, ``chebyshev``  ``polynomial``  Type of function fit to the PCA coefficients for each component.  Options are: polynomial, legendre, chebyshev                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
``pca_maxiter``              int               ..                                           25              Maximum number of rejection iterations when fitting the PCA coefficients.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
``pca_maxrej``               int               ..                                           1               Maximum number of PCA coefficients rejected during a given fit iteration.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
``pca_min_edges``            int               ..                                           4               Minimum number of edge traces required to perform a PCA decomposition of the trace form.  If left_right_pca is True, this minimum applies to the number of left and right traces separately.                                                                                                                                                                                                                                                                                                                                                                                                          
``pca_n``                    int               ..                                           ..              The number of PCA components to keep, which must be less than the number of detected traces.  If not provided, determined by calculating the minimum number of components required to explain a given percentage of variance in the edge data; see `pca_var_percent`.                                                                                                                                                                                                                                                                                                                                 
``pca_order``                int               ..                                           2               Order of the function fit to the PCA coefficients.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
``pca_sigrej``               int, float, list  ..                                           2.0, 2.0        Sigma rejection threshold for fitting PCA components. Individual numbers are used for both lower and upper rejection. A list of two numbers sets these explicitly (e.g., [2., 3.]).                                                                                                                                                                                                                                                                                                                                                                                                                   
``pca_var_percent``          int, float        ..                                           99.8            The percentage (i.e., not the fraction) of the variance in the edge data accounted for by the PCA used to truncate the number of PCA coefficients to keep (see `pca_n`).  Ignored if `pca_n` is provided directly.                                                                                                                                                                                                                                                                                                                                                                                    
``rm_slits``                 str, list         ..                                           ..              Remove one or more user-specified slits.  The syntax used to define a slit to remove is: 'det:spec:spat' where det=detector, spec=spectral pixel, spat=spatial pixel.  For example, '2:2000:2121,3:2000:1500' will remove the slit on detector 2 that contains pixel (spat,spec)=(2000,2121) and on detector 3 that contains pixel (2000,2121).                                                                                                                                                                                                                                                       
``smash_range``              list              ..                                           0.0, 1.0        Range of the slit in the spectral direction (in fractional units) to smash when searching for slit edges.  If the spectrum covers only a portion of the image, use that range.                                                                                                                                                                                                                                                                                                                                                                                                                        
``sobel_mode``               str               ``nearest``, ``constant``                    ``nearest``     Mode for Sobel filtering.  Default is 'nearest'; note we find'constant' works best for DEIMOS.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
``sync_center``              str               ``median``, ``nearest``, ``gap``             ``median``      Mode to use for determining the location of traces to insert.  Use `median` to use the median of the matched left and right edge pairs, `nearest` to use the length of the nearest slit, or `gap` to offset by a fixed gap width from the next slit edge.                                                                                                                                                                                                                                                                                                                                             
``sync_predict``             str               ``pca``, ``nearest``                         ``pca``         Mode to use when predicting the form of the trace to insert.  Use `pca` to use the PCA decomposition or `nearest` to reproduce the shape of the nearest trace.                                                                                                                                                                                                                                                                                                                                                                                                                                        
``sync_to_edge``             bool              ..                                           True            If adding a first left edge or a last right edge, ignore `center_mode` for these edges and place them at the edge of the detector (with the relevant shape).                                                                                                                                                                                                                                                                                                                                                                                                                                          
``trace_median_frac``        int, float        ..                                           ..              After detection of peaks in the rectified Sobel-filtered image and before refitting the edge traces, the rectified image is median filtered with a kernel width of `trace_median_frac*nspec` along the spectral dimension.                                                                                                                                                                                                                                                                                                                                                                            
``trace_thresh``             int, float        ..                                           ..              After rectification and median filtering of the Sobel-filtered image (see `trace_median_frac`), values in the median-filtered image *below* this threshold are masked in the refitting of the edge trace data.  If None, no masking applied.                                                                                                                                                                                                                                                                                                                                                          
``use_maskdesign``           bool              ..                                           False           Use slit-mask designs to identify slits.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
===========================  ================  ===========================================  ==============  ======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================


----

WaveTiltsPar Keywords
---------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.WaveTiltsPar`

===================  =========================  =======  ==============  =========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Key                  Type                       Options  Default         Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
===================  =========================  =======  ==============  =========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
``cont_rej``         int, float, list, ndarray  ..       3, 1.5          The sigma threshold for rejection.  Can be a single number or two numbers that give the low and high sigma rejection, respectively.                                                                                                                                                                                                                                                                                                                                                                                                                                      
``func2d``           str                        ..       ``legendre2d``  Type of function for 2D fit                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
``idsonly``          bool                       ..       False           Only use the arc lines that have an identified wavelength to trace tilts (CURRENTLY NOT USED!)                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
``maxdev2d``         int, float                 ..       0.25            Maximum absolute deviation (in units of fwhm) rejection threshold used to determines which pixels in global 2d fits to arc line tilts are rejected because they deviate from the model by more than this value                                                                                                                                                                                                                                                                                                                                                           
``maxdev_tracefit``  int, float                 ..       0.2             Maximum absolute deviation (in units of fwhm) for the legendre polynomial fits to individual arc line tilt fits during iterative trace fitting (flux weighted, then gaussian weighted)                                                                                                                                                                                                                                                                                                                                                                                   
``minmax_extrap``    list, ndarray              ..       150.0, 1000.0   Sets how far below the last measured tilt line is extrapolated in tracewave.fit_tilts()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
``nfwhm_neigh``      int, float                 ..       3.0             Required separation between neighboring arc lines for them to be considered for tilt tracing in units of the the spectral fwhm (see wavelength parset where fwhm is defined)                                                                                                                                                                                                                                                                                                                                                                                             
``rm_continuum``     bool                       ..       False           Before tracing the line center at each spatial position, remove any low-order continuum in the 2D spectra.                                                                                                                                                                                                                                                                                                                                                                                                                                                               
``sig_neigh``        int, float                 ..       10.0            Significance threshold for arcs to be used in line identification for the purpose of identifying neighboring lines.The tracethresh parameter above determines the significance threshold of lines that will be traced, but these lines must be at least nfwhm_neigh fwhm away from neighboring lines. This parameter determines the significance above which a line must be to be considered a possible colliding neighbor. A low value of sig_neigh will result in an overall larger number of lines, which will result in more lines above tracethresh getting rejected
``sigrej2d``         int, float                 ..       3.0             Outlier rejection significance determining which pixels on a fit to an arc line tilt are rejected by the global 2D fit                                                                                                                                                                                                                                                                                                                                                                                                                                                   
``sigrej_trace``     int, float                 ..       3.0             Outlier rejection significance to determine which traced arc lines should be included in the global fit                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
``spat_order``       int, float, list, ndarray  ..       3               Order of the legendre polynomial to be fit to the the tilt of an arc line. This parameter determinesboth the orer of the *individual* arc line tilts, as well as the order of the spatial direction of the2d legendre polynomial (spatial, spectral) that is fit to obtain a global solution for the tilts across theslit/order. This can be a single number or a list/array providing the value for each slit                                                                                                                                                           
``spec_order``       int, float, list, ndarray  ..       4               Order of the spectral direction of the 2d legendre polynomial (spatial, spectral) that is fit to obtain a global solution for the tilts across the slit/order. This can be a single number or a list/array providing the value for each slit                                                                                                                                                                                                                                                                                                                             
``tracethresh``      int, float, list, ndarray  ..       20.0            Significance threshold for arcs to be used in tracing wavelength tilts. This can be a single number or a list/array providing the value for each slit/order.                                                                                                                                                                                                                                                                                                                                                                                                             
===================  =========================  =======  ==============  =========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================


----

WavelengthSolutionPar Keywords
------------------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.WavelengthSolutionPar`

====================  =========================  ======================================================================================================  ================  ===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Key                   Type                       Options                                                                                                 Default           Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
====================  =========================  ======================================================================================================  ================  ===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
``IDpixels``          int, float, list           ..                                                                                                      ..                One or more pixels at which to manually identify a line                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
``IDwaves``           int, float, list           ..                                                                                                      ..                Wavelengths of the manually identified lines                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
``cc_local_thresh``   float                      ..                                                                                                      0.7               Threshold for the *local* cross-correlation coefficient, evaluated at each reidentified line,  between an input spectrum and the shifted and stretched archive spectrum above which a line must be to be considered a good line for reidentification. The local cross-correlation is evaluated at each candidate reidentified line (using a window of nlocal_cc), and is then used to score the the reidentified lines to arrive at the final set of good reidentifications.                                                                                                                                                                                                                                                                                                       
``cc_thresh``         float, list, ndarray       ..                                                                                                      0.7               Threshold for the *global* cross-correlation coefficient between an input spectrum and member of the archive required to attempt reidentification.  Spectra from the archive with a lower cross-correlation are not used for reidentification. This can be a single number or a list/array providing the value for each slit.                                                                                                                                                                                                                                                                                                                                                                                                                                                      
``disp``              float                      ..                                                                                                      0.0               Dispersion. Backwards compatibility with basic and semi-brute algorithms.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
``ech_fix_format``    bool                       ..                                                                                                      True              Is this a fixed format echelle?  If so reidentification will assume that each order in the data is aligned with a single order in the reid arxiv.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
``ech_norder_coeff``  int                        ..                                                                                                      4                 For echelle spectrographs, this is the order of the final 2d fit to the order dimension.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
``ech_nspec_coeff``   int                        ..                                                                                                      4                 For echelle spectrographs, this is the order of the final 2d fit to the spectral dimension.  You should choose this to be the n_final of the fits to the individual orders.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
``ech_sigrej``        int, float                 ..                                                                                                      2.0               For echelle spectrographs, this is the sigma-clipping rejection threshold in the 2d fit to spectral and order dimensions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
``echelle``           bool                       ..                                                                                                      False             Is this an echelle spectrograph? If yes an additional 2-d fit wavelength fit will be performed as a function of spectral pixel and order number to improve the wavelength solution                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
``func``              str                        ..                                                                                                      ``legendre``      Function used for wavelength solution fits                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
``fwhm``              int, float                 ..                                                                                                      4.0               Spectral sampling of the arc lines. This is the FWHM of an arcline in *unbinned* pixels.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
``fwhm_fromlines``    bool                       ..                                                                                                      False             Estimate spectral resolution in each slit using the arc lines. If True, the estimated FWHM will override ``fwhm`` only in the determination of the wavelength solution (i.e. not in WaveTilts).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
``lamps``             list                       ..                                                                                                      ..                Name of one or more ions used for the wavelength calibration.  Use ``None`` for no calibration. Choose ``use_header`` to use the list of lamps recorded in the header of the arc frames (this is currently available only for Keck DEIMOS).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
``match_toler``       float                      ..                                                                                                      2.0               Matching tolerance in pixels when searching for new lines. This is the difference in pixels between the wavlength assigned to an arc line by an iteration of the wavelength solution to the wavelength in the line list.  This parameter is also used as the matching tolerance in pixels for a line reidentification.  A good line match must match within this tolerance to the shifted and stretched archive spectrum, and the archive wavelength solution at this match must be within match_toler dispersion elements from the line in line list.                                                                                                                                                                                                                             
``method``            str                        ``simple``, ``semi-brute``, ``basic``, ``holy-grail``, ``identify``, ``reidentify``, ``full_template``  ``holy-grail``    Method to use to fit the individual arc lines.  Note that most of the available methods should not be used; they are unstable and require significant parameter tweaking to succeed.  You should useeither 'holy-grail' or 'reidentify': 'holy-grail' attempts to get a first guess at line IDs by looking for patterns in the line locations.  It is fully automated.  When it works, it works well; however, it can fail catastrophically.  Instead, 'reidentify' is the preferred method.  It requires an archived wavelength solution for your specific instrument/grating combination as a reference.  This is used to anchor the wavelength solution for the data being reduced.  All options are: simple, semi-brute, basic, holy-grail, identify, reidentify, full_template
``n_final``           int, float, list, ndarray  ..                                                                                                      4                 Order of final fit to the wavelength solution (there are n_final+1 parameters in the fit). This can be a single number or a list/array providing the value for each slit                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
``n_first``           int                        ..                                                                                                      2                 Order of first guess fit to the wavelength solution.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
``nfitpix``           int                        ..                                                                                                      5                 Number of pixels to fit when deriving the centroid of the arc lines (an odd number is best)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
``nlocal_cc``         int                        ..                                                                                                      11                Size of pixel window used for local cross-correlation computation for each arc line. If not an odd number one will be added to it to make it odd.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
``nreid_min``         int                        ..                                                                                                      1                 Minimum number of times that a given candidate reidentified line must be properly matched with a line in the arxiv to be considered a good reidentification. If there is a lot of duplication in the arxiv of the spectra in question (i.e. multislit) set this to a number like 1-4. For echelle this depends on the number of solutions in the arxiv.  Set this to 1 for fixed format echelle spectrographs.  For an echelle with a tiltable grating, this will depend on the number of solutions in the arxiv.                                                                                                                                                                                                                                                                  
``nsnippet``          int                        ..                                                                                                      2                 Number of spectra to chop the arc spectrum into when ``method`` is 'full_template'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
``numsearch``         int                        ..                                                                                                      20                Number of brightest arc lines to search for in preliminary identification                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
``reference``         str                        ``arc``, ``sky``, ``pixel``                                                                             ``arc``           Perform wavelength calibration with an arc, sky frame.  Use 'pixel' for no wavelength solution.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
``refframe``          str                        ``observed``, ``heliocentric``, ``barycentric``                                                         ``heliocentric``  Frame of reference for the wavelength calibration.  Options are: observed, heliocentric, barycentric                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
``reid_arxiv``        str                        ..                                                                                                      ..                Name of the archival wavelength solution file that will be used for the wavelength reidentification.  Only used if ``method`` is 'reidentify'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
``rms_threshold``     float, list, ndarray       ..                                                                                                      0.15              Minimum RMS for keeping a slit/order solution. This can be a single number or a list/array providing the value for each slit. Only used if ``method`` is either 'holy-grail' or 'reidentify'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
``sigdetect``         int, float, list, ndarray  ..                                                                                                      5.0               Sigma threshold above fluctuations for arc-line detection.  Arcs are continuum subtracted and the fluctuations are computed after continuum subtraction.  This can be a single number or a vector (list or numpy array) that provides the detection threshold for each slit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
``sigrej_final``      float                      ..                                                                                                      3.0               Number of sigma for rejection for the final guess to the wavelength solution.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
``sigrej_first``      float                      ..                                                                                                      2.0               Number of sigma for rejection for the first guess to the wavelength solution.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
``use_instr_flag``    bool                       ..                                                                                                      False             If True, restrict to lines matching the instrument.  WARNING: This is only implemented for shane_kast_red + HolyGrail.  Do not use it unless you really know what you are doing.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
``wv_cen``            float                      ..                                                                                                      0.0               Central wavelength. Backwards compatibility with basic and semi-brute algorithms.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
``wvrng_arxiv``       list                       ..                                                                                                      ..                Cut the arxiv template down to this specified wavelength range [min,max]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
====================  =========================  ======================================================================================================  ================  ===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================


----

Coadd1DPar Keywords
-------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.Coadd1DPar`

====================  ==========  =======  ==========  =============================================================================================================================================================================================================================================================================================================================================================================================================================
Key                   Type        Options  Default     Description                                                                                                                                                                                                                                                                                                                                                                                                                  
====================  ==========  =======  ==========  =============================================================================================================================================================================================================================================================================================================================================================================================================================
``coaddfile``         str         ..       ..          Output filename                                                                                                                                                                                                                                                                                                                                                                                                              
``ex_value``          str         ..       ``OPT``     The extraction to coadd, i.e. optimal or boxcar. Must be either 'OPT' or 'BOX'                                                                                                                                                                                                                                                                                                                                               
``filter``            str         ..       ``none``    Filter for scaling.  See flux_calib.load_fitler_file() for naming.  Ignore if none                                                                                                                                                                                                                                                                                                                                           
``filter_mag``        float       ..       ..          Magnitude of the source in the given filter                                                                                                                                                                                                                                                                                                                                                                                  
``filter_mask``       str, list   ..       ..          List of wavelength regions to mask when doing the scaling (ie. occasional junk pixels).Colon and comma separateed, e.g.   5552:5559,6010:6030                                                                                                                                                                                                                                                                                
``flux_value``        bool        ..       True        If True (default), the code will coadd the fluxed spectra (i.e. the FLAM) in the spec1d files. If False, it will coadd the counts.                                                                                                                                                                                                                                                                                           
``lower``             int, float  ..       3.0         Lower rejection threshold used for rejecting pixels when combining spectra in units of sigma.                                                                                                                                                                                                                                                                                                                                
``mag_type``          str         ..       ``AB``      Magnitude type.  AB is the only option currently allowed                                                                                                                                                                                                                                                                                                                                                                     
``maxiter_reject``    int         ..       5           maximum number of iterations for stacking and rejection. The code stops iterating either when the output mask does not change betweeen successive iterations or when maxiter_reject is reached.                                                                                                                                                                                                                              
``maxiter_scale``     int         ..       5           Maximum number of iterations performed for rescaling spectra.                                                                                                                                                                                                                                                                                                                                                                
``maxrej``            int         ..       ..          Coadding performs iterative rejection by comparing each exposure to a preliminary stack of all the exposures. If this parameter is set then it will not reject more than maxrej pixels per iteration of this rejection. The default is None, which means no maximum on rejected pixels.                                                                                                                                      
``nbest``             int         ..       ..          Number of orders to use for estimating the per exposure weights. Default is None, which will just use one fourth of the total number of orders. This is only used for Echelle                                                                                                                                                                                                                                                
``nmaskedge``         int         ..       2           Number of edge pixels to mask. This should be removed/fixed.                                                                                                                                                                                                                                                                                                                                                                 
``ref_percentile``    int, float  ..       70.0        Percentile used for selecting the minimum SNR cut from a reference spectrum used to robustly determine the median ratio between spectra. This parameter is used by coadd1d.robust_median_ratio as part of the automatic rescaling procedure. Pixels above this percentile cut are deemed the "good" pixels and are used to compute the ratio of two spectra.  This must be a number between 0 and 100.                       
``scale_method``      str         ..       ``auto``    Method used to rescale the spectra prior to coadding. The options are: 'auto' -- Determine the scaling method automatically based on the S/N ratio which works well'poly' -- Polynomial rescaling.'median' -- Median rescaling'none' -- Do not rescale.'hand' -- Pass in hand scaling factors. This option is not well tested.                                                                                               
``sensfuncfile``      str         ..       ..          File containing sensitivity function which is a requirement for echelle coadds. This is only used for Echelle                                                                                                                                                                                                                                                                                                                
``sigrej_scale``      int, float  ..       3.0         Rejection threshold used for rejecting pixels when rescaling spectra with scale_spec.                                                                                                                                                                                                                                                                                                                                        
``sn_clip``           int, float  ..       30.0        Errors are capped during rejection so that the S/N is never greater than sn_clip. This prevents overly aggressive rejection in high S/N ratio spectrum which neverthless differ at a level greater than the formal S/N due to systematics.                                                                                                                                                                                   
``sn_min_medscale``   int, float  ..       0.5         For scale method set to 'auto', this sets the minimum SNR for which median scaling is attempted                                                                                                                                                                                                                                                                                                                              
``sn_min_polyscale``  int, float  ..       2.0         For scale method set to 'auto', this sets the minimum SNR for which polynomial scaling is attempted.                                                                                                                                                                                                                                                                                                                         
``sn_smooth_npix``    int, float  ..       ..          Number of pixels to median filter by when computing S/N used to decide how to scale and weight spectra. If set to None (default), the code will determine the effective number of good pixels per spectrum in the stack that is being co-added and use 10% of this neff.                                                                                                                                                     
``spec_samp_fact``    float       ..       1.0         Make the wavelength grid  sampling finer (spec_samp_fact < 1.0) or coarser (spec_samp_fact > 1.0) by this sampling factor. This basically multiples the 'native' spectral pixels by spec_samp_fact, i.e. units spec_samp_fact are pixels.                                                                                                                                                                                    
``upper``             int, float  ..       3.0         Upper rejection threshold used for rejecting pixels when combining spectra in units of sigma.                                                                                                                                                                                                                                                                                                                                
``wave_method``       str         ..       ``linear``  Method used to construct wavelength grid for coadding spectra. The routine that creates the wavelength is :func:`~pypeit.core.wavecal.wvutils.get_wave_grid`. The options are: 'iref' -- Use the first wavelength array'velocity' -- Grid is uniform in velocity'log10' -- Grid is uniform in log10(wave).This is the same as velocity.'linear' -- Grid is uniform in lamba.'concatenate' -- Meld the input wavelength arrays
====================  ==========  =======  ==========  =============================================================================================================================================================================================================================================================================================================================================================================================================================


----

Coadd2DPar Keywords
-------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.Coadd2DPar`

====================  =========  =======  ========  ===========================================================================
Key                   Type       Options  Default   Description                                                                
====================  =========  =======  ========  ===========================================================================
``offsets``           list       ..       ..        User-input list of offsets for the images being combined (spat pixels).    
``use_slits4wvgrid``  bool       ..       False     If True, use the slits to set the trace down the center                    
``weights``           str, list  ..       ``auto``  Mode for the weights used to coadd images.  See coadd2d.py for all options.
====================  =========  =======  ========  ===========================================================================


----

Collate1DPar Keywords
---------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.Collate1DPar`

=========================  ==========  =======  ============================================  ==============================================================================================================================================================================================================================================================================================================================================================================================================
Key                        Type        Options  Default                                       Description                                                                                                                                                                                                                                                                                                                                                                                                   
=========================  ==========  =======  ============================================  ==============================================================================================================================================================================================================================================================================================================================================================================================================
``archive_root``           str         ..       ..                                            The path where files and metadata will be archived.                                                                                                                                                                                                                                                                                                                                                           
``dry_run``                bool        ..       False                                         If set, the script will display the matching File and Object Ids but will not flux, coadd or archive.                                                                                                                                                                                                                                                                                                         
``exclude_serendip``       bool        ..       False                                         Whether to exclude SERENDIP objects from collating.                                                                                                                                                                                                                                                                                                                                                           
``exclude_slit_trace_bm``  list, str   ..       []                                            A list of slit trace bitmask bits that should be excluded.                                                                                                                                                                                                                                                                                                                                                    
``match_using``            str         ..       ``ra/dec``                                    Determines how 1D spectra are matched as being the same object. Must be either 'pixel' or 'ra/dec'.                                                                                                                                                                                                                                                                                                           
``outdir``                 str         ..       ``/Users/westfall/Work/packages/pypeit/doc``  The path where all coadded output files and report files will be placed.                                                                                                                                                                                                                                                                                                                                      
``pypeit_file``            str         ..       ..                                            A .pypeit file to place into the archive. Only used if archive_root is specified. Defaults to looking in the parent directory of the spec1d files.                                                                                                                                                                                                                                                            
``tolerance``              str, float  ..       ``3.0``                                       The tolerance used when comparing the coordinates of objects. If two objects are within this distance from each other, they are considered the same object. If match_using is 'ra/dec' (the default) this is an angular distance. The defaults units are arcseconds but other units supported by astropy.coordinates.Angle can be used(e.g. '0.003d' or '0h1m30s'). If match_using is 'pixel' this is a float.
=========================  ==========  =======  ============================================  ==============================================================================================================================================================================================================================================================================================================================================================================================================


----

FlexurePar Keywords
-------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.FlexurePar`

=================  ==========  =================================  ==============================================================================  ======================================================================================================================================================================================================================
Key                Type        Options                            Default                                                                         Description                                                                                                                                                                                                           
=================  ==========  =================================  ==============================================================================  ======================================================================================================================================================================================================================
``multi_min_SN``   int, float  ..                                 1                                                                               Minimum S/N for analyzing sky spectrum for flexure                                                                                                                                                                    
``spec_maxshift``  int, float  ..                                 20                                                                              Maximum allowed spectral flexure shift in pixels.                                                                                                                                                                     
``spec_method``    str         ``boxcar``, ``slitcen``, ``skip``  ``skip``                                                                        Method used to correct for flexure. Use skip for no correction.  If slitcen is used, the flexure correction is performed before the extraction of objects (not recommended).  Options are: None, boxcar, slitcen, skip
``spectrum``       str         ..                                 ``/Users/westfall/Work/packages/pypeit/pypeit/data/sky_spec/paranal_sky.fits``  Archive sky spectrum to be used for the flexure correction.                                                                                                                                                           
=================  ==========  =================================  ==============================================================================  ======================================================================================================================================================================================================================


----

FluxCalibratePar Keywords
-------------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.FluxCalibratePar`

===================  ====  =======  =======  =============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Key                  Type  Options  Default  Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
===================  ====  =======  =======  =============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
``extinct_correct``  bool  ..       ..       The default behavior for atmospheric extinction corrections is that if UVIS algorithm is used (which does not correct for telluric absorption) than an atmospheric extinction model is used to correct for extinction below 10000A, whereas if the IR algorithm is used, then no extinction correction is applied since the atmosphere is modeled directly. To follow thesedefaults based on the algorithm this parameter should be set to extinct_correct=None. If instead this parameter is set, this overide this default behavior. In other words, it will force an extinction correctionif extinct_correct=True, and will not perform an extinction correction if extinct_correct=False.
``extrap_sens``      bool  ..       False    If False (default), the code will barf if one tries to use sensfunc at wavelengths outside its defined domain. By changing the par['sensfunc']['extrap_blu'] and par['sensfunc']['extrap_red'] this domain can be extended. If True the code will blindly extrapolate.                                                                                                                                                                                                                                                                                                                                                                                                                       
===================  ====  =======  =======  =============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================


----

ReduxPar Keywords
-----------------

Class Instantiation: :class:`pypeit.par.pypeitpar.ReduxPar`

======================  ==========  =======  ============================================  ==============================================================================================================================================================================================================================================================================
Key                     Type        Options  Default                                       Description                                                                                                                                                                                                                                                                   
======================  ==========  =======  ============================================  ==============================================================================================================================================================================================================================================================================
``calwin``              int, float  ..       0                                             The window of time in hours to search for calibration frames for a science frame                                                                                                                                                                                              
``detnum``              int, list   ..       ..                                            Restrict reduction to a list of detector indices.This cannot (and should not) be used with slitspatnum.                                                                                                                                                                       
``ignore_bad_headers``  bool        ..       False                                         Ignore bad headers (NOT recommended unless you know it is safe).                                                                                                                                                                                                              
``qadir``               str         ..       ``QA``                                        Directory relative to calling directory to write quality assessment files.                                                                                                                                                                                                    
``redux_path``          str         ..       ``/Users/westfall/Work/packages/pypeit/doc``  Path to folder for performing reductions.  Default is the current working directory.                                                                                                                                                                                          
``scidir``              str         ..       ``Science``                                   Directory relative to calling directory to write science files.                                                                                                                                                                                                               
``slitspatnum``         str, list   ..       ..                                            Restrict reduction to a set of slit DET:SPAT values (closest slit is used). Example syntax -- slitspatnum = 1:175,1:205   If you are re-running the code, (i.e. modifying one slit) you *must* have the precise SPAT_ID index.This cannot (and should not) be used with detnum
``sortroot``            str         ..       ..                                            A filename given to output the details of the sorted files.  If None, the default is the root name of the pypeit file.  If off, no output is produced.                                                                                                                        
``spectrograph``        str         ..       ..                                            Spectrograph that provided the data to be reduced.  See :ref:`instruments` for valid options.                                                                                                                                                                                 
======================  ==========  =======  ============================================  ==============================================================================================================================================================================================================================================================================


----

ReducePar Keywords
------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.ReducePar`

==============  ===========================================  =======  =========================  =========================================================================
Key             Type                                         Options  Default                    Description                                                              
==============  ===========================================  =======  =========================  =========================================================================
``cube``        :class:`pypeit.par.pypeitpar.CubePar`        ..       `CubePar Keywords`_        Parameters for cube generation algorithms                                
``extraction``  :class:`pypeit.par.pypeitpar.ExtractionPar`  ..       `ExtractionPar Keywords`_  Parameters for extraction algorithms                                     
``findobj``     :class:`pypeit.par.pypeitpar.FindObjPar`     ..       `FindObjPar Keywords`_     Parameters for the find object and tracing algorithms                    
``skysub``      :class:`pypeit.par.pypeitpar.SkySubPar`      ..       `SkySubPar Keywords`_      Parameters for sky subtraction algorithms                                
``slitmask``    :class:`pypeit.par.pypeitpar.SlitMaskPar`    ..       `SlitMaskPar Keywords`_    Parameters for slitmask                                                  
``trim_edge``   list                                         ..       0, 0                       Trim the slit by this number of pixels left/right when performing sky sub
==============  ===========================================  =======  =========================  =========================================================================


----

CubePar Keywords
----------------

Class Instantiation: :class:`pypeit.par.pypeitpar.CubePar`

====================  =====  =======  =================  ===============================================================================================================================================================================================================================================================================================================
Key                   Type   Options  Default            Description                                                                                                                                                                                                                                                                                                    
====================  =====  =======  =================  ===============================================================================================================================================================================================================================================================================================================
``astrometric``       bool   ..       True               If true, an astrometric correction will be applied using the alignment frames.                                                                                                                                                                                                                                 
``combine``           bool   ..       True               If set to True, the input frames will be combined. Otherwise, a separatedatacube will be generated for each input spec2d file.                                                                                                                                                                                 
``dec_max``           float  ..       ..                 Maximum DEC to use when generating the WCS. If None, the default is maximum DECbased on the WCS of all spaxels. Units should be degrees.                                                                                                                                                                       
``dec_min``           float  ..       ..                 Minimum DEC to use when generating the WCS. If None, the default is minimum DECbased on the WCS of all spaxels. Units should be degrees.                                                                                                                                                                       
``flux_calibrate``    bool   ..       False              Flux calibrate the data? If True, you must also provide a standard starcube using the standard_cube parameter.                                                                                                                                                                                                 
``output_filename``   str    ..       ``datacube.fits``  Output filename of the combined datacube.                                                                                                                                                                                                                                                                      
``ra_max``            float  ..       ..                 Maximum RA to use when generating the WCS. If None, the default is maximum RAbased on the WCS of all spaxels. Units should be degrees.                                                                                                                                                                         
``ra_min``            float  ..       ..                 Minimum RA to use when generating the WCS. If None, the default is minimum RAbased on the WCS of all spaxels. Units should be degrees.                                                                                                                                                                         
``reference_image``   str    ..       ..                 White light image of a previously combined datacube. The white lightimage will be used as a reference when calculating the offsets of theinput spec2d files.                                                                                                                                                   
``relative_weights``  bool   ..       False              If set to True, the combined frames will use a relative weighting scheme.This only works well if there is a common continuum source in the field ofview of all input observations, and is generally only required if highrelative precision is desired.                                                        
``save_whitelight``   bool   ..       False              Save a white light image of the combined datacube. The output filenamewill be given by the "output_filename" variable with a suffix "_whitelight".Note that the white light image collapses the flux along the wavelength axis,so some spaxels in the 2D white light image may have different wavelengthranges.
``slit_spec``         bool   ..       True               If the data use slits in one spatial direction, set this to True.If the data uses fibres for all spaxels, set this to False.                                                                                                                                                                                   
``spatial_delta``     float  ..       ..                 The spatial size of each spaxel to use when generating the WCS (in arcsec).If None, the default is set by the spectrograph file.                                                                                                                                                                               
``standard_cube``     str    ..       ..                 Filename of a standard star datacube. This cube will be used to correctthe relative scales of the slits, and to flux calibrate the sciencedatacube.                                                                                                                                                            
``wave_delta``        float  ..       ..                 The wavelength step to use when generating the WCS (in Angstroms).If None, the default is set by the wavelength solution.                                                                                                                                                                                      
``wave_max``          float  ..       ..                 Maximum wavelength to use when generating the WCS. If None, the default ismaximum wavelength based on the WCS of all spaxels. Units should be Angstroms.                                                                                                                                                       
``wave_min``          float  ..       ..                 Minimum wavelength to use when generating the WCS. If None, the default isminimum wavelength based on the WCS of all spaxels. Units should be Angstroms.                                                                                                                                                       
====================  =====  =======  =================  ===============================================================================================================================================================================================================================================================================================================


----

ExtractionPar Keywords
----------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.ExtractionPar`

====================  =================================================  =======  ===============================  =============================================================================================================================================================================================================================================================================================
Key                   Type                                               Options  Default                          Description                                                                                                                                                                                                                                                                                  
====================  =================================================  =======  ===============================  =============================================================================================================================================================================================================================================================================================
``boxcar_radius``     int, float                                         ..       1.5                              Boxcar radius in arcseconds used for boxcar extraction                                                                                                                                                                                                                                       
``manual``            :class:`pypeit.par.pypeitpar.ManualExtractionPar`  ..       `ManualExtractionPar Keywords`_  Parameters for manual extraction                                                                                                                                                                                                                                                             
``model_full_slit``   bool                                               ..       False                            If True local sky subtraction will be performed on the entire slit. If False, local sky subtraction will be applied to only a restricted region around each object. This should be set to True for either multislit observations using narrow slits or echelle observations with narrow slits
``skip_extraction``   bool                                               ..       False                            Do not perform an object extraction                                                                                                                                                                                                                                                          
``skip_optimal``      bool                                               ..       False                            Perform boxcar extraction only (i.e. skip Optimal and local skysub)                                                                                                                                                                                                                          
``sn_gauss``          int, float                                         ..       4.0                              S/N threshold for performing the more sophisticated optimal extraction which performs a b-spline fit to the object profile. For S/N < sn_gauss the code will simply optimal extractwith a Gaussian with FWHM determined from the object finding.                                             
``std_prof_nsigma``   float                                              ..       30.0                             prof_nsigma parameter for Standard star extraction.  Prevents undesired rejection.                                                                                                                                                                                                           
``use_2dmodel_mask``  bool                                               ..       True                             Mask pixels rejected during profile fitting when extracting.Turning this off may help with bright emission lines.                                                                                                                                                                            
``use_user_fwhm``     bool                                               ..       False                            Boolean indicating if PypeIt should use the FWHM provided by the user (``find_fwhm`` in `FindObjPar`) for the optimal extraction. If this parameter is ``False`` (default), PypeIt estimates the FWHM for each detected object, and uses ``find_fwhm`` as initial guess.                     
====================  =================================================  =======  ===============================  =============================================================================================================================================================================================================================================================================================


----

ManualExtractionPar Keywords
----------------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.ManualExtractionPar`

=============  ===========  =======  =======  ======================================================================================================================================
Key            Type         Options  Default  Description                                                                                                                           
=============  ===========  =======  =======  ======================================================================================================================================
``det``        list, int    ..       ..       List of detectors for hand extraction. This must be a list aligned with the spec_spat list.  Negative values indicate negative images.
``fwhm``       list, float  ..       ..       List of FWHM (in pixels) for hand extraction. This must be a list aligned with spec_spat                                              
``spat_spec``  list, str    ..       ..       List of spatial:spectral positions to hand extract, e.g. "1243.3:1200," or "1243.3:1200,1345:1200                                     
=============  ===========  =======  =======  ======================================================================================================================================


----

FindObjPar Keywords
-------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.FindObjPar`

===========================  ==========  =======  =======  ========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Key                          Type        Options  Default  Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
===========================  ==========  =======  =======  ========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
``cont_sig_thresh``          int, float  ..       2.0      Significance threshold for peak detection for determinining which pixels to use for the iteratively fit continuum of the spectral direction smashed image. This is passed as the sigthresh parameter to core.arc.iter_continum. For extremely narrow slits that are almost filled by the object trace set this to a smaller number like 1.0                                                                                                                                                                                                                                                                                                                                                                             
``ech_find_max_snr``         int, float  ..       1.0      Criteria for keeping echelle objects. They must either have a maximum S/N across all the orders greater than this value or satisfy the min_snr criteria described by the min_snr parameters                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
``ech_find_min_snr``         int, float  ..       0.3      Criteria for keeping echelle objects. They must either have a maximum S/N across all the orders greater than ech_find_max_snr,  value or they must have S/N > ech_find_min_snr on >= ech_find_nabove_min_snr orders                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
``ech_find_nabove_min_snr``  int         ..       2        Criteria for keeping echelle objects. They must either have a maximum S/N across all the orders greater than ech_find_max_snr,  value or they must have S/N > ech_find_min_snr on >= ech_find_nabove_min_snr orders                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
``find_cont_fit``            bool        ..       True     Fit a continuum to the illumination pattern across the trace rectified image (masking objects) when searching for peaks to initially identify objects                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
``find_extrap_npoly``        int         ..       3        Polynomial order used for trace extrapolation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
``find_fwhm``                int, float  ..       5.0      Indicates roughly the fwhm of objects in pixels for object finding                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
``find_maxdev``              int, float  ..       2.0      Maximum deviation of pixels from polynomial fit to trace used to reject bad pixels in trace fitting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
``find_min_max``             list        ..       ..       It defines the minimum and maximum of your object in the spectral direction on thedetector. It only used for object finding. This parameter is helpful if your object onlyhas emission lines or at high redshift and the trace only shows in part of the detector.                                                                                                                                                                                                                                                                                                                                                                                                                                                      
``find_negative``            bool        ..       ..       Identify negative objects in object finding for spectra that are differenced. This is used to manually override the default behavior in PypeIt for object finding by setting this parameter to something other than NoneThe default behavior is that PypeIt will search for negative object traces if background frames are present in the PypeIt file that are classified as "science" (i.e. via pypeit_setup -b, and setting bkg_id in the PypeIt file). If background frames are presentthat are classified as "sky", then PypeIt will NOT search for negative object traces. If one wishesto explicitly override this default behavior, set this parameter to True to find negative objects or False to ignore them.
``find_npoly_cont``          int         ..       1        Polynomial order for fitting continuum to the illumination pattern across the trace rectified image (masking objects) when searching for peaks to initially identify objects                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
``find_trim_edge``           list        ..       5, 5     Trim the slit by this number of pixels left/right before finding objects                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
``maxnumber``                int         ..       10       Maximum number of objects to extract in a science frame.  Use None for no limit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
``sig_thresh``               int, float  ..       10.0     Significance threshold for object finding.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
``skip_second_find``         bool        ..       False    Only perform one round of object finding (mainly for quick_look)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
``trace_npoly``              int         ..       5        Order of legendre polynomial fits to object traces.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
===========================  ==========  =======  =======  ========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================


----

SkySubPar Keywords
------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.SkySubPar`

===================  ==========  =======  =======  ===================================================================================================================================================================================================================================================================================================================================================================================================================
Key                  Type        Options  Default  Description                                                                                                                                                                                                                                                                                                                                                                                                        
===================  ==========  =======  =======  ===================================================================================================================================================================================================================================================================================================================================================================================================================
``bspline_spacing``  int, float  ..       0.6      Break-point spacing for the bspline sky subtraction fits.                                                                                                                                                                                                                                                                                                                                                          
``global_sky_std``   bool        ..       True     Global sky subtraction will be performed on standard stars. This should be turnedoff for example for near-IR reductions with narrow slits, since bright standards canfill the slit causing global sky-subtraction to fail. In these situations we go straight to local sky-subtraction since it is designed to deal with such situations                                                                           
``joint_fit``        bool        ..       False    Perform a simultaneous joint fit to sky regions using all available slits.                                                                                                                                                                                                                                                                                                                                         
``load_mask``        bool        ..       False    Load a user-defined sky regions mask to be used for the sky regions. Note,if you set this to True, you must first run the pypeit_skysub_regions GUIto manually select and store the regions to file.                                                                                                                                                                                                               
``mask_by_boxcar``   bool        ..       False    In global sky evaluation, mask the sky region around the object by the boxcar radius (set in ExtractionPar).                                                                                                                                                                                                                                                                                                       
``no_local_sky``     bool        ..       False    If True, turn off local sky model evaluation, but do fit object profile and perform optimal extraction                                                                                                                                                                                                                                                                                                             
``no_poly``          bool        ..       False    Turn off polynomial basis (Legendre) in global sky subtraction                                                                                                                                                                                                                                                                                                                                                     
``sky_sigrej``       float       ..       3.0      Rejection parameter for local sky subtraction                                                                                                                                                                                                                                                                                                                                                                      
``user_regions``     str, list   ..       ..       A user-defined sky regions mask can be set using this keyword. To allowthe code to identify the sky regions automatically, set this variable toan empty string. If you wish to set the sky regions, The text should bea comma separated list of percentages to apply to _all_ slits For example: The following string   :10,35:65,80:   would select thefirst 10%, the inner 30%, and the final 20% of _all_ slits.
===================  ==========  =======  =======  ===================================================================================================================================================================================================================================================================================================================================================================================================================


----

SlitMaskPar Keywords
--------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.SlitMaskPar`

========================  ==========  =======  =======  ===================================================================================================================================================================================================================================================================================================================================================================
Key                       Type        Options  Default  Description                                                                                                                                                                                                                                                                                                                                                        
========================  ==========  =======  =======  ===================================================================================================================================================================================================================================================================================================================================================================
``assign_obj``            bool        ..       False    If SlitMask object was generated, assign RA,DEC,name to detected objects                                                                                                                                                                                                                                                                                           
``bright_maskdef_id``     int         ..       ..       `maskdef_id` (corresponding to `dSlitId` and `Slit_Number` in the DEIMOS and MOSFIRE slitmask design, respectively) of a slit containing a bright object that will be used to compute the slitmask offset. This parameter is optional and is ignored if ``slitmask_offset`` is provided.                                                                           
``extract_missing_objs``  bool        ..       False    Force extraction of undetected objects at the location expected from the slitmask design. PypeIt will try to determine the FWHM from the flux profile (by using ``find_fwhm`` in `FindObjPar` as initial guess). If the FWHM cannot be determined, ``find_fwhm`` will be assumed.                                                                                  
``nsig_thrshd``           int, float  ..       50.0     Objects detected above this significance threshold will be used to compute the slitmask offset. This is the default behaviour for DEIMOS  unless ``slitmask_offset``, ``bright_maskdef_id`` or ``use_alignbox`` is set.                                                                                                                                            
``obj_toler``             int, float  ..       1.0      If slitmask design information is provided, and slit matching is performed (``use_maskdesign = True`` in ``EdgeTracePar``), this parameter provides the desired tolerance (arcsec) to match sources to targeted objects                                                                                                                                            
``slitmask_offset``       int, float  ..       ..       User-provided slitmask offset (pixels) from the position expected by the slitmask design. This is optional, and if set PypeIt will NOT compute the offset using `nsig_thrshd` or `bright_maskdef_id`.                                                                                                                                                              
``use_alignbox``          bool        ..       False    Use stars in alignment boxes to compute the slitmask offset. If this is set to ``True`` PypeIt will NOT compute the offset using `nsig_thrshd` or `bright_maskdef_id`                                                                                                                                                                                              
``use_dither_offset``     bool        ..       False    Use the dither offset recorded in the header of science frames as the value of the slitmask offset. This is currently only available for Keck MOSFIRE reduction and it is set as the default for this instrument. If set PypeIt will NOT compute the offset using `nsig_thrshd` or `bright_maskdef_id`. However, it is ignored if ``slitmask_offset`` is provided. 
========================  ==========  =======  =======  ===================================================================================================================================================================================================================================================================================================================================================================


----

FrameGroupPar Keywords
----------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.FrameGroupPar`

=============  ==============================================  ==========================================================================================================================================  ============================  ===============================================================================================================================================================================================================================================================
Key            Type                                            Options                                                                                                                                     Default                       Description                                                                                                                                                                                                                                                    
=============  ==============================================  ==========================================================================================================================================  ============================  ===============================================================================================================================================================================================================================================================
``exprng``     list                                            ..                                                                                                                                          None, None                    Used in identifying frames of this type.  This sets the minimum and maximum allowed exposure times.  There must be two items in the list.  Use None to indicate no limit; i.e., to select exposures with any time greater than 30 sec, use exprng = [30, None].
``frametype``  str                                             ``align``, ``arc``, ``bias``, ``dark``, ``pinhole``, ``pixelflat``, ``illumflat``, ``science``, ``standard``, ``trace``, ``tilt``, ``sky``  ``science``                   Frame type.  Options are: align, arc, bias, dark, pinhole, pixelflat, illumflat, science, standard, trace, tilt, sky                                                                                                                                           
``process``    :class:`pypeit.par.pypeitpar.ProcessImagesPar`  ..                                                                                                                                          `ProcessImagesPar Keywords`_  Low level parameters used for basic image processing                                                                                                                                                                                                           
``useframe``   str                                             ..                                                                                                                                          ..                            A master calibrations file to use if it exists.                                                                                                                                                                                                                
=============  ==============================================  ==========================================================================================================================================  ============================  ===============================================================================================================================================================================================================================================================


----

ProcessImagesPar Keywords
-------------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.ProcessImagesPar`

========================  ==========  ======================================  ==========  ===========================================================================================================================================================================================================================================
Key                       Type        Options                                 Default     Description                                                                                                                                                                                                                                
========================  ==========  ======================================  ==========  ===========================================================================================================================================================================================================================================
``apply_gain``            bool        ..                                      True        Convert the ADUs to electrons using the detector gain                                                                                                                                                                                      
``clip``                  bool        ..                                      True        Perform sigma clipping when combining.  Only used with combine=mean                                                                                                                                                                        
``comb_sigrej``           float       ..                                      ..          Sigma-clipping level for when clip=True; Use None for automatic limit (recommended).                                                                                                                                                       
``combine``               str         ``median``, ``mean``                    ``mean``    Method used to combine multiple frames.  Options are: median, mean                                                                                                                                                                         
``empirical_rn``          bool        ..                                      False       If True, use the standard deviation in the overscan region to measure an empirical readnoise to use in the noise model.                                                                                                                    
``grow``                  int, float  ..                                      1.5         Factor by which to expand regions with cosmic rays detected by the LA cosmics routine.                                                                                                                                                     
``lamaxiter``             int         ..                                      1           Maximum number of iterations for LA cosmics routine.                                                                                                                                                                                       
``mask_cr``               bool        ..                                      False       Identify CRs and mask them                                                                                                                                                                                                                 
``n_lohi``                list        ..                                      0, 0        Number of pixels to reject at the lowest and highest ends of the distribution; i.e., n_lohi = low, high.  Use None for no limit.                                                                                                           
``noise_floor``           float       ..                                      0.0         Impose a noise floor by adding the provided fraction of the bias- and dark-subtracted electron counts to the error budget.  E.g., a value of 0.01 means that the S/N of the counts in the image will never be greater than 100.            
``objlim``                int, float  ..                                      3.0         Object detection limit in LA cosmics routine                                                                                                                                                                                               
``orient``                bool        ..                                      True        Orient the raw image into the PypeIt frame                                                                                                                                                                                                 
``overscan_method``       str         ``polynomial``, ``savgol``, ``median``  ``savgol``  Method used to fit the overscan. Options are: polynomial, savgol, median                                                                                                                                                                   
``overscan_par``          int, list   ..                                      5, 65       Parameters for the overscan subtraction.  For 'polynomial', set overcan_par = order, number of pixels, number of repeats ; for 'savgol', set overscan_par = order, window size ; for 'median', set overscan_par = None or omit the keyword.
``rmcompact``             bool        ..                                      True        Remove compact detections in LA cosmics routine                                                                                                                                                                                            
``satpix``                str         ``reject``, ``force``, ``nothing``      ``reject``  Handling of saturated pixels.  Options are: reject, force, nothing                                                                                                                                                                         
``shot_noise``            bool        ..                                      True        Use the bias- and dark-subtracted image to calculate and include electron count shot noise in the image processing error budget                                                                                                            
``sigclip``               int, float  ..                                      4.5         Sigma level for rejection in LA cosmics routine                                                                                                                                                                                            
``sigfrac``               int, float  ..                                      0.3         Fraction for the lower clipping threshold in LA cosmics routine.                                                                                                                                                                           
``spat_flexure_correct``  bool        ..                                      False       Correct slits, illumination flat, etc. for flexure                                                                                                                                                                                         
``trim``                  bool        ..                                      True        Trim the image to the detector supplied region                                                                                                                                                                                             
``use_biasimage``         bool        ..                                      True        Use a bias image.  If True, one or more must be supplied in the PypeIt file.                                                                                                                                                               
``use_darkimage``         bool        ..                                      False       Subtract off a dark image.  If True, one or more darks must be provided.                                                                                                                                                                   
``use_illumflat``         bool        ..                                      True        Use the illumination flat to correct for the illumination profile of each slit.                                                                                                                                                            
``use_overscan``          bool        ..                                      True        Subtract off the overscan.  Detector *must* have one or code will crash.                                                                                                                                                                   
``use_pattern``           bool        ..                                      False       Subtract off a detector pattern. This pattern is assumed to be sinusoidal along one direction, with a frequency that is constant across the detector.                                                                                      
``use_pixelflat``         bool        ..                                      True        Use the pixel flat to make pixel-level corrections.  A pixelflat image must be provied.                                                                                                                                                    
``use_specillum``         bool        ..                                      False       Use the relative spectral illumination profiles to correct the spectral illumination profile of each slit. This is primarily used for IFUs.  To use this, you must set ``slit_illum_relative=True`` in the ``flatfield`` parameter set!    
========================  ==========  ======================================  ==========  ===========================================================================================================================================================================================================================================


----

SensFuncPar Keywords
--------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.SensFuncPar`

==================  =============================================  ================  ===========================  ======================================================================================================================================================================================================================================================================================================================================================================
Key                 Type                                           Options           Default                      Description                                                                                                                                                                                                                                                                                                                                                           
==================  =============================================  ================  ===========================  ======================================================================================================================================================================================================================================================================================================================================================================
``IR``              :class:`pypeit.par.pypeitpar.TelluricPar`      ..                `TelluricPar Keywords`_      Parameters for the IR sensfunc algorithm                                                                                                                                                                                                                                                                                                                              
``UVIS``            :class:`pypeit.par.pypeitpar.SensfuncUVISPar`  ..                `SensfuncUVISPar Keywords`_  Parameters for the UVIS sensfunc algorithm                                                                                                                                                                                                                                                                                                                            
``algorithm``       str                                            ``UVIS``, ``IR``  ``UVIS``                     Specify the algorithm for computing the sensitivity function. The options are:  (1) UVIS = Should be used for data with lambda < 7000A.No detailed model of telluric absorption but corrects for atmospheric extinction. (2) IR = Should be used for data with lambbda > 7000A.Peforms joint fit for sensitivity function and telluric absorption using HITRAN models.
``extrap_blu``      float                                          ..                0.1                          Fraction of minimum wavelength coverage to grow the wavelength coverage of the sensitivitity function in the blue direction, i.e. if the standard star spectrumcuts off at wave_min, the sensfunc will be extrapolated to cover down to  (1.0-extrap_blu)*wave_min                                                                                                    
``extrap_red``      float                                          ..                0.1                          Fraction of maximum wavelength coverage to grow the wavelength coverage of the sensitivitity function in the red direction, i.e. if the standard star spectrumcuts off at wave_max, the sensfunc will be extrapolated to cover up to  (1.0 + extrap_red)*wave_max                                                                                                     
``mask_abs_lines``  bool                                           ..                True                         Mask Balmer, Paschen, Brackett, and Pfund lines in sensitivity function fit                                                                                                                                                                                                                                                                                           
``multi_spec_det``  list                                           ..                ..                           List of detector numbers to splice together for multi-detector instruments (e.g. DEIMOS, GMOS). It is assumed that there is *no* overlap in wavelength across detectors (might be ok if there is)                                                                                                                                                                     
``polyorder``       int, list                                      ..                5                            Polynomial order for sensitivity function fitting                                                                                                                                                                                                                                                                                                                     
``samp_fact``       float                                          ..                1.5                          sampling factor to make the wavelength grid for sensitivity function finer or coarser.  samp_fact > 1.0 oversamples (finer), samp_fact < 1.0 undersamples (coarser).                                                                                                                                                                                                  
``star_dec``        float                                          ..                ..                           DEC of the standard star. This will override values in the header, i.e. if they are wrong or absent                                                                                                                                                                                                                                                                   
``star_mag``        float                                          ..                ..                           Magnitude of the standard star (for near-IR mainly)                                                                                                                                                                                                                                                                                                                   
``star_ra``         float                                          ..                ..                           RA of the standard star. This will override values in the header, i.e. if they are wrong or absent                                                                                                                                                                                                                                                                    
``star_type``       str                                            ..                ..                           Spectral type of the standard star (for near-IR mainly)                                                                                                                                                                                                                                                                                                               
==================  =============================================  ================  ===========================  ======================================================================================================================================================================================================================================================================================================================================================================


----

SensfuncUVISPar Keywords
------------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.SensfuncUVISPar`

====================  ==========  =======  =======  ============================================================================================================================================================================================================================
Key                   Type        Options  Default  Description                                                                                                                                                                                                                 
====================  ==========  =======  =======  ============================================================================================================================================================================================================================
``balm_mask_wid``     float       ..       10.0     Mask width for Balmer lines in Angstroms.                                                                                                                                                                                   
``extinct_correct``   bool        ..       True     If extinct_correct=True the code will use an atmospheric extinction model to extinction correct the data below 10000A. Note that this correction makes no sense if one is telluric correcting and this shold be set to False
``nresln``            int, float  ..       20       Parameter governing the spacing of the bspline breakpoints.                                                                                                                                                                 
``polycorrect``       bool        ..       True     Whether you want to correct the sensfunc with polynomial in the telluric and recombination line regions                                                                                                                     
``polyfunc``          bool        ..       False    Whether you want to use the polynomial fit as your final SENSFUNC                                                                                                                                                           
``resolution``        int, float  ..       3000.0   Expected resolution of the standard star spectrum. This should be measured from the data.                                                                                                                                   
``sensfunc``          str         ..       ..       FITS file that contains or will contain the sensitivity function.                                                                                                                                                           
``std_file``          str         ..       ..       Standard star file to generate sensfunc                                                                                                                                                                                     
``std_obj_id``        str, int    ..       ..       Specifies object in spec1d file to use as standard. The brightest object found is used otherwise.                                                                                                                           
``telluric``          bool        ..       False    If telluric=True the code creates a synthetic standard star spectrum using the Kurucz models, the sens func is created setting nresln=1.5 it contains the correction for telluric lines.                                    
``telluric_correct``  bool        ..       False    If telluric_correct=True the code will grab the sens_dict['telluric'] tag from the sensfunc dictionary and apply it to the data.                                                                                            
``trans_thresh``      float       ..       0.9      Parameter for selecting telluric regions which are masked. Locations below this transmission value are masked. If you have significant telluric absorption you should be using telluric.sensnfunc_telluric                  
====================  ==========  =======  =======  ============================================================================================================================================================================================================================


----

TelluricPar Keywords
--------------------

Class Instantiation: :class:`pypeit.par.pypeitpar.TelluricPar`

=======================  ==================  =======  ===========================================================================================  =================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Key                      Type                Options  Default                                                                                      Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
=======================  ==================  =======  ===========================================================================================  =================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
``bal_wv_min_max``       list, ndarray       ..       ..                                                                                           Min/max wavelength of broad absorption features. If there are several BAL features, the format for this mask is [wave_min_bal1, wave_max_bal1,wave_min_bal2, wave_max_bal2,...]. These masked pixels will be ignored during the fitting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
``bounds_norm``          tuple               ..       0.1, 3.0                                                                                     Normalization bounds for scaling the initial object model.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
``delta_coeff_bounds``   tuple               ..       -20.0, 20.0                                                                                  Parameters setting the polynomial coefficient bounds for sensfunc optimization.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
``delta_redshift``       float               ..       0.1                                                                                          Range within the redshift can be varied for telluric fitting, i.e. the code performs a bounded optimization withinthe redshift +- delta_redshift                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
``disp``                 bool                ..       False                                                                                        Argument for scipy.optimize.differential_evolution which will  display status messages to the screen indicating the status of the optimization. See documentation for telluric.Telluric for a description of the output and how to know if things are working well.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
``fit_wv_min_max``       list                ..       ..                                                                                           Pixels within this mask will be used during the fitting. The formatis the same with bal_wv_min_max, but this mask is good pixel masks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
``func``                 str                 ..       ``legendre``                                                                                 Polynomial model function                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
``lower``                int, float          ..       3.0                                                                                          Lower rejection threshold in units of sigma_corr*sigma, where sigma is the formal noise of the spectrum, and sigma_corr is an empirically determined correction to the formal error. The distribution of input chi (defined by chi = (data - model)/sigma) values is analyzed, and a correction factor to the formal error sigma_corr is returned which is multiplied into the formal errors. In this way, a rejection threshold of i.e. 3-sigma, will always correspond to roughly the same percentile.  This renormalization is performed with coadd1d.renormalize_errors function, and guarantees that rejection is not too agressive in cases where the empirical errors determined from the chi-distribution differ significantly from the formal noise which is used to determine chi.                                                                                                                     
``mask_abs_lines``       bool                ..       True                                                                                         Mask stellar absorption line?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
``mask_lyman_a``         bool                ..       True                                                                                         Mask the blueward of Lyman-alpha line during the fitting?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
``maxiter``              int                 ..       2                                                                                            Maximum number of iterations for the telluric + object model fitting. The code performs multiple iterations rejecting outliers at each step. The fit is then performed anew to the remaining good pixels. For this reason if you run with the disp=True option, you will see that the f(x) loss function gets progressively better during the iterations.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
``minmax_coeff_bounds``  tuple               ..       -5.0, 5.0                                                                                    Parameters setting the polynomial coefficient bounds for sensfunc optimization.Bounds are currently determined as follows. We compute an initial fit to the sensfunc in the pypeit.core.telluric.init_sensfunc_model function. That deterines a set of coefficients. The bounds are then determined according to: [(np.fmin(np.abs(this_coeff)*obj_params['delta_coeff_bounds'][0], obj_params['minmax_coeff_bounds'][0]), np.fmax(np.abs(this_coeff)*obj_params['delta_coeff_bounds'][1],obj_params['minmax_coeff_bounds'][1]))]                                                                                                                                                                                                                                                                                                                                                                                
``model``                str                 ..       ``exp``                                                                                      Types of polynomial model. Options are poly, square, exp corresponding to normal polynomial,squared polynomial, or exponentiated polynomial                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
``npca``                 int                 ..       8                                                                                            Number of pca for the objmodel=qso qso PCA fit                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
``objmodel``             str                 ..       ..                                                                                           The object model to be used for telluric fitting. Currently the options are: qso, star, and poly                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
``only_orders``          int, list, ndarray  ..       ..                                                                                           Order number, or list of order numbers if you only want to fit specific orders                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
``pca_file``             str                 ..       ``/Users/westfall/Work/packages/pypeit/pypeit/data/telluric/models/qso_pca_1200_3100.fits``  Fits file containing quasar PCA model. Needed for objmodel=qso                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
``pca_lower``            int, float          ..       1220.0                                                                                       Minimum wavelength for the qso pca model                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
``pca_upper``            int, float          ..       3100.0                                                                                       Maximum wavelength for the qso pca model                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
``pix_shift_bounds``     tuple               ..       -5.0, 5.0                                                                                     Bounds for the pixel shift optimization in telluric model fit in units of pixels. The atmosphere will be allowed to shift within this range during the fit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
``polish``               bool                ..       True                                                                                         If True then differential evolution will perform an additional optimizatino at the end to polish the best fit at the end, which can improve the optimization slightly. See scipy.optimize.differential_evolution for details.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
``polyorder``            int                 ..       3                                                                                            Order of the polynomial model fit                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
``popsize``              int                 ..       30                                                                                           A multiplier for setting the total population size for the differential evolution optimization. See scipy.optimize.differential_evolution for details.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
``recombination``        int, float          ..       0.7                                                                                          The recombination constant for the differential evolution optimization. This should be in the range [0, 1]. See scipy.optimize.differential_evolution for details.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
``redshift``             int, float          ..       0.0                                                                                          The redshift for the object model. This is currently only used by objmodel=qso                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
``resln_frac_bounds``    tuple               ..       0.5, 1.5                                                                                     Bounds for the resolution fit optimization which is part of the telluric model. This range is in units of the resln_guess, so the (0.5, 1.5) would bound the spectral resolution fit to be within the range bounds_resln = (0.5*resln_guess, 1.5*resln_guess)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
``resln_guess``          int, float          ..       ..                                                                                           A guess for the resolution of your spectrum expressed as lambda/dlambda. The resolution is fit explicitly as part of the telluric model fitting, but this guess helps determine the bounds for the optimization (see next). If not provided, the  wavelength sampling of your spectrum will be used and the resolution calculated using a typical sampling of 3 spectral pixels per resolution element.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
``seed``                 int                 ..       777                                                                                          An initial seed for the differential evolution optimization, which is a random process. The default is a seed = 777 which will be used to generate a unique seed for every order. A specific seed is used because otherwise the random number generator will use the time for the seed, and the results will not be reproducible.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
``sn_clip``              int, float          ..       30.0                                                                                         This adds an error floor to the ivar, preventing too much rejection at high-S/N (i.e. standard stars, bright objects) using the function utils.clip_ivar. A small erorr is added to the input ivar so that the output ivar_out will never give S/N greater than sn_clip. This prevents overly aggressive rejection in high S/N ratio spectra which neverthless differ at a level greater than the formal S/N due to the fact that our telluric models are only good to about 3%.                                                                                                                                                                                                                                                                                                                                                                                                                                 
``star_dec``             float               ..       ..                                                                                           Object declination in decimal deg                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
``star_mag``             float, int          ..       ..                                                                                           AB magnitude in V band                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
``star_ra``              float               ..       ..                                                                                           Object right-ascension in decimal deg                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
``star_type``            str                 ..       ..                                                                                           stellar type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
``sticky``               bool                ..       True                                                                                         Sticky parameter for the utils.djs_reject algorithm for iterative model fit rejection.  If set to True then points rejected from a previous iteration are kept rejected, in other words the bad pixel mask is the OR of all previous iterations and rejected pixels accumulate. If set to False, the bad pixel mask is the mask from the previous iteration, and if the model fit changes between iterations, points can alternate from being rejected to not rejected. At present this code only performs optimizations with differential evolution and experience shows that sticky needs to be True in order for these to converge. This is because the outliers can be so large that they dominate the loss function, and one never iteratively converges to a good model fit. In other words, the deformations in the model between iterations with sticky=False are too small to approach a reasonable fit.
``telgridfile``          str                 ..       ..                                                                                           File containing the telluric grid for the observatory in question. These grids are generated from HITRAN models for each observatory using nominal site parameters. They must be downloaded from the GoogleDrive and stored in PypeIt/pypeit/data/telluric/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
``tell_norm_thresh``     int, float          ..       0.9                                                                                          Threshold of telluric absorption region                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
``tol``                  float               ..       0.001                                                                                        Relative tolerance for converage of the differential evolution optimization. See scipy.optimize.differential_evolution for details.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
``upper``                int, float          ..       3.0                                                                                          Upper rejection threshold in units of sigma_corr*sigma, where sigma is the formal noise of the spectrum, and sigma_corr is an empirically determined correction to the formal error. See above for description.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
=======================  ==================  =======  ===========================================================================================  =================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================



 .. _instr_par:

Instrument-Specific Default Configuration
+++++++++++++++++++++++++++++++++++++++++

The following provides the changes to the global default parameters
provided above for each instrument.  That is, if one were to include
these in the PypeIt file, you would be reproducing the effect of the
`default_pypeit_par` method specific to each derived
:class:`pypeit.spectrographs.spectrograph.Spectrograph` class.

BOK BC (``bok_bc``)
-------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = bok_bc
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = None, 120
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          exprng = None, 120
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[wavelengths]]
          lamps = NeI, ArI, ArII, HeI
          fwhm = 5.0
          rms_threshold = 0.5
      [[slitedges]]
          sync_predict = nearest
  [scienceframe]
      exprng = 90, None
      [[process]]
          mask_cr = True
          sigclip = 5.0
          objlim = 2.0
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[findobj]]
          sig_thresh = 5.0
      [[skysub]]
          sky_sigrej = 5.0
          global_sky_std = False
          no_poly = True
  [sensfunc]
      polyorder = 7

GEMINI-S FLAMINGOS (``gemini_flamingos1``)
------------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = gemini_flamingos1
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 20, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 1, 50
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          exprng = None, 60
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[wavelengths]]
          method = full_template
          lamps = ArI, ArII, ThAr, NeI
          sigdetect = 3
          fwhm = 20
          reid_arxiv = magellan_fire_long.fits
          rms_threshold = 1.0
          match_toler = 5.0
      [[slitedges]]
          trace_thresh = 5.0
          sync_predict = nearest
      [[tilts]]
          tracethresh = 5
  [scienceframe]
      exprng = 20, None
      [[process]]
          mask_cr = True
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[findobj]]
          sig_thresh = 5.0
          find_trim_edge = 50, 50

GEMINI-S FLAMINGOS (``gemini_flamingos2``)
------------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = gemini_flamingos2
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 20, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 50, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          exprng = 50, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          exprng = None, 30
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[wavelengths]]
          lamps = OH_NIRES
          fwhm = 5
          rms_threshold = 0.5
          match_toler = 5.0
      [[slitedges]]
          edge_thresh = 200.0
          fit_min_spec_length = 0.4
          trace_thresh = 10.0
          sync_predict = nearest
      [[tilts]]
          tracethresh = 5
          spat_order = 4
  [scienceframe]
      exprng = 20, None
      [[process]]
          mask_cr = True
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[findobj]]
          sig_thresh = 5.0
          find_trim_edge = 10, 10
      [[skysub]]
          sky_sigrej = 5.0
  [sensfunc]
      algorithm = IR
      polyorder = 8
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_LasCampanas_3100_26100_R20000.fits

GEMINI-N GMOS-N (``gemini_gmos_north_e2v``)
-------------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = gemini_gmos_north_e2v
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = CuI, ArI, ArII
          rms_threshold = 0.4
          nsnippet = 1
      [[slitedges]]
          fit_order = 3
      [[tilts]]
          tracethresh = 10.0
  [scienceframe]
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar
  [sensfunc]
      multi_spec_det = 1, 2, 3

GEMINI-N GMOS-N (``gemini_gmos_north_ham``)
-------------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = gemini_gmos_north_ham
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = CuI, ArI, ArII
          rms_threshold = 0.4
          nsnippet = 1
      [[slitedges]]
          fit_order = 3
      [[tilts]]
          tracethresh = 10.0
  [scienceframe]
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar
  [sensfunc]
      multi_spec_det = 1, 2, 3

GEMINI-N GMOS-N (``gemini_gmos_north_ham_ns``)
----------------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = gemini_gmos_north_ham_ns
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = CuI, ArI, ArII
          rms_threshold = 0.4
          nsnippet = 1
      [[slitedges]]
          fit_order = 3
      [[tilts]]
          tracethresh = 10.0
  [scienceframe]
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar
  [sensfunc]
      multi_spec_det = 1, 2, 3

GEMINI-S GMOS-S (``gemini_gmos_south_ham``)
-------------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = gemini_gmos_south_ham
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = CuI, ArI, ArII
          rms_threshold = 0.4
          nsnippet = 1
      [[slitedges]]
          fit_order = 3
          bound_detector = True
      [[tilts]]
          tracethresh = 10.0
  [scienceframe]
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar
  [sensfunc]
      multi_spec_det = 1, 2, 3
      algorithm = IR
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_LasCampanas_3100_26100_R20000.fits

GEMINI-N GNIRS (``gemini_gnirs``)
---------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = gemini_gnirs
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = None, 30
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = None, 30
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          exprng = None, 30
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[flatfield]]
          tweak_slits_thresh = 0.9
  [scienceframe]
      exprng = 30, None
      [[process]]
          mask_cr = True
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[findobj]]
          sig_thresh = 5.0
          find_trim_edge = 2, 2
          find_cont_fit = False
          find_npoly_cont = 0
      [[skysub]]
          bspline_spacing = 0.8
          global_sky_std = False
          no_poly = True
      [[extraction]]
          model_full_slit = True
  [sensfunc]
      algorithm = IR
      polyorder = 6
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_MaunaKea_3100_26100_R20000.fits

GTC OSIRIS (``gtc_osiris``)
---------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = gtc_osiris
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              clip = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
          [[[process]]]
              use_overscan = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_overscan = False
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 120
          [[[process]]]
              mask_cr = True
              use_overscan = False
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = XeI,HgI,NeI,ArI
      [[slitedges]]
          sync_predict = nearest
          bound_detector = True
  [scienceframe]
      exprng = 90, None
      [[process]]
          mask_cr = True
          use_overscan = False
          noise_floor = 0.01

KECK DEIMOS (``keck_deimos``)
-----------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = keck_deimos
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              clip = False
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              clip = False
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              comb_sigrej = 10.0
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              noise_floor = 0.01
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              noise_floor = 0.01
      [[wavelengths]]
          lamps = ArI, NeI, KrI, XeI
          match_toler = 2.5
          n_first = 3
      [[slitedges]]
          edge_thresh = 50.0
          fit_order = 3
          minimum_slit_length_sci = 4.0
          minimum_slit_gap = 0.25
      [[tilts]]
          tracethresh = 10
  [scienceframe]
      [[process]]
          mask_cr = True
          sigclip = 4.0
          objlim = 1.5
          use_biasimage = False
          noise_floor = 0.01
  [reduce]
      [[findobj]]
          find_fwhm = 10.0
  [flexure]
      spec_method = boxcar
  [sensfunc]
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_MaunaKea_3100_26100_R20000.fits

KECK HIRES_R (``keck_hires_red``)
---------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = keck_hires_red
  [calibrations]
      [[biasframe]]
          useframe = bias
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 600
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          echelle = True
          ech_sigrej = 3.0
          lamps = ThAr
          rms_threshold = 0.25
      [[slitedges]]
          edge_thresh = 600.0
          max_shift_adj = 0.5
          left_right_pca = True
  [scienceframe]
      exprng = 600, None
      [[process]]
          satpix = nothing
          mask_cr = True
          sigclip = 20.0
          noise_floor = 0.01

KECK KCWI (``keck_kcwi``)
-------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = keck_kcwi
  [calibrations]
      [[biasframe]]
          exprng = None, 0.01
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
              use_pattern = True
      [[darkframe]]
          exprng = 0.01, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
              use_pattern = True
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = None, 30
          [[[process]]]
              combine = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[alignment]]
          locations = 0.1, 0.3, 0.5, 0.7, 0.9
      [[traceframe]]
          exprng = None, 30
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
              use_pattern = True
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
              use_pattern = True
      [[flatfield]]
          spec_samp_coarse = 20.0
          tweak_slits_thresh = 0.0
          tweak_slits_maxfrac = 0.0
          slit_illum_relative = True
          slit_illum_ref_idx = 14
      [[slitedges]]
          fit_order = 4
  [scienceframe]
      exprng = 30, None
      [[process]]
          mask_cr = True
          sigclip = 4.0
          objlim = 1.5
          use_biasimage = False
          noise_floor = 0.01
          use_specillum = True
          use_pattern = True
  [reduce]
      [[skysub]]
          no_poly = True
          joint_fit = True
      [[extraction]]
          skip_extraction = True
  [flexure]
      spec_method = slitcen

KECK LRISb (``keck_lris_blue``)
-------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = keck_lris_blue
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = None, 300
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = None, 300
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 30
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
              spat_flexure_correct = True
      [[wavelengths]]
          method = full_template
          lamps = NeI, ArI, CdI, KrI, XeI, ZnI, HgI
          sigdetect = 10.0
          rms_threshold = 0.2
          match_toler = 2.5
          n_first = 3
      [[slitedges]]
          edge_thresh = 15.0
          det_min_spec_length = 0.1
          fit_order = 3
          fit_min_spec_length = 0.2
          sync_center = gap
          minimum_slit_length = 4.0
          minimum_slit_length_sci = 6
  [scienceframe]
      exprng = 60, None
      [[process]]
          mask_cr = True
          noise_floor = 0.01
          spat_flexure_correct = True
  [flexure]
      spec_method = boxcar

KECK LRISb (``keck_lris_blue_orig``)
------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = keck_lris_blue_orig
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = None, 300
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = None, 300
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 30
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
              spat_flexure_correct = True
      [[wavelengths]]
          method = full_template
          lamps = NeI, ArI, CdI, KrI, XeI, ZnI, HgI
          sigdetect = 10.0
          rms_threshold = 0.2
          match_toler = 2.5
          n_first = 3
      [[slitedges]]
          edge_thresh = 15.0
          det_min_spec_length = 0.1
          fit_order = 3
          fit_min_spec_length = 0.2
          sync_center = gap
          minimum_slit_length = 4.0
          minimum_slit_length_sci = 6
  [scienceframe]
      exprng = 60, None
      [[process]]
          mask_cr = True
          noise_floor = 0.01
          spat_flexure_correct = True
  [flexure]
      spec_method = boxcar

KECK LRISr (``keck_lris_red``)
------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = keck_lris_red
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = None, 60
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = None, 60
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 30
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
              spat_flexure_correct = True
      [[wavelengths]]
          lamps = NeI, ArI, CdI, KrI, XeI, ZnI, HgI
          sigdetect = 10.0
          rms_threshold = 0.2
      [[slitedges]]
          fit_order = 3
          sync_center = gap
          minimum_slit_length = 4.0
          minimum_slit_length_sci = 6
      [[tilts]]
          tracethresh = 25
          maxdev_tracefit = 1.0
          spat_order = 4
          spec_order = 7
          maxdev2d = 1.0
          sigrej2d = 5.0
  [scienceframe]
      exprng = 60, None
      [[process]]
          mask_cr = True
          sigclip = 5.0
          objlim = 5.0
          noise_floor = 0.01
          spat_flexure_correct = True
  [reduce]
      [[skysub]]
          bspline_spacing = 0.8
  [flexure]
      spec_method = boxcar

KECK LRISr (``keck_lris_red_mark4``)
------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = keck_lris_red_mark4
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = None, 60
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = None, 60
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 30
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
              spat_flexure_correct = True
      [[wavelengths]]
          lamps = NeI, ArI, CdI, KrI, XeI, ZnI, HgI
          sigdetect = 10.0
          rms_threshold = 0.2
      [[slitedges]]
          fit_order = 3
          sync_center = gap
          minimum_slit_length = 4.0
          minimum_slit_length_sci = 6
      [[tilts]]
          tracethresh = 25
          maxdev_tracefit = 1.0
          spat_order = 4
          spec_order = 7
          maxdev2d = 1.0
          sigrej2d = 5.0
  [scienceframe]
      exprng = 60, None
      [[process]]
          mask_cr = True
          sigclip = 5.0
          objlim = 5.0
          noise_floor = 0.01
          spat_flexure_correct = True
  [reduce]
      [[skysub]]
          bspline_spacing = 0.8
  [flexure]
      spec_method = boxcar

KECK LRISr (``keck_lris_red_orig``)
-----------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = keck_lris_red_orig
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = None, 60
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = None, 60
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 30
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
              spat_flexure_correct = True
      [[wavelengths]]
          lamps = NeI, ArI, KrI, XeI, HgI
          sigdetect = 10.0
          rms_threshold = 0.2
      [[slitedges]]
          fit_order = 3
          sync_center = gap
          minimum_slit_length = 4.0
          minimum_slit_length_sci = 6
      [[tilts]]
          tracethresh = 25
          maxdev_tracefit = 1.0
          spat_order = 4
          spec_order = 7
          maxdev2d = 1.0
          sigrej2d = 5.0
  [scienceframe]
      exprng = 60, None
      [[process]]
          mask_cr = True
          sigclip = 5.0
          objlim = 5.0
          noise_floor = 0.01
          spat_flexure_correct = True
  [reduce]
      [[skysub]]
          bspline_spacing = 0.8
  [flexure]
      spec_method = boxcar

KECK MOSFIRE (``keck_mosfire``)
-------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = keck_mosfire
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 1, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 1, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 20
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
      [[wavelengths]]
          lamps = OH_NIRES
          fwhm = 5.0
          rms_threshold = 0.3
      [[slitedges]]
          edge_thresh = 50.0
          sync_predict = nearest
  [scienceframe]
      exprng = 20, None
      [[process]]
          satpix = nothing
          mask_cr = True
          sigclip = 20.0
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
  [reduce]
      [[skysub]]
          bspline_spacing = 0.8
  [fluxcalib]
      extrap_sens = True
  [sensfunc]
      extrap_blu = 0.0
      extrap_red = 0.0
      algorithm = IR
      polyorder = 13
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_MaunaKea_3100_26100_R20000.fits

KECK NIRES (``keck_nires``)
---------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = keck_nires
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 60, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 100, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          exprng = 100, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          exprng = None, 60
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[wavelengths]]
          method = reidentify
          echelle = True
          ech_norder_coeff = 6
          ech_sigrej = 3.0
          lamps = OH_NIRES
          fwhm = 5.0
          reid_arxiv = keck_nires.fits
          rms_threshold = 0.2
          n_final = 3, 4, 4, 4, 4
      [[slitedges]]
          fit_min_spec_length = 0.4
          left_right_pca = True
          trace_thresh = 10.0
          fwhm_gaussian = 4.0
      [[tilts]]
          tracethresh = 10.0
  [scienceframe]
      exprng = 60, None
      [[process]]
          satpix = nothing
          mask_cr = True
          sigclip = 20.0
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[skysub]]
          bspline_spacing = 0.8
      [[extraction]]
          boxcar_radius = 0.75
  [sensfunc]
      algorithm = IR
      polyorder = 8
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_MaunaKea_3100_26100_R20000.fits

KECK NIRSPEC (``keck_nirspec_low``)
-----------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = keck_nirspec_low
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 20, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 20, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          exprng = None, 20
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[flatfield]]
          tweak_slits_thresh = 0.8
      [[wavelengths]]
          lamps = OH_NIRES
          fwhm = 5.0
          rms_threshold = 0.2
      [[slitedges]]
          edge_thresh = 200.0
          sync_predict = nearest
  [scienceframe]
      exprng = 20, None
      [[process]]
          satpix = nothing
          mask_cr = True
          sigclip = 20.0
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[skysub]]
          bspline_spacing = 0.8
  [sensfunc]
      algorithm = IR
      polyorder = 8
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_MaunaKea_3100_26100_R20000.fits

LBT LUCI1 (``lbt_luci1``)
-------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = lbt_luci1
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[wavelengths]]
          lamps = OH_NIRES
          fwhm = 5.0
          rms_threshold = 0.2
      [[slitedges]]
          edge_thresh = 300.0
          sync_predict = nearest
  [scienceframe]
      [[process]]
          satpix = nothing
          mask_cr = True
          sigclip = 20.0
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[skysub]]
          bspline_spacing = 0.8
      [[extraction]]
          std_prof_nsigma = 100.0

LBT LUCI2 (``lbt_luci2``)
-------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = lbt_luci2
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[wavelengths]]
          lamps = OH_NIRES
          fwhm = 5.0
          rms_threshold = 0.2
      [[slitedges]]
          edge_thresh = 300
          fit_order = 8
          sync_predict = nearest
  [scienceframe]
      [[process]]
          satpix = nothing
          mask_cr = True
          sigclip = 20.0
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[skysub]]
          bspline_spacing = 0.8
          global_sky_std = False
      [[extraction]]
          std_prof_nsigma = 100.0
          model_full_slit = True

LBT MODS1B (``lbt_mods1b``)
---------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = lbt_mods1b
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = 0, None
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = 0, None
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = 1, 200
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          lamps = XeI, KrI, ArI, HgI
          sigdetect = 10.0
          rms_threshold = 0.4
      [[slitedges]]
          edge_thresh = 100.0
          sync_predict = nearest
      [[tilts]]
          maxdev_tracefit = 0.02
          spat_order = 5
          spec_order = 5
          maxdev2d = 0.02
  [scienceframe]
      exprng = 200, None
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar

LBT MODS1R (``lbt_mods1r``)
---------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = lbt_mods1r
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = 0, None
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = 0, None
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = 1, 200
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          lamps = ArI, NeI, KrI, XeI
          fwhm = 10.0
          rms_threshold = 0.4
          match_toler = 2.5
          n_first = 3
      [[slitedges]]
          edge_thresh = 100.0
          sync_predict = nearest
      [[tilts]]
          maxdev_tracefit = 0.02
          spat_order = 5
          spec_order = 5
          maxdev2d = 0.02
  [scienceframe]
      exprng = 200, None
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar

LBT MODS2B (``lbt_mods2b``)
---------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = lbt_mods2b
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = 0, None
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = 0, None
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = 1, 200
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          lamps = XeI, KrI, ArI, HgI
          sigdetect = 10.0
          rms_threshold = 0.4
      [[slitedges]]
          edge_thresh = 100.0
          sync_predict = nearest
      [[tilts]]
          maxdev_tracefit = 0.02
          spat_order = 5
          spec_order = 5
          maxdev2d = 0.02
  [scienceframe]
      exprng = 200, None
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar

LBT MODS2R (``lbt_mods2r``)
---------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = lbt_mods2r
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = 0, None
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = 0, None
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = 1, 200
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          lamps = ArI, NeI, KrI, XeI
          fwhm = 10.0
          rms_threshold = 1.0
          match_toler = 2.5
          n_first = 3
      [[slitedges]]
          edge_thresh = 300.0
          sync_predict = nearest
      [[tilts]]
          maxdev_tracefit = 0.02
          spat_order = 5
          spec_order = 5
          maxdev2d = 0.02
  [scienceframe]
      exprng = 200, None
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar

LDT deveny (``ldt_deveny``)
---------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = ldt_deveny
  [calibrations]
      bpm_usebias = True
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
              use_illumflat = False
      [[wavelengths]]
          ech_fix_format = False
          lamps = NeI, ArI, CdI, HgI
          sigdetect = 10.0
          fwhm_fromlines = True
          rms_threshold = 0.5
          n_first = 3
          n_final = 5
      [[slitedges]]
          sync_predict = nearest
          bound_detector = True
          minimum_slit_length = 90.0
      [[tilts]]
          spat_order = 4
          spec_order = 5
  [scienceframe]
      [[process]]
          mask_cr = True
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[findobj]]
          sig_thresh = 5.0
  [sensfunc]
      polyorder = 7

MAGELLAN FIRE (``magellan_fire``)
---------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = magellan_fire
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 20, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 20, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          exprng = None, 60
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[wavelengths]]
          method = reidentify
          echelle = True
          ech_norder_coeff = 6
          ech_sigrej = 3.0
          lamps = OH_FIRE_Echelle
          sigdetect = 5, 10, 10, 10, 10, 20, 30, 30, 30, 30, 30, 10, 30, 30, 60, 30, 30, 10, 20, 30, 10
          reid_arxiv = magellan_fire_echelle.fits
          cc_thresh = 0.35
          rms_threshold = 1.0
          match_toler = 30.0
          n_final = 3, 3, 3, 2, 4, 4, 4, 3, 4, 4, 4, 3, 4, 4, 4, 4, 4, 4, 6, 6, 4
      [[slitedges]]
          edge_thresh = 10.0
          max_shift_adj = 0.5
          fit_min_spec_length = 0.5
          left_right_pca = True
          pca_order = 3
          trace_thresh = 10.0
      [[tilts]]
          tracethresh = 5
  [scienceframe]
      exprng = 20, None
      [[process]]
          satpix = nothing
          mask_cr = True
          sigclip = 20.0
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[extraction]]
          model_full_slit = True
  [sensfunc]
      algorithm = IR
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_LasCampanas_3100_26100_R20000.fits

MAGELLAN FIRE (``magellan_fire_long``)
--------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = magellan_fire_long
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 20, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 1, 50
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          exprng = None, 60
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[wavelengths]]
          method = full_template
          lamps = ArI, ArII, ThAr, NeI
          sigdetect = 3
          fwhm = 20
          reid_arxiv = magellan_fire_long.fits
          rms_threshold = 1.0
          match_toler = 5.0
      [[slitedges]]
          trace_thresh = 10.0
          sync_predict = nearest
      [[tilts]]
          tracethresh = 5
  [scienceframe]
      exprng = 20, None
      [[process]]
          mask_cr = True
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[findobj]]
          sig_thresh = 5
          find_trim_edge = 50, 50
  [sensfunc]
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/TelFit_LasCampanas_3100_26100_R20000.fits

MAGELLAN MagE (``magellan_mage``)
---------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = magellan_mage
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 20, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 20, None
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 20
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          method = reidentify
          echelle = True
          ech_sigrej = 3.0
          lamps = ThAr_MagE
          reid_arxiv = magellan_mage.fits
          cc_thresh = 0.5
          cc_local_thresh = 0.5
          rms_threshold = 0.2
      [[slitedges]]
          edge_thresh = 10.0
          max_shift_adj = 3.0
          fit_min_spec_length = 0.3
          left_right_pca = True
      [[tilts]]
          tracethresh = 10.0
  [scienceframe]
      exprng = 20, None
      [[process]]
          satpix = nothing
          mask_cr = True
          sigclip = 20.0
          noise_floor = 0.01
  [reduce]
      [[findobj]]
          find_trim_edge = 4, 4

KPNO MDM4K (``mdm_osmos_mdm4k``)
--------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = mdm_osmos_mdm4k
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 120
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = ArI, XeI
          sigdetect = 10.0
          reid_arxiv = mdm_osmos_mdm4k.fits
      [[slitedges]]
          sync_predict = nearest
  [scienceframe]
      exprng = 90, None
      [[process]]
          mask_cr = True
          noise_floor = 0.01

MMT BINOSPEC (``mmt_binospec``)
-------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = mmt_binospec
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 20, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 20, None
          [[[process]]]
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 100
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              noise_floor = 0.01
      [[wavelengths]]
          lamps = ArI, ArII
          fwhm = 5.0
          rms_threshold = 0.5
      [[slitedges]]
          sync_predict = nearest
      [[tilts]]
          tracethresh = 10.0
          spat_order = 6
          spec_order = 6
  [scienceframe]
      exprng = 20, None
      [[process]]
          mask_cr = True
          sigclip = 5.0
          objlim = 2.0
          use_biasimage = False
          noise_floor = 0.01
  [reduce]
      [[skysub]]
          bspline_spacing = 0.8
          global_sky_std = False
  [flexure]
      spec_method = boxcar
  [sensfunc]
      polyorder = 7
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_MaunaKea_3100_26100_R20000.fits

MMT Blue_Channel (``mmt_bluechannel``)
--------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = mmt_bluechannel
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 300, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 10, None
          [[[process]]]
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = None, 100
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = None, 100
          [[[process]]]
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          exprng = 30, None
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 600
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              noise_floor = 0.01
      [[wavelengths]]
          lamps = ArI, ArII, HeI, NeI
          fwhm = 5.0
          rms_threshold = 0.5
      [[slitedges]]
          sync_predict = nearest
          bound_detector = True
  [scienceframe]
      [[process]]
          mask_cr = True
          sigclip = 5.0
          objlim = 2.0
          use_biasimage = False
          noise_floor = 0.01
  [reduce]
      [[skysub]]
          bspline_spacing = 0.8
          global_sky_std = False
  [sensfunc]
      polyorder = 7

MMT MMIRS (``mmt_mmirs``)
-------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = mmt_mmirs
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 30, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 60, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          exprng = 60, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          exprng = None, 60
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[wavelengths]]
          lamps = OH_NIRES
          fwhm = 5
          rms_threshold = 0.5
          match_toler = 5.0
      [[slitedges]]
          edge_thresh = 100.0
          fit_min_spec_length = 0.4
          trace_thresh = 10.0
          sync_predict = nearest
          bound_detector = True
      [[tilts]]
          tracethresh = 5
          spat_order = 7
          spec_order = 5
  [scienceframe]
      exprng = 30, None
      [[process]]
          mask_cr = True
          grow = 0.5
          sigclip = 5.0
          objlim = 2.0
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
  [reduce]
      [[findobj]]
          sig_thresh = 5.0
      [[skysub]]
          sky_sigrej = 5.0
  [sensfunc]
      algorithm = IR
      polyorder = 8
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_MaunaKea_3100_26100_R20000.fits

NOT ALFOSC (``not_alfosc``)
---------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = not_alfosc
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
          [[[process]]]
              use_overscan = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_overscan = False
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 120
          [[[process]]]
              mask_cr = True
              use_overscan = False
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = HeI, NeI
          sigdetect = 10.0
      [[slitedges]]
          sync_predict = nearest
          bound_detector = True
  [scienceframe]
      exprng = 90, None
      [[process]]
          mask_cr = True
          use_overscan = False
          noise_floor = 0.01

NTT EFOSC2 (``ntt_efosc2``)
---------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = ntt_efosc2
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[flatfield]]
          tweak_slits_thresh = 0.9
      [[wavelengths]]
          method = full_template
          lamps = HeI, ArI
          sigdetect = 10.0
          rms_threshold = 0.25
      [[slitedges]]
          edge_thresh = 75.0
          sync_predict = nearest
      [[tilts]]
          tracethresh = 25.0
  [scienceframe]
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [reduce]
      [[skysub]]
          sky_sigrej = 5.0
          global_sky_std = False
          no_poly = True
  [flexure]
      spec_method = boxcar

P200 DBSPb (``p200_dbsp_blue``)
-------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = p200_dbsp_blue
  [calibrations]
      bpm_usebias = True
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = None, 120
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 120
          [[[process]]]
              combine = median
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = FeI, ArI, ArII
      [[slitedges]]
          fit_min_spec_length = 0.55
          sync_predict = nearest
  [scienceframe]
      exprng = 90, None
      [[process]]
          combine = median
          mask_cr = True
          noise_floor = 0.01
  [sensfunc]
      [[UVIS]]
          nresln = 5

P200 DBSPr (``p200_dbsp_red``)
------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = p200_dbsp_red
  [calibrations]
      bpm_usebias = True
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = None, 120
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 120
          [[[process]]]
              combine = median
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = ArI, ArII, NeI, HeI
      [[slitedges]]
          sync_predict = nearest
  [scienceframe]
      exprng = 90, None
      [[process]]
          combine = median
          mask_cr = True
          sigclip = 4.0
          objlim = 1.5
          noise_floor = 0.01
  [sensfunc]
      [[UVIS]]
          polycorrect = False
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_Lick_3100_11100_R10000.fits

P200 TSPEC (``p200_tspec``)
---------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = p200_tspec
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 0, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 100, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          exprng = 100, None
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          exprng = None, 60
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[wavelengths]]
          method = reidentify
          echelle = True
          ech_norder_coeff = 6
          ech_sigrej = 3.0
          lamps = OH_NIRES
          fwhm = 5.0
          reid_arxiv = p200_triplespec.fits
          rms_threshold = 0.3
          n_final = 3, 4, 4, 4, 4
      [[slitedges]]
          fit_min_spec_length = 0.3
          left_right_pca = True
          trace_thresh = 5.0
          fwhm_gaussian = 4.0
      [[tilts]]
          tracethresh = 10.0
  [scienceframe]
      exprng = 60, None
      [[process]]
          satpix = nothing
          mask_cr = True
          sigclip = 20.0
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[skysub]]
          bspline_spacing = 0.8
      [[extraction]]
          boxcar_radius = 0.75
  [sensfunc]
      algorithm = IR
      polyorder = 8
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_MaunaKea_3100_26100_R20000.fits

SHANE KASTb (``shane_kast_blue``)
---------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = shane_kast_blue
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = None, 61
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = 0, None
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = 0, None
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = 1, 61
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = CdI, HgI, HeI
          rms_threshold = 0.2
          match_toler = 2.5
          n_first = 3
      [[slitedges]]
          sync_predict = nearest
          bound_detector = True
      [[tilts]]
          maxdev_tracefit = 0.02
          spec_order = 5
          maxdev2d = 0.02
  [scienceframe]
      exprng = 61, None
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar
      spectrum = /Users/westfall/Work/packages/pypeit/pypeit/data/sky_spec/sky_kastb_600.fits

SHANE KASTr (``shane_kast_red``)
--------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = shane_kast_red
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = None, 61
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = 0, None
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = 0, None
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = 1, 61
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          lamps = NeI, HgI, HeI, ArI
      [[slitedges]]
          sync_predict = nearest
          bound_detector = True
  [scienceframe]
      exprng = 61, None
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar
  [sensfunc]
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_Lick_3100_11100_R10000.fits

SHANE KASTr (``shane_kast_red_ret``)
------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = shane_kast_red_ret
  [calibrations]
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = None, 61
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          exprng = 0, None
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          exprng = 0, None
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          exprng = 1, 61
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          lamps = NeI, HgI, HeI, ArI
          rms_threshold = 0.2
          use_instr_flag = True
      [[slitedges]]
          sync_predict = nearest
          bound_detector = True
  [scienceframe]
      exprng = 61, None
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar

SOAR red (``soar_goodman_red``)
-------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = soar_goodman_red
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = None, 30
          [[[process]]]
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 120
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              noise_floor = 0.01
      [[wavelengths]]
          lamps = NeI, ArI, HgI
          fwhm = 5.0
          rms_threshold = 0.5
      [[slitedges]]
          sync_predict = nearest
          bound_detector = True
  [scienceframe]
      exprng = 90, None
      [[process]]
          mask_cr = True
          use_biasimage = False
          noise_floor = 0.01
  [sensfunc]
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_LasCampanas_3100_26100_R20000.fits

TNG DOLORES (``tng_dolores``)
-----------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = tng_dolores
  [calibrations]
      [[biasframe]]
          exprng = None, 0.1
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
  [scienceframe]
      exprng = 1, None
      [[process]]
          mask_cr = True
          noise_floor = 0.01

VLT FORS2 (``vlt_fors2``)
-------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = vlt_fors2
  [calibrations]
      [[biasframe]]
          [[[process]]]
              overscan_method = median
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              overscan_method = median
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              overscan_method = median
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              overscan_method = median
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              overscan_method = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              overscan_method = median
      [[alignframe]]
          [[[process]]]
              overscan_method = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              overscan_method = median
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              overscan_method = median
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              overscan_method = median
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          [[[process]]]
              overscan_method = median
              mask_cr = True
              noise_floor = 0.01
      [[flatfield]]
          tweak_slits_thresh = 0.9
      [[wavelengths]]
          lamps = HeI, ArI
          sigdetect = 10.0
          rms_threshold = 0.25
      [[slitedges]]
          edge_thresh = 50.0
          max_shift_adj = 0.5
          fit_order = 3
      [[tilts]]
          tracethresh = 25.0
  [scienceframe]
      [[process]]
          mask_cr = True
          noise_floor = 0.01
  [flexure]
      spec_method = boxcar

VLT SINFONI (``vlt_sinfoni``)
-----------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = vlt_sinfoni
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 20, None
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = 20, None
          [[[process]]]
              mask_cr = True
              sigclip = 20.0
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              mask_cr = True
              sigclip = 20.0
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_darkimage = True
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_darkimage = True
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_darkimage = True
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              sigclip = 20.0
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 20
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = OH_FIRE_Echelle
          fwhm = 5.0
          reid_arxiv = vlt_sinfoni_K.fits
          rms_threshold = 0.3
      [[slitedges]]
          edge_thresh = 50.0
          sync_predict = nearest
          rm_slits = 1:1024:983
      [[tilts]]
          tracethresh = 5.0
  [scienceframe]
      exprng = 20, None
      [[process]]
          satpix = nothing
          mask_cr = True
          sigclip = 20.0
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
  [reduce]
      [[findobj]]
          find_fwhm = 10
          skip_second_find = True
          cont_sig_thresh = 1.0
      [[skysub]]
          bspline_spacing = 0.9
          global_sky_std = False
      [[extraction]]
          sn_gauss = 5.0
          model_full_slit = True
  [sensfunc]
      algorithm = IR
      polyorder = 7
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_Paranal_NIR_9800_25000_R25000.fits

VLT XShooter_NIR (``vlt_xshooter_nir``)
---------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = vlt_xshooter_nir
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_darkimage = True
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_biasimage = False
              use_overscan = False
              use_darkimage = True
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_biasimage = False
              use_overscan = False
              use_darkimage = True
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              use_biasimage = False
              use_overscan = False
              noise_floor = 0.01
              use_illumflat = False
      [[flatfield]]
          tweak_slits_thresh = 0.9
      [[wavelengths]]
          method = reidentify
          echelle = True
          ech_nspec_coeff = 5
          ech_norder_coeff = 5
          ech_sigrej = 3.0
          lamps = OH_XSHOOTER
          sigdetect = 10.0
          fwhm = 5.0
          reid_arxiv = vlt_xshooter_nir.fits
          cc_thresh = 0.5
          cc_local_thresh = 0.5
          rms_threshold = 0.25
      [[slitedges]]
          edge_thresh = 50.0
          max_shift_adj = 0.5
          fit_order = 8
          fit_min_spec_length = 0.5
          left_right_pca = True
          trace_thresh = 10.0
          length_range = 0.3
      [[tilts]]
          tracethresh = 25.0
          maxdev_tracefit = 0.04
          maxdev2d = 0.04
          rm_continuum = True
  [scienceframe]
      [[process]]
          satpix = nothing
          mask_cr = True
          sigclip = 20.0
          use_biasimage = False
          use_overscan = False
          noise_floor = 0.01
          use_illumflat = False
  [reduce]
      [[findobj]]
          trace_npoly = 8
          find_cont_fit = False
          find_npoly_cont = 0
      [[skysub]]
          bspline_spacing = 0.8
          global_sky_std = False
      [[extraction]]
          model_full_slit = True
  [sensfunc]
      algorithm = IR
      polyorder = 8
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_Paranal_NIR_9800_25000_R25000.fits

VLT XShooter_UVB (``vlt_xshooter_uvb``)
---------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = vlt_xshooter_uvb
  [calibrations]
      [[biasframe]]
          [[[process]]]
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              mask_cr = True
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              overscan_method = median
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              overscan_method = median
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[standardframe]]
          [[[process]]]
              mask_cr = True
              noise_floor = 0.01
      [[wavelengths]]
          method = reidentify
          echelle = True
          ech_norder_coeff = 5
          ech_sigrej = 3.0
          lamps = ThAr_XSHOOTER_UVB
          reid_arxiv = vlt_xshooter_uvb1x1_iraf.json
          rms_threshold = 0.5
      [[slitedges]]
          edge_thresh = 8.0
          max_shift_adj = 0.5
          left_right_pca = True
          trace_thresh = 10.0
          length_range = 0.3
  [scienceframe]
      useframe = overscan
      [[process]]
          mask_cr = True
          noise_floor = 0.01

VLT XShooter_VIS (``vlt_xshooter_vis``)
---------------------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = vlt_xshooter_vis
  [calibrations]
      [[biasframe]]
          [[[process]]]
              overscan_method = median
              combine = median
              use_biasimage = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          [[[process]]]
              overscan_method = median
              mask_cr = True
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          [[[process]]]
              overscan_method = median
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              overscan_method = median
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              overscan_method = median
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          [[[process]]]
              overscan_method = median
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[alignframe]]
          [[[process]]]
              overscan_method = median
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              overscan_method = median
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              overscan_method = median
              satpix = nothing
              use_biasimage = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              overscan_method = median
              mask_cr = True
              use_biasimage = False
              noise_floor = 0.01
              use_pixelflat = False
              use_illumflat = False
      [[standardframe]]
          [[[process]]]
              overscan_method = median
              mask_cr = True
              use_biasimage = False
              noise_floor = 0.01
      [[flatfield]]
          tweak_slits_thresh = 0.9
      [[wavelengths]]
          method = reidentify
          echelle = True
          ech_sigrej = 3.0
          lamps = ThAr_XSHOOTER_VIS
          fwhm = 11.0
          reid_arxiv = vlt_xshooter_vis1x1.fits
          cc_thresh = 0.5
          cc_local_thresh = 0.5
          rms_threshold = 0.5
          n_final = 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3
      [[slitedges]]
          edge_thresh = 8.0
          max_shift_adj = 0.5
          fit_order = 8
          left_right_pca = True
          trace_thresh = 10.0
          length_range = 0.3
      [[tilts]]
          tracethresh = 15
          spec_order = 5
  [scienceframe]
      [[process]]
          overscan_method = median
          mask_cr = True
          noise_floor = 0.01
  [reduce]
      [[findobj]]
          find_trim_edge = 3, 3
          find_cont_fit = False
          find_npoly_cont = 0
      [[skysub]]
          bspline_spacing = 0.5
          global_sky_std = False
      [[extraction]]
          model_full_slit = True
  [sensfunc]
      algorithm = IR
      polyorder = 9, 11, 11, 9, 9, 8, 8, 7, 7, 7, 7, 7, 7, 7, 7
      [[IR]]
          telgridfile = /Users/westfall/Work/packages/pypeit/pypeit/data/telluric/atm_grids/TelFit_Paranal_VIS_4900_11100_R25000.fits

WHT ISISb (``wht_isis_blue``)
-----------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = wht_isis_blue
  [calibrations]
      bpm_usebias = True
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = None, 120
          [[[process]]]
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
          [[[process]]]
              use_overscan = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_overscan = False
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 120
          [[[process]]]
              mask_cr = True
              use_overscan = False
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = NeI, ArI, ArII, CuI
          sigdetect = 10.0
          n_first = 3
          n_final = 5
          wv_cen = 4859.0
          disp = 0.2
      [[slitedges]]
          sync_predict = nearest
  [scienceframe]
      exprng = 90, None
      [[process]]
          mask_cr = True
          use_overscan = False
          noise_floor = 0.01

WHT ISISr (``wht_isis_red``)
----------------------------
Alterations to the default parameters are::

  [rdx]
      spectrograph = wht_isis_red
  [calibrations]
      bpm_usebias = True
      [[biasframe]]
          exprng = None, 1
          [[[process]]]
              combine = median
              use_biasimage = False
              use_overscan = False
              shot_noise = False
              use_pixelflat = False
              use_illumflat = False
      [[darkframe]]
          exprng = 999999, None
          [[[process]]]
              mask_cr = True
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[arcframe]]
          exprng = None, 120
          [[[process]]]
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[tiltframe]]
          [[[process]]]
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pixelflatframe]]
          [[[process]]]
              combine = median
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[pinholeframe]]
          exprng = 999999, None
          [[[process]]]
              use_overscan = False
      [[alignframe]]
          [[[process]]]
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[traceframe]]
          [[[process]]]
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[illumflatframe]]
          [[[process]]]
              satpix = nothing
              use_overscan = False
              use_pixelflat = False
              use_illumflat = False
      [[skyframe]]
          [[[process]]]
              mask_cr = True
              use_overscan = False
              noise_floor = 0.01
      [[standardframe]]
          exprng = None, 120
          [[[process]]]
              mask_cr = True
              use_overscan = False
              noise_floor = 0.01
      [[wavelengths]]
          method = full_template
          lamps = NeI, ArI, ArII, CuI
          sigdetect = 10.0
          wv_cen = 6000.0
          disp = 0.2
      [[slitedges]]
          sync_predict = nearest
  [scienceframe]
      exprng = 90, None
      [[process]]
          mask_cr = True
          use_overscan = False
          noise_floor = 0.01

.. _coadd2d:

================
Coadd 2D Spectra
================

Overview
========

This document will describe how to combine the 2D spectra
from multiple exposures.

This must be done outside of the data reduction pipeline,
i.e. PypeIt will *not* coadd your spectra as
part of the data reduction process, although it can
combine (without weighting) multiple exposures
during reductions (See :ref:`2d_combine`).

pypeit_coadd_2dspec
===================

The primary script is called `pypeit_coadd_2dspec`_ which takes
an input file or *object name* to guide the process.

usage
-----

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_coadd_2dspec.rst


options
-------

Here are commonly used options:

--show
++++++

Show a series of matplotlib plots to the screen.

--basename
++++++++++

Provides the basename for the spec1d and spec2d files.
If not provided, defaults to a portion of the input spec2d filenames.

--debug
+++++++

Unclear how this differs from `--show`_.

coadd2d file
------------

The format of this file is very similar to a :doc:`pypeit_file`.
Here is an example for `keck_lris_blue`::

    # User-defined execution parameters
    [rdx]
      spectrograph = keck_lris_blue
      detnum = 2
    [reduce]
        [[findobj]]
            sig_thresh=5.0

    # Read in the data
    spec2d read
    Science/spec2d_b170320_2083-c17_60L._LRISb_2017Mar20T055336.211.fits
    Science/spec2d_b170320_2090-c17_60L._LRISb_2017Mar20T082144.525.fits
    Science/spec2d_b170320_2084-c17_60L._LRISb_2017Mar20T062414.630.fits
    Science/spec2d_b170320_2091-c17_60L._LRISb_2017Mar20T085223.894.fits
    spec2d end


The opening block sets parameters for the reduction steps

The data block provides a list of :doc:`out_spec2D` files.


run
---

Then run the script::

    pypeit_coadd_2dspec --file FRB190711_XS_coadd2d.cfg --show



The parameters that guide the coadd process are also written
to disk for your records. The default location is *coadd2d.par*.
You can choose another location by modifying `--basename`_.


Current Coadd2D Data Model
==========================

The outputs are identical to the standard run, as
described in :doc:`out_spec1D` and :doc:`out_spec2D`.


.. include:: include/links.rst

.. _keck_kcwi:

*********
KECK KCWI
*********


Overview
========

This file summarizes several instrument specific
settings that are related to the Keck/KCWI spectrograph.
Future setups will be included in PypeIt. If your setup
or wavelength range is not supported, you may need to use
the pypeit_identify task to manually wavelength calibrate
your data. Also note that NAS mode is not currently
supported in PypeIt.

Taking Calibrations for KCWI
++++++++++++++++++++++++++++

Arcs
----

We recommend that you only use the FeAr lamp to wavelength
calibrate your data. Note that some FeAr calibration frames
were contaminated due to a leaking ThAr lamp for observations
up to the end of 2019. If your data are affected, you will
need to request a new arc calibration. If there is a small
offset, this is compensated for by default using a spectral
flexure correction to the sky emission lines.

The archived wavelength calibration solution only contains
the FeAr spectrum.

Pixel Flat
----------

It is recommended to correct for pixel-to-pixel variations
using the internal "Continuum" lamp.

Trace Flat
----------

We strongly recommend that you take dome trace flats. This
is essential for the spatial illumination profile correction
and to trace the slit edges. The dome flats (or sky flats)
are a more faithful representation of the slit edge locations
and spatial illumination profile of your science frames.

Alignment frames
----------------

PypeIt uses alignment frames to perform an astrometric correction.
For KCWI, these are referred to as "Cont Bars" frames. This correction
is small, and if you do not have alignment frames for KCWI you should
turn off the astrometric correction using the command::

    [reduce]
      [[cube]]
           astrometric = False


Image processing
++++++++++++++++

CCD Pattern Removal
-------------------

We identified a sinusoidal pattern that is imprinted on the
CCD which varies with time and CCD row (i.e. the sinusoidal
pattern is present in the spatial direction). If you are working
in the read noise limit, we recommend that you subtract off this
pattern. We have a robust algorithm to remove this pattern in both
1x1 and 2x2 binning data, but it is relatively slow. This pattern
is removed by default, but if you would prefer to turn this
off, you can do so by adding the following in your
:doc:`pypeit_file`::

    [scienceframe]
      [[process]]
           use_pattern = False

Note, the effective read noise of the data is determined from the
overscan regions. Our tests suggest that the effective read noise
is reduced by 25-40 percent if the pattern noise is subtracted.

Relative spectral illumination correction
-----------------------------------------

PypeIt uses a flat field frame to make a first guess at the relative
spectral illumination. A fine correction to this relative spectral
illumination can be performed using the sky. This algorithm ensures
that each slice has the same sensitivity as a function
of wavelength. We recommend that you design your observations
so that each slice contains some sky. If you would not like to
perform a relative spectral sensitivity correction (for example,
if you do not have enough sky information for this to be reliable),
you can turn it off using the command::

    [scienceframe]
      [[process]]
           use_specillum = False

Sky subtraction
---------------

See :doc:`skysub` for useful hints to define the sky regions
using an interactive GUI.

Producing datacubes
+++++++++++++++++++

PypeIt does not produce datacubes as a standard product of
the reduction process. Instead, PypeIt delivers fully processed
2D frames, which can be combined into a single datacube using
the pypeit_coadd_datacube routine (see :doc:`coadd3d` for the
documentation).
.. include:: include/links.rst

.. _pypeit_file:

=====================
PypeIt Reduction File
=====================

Overview
========

The primary file that dictates how ``PypeIt`` is executed and what
data it reduces is called the ``PypeIt`` reduction file. The name of
the file is expected to end with ``.pypeit``, and it has a specific
format that we discuss below. The ``PypeIt`` reduction file should
first be automatically generated using the :ref:`pypeit_setup`
script, but it can (and often will be) edited by the user.

This document provides guidance on modifying the file.

You must have a unique ``PypeIt`` file for each instrument
configuration, or "setup" (modulo detectors), which is often includes
the name of the slit mask design for relevant instruments. It is
possible that you will need to modify the settings for different
gratings, etc. It will also enable you to more easily customize the
associated calibration files to process.

File Format
===========

Here is an example PypeIt reduction file:

.. include:: include/shane_kast_blue_A.pypeit.rst

Parameter Block
---------------

At the top of the file is the parameter block which allows the user
to customize the parameters used to define how the data reduction
proceeds. The two lines shown in this example are the only 2 that are
required.

See `Edits to the Parameter Block`_ for common edits and also read
the :ref:`instr_par` relevant to the instrument used to collect your
data. Importantly, not that this provides the alterations that are
*always* made to the default parameters for the instrument in
question; i.e., these are *not* the parameters that you need to
include in your ``PypeIt`` reduction file. You only need to include
parameters in your ``PypeIt`` reduction file that you wish to change
from the instrument-specific defaults (or the global defaults in the
case that the instrument requires no change to the global default).

.. _setup_block:

Setup Block
-----------

The next block, beginning with line ``setup read``, describes the
instrument configuration. There should only be one setup shown (e.g.,
``Setup A``), and the parameters provided show the salient metadata
for that instrument configuration. **You should not edit any of
this**; it is informational and required. See :doc:`setup`.

.. _data_block:

Data Block
----------

Last is the data block, beginning with the line ``data read``, which
includes the path(s) to the raw data files and a table describing
those files. It is common to edit this table as described below.

The data block is a fixed-format table as written by the underlying
`astropy.table.Table`_ object used by :ref:`pypeit_setup`. The |
symbols need not align but the number per row must be equal.

.. warning::

    Users should always generate the ``PypeIt`` reduction file using
    the :ref:`pypeit_setup` script. However, you will often need to
    edit it because it is virtually impossible to create an automated
    procedure that will work in all cases. The ``PypeIt`` reduction
    file is the ultimate authority in terms of how the data is
    reduced. As such, you should understand how edits to this file
    work because these edits will override *anything* derived from
    the FITS headers!

Most :doc:`spectrographs` require at least one file with each
of the following :doc:`frametype`:

    - ``arc``: Wavelength calibration
    - ``trace``: Slit/order definition
    - ``pixelflat``: Flat fielding
    - ``science``: Science exposure

.. warning::

    The code will *not* run if your :doc:`pypeit_file` includes
    entries with ``None``. You must remove or modify those entries.

Edits to the Parameter Block
============================

:doc:`pypeit_par` provides the complete (and extensive) list of
parameters, the :ref:`instr_par`, and the instructions for
:ref:`change_par`.

Here are additional docs on common edits that ``PypeIt`` users make:

.. toctree::
   :caption: More reading
   :maxdepth: 1

   calibrations
   frametype
   bias_dark
   flat_fielding
   wave_calib
   slit_tracing
   object_finding
   reduction_tips


Edits to the Data Block
=======================

This section describes the common edits to the Data Block of the
``PypeIt`` file.

Add/Remove a File
-----------------

You can add/remove files from the data block.

To add a file, the only safe move is to copy in a line from the
``sorted`` file generated by :ref:`pypeit_setup`; see :doc:`setup`.
It needs to be formatted just like the others.

To remove a file, you may delete the line or comment it out by
pre-pending a `#`.

Here is yet another reminder to **not** include bad calibration
frames in the reduction (i.e., frames that you do not want to use,
frames with incorrectly identified types, or frames that could not be
automatically classified and have a ``None`` type). Check them now
and remove them if they are bad.

frametype
---------

The most common edit for a given data file is its :doc:`frametype`.
For almost all spectrographs supported by ``PypeIt``, you will need
at least one of these: ``arc``, ``tilt``, ``pixelflat``, ``trace``
and ``science``.

As you can see from the above example, a given file can have multiple
frametypes. Simply provide a comma-separated list, **without
spaces**.

Standard star exposures are very frequently mis-labeled as `science`
(and to a lesser extent, vice-versa). So keep an eye out for those.

near-IR
-------

One key difference is that you can and probably should make
modifications to enable A-B (or AA-BB or whatever) subtraction. See
:doc:`A-B_differencing` for a full discussion.


.. include:: include/links.rst

.. _history:

===============
History Keyword
===============

``PypeIt`` will update the ``HISTORY`` keyword in the FITS header with
information about how a file was created and what raw data the file was
reduced from.

Each history entry will start with a date in ISO 8601 format and the 
string ``PypeIt``. Because of the limited length allowed in the FITS
standard, entries may wrap to the next ``HISTORY`` keyword. To make it 
easier to detect if this has happened to a filename, all filenames are 
wrapped in double quotes ``"``.

Examples:

Reduction::

  HISTORY 2021-03-05T23:56 PypeIt Reducing target HIP15339                        
  HISTORY Combining frames:                                                       
  HISTORY "S20161108S0087.fits.gz"                                                
  HISTORY "S20161108S0090.fits.gz"                                                
  HISTORY Subtracted background from frames:                                      
  HISTORY "S20161108S0088.fits.gz"                                                
  HISTORY "S20161108S0089.fits.gz"                                                
  HISTORY Callibration frames:                                                    
  HISTORY arc,science,tilt "S20161108S0069.fits.gz"                               
  HISTORY arc,science,tilt "S20161108S0070.fits.gz"                               
  HISTORY arc,science,tilt "S20161108S0071.fits.gz"                               
  HISTORY arc,science,tilt "S20161108S0072.fits.gz"                               
  HISTORY pixelflat,trace "S20161108S0078.fits.gz"                                

Coadding::

  HISTORY 2021-01-23T02:12 PypeIt Coadded 4 objects from 3 spec1d files           
  HISTORY File 0 "spec1d_DE.20170425.53065-dra11_DEIMOS_2017Apr25T144418.240.fits"  
  HISTORY File 1 "spec1d_DE.20170425.51771-dra11_DEIMOS_2017Apr25T142245.350.fits"  
  HISTORY File 2 "spec1d_DE.20170425.50487-dra11_DEIMOS_2017Apr25T140121.014.fits"  
  HISTORY Object ID SPAT0692-SLIT0704-DET08 from file 0                           
  HISTORY Object ID SPAT0695-SLIT0706-DET04 from file 2                           
  HISTORY Object ID SPAT0691-SLIT0704-DET08 from file 2                           
  HISTORY Object ID SPAT0695-SLIT0706-DET04 from file 1

Fluxing::

  HISTORY 2021-03-09T01:21 PypeIt Flux calibration "sens_b24-Feige66_KASTb_2015May
  HISTORY 20T041246.960.fits"                                                     

.. _flexure:

==================
Flexure Correction
==================

Overview
========

PypeIt can account for `Spectral`_ and `Spatial`_ flexure
in the instrument.  The former is applied by default
while the latter requires extra care and expertise.

We discuss each in turn.

Spatial
=======

The code has a simple yet relatively robust method to cross-correlate
the slits against any input image to determine a rigid, spatial offset.
This algorithm is performed for any frametype with
**spat_flexure_correct** set to *True* in the `process` block
of :ref:`pypeit_par:ProcessImagesPar Keywords`.

We have made our own determinations for which instruments
to enable this as the default. Inspect the
:ref:`pypeit_par:Instrument-Specific Default Configuration`
list to see if your instrument is included.

Depending on what frametypes you choose to correct, the
code will behave somewhat differently.  Here we describe
the options in increasing complexity.

Science/Standard Only
---------------------

Most users may wish to only correct for flexure when
processing the
*standard* and *scienceframe* images.
If you wish to turn on this correction
add this to your PypeIt file::

    [scienceframe]
      [[process]]
         spat_flexure_correct = True
    [calibrations]
      [[standardframe]]
         [[[process]]]
            spat_flexure_correct = True


This will:

 - Calculate a spatial offset for each science/standard frame from the slits
 - Apply this correction for the illumination flat
 - Apply this correction prior to sky subtraction and extraction

Tilts only
----------

Here the modification to your :doc:`pypeit_file` is like::

    [calibrations]
      [[tiltframe]]
         [[[process]]]
            spat_flexure_correct = True

This will:

 - Calculate a spatial offset between the trace flats and the tilt image
 - Construct the tilt solution in that frame
 - Apply an offset to generate tilts and wavelegths for the science/standard image


Spectral
========

``PypeIt`` calculates the spectral flexure correction, as a single pixel shift,
by performing a cross-correlation between an extracted sky spectrum and an archived sky spectrum.
This is then imposed on the wavelength solution with simple linear interpolation.
To enable this correction the parameter ``spec_method`` in :ref:`pypeit_par:FlexurePar Keywords`
should be set to ``boxcar`` or ``slitcen``. The default is ``spec_method = skip``, i.e.,
no spectral flexure correction, for most spectrographs, except:

- Gemini/GMOS (N&S)
- Keck/DEIMOS
- Keck/KCWI
- Keck/LRIS (all)
- LBT/MODS (all)
- MMT/Binospec
- NTT/EFOSC2
- Shane/KAST (all)
- VLT/FORS2

If ``spec_method = boxcar`` (recommended) the observed sky spectrum flux is boxcar extracted,
while the spectrum wavelength is taken from the extracted 1D object. If no objects have been
extracted, set ``spec_method = slitcen``, which uses a spectrum extracted from the center of
each slit.

For the archived sky spectrum, generally, the Paranal sky spectrum is used by default. However, this is
different for Kast blue and LRIS blue where sky_kastb_600.fits and sky_LRISb_600.fits
are respectively used (see `Alternate sky models`_ for all sky models).

Narrow sky emission lines dominate the analysis, but other features
can affect the cross-correlation.


Algorithm
---------

The basic algorithm may be summarized as follows:

1. Identify the overlapping wavelength range between data and archived sky.

2. Rebin the archived sky spectrum onto the overlapping wavelength range.

3. Smooth the sky spectrum to the resolution of the data, if the archive
   has higher spectral resolution (preferred).

4. Normalize each spectrum to unit average sky counts

5. Subtract a bspline continuum from each

6. Perform a cross-correlation

7. Fit the cross-correlation with a parabola to find center

8. Apply shift

QA
--


Alternate sky models
--------------------

You may find that the default sky models are not the best suited 
for your data.There is a script that allows the user to plot the 
extracted sky spectrum for their data against any of the sky models 
in the PypeIt archive.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_compare_sky.rst

As noted above, the Paranal sky model is the default reference.
Presently, we are finding that the sky spectrum at Mauna Kea (measured
with LRIS) is sufficiently variable and dark
that a robust solution is challenging.
Fair results are achieved by using the instrument-specific sky spectra
in the LowRedux package. The best practice currently is to use the one 
that best matches as an optional parameter

.. THIS IS OUT OF DATE!
.. You can use a different sky model than the default by placing the 
.. following line under the ''Reduce'' block in your .pypeit file::

.. reduce flexure spectrum <Name of sky model>

The models supplied with PypeIt are,

+-----------------------------------+-----------------------------------------------------------------------------------+
| Filename                          | Description                                                                       |
+===================================+===================================================================================+
| paranal_sky.fits                  |  Description to come                                                              |
+-----------------------------------+-----------------------------------------------------------------------------------+
| sky_LRISb_400.fits                |  Mauna Kea sky observed with LRISb and the 400/3400 grism                         |
+-----------------------------------+-----------------------------------------------------------------------------------+
| sky_LRISb_600.fits                |  Mauna Kea sky observed with LRISb and the 600/4000 grism [Default for lris_blue] |
+-----------------------------------+-----------------------------------------------------------------------------------+
| sky_kastb_600.fits                |  Mt. Hamilton sky observed with Kastb and the 600 grism [Default for kast_blue]   |
+-----------------------------------+-----------------------------------------------------------------------------------+
| sky_LRISr_600_7500_5460_7950.fits |  Description to come                                                              |
+-----------------------------------+-----------------------------------------------------------------------------------+

.. _pypeit_multislit_flexure:

pypeit_multislit_flexure
------------------------

We have now implemented a method to calculate a flexure
correction across multiple detectors, i.e. with an expanded wavelength coverage.
In contrast to the standard approach which estimates and applies a single 
pixel shift for the entire spectrum, this technique fits for a linear
correction with wavelength.

Thus far, it has only been developed and fine-tuned for the 
1200 line grating of Keck/DEIMOS.  It is unlikely to work very
well for wavelengths much blueward of 6000Ang (where sky emission
lines are sparse).

Briefly, this algorithm:

1. Match slits across pairs of red/blue detectors

2. Measure the centroids of select sky lines

3. Fit the flexure solutions, slit by slit

4. Fit a 2D solution to all of the slits

5. Output, including QA

6. The user then needs to read in the output and apply it to their spectra with their own custom code.
   
Future work may combine this approach with the standard (e.g. 
implement cross-correlation with a stretch).

If you wish to adopt this approach (not recommended for most users), there are
several key steps:

First, modify your :doc:`pypeit_file` to turn off the standard flexure *and*
to avoid the vacuum frame::

   [flexure]
      spec_method = skip 
   [calibrations]
      [[wavelengths]]
         refframe = observed

After running PypeIt with the standard call, construct a simple flexure file
which mainly consists of a list of the spec1d files.  Here is the test file:: 

   # User-defined execution parameters
   [rdx]
   spectrograph = keck_deimos

   flexure read
   Science/spec1d_DE.20100913.22358-CFHQS1_DEIMOS_20100913T061231.334.fits
   flexure end

As desired, you can modify the 
:ref:`pypeit_par:FlexurePar Keywords` in the top block.
Last, run the `pypeit_deimos_flexure` script::

   pypeit_multislit_flexure flexure.file out_root

where out_root is the prefix for the FITS file generated that
contains the flexure solution for all of the slits.  
.. _nir-example:

***********
NIR Example
***********

Overview
========

This file provides an example for the
Gemini/GNIRS spectrograph on how to best
run a NIR reduction and especially how to set the
`calib` id's.

PypeIt File
===========

Here is some advice on how to setup your PypeIt file. 

To setup the pypeit file, pypeit_setup is run as::  

    pypeit_setup -r absolute_path -s gemini_gnirs -b -c A 

where -b indicates that the data use sky subtraction and the 
columns  `calib`, `comb_id`, `bkg_id`  are added to the pypeit file. 

The resulting pypeit file looks like::

    # Auto-generated PypeIt file
    # 2021-08-03

    # User-defined execution parameters
    [rdx]
    spectrograph = gemini_gnirs

    # Setup
    setup read
        Setup A:
            decker: 0.68arcsec_G5530
            dispname: 32/mmSB_G5533
            dispangle: 6.1887
    setup end

    # Read in the data

    data read
    path absolute_path
    |            filename |         frametype |           ra |         dec |   target |      dispname |           decker | binning |              mjd | airmass | exptime | dispangle | calib | comb_id | bkg_id |
    | N20170331S0216.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3709743134 |   1.077 |   300.0 |    6.1887 |     0 |       6 |     -1 |
    | N20170331S0217.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3746886267 |   1.068 |   300.0 |    6.1887 |     0 |       3 |     -1 |
    | N20170331S0218.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3784029399 |    1.06 |   300.0 |    6.1887 |     0 |      10 |     -1 |
    | N20170331S0219.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3821513967 |   1.053 |   300.0 |    6.1887 |     0 |       7 |     -1 |
    | N20170331S0220.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3858649384 |   1.047 |   300.0 |    6.1887 |     0 |       5 |     -1 |
    | N20170331S0221.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 |  57843.389578673 |   1.041 |   300.0 |    6.1887 |     0 |       4 |     -1 |
    | N20170331S0222.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 |  57843.393291443 |   1.036 |   300.0 |    6.1887 |     0 |       9 |     -1 |
    | N20170331S0223.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3970400927 |   1.032 |   300.0 |    6.1887 |     0 |       8 |     -1 |
    | N20170331S0206.fits | arc,standard,tilt | 192.84719583 | 12.37277778 | HIP62745 | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 |  57843.356848156 |   1.029 |    10.0 |    6.1887 |     0 |       2 |     -1 |
    | N20170331S0207.fits | arc,standard,tilt | 192.84719583 | 12.37277778 | HIP62745 | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 |  57843.357060926 |   1.028 |    10.0 |    6.1887 |     0 |       1 |     -1 |
    | N20170331S0208.fits | arc,standard,tilt | 192.84719583 | 12.37277778 | HIP62745 | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3572769754 |   1.028 |    10.0 |    6.1887 |     0 |      12 |     -1 |
    | N20170331S0209.fits | arc,standard,tilt | 192.84719583 | 12.37277778 | HIP62745 | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3575292903 |   1.028 |    10.0 |    6.1887 |     0 |      11 |     -1 |
    | N20170331S0252.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4641730017 |   1.053 |    0.84 |    6.1887 |     0 |      -1 |     -1 |
    | N20170331S0253.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4642846915 |   1.054 |    0.84 |    6.1887 |     0 |      -1 |     -1 |
    | N20170331S0254.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4643977316 |   1.054 |    0.84 |    6.1887 |     0 |      -1 |     -1 |
    | N20170331S0255.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 |  57843.464510193 |   1.054 |    0.84 |    6.1887 |     0 |      -1 |     -1 |
    | N20170331S0256.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4646238119 |   1.054 |    0.84 |    6.1887 |     0 |      -1 |     -1 |
    | N20170331S0257.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4647383952 |   1.054 |    0.84 |    6.1887 |     0 |      -1 |     -1 |
    | N20170331S0258.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4648516282 |   1.055 |    0.84 |    6.1887 |     0 |      -1 |     -1 |
    | N20170331S0259.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4649642825 |   1.055 |    0.84 |    6.1887 |     0 |      -1 |     -1 |
    | N20170331S0260.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4650775156 |   1.055 |    0.84 |    6.1887 |     0 |      -1 |     -1 |
    | N20170331S0261.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4651915202 |   1.055 |    0.84 |    6.1887 |     0 |      -1 |     -1 |
    data end

Reliable image typing and sequence generation based on header cards is not yet implemented for GNIRS.
Hence, several modifications to the PypeIt file need to be made before executing run_pypeit
Wavelength solutions can be robustly determined from OH sky lines, which due to 
flexure, is preferable to using the Ar lamp arcs, which will not be used. 
Typically the telluric star chosen is bright and will have high signal in a 
short amount of time resulting in weak sky lines relative to the telluric star 
itself. For this reason we cannot determine the tilt and and wavelength solutions from
the telluric standard (t_exp = 10s), thus, arc and tilt should be removed from the telluric
star's frame types.

Instead we will set its calibration id `calib` to match that of the 
nearest (in time) science image, which instructs pypeit to use the tilt and 
wavelength solution from that sequence for the telluric standard.
**Note that even if you don’t plan to telluric correct your data, it is advantageous
to always nevertheless include the telluric star in your PypeIt file.**
The reason is that PypeIt uses the telluric star as a crutch for object tracing, 
and if you have faint objects this will likely produce better results than if there 
is no telluric star in the PypeIt file, in which case PypeIt uses the slit/order boundaries as the
tracing crutch.

The calib id should be set to the same number for the frames that will be combined together to generate
the calibration image in question. The best strategy for choosing these frames and setting the associated
calib ids depends on the exposure time, dither pattern, and the instrument in question.
The example PypeIt file block below is for an ABBA sequence with GNIRS. To better understand how to
set the calib ids, it may help to eview how to set the `comb_id` and `bkg_id` for an ABBA sequence,
as described :doc:`A-B_differencing`. Below we are instructing PypeIt to average two A images together
as the science and subtract from this the average of two B images, which will generate one set of
spec2d and spec1d outputs. We do the same thing for the B images, i.e. combine them and subtract from them the combine
of the A images. This entire ABBA sequence has the same OH lines. If we really want a distinct
wavelength and tilt solution to be generated from the average of the As and another one to be generated from the
average of the Bs, then we would set the calib ids to be 0110, where the 0 and 1 are arbitrary numbers (i.e. it could
also be 4554). However, if the instrument is not expected to flex much in an ABBA sequence, it is actually advantageous
to combine the entire ABBA sequence into one Master frame for wavelength calibration and tilt generation. The reason
for this is that by averaging four images, the flux from the science object gets diluted. This is desirable
for OH wavelength and tilt calibrations because the object counts, particularly if the object is bright, is actually
a contaminant. In other words, we extract a 1d OH sky spectrum for the wavelength calibration and trace the arc lines
trajectories across the detector for the tilts. Obviously a bright object can mess this up. (For example in the optical
you would not turn the arc lamps on and take arcs while simultaneously observing a star through the slit). In the IR
often the sky is so bright relative to the objects and contaminates so few spatial pixels that this is not
much of a worry, but it still good practice to average away the object flux by combining the entire ABBA sequence
into set of calibration frames. For this reason for a single ABBA sequence, we set the calib ids to be 0 for
all the images in that sequence.

Based on this the gemini_gnirs_A.pypeit file will look like::


    # Auto-generated PypeIt file
    # 2021-07-27

    # User-defined execution parameters
    [rdx]
    spectrograph = gemini_gnirs

    # Setup
    setup read
        Setup A:
            decker: 0.68arcsec_G5530
            dispname: 32/mmSB_G5533
            dispangle: 6.1887
    setup end

    # Read in the data
    data read
    path absolute_path
    |            filename |         frametype |           ra |         dec |   target |      dispname |           decker | binning |              mjd | airmass | exptime | dispangle | calib | comb_id | bkg_id |
    | N20170331S0206.fits | standard | 192.84719583 | 12.37277778 | HIP62745 | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 |  57843.356848156 |   1.029 |    10.0 |    6.1887 |     0 |      0 |     2 |      1
    | N20170331S0207.fits | standard | 192.84719583 | 12.37277778 | HIP62745 | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 |  57843.357060926 |   1.028 |    10.0 |    6.1887 |     0 |      0 |     1 |      2
    | N20170331S0208.fits | standard | 192.84719583 | 12.37277778 | HIP62745 | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3572769754 |   1.028 |    10.0 |    6.1887 |     0 |      0 |     1 |       2
    | N20170331S0209.fits | standard | 192.84719583 | 12.37277778 | HIP62745 | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3575292903 |   1.028 |    10.0 |    6.1887 |     0 |      0 |     2 |       1
    | N20170331S0216.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3709743134 |   1.077 |   300.0 |    6.1887 |     0 |       3 |     4 |
    | N20170331S0217.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3746886267 |   1.068 |   300.0 |    6.1887 |     0 |       4 |     3 |
    | N20170331S0218.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3784029399 |    1.06 |   300.0 |    6.1887 |     0 |      4 |     3 |
    | N20170331S0219.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3821513967 |   1.053 |   300.0 |    6.1887 |     0 |       3 |     4 |
    | N20170331S0220.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3858649384 |   1.047 |   300.0 |    6.1887 |     1 |       5 |     6 |
    | N20170331S0221.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 |  57843.389578673 |   1.041 |   300.0 |    6.1887 |     1 |       6 |     5 |
    | N20170331S0222.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 |  57843.393291443 |   1.036 |   300.0 |    6.1887 |     1 |       6 |     5 |
    | N20170331S0223.fits |  arc,science,tilt | 205.53380833 |  9.47733611 |    pisco | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.3970400927 |   1.032 |   300.0 |    6.1887 |     1 |       5 |     6 |
    | N20170331S0252.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4641730017 |   1.053 |    0.84 |    6.1887 |     0,1,2,3 |      -1 |     -1 |
    | N20170331S0253.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4642846915 |   1.054 |    0.84 |    6.1887 |     0,1,2,3 |      -1 |     -1 |
    | N20170331S0254.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4643977316 |   1.054 |    0.84 |    6.1887 |     0,1,2,3 |      -1 |     -1 |
    | N20170331S0255.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 |  57843.464510193 |   1.054 |    0.84 |    6.1887 |     0,1,2,3 |      -1 |     -1 |
    | N20170331S0256.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4646238119 |   1.054 |    0.84 |    6.1887 |     0,1,2,3 |      -1 |     -1 |
    | N20170331S0257.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4647383952 |   1.054 |    0.84 |    6.1887 |     0,1,2,3 |      -1 |     -1 |
    | N20170331S0258.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4648516282 |   1.055 |    0.84 |    6.1887 |     0,1,2,3 |      -1 |     -1 |
    | N20170331S0259.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4649642825 |   1.055 |    0.84 |    6.1887 |     0,1,2,3 |      -1 |     -1 |
    | N20170331S0260.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4650775156 |   1.055 |    0.84 |    6.1887 |     0,1,2,3 |      -1 |     -1 |
    | N20170331S0261.fits |   pixelflat,trace | 205.53380833 |  9.47733611 | GCALflat | 32/mmSB_G5533 | 0.68arcsec_G5530 |     1,1 | 57843.4651915202 |   1.055 |    0.84 |    6.1887 |     0,1,2,3 |      -1 |     -1 |
    data end


Note that the telluric standard has its calib ids set to all 0s, which corresponds to the calib id of the nearest science ABBA sequence in time.

This PypeIt file and the associated data can be found in the  `PypeIt-Development-Suite <https://github.com/pypeit/PypeIt-development-suite/>`_. Try reducing
it!.. include:: include/links.rst

.. _detectors:

===================
Detector Parameters
===================

Basically anytime a raw image is loaded by ``PypeIt``, it also instantiates a
:class:`~pypeit.images.detector_container.DetectorContainer` object to hold
salient detector parameters.  Many of these parameters are hard-coded for each
supported instrument, but they can also be read from the frame in question.  The
detector parameters used during the data reduction are provided in most of the
primary ``PypeIt`` output files, including both the :ref:`spec-2d-output` and
the :ref:`masters`.

The datamodel for the
:class:`~pypeit.images.detector_container.DetectorContainer` object is:

.. include:: include/datamodel_detector.rst

Instrument-Specific Data
========================

The table below provides a subset of the the current detector parameters (see
the datamodel table above).  If the value is *always* read from the frame being
processed, the table entry is set to ``None``.  Currently, these parameters
*cannot* be changed programmatically (e.g., via the :ref:`pypeit_file`).  If you
see errors, please provide corrections via a PR or `Submit an issue`_.

.. include:: include/inst_detector_table.rst


************
Keck MOSFIRE
************

Overview
========

This file summarizes several instrument specific settings that are related to the Keck/MOSFIRE spectrograph.

PypeIt File
===========

Here is some advice on how to setup your PypeIt file.

To setup the :ref:`pypeit_file`, run::

    pypeit_setup -r absolute_path -s keck_mosfire -b -c A

where -b indicates that the data use sky subtraction and the columns  `calib`, `comb_id`, `bkg_id`
are added to the :ref:`pypeit_file:Data Block`. See :ref:`pypeit_setup` and
:doc:`A-B_differencing` for the syntax used for the data in these columns and how ``PypeIt`` uses them.

Here is an example of the :ref:`pypeit_file:Data Block` of the PypeIt file::

    # Read in the data
    data read
     path raw/
    |          filename |                 frametype |           ra |         dec |          target |       dispname |           decker | binning |            mjd |    airmass | exptime | filter1 | lampstat01 |  dithpat | dithpos | dithoff | frameno | calib | comb_id | bkg_id |
    | m120910_0410.fits | pixelflat,illumflat,trace |          7.8 |        45.0 |     Dome Phlatz | H-spectroscopy | MOSFIRE_DRP_MASK |     1,1 |  56180.6945327 | 1.41291034 | 14.5479 |       H |         on |    Stare |  object |     0.0 |     410 |     3 |      -1 |     -1 |
    | m120910_0411.fits | pixelflat,illumflat,trace |          7.8 |        45.0 |     Dome Phlatz | H-spectroscopy | MOSFIRE_DRP_MASK |     1,1 |  56180.6948371 | 1.41291034 | 14.5479 |       H |         on |    Stare |  object |     0.0 |     411 |     3 |      -1 |     -1 |
    | m120910_0412.fits | pixelflat,illumflat,trace |          7.8 |        45.0 |     Dome Phlatz | H-spectroscopy | MOSFIRE_DRP_MASK |     1,1 | 56180.69517159 | 1.41291034 | 14.5479 |       H |         on |    Stare |  object |     0.0 |     412 |     3 |      -1 |     -1 |
    | m120910_0175.fits |          arc,science,tilt | 344.98215835 | 33.00561651 | MOSFIRE_DRP_MAS | H-spectroscopy | MOSFIRE_DRP_MASK |     1,1 | 56180.53134073 | 1.27528573 | 29.0958 |       H |        off | Mask Nod |       A |     2.5 |     175 |     3 |       3 |     -1 |
    | m120910_0176.fits |          arc,science,tilt | 344.98372629 | 33.00516929 | MOSFIRE_DRP_MAS | H-spectroscopy | MOSFIRE_DRP_MASK |     1,1 | 56180.53198772 | 1.27866912 | 29.0958 |       H |        off | Mask Nod |       B |    -2.5 |     176 |     3 |      55 |     -1 |

    data end

The dither pattern, position and offset associated to each fame is reported here, but the `calib`, `comb_id`, `bkg_id`
columns are not properly set. The user can use the dither information to help guide the edit of these columns.


Calibrations
============

Edge Tracing
------------

Multi-slits
***********

``PypeIt`` is able to match the traced slit to the slit-mask design information
contained as meta data in the MOSFIRE observations. This functionality at the moment is
implemented only for MOSFIRE and DEIMOS and is switched on by setting **use_maskdesign** flag in
:ref:`pypeit_par:EdgeTracePar Keywords` to *True*.  This is, already, the default for MOSFIRE,
except when the *LONGSLIT* mask is used.

``PypeIt`` also assigns to each extracted 1D spectrum the corresponding RA, Dec and object name
information from the slit-mask design, and forces the extraction of undetected object at the location
expected from the slit-mask design. This functionality is also the default for MOSFIRE and can be
controlled through the flags **assign_obj** and **extract_missing_objs** in :ref:`pypeit_par:SlitMaskPar Keywords`.
See `Additional Reading`_ .

By default, ``PypeIt`` uses the dither offset recorded in the header of the science frames to find the
objects in the slits. However, a better procedure would be to let ``PypeIt`` compute the offset using
a bright object in one of the slits in the slit-mask. To do so, the user should provide in the :doc:`pypeit_file`
the ``maskdef_id`` (corresponding to "Slit_Number" in the MOSFIRE slit-mask design) of the slit containing the
bright object. Here is an example::

    [reduce]
       [[slitmask]]
            use_dither_offset = False
            bright_maskdef_id = 1

Note that ``maskdef_id`` is an ID associated to each slit in the slit-mask design, therefore it is instrument specific,
and it differs from ``SPAT_ID``, which is generated by ``PypeIt`` and assigned to each slit.

When the extraction of undetected object is performed, a gaussian profile with FWHM given by the parameter
``find_fwhm`` in :ref:`pypeit_par:FindObjPar Keywords` is assumed. The default value for MOSFIRE is **find_fwhm = 5**
(pixels), but the user needs to adjust this value according to the size of the objects to extract. Moreover,
it may be occasionally necessary to set **no_local_sky = True** in :ref:`pypeit_par:SkySubPar Keywords`
to avoid a bad local sky subtraction.

long2pos
********
This a custom CSU mask with two slits that are offset from the field center (plus a center alignment box),
which allows MOSFIRE observers to acquire standard star spectra that cover the entire accessible wavelength range.
Besides these two slits and the central alignment box, the rest of the mask is filled with random slits. Often, the
calibration frames don't have the same number of random slits as in the science frame, causing bad calibration
or the code to crash.
``PypeIt`` is able to exclude those random slits from the slit tracing process.
The parameter that controls the exclusion of detector regions from the slit edge tracing is **exclude_regions**
in :ref:`pypeit_par:EdgeTracePar Keywords`. By default, ``PypeIt`` excludes the regions where the random slits are
for a `long2pos` mask, but if the users want to modify that, they can do it in the :doc:`pypeit_file` in the
following way::

    [calibrations]
        [[slitedges]]
            exclude_regions = 1:0:880,1:1190:2040

This example would select two regions in det=1 between pixels 0 and 880 and between 1190 and 2040 in the x
direction of the detector.

Moreover, similarly to the multi-slits mask, ``PypeIt`` by default will match the traced slit to the slit-mask
design information contained as meta data in the MOSFIRE observations, and assign to each extracted 1D spectrum
the corresponding RA, Dec and object name information from the slit-mask design. However, forces the extraction
of undetected object is not performed by default.
Note that the RA and Dec recorded in the MOSFIRE observations of `long2pos` masks are mock numbers, therefore
the users should not use them.

LONGSLIT
********
Similarly to `long2pos`, `LONGSLIT` masks with a single slit that is shorter than the length of the
detector will have random slits that fill the mask. By default, ``PypeIt`` is capable of excluding
from the edge tracing process the regions where the random slits are for a `LONGSLIT` mask. However,
if the automatic selection of the regions to exclude does not look right, the users can still modify that
adding the **exclude_regions** parameter in the :doc:`pypeit_file` (as shown above), making sure that the
flag **bound_detector** is set to **True**.

Flat Fielding
-------------
Although ``PypeIt`` is able to recognize flat frames taken with the lamps off (and those frame will be
assigned the frame type ``pixelflat``, ``trace``, but not ``illumflat``), currently the lamps off flats
are not used to correct the dome flats for the thermal emission generated by the dome during K-band observations.

Wavelength calibration
----------------------
The wavelength calibration is generally performed using the OH lines in science frames and
the :ref:`wave_calib:Holy Grail` algorithm.








Additional Reading
==================

Here are additional docs related to Keck/MOSFIRE:

.. toctree::
   :maxdepth: 1

   dev/mosfireframes
   dev/slitmask_ids
   dev/radec_object
   dev/add_missing_obj
*********
Code Flow
*********

Overview
========

Setup
=====

Flow
----

Below is the code flow for the :ref:`pypeit-setup` script.  The
following are nearly all function names or object methods.
The module name is typically the first item, e.g. arparse.init
is a method in arparse.py.  Here goes::

   ├── pypeit_setup
   |  ├── pyputils.make_pypeit_file(pypeit_file, spectrograph, dfnames)
   |  ├── run_pypeit.parser(options)
   |  ├── pypeit.PypeIt(args)
   |  |  ├── load_input(pypeit_file)
   |  |  |  ++ generates pyp_dict
   |  |  ├── arparse.get_argflag_class()
   |  |  |  ++ generates argf Class
   |  |  ├── argf.init_param()
   |  |  ├── plines = argf.load_lines(parlines)
   |  |  ├── argf.set_paramlist(plines)
   |  |  ├── arparse.get_spect_class()
   |  |  |  ++ generates spect Class
   |  |  ├── spect.load_file(base=True)  # default
   |  |  ├── spect.set_paramlist(lines)
   |  |  ├── spect.load_file()  # instrument specific
   |  |  ├── spect.set_paramlist(lines)
   |  |  ├── spect.set_paramlist(plines)   # using pyp_dict
   |  |  ├── spect.load_lines(spclines)      # command line
   |  |  ├── argf.save()
   |  |  ├── spect.save()
   |  |  ├── arparse.init(argf, spect)  # Saved into settings.
   |  |  ├── # fitsdict created
   |  |  ├── fitsdict = arload.load_headers(datlines)
   |  |  |  ├── # Checks on FITS files
   |  |  |  ├── settings.spect['check'][ch]
   |  |  ├── # Flip dispersion direction (if needed)
   |  ├── ARMLSD  # This is formally below PypeIt, but I want to reduce the indentation here
   |  |  ├── armbase.SetupScience(fitsdict)
   |  |  |  ├── filesort = arsort.sort_data(fitsdict)
   |  |  |  |  ├── find_standard_file()
   |  |  |  |  ++ Generates filesort dict
   |  |  |  ├── arsort.match_science(fitsdict, filesort)
   |  |  |  |  ++ Written to settings.spect[ftag]['index']
   |  |  |  ├── arsciexp.ScienceExposure(i, fitsdict)
   |  |  |  |  ++ Generates sciexp list of ScienceExposure objects
   |  |  |  ++ setup_dict generated
   |  |  |  ├── arsort.instr_setup(sciexp, kk+1, fitsdict, setup_dict)
   |  |  |  |  ++ Generates setupIDs
   |  |  |  ++ group_dict generated
   |  |  |  ├── arsort.write_sorted(group_dict, setup_dict)
   |  |  |  ├── arsort.write_setup(setup_dict)


Items
-----

Items created and carried around::

    filesort
    fitsdict
    settings.spect
    settings.argf
    setup_dict
    group_dict
    sciexp

.. highlight:: rest

*************
Output Naming
*************

There is no standard for naming data reduction output products in
Astronomy, nor even common practices.  PypeIt follows its own schema.

A naming system must provide unique names (to avoid overwriting files)
but one also desires a format that is both compact and informative.
Our approach is a compromise between these competing requirements/desires.

Source Files
============

This section describes the components of file naming
for observed sources (including standard stars).

.. _prefix:

Prefix
------

The file type is indicated by its prefix, a short label.
The following Table lists all formats for the 
:ref:`outputs` of PypeIt.
We describe each and include the likely suffix(es). 

=======   ===========================================  ======
Prefix    Format                                       Suffix
=======   ===========================================  ======
spec1D    multi-extension FITS; one binary FITS table  .fits
          per extracted object
spec2D    multi-extension FITS; one 2D array per       .fits
          spectral image
qa        Series of figures assessing data reduction   .pdf
          and data quality
=======   ===========================================  ======

Instrument
----------

The second label indicates the instrument.  Here are the
set of currently supported instruments in PypeIt: 

.. PUT THESE IN include/links.rst

.. _KastWebSite: http://mthamilton.ucolick.org/techdocs/instruments/kast/
.. _LRISWebSite: https://www2.keck.hawaii.edu/inst/lris/
.. _LowRedux: http://www.ucolick.org/~xavier/LowRedux/

=====   ============= ======================= =======================
Instr   Telescope     Short Description       Web Page
=====   ============= ======================= =======================
kastb   Lick Shane 3m blue camera of the Kast KastWebSite_
                      dual-spectrometer 
kastr   Lick Shane 3m red camera of the Kast  KastWebSite_
                      dual-spectrometer  
lrisb   Keck I        blue camera of the LRIS LRISWebSite_
                      spectrometer
=====   ============= ======================= =======================

Date and Time
-------------

By including the UT observing date and time to the nearest second, we 
believe the filename is now unique.  The UT date + time are drawn from
the Header and refer to the start of the observation, if there
are multiple time stamps.  Other DRPs (e.g. LowRedux_)
have tended to use the Frame number as the unique identifier.
We have broken with that tradition: (1) to better follow 
archival naming conventions; (2) because of concerns that
some facilities may not include the frame number in the header;
(3) some users may intentionally or accidentally generate multiple
raw files with the same frame number.  

The adopted format is::

	YYYYMMMDDTHHMMSS
	e.g. 2015nov11T231402

A typical filename may then appear as::

	spec1D_lrisb_2011nov11T231402.fits

Source Identifiers
------------------

PypeIt reduces each detector separately and associates identified
slits and objects to that detector.  Therefore, sources are 
uniquely identified by a combination of these `source-id-values` (out of date!).  
If requested, the Spec1D files
can be exploded to yield one FITS file per source.  In this
case, the filenames are appended by the source identifiers::

	_DetID_SlitID_ObjID


A complete filename may then appear as::

	spec1D_lrisb_2011nov11T231402_02_783_423.fits

For sanity sake, files that are exploded in this manner are 
placed into their own folders named by the instrument and timestamp.


Calibration Files
=================

The following section describes the components of file naming
for calibrations.

.. include:: include/links.rst

.. _skysub:

===============
Sky Subtraction
===============

Overview
========

This document describes how PypeIt performs sky subtraction.

See :ref:`pypeit_par:SkySubPar Keywords` for the complete
list of options related to sky subtraction.

Global
======

Phase I of sky subtraction is to perform a fit to the sky across
the entire slit.  By default, this is done twice:  once without
any knowledge of objects in the slit and then again after object
detection has taken place (these are masked).

Default masking of objects is relatively benign.  The FWHM
of each object is estimated and then those pixels above a
set threshold in the profile are masked.

One can enforce more aggressive masking by
setting *mask_by_boxcar* which will mask each object by the
*boxcar_radius* set in :ref:`pypeit_par:ExtractionPar Keywords`::

    [reduce]
       [[extraction]]
          boxcar_radius = 2.5  # arcsec
       [[skysub]]
          mask_by_boxcar = True


Local
=====

Assuming you perform :ref:`extraction:Optimal` extraction,
the default is to refine the sky subtraction in tandem.

To turn this off (e.g. recommended for bright extended emission
lines on faint galaxy continua), set
*no_local_sky* in :ref:`pypeit_par:SkySubPar Keywords`::


    [reduce]
       [[skysub]]
          no_local_sky = True


Interactively defining the sky regions
======================================

PypeIt has an automatic algorithm (described above) to define
the sky regions, but this may not work in
your specific science case. There are several ways to define
the sky regions. The first option is to define the locations
on the slits where there is sky in your .pypeit file. The
command is a comma separated list of regions that represent
the locations on the slit (0 is the left edge, 100 is the
right edge)::

    [reduce]
      [[skysub]]
           user_regions = :20,65:

where in the example above, the sky regions are defined as all
pixels in all slices that are in the leftmost 20 percent of the
slit (i.e. :20), and the rightmost 35 percent of the slit (65:).
You can specify as many regions as you like. For example, 45:55
would indicate that the innermost 10 percent of pixels contains
sky. An alternative approach is to set the sky regions interactively.
This is the preferred approach if you want to set different sky
regions for every slit. Remember, you really should assign some
sky regions in every slit, otherwise the relative spectral
sensitivity correction will not work. To interactively define
the sky regions, you must first run through the reduction once,
and then use the following command::

    pypeit_skysub_regions filename.pypeit

You will be provided a list of science frames that you want to
define the sky regions for. Do this one science frame at a time.
Enter the corresponding number on the terminal and press enter.
You will see a GUI where you can click and drag regions on each
slit to define the sky regions. Hover the mouse over the window
and press the '?' key. This will print a list of options in the
terminal window, so that you know how to operate the GUI. A left
(right) mouse button click and drag will add (remove) pixels to
(from) the sky regions mask. Once you have defined some regions,
the red shaded regions represent the sky pixels. If you want to
set the sky regions for multiple slits, use the
"Assign sky regions to all slits"
bar on the right hand side of the GUI. The gray region represents
the slit, and the black regions represent outside the slit. You
need to click and drag only on the gray regions, or you can click
and drag from the gray to the black regions (i.e. you must click
and drag within this small window for it to work).

Alternatively, you can click the "Enter regions" button, which
will request input from the command line. You should now enter
the regions in the same format as above for the "user_regions".

If you're happy with the sky regions, press the
"Continue (and save changes)" button. If you do not wish to save
the sky regions, press the "Continue (and don't save changes)" button.
The menu bar at the top of the screen will prompt you if you
wish to save these sky regions (click on either YES or NO).
If you chose to save the regions file, the regions will be
saved in your "Masters" folder, with a prefix "MasterSkyRegions".
A given MasterSkyRegions file is linked to a science frame
based on the name of the MasterSkyRegions file.

Once you have defined all of the sky regions manually, re-run
the reduction. If a sky regions file exists in the Masters folder
for a corresponding science frame, it will be used as a default.
NOTE: If you manually create a sky regions file - this will be
used by default in PypeIt. You should either delete or rename
the MasterSkyRegions file if you later want to use the automatic
PypeIt algorithm.
===========
MasterTilts
===========

Overview
========

This file describes the data model for the `MasterTilts`_.


The images are written to disk as a multi-extension FITS file
prefixed by `MasterTilts`_ in the Masters/ folder.
See :ref:`masters:Masters Naming` for the naming convention.


Inspecting
==========

At present, the only way to examine the quality of this
step is by viewing the PNG files generated by the code.
:doc:`qa` describes how to access them.

There are 3 PNG files generated per slit:

2D Arc Tilts
------------

This QA shows the spectral,spatial positions of all
the lines traced by the code.  Here is an example
from `shane_kast_red`:

.. image:: figures/arc_tilts_2d.png

Here is what you hope to see in this QA:

 - RMS < 0.1
 - Very few red points
 - The red points are mainly at the very edges of the black lines
 - The black points span across the full detector

On the last point, if only a smaller portion of the detector
is covered, the code is extrapolating.
Indeed, the example above only shows
outputs down to ~480 Spectral Pixel which is not ideal.
Of course, this will be the case for spectrographs
that have data which does not span the full detector.

Spat Tilts
----------

This QA examines the residuals of (tilt position - model)
as a function of spatial offset along the slit.  Here
is an example from `shane_kast_red`:

.. image:: figures/arc_tilts_spat.png

One hopes to see small residuals and without any substantial
spatial dependence.  But, it is comment for there to be
significant residuals at the edges of the slit
(as in this example).

Spec Tilts
----------

This QA examines the residuals of (tilt position - model)
as a function of spetral offset along the slit.  Here
is an example from `shane_kast_red`:

.. image:: figures/arc_tilts_spec.png

One hopes to see:

 - The black points scattering about 0
 - The orange and green points not too far above 0

Trouble Shooting
================

If one or more of your image appears to be in err,
here are the things to consider:

Insufficient Lines
------------------

TODO: Explain how to add more


Current WaveTilts Data Model
============================

Internally, the image is held in
:class:`pypeit.wavetilts.WaveTilts`
which is a :class:`pypeit.datamodel.DataContainer`.
The datamodel written to disk is:


.. include:: include/datamodel_wavetilts.rst


.. include:: include/links.rst

.. _spec-2d-output:

=============
Spec2D Output 
=============

.. index:: spec2d

Overview
========

During the data-reduction process, ``PypeIt`` creates a series of 2D
spectral images prior to extraction of 1D spectra. And, of course,
several of these 2D images may have greater value for analysis than
the 1D spectra.

For each on-source exposure, ``PypeIt`` outputs a series of these
images in a single, multi-extension fits file, separated by detector.
See the `Current Spec2DObj Data Model`_ for details.

Naming
======

The 2D spectra files have names like::

    spec2d_b27-J1217p3905_KASTb_2015May20T045733.560.fits

The model is::

    Prefix_frame-objname_spectrograph_timestamp.fits

Inspecting
==========

You can open this image in ds9 and play around. But we highly
recommend using the `pypeit_show_2dspec`_ script which interfaces
with `ginga`_.

.. _pypeit_show_2dspec:

pypeit_show_2dspec
------------------

This script displays the sky-subtracted 2D image for a single
detector in a `ginga`_ RC viewer. It also overlays the slits and any
objects extracted. It should be called from the reduction directory,
i.e. above the ``Science/`` folder where the spec2d image is located.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_show_2dspec.rst

Here is a typical call:

.. code-block:: console

    pypeit_show_2dspec Science/spec2d_c17_60L._LRISb_2017Mar20T055336.211.fits


This opens 4 tabs in the `ginga`_ display, one for each of the
following:

 - Procesed image (sciimg-det##)
 - Sky subtracted image (skysub-det##)
 - Sky residual image (sky_resid-det##)
 - Full residual image which removes the object too (resid-det##)

Red/green lines indicate slit edges.  Orange lines (if present)
indicate traces for detected objects. Light blue lines (if present)
indicate traces for manually extracted objects.

As you mouse around, the x-values shown at the bottom indicate
the wavelength.

pypeit_chk_2dslits
------------------

This script prints to the screen a short summary of the slit
information, detector by detector.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_chk_2dslits.rst


Identifying Slits
=================

If you need to generate an image describing the location of each
slit/order for a given detector here is the recommended approach::

    from pypeit import spec2dobj
    spec2DObj = spec2dobj.Spec2DObj.from_file('spec2d_b170320_2083-c17_60L._LRISb_2017Mar20T055336.211.fits', det=2)
    slitmask = spec2DObj.slits.slit_img(flexure=spec2DObj.sci_spat_flexure)

If no flexure correction was applied, it will be ignored.
This generates an image with pixel values:

 - -1 for a pixel not in any slit/order
 - SPAT_ID for each pixel in the slit identified by SPAT_ID

.. _spec2dobj_datamodel:

Current Spec2DObj Data Model
============================

Internally, the image is held in
:class:`~pypeit.spec2dobj.AllSpec2DObj`, which holds the full set of
:class:`~pypeit.spec2dobj.Spec2DObj` objects.

All wavelengths are in vacuum.

The data model for the latter is:

.. include:: include/datamodel_spec2dobj.rst

Each array and the associated
:class:`~pypeit.images.detector_container.DetectorContainer` is
written as a separate HDU prefixed by the detector number,
``DET01-``.

For a description of how to use the bitmasks (i.e., the ``*BPMMASK``
extensions), see our description of the :ref:`out_masks`.

.. include:: include/links.rst

.. _setup_doc:

*****
Setup
*****

Overview
========

The :doc:`pypeit_file` is *the* critical component to any successful
run of ``PypeIt``, and :ref:`pypeit_setup` provides an automated
means of generating this file based on a set of fits files. Below, we
describe how ``PypeIt`` defines unique instrument configurations
("setups") and sorts data in preparation for the data reduction.

``PypeIt`` distinguishes between instrument configurations using
metadata pulled from the fits file headers, as defined specifically
for each spectrograph. To list the metadata used to establish the
instrument configuration, e.g.:

.. code-block:: python

    from pypeit.spectrographs.util import load_spectrograph
    spec = load_spectrograph('keck_deimos')
    spec.meta_key_map()

which will print::

    Metadata Key   Header Card
    ------------   -----------
              ra            RA
             dec           DEC
          target      TARGNAME
          decker      SLMSKNAM
         binning          None
             mjd       MJD-OBS
         exptime      ELAPTIME
         airmass       AIRMASS
        dispname      GRATENAM
           hatch      HATCHPOS
       dispangle          None
          idname       OBSTYPE
      lampstat01         LAMPS
         dateobs      DATE-OBS
             utc           UTC
            mode       MOSMODE
             amp       AMPMODE

where the left column provides the ``PypeIt``-specific metadata
keyword and the right column is the associated instrument-specific
header card. Any metadata element with a header card set to ``None``
means that the metadata keyword or value is conditioned on multiple
header values. In this example, the header card that provides the
central wavelength given the grating angle (``dispangle``) for DEIMOS
is dependent on the grating used (``dispname``); see
:func:`~pypeit.spectrographs.keck_deimos.compound_meta`. Generally
speaking, most instrument configurations are set by the name
(``dispname``) and central wavelength (``dispangle``) of the
dispersing element, the name of the decker or slit mask (``decker``),
the name of the beam-splitting dichroic (``dichroic``), and/or the
on-chip binning (``binning``). As of ``PypeIt`` version ``1.2.1dev``,
the following table provides the list of metadata used to define the
instrument configuration for *any* supported spectrograph.

=============== ======= =============== ===================================================================
Metadata Key    Type    Example         Description
=============== ======= =============== ===================================================================
``amp``         str     SINGLE:B        Name of the amplifier used to read the detector
``arm``         str     VIS             Name of the spectrograph arm used to collect the data
``binning``     str     1,1             On-chip binning
``datasec``     str     [1:256,1:512]   The science region of the detector
``decker``      str     long_1.0        Name of the decker or slit mask
``detector``    str     CHIP1           Name of the detector
``dichroic``    str     560             Name of the dichroic
``dispangle``   float   7500.0          Central wavelength for the dispersing element at the observed angle
``dispname``    str     830G            Name of the dispersing element
``filter1``     str     J               Name of the order-sorting filter
=============== ======= =============== ===================================================================

*Every unique combination* of the relevant metadata found in any of
the fits files to be reduced represents a unique instrument
configuration for ``PypeIt`` to consider; these configurations can be
determined automatically by :ref:`pypeit_setup` and will be
identified by a capital letter, e.g., **A**. When executing
:ref:`run-pypeit`, however, the instrument configuration is set by
the :ref:`setup_block` in the :ref:`pypeit_file` and not redetermined
by the fits files. The latter allows the user flexibility to override
``PypeIt``'s automated configuration settings. Currently, each
:ref:`pypeit_file` should only provide data from *one* instrument
configuration.

If you tend to observe with one instrument configuration and with a
simple set of calibrations, then the setup to run ``PypeIt`` should
be straightforward. However, if you use multiple configurations (e.g.
gratings, grating tilts, slitmasks), then you must pay more careful
attention to the setups.

Below, we describe how ``PypeIt`` automatically determines instrument
configurations for a set of files and constructs auto-generated
pypeit files.

.. _pypeit_obslog:

pypeit_obslog
=============

The ``pypeit_obslog`` script allows you to see a simple listing of the data
files in a given directory (or directories) and the metadata that ``PypeIt``
will pull from their headers. As always, the script usage can be displayed by
calling the script with the ``-h`` option:

.. include:: help/pypeit_obslog.rst

For example, if you've been observing with Keck DEIMOS, you can go into the
directory with the raw data and execute:

.. code-block:: console

    pypeit_obslog keck_deimos

Or you can point to the directory that you want to list:

.. code-block:: console

    pypeit_obslog keck_deimos -r /path/to/raw/data

The listing is printed to ``stdout``, but you can also specify a file for the
output. You can also select the metadata by which to sort the output, change
the columns that are printed, etc.

.. _pypeit_setup:

pypeit_setup
============

``PypeIt`` includes the :ref:`pypeit_setup` script that one executes
to prepare for the data reduction by automatically associating fits
files to specific :ref:`frame_types` and collecting groups of frames
collected in a unique instrument configuration. The script usage can
be displayed by calling the script with the ``-h`` option:

.. include:: help/pypeit_setup.rst

The following is a step-by-step procedure for preparing for the data
reduction.

0. Prepare
----------

Change your working directory to the one where you wish the reduced
data products to appear. Any directory will do.

1. First Execution
------------------

We recommend you first execute ``pypeit_setup`` like this::

    pypeit_setup -r path_to_your_raw_data/LB -s keck_lris_blue

where the two command-line options are *required* and provide:

  - ``-s``: Sets the spectrograph to be reduce. This is camera
    specific.
  - ``-r``: Sets the full path to the raw data and the root prefix of
    the FITS files

Specifically note that this first run does *not* include the ``-c``
argument.

This execution of ``pypeit_setup`` searches for all `*.fits` and
`*.fits.gz` files with the provided root directory. Generally, the
provided path should **not** contain a wild-card and it is best if
you provide the *full* path; however, you can search through multiple
directories as follows::

    pypeit_setup -r "/Users/xavier/Keck/LRIS/data/2016apr06/Raw/*/LB" -s keck_lris_blue

2. Inspect the outputs
----------------------

The call above creates two files in a ``setup_files/`` folder:

  - ``{spectrograph}_{date}.pypeit``: This is a dummy file that can
    be ignored.
  - ``{spectrograph}_{date}.sorted``: This shows the unique
    configurations and the list of frames associated with each
    configuration as determine by the automated procedures in
    ``PypeIt``. Each unique configuration is given a capital letter
    identifier (e.g., A,B,C,D...).

Here is an example ``.sorted`` file for some example Keck DEIMOS data:

.. include:: include/keck_deimos.sorted.rst

This ``sorted`` file contains two configurations, ``A`` and ``B``.
The "setup block" (the information between the ``###...`` and
``#--...`` lines) describes the instrument configuration specific to
this setup as determined using the relevant metadata. Each "setup
block" is followed by a table listing the files and relevant metadata
for all files matched to that instrument configuration. The data
provided is specific to each instrument, as defined by, e.g.,
:func:`~pypeit.spectrographs.keck_deimos.pypeit_file_keys`.

The ``sorted`` file is only provided as a means of assessing the
automated setup identification and file sorting, and we encourage you
to briefly review the results. You may recognize that you are missing
calibrations or you may be surprised to see more configurations than
you were expecting. In the latter case, you can help us improve the
automated procedures in ``PypeIt`` by submitting an issue on GitHub
(`Submit an issue`_) and including the sorted file in the issue
description.

Importantly, you should use the ``sorted`` file to decide which
configuration (as selected by its letter) you wish to reduce. Also
note that ``PypeIt`` cannot interpret any edits you make to this
file; all user-level edits to the frame-typing, association of frames
with given configurations, etc., must be done via the :doc:`pypeit_file`.

3. Second execution: Write the pypeit file for one or more setups
-----------------------------------------------------------------

Provided you are happy with the ``sorted`` file, you should execute
:ref:`pypeit_setup` a second time with the `--cfg_split` (shortcut
`-c`) option. This will generate one or more sub-folders and populate
each with a :doc:`pypeit_file`. Some example uses of the ``-c``
option are:

    - ``-c A``: This will generate one folder+file for the chosen
      configuration
    - ``-c A,C``: This will generate one folder+file for each input
      configuration
    - ``-c all``: This will generate folders+files for all
      configurations

An example execution that only produces the :ref:`pypeit_file` for
the A configuration is::

    pypeit_setup -r path_to_your_raw_data/LB -s keck_lris_blue -c A

This example will generate a new folder named ``keck_lris_blue_A``
and within it will be a file named ``keck_lris_blue_A.pypeit``.

-b option
+++++++++

If you wish to specify pairs (or groups) of files to use for
background subtraction (e.g. A-B), then include the `-b` option. This
simply adds the relevant columns to the :ref:`pypeit_file` that you
will need to edit by hand. The two columns added, ``comb_id`` and
``bkg_id``, are added by default for most near-IR spectrographs. See
:doc:`A-B_differencing` for the syntax used for the data in these
columns and how ``PypeIt`` uses them.


.. Where do we specify the pypeit image orientation convention, etc?  I want to
   specify somewhere that the exposure time needs to be in seconds.  Do we
   something like a "PypeIt Conventions" doc?

.. _new_spec:

****************
New Spectrograph
****************

Here are notes on how to add a new spectrograph from scratch or to add a new
mode. To do so, you should install ``PypeIt`` following the development path;
see :doc:`installing` and :doc:`dev/development`.

Entirely New
============

``PypeIt`` defines instrument-specific behavior/parameters using a python
class hierarchy; see :class:`~pypeit.spectrographs.spectrograph.Spectrograph`
for relevant documentation and the abstractions that will need to be defined
for new spectrographs.

``PypeIt`` reductions follow three different data-reduction paths: (1)
single, long-slit, or multi-slit reductions (e.g., Keck DEIMOS), (2) echelle
reductions for spectrographs that observe multiple, cross-dispersed orders
(e.g., Keck NIRES), and (3) slit-based integral-field spectrographs (e.g.,
KCWI). When introducing a new spectrograph, it is helpful to start with the
class for a supported spectrograph and alter it for the new spectrographs.
All spectrograph classes are located in ``pypeit/spectrographs/``, starting
from the top-level of the repository. See :ref:`instruments` for a table with
the data-reduction (pipeline) path used for each spectrograph.

The class-hierarchy is used by ``PypeIt`` to specify certain instrument
modes, like spectrograph arm, that inherit from a common base class. For
example, :class:`~pypeit.spectrographs.keck_lris.KeckLRISSpectrograph`
implements many of the methods that are common to both arms (red and blue) of
the spectrograph. These include methods used to read raw files, used to
define header cards with required :doc:`metadata`, and used to determine the type of
frame (arc, dome, bias, etc) based on that :doc:`metadata`. The
:class:`~pypeit.spectrographs.spectrograph.Spectrograph` instance for each
LRIS arm inherits these methods common to them both by subclassing from
:class:`~pypeit.spectrographs.keck_lris.KeckLRISSpectrograph`. If your
spectrograph has a similar set of modes, see
``pypeit/spectrographs/keck_lris.py`` for a demonstration.

.. note::

    - The class-hierarchy is *not* meant to capture different instrument
      configurations (gratings, filters, etc).
    - The `name` attribute of a spectrograph *should be None* if the class is
      only a base class.

Having said all of that, the basic steps one needs to follow to introduce a
new spectrograph are as follows:

#. Build a new file called ``name_of_spectrograph.py`` file and put it in the
   ``pypeit/spectrographs/`` directory.

#. Add the new module to the list imported by
   ``pypeit/spectrographs/__init__.py``.

#. Generate a new Telescope object in (if new)
   ``pypeit/telescopes.py``.

#. Add telescope name to valid_telescopes in
   ``pypeit/par/pypeitpar.py``.

#. Set the algorithmic path: the class attribute, ``pypeline``, must be
   ``'MultiSlit'``, ``'Echelle'``, or ``'IFU'``.

#. Set the default parameters ``PypeIt`` uses during the reduction; see
   :ref:`pypeitpar`, and, e.g.,
   :func:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.default_pypeit_par`.

#. Include a default bad-pixel mask; see, e.g.,
   :func:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.bpm`.

#. Define the link between header keywords read from the raw fits files and
   the ``PypeIt``-specific :doc:`metadata` keys used throughout the code; see e.g.,
   :func:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.init_meta`
   and :func:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.compound_meta`.

#. Define the set of ``PypeIt``-specific :doc:`metadata` keys that are used to
   establish a unique instrument configuration; see, e.g.,
   :func:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.configuration_keys`.

#. Define the method used to determine the frame type of a given file based on
   its :doc:`metadata`; see, e.g., 
   :func:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.check_frame_type`.

#. Set the :doc:`metadata` for the instrument detector(s); see, e.g.,
   :func:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.get_detector_par`.

#. Define the method used to read the raw data.  See
   :func:`~pypeit.spectrographs.spectrograph.Spectrograph.get_rawimage` and
   compare to, e.g.,
   :func:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.get_rawimage`.

#. For echelle spectrographs, there are numerous methods required that provide
   details for the (currently fixed) format of the orders.

#. You may need to generate wavelength solutions for your setups. You can use the
   :ref:`wave_calib:pypeit_identify` utility, and add this to the PypeIt archive
   by following the steps outlined in the :doc:`construct_template` documentation.


See this `example PR <https://github.com/pypeit/PypeIt/pull/1179>`_ for the SOAR/Goodman spectrograph.


Near-IR
+++++++

If this is a near-IR instrument, you may wish to turn off calibration steps.
See :class:`~pypeit.spectrographs.gemini_gnirs.GeminiGNIRSSpectrograph` for
an example.

Tests
+++++

For a spectrograph to be supported going forth, we require a mininum set
of tests.  These are:

- A full run of the pipeline for each grating/mode of the spectrograph in the PypeIt Development Suite.
- A unit test in ``test_load_images.py`` to tickle the I/O.

Docs
++++

We request that the following docs be updated to advertise the new
spectrograph:

- The top-level ``README`` file
- The ``index.rst`` file in ``doc/``
- Also update the ``CHANGES.rst``


.. include:: include/links.rst

.. _out_masks:

===============
Output Bitmasks
===============

``PypeIt`` uses bitmasks to flag data for various reasons. For a 
primer on the general use of bitmasks, see the `SDSS bitmasks`_
primer.

See also:

.. toctree::
   :maxdepth: 1

   bitmasks

----   

In terms of the output data, the main bitmask you will encounter is
in the :ref:`spec-2d-output`. The ``BPMMASK`` extension in these file
contain the bad-pixel bitmask values accrued during the processing
and reduction of the data. The main object that manages the bitmasks
is :class:`~pypeit.images.imagebitmask.ImageBitMask`, which defines
the following bits:

.. include:: include/imagebitmask_table.rst

You can construct the appropriate bitmask in two ways:

    - (Recommended) Instantiate the bitmask directly:

      .. code-block:: python

        from pypeit.images.imagebitmask import ImageBitMask
        bm = ImageBitMask()

    - Specifically for the ``spec2d*`` files, the names of the bits
      and their order is saved to the header. You can instantiate a
      generic :class:`pypeit.bitmask.BitMask` from the header;
      however, it's not clear how long this behavior will remain. To
      instantiate the relevant :class:`~pypeit.bitmask.BitMask` from
      the header:

      .. code-block:: python

        from astropy.io import fits
        from pypeit.bitmask import BitMask
        hdu = fits.open('spec2d_b27-J1217p3905_KASTb_2015May20T045733.560.fits')
        bm = BitMask(hdu[1].header['IMGBITM'].split(','))


With the :class:`~pypeit.bitmask.BitMask` or
:class:`~pypeit.images.imagebitmask.ImageBitMask` instantiated, you
can interpret the meaning of the ``BPMMASK`` extensions as follows:

    - Use the :func:`~pypeit.bitmask.BitMask.flagged` method to
      produce a boolean array that selects pixels flagged with a
      given bit:

      .. code-block:: python

        extract_flag = bm.flagged(hdu['DET01-BPMMASK'].data, flag='EXTRACT')

    - Use the same method to select multiple bits:

      .. code-block:: python

        process_flag = bm.flagged(hdu['DET01-BPMMASK'].data, flag=['BPM', 'CR', 'SATURATION'])

    - Or select bits that are flagged for *any* reason:

      .. code-block:: python

        bpm = hdu['DET01-BPMMASK'].data > 0

    - To get the human-readable reason that any given value is
      flagged, use the :func:`~pypeit.bitmask.BitMask.flagged_bits`
      method:

      .. code-block:: python

        print(bm.flagged_bits(hdu['DET01-BPMMASK'].data[0,0])) 

===================
Telluric correction
===================

Overview
========

Telluric correction is done after the main run of PypeIt, :doc:`fluxing` and
:doc:`coadd1d`.  The algorithm for deriving the best telluric model is pretty
similar with that used in the IR sensitivity function, which fits an user
defined model and telluric to a giant telluric grid. Please see :doc:`fluxing`
for more details.

Note that execution of ``pypeit_tellfit`` requires the atmospheric model grids
to be installed on your system.  See the instructions for installing these
:ref:`data_installation`.

pypeit_tellfit
==============

The primary script is called `pypeit_tellfit`_ which takes
an input file or arguments to guide the process. There are three
different object models for the fitting:

object models
-------------

The object model options are:
 - qso = for quasar or AGN.
 - star = for stellar object.
 - poly = can be used for any other object by solving polynomial model.

tellfit file
------------

The format of that file
is described in the *usage* of the script, i.e. type
*pypeit_tellfit -h*. Here are three examples for
three different object models ::

    # User-defined tellfit parameters for a quasar at redshift seven
    [tellfit]
         objmodel = qso
         redshift = 7.0
         bal_wv_min_max = 10825,12060

    OR

    # User-defined tellfit parameters for a A0 type star
    [tellfit]
         objmodel = star
         star_type = A0
         star_mag = 8.0

    OR

    # User-defined tellfit parameters for other type target
    [tellfit]
         objmodel = poly
         polyorder = 3
         fit_wv_min_max = 17000, 22000

See `Parameters`_ for details.


run
---

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_tellfit.rst

Example script executions would be::

    pypeit_tellfit J1342_GNIRS.fits -t gemini_gnirs.tell

or::

    pypeit_tellfit J1342_GNIRS.fits --objmodel qso -r 7.52

A substantial set of output are printed to the screen, and
if successful the final spectrum is written to disk. Both
input and output file are in the standard coadd1d data model format.
See :doc:`coadd1d` for the current data model.



The parameters that guide the tellfit process are also written
to disk for your records. The default location is *telluric.par*.
You can choose another location with the `--par_outfile`_
option.

Command Line Options
--------------------

--objmodel
+++++++++++++
Your object model, either qso, star or poly.

--tell_grid OR -g
+++++++++++++++++

The full path for the telluric grid file. In case of spectrograph which
has defined the default grid, you do not need to set this argument.

--pca_file or -p
++++++++++++++++

The full path for the qso pca pickle file. Only used in the qso model.
The default is qso_pca_1200_3100.pckl which should be downloaded and put in
the pypeit telluric data folder.

--tell_file or -t
+++++++++++++++++

The tellfit parameter file.

--redshift or -r
++++++++++++++++

Redshift of your object.

--debug
+++++++

show debug plots if set.

--plot
++++++

show the final telluric corrected spectrum if set.

--par_outfile
+++++++++++++

File name for the tellfit parameters used in the fit.


Parameters
==========

qso model
---------

The two main parameters for a qso model are::

  redshift and bal_wv_min_max

redshift
++++++++

The redshift of your science object you want to correct telluric absorption

bal_wv_min_max
++++++++++++++

You can set a bal_wv_min_max if your quasar/AGN is a broad absorption line quasar.
It is a list with even float numbers in the format of (in case of two absorption troughs)::

    bal1_wave_min, bal1_wave_max, bal2_wave_min, bal2_wave_max

star model
----------

The main parameters for a star model are::

  star_type and star_mag

star_type
+++++++++

The spectra type of your star. If A0, it will use VEGA spectrum, otherwise will use a
Kurucz SED model.


star_mag
++++++++

V-band magnitude of your star.

poly model
----------

The main parameters for a poly model are::

  poly_order and fit_wv_min_max

poly_order
++++++++++
The polynomial order you want to use for modeling your object

fit_wv_min_max
++++++++++++++

You can specify a list of specific regions used for the fitting, if not
set it will simply use the whole spectrum. The format for this parameter
is exactly same with the `bal_wv_min_max`_ defined above.


Show your final telluric corrected spectrum
===========================================

The final spectrum may be viewed with the *lt_xspec* script which loads the data
and launches a GUI from the linetools package. e.g.::

    lt_xspec J1342_GNIRS_tellcorr.fits

.. NEED TO DOCUMENT THE tellmodel FILE    

.. include:: include/links.rst

.. _image_proc:

======================
Basic Image Processing
======================

Here we describe the basic image processing steps performed by ``PypeIt``,
specifically their order, salient details, and how to toggle specific steps
using the :ref:`pypeit_file`.  This description is meant to be general to *all*
spectrographs.  For instrument-specific advice, see :ref:`spec_details`.

Unless otherwise stated, the relevant parameters governing basic image
processing are kept by :class:`~pypeit.par.pypeitpar.ProcessImagesPar`; see
:ref:`pypeitpar`.  Importantly, however, changing the default parameters for
some frame types will lead to faults; see :ref:`proc_algorithm` and
:ref:`workflow`.

.. _overview:

Overview
========

We provide a very general approach to image processing with hooks to toggle each
step, as appropriate for different frame types and/or different instruments.
Generally, we treat pixel values, :math:`p`, in an astronimcal image (in units of ADU) as containing
the following components:

.. math::

    p = O + B + (C + N_{\rm bin}\ D\ t_{\rm exp}) / g

where:

    - :math:`O` is a frame-dependent bias estimate (in ADU) using image overscan
      regions,
    - :math:`B` is a longer-term pixel-by-pixel bias estimate (in ADU after
      overscan subtraction) using bias images,
    - the quantity :math:`C=c/s` is the number of electron counts excited by
      photons hitting the detector,
    - :math:`1/s` is an efficiency factor (one of many) that accounts for relative
      throughput factors (see below) that can be measured from flat-field frames,
    - :math:`D` is the dark-current, i.e., the rate at which the detector
      generates thermal electrons, in e-/pixel/s,
    - :math:`N_{\rm bin}` is the number of pixels in a binned pixel,
    - :math:`t_{\rm exp}` is the exposure time in seconds, and
    - :math:`g` is the amplifier gain in e- per ADU.

By "relative throughput," we mean the aggregate of relative (to, say, the center
of the field) telescope+instrument+detector efficiency factors that can be
measured from flat-field images (see :ref:_flat_fielding), like pixel-to-pixel differences in quantum
efficiency (known as the pixelflat), spatial variations in slit illumination
as a result of vignetting or instrument optics (known as the illumflat),
and variations in slit illumination in the spectral direction (known as specillumflat).  The
goal of the basic image processing is to solve for :math:`c` in a set of science
and calibration frames using a set of frames that isolate the detector bias,
dark current, and relative throughput, to find:

.. math::

    c = s\ \left[ g\ (p - O - B) - N_{\rm bin}\ D\ t_{\rm exp} \right]

During this process, we also generate a noise model for the result of the image
processing, calculated using :func:`~pypeit.core.procimg.variance_model`.  The
full variance model, :math:`V`, is:

.. math::

    V = s^2\ \left[ {\rm max}(0, C) + N_{\rm bin}\ D\ t_{\rm exp} +
            V_{\rm rn} + V_{\rm proc} \right] + \epsilon^2 {\rm max}(0, c)^2

where

    - :math:`V_{\rm rn}` is the detector readnoise variance (i.e., read-noise in
      e- squared),
    - :math:`V_{\rm proc}` is added variance from image processing (i.e., this
      term in includes uncertainty from the bias subtraction, etc.), and
    - :math:`\epsilon` is an added error term that imposes a maximum
      signal-to-noise on the scaled counts.

We emphasize that this is a *model* for the per-pixel image variance,
particularly because we are using the as-observed pixel value to estimate the
Poisson error in the observed counts.  This estimate systematically
overestimates the variance toward low counts (:math:`\lesssim 2 \sigma_{\rm
rn}`), with a bias of approximately :math:`1.4/\sigma_{\rm rn}` for :math:`C=0`
(i.e., about 20% for a readnoise of 2 e-) and less than 10% (for any readnoise)
when :math:`C\geq1`.  The reason for this bias is that one is trying to estimate the
variance of a Poisson process from a noisy realization of the true underlying count
rate. To mitigate this bias, the variance model is typically updated during the
sky-subtraction and object-extraction procedures.

.. _proc_algorithm:

Processing Algorithm
====================

The basic image processing steps are performed by
:class:`~pypeit.images.rawimage.RawImage`.  Regardless of the image
:ref:`frame_types`, the order of operations is always the same:

.. contents:: Processing Steps
    :depth: 1
    :local:

Conversion to Counts
--------------------

First, the image units are converted to electron counts using the gain (in
e-/ADU) for each amplifier.  Even though :math:`O` and :math:`B` are in ADU in
the equation for :math:`p` above, they can be measured in e- by applying the
gain.  More importantly, how they are measured must be consistent across all
images.  The ``apply_gain`` parameter defaults to true, and you should rarely
(if ever) want to change this.  However, if you do, **make sure you change it
for all images you process**; i.e., you don't want to be bias subtracting an
image in ADU (``apply_gain = False``) from an image in e- (``apply_gain =
True``).  The units of the processed images are saved to the image header as
``UNITS``, which can be either ``'e-'`` or ``'ADU'``.

Pattern-Noise Subtraction
-------------------------

Some instruments, specifically Keck KCWI, are known to have a sinusoidal pattern
in its bias.  :func:`~pypeit.images.rawimage.RawImage.subtract_pattern` models
and subtracts this pattern from the data based on the overscan regions.  Unless
you know such a pattern exists in your data, you should set the ``use_pattern``
option to false (the default) for *all* frames.

Currently no error associated with this pattern subtraction is included in the
image-processing error budget; however, if the readnoise is determined
empirically, the error in the pattern noise subtraction will effectively be
included in the read-noise estimate.  It's worth considering using the empirical
readnoise calculation if you're applying the pattern subtraction.

Read and Digitization Noise
---------------------------

Readnoise variance, :math:`V_{\rm rn}`, is calculated by
:func:`~pypeit.core.procimg.rn2_frame`.  The calculation requires the detector
readnoise (RN in elections, e-) and, possibly, gain (:math:`g` in e-/ADU)
for each amplifier, which are provided for each amplifier by the
:class:`~pypeit.images.detector_container.DetectorContainer` object defined for
each detector in each :class:`~pypeit.spectrographs.spectrograph.Spectrograph`
subclass.  If a readnoise value is set to :math:`\leq 0`, the readnoise is
estimated by the variance in the overscan regions of the image being processed;
see :func:`~pypeit.images.rawimage.RawImage.estimate_readnoise`; use of the
readnoise estimate regardless of the value provided by the
:class:`~pypeit.images.detector_container.DetectorContainer` object can also be
explicitly requested by setting the ``empirical_rn`` parameter to true.

By default, the readnoise variance image does *not* include digitization noise.
Digitization noise is driven by the conversion from counts to ADU via the gain
and the quantization to an integer.  One can derive the digitization noise by
taking the second moment of a uniform distribution from -1/2 to 1/2 to find
:math:`\sqrt{1/12}` ADU [1]_ [2]_, which is typically negligible (i.e., when the
gain is on the same order as the readnoise).  And, in most cases, digitization
noise will have been included in the estimate of the readnoise.  For this
reason, digitization noise is *not* explicitly included in the ``PypeIt``
variance model, and its inclusion cannot be turned on using a ``PypeIt``
parameter.  If you need to add digitization noise for your instrument, please
`Submit an issue`_.

Overscan Subtraction
--------------------

If available, the raw-image reader for each spectrograph returns the overscan
region of the detector; see
:func:`~pypeit.spectrographs.spectrograph.Spectrograph.get_rawimage`.  Overscan
subtraction uses this region of the image to subtract a per-frame bias level;
see :func:`~pypeit.core.procimg.subtract_overscan`.  Set the ``use_overscan``
parameter to false if you do not want to use the overscan in this way or, more
importantly, your instrument detector does not include an overscan region;
supported instruments with no overscan regions should have
``use_overscan=False`` as the default.  Uncertainty in the overscan subtraction
is propagated to the image-processing error budget. 

Trimming & Re-orientation
-------------------------

The raw-image reader for each spectrograph returns the primary data region of
the detector; see
:func:`~pypeit.spectrographs.spectrograph.Spectrograph.get_rawimage`.  Trimming
crops the image to only include the primary data region; see
:func:`~pypeit.core.procimg.trim_frame`.  Trimming will be performed if the
``trim`` parameter is true.

The ``PypeIt`` convention is to orient images for spectra to run along the first
axis of an image --- from blue wavelengths at small pixel coordinates to red
wavelengths at large pixel coordinates --- and the spatial or cross-dispersion
direction to be along the second axis --- with echelle orders running from the
highest order at small pixel coordinates to the lowest order at large pixel
coordinates.  That is, the shape of the images is always (roughly) the number of
spectral pixels by the number of spatial pixels, often referred to in our
documentation as ``(nspec,nspat)``.  The operations required to flip/transpose
the image arrays to match the ``PypeIt`` convention are dictated by
instrument-specific :class:`~pypeit.images.detector_container.DetectorContainer`
parameters and performed by
:func:`~pypeit.spectrograph.spectrographs.Spectrograph.orient_image`.  Image
orientation will be performed if the ``orient`` parameter is true.

.. warning::

    **Never** turn off image trimming or image orientation.  All processed
    images are expected to have been trimmed and re-oriented according to the
    ``PypeIt`` convention.  It will break the code if you turn these options
    off.

Bias Subtraction
----------------

Overscan regions are generated by additional reads of the detector beyond its
size along the readout direction, and overscan subtraction provides a single
correction for the full 2D image (if ``overscan_method`` is ``median``) or a
correction for each pixel along the readout direction (if ``overscan_method`` is
not ``median``).  Combining many overscan-subtracted bias images provides a 2D,
pixel-to-pixel bias-level correction in the science region of the detector.  To
perform bias subtraction, include bias frames in your :ref:`pypeit_file` and set
``use_biasimage`` to true.  The bias correction (see
:func:`~pypeit.images.rawimage.RawImage.subtract_bias`) is applied *after*
trimming and orientation.  Uncertainty in the bias subtraction is propagated to
the image-processing error budget. 

Dark Subtraction
----------------

In addition to readnoise and gain, our instrument-specific
:class:`~pypeit.images.detector_container.DetectorContainer` objects also
provide the expected dark current; see :ref:`detectors`.  The tabulated dark
current must be in elections per pixel per hour; note that "per pixel" means per
*unbinned* pixel; dark current in a binned pixel is :math:`N_{\rm bin}` higher
than in an unbinned pixel.  As of version 1.6.0, this tabulated dark current
(scaled by the frame exposure time and the binning) is *always* subtracted from
the observed images (i.e., there is currently no parameter that will turn this
off).  This is primarily due to how we account for dark current in our image
variance model (see above); i.e., the :math:`D` term is assumed to be the same
for all images taken with a given instrument.

Importantly, ``PypeIt`` also subtracts this tabulated dark-current value from
any provided dark frames.  This means that dark frames, combined into the
``MasterDark``, are used to correct for the 2D, pixel-to-pixel deviation in the
measured dark current with respect to the tabulated value.  These deviations are
expected to be small compared to the tabulated dark current value, and a warning
is thrown if the median difference between the measured and tabulated dark
current is larger than 50%.

If you have collected dark images and wish to subtract them from your science
frames, include them in your :ref:`pypeit_file` and set ``use_darkimage`` to
true; see :func:`~pypeit.images.rawimage.RawImage.subtract_dark`.  Note that if
you bias-subtract the science frames and you plan to also subtract a combined
dark frame, make sure that you bias-subtract your dark frames!  ``PypeIt``
automatically scales the sum of the tabulated dark current and the
``MasterDark`` by the ratio of the exposure times to appropriately subtract the
counts/s measured by the master dark frame.

.. note::

    Nominally, the exposure time for dark images should be identical to the
    frames they are applied to, meaning that the ratio of exposure times is
    unity.  Beware how the dark images are processed when this is not the case.
    Specifically, scaling by the ratio of the exposure times assumes the
    processed dark frame **only includes dark counts**; i.e., the dark image
    cannot include a bias offset.  When the exposure times are different, also
    note that it is important from a noise perspective that the dark exposures
    always be at least as long as your longest exposure time in the same
    calibration group.  Calibration groups are discussed by :ref:`setup_doc`,
    :ref:`a-b_differencing`, and :ref:`2d_combine`.

Spatial Flexure Shift
---------------------

A spatial shift in the slit positions due to instrument flexure is calculated
using :func:`~pypeit.core.flexure.spat_flexure_shift` if the
``spat_flexure_correct`` parameter is true.  See :ref:`flexure` for additional
discussion.

Flat-fielding
-------------

The processed images can be flat-field corrected for pixel-to-pixel throughput
variations (``use_pixelflat``), the slit illumination profile
(``use_illumflat``), and the relative spectral response (``use_specillum``).
These multiplicative corrections are all propagated to the image-processing
error budget.  See :ref:`flat_fielding` for additional discussion.

.. note::

    Currently, to apply the slit-illumination and spectral response corrections,
    you must also apply the pixel-to-pixel correction. I.e., in order to perform
    *any* flat-field correction, ``use_pixelflat`` must be true.

Counting Statistics and Noise Floor
-----------------------------------

Components of the error budget (see the :ref:`overview`) are calculated
throughout the processing steps.  The two final components are:

    #. Shot noise in the electron counts are added if the ``shot_noise``
       parameter is true.  With the exception of bias frames, all images should
       include the shot-noise calculation (including the dark frames).

    #. For the on-sky observations (sky, standard, and science frames),
       ``PypeIt`` imposes a per-pixel noise floor by adding a fractional count
       to the error-budget.  Specifically, the quantity :math:`(\epsilon\ c)^2`
       (see the :ref:`overview`) is added to the variance image, where
       :math:`\epsilon` is set by ``noise_floor`` and :math:`c` is the rescaled
       (i.e., flat-field-corrected) counts.  In the limit where :math:`c` is
       large, this yeilds a maximum signal-to-noise per pixel
       (:math:`c/\sqrt{V}`) of ``1/noise_floor``.  To remove this, set
       ``noise_floor`` to 0.

Cosmic Ray Identification and Masking
-------------------------------------

.. TODO: SHOULDN'T THIS BE DONE **BEFORE** FLAT-FIELDING?  Is there a
   reference/description of what's done to remove the false positives?

``PypeIt`` will identify and mask cosmic rays, if the ``mask_cr`` parameter is
true.  ``PypeIt`` uses a combination of the L.A. Cosmic Ray rejection algorithm
[3]_ and some follow-up filtering to identify and remove false positives.  The
most relevant parameters in the algorithm are editable via the
:ref:`pypeit_file`; see
:func:`~pypeit.images.pypeitimage.PypeItImage.build_crmask` and
:func:`~pypeit.core.procimg.lacosmic`.

.. _workflow:

Workflow Flexibility
====================

The main parameters dictating the image processing workflow are provided in the
table below.  The first column gives the parameter, ordered by their effect on
the algorithm above, and the second column gives its default value, independent
of the frame type.  The subsequent columns give generic changes to those defaults
made for each frame type; empty cells in these columns mean the parameter has
the default value.  The frame type order is the order in which they're processed
within the ``PypeIt`` workflow (modulo subtle differences between when the
arc+tilt images are processed compared to the slit trace images when reducing
IFU data vs. multi-slit/echelle data).  When making changes to the workflow via
the parameters, make sure to consider that the order of operations, as
illustrated by this table, go from top to bottom and left to right.  Also beware
that some changes will lead to faults or silent bugs.  In particular, ``PypeIt``
always expects processed images to have been trimmed and re-oriented to match
the ``PypeIt`` convention.

.. note::

    These are the instrument-independent parameter defaults.  Each
    :class:`~pypeit.spectrographs.spectrograph.Spectrograph` subclass can alter
    these defaults as needed for the typical approach that should be taken for
    data from that instrument, and users can make further alterations as needed
    for their specific data via the :doc:`pypeit_file`.  See :ref:`pypeitpar`.

.. include:: include/imgproc_defaults_table.rst

.. warning::

    The basic image processing workflow is largely independent for each frame
    type.  In particular, there's no intelligent automated checking in place for
    how master frames are processed and whether it is correct to apply those
    masters to other frames.  For example, if you overscan subtract your bias
    frames, you should also overscan subtract all other frames before performing
    bias subtraction, and vice versa.  When altering the processing workflow, it
    is up to the user to make sure that the processing of images is appropriate
    across all frame types.

Masking
=======

``PypeIt`` uses bitmasks to flag pixels for various reasons.  See
:ref:`out_masks` for a description of these masks and how to use/parse them.


.. [1] `Newberry (1991, PASP, 103, 122) <https://ui.adsabs.harvard.edu/abs/1991PASP..103..122N/abstract>`_
.. [2] `Merline & Howell (1995, ExA, 6, 163) <https://ui.adsabs.harvard.edu/abs/1995ExA.....6..163M/abstract>`_
.. [3] `van Dokkum (2001, PASP, 113, 1420) <https://ui.adsabs.harvard.edu/abs/2001PASP..113.1420V/abstract>`_



********
MetaData
********

.. index:: Metadata

Overview
========

PypeIt will slurp from the raw data frames a set of
meta data for performing the reduction.  These are
held in an astropy Table within the PypeItMetaData class.

The following doc is mainly for developers but we begin
with a point or two for the user.

User
====

The meta data is primarily ingested via code but the
user will over-ride any such data via the PypeIt file.
So tread carefully.

When perform a reduction run (with run_pypeit), the code
will require that all required meta data be ingested.
There are cases, however, when the header has been mucked
(e.g. Keck).  It is best to fix the file and proceed, but
if you are feeling adventursome, you may set the
`ignore_image_headers` parameter in the `rdx` block, e.g.::

    [rdx]
       ignore_bad_headers = True

Buyer beware in this case..

Developers
==========

Data Model
++++++++++

The data model for the meta data is specified in a series
of methods at the bottom of the metadata.py module.  Here
are a few examples::

    core_meta['target'] = dict(dtype=str, comment='Name of the target')
    core_meta['binning'] = dict(dtype=str, comment='(spatial,spectral) binning')

The key specifies the name, there is a data type, and a comment.
If the meta data is a `float` and is intended to be used for
defining a configuration, then an `rtol` key should be present, e.g.::

    additional_meta['dispangle'] = dict(dtype=float, comment='Angle of the disperser', rtol=0.)

The core meta are required for the code to run.  The additional meta
are used primarily for configurations.

Ingesting Meta
++++++++++++++

Meta data is read from the `Spectrograph` classes.
The main method is `get_meta_value()` in the parent class.

The children specify how a specific meta data item is to
be ingested.  The standard method is via the header and
one specifies the extension of the header array (typically 0)
and the header card, e.g.::

        meta['dec'] = dict(ext=0, card='DEC')
        meta['target'] = dict(ext=0, card='OBJECT')

If an item of required meta data is not provided by the data file
and has a set value, one sets it by `default`::

        meta['binning'] = dict(ext=0, card=None, default='1,1')

If the meta is only required for a set of frametypes (e.g. VLT which does
not provide RA/DEC for calibrations), you may specify which frametypes
*require* it with::

        meta['dec'] = dict(ext=0, card='DEC', required_ftypes=['science'])

You can also not require a particular bit of meta data for any frame by
setting `required=False`, i.e.::

        self.meta['dither'] = dict(ext=0, card='HIERARCH ESO SEQ CUMOFF Y', required=False)  

Note that this overrules `required_ftypes`, i.e. don't use these together.

For meta data that depends on more than one header card or has some
other complexity, the `compound_meta()` method is used.  Here is
an example from Keck/DEIMOS::

    def compound_meta(self, headarr, meta_key):
        """

        Args:
            headarr: list
            meta_key: str

        Returns:
            value

        """
        if meta_key == 'binning':
            binspatial, binspec = parse.parse_binning(headarr[0]['BINNING'])
            binning = parse.binning2string(binspatial, binspec)
            return binning
        elif meta_key == 'dispangle':
            if headarr[0]['GRATEPOS'] == 3:
                return headarr[0]['G3TLTWAV']
            elif headarr[0]['GRATEPOS'] == 4:
                return headarr[0]['G4TLTWAV']
            else:
                debugger.set_trace()
        else:
            msgs.error("Not ready for this compound meta")



.. _master-edges:

===========
MasterEdges
===========

Overview
========

This file describes the MasterEdges object.
It contains the core information required to describe the edges
of each slit on a given detector (or orders for echelle).

See below for the `Current EdgeTrace Data Model`_.
This is written to disk as a multi-extension FITS file prefixed by
MasterEdges in the Masters/ folder.
See the :ref:`master-naming` docs for more.

We also describe how to view the slit edges
using `pypeit_chk_edges`_.

Viewing
=======

The preferred way to view the slit edges identified
by PypeIt is with the `pypeit_chk_edges`_ script.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_chk_edges.rst

.. _pypeit_chk_edges:

pypeit_chk_edges
----------------

There are currently 2 options for viewing the slit edges on the image
used to construct them.  Each uses the `pypeit_chk_edges`_ script.

ginga
+++++

This is the default mode and it requires you to first launch
a `ginga` viewer in remote control mode::

    ginga --modules=RC

You should see `RC` in a tab on the upper right of the ginga viewer.

You may then run the script::

    pypeit_chk_edges Masters/MasterEdges_A_1_01.fits.gz


Here is an zoom-in screen shot for the :ref:`keck-lris-red` spectrograph.

.. image:: figures/slit_edges_ginga.png

A few things to note from this good-performing example:

 - The slits run nearly vertically across the image
 - The left/right edge of each slit identified is a green/red line
 - There were 13 slits identified (0 indexing)
 - The brightest `slit` is an alignment box and was discarded by the code

matplotlib
++++++++++

To avoid ginga, use the `--mpl` flag::

    pypeit_chk_edges Masters/MasterEdges_A_1_01.fits.gz --mpl

The color scheme is distinct and the labeling
now includes -1 or +1 for left/right edges.

SlitTrace
=========

TODO:
Describe that object here (or link to its own doc??)

.. _edges-trouble:

Edges Trouble Shooting
======================

See :doc:`slit_tracing` for a discussion of how to customize
and fuss with slit tracing.

Current EdgeTrace Data Model
============================

Internally, the image is held in EdgeTrace DataContainer.
The datamodel written to disk is:

TO APPEAR HERE

.. highlight:: rest

.. _frame_types:

***********
Frame Types
***********

.. index:: Frame_Type

Overview
========

Every raw data file ingested by ``PypeIt`` must be given a frame
type. This identifies how the frame should be treated and included in
the data reduction.

Frame typing can be done automatically by running ``pypeit_setup``
(see :ref:`pypeit_setup`), which is a simple wrapper for
:class:`~pypeit.pypeitsetup.PypeItSetup`. The type of frame for each
data file is automatically identified as one or more of the types
listed in the table below; any files that could not be identified are
given a frame type set to ``None``.

Automated typing of *calibration* frames is robust for the following
instruments:

 - Keck DEIMOS

However, automated typing of ``science`` versus ``standard`` frames
is not generally robust.

.. _frame_type_defs:

Definitions
===========

The possible frame types defined by ``PypeIt`` and a brief
description can be listed as follows:

.. code-block:: python

    from pypeit.core.framematch import FrameTypeBitMask
    FrameTypeBitMask().info()

More detailed descriptions are given in the table below.

============= =============================================================
Frame Type    Description
============= =============================================================
``align``     Used to align spatial positions in multiple slits. This frame is particularly useful for slit-based IFU, such as Keck KCWI.
``arc``       Spectrum of one or more calibration arc lamps
``bias``      Bias frame;  typically a 0s exposure with the shutter closed
``dark``      Dark frame;  typically a >0s exposure to assess dark current (shutter closed)
``illumflat`` Spectrum taken to correct illumination profile of the slit(s). This is often the same as the trace flat (below).
``pinhole``   Spectrum taken through a pinhole slit (i.e. a very short slit length), and is used to define the centre if a slit (currently, this frame is only used for echelle data reduction). Often this is an exposure using a flat lamp, but one can in principle use a standard star frame too (or a science frame if the spectrum is uniform).
``pixelflat`` Spectrum taken to correct for pixel-to-pixel detector variations Often an exposure using a dome (recommended) or internal flat lamp, but for observations in the very blue, this may be on-sky
``science``   Spectrum of one or more science targets
``standard``  Spectrum of spectrophotometric standard star PypeIt includes a list of pre-defined standards
``trace``     Spectrum taken to define the slit edges. Often this is an exposure using a flat lamp, but for observations in the very blue, this may be on-sky. The slit length of a trace frame should be the same as the science slit.
``tilt``      Exposure used to trace the tilt in the wavelength solution. Often the same file(s) as the arc.
``None``      File could not be automatically identified by PypeIt
============= =============================================================

It is possible (and even common for arc and flats images) that a frame can be
assigned more than one frame type.

.. warning:: 

    The code will *not* run if your :doc:`pypeit_file` includes
    entries with ``None`` frame types defined. You must either remove
    or edit those entries in the pypeit file by-hand after running
    ``pypeit_setup``.

Automated Typing
================

Automated typing of files is performed by ``pypeit_setup``.

In detail, :class:`~pypeit.pypeitsetup.PypeItSetup` builds a table of
metadata for all files found using the search key provided to its
:func:`~pypeit.pypeitsetup.PypeItSetup.from_file_root` method. The
metadata itself is gathered and maintained by
:class:`~pypeit.metadata.PypeItMetaData` based on a set of header
keywords that are defined for each supported spectrograph. For
example, the metadata keywords for Keck DEIMOS reductions are:

.. code-block:: python

    from pypeit.spectrographs.keck_deimos import KeckDEIMOSSpectrograph
    spec = KeckDEIMOSSpectrograph()

    for key in spec.meta.keys():
        if spec.meta[key]['card'] is None:
            continue
        print('Key: {0:>15}; Extension: {1:>2}; Header Card: {2:>10}'.format(
                    key, spec.meta[key]['ext'], spec.meta[key]['card']))

which prints the following:

.. code-block:: bash

    Key:              ra; Extension:  0; Header Card:         RA
    Key:             dec; Extension:  0; Header Card:        DEC
    Key:          target; Extension:  0; Header Card:   TARGNAME
    Key:          decker; Extension:  0; Header Card:   SLMSKNAM
    Key:             mjd; Extension:  0; Header Card:    MJD-OBS
    Key:         exptime; Extension:  0; Header Card:   ELAPTIME
    Key:         airmass; Extension:  0; Header Card:    AIRMASS
    Key:        dispname; Extension:  0; Header Card:   GRATENAM
    Key:           hatch; Extension:  0; Header Card:   HATCHPOS
    Key:          idname; Extension:  0; Header Card:    OBSTYPE
    Key:      lampstat01; Extension:  0; Header Card:      LAMPS


The method :func:`~pypeit.metadata.PypeItMetaData.get_frame_types`
uses the metadata to try to identify each frame type. With a couple
exceptions, however, this method is largely a wrapper for the
``check_frame_type`` method of each spectrograph; e.g., see
:func:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.check_frame_type`
for DEIMOS. The relevant exposure time for each frame can be refined
using parameters in the pypeit file. For example, to edit the
exposure time for ``pixelflat`` images to be between 15 and 30
seconds, you can include the following lines in your pypeit file:

.. code-block:: ini

    [calibrations]
        [[pixelflatframe]]
            exprng = 15, 30

Note that you can set either (or both) of the limits to ``None`` such
that it is undefined. I.e.:

.. code-block:: python

    from pypeit.spectrographs.keck_deimos import KeckDEIMOSSpectrograph
    KeckDEIMOSSpectrograph().default_pypeit_par()['calibrations']['pixelflatframe']['exprng']

shows the default exposure-time range for pixel flats is ``[None,
30]``, meaning there is no lower limit on the exposure time for the
pixel-flats. At the moment, only the exposure time can be altered
programmatically for the frame type determination; all other
conditions are hard-coded.
.. _fluxing:

=======
Fluxing
=======

Overview
========
Fluxing is done after the main run of PypeIt.

It is a two step process of generating a `Sensitivity Function`_ and then
`Applying the Sensitivity Function`_.  We describe each in turn.  However, we
first discuss the basic fluxing concepts/approach.


Sensitivity Function
====================

The sensitivity function is generated from the :doc:`out_spec1D` file of a
processed standard star.

``PypeIt`` uses an archived fluxed spectrum from either the `CALSPEC calibration
database <http://stsci.edu/hst/observatory/crds/calspec.html>`_ or one of the
files we have grabbed from `ESO
<https://www.eso.org/sci/observing/tools/standards/spectra/stanlis.html>`_.  If
you observed something else, see `Adding a Standard Star`_.

The sensitivity function is generated by dividing the standard star's flux in
units of 1e-17 erg/s/cm^2/Ang by the standard star's counts per second per
Angstrom [photons/s/Ang]. The sensitivity function is written to disk as a FITS
file. It has units of [1e-17 erg/s/cm^2/Ang]/[e-/s/Ang]. For more
information see :ref:`fluxcalib`.

To flux calibrate spectra, the spectrum in counts from the spec1D files is used
to compute  counts per second per Angstrom, by which the sensitivity function is
multiplied to yield a fluxed science spectrum in units of f_lambda [1e-17
erg/s/cm^2/Ang].

The sensitivity function is written to disk as a FITS file. It has units of
[1e-17 erg/s/cm^2/Ang]/[photons/s/Ang] = [1e-17 erg/cm^2/photons]

If you are using an IR instrument or choose the IR mode (see below)
then you will need to have grabbed the telluric files.
See :ref:`install_atmosphere`.

pypeit_sensfunc
---------------

The process is mediated by the *pypeit_sensfunc* script.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_sensfunc.rst

Here is a typical call::

    pypeit_sensfunc spec1dfile -o Keck_LRISr_600_7500_sens.fits

This analyzes the standard star spectrum in *spec1dfile* and writes
the sensitivity file to *Keck_LRISr_600_7500_sens.fits*.

Here are the common options used:

--multi
+++++++

For some instruments (e.g. *keck_deimos*, *gemini_gmos*), the spectrum spans
across multiple detectors.  You can have the sensitivity function
handle this by using the --multi option, e.g.::

    pypeit_sensfunc --multi 3,7

--debug
+++++++

Throws a number of plots to the screen

--algorithm
+++++++++++

The algorithm options are:
 - UVIS = Should be used for data with lambda < 7000A.
   No detailed model of telluric absorption but corrects for atmospheric extinction.
 - IR   = Should be used for data with lambbda > 7000A.
   Peforms joint fit for sensitivity function and telluric absorption using HITRAN models.

--sens
++++++

Provide a file to guide the process.  Do this if your changes to
the defaults are not accommodated by the script inputs.

IR without a Standard
---------------------

If you wish to generate a sensitivity function on a standard
star that is not part of the PypeIt database and are working
in the IR, you can feed the stellar parameters.  Here is an
example::

    [sensfunc]
       algorithm = IR
       star_mag = 12.1
       star_type = A0

Then run on the spec1d file as you would otherwise.
For an A0 star, we use the Vega spectrum.  Otherwise,
we use the Kurucz93 stellar SED.

Alternative see `Adding a Standard Star`_.


Sensitivity Function Units and Definitions
==========================================

The sensitivity function in PypeIt is defined to be the function
:math:`S_\lambda` satisfying

.. math::

    S_\lambda  = \frac{F_\lambda}{N_\lambda}

with units of :math:`[{\rm erg/cm^2/photons}]`, where :math:`F_\lambda` is the
specific energy flux in units of :math:`[{\rm
erg/s/cm^2/\mathrm{\mathring{A}}}]`, :math:`N_\lambda` is the specific photon
flux with units :math:`[{\rm photons/s/\mathrm{\mathring{A}}}]`,

``PypeIt`` spec1d files contain :math:`N_{\rm pix}` with units :math:`[{\rm
photons/pixel}]`. To generate flux-calibrated spectra :math:`F_\lambda`,
:math:`S_\lambda` must be computed from a spectrophotometric standard-star
observations.

.. This was in the paragraph above: (insert hyperlink to discussion below and
.. fluxing.rst).  Can someone address this? 

:math:`N_{\lambda}` must be determined from :math:`N_{\rm pix}` via

.. math::

    N_\lambda = \frac{N_{\rm pix}}{\frac{d\lambda}{d{\rm pix} \Delta t}},

where :math:`\Delta t` is the exposure time and :math:`\frac{d\lambda}{d{\rm
pix}}` is the wavelength spacing per pixel, which is in general not a constant
since ``PypeIt`` spec1d spectra (i.e. :math:`N_{\rm pix}`) are extracted on an
irregularly spaced wavelength grid.

After flux calibration, flux calibrated spectra (i.e. :math:`F_\lambda`) are
reported in the spec1d files as e.g. ``OPT_FLAM`` and ``BOX_FLAM`` for optimal
and boxcar extractions, respectively, in units of :math:`[10^{-17} {\rm
erg/s/cm^2/\mathrm{\mathring{A}}}]`.

Spectroscopic Zeropoints
========================

Flux calibration of ``PypeIt`` spectra is expressed via the "spectroscopic
zeropoint", which, by analogy with the imaging zeropoint, is defined to be:

.. math::
    
    {\rm Zeropoint} \equiv -2.5
    \log_{10}{\left[\frac{\frac{\lambda^2}{c}S_\lambda}{\left(\frac{3631 {\rm
    Jy}}{{\rm photons}/ {\rm s} / \mathrm{\mathring{A}}}\right)}\right]}.

With this definition we see that an astronomical source with a flat spectrum in
frequency :math:`\nu`, i.e. :math:`F_\nu = {\rm const}` and AB magnitude equal
to the Zeropoint will produce :math:`N_\lambda = 1\ {\rm
photon/s/\mathrm{\mathring{A}}}` on the detector, that is the sum of the
:math:`N_{\rm pix}` photons per pixel over all pixels corresponding to a
:math:`\Delta \lambda = 1 \mathrm{\mathring{A}}` interval will be equal to
unity.

From the definition of the spectroscopic zeropoint above, it follows that

.. math::

    \left(\frac{F_\lambda}{10^{-17} {\rm
    erg/s/cm^2/\mathrm{\mathring{A}}}}\right) = 10^{-0.4({\rm Zeropoint -
    ZPCONST})} \left(\frac{N_\lambda}{\rm
    photons/s/\mathrm{\mathring{A}}}\right)\left(\frac{\lambda}{\mathrm{\mathring{A}}}\right)^2,

where :math:`ZPCONST = 40.09` is a dimensionless number defined by

.. math::

    {\rm ZPCONST}\equiv \frac{\frac{\mathrm{\mathring{A}}^2}{c}\times
    10^{-17}{\rm erg/s/cm^2/\mathrm{\mathring{A}}}}{3631 {\rm Jy}}.

In practice, ``PypeIt`` fits and stores the spectroscopic zerpoints and uses the
equation above to compute :math:`F_\lambda` from :math:`N_\lambda` and
vice-versa.

The sensitivity function script, :ref:`fluxing:pypeit_sensfunc`, produces a QA
plot showing the the zeropoint fit, as shown below. For echelle observations
this zeropoint QA is shown for each order.

.. "as shown below"?  We should add this plot.


Spectroscopic Throughput
========================

The zeropoint is closely related to the spectroscopic throughput. The number of
counts per pixel in a spectrum of an object with flux :math:`F_\lambda`

.. math::

    N_{\rm pix} = A\ T(\lambda)\ {\rm Atm}(\lambda)\ \frac{d\lambda}{d_{\rm
    pix}}\frac{F_\lambda}{h\nu}\Delta t,

where :math:`A` is the effective aperture of the telescope, :math:`T(\lambda)`
is the spectroscopic throughput, :math:`{\rm Atm(\lambda)}` is the attenuation
caused by the Earth's atmosphere, :math:`\frac{d\lambda}{d_{\rm pix}}` is the
number of :math:`\mathrm{\mathring{A}}` per pixel defined above, :math:`h\nu`
is the photon energy, and :math:`\Delta t` is the exposure time.

Based on this equation and the definitions above it follows that the
spectroscopic throughput can be written :math:`T(\lambda) = \frac{h\nu}{A
S_\lambda}`.

Note :math:`T(\lambda)` is clearly dimensionless given the units of
:math:`S_\lambda`: :math:`[{\rm erg/cm^2/photons}]`.  As :math:`S_\lambda` is
specified by the zeropoint, throughput curves can be computed once the
zeropoints given the effective aperture of the telescope.

.. The QA plot isn't shown...  Can we add this?

In addition to the zeropoint QA shown above, the sensitivity function script
``pypeit_sensfunc`` also produces a QA plot showing throughput curve(s),
computed directly from the spectroscopic zeropoints.

Note that we have defined the spectroscopic throughput above to be that of the
telescope + instrument system, but it does **not** include the attenuation
caused by the Earth's atmosphere. Also, the zeropoints, sensitivity functions,
and ``PypeIt`` flux calibration algorithms in general do not attempt to remove
the impact of slit losses. In the limit where your standard star observations
and science observations have exactly the same seeing, the flux calibration will
be perfect.  In the more realistic scenario where they differ, this will
manifest as a wavelength-dependent systematic error in the flux calibration,
with the direction of the error depending on the relative seeing between the
standard-star and science observations. In future versions, we hope to implement
a better treatment of slit losses. For the time being, we recommend that users
that require very accurate flux calibration force ``PypeIt`` flux-calibrated
spectra to agree with photometry. This can be done using the `filter` parameter
option for 1D coadding (see :ref:`pypeit_par:Coadd1DPar Keywords`), which can be
set in the ``.coadd1d`` file, which is used to guide 1D coaddition with the
``pypeit_coadd1d`` script (see :ref:`coadd1d`).


Applying the Sensitivity Function
=================================

Once you have generated a `Sensitivity Function`_, you may apply
it to one or more :doc:`out_spec1D` files.
The files are modified in place, filling the OPT_FLAM, BOX_FLAM, etc.
entries, as described in :doc:`out_spec1D`.

Flux File
---------

To flux one or more spec1d files, generate a flux_file that is has the
following format::

    flux read
       spec1dfile1 sensfile
       spec1dfile2
          ...
          ...
    flux end

    OR

    flux read
       spec1dfile1 sensfile1
       spec1dfile2 sensfile2
       spec1dfile3 sensfile3
          ...
    flux end

Here is an actual example::

    flux read
      spec1d_UnknownFRBHostY_vlt_fors2_2018Dec05T020241.687.fits VLT_FORS2_sens.fits
      spec1d_UnknownFRBHostY_vlt_fors2_2018Dec05T021815.356.fits
      spec1d_UnknownFRBHostY_vlt_fors2_2018Dec05T023349.816.fits
    flux end

If one wishes to modify the :ref:`pypeit_par:FluxCalibratePar Keywords`,
add a Parameter block at the top of the file, e.g.::

    [fluxcalib]
       extrap_sens = True

    flux read
      spec1d_FORS2.2019-07-12T08:11:41.539-FRB190611Host_FORS2_2019Jul12T081141.539.fits VLT_FORS2_300I_sens.fits
      spec1d_FORS2.2019-07-12T08:34:55.904-FRB190611Host_FORS2_2019Jul12T083455.904.fits
    flux end

To aid this setup, we provide the ``pypeit_flux_setup`` script.  

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_flux_setup.rst

.. THIS NEEDS SOME MORE DESCRIPTION


pypeit_flux_calib
-----------------

Fluxing is performed with the *pypeit_flux_calib* script.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_flux_calib.rst

Here is a typical call::

    pypeit_flux_calib flux_file.txt

Again, the :doc:`out_spec1D` files are modified in place.
See :ref:`pypeit_show_1dspec` for details on how to view them.

FluxSpec Class
==============

The guts of the flux algorithms are guided by the
:class:`pypeit.fluxcalibrate.FluxCalibrate`.
class.

Troubleshooting
===============

Problem with Empty filename
---------------------------

If you encounter this error when doing flux calibration with the IR algorithm,
please do the following steps:

- Make sure you have installed the relevant atmosphere telluric models.  See the
  instructions for installing this :ref:`data_installation`. 

.. WHEN INSTALLING VIA PIP/CONDA, THE PATH TO THE PYPEIT DIRECTORY IS NOT
.. STRAIGHT-FORWARD FOR SOMEONE NOT FAMILIAR WITH PYTHON PACKAGE INSTALLATION.
.. THIS IS WHY I ADDED THE NEW "DATA INSTALLATION" SCRIPTS.  CAN THE TELGRIDFILE
.. JUST BE THE NAME OF A FILE IN THE /pypeit/data/telluric/atm_grids/ DIRECTORY?

- Write the filename of the corresponding file for your observatory in the
  parameter telgridfile (i.e. keck_lris_sens.txt), e.g.:

    .. code-block:: ini

        [sensfunc]
            algorithm = IR
            polyorder = 8
            [[IR]]
                telgridfile = TelFit_MaunaKea_3100_26100_R20000-006.fits

- Run pypeit_sensfunc with the --sens_file option, e.g.:

    .. code-block:: console

        pypeit_sensfunc your_spec1dfile -o your_output.fits --sens_file keck_lris_sens.txt


Problem with bspline knot
-------------------------

.. THERE'S NO TEXT HERE.  CAN SOMEONE DESCRIBE THIS PROBLEM?


Adding a Standard Star
======================

If your star is not in the repository you can add in a new
solution if it is in the
`ESO database <https://www.eso.org/sci/observing/tools/standards/spectra/stanlis.html>`_.

You will need to place their .dat file in pypeit/data/standards/esofil/ and then edit 
the *esofil_info.txt* file accordingly. Make sure the flux column is in flux units rather 
than magnitudes (i.e. those files starting with `f` in the ESO database), and these fluxes 
are in units of 10^(-16) ergs/s/cm^2/AA.

Extra kudos if you submit this as a PR for others benefit.

If your standard star is even more non-traditional, contact
the developers.

Additional Reading
==================

Here are additional docs on somewhat common edits that
PypeIt users make:

.. toctree::
   :maxdepth: 1

   standards
   telluric


.. _masters:

=============
Master Frames
=============

Overview
========

As calibrations are generated,
by default PypeIt will write these data
to the hard-drive in the :doc:`masters` folder named Masters/.
This is to:

 - Allow the user to inspect the calibrations.
 - Allow for a quicker re-reduction (i.e. these steps can be skipped) including in cases where
   the code crashed, things were fixed and one re-runs the script.

Here is a listing of all the of MasterFrame files that
can be generated.  The ones that are made depend on the
:doc:`spectrographs` and the calibrations files provided.

================= ========= ===========================================
Type              Format    Description
================= ========= ===========================================
MasterAlign       FITS      Alignment image (IFU)
MasterArc         FITS      Processed arc spectral image
MasterBias        FITS      Processed bias image
MasterDark        FITS      Processed dark image
MasterEdges       FITS      Several images describing the slit traces
MasterFlat        FITS      Normalized flat field image
MasterPinhole     FITS      Pinhole flat image
MasterSlits       FITS      Reduced output of slit tracing
MasterTiltimg     FITS      Mapping of pixel to constant wavelength
MasterTilts       FITS      Image used to trace wavelengths in the slits
MasterWave        FITS      Wavelength image (in air and Angstroms)
MasterWaveCalib   FITS      Solution of 1D wavelength calibration
================= ========= ===========================================


.. _master-naming:

Masters Naming
==============

The naming convention for MasterFrames is a bit obscure.
Here is an example of one::

    MasterEdges_A_1_01.fits

Here is how we break it down:

  - The prefix is as described in the Table above
  - The **A** specifies the spectrograph :doc:`setup`
  - The **1** specifies the detector number (one-based indexing)
  - The **01** specifies a bit-wise description of the `calib`

calib_ids
---------

When pypeit runs successful, a file with a .calib extension is
generated that offers a summary of the :ref:`master-naming`.

You may generate a similar (and perhaps more readable)
file using the :ref:`pypeit-parse-calib-id` script.
=========
MasterArc
=========

Overview
========

This file describes the data model for the `MasterArc`_ image.
It is generally a simple combination of all input arc frames.

The image is written to disk as a multi-extension FITS file
prefixed by `MasterArc`_ in the Masters/ folder.
See :ref:`masters:Masters Naming` for the naming convention.


Inspecting
==========

The first extension is the combined image.
You can view it with any standard image viewer, e.g.::

    ginga Masters/MasterArc_A_1_01.fits

Most often you use only one arc frame and this appears
very similar to the raw image.  If you do stack several,
the output could be quite different.

The image will also be a trimmed portion of the
raw image and also re-oriented
so that vertical is the spectral dimension with blue at the bottom.

Here is an screen shot of a `ginga` view
for an example from the `shane_kast_red` spectrograph.

.. image:: figures/arc_image.png

Yup, an arc.

Trouble Shooting
================

If your image appears to be in err, here are the things to consider:

 - Is one or more of your input arc frames junk?
 - Is one or more of your input arc frames mis-labeled?

Current ArcImage Data Model
===========================

Internally, the image is held in
:class:`pypeit.images.buildimage.ArcImage`
which is a :class:`pypeit.images.pypeitimage.PypeItImage` and
:class:`pypeit.datamodel.DataContainer`.

The datamodel written to disk is:

.. include:: include/datamodel_arcimage.rst

***********
Gemini GMOS
***********


Overview
========

This file summarizes several instrument specific
settings that are related to the Gemini/GMOS spectrograph.


Nod and Shuffle
===============

For the time being, we have enabled reductions of data
taken in Nod+Shuffle mode by simply replicating the calibrations.
That is, we do *not* subtract the nodded images but reduce
it as if it were a separate slit.

For this mode, you need to specify the `gemini_gmos_north_ham_ns` 
spectrograph.

Slits
=====

1.
Somewhat too frequently when using the longslit,
the "3" slits are not all identified in the bluest detector.

To mitigate this, we recommend adding to this to your PypeIt file:

.. code-block:: ini

    [calibrations]
        [[slitedges]]
            det_min_spec_length=0.1
            fit_min_spec_length=0.1
            edge_thresh=3.

One can also do a manual check with:

.. code-block:: console

    pypeit_trace_edges -f my_pypeit_file.pypeit --debug --show
    pypeit_chk_edges Masters/MasterEdges_file.fits.gz

2.
No valid traces, this happens for some long-slit data where the slit edges are,
in fact, beyond the edges of the detector. It returns an error: TypeError:
unsupported format string passed to NoneType.__format__

The solution is adding this to PypeIt file:

.. code-block:: ini

    [calibrations]
        [[slitedges]]
	        bound_detector = True

If bound_detector is True, the code will artificially add left and right edges that bound the detector

3.
In some cases, the slits were detected, but then rejected due to a failure of
wavelength calibration. The appearance of this issue is very similar to that of
1, you will see a lack of slits in skiing, the difference is that, there will be
such information on slit detection in log files: Not enough useful IDs. 

In this case, you should check your wavelength solution, and try to adjust the
wavelength parameters. (This issue might be solved after the mosaic functionality
is added).

Arcs
====

The CuAr lamps are pretty faint in the blue which lead
to some "unique" challenges.  At present we have
lowered the default tracethresh parameter to 10, i.e.:

.. code-block:: python

    par['calibrations']['tilts']['tracethresh'] = 10.  # Deals with faint CuAr lines

It is possible you will want to increase this, but unlikely.


.. _heliocorr:

.. highlight:: rest

***********************
Heliocentric Correction
***********************

This document will describe how PypeIt imposes a heliocentric correction
on each 1D spectrum extracted.

Overview
========

Nearly all analysis of the 1D spectra from astronomical objects
will require one to remove the peculiar motion of the Earth.  In addition,
one may wish to correct for the Solar System.
The default in PypeIt is to impose a heliocentric correction to place
the Earth within the Sun's reference frame.


Algorithm
=========

The basic algorithm may be summarized as follows:

1. Determine the time, observational RA/DEC and observatory info from the header
2. Calculate the correction using astropy.solar_system
3. Impose on the data *after* extraction and flexure correction


Details
=======

Time
++++

By default, the code establishes the time of observation from the DATE
keyword read from the header.  The header card used depends on instrument.
Note that it currently must be written ISOT format for the code to run
successfully.

Observatory info
++++++++++++++++

This is set in the instrument specific settings file.

RA/DEC
++++++

By default these are taken from the header using the RA, DEC keywords.
==========
MasterDark
==========

Overview
========

This file describes the data model for the MasterDark image.
This is written to disk as a multi-extension FITS file prefixed by
MasterDark in the Masters/ folder.

This is generally a simple combination of all input dark frames.

Inspecting
==========

The first extension is the stacked image.  You can view it with
any standard image viewer, e.g.::

    ginga Masters/MasterDark_A_1_01.fits

It should resemble any one of your input dark frames aside from:

- Having been overscan subtracted (depending on the processing parameters)
- Having been bias subtracted (depending on the processing parameters)
- Being only a trimmed portion of the image
- Re-oriented so that vertical is the spectral dimension with blue at the bottom

Trouble Shooting
================

If your image appears to be in error, here are the things to consider:

 - Is one or more of your input dark frames junk?
 - Is one or more of your input dark frames mis-labeled?

Current DarkImage Data Model
============================

Internally, the image is held in
:class:`pypeit.images.buildimage.DarkImage`
which is a :class:`pypeit.images.pypeitimage.PypeItImage` and
:class:`pypeit.datamodel.DataContainer`.
The datamodel written to disk is:

.. include:: include/datamodel_darkimage.rst

***********
Keck DEIMOS
***********

Overview
========

This file summarizes several instrument specific
settings that are related to the Keck/DEIMOS spectrograph.

.. warning::

    ``PypeIt`` currently *cannot* reduce images produced by reading
    the DEIMOS CCDs with the A amplifier or those taken in imaging
    mode. All image-handling assumes DEIMOS images have been read
    with the B amplifier in the "Spectral" observing mode. ``PypeIt``
    handles files that do not meet these criteria in two ways:

        - When running :ref:`pypeit_setup`, any frames not in
          Spectral mode and read by the B amplifier will be ignored
          and should not appear in your :ref:`pypeit_file`.

        - If you add frames to the :ref:`pypeit_file` that are not in
          Spectral mode and read by the B amplifier, the method used
          to read the DEIMOS files will fault.

Deviations
==========

The default changes to the ``PypeIt`` parameters specific to DEIMOS
data are listed here: :ref:`instr_par`.

These are tuned to the standard calibration
set taken with DEIMOS.

Calibrations
============

Edge Tracing
------------

It has been reported that the default `edge_thresh` of 50
for DEIMOS is too high for some setups.  If some of your
'fainter' slits on the blue side of the spectrum are missing,
try::

    [calibrations]
      [[slitedges]]
         edge_thresh = 10

It is possible, however, that our new implementation of using
the slitmask design file has alleviated this issue.

Slit-mask design matching
-------------------------
``PypeIt`` is able to match the traced slit to the slit-mask design information
contained as meta data in the DEIMOS observations. This functionality at the moment is
implemented only for DEIMOS and MOSFIRE and is switched on by setting **use_maskdesign** flag in
:ref:`pypeit_par:EdgeTracePar Keywords` to *True*.  This is, already, the default for DEIMOS,
except when the *LongMirr* or the *LVM* mask is used.

``PypeIt`` also assigns to each extracted 1D spectrum the corresponding RA, Dec and object name
information from the slitmask design, and forces the extraction of undetected object at the location
expected from the slitmask design. See `Additional Reading`_ .

When the extraction of undetected object is performed, a gaussian profile with FWHM given by the parameter
``find_fwhm`` in :ref:`pypeit_par:FindObjPar Keywords` is assumed. The default value for DEIMOS is **find_fwhm = 10**
(pixels), but the user needs to adjust this value according to the size of the objects to extract. Moreover,
it may be occasionally necessary to set **no_local_sky = True** in :ref:`pypeit_par:SkySubPar Keywords`
to avoid a bad local sky subtraction.

Wavelength Calibration
----------------------
``PypeIt`` is able (currently only for DEIMOS) to read from the header of the arc frames which
lamps were ON during the observations and to set those to be the list of lamps to be used
for the wavelength calibration. This functionality is switched on by setting ``lamps = use_header``
in :ref:`pypeit_par:WavelengthSolutionPar Keywords`. This is already set by default for DEIMOS.

It may happen, occasionally, that some lamps are not recorded in the header even if they were ON
during the observations. This could be the case if a specific script, called `calib_blue`
(see https://www2.keck.hawaii.edu/inst/deimos/calib_blue.html), is used to take arc frames for
blue observations. To resolve this, the user can just edit the PypeIt file to input the correct
list of lamps in the following way::

    [calibrations]
      [[wavelengths]]
            lamps = ArI, NeI, KrI, XeI, CdI, ZnI, HgI


Flat Fielding
-------------

When using the *LVMslitC* mask, it is common for the
widest slits to have saturated flat fields.  If so, the
code will exit during flat fielding. You can skip over them
as described in :ref:`flat_fielding:Saturated Slits`.


Fluxing
-------

If you use the LVMslitC (common), avoid placing your standard
star in the right-most slit as you are likely to collide with
a bad column.

Flexure
-------

For most users, the standard flexure correction will be sufficient.
For RV users, you may wish to use the
:ref:`flexure:pypeit_multislit_flexure` script which also means
initially reducing the data without the standard corrections.
See those docs for further details and note it has only been
tested for the 1200 line grating and with redder wavelengths.


Additional Reading
==================

Here are additional docs related to Keck/DEIMOS:

.. toctree::
   :maxdepth: 1

   dev/deimosframes
   dev/deimosconfig
   dev/slitmask_ids
   dev/radec_object
   dev/deimos_wavecalib
   dev/add_missing_obj
   deimos_howto************
VLT XShooter
************


Overview
========

This file summarizes several instrument specific
settings that are related to the VLT/XShooter spectrograph.


.. _2d_combine:

=========================
Combine Science Exposures
=========================

Overview
========

PypeIt can combine (without optimal weighting) multiple science exposures
as part of the data reduction process. See :ref:`coadd2d` for a optimally weighted
coadd, which uses the squared S/N of the extracted objects as weights and
is done by a separate script after the standard reduction.

To combine (without optimal weighting) multiple science exposures, the user needs to edit
the :ref:`pypeit_file` according to the desired reduction.
The process to combine multiple science exposures is basically identical
to :ref:`a-b_differencing` without the subtraction of a background frame.

PypeIt file
===========

Data Block
----------
After running :ref:`pypeit_setup`, the user should update the
:ref:`pypeit_file:Data Block` in the PypeIt file to add three extra
columns, and name them ``calib``, ``comb_id`` and ``bkg_id``.
This can also be obtained by running :ref:`pypeit_setup` and adding the `-b` option.
The columns ``calib`` and ``comb_id`` should be edited according to the desired reduction,
while ``bkg_id`` is not used here and its value should be set to -1.

Parameter Block
---------------
The combining process is guided by the parameters in :ref:`pypeit_par:ProcessImagesPar Keywords`.
Currently, there are only 2 available methods to combine multiple frames: ``median`` and  ``weightmean``.
The default is ``weightmean``, which computes an average image using uniform weighting.
The user can change this parameter in the PypeIt file in the following way ::

    [scienceframe]
        [[process]]
            combine = median


Extra columns
=============

The additional columns used here (``calib``, ``comb_id``) have the following meanings/definitions:

* ``calib`` assigns a calibration group ID to each frame. Calibration frames with the same
  calibration group number will be used to reduce a science frame with that calibration group number.
* ``comb_id`` represents a combination ID assigned to each science frame. Frames with the same value
  of ``comb_id`` will be combined. Note that this is an unweighted co-add (and hence may not be
  necessarily be "optimal" in terms of S/N ratio).

Both should be assigned integer values (or ``all``, see below), and values less than
or equal to 63.
Remember that ``bkg_id`` should have a value of -1. See :ref:`a-b_differencing` for the definition
of this ID.

Science frames
==============

Each science frame in the :ref:`pypeit_file:Data Block` should have an assigned ``calib`` ID value,
and it should be a integer number <= 63. Science frames that are combined together can have the
same ``calib`` value if they use the same set calibrations.

To combine the science frames, ``comb_id`` should be set for each frame, such that frames with the same
value of ``comb_id`` will be combined.

Calibrations
============

Each calibration frame in the :ref:`pypeit_file:Data Block` should have the same ``calib`` ID value of
the science data that uses it, or be set to ``all`` if used by all of the science frames
in the Pypeit file.

For the calibration frames ``comb_id`` is irrelevant and its value should be set to ``-1``.

Example
=======
Here is an example of a Pypeit file where the science frames are combined ::

    |                  filename |                 frametype |                 ra |                dec |  target | dispname | decker | binning |          mjd |    airmass | exptime |     dispangle |      amp | filter1 |    dateobs |         utc | calib | comb_id | bkg_id |
    | DE.20170425.09554.fits.gz |                  arc,tilt |  57.99999999999999 |               45.0 | unknown |    1200G |  dra11 |     1,1 | 57868.110529 | 1.41291034 |     1.0 | 7699.95654297 | SINGLE:B |   OG550 | 2017-04-25 | 02:39:14.41 |   all |      -1 |     -1 |
    | DE.20170425.09632.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | unknown |    1200G |  dra11 |     1,1 | 57868.111418 | 1.41291034 |    12.0 | 7699.95654297 | SINGLE:B |   OG550 | 2017-04-25 | 02:40:32.06 |   all |      -1 |     -1 |
    | DE.20170425.09722.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | unknown |    1200G |  dra11 |     1,1 | 57868.112443 | 1.41291034 |    12.0 | 7699.95654297 | SINGLE:B |   OG550 | 2017-04-25 | 02:42:02.26 |   all |      -1 |     -1 |
    | DE.20170425.09803.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | unknown |    1200G |  dra11 |     1,1 | 57868.113392 | 1.41291034 |    12.0 | 7699.95654297 | SINGLE:B |   OG550 | 2017-04-25 | 02:43:23.16 |   all |      -1 |     -1 |
    | DE.20170425.50487.fits.gz |                   science | 260.04999999999995 | 57.958444444444446 |   dra11 |    1200G |  dra11 |     1,1 | 57868.584271 |  1.2765523 |  1200.0 | 7699.95654297 | SINGLE:B |   OG550 | 2017-04-25 | 14:01:27.15 |     0 |       1 |     -1 |
    | DE.20170425.51771.fits.gz |                   science | 260.04999999999995 | 57.958444444444446 |   dra11 |    1200G |  dra11 |     1,1 | 57868.599136 | 1.29137753 |  1200.0 | 7699.95654297 | SINGLE:B |   OG550 | 2017-04-25 | 14:22:51.01 |     0 |       1 |     -1 |
    | DE.20170425.53065.fits.gz |                   science | 260.04999999999995 | 57.958444444444446 |   dra11 |    1200G |  dra11 |     1,1 |   57868.6141 | 1.31412428 |  1000.0 | 7699.95654297 | SINGLE:B |   OG550 | 2017-04-25 | 14:44:25.52 |     0 |       1 |     -1 |

The three science frames are combined together, therefore they are assigned a common value of ``comb_id``.
Also the ``calib`` value is assigned to be the same for all the science frames. However, in this case it is irrelevant
since ``calib`` = ``all`` for calibration frames, meaning that all the science frames will be reduced using the same
set of calibrations. In cases when science frames are also used as calibrations, for examples in near-IR observations
where the OH lines are used for wavelength and tilt calibration, different values of ``calib`` for science frames
can be used.





Summary
=======

* A common ``comb_id`` should be used for all science frames that the user wishes to combine
  (without optimal weighting) before spectral extraction.
* For the ``arc``, ``tilt``, ``illumflat``, ``pixelflat``, and ``trace`` frames, the user should assign
  the same ``calib`` values of the science data that uses them (or ``all``), while ``comb_id``
  should be set to ``-1``.
.. _flat_fielding:

=============
Flat Fielding
=============

Overview
========

This doc describes the `Approach`_ used to perform flat-fielding
in PypeIt, how one goes about `Modifying the Default Approach`_
for a given :doc:`spectrographs`, and
how to guide `Generating the Flat Field Images`_.

Note that :doc:`slit_tracing` is frequently performed with
flat field images; refer to that doc for a full description.

Approach
========

Corrections
-----------

There are two primary components to flat-fielding in PypeIt:

- Pixel-level flat fielding
- Illumination corrections

The first accounts for pixel-to-pixel variations in the detector
while the latter corrects for spatial variations along each slit
and at its edges. There is also a routine to correct for the
relative spectral illumination of multiple slits.

Application
-----------

The code can implement any, none or all of the corrections
described above.  We have set a default approach for each
of the :doc:`spectrographs` based on our expertise and
the data in the `Development Suite <https://github.com/pypeit/PypeIt-development-suite>`_.

Of course, for the correction to be applied the user
must supply the required images in the :doc:`pypeit_file`.
We discuss that process in greater detail in
`Generating the Flat Field Images`_.

Modifying the Default Approach
==============================

Each spectrograph has a default approach to flat fielding.
For most, the code will apply both the pixel-level
and illumination corrections.

And for most if not all spectrographs, these are only applied
to the *science* and *standard* :doc:`frametype`.

If you wish to modify the default either for a custom approach
or because you lack the necessary calibration data, you will
need to modify the :doc:`pypeit_file` and specifically the
**use_pixelflat** and **use_illumflat** parameters in the
:ref:`pypeit_par:ProcessImagesPar Keywords`.

We now provide a few typical examples.

No Flat Fielding
----------------

If you wish to turn off flat fielding entirely during
data reduction, add the following to
the :ref:`pypeit_file:Parameter Block`:

.. code-block:: ini

    [baseprocess]
        use_pixelflat = False
        use_illumflat = False

Note that if you provide flat field images in the
:doc:`pypeit_file`
:ref:`pypeit_file:Data Block`,
then these will still be processed
during reduction.  But they will not be used.

No Illumination Flat
--------------------

If you wish to turn off application of the illumination
flat for all files, add the following to
the :ref:`pypeit_file:Parameter Block`:

.. code-block:: ini

    [baseprocess]
        use_illumflat = False

Of course, you can do the same for pixel-level flat fielding.
Or you can choose to make this choice for only a specific frametype:

.. code-block:: ini

    [calibrations]
        [[standard]]
            [[[process]]]
                use_illumflat = False

Apply Illumination Flat
-----------------------

For an instrument where applying the illumination flat
is not the default, you may turn this on with:

.. code-block:: ini

    [calibrations]
        [[standard]]
            [[[process]]]
                use_illumflat = True

Of course, you will need to provide one or more images
labeled as *illumflat* :doc:`frametype` in your :doc:`pypeit_file`.
See below for further details.

Apply Spectral Illumination Correction
--------------------------------------

Spectral illumination corrections are not applied by default.
The main usage case at the moment is for correcting the relative
spectral sensitivity of different slits/slices for IFU data. If
you would like to calculate the relative spectral sensitivity,
you can do so with this keyword argument:

.. code-block:: ini

    [calibrations]
        [[flatfield]]
            slit_illum_relative = True

To apply this correction to science frames, you need to make sure
the following keyword argument is set as well:

.. code-block:: ini

    [scienceframe]
        [[process]]
            use_specillum = True

You will need to provide one or more images labeled as *pixelflat*
:doc:`frametype` in your :doc:`pypeit_file`.
See below for further details.

Generating the Flat Field Images
================================

Input files
-----------

If you wish to apply one or more of the `Corrections`_ you will
need to provide the matching flat field images in your
:doc:`pypeit_file` and specify them with the appropriate
:doc:`frametype`.

In short, if **use_pixelflat** is set for *any* of your images,
at least one of the data files in the
:doc:`pypeit_file` :ref:`pypeit_file:Data Block` must
be labelled as *pixelflat* (unless you `Feed a PixelFlat`_).

And, if **use_illumflat** is set for *any* of your images,
at least one of the data files in the
:doc:`pypeit_file` :ref:`pypeit_file:Data Block` must
be labelled as *illumflat*.

In some cases, it may be desirable to use a different set of
frames for the pixel and illumination corrections. This is
supported, but we recommend that you set the *trace* frames
to be the same as the *illumflat* frames.

Feed a PixelFlat
----------------

If you have generated your own pixel flat (or were provided one)
and it is trimmed and oriented
in the PypeIt frame (spectral vertical, blue at the bottom),
then you may feed this into PypeIt.  This is the recommended approach
at present for :ref:`lris:keck_lris_blue`.

And you perform this by modifying the
:ref:`pypeit_file:Parameter Block`:

.. code-block:: ini

    [calibrations]
        [[flatfield]]
            pixelflat_file = /Users/joe/python/PypeIt-development-suite/CALIBS/PYPEIT_LRISb_pixflat_B600_2x2_17sep2009.fits.gz

None of the frames in the
:doc:`pypeit_file` :ref:`pypeit_file:Data Block`
should be labelled as *pixelflat*.

Algorithms
----------

To be filled in by JFH.

Tuning
======

If you wish to tune the algorithms used to generate the
pixel flat and/or illumination flat, you will want to
modify the :ref:`pypeit_par:FlatFieldPar Keywords`.

JFH+KBW to provide expert advice on that here.

Below we list common modifications.

Saturated Slits
---------------

Occasionally one or more slits are saturated
(a common case is the :doc:`deimos` LVMCslitC mask)
and the code exits in flat field generation.  If you
wish to continue on with the slits that are ok,
add this to your :doc:`pypeit_file`:

.. code-block:: ini

    [calibrations]
        [[flatfield]]
            saturated_slits = mask  # or continue

Using *mask* will preclude the slit from any further
reduction.  Using *continue* will set the flat to unit value
and extraction will be attempted.


Ignoring Extrema
----------------

If you wish to set the pixelflat to unity below/above a 
user-specified wavelength, then use *pixelflat_min_wave* or
*pixelflat_max_wave*, e.g.:

.. code-block:: ini

    [calibrations]
        [[flatfield]]
            pixelflat_min_wave = 3750.

This will set the flat to be 1. for pixel with wavelength
less than 3750Ang in every slit.


**********
Shane Kast
**********

Overview
========

This file summarizes several instrument specific
items for the Shane/Kast spectrograph.

Kastr
=====

300/7500 Grating
++++++++++++++++

The default uses an archived wavelength solution
with the Ne lamp *on*.

If you did not use the Ne lamp, you should make the following
modification to your :doc:`pypeit_file`::

    [calibrations]
       [[wavelengths]]
            lamps = HeI,ArI,HgI,CdI
            reid_arxiv = shane_kast_red_300_7500_NoNe.fits

Note that if you have the Ne lamps *on*, then the
holy-grail algorithm may be more successful.  Especially
if you had an unusual grating tilt.
=========
Keck LRIS
=========


Overview
========

This file summarizes several instrument specific
settings that are related to the Keck/LRIS spectrograph.

Common Items
============

Flexure
+++++++

There is substantial flexure in the LRIS instrument and
the default settings attemps to characterize both the spectral
and spatial effects.

See the :doc:`flexure` notes if you wish
to turn either of these off.

.. _LRISb:

keck_lris_blue
==============

LRISb Default Settings
++++++++++++++++++++++

See :ref:`pypeit_par:Instrument-Specific Default Configuration` for
a listing of modifications to the default settings.

Taking Calibrations for LRISb
+++++++++++++++++++++++++++++

Arcs
----

We recommend that you turn on *all* of the standard
arc lamps,  including those slated for the red side.

These are::

    Ne,Ar,Cd,Kr,Xe,Zn,Hg

The archived solutions expect all of these lamps.

Pixel Flat
----------

It is recommend to correct for pixel-to-pixel variations using a slitless
flat.  If you did not take such calibration frames or cannot process them,
you may wish to use an archival.
`This link <https://drive.google.com/drive/folders/1YmDgCgXrsRbkuH_Pc_MLShWVdSrMkoFP?usp=sharing>`_
has the existing ones staged by the PypeIt team.

And then set the following in your :doc:`pypeit_file`::

    [calibrations]
      [[flatfield]]
           frame = path_to_the_file/PYPEIT_LRISb_pixflat_B600_2x2_17sep2009.fits.gz

WARNING: Internal flats may be too bright and need to be tested.

Trace Flat
----------

We strongly recommend on-the-sky trace flats through full instrument
setup.  Aim for 1000 counts per pixel above bias.
These are best achieved by taking twilight flats within 15 minutes
of sunset/sunrise.

WARNING: Internal/dome flats are likely to be too faint in the
very blue.

.. _400-3400-grism:


400/3400 grism
++++++++++++++

If you are using this grism, you are likely aware there are
strong ghosts.  We have found these complicate edge tracing
for dome flats (sky flats appear ok).  Therefore, you may
need to increase the `edge_thresh` parameter to 
40 for successful performance, i.e.::

    [calibrations]
        [[slitedges]]
            edge_thresh = 40

.. _keck-lris-red:

keck_lris_red
=============

Detectors
+++++++++

There have been 3 (or is it 4?!) generations of detectors
in the LRISr camera.  The original is named `keck_lris_red_orig`,
the LBNL detectors (2kx4k) are `keck_lris_red` and the newest
Mark4 detector is `keck_lris_red_mark4`.   

For the latter (Mark4), the wavelengths have been incorporated for the 
R400 grating only so far but the arxiv solutions from the LBNL detector
may work ok.  Check the outputs!

LRISr Default Settings
++++++++++++++++++++++

Here are the deviations from the default settings
for LRISr::

    settings trace slits sigdetect 50.0   # Good for relatively bright dome flats
    settings trace slits pca params [3,2,1,0]

Known issues
============

LRISb Slit Edges
++++++++++++++++

When observing in long-slit mode, PypeIt might set the slit incorrectly
for detector 2.  This may occur if the counts from the flat field
are too low (e.g., using internal flats rather than twilight
flats with a higher signal in the blue).
Therefore, if you use internal flats, be careful to inspect the
slits defined by PypeIt as described in :doc:`master_edges`.

If the defined slit(s) does not cover the portion of
the illuminated detector where your source falls, you
can manually define the slit position as described
in :ref:`slit_tracing:Missing A Slit`.


Here is an example for the PypeIt file::

    [calibrations]
       [[slitedges]]
         add_slits = 2:788:10:650
         sync_predict = nearest

This will force a slit onto the detector for reduction.

Multi-slit
++++++++++

The code may identify a 'ghost' slit in empty detector real
estate if your mask does not fill most of the field.  Be prepared
to ignore it.
.. _step_by_step:

====================
Step by Step Example
====================

Overview
========

This doc goes through a full run of ``PypeIt`` on one of the Shane
Kast*b* datasets in the Development Suite.
`(see here) <https://wiki.qt.io/Qt_for_Python>`_

There is now a doc for :doc:`deimos_howto`. 

Setup
=====

Organize data
-------------

Place all of the files in a single folder. Mine is named
``/home/xavier/Projects/PypeIt-development-suite/RAW_DATA/shane_kast_blue/600_4310_d55``
(which I will refer to as ``RAW_PATH``) and the files within are:

.. code-block:: bash

    $ ls
    b10.fits.gz  b15.fits.gz  b1.fits.gz   b24.fits.gz  b4.fits.gz  b9.fits.gz
    b11.fits.gz  b16.fits.gz  b20.fits.gz  b27.fits.gz  b5.fits.gz
    b12.fits.gz  b17.fits.gz  b21.fits.gz  b28.fits.gz  b6.fits.gz
    b13.fits.gz  b18.fits.gz  b22.fits.gz  b2.fits.gz   b7.fits.gz
    b14.fits.gz  b19.fits.gz  b23.fits.gz  b3.fits.gz   b8.fits.gz

Run ``pypeit_setup``
--------------------

The first script you will run with ``PypeIt`` is :ref:`pypeit_setup` which
examines your raw files and generates a sorted list and (when instructed)
one :doc:`pypeit_file` per instrument configuration.

Complete instructions are provided in :doc:`setup`.

Here is my call for these data::

    cd folder_for_reducing   # this is usually *not* the raw data folder
    pypeit_setup -r RAW_PATH/b -s shane_kast_blue -c A

This creates a :doc:`pypeit_file` in the folder named
*shane_kast_blue_A* beneath where the script was run.
Note that RAW_PATH should be the *full* path, i.e. including a /
at the start.

It looks like this::

    # Auto-generated PypeIt file
    # Wed 12 Aug 2020 10:00:54

    # User-defined execution parameters
    [rdx]
    spectrograph = shane_kast_blue

    # Setup
    setup read
     Setup A:
       --:
         binning: 1,1
         dichroic: d55
         disperser:
           angle: none
           name: 600/4310
         slit:
           decker: 2.0 arcsec
           slitlen: none
           slitwid: none
    setup end

    # Read in the data
    data read
     path /home/xavier/Projects/PypeIt-development-suite/RAW_DATA/shane_kast_blue/600_4310_d55
    |    filename |                 frametype |                 ra |                dec |     target | dispname |     decker | binning |                mjd |        airmass | exptime | dichroic |
    |  b1.fits.gz |                  arc,tilt | 140.44166666666663 |  37.43222222222222 |       Arcs | 600/4310 | 0.5 arcsec |     1,1 |  57162.06664467593 |            1.0 |    30.0 |      d55 |
    | b14.fits.gz |                      bias | 172.34291666666664 |  36.86833333333333 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15420034722 |            1.0 |     0.0 |      d55 |
    | b15.fits.gz |                      bias | 172.41833333333332 |  36.94444444444444 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15440162037 |            1.0 |     0.0 |      d55 |
    | b16.fits.gz |                      bias | 172.49124999999995 |  36.97833333333333 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |    57162.154603125 |            1.0 |     0.0 |      d55 |
    | b17.fits.gz |                      bias |  172.5645833333333 |  37.04694444444444 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15480474537 |            1.0 |     0.0 |      d55 |
    | b18.fits.gz |                      bias | 172.63708333333332 |  37.11555555555556 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15500949074 |            1.0 |     0.0 |      d55 |
    | b19.fits.gz |                      bias | 172.71166666666664 |  37.18611111111111 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15521145833 |            1.0 |     0.0 |      d55 |
    | b20.fits.gz |                      bias | 172.78416666666666 | 37.254444444444445 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15541377315 |            1.0 |     0.0 |      d55 |
    | b21.fits.gz |                      bias | 172.85708333333332 |  37.32361111111111 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15561504629 |            1.0 |     0.0 |      d55 |
    | b22.fits.gz |                      bias |             172.93 |            37.3925 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15581597222 |            1.0 |     0.0 |      d55 |
    | b23.fits.gz |                      bias | 173.00166666666667 |            37.4225 |       Bias | 600/4310 | 2.0 arcsec |     1,1 | 57162.156018981485 |            1.0 |     0.0 |      d55 |
    | b10.fits.gz | pixelflat,illumflat,trace | 144.82041666666666 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07859895833 |            1.0 |    15.0 |      d55 |
    | b11.fits.gz | pixelflat,illumflat,trace |            144.955 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07897476852 |            1.0 |    15.0 |      d55 |
    | b12.fits.gz | pixelflat,illumflat,trace |  145.0908333333333 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.079351388886 |            1.0 |    15.0 |      d55 |
    | b13.fits.gz | pixelflat,illumflat,trace | 145.22791666666666 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.079728240744 |            1.0 |    15.0 |      d55 |
    |  b2.fits.gz | pixelflat,illumflat,trace | 143.36208333333335 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07473645834 |            1.0 |    30.0 |      d55 |
    |  b3.fits.gz | pixelflat,illumflat,trace | 143.86791666666667 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07596400463 |            1.0 |    15.0 |      d55 |
    |  b4.fits.gz | pixelflat,illumflat,trace | 144.00458333333333 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.076341782406 |            1.0 |    15.0 |      d55 |
    |  b5.fits.gz | pixelflat,illumflat,trace | 144.14041666666665 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07671956019 |            1.0 |    15.0 |      d55 |
    |  b6.fits.gz | pixelflat,illumflat,trace | 144.27708333333334 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.077096064815 |            1.0 |    15.0 |      d55 |
    |  b7.fits.gz | pixelflat,illumflat,trace | 144.41291666666666 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07747175926 |            1.0 |    15.0 |      d55 |
    |  b8.fits.gz | pixelflat,illumflat,trace | 144.54874999999996 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.077847569446 |            1.0 |    15.0 |      d55 |
    |  b9.fits.gz | pixelflat,illumflat,trace |  144.6845833333333 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.078222916665 |            1.0 |    15.0 |      d55 |
    | b27.fits.gz |                   science | 184.40291666666664 |  39.01111111111111 | J1217p3905 | 600/4310 | 2.0 arcsec |     1,1 |  57162.20663842592 |            1.0 |  1200.0 |      d55 |
    | b28.fits.gz |                   science | 184.40416666666664 |  39.01111111111111 | J1217p3905 | 600/4310 | 2.0 arcsec |     1,1 |  57162.22085034722 |            1.0 |  1200.0 |      d55 |
    | b24.fits.gz |                  standard | 189.47833333333332 |  24.99638888888889 |   Feige 66 | 600/4310 | 2.0 arcsec |     1,1 |  57162.17554351852 | 1.039999961853 |    30.0 |      d55 |
    data end


For some instruments (especially Kast), it is common for 
frametypes to be incorrectly assigned owing to limited
or erroneous headers.

In this example, however, all of the frametypes were accurately assigned
in the :doc:`pypeit_file`,
so there are no edits to be made.

Main Run
========

Once the :doc:`pypeit_file` is ready, the main call is
simply::

    cd shane_kast_blue_A
    run_pypeit shane_kast_blue_A.pypeit -o

The "-o" specifies to over-write any existing science
output files.  As there are none, it is superflous but we
recommend (almost) always using it.

The :doc:`running` doc describes the process in some
more detail.

Inspecting Files
================

As the code runs, a series of files are written to the disk.

Calibrations
------------

The first set are :doc:`calibrations`.
What follows are a series of screen shots
and :doc:`qa` PNGs produced by *PypeIt*.


Bias
++++

Here is a screen shot of a portion of the bias image as viewed
with *ginga*::

    ginga Masters/MasterBias_A_1_01.fits


As typical of most bias images, it is featureless
(effectively noise from the readout).

.. image:: figures/kastb_bias_image.png

See :doc:`master_bias` for further details.

Arc
+++

Here is a screen shot of a portion of the arc image as viewed
with *ginga*::

    ginga Masters/MasterArc_A_1_01.fits

As typical of most arc images, one sees a series
of arc lines, here oriented horizontally (as always in *PypeIt*).

.. image:: figures/kastb_arc_image.png

See :doc:`master_arc` for further details.


Slit Edges
++++++++++

The code will automatically assign edges to each slit on the
detector.  For this example, which used the starndard long
slit of the Kast instrument, there is only one slit.

Here is a screen shot from the first tab in the *ginga*
window after using
the :ref:`pypeit_chk_edges` script, with this explicit call::

    pypeit_chk_edges Masters/MasterEdges_A_1_01.fits.gz

.. image:: figures/kastb_edges_image.png

The data is the combined flat images and the green/red
lines indicate the left/right slit edges.  The S174 label
indicates the slit name.

See :doc:`master_edges` for further details.


Wavelengths
+++++++++++

One should inspect the :doc:`qa` for the wavelength
calibration.  These are PNGs in the QA/PNG/ folder.

1D
::

Here is an example of the 1D fits, written to
the QA/PNGs/Arc_1dfit_A_1_01_S0175.png file:

.. image:: figures/kastb_arc1d.png

What you hope to see in this QA is:

 - On the left, many of the blue arc lines marked with green IDs
 - In the upper right, an RMS < 0.1 pixels
 - In the lower right, a random scatter about 0 residuals

See :doc:`master_wvcalib` for further details.

2D
::

There are several QA files written for the 2D fits.
Here is QA/PNGs/Arc_tilts_2d_A_1_01_S0175.png:

.. image:: figures/kastb_arc2d.png

Each horizontal line of black dots is an arc line.
Red points were rejected in the 2D fitting.  Provided
most were not rejected, the fit should be good.
An RMS<0.1 is also desired.

See :doc:`master_wvcalib` for further details.

Flatfield
+++++++++

The code produces flat field images for correcting
pixel-to-pixel variations and illumination of the detector.

Here is a screen shot from the first tab in the *ginga*
window (pixflat_norm) after using
:ref:`pypeit_chk_flats`, with this explicit call::

    pypeit_chk_flats Masters/MasterFlat_A_1_01.fits

.. image:: figures/kastb_flat.png

One notes the pixel-to-pixel variations;  these are
at the percent level.
The slit edges defined by the code
are also plotted (green/red lines).
The region of the detector beyond these images
has been set to unit value.

See :doc:`master_flat` for further details.

Spectra
-------

Eventually (be patient), the code will start
generating 2D and 1D spectra outputs.  One per standard
and science frame, located in the *Science/* folder.

Spec2D
++++++

Here is a screen shot from the third tab in the *ginga*
window (sky_resid-det01) after using
:ref:`pypeit_show_2dspec`, with this explicit call::

    pypeit_show_2dspec Science/spec2d_b27-J1217p3905_KASTb_2015may20T045733.560.fits

.. image:: figures/kastb_spec2d.png

The green/red lines are the slit edges.
The white line down the center is the object.
The orange line shows the *PypeIt* trace
of the object and the orange text is the
*PypeIt* assigned name.
The night sky and emission lines have been subtracted.

See :doc:`out_spec2D` for further details.

Spec1D
++++++

Here is a screen shot from the GUI showing the
1D spectrum after using
:ref:`pypeit_show_1dspec`, with this explicit call::

    pypeit_show_1dspec Science/spec1d_b27-J1217p3905_KASTb_2015may20T045733.560.fits

.. image:: figures/kastb_spec1d.png

This uses the
`XSpecGUI <https://linetools.readthedocs.io/en/latest/xspecgui.html>`_
from the *linetools* package.

See :doc:`out_spec1D` for further details.

Fluxing
=======

Now that we have a reduced standard star spectrum, we can
use that to generate a sensitivity file.  Here is the
call for this example, which I run in the Science/ folder::

    pypeit_sensfunc spec1d_b24-Feige66_KASTb_2015may20T041246.960.fits -o Kastb_feige66_sens.fits

See :doc:`fluxing` for further details.
.. highlight:: rest

*************
Magellan Mage
*************


Overview
========

This file summarizes several instrument specific
settings that are related to Magellan/Mage.


Short slits
===========

There are several issues related to the very short
slits of Magellan/Mage  (34 pixels or 10" unbinned).

Find Objects
------------

To have enough slit to 'properly' find objects,
we restrict the find_trim_edge parameter, i.e.::

    par['scienceimage']['find_trim_edge'] = (4,4)    # Slit is too short to trim 5,5 especially with 2x binning

For spatial binning, we recommend you to further reduce
this by the binning factor.
.. include:: include/links.rst

.. _master_slits:

===========
MasterSlits
===========


Overview
========

This file describes the MasterSlits object.
It contains the main information on the traced slit edges, organized into left-right slit pairs.


See below for the `Current SlitTrace Data Model`_.
This is written to disk as a multi-extension FITS file prefixed by
MasterSlits in the Masters/ folder.
See the :ref:`master-naming` docs for more.


Viewing
=======

This is the preferred way to view the slit edges information contained in MasterSlits:

.. code-block:: python

    from astropy.io import fits
    from astropy.table import Table

    hdu=fits.open('MasterSlits_A_1_01.fits')
    Table(hdu[1].data)

This will show a table that looks like this:

.. code-block:: python

    spat_id maskdef_id             left_init [4096]                        right_init [4096]                        left_tweak [4096]                        right_tweak [4096]                         center [4096]               mask_init  mask specmin specmax
    int64    int64                    float64                                  float64                                  float64                                  float64                                  float64                    int16   int16 float64 float64
    ------- ---------- ---------------------------------------- ---------------------------------------- ---------------------------------------- ---------------------------------------- ---------------------------------------- --------- ----- ------- -------
         31     699084                 5.0 .. 37.18657261586156 29.277545928955078 .. 62.018354415893555                 5.0 .. 37.18657261586156 29.277545928955078 .. 62.018354415893555   17.13877296447754 .. 49.60246351587756         0     0    -inf     inf
        111     699078   33.88330268859863 .. 65.59163284301758  135.11531257629395 .. 167.1435375213623     37.948677458954 .. 69.65700761337295  135.11531257629395 .. 167.1435375213623  84.49930763244629 .. 116.36758518218994         0     0    -inf     inf
        217     699086 139.54998016357422 .. 170.55170822143555  243.45840644836426 .. 274.8020210266113  143.1504450626825 .. 174.15217312054384  243.45840644836426 .. 274.8020210266113 191.50419330596924 .. 222.67686462402344         0     0    -inf     inf
        322     699091   248.21048545837402 .. 278.352352142334   345.8145122528076 .. 376.4430561065674   251.7797389884793 .. 281.9216056724392   345.8145122528076 .. 376.4430561065674   297.0124988555908 .. 327.3977041244507         0     0    -inf     inf
        457     699080  350.76593017578125 .. 379.9788398742676   514.4993572235107 .. 544.0507583618164  355.0206685112119 .. 384.23357820969824    513.3126446738094 .. 542.864045812115     432.632643699646 .. 462.014799118042         0     0    -inf     inf

In addition, if reducing :doc:`deimos` or :doc:`mosfire` data and slit-mask design matching is performed
(see :ref:`deimos:Slit-mask design matching` for DEIMOS and :ref:`mosfire:Edge Tracing` for MOSFIRE), a second
`astropy.io.fits.BinTableHDU`_ is written to disk.

.. code-block:: python

    Table(hdu[2].data)

    TRACEID TRACESROW     TRACELPIX          TRACERPIX      SPAT_ID SLITID       SLITLOPT           SLITROPT         SLITRA      SLITDEC        SLITLEN       SLITWID  SLITPA ALIGN OBJID     OBJRA        OBJDEC   OBJNAME  OBJMAG OBJMAG_BAND OBJ_TOPDIST OBJ_BOTDIST
     int64    int64        float64            float64        int64  int64        float64            float64         float64      float64        float64       float64 float64 int16 int64    float64      float64    str32  float64    str32      float64     float64
    ------- --------- ------------------ ------------------ ------- ------ ------------------- ------------------ ------------ ----------- ------------------ ------- ------- ----- ------ ------------ ----------- ------- ------- ----------- ----------- -----------
          0      2048                5.0  56.08821487426758      31 699084 -21.955958625056724  69.84514502686432 358.68126787  42.3347698 10.682000160217285     1.0     0.0     0 733790  358.6812625   42.334675 3003915   21.39           I         5.0       5.682
          1      2048 59.798553466796875 161.30295944213867     111 699078   72.84633999813946  175.5490274983032 358.69310956 42.33811871 11.979000091552734     1.0     0.0     0 733784 358.69310417 42.33803333 3003737   22.54           I       5.682       6.297
          2      2048  164.9419937133789 269.14466094970703     217 699086  178.11184062306785 283.34493633572674 358.67168891 42.34139707 12.293000221252441     1.0     0.0     0 733792 358.67168333 42.34143889 3104178   21.19           I       6.297       5.996
          3      2048  272.8930130004883  370.9837417602539     322 699091   286.1885530241663   384.710234625776 358.65265564 42.34461342 11.529000282287598     1.0     0.0     0 733797    358.65265 42.34467778 3104468   20.24           I       5.996       5.533
          4      2048 374.71178817749023    538.83056640625     457 699080  387.93013336193303  552.8797949320767 358.68945391 42.34933141 19.270000457763672     1.0     0.0     0 733786    358.68945 42.34819167 3103868   22.44           I       5.533      13.737

See `Current SlitTrace Data Model`_ for a description of the columns.


Current SlitTrace Data Model
============================

Internally, the MasterSlits object is held in :class:`pypeit.slittrace.SlitTraceSet`,
which is a :class:`pypeit.datamodel.DataContainer`.


Here is its datamodel, which is written as an `astropy.io.fits.BinTableHDU`_.
In addition, if reducing :doc:`deimos` or :doc:`mosfire` data and slit-mask design matching is performed,
another  `astropy.io.fits.BinTableHDU`_ is written to a fits extension named `MASKDEF_DESIGNTAB`.

.. include:: include/datamodel_slittrace.rst==========
GTC OSIRIS
==========


Overview
========

This file summarizes several instrument specific
settings that are related to the GTC/OSIRIS spectrograph.

Common Items
============

Targets centred on chip 2
+++++++++++++++++++++++++

GTC/OSIRIS has two detectors with the object of interest always centred on
chip 2.  For many users this might meaning running run_pypeit with the
"--det 2" switch.

Standards taken with wide-slit
++++++++++++++++++++++++++++++

GTC/OSIRIS standards are not taken with the same setup as the science.
The standards are taken with a 2.5" wide slit, so standards are exempted
from the usual criteria for distinguishing unique setups and are simply
included in the setup(s) with the same dispersion element.

MOS fails
+++++++++

MOS setups are prone to failures, particularly when slits are very close
together (which can lead to overlaps that are identified as slits) or very
short.  For overlapping slitlets, one can set::

    [calibrations]
        [[slitedges]]
            minimum_slit_length = 2.

To avoid these overlapping regions from being identified as slits.
Similarly, short slits which cause problems for flat-fielding,
sky-subtraction or object detection can be ignored by setting the same
parameter to ~4.0
.. _construct_template:

======================================
Constructing a New Wavelength Template
======================================


Overview
========

This doc describes how to create a wavelength template used to perform
wavelength calibration with the :ref:`wave_calib:Automated Algorithms`.

See :doc:`wave_calib` for a discussion of various algorithms and
see :doc:`master_wvcalib` for a discussion of the
main outputs and good/bad examples.

Finding Data
============

To build a new template, the requirements are wavelength calibrations for the
arc spectra over the full wavelength range needed. This may take multiple
exposures of arc lamps to cover the full range.

Using the Holy Grail Algorithm
==============================

Once you have a set of different arc lamp exposures that cover the desired range,
run through the data using the option of the :ref:`wave_calib:Holy Grail` algorithm to generate a
master wavelength calibration and select the slits where the technique is
successful. See :doc:`master_wvcalib` for an example QA plot that illustrates
a good wavelength solution.

With a complete set of correctly calibrated arc line data, identify wavelength
regions, with no gaps, that cover the full range in wavelength desired.

In situations where the Holy Grail fails, one may resort to

    `pypeit_identify`

See :ref:`wave_calib:pypeit_identify`.

If a calibrated arc line spectrum that covers the desired wavelength range is already available,
an ``ascii`` file with 2 columns, `wavelength` and `flux`, can be used instead of running the reduction with the
:ref:`wave_calib:Holy Grail` algorithm.

Creating the Template
=====================

Once all of the slits and master wavelength calibration files are
selected, use the function :func:`pypeit.core.wavecal.templates.build_template` to turn the list of slits,
wavelength ranges, and master wavecalib files into a final template.

For longevity, it is a good idea to obtain the PypeIt Development Suite and combine your solution
with all PypeIt wavelength solutions using the same instrument and grating. If you used the
:ref:`wave_calib:pypeit_identify` utility, it will output a file called ``wvcalib.fits``.
You should put this file in the appropriate instrument folder in the PypeIt Development Suite
templates directory::

    $PYPEIT_DEV/dev_algorithms/wavelengths/template_files/

you should also rename this file to match the current formatting:

    `mv wvcalib.fits TELESCOPE_INSTRUMENT_GRATING_WAVECEN.fits`

Now, open the :func:`pypeit.core.wavecal.spectrographs/templ_TELESCOPE_INSTRUMENT.py` file,
and either add a new setup if yours doesn't already exist, or edit a setup if you want to add your solution
to a pre-existing setup (this is only usually warranted if you are extending the wavelength coverage of
a previous setup). The key information you will need is the spectral binning and the slit spatid.
Both of these numbers are printed on the command line when you complete the fitting with the
:ref:`wave_calib:pypeit_identify` utility.
Once this is setup, simply cd into the same directory as the `templ_TELESCOPE_INSTRUMENT.py` file and run
`python templates.py`.
This will automatically put your solution into the reid_arxiv. Add all of these files to git, and submit a
PR for both PypeIt and the PypeIt Development Suite.

Alternatively, if you want to construct a template file yourself (with the possible disadvantage that
your solution cannot be stitched together with solutions from the same spectrograph+grating in the future),
you can write a script, and the input looks like the following:

.. code-block:: python

    from pypeit.core.wavecal import templates

    templates.build_template(wfiles, slits, wv_cuts, binspec, outroot, ifiles=ifiles, det_cut=det_cut, chk=True,
                             normalize=False, lowredux=False, subtract_conti=True, overwrite=overwrite, shift_wave=True)

See :func:`pypeit.core.wavecal.templates.build_template` for a description of all the parameters, and
``pypeit/core/wavecal/spectrographs`` for examples of the use of this function.

This produces a file called ``outroot`` that contains the template. The templates are saved in
``pypeit/data/arc_lines/reid_arxiv``. It also produces a plot of the final product.

.. _slit_tracing:

============
Slit Tracing
============

Overview
========

One of the first and most crucial steps of the pipeline is to auto-magically
identify the slits (or orders) on a given detector. This is a challenging
task owing to the wide variety in:

  - the number of slits/orders,
  - the separation between slits/orders (if any)
  - the varying brightness of flats across the detector

Developing a single algorithm to handle all of these edge cases (pun
intended) is challenging if not impossible. Therefore, there are a number of
user-input parameters that one may need to consider when running PypeIt (see
below).

Underlying the effort is the :class:`~pypeit.edgetrace.EdgeTraceSet` class.

Viewing
=======

See :doc:`master_edges` and :doc:`master_slits` for notes on how to view the
outputs related to `Slit Tracing`_.

Script
======

Slit tracing is one of the steps in ``PypeIt`` that can be run independently
of the full reduction, using the ``pypeit_trace_edges`` script. This can
nominally be run just by providing a trace image (but this has had limited
testing), but it's recommended that you first construct the
:ref:`pypeit_file` you would use to fully reduce the data (see
:ref:`pypeit_setup`) and supply that as the argument to
``pypeit_trace_edges``.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_trace_edges.rst


Known Slit Tracing Issues
=========================

No Slits
--------

It is possible that the edge-tracing algorithm will not find *any* slit
edges. This may be because the edges fall off the detector, that there truly
is no data in a given detector of a multi-detector instrument (e.g.,
:doc:`lris`), or the threshold for edge detection has been set too high. An
inability to find slit edges can be common for long-slit observations, but
occurs occasionally for multi-slit. If you know that a given detector should
have well-defined slit edges, try adjusting the ``edge_thresh`` parameter
(see :ref:`trace-edge-thresh`). Regardless, if ``PypeIt`` does not find any
slit edges, there are two ways it can proceed:

 1. The default behavior for *most* (but not all) instruments is to simply
    skip any detectors where the edge-tracing algorithm does not find any
    edges. If this is the case, ``run_pypeit`` will issue a warning that the
    calibrations for a given detector have failed (in ``get_slits``). For
    single-detector instruments, this means that ``PypeIt`` might exit
    gracefully without actually producing much output. For multi-detector
    instruments (e.g., DEIMOS), this means that ``PypeIt`` will skip any
    further processing of the detector and move on to the next one. If you
    already know the detectors that should be skipped, you can use the pypeit
    file to *select* the detectors that should be processed (see the
    ``detnum`` parameter in :ref:`pypeit_par:ReduxPar Keywords`)::

        [rdx]
            detnum = 2,3,4

 2. You can force ``PypeIt`` to add left and right edges that bound the
    spatial extent of the detector using the ``bound_detector`` parameter in
    :ref:`pypeit_par:EdgeTracePar Keywords`. This is required for instruments
    where the entire detector is illuminated so that the slit edges are
    projected off the detector, or for situations where the detector is
    windowed (Shane Kast) in such a way that the slit edges are not covered
    by the windowed detector. Although bounding the detector in this way
    allows the code to continue to subsequent analysis steps, using this
    approach comes with a significant warning:

    .. warning::

        When bounding the spatial extent of the detector by straight slit
        edges, the spectral curvature is not properly traced. This can lead
        to errors in the subsequent processing steps and/or highly
        sub-optimal extraction of any object spectra. If available, users
        should be sure to add a standard-star observation to the ``PypeIt``
        file (ensuring that is classified as a ``standard`` frame), so that
        ``PypeIt`` will use the standard star trace as a crutch for object
        tracing in the ``science`` frames.

Slit PCA fails
--------------

The default tracing uses a PCA analysis that requires a minimum
number of slits to succeed.  If there aren't enough, you should
revert back to the `nearest` mode by setting the `sync_predict`
keyword in :ref:`pypeit_par:EdgeTracePar Keywords` to `nearest`, e.g.::

    [calibrations]
      [[slitedges]]
        sync_predict = nearest



Missing a Slit
--------------

It is common for some spectrographs for the code to miss
one or more slits.  This may be mitigated by modifying the
`edge_thresh` or `minimum_slit_length` keywords of
:ref:`pypeit_par:EdgeTracePar Keywords`.

Otherwise, the code may be instructed to add slits at user-input
locations.  The syntax is is a list of lists, with
each sub-list having syntax (all integers):  detector:y_spec:x_spat0:x_spat1
For example::

    [calibrations]
      [[slitedges]]
        add_slits = 2:2000:2121:2322,3:2000:1201:1500

The above will add one slit on detector 2 with left/right edge at
2121/2322 at row 2000.  The shapes of the slit will be taken from
the ones that are nearest or the PCA model if it exists.

Too many Slits
--------------

The code may identify stray light or some other spurious
feature as a slit.  This might be mitigated by increasing
the value of `edge_thresh` in
:ref:`pypeit_par:EdgeTracePar Keywords`.  Indeed, this
is required for longslit observations
with the red camera of :doc:`lris`.

Otherwise, the code may be instructed to remove slits at user-input
locations. The syntax is a list of lists,
with each sub-list having syntax (all integers):  detector:y_spec:x_spat
For example::

    [calibrations]
      [[slitedges]]
        rm_slits = 2:2000:2121,3:2000:1500

This will remove any slit on detector 2 that contains x_spat=2121
at row=2000 and similarly for the slit on det=3.

Slit Tracing Customizing
========================

The following are settings that the user may consider
varying to improve the slit tracing.

.. _trace-edge-thresh:

Detection Threshold
-------------------

The detection threshold for identifying slits is set
relatively low to err on finding more than fewer slit edges.
The algorithm can be fooled by scattered light and detector
defects.  One can increase the threshold with the *sigdetect*
parameter::

    [calibrations]
      [[slitedges]]
        edge_thresh = 30.

Then monitor the number of slits detected by the algorithm.

Presently, we recommend that you err on the conservative
side regarding thresholds, i.e. higher values of sigdetect,
unless you have especially faint trace flat frames.

On the flip side, if slit defects (common) are being
mistaken as slit edges then *increase* sigdetect
and hope for the best.

.. _trace-slit-mask_frac_thresh:

Fraction Threshold
------------------

In an interemediate step, the mslit_tcrude() method,
the edges defined thus far are traced across the detector
with the trace_crude method.  A PCA analysis of these is
then performed on those edges which spanned at least
mask_frac_thresh of the detector in the spectral direction.

The default value is 0.6 which may be too large for some
instruments (e.g. LRISb with the 300 grism).  Consider
lowering the value, especially if the code raised a warning
on too few edges for the PCA::

    [calibrations]
      [[slitedges]]
        fit_min_spec_length = 0.45

You may also need to adjust the `Smash Range`_.


Smash Range
-----------

One of the final steps in slit/order definition is to identify
edges by smashing a rectified version of the Sobolev image.
The default is to smash the entire image, but if the spectra
are primariliy in a subset of the image one should consider
modifying the default parameter.  This is frequently the
case for low-dispersion data, e.g. LRISb 300 grism spectra
(which has a different default value).  Modify it as such::

    [calibrations]
      [[slits]]
        smash_range = 0.5,1.




Algorithm
=========

THIS IS SOMEWHAT OUT OF DATE

Here is the flow of the algorithms.

#. A Sobolev S/N image is generated from the trace flat image
#. edge detection: An initial set of edges are derived from the Sobolev
   according to the `Detection Threshold`_.
#. match edges:  An algorithm is performed to match edges into slits
   for the first time.
#. trace (crudely) the slits: Each slit edge is traced with the trace_crude
   algorithm and snippets of edges are (hopefully) merged
#. PCA: A PCA analysis is performed of the well-traced edges found thus far.
   This is then used to rectify the Sobolev images and search for additional edges.
#. synchronize: Slit edges are synchronized primarily to pick up missing edges
#. trim: Trimming of small slits is performed

Open Issues
===========

#.  Bad columns yield fake edges.  These should be masked out by the pipeline
    using the instrument-specific bad pixel mask.
#.  Overlapping slits are notoriously difficult to detect.  One may need to
    add/subtract individual slits on occasion.



.. _bitmasks:

Bitmasks
========

``PypeIt`` has implemented a generalized class for handling bitmasks.

.. include:: include/links.rst

.. include:: include/bitmask_usage.rst


.. _wave_calib:

======================
Wavelength Calibration
======================

.. index:: wave_calib

Overview
========

Wavelength calibration is performed using arc lamp spectra
or the night sky lines, dependent on the instrument.
In all cases, the solution is provided in vacuum.

This doc describes the wavelength calibration
`Automated Algorithms`_
the `By-Hand Approach`_ including the
`pypeit_identify`_ script,
`Common Failure Modes`_, and more.

See :doc:`master_wvcalib` for a discussion of the
main outputs and good/bad examples.

Automated Algorithms
====================

These notes will describe the algorithms used to perform
wavelength calibration in 1D (i.e. down the slit/order)
with PypeIt.   The basic steps are:

 1. Extract 1D arc spectra down the center of each slit/order
 2. Load the parameters guiding wavelength calibration
 3. Generate the 1D wavelength fits

The code is guided by the WaveCalib class, partially described
by this `WaveCalib.ipynb <https://github.com/pypeit/pypeit/blob/master/doc/nb/WaveCalib.ipynb>`_
Notebook.

For the primary step (#3), we have developed several
algorithms finding it challenging to have one that satisfies
all instruments in all configurations.  We now briefly
describe each and where they tend to be most effective.
Each of these is used only to identify known arc lines in the
spectrum.  Fits to the identified lines (vs. pixel) are
performed with the same, iterative algorithm to generate
the final wavelength solution.

.. _wvcalib-holygrail:

Holy Grail
----------

This algorithm is based on pattern matching the detected lines
with that expected from the lamps observed.  It has worked
well for the low dispersion spectrographs and has been used
to generate the templates used for most of the other algorithms.

It has the great positive of requiring limited developer
effort once a vetted line-list for the observed lamps has been
generated.

However, we have found this algorithm is not highly robust
(e.g. slits fail at ~5-10% rate) and it struggles with
high dispersion data (e.g. ThAr lamps).  At this stage, we
recommend it be used primarily by the Developers to generate
template spectra.

Reidentify
----------

Following on our success using archived templates with the
LowRedux code, we have implemented an improved version in PypeIt.
Each input arc spectrum is cross-correlated against one or
more archived spectra, allowing for both a shift and a stretch.

Archived spectra that yield a high cross-correlation score
are used to identify arc lines based on their recorded
wavelength solutions.

This algorithm is optimal for fixed-format spectrographs
(e.g. X-Shooter, ESI).

.. _wvcalib-fulltemplate:

Full Template
-------------

This algorithm is similar to `Reidentify`_ with
two exceptions:  (i) there is only a single template used
(occasionally one per detector for spectra that span across
multiple, e.g. DEIMOS); (ii) IDs from
the input arc spectrum are generally performed on snippets
of the full input array.  The motivation for the latter is
to reduce non-linearities that are not well captured by the
shift+stretch analysis of `Reidentify`_.

We recommend implementing this method for multi-slit
observations, long-slit observations where wavelengths
vary (e.g. grating tilts).  We are likely to implement
this for echelle observations (e.g. HIRES).

.. _wvcalib-byhand:

By-Hand Approach
================

Identify
--------

If you would prefer to manually wavelength calibrate, then
you can do so with the 'pypeit_identify' task. To launch this task,
you need to have successfully traced the slit edges (i.e. a
:doc:`master_edges` file must exist), and generated a
:doc:`master_arc`
calibration frame.

pypeit_identify
+++++++++++++++

usage
-----

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_identify.rst

To launch the GUI, use the following command:

.. code-block:: bash

    pypeit_identify MasterArc_A_1_01.fits MasterSlits_A_1_01.fits.gz

basics
------

Instructions on how to use this GUI are available by pressing
the '?' key while hovering your mouse over the plotting window.
You might find it helpful to specify the wavelength range of the
linelist and the lamps to use using the pypeit_identify command
line options.

Here is a standard sequence of moves once the GUI pops up:

0. Load an existing ID list if you made one already (type 'l').
   If so, skip to step 7.
1. Compare the arc lines to a calibrated spectrum
2. Use the Magnifying glass to zoom in on one you recognize and
   which is in the PypeIt linelist(s)
3. To select a line, use 'm' to mark the line near the cursor,
   or use a left mouse button click near the line (a red line
   will appear on the selected line)
4. Use the slider bar to select the wavelength (vacuum)
5. Click on Assign Line (it will be blue when you move the mouse back in
   the plot window)
6. Repeat steps 1-5 until you have identified 4+ lines across the spectrum
7. Use 'f' to fit the current set of lines
8. Use '+/-' to modify the order of the polyonmial fit
9. Use 'a' to auto ID the rest
10. Use 'f' to fit again
11. Use 's' to save the line IDs and the wavelength solution if the
    RMS of the latter is within tolerance.

Some tips: Pressing the left/right keys will advance the
line list by one. You may find it helpful to toggle between
pixel coordinates and wavelength coordinates (use the 'w' key
to toggle between these two settings). Wavelength coordinates
can only be accessed once you have a preliminary fit to the
spectrum. When plotting in wavelength coordinates, you can
overplot a 'ghost' spectrum (press the 'g' key to activate
or deactivate) based on the linelist which may help you to
identify lines. You can shift and stretch the ghost spectrum
by clicking and dragging the left and right mouse buttons,
respectively (if you're not in 'pan' mode). To reset the
shift/stretch, press the 'h' key.

If your solution is good enough (rms < 0.1 pixels), then
`pypeit_identify`_ will automatically prompt you after you
quit the GUI to see if you want to save the solution. Note,
you can increase this tolerance using the command line option
`pixtol`, or by setting the `force_save` command line option.

To use this wavelength solution in your reduction, you will
need to add your solution to the PypeIt database. To do this,
you will need to move the output file into the master directory,
which will be similar to the following directory:

``/directory/to/PypeIt/pypeit/data/arc_lines/reid_arxiv/name_of_your_solution.fits``

Once your solution is in the database, you will be able to
run PypeIt in the standard :ref:`wvcalib-fulltemplate` mode.
Make sure you add the following line to your pypeit file::

  [calibrations]
     [[wavelengths]]
        reid_arxiv = name_of_your_solution.fits

We also recommend that you send your solution to the
PypeIt development (e.g. post it on GitHub or the Users Slack)
team, so that others can benefit from your wavelength
calibration solution.

customizing
-----------

If your arclines are over-sampled (e.g. Gemini/GMOS)
you may need to increase the `fwhm` from the default value of 4.
And also the pixel tolerance `pixtol` for auto ID'ng lines
from its default of 0.1 pixels.
And the `rmstol`, if you wish to save the solution to disk!



Common Failure Modes
====================

Most of the failures should only be in MultiSlit mode
or if the calibrations for Echelle are considerably
different from expectation.

As regards Multislit, the standard failure modes of
the :ref:`wvcalib-fulltemplate` method that is now preferred
are:

 1. The lamps used are different from those archived.
 2. The slit spans much bluer/redder than the archived template.

In either case, a new template may need to be generated.
If you are confident this is the case, raise an Issue.

Items to Modify
===============

There are several parameters in the Wavelength Calibration
:ref:`pypeit_par:WavelengthSolutionPar Keywords` that one
needs to occasionally customize for your specific observations.
We describe the most common below.

FWHM
----

The arc lines are identified and fitted with an
expected knowledge of their FWHM (future versions
should solve for this).  A fiducial value for a
standard slit is assumed for each instrument but
if you are using particularly narrow/wide slits
than you may need to modify::

    [calibrations]
      [[wavelengths]]
        fwhm=X.X

in your PypeIt file.


Alternatively, PypeIt can compute the arc line FWHM from the arc lines themselves (only the ones with the
highest detection significance). The FWHM measured in this way will override the value set by `fwhm`, which
will still be used as first guess and for the :doc:`wavetilts`.
This is particularly advantageous for multi-slit observations that have slit with different slit widths,
e.g., DEIMOS LVM slit-masks.
The keyword that controls this option is called `fwhm_fromlines` and is set to `False` by default. To switch it
on add::

    [calibrations]
      [[wavelengths]]
        fwhm_fromlines = True

in your PypeIt file.

Line Lists
==========

Without exception, arc line wavelengths are taken from
the `NIST database <http://physics.nist.gov/PhysRefData>`_,
*in vacuum*. These data are stored as ASCII tables in the
`arclines` repository. Here are the available lamps:

======  ==========  ==============
Lamp    Range (A)   Last updated
======  ==========  ==============
ArI     3000-10000  21 April 2016
CdI     3000-10000  21 April 2016
CuI     3000-10000  13 June 2016
HeI     2900-12000  2 May 2016
HgI     3000-10000  May 2018
KrI     4000-12000  May 2018
NeI     3000-10000  May 2018
XeI     4000-12000  May 2018
ZnI     2900-8000   2 May 2016
ThAr    3000-11000  9 January 2018
======  ==========  ==============

In the case of the ThAr list, all of the lines are taken from
the NIST database, and are labelled with a 'MURPHY' flag if the
line also appears in the list of lines identified by
`Murphy et al. (2007) MNRAS 378 221 <http://adsabs.harvard.edu/abs/2007MNRAS.378..221M>`_



Flexure Correction
==================

By default, the code will calculate a flexure shift based on the
extracted sky spectrum (boxcar). See :doc:`flexure` for
further details.

.. _wvcalib-develop:

Developers
==========

Adding a new Solution
---------------------

When adding a new instrument or grating, one generally has
to perform a series of steps to enable accurate and precise
wavelength calibration with PypeIt.  We recommend the following
procedure, when possible:

- Perform wavelength calibration with a previous pipeline
   * Record a calibrated, arc spectrum, i.e. wavelength vs. counts
   * In vaccuum or convert from air to vacuum

- If no other DRP exists..
   * Try running PypeIt with the :ref:`wvcalib-holygrail` algorithm and use that output
   * And if that fails, generate a solution with the :ref:`wvcalib-byhand`

- Build a template from the arc spectrum
   * For fixed-format spectrographs, one spectrum (or one per order) should
     be sufficient.
   * For gratings that tilt, one may need to splice together a series
     of arc spectra to cover the full spectral range.
   * See examples in the `templates.py` module.
   * See :doc:`construct_template`

- Augment the line list
   * We are very conservative about adding new lines to the existing line lists.
     One bad line can have large, negative consequences.
   * Therefore, carefully vet the line by insuring it is frequently
     detected
   * And that it does not have large systematic residuals in good
     wavelength solutions.
   * Then add to one of the files in data/arc_lines/lists

.. _full-template-dev:

Full Template Dev
-----------------

The preferred method for multi-slit calibration is now
called `full_template` which
cross-matches an input sepctrum against an archived template.  The
latter must be constructed by a Developer, using the
core.wavecal.templates.py module.  The following table
summarizes the existing ones (all of which are in the
data/arc_lines/reid_arxiv folder):

===============  =========================  =============================
Instrument       Setup                      Name
===============  =========================  =============================
keck_deimos      600ZD grating, all lamps   keck_deimos_600ZD.fits
keck_deimos      830G grating, all lamps    keck_deimos_830G.fits
keck_deimos      1200G grating, all lamps   keck_deimos_1200G.fits
keck_deimos      1200B grating, all lamps   keck_deimos_1200B.fits
keck_deimos      900ZD grating, all lamps   keck_deimos_900ZD.fits
keck_lris_blue   B300 grism, all lamps      keck_lris_blue_300_d680.fits
keck_lris_blue   B400 grism, all lamps?     keck_lris_blue_400_d560.fits
keck_lris_blue   B600 grism, all lamps      keck_lris_blue_600_d560.fits
keck_lris_blue   B1200 grism, all lamps     keck_lris_blue_1200_d460.fits
keck_lris_red    R400 grating, all lamps    keck_lris_red_400.fits
keck_lris_red    R1200/9000 , all lamps     keck_lris_red_1200_9000.fits
shane_kast_blue  452_3306 grism, all lamps  shane_kast_blue_452.fits
shane_kast_blue  600_4310 grism, all lamps  shane_kast_blue_600.fits
shane_kast_blue  830_3460 grism, all lamps  shane_kast_blue_830.fits
===============  =========================  =============================

See the Templates Notebook or the core.wavecal.templates.py module
for further details.

One of the key parameters (and the only one modifiable) for
`full_template` is the number of snippets to break the input
spectrum into for cross-matchging.  The default is 2 and the
concept is to handle non-linearities by simply reducing the
length of the spectrum.  For relatively linear dispersers,
nsinppet=1 may frequently suffice.

For instruments where the spectrum runs across multiple
detectors in the spectral dimension (e.g. DEIMOS), it may
be necessary to generate detector specific templates (ugh).
This is especially true if the spectrum is partial on the
detector (e.g. the 830G grating).



.. toctree::
   :caption: Additional Reading
   :maxdepth: 1

   flexure
   heliocorr
   wavetilts
   construct_template
==========
MasterBias
==========

Overview
========

This file describes the data model for the MasterBias image.
This is written to disk as a multi-extension FITS file prefixed by
MasterBias in the Masters/ folder.

This is generally a simple combination of all input bias frames.

Inspecting
==========

The first extension is the stacked image.  You can view it with
any standard image viewer, e.g.::

    ginga Masters/MasterBias_A_1_01.fits

It should resemble any one of your input bias frames aside from:

- Having been overscan subtracted
- Being only a trimmed portion of the image
- Re-oriented so that vertical is the spectral dimension with blue at the bottom

Here is an example for the :ref:`keck-lris-red` spectrograph.

.. image:: figures/bias_image.png

Pretty boring, as expected.
Note that this is only 1 of the 2 detectors for this spectrograph.

Trouble Shooting
================

If your image appears to be in err, here are the things to consider:

 - Is one or more of your input bias frames junk?
 - Is one or more of your input bias frames mis-labeled?

Current BiasImage Data Model
============================

Internally, the image is held in
:class:`pypeit.images.buildimage.BiasImage`
which is a :class:`pypeit.images.pypeitimage.PypeItImage` and
:class:`pypeit.datamodel.DataContainer`.
The datamodel written to disk is:

.. include:: include/datamodel_biasimage.rst

==============
Running PypeIt
==============

Overview
========

This document describes the process to run the reduction.

It assumes:

1. You have already properly inspected and fussed with your setups (:doc:`setup`).

2. You have entered one of the setup sub-folders.

3. You edited the :doc:`pypeit_file` as desired.

4. You have removed any (likely all) calibration file from the
Masters/ folder that are stale/old versions/etc.




.. _run-pypeit:

run_pypeit
==========

The main script to run the PypeIt reduction is :ref:`run-pypeit`.  It
was placed in your Python path when you installed the code.

.. _run-pypeit-usage:

usage
-----

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/run_pypeit.rst

Standard Call
-------------

A typical run of PypeIt is initiated with a command like::

    run_pypeit keck_lris_blue_multi_600_4000_d560.pypeit -o

The code launches, reads the :doc:`pypeit_file`, initiates a few internals,
and then proceeds to generate *a lot* of messages in the terminal window.
We fear that some of those comments are outdated or even misleading.
In short, only a PypeIt `developer` is likely to make too much sense of them.

Options
-------

There are a few standard options that you should consider.
These are listed in the :ref:`run-pypeit-usage` and we
describe them in a bit more detail here with guidance on
when to (or not to) use them.

-o
++

The `-o` or `--overwrite` command will over-write any existing
files and directories.  We recommend this be used the majority of the
time.  But if you know you only want to re-reduce a few science frames,
then remove them and run without `-o`.

-m
++

This `-m` or `--do_not_use_masters` flag tells PypeIt to **avoid**
using any existing
calibration frames (referred to as :doc:`masters`) instead
of loading from disk.

Using this can *greatly* slow down the code.

-s
++

This is the main debugging mode of PypeIt.  It will generate *a lot*
of plots to the screen.  It is probably too overwhelming for most users,
i.e. best for *developers*.



.. _master_wvcalib:

===============
MasterWaveCalib
===============

Overview
========

This file describes the data model for the `MasterWaveCalib`_.

The images are written to disk as a multi-extension FITS file
prefixed by `MasterWaveCalib`_ in the Masters/ folder.
See :ref:`masters:Masters Naming` for the naming convention.

Inspecting
==========

.. _pypeit-chk-wavecalib:

pypeit_chk_wavecalib
--------------------

You can print a set of simple diagnostics to the screen
with the *pypeit_chk_wavecalib* script, e.g. ::

     pypeit_chk_wavecalib Masters/MasterWaveCalib_A_1_03.fits
     #
     SpatID minWave Wave_cen maxWave dWave Nlin  RMS
    ------ ------- -------- ------- ----- ---- -----
        54  5596.7   6858.8  8236.6 0.680   12 0.573
       148  3620.1   4946.3  6259.7 0.647   16 0.234
       230  4105.6   5368.2  6673.7 0.629   33 0.164
       302  5615.7   6889.9  8234.8 0.685    6 0.002
       384  3980.9   5242.8  6548.3 0.629   31 0.121
       482  4081.7   5344.4  6649.7 0.629   34 0.186
       586  4154.5   5417.4  6722.6 0.629   32 0.120


PNGs
----

At present, the only way to examine the quality of this
step is by viewing the PNG file generated by the code.
:doc:`qa` describes how to access them.

There is 1 PNG file generated per slit.  Here is an
example from the `shane_kast_red` spectrograph.

.. image:: figures/arc_1d_fit.png

What you hope to see in your QA is:

 - On the left, many of the blue arc lines marked with IDs
 - In the upper right, an RMS < 0.1 pixels
 - In the lower right, a random scatter about 0 residuals


Trouble Shooting
================

Wavelength solutions are amongst the most challenging
part of data reduction.  See :doc:`wave_calib` for
extensive details on how PypeIt performs wavelength
calibration and related issues.


Current WaveCalib Data Model
============================

Internally, the image is held in
:class:`pypeit.wavecalib.WaveCalib`
which is a :class:`pypeit.datamodel.DataContainer`.
The datamodel written to disk is:

.. include:: include/datamodel_wavecalib.rst


.. highlight:: rest

.. _internals:

*********
Internals
*********

Overview
========

This file contains notes related to the internal
workings of PypeIt.

Objects
=======


filesort
--------

This *dict* whose keys are the various :doc:`frametype` used
in PypeIt and the items are arrays of the indices of the frames
with that type.

Generated by arsort.sort_data()

.. _internal_setup_dict:

setup_dict
----------

This highly nested *dict* organizes the various setups used in the input set of
data files.  The top-level keys, which define the setup,
are simple labels:  A, B, C, ...

The next set of keys are:

*  '--': which holds a *dict* defining properties of the setup (e.g. dichroic)
*  '01': a *dict* holding detector specific info (e.g. binning)
*  'aa', 'ab', 'ac', etc:  are *dict*'s containing lists of filenames as a function of frame type

Here is an example (as output to the .setups file)::

    A:
      --:
        dichroic: d55
        disperser: {angle: None, name: 600/4310}
        slit: {decker: 0.5 arcsec, slitlen: None, slitwid: None}
      '01': {binning: None, det: 1, namp: 2}


Usually generated by arsetup.instr_setup()

.. _internal_setup_id:

setup_ID
--------

The setup_ID is then commbines the keys of the :ref:`internal_setup_dict`,
e.g.  **A_01_aa**
.. PypeIt documentation master file, created by
   sphinx-quickstart on Fri Nov 13 13:39:35 2015.
   You can adapt this file completely to your liking, but it should at least
   contain the root `toctree` directive.

.. |DOI_latest| image:: https://zenodo.org/badge/DOI/10.5281/zenodo.3743493.svg
   :target: https://doi.org/10.5281/zenodo.3743493

.. |JOSS| image:: https://joss.theoj.org/papers/10.21105/joss.02308/status.svg
   :target: https://doi.org/10.21105/joss.02308

.. |arxiv| image:: https://img.shields.io/badge/arxiv-2005.06505-black
   :target: https://arxiv.org/abs/2005.06505

.. |pypi| image:: https://img.shields.io/badge/pypi-latest-blue
    :target: https://pypi.org/project/pypeit/

.. |issues| image:: https://img.shields.io/github/issues/fpavogt/fcmaker.svg?colorB=b4001e
   :target: https://github.com/fpavogt/fcmaker/issues

.. |astropy| image:: http://img.shields.io/badge/powered%20by-AstroPy-orange.svg?style=flat
    :target: http://www.astropy.org/


.. |stars| image:: https://img.shields.io/github/stars/fpavogt/fcmaker.svg?style=social&label=Stars
   :target: https://github.com/pypeit/PypeIt

.. |watch| image:: https://img.shields.io/github/watchers/fpavogt/fcmaker.svg?style=social&label=Watch
   :target: https://github.com/pypeit/PypeIt


.. |github| image:: https://img.shields.io/github/release/fpavogt/fcmaker.svg
   :target: https://github.com/pypeit/PypeIt

.. |pypeit_logo| image:: https://img.shields.io/github/release/fpavogt/fcmaker.svg
   :target: https://github.com/pypeit/PypeIt

PypeIt |stars| |watch|
======================

|pypi| |DOI_latest| |arxiv| |astropy|

.. raw:: html

    <img src="_static/PypeIt_color_white_txt_black_background.png" onerror="this.src='_static/astropy_banner_96.png'; this.onerror=null;" width="485"/>

**Version**: |version|

``PypeIt`` is a Python package for semi-automated reduction of
astronomical, spectroscopic data. Its algorithms build on
decades-long development of previous data reduction pipelines by the
developers. The reduction procedure - including a complete list of
the input parameters and available functionality - is provided by
this online documentation.

``PypeIt`` is a set of commands designed to perform the reduction
without any additional coding.

This release of ``PypeIt`` is designed to be used by both advanced
spectroscopists with prior data reduction expertise and astronomers
with no prior experience of data reduction. It is highly configurable
and designed to be applied to any standard slit-imaging spectrograph,
and can accommodate long-slit, multi-slit, as well as cross-dispersed
echelle spectra.

Citation
++++++++

If you use ``PypeIt`` in your research, please cite the following
publications (:ref:`bibtex` are provided below):

 - Prochaska et al. (2020, JOSS): `arXiv <https://ui.adsabs.harvard.edu/abs/2020arXiv200506505P/abstract>`__, `JOSS <https://joss.theoj.org/papers/10.21105/joss.02308>`__
 - Prochaska et al. (2020, Zenodo): `Zenodo <https://ui.adsabs.harvard.edu/abs/2020zndo...3743493P/abstract>`__

If there is no place to include the relevant citations in the text of
the publication, please include the following acknowledgement
(provided in latex and using the provided :ref:`bibtex`):

.. code-block:: latex

    This research made use of \ttfamily{PypeIt},\footnote{\url{https://pypeit.readthedocs.io/en/latest/}}
    a Python package for semi-automated reduction of astronomical slit-based spectroscopy
    \citep{pypeit:joss_pub, pypeit:zenodo}.

----

Funding
+++++++

``PypeIt`` receives direct funding from the following sources:

  * NASA (ADAP-A20-0412)
  * W.M. Keck Observatory
  * University of California Observatories

We also rely on important in-kind contributions from individuals at
Caltech, the Multiple Mirror Observatory, and elsewhere.

What this version provides
++++++++++++++++++++++++++

* Support for 20+ :doc:`spectrographs`; see there for the full list, including
  those that are currently in various stages of development.
 
  * Bok/B&C
  * Gemini/GNIRS
  * Gemini/GMOS
  * Gemini/FLAMINGOS 2
  * GTC/OSIRIS
  * Lick/Kast
  * Magellan/MagE
  * Magellan/Fire
  * MDM/OSMOS
  * Keck/DEIMOS (600ZD, 830G, 1200G, 1200B, 900ZD)
  * Keck/KCWI
  * Keck/LRIS
  * Keck/MOSFIRE (Y, J, K gratings tested)
  * Keck/NIRES
  * Keck/NIRSPEC (low-dispersion; old detector)
  * LBT/Luci-I
  * LBT/Luci-II
  * LBT/MODS
  * LDT/DeVeny
  * MDM/OSMOS
  * MMT/MMIRS
  * MMT/binospec
  * MMT/bluechannel
  * NOT/ALFOSC
  * P200/DBSP
  * P200/TripleSpec
  * VLT/X-Shooter (VIS, NIR)
  * VLT/FORS2 (300I, 300V)

* Default reduction algorithms

  * :doc:`flat_fielding` with illumination pattern correction
  * Full 2D :doc:`wave_calib` (no rectification)
  * :doc:`flexure` (spatial and spectral)
  * Global and local :doc:`skysub`
  * Optimal (and boxcar) :doc:`extraction`
  * :doc:`A-B_differencing`
  * Slitmask metadata slurping including RA/DEC (:doc:`deimos` only)

* Documentation

  * :doc:`installing`
  * :doc:`setup`
  * :doc:`pypeit_par`
  * :doc:`cookbook`
  * Data Models for (nearly) all output files
  * :doc:`fluxing`
  * :doc:`manual`
  * :doc:`telluric`
  * :doc:`2d_combine`
  * :doc:`coadd1d`
  * :doc:`coadd2d`

* Scripts and Tools for Inspection

  * Slit Edges -- :ref:`master_edges:pypeit_chk_edges`
  * Flats -- :ref:`master_flat:pypeit_chk_flats`
  * 1D Spectra-- :ref:`out_spec1D:pypeit_show_1dspec`
  * 2D Spectra-- :ref:`out_spec2D:pypeit_show_2dspec`

* :doc:`quicklook`

What this version is missing (i.e. what we are working on)
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

* Full 2D coadd support
* Additional QA outputs
* A dashboard to monitor/control ``PypeIt``
* Keck/HIRES, Keck/ESI support


Users
=====

If you are mainly here to use ``PypeIt`` to reduce your observational
data then this section is for you. Ideally, you will need to go not
much further than the few links in this section take you.

If you have problems, we have a very active "PypeIt Users" Slack
workspace. We periodically update the invitation `here
<https://github.com/pypeit/PypeIt/issues/676>`__. If you find a bug
or have a feature request, please `submit an issue
<https://github.com/pypeit/PypeIt/issues>`__.

----

.. toctree::
   :caption: Getting started
   :maxdepth: 1

   codeconduct
   installing
   cookbook
   step-by-step
   known_failure_modes

----

.. toctree::
   :caption: Running
   :maxdepth: 1

   spectrographs
   setup
   pypeit_par
   pypeit_file
   running
   quicklook
   2d_combine
   object_finding
   skysub
   extraction
   scripts
   A-B_differencing
   nir_example

----

.. toctree::
   :caption: Standard outputs
   :maxdepth: 1

   image_proc
   calibrations
   outputs
   qa

----

.. toctree::
   :caption: Further processing
   :maxdepth: 1

   fluxing
   coadd1d
   telluric
   coadd2d
   coadd3d
   collate1d

----

.. toctree::
   :caption: For developers
   :maxdepth: 1

   dev/development
   PypeIt API <api/modules>
   new_spectrograph

Contributors
============

``PypeIt`` is an open-source, community developed package.
Astronomers are encouraged to join the project and should review our
:doc:`codeconduct` and :ref:`development`. We would also appreciate
if you contact the lead developers (JXP, JFH) before beginning
development activities.

The following persons have contributed substantially to the
development of ``PypeIt``.

* J Xavier Prochaska
* Joseph F. Hennawi
* Kyle B. Westfall
* Ryan J. Cooke
* Feige Wang
* Tiffany Hsyu
* Frederick B. Davies
* Emanuele Paolo Farina
* Debora Pelliccia
* James Reichwein

----

.. _bibtex:

PypeIt BibTeX Entries
+++++++++++++++++++++

.. code-block:: latex

    @ARTICLE{pypeit:joss_arXiv,
           author = {{Prochaska}, J. Xavier and {Hennawi}, Joseph F. and {Westfall}, Kyle B. and
             {Cooke}, Ryan J. and {Wang}, Feige and {Hsyu}, Tiffany and
             {Davies}, Frederick B. and {Farina}, Emanuele Paolo},
            title = "{PypeIt: The Python Spectroscopic Data Reduction Pipeline}",
          journal = {arXiv e-prints},
         keywords = {Astrophysics - Instrumentation and Methods for Astrophysics},
             year = 2020,
            month = may,
              eid = {arXiv:2005.06505},
            pages = {arXiv:2005.06505},
    archivePrefix = {arXiv},
           eprint = {2005.06505},
     primaryClass = {astro-ph.IM},
           adsurl = {https://ui.adsabs.harvard.edu/abs/2020arXiv200506505P},
          adsnote = {Provided by the SAO/NASA Astrophysics Data System}
    }

    @article{pypeit:joss_pub,
        doi = {10.21105/joss.02308},
        url = {https://doi.org/10.21105/joss.02308},
        year = {2020},
        publisher = {The Open Journal},
        volume = {5},
        number = {56},
        pages = {2308},
        author = {J. Xavier Prochaska and Joseph F. Hennawi and Kyle B. Westfall and Ryan J. Cooke and Feige Wang and Tiffany Hsyu and Frederick B. Davies and Emanuele Paolo Farina and Debora Pelliccia},
        title = {PypeIt: The Python Spectroscopic Data Reduction Pipeline},
        journal = {Journal of Open Source Software}
    }

    @MISC{pypeit:zenodo,
           author = {{Prochaska}, J. Xavier and {Hennawi}, Joseph and {Cooke}, Ryan and
             {Westfall}, Kyle and {Wang}, Feige and {EmAstro} and {Tiffanyhsyu} and
             {Wasserman}, Asher and {Villaume}, Alexa and {Marijana777} and
             {Schindler}, JT and {Young}, David and {Simha}, Sunil and
             {Wilde}, Matt and {Tejos}, Nicolas and {Isbell}, Jacob and
             {Fl{\"o}rs}, Andreas and {Sandford}, Nathan and {Vasovi{\'c}}, Zlatan and
             {Betts}, Edward and {Holden}, Brad},
            title = "{pypeit/PypeIt: Release 1.0.0}",
             year = 2020,
            month = apr,
              eid = {10.5281/zenodo.3743493},
              doi = {10.5281/zenodo.3743493},
          version = {v1.0.0},
        publisher = {Zenodo},
           adsurl = {https://ui.adsabs.harvard.edu/abs/2020zndo...3743493P},
          adsnote = {Provided by the SAO/NASA Astrophysics Data System}
    }

.. include:: include/links.rst

.. _new_script:

*****************************
Developing New PypeIt Scripts
*****************************

All of the ``PypeIt`` executable scripts are located in the ``pypeit/scripts``
directory, and they all have roughly the same structure:

.. code-block:: python

    from pypeit.scripts import scriptbase

    class NewScript(scriptbase.ScriptBase):

        @classmethod
        def get_parser(cls, width=None):
            parser = super().get_parser(description='A new PypeIt script', width=width)
            ...

        @staticmethod
        def main(args):
            ...

The important components of the scripts are:

 * To ease installation and documentation of the scripts, they all must use
   :class:`~pypeit.scripts.scriptbase.ScriptBase` as their base class.  Note
   that the class has no instantiation method.

 * The :func:`~pypeit.scripts.scriptbase.ScriptBase.get_parser` function is used
   to return an instance of `argparse.ArgumentParser`_ used to parse the
   command-line arguments.

 * The :func:`~pypeit.scripts.scriptbase.ScriptBase.main` function performs the
   primary operations of the script.  It needs no return value, but a return is
   not prohibited (see, e.g.,
   :class:`~pypeit.scripts.chk_for_calibs.ChkForCalibs`).

 * Each file in the ``pypeit/scripts`` directory should only contain *one*
   script class.  The :func:`~pypeit.scripts.scriptbase.ScriptBase.name`
   function sets the name of the script to ``pypeit_{module}`` by default, where
   ``{module}`` is the name of the file.  E.g., if the file name of the new
   script is ``new_script.py`` the executable installed will be
   ``pypeit_new_script``.  This can be altered by overriding the base class
   ``name`` function (see :class:`~pypeit.scripts.run_pypeit.RunPypeIt`).

The base class, :class:`~pypeit.scripts.scriptbase.ScriptBase`, provides the
common entry point function
(:func:`~pypeit.scripts.scriptbase.ScriptBase.entry_point`) used during
installation.  To ensure that the script is properly installed by `pip`_, you
need to add this entry point to the ``setup.cfg`` file.  All of the ``PypeIt``
scripts are listed in the ``[options.entry_points]`` group.  To add your script,
you enter a new line with the following format:

.. code-block:: ini

    pypeit_new_script = pypeit.scripts.new_script:NewScript.entry_point

Lastly, you should add the import of the script module to the
``pypeit/scripts/__init__.py`` file; i.e., add:

.. code-block:: python

    from pypeit.scripts import new_script

Note that the script files in the ``pypeit/scripts`` directory:

 * Should not be executable (i.e., no xs in their permissions)
 * Should not start with an env statement; i.e., ``#!/usr/bin/env python``
 * Should not end with the ``if __name__ == '__main__':`` block

Creating the executables from the raw script files is all handled by `pip`_
installing ``PypeIt``.  To ensure the script is installed, from the top-level
directory run, e.g.:

.. code-block:: console

    pip install -e ".[dev]"


==========
MasterFlat
==========

Overview
========

This file describes the data model for the `MasterFlat`_.
It is a series of images starting from
the combination of all input *pixelflat* frames.

The images are written to disk as a multi-extension FITS file
prefixed by `MasterFlat`_ in the Masters/ folder.
See :ref:`masters:Masters Naming` for the naming convention.


Inspecting
==========

PypeIt provides the `pypeit_chk_flats` script to inspect
the key `MasterFlat`_ outputs.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_chk_flats.rst

.. _pypeit_chk_flats:

pypeit_chk_flats
----------------

This script takes a `MasterFlat`_ as input and displays
a series of images in a
`ginga <https://ginga.readthedocs.io/en/latest/>`_
viewer, each in a separate tab.

Here is a typical call::

    pypeit_chk_flats Masters/MasterFlat_A_1_01.fits

We now describe the standard products.
There is enough variation from spectrograph to
spectrograph that we have not included example
screen-shots.

Raw Flat
--------

This is the processed and combined `pixelflat` images.
Despite the name, it is not completely Raw.

This image should look like any one of your input
`pixelflat` images.

Pixel Flat
----------

This is the normalized to unity image which is used to
correct for pixel-to-pixel variations across the detector.

It should look mainly like a salt-and-pepper, random-noise image
fluctuating very close around values of 1.

For many detectors there may be 'pock' marks, columns,
and even funny patterns.

It is also typical for the extreme spectral portions (top/bottom)
to have more structure or pattern noise.  This is especially
true if there is limited flux at these ends (e.g. the data
goes below the atmospheric cutoff).

Illumination Flat
-----------------

This image should also have most values near unity, but
there will be vertical coherence.  And the edges (left/right)
may fall off well below unity.

Flat Model
----------

This image should largely resemble the `Raw Flat`_.

Trouble Shooting
================

If one or more of your image appears to be in err,
here are the things to consider:

 - Is one or more of your flat frames junk?
 - Is one or more of your input flat frames mis-labeled?
 - Did you saturate portions of the flat?

Current FlatImages Data Model
=============================

Internally, the image is held in
:class:`pypeit.flatfield.FlatImages`
which is a :class:`pypeit.datamodel.DataContainer`.

The datamodel written to disk is:

.. include:: include/datamodel_flatimages.rst


.. include:: include/links.rst

.. _known_failure_modes:

=============
Failure Modes
=============

Overview
========

This doc attempts to capture known failure modes of
PypeIt and potential mitigations.  These are intended to be 
distinct from common user error.

.. bad-headers:

Bad Headers
===========

A common failure mode is individual data files have 
corrupt headers.  This occurs somewhat frequently
at the Keck Observatory when the instrument loses 
connectivity with the telescope.

The :ref:`pypeit-setup` and :ref:`pypeit-obslog` scripts
have been written to be *immune* from this.  Therefore,
a failure when using this scripts should be brought to the
attention of the developers.

The :ref:`run-pypeit` script, however, is designed to 
fail as the default when presented with files that
have corrupt headers.  To over-ride that, you need
to add the following to your :ref:`pypeit_file`::

    [rdx]
    ignore_bad_headers = True

Note that PypeIt always uses the entries in your data block
(often slurped from the headers) as the *true* values, i.e.
you can modify those by hand to over-come aspects of your
corrupt header.


=================
Manual Extraction
=================

Overview
========

This document describes how to perform so-called Manual
Extraction in PypeIt.  This is generally for cases where the
object continuum is too faint to trigger the auto-magical
:doc:`object_finding` algorithm.

Process
=======

Here is the standard recipe:

1. Reduce the spectral image(s)
2. Examine the spec2d images with :ref:`pypeit_show_2dspec`
3. Record the spatial and spectral pixel where the trace should cross
4. Modify the PypeIt file as described below
5. :ref:`run-pypeit` again

Tracing
-------

The code will lay down a new trace and perform extraction
at each input location.  The trace used will be, in order
of decreasing preference:

1. The brightest object on the slit, offset to the input position
2. The standard star
3. The slit edges

Multi-Slit
----------

If you are running in multi-slit mode, you will add the spatial-spectral
pixel pair for each object to extract for each detector to the PypeIt file.

Here is an example::

    [reduce]
      [[extraction]]
        [[[manual]]]
           spat_spec = 212.3:1200,742.3:1200
           det = 1,2
           fwhm = 3.,3.

The above will lay down a new trace at spatial=212.3, spectral=1200
pixel on detector 1 and use a FWHM of 3 pixels.


Echelle
-------

For echelle, you only have to specify the object location in a single
order and the code will use its fractional position on all other orders.

Here is an example from the DevSuite (VLT_manual)::

    [reduce
      [[extraction]]
        [[[manual]]]
           spat_spec = 1181.8:3820.6
           det = 1
           fwhm = 3.

*********************
Quick Look Reductions
*********************

Overview
========

PypeIt provides a set of Quick Look scripts for
quick reductions, presumably at the telescope.
We describe each in turn.

.. _pypeit-ql-mos:

pypeit_ql_mos
=============

This script performs a boxcar (only) extraction of a long
or multi-slit observation taken with one of PypeIt's
spectrographs.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_ql_mos.rst

And here is a sample call on files from the Development suite::

    pypeit_ql_mos shane_kast_blue /home/xavier/local/Python/PypeIt-development-suite/RAW_DATA/Shane_Kast_blue/600_4310_d55 b1.fits.gz b10.fits.gz b27.fits.gz

This generates a `shane_kast_blue_A` folder with the standard
calibration (Masters), QA, and Science outputs.

This script has been tested successfully on the following instruments:
shane_kast_blue, shane_kast_red, keck_lris_blue, keck_deimos.

.. _pypeit-ql-mos-options:

QL Options
++++++++++

Here are a few of the standard options:

--box_radius
------------

Specify the size of the extraction radius.

--ignore_headers
----------------

If your telescope (e.g. Keck) has a tendency to write
bad headers, you may wish to set it.  We recommend
not doing so until you see it crash from a bad header.

--det
-----

Specify the detector to be reduced. Only 1 is done at a time.

--slit_spat
-----------

Specify the spatial position of the single slit to reduce.
On the detector you chose.

Examples
++++++++

shane_kast_blue::

    pypeit_ql_mos shane_kast_blue /home/xavier/local/Python/PypeIt-development-suite/RAW_DATA/Shane_Kast_blue/600_4310_d55 b1.fits.gz b10.fits.gz b27.fits.gz

keck_lris_red (longslit)::

    pypeit_ql_mos keck_lris_red /home/xavier/local/Python/PypeIt-development-suite/RAW_DATA/Keck_LRIS_red/long_600_7500_d560 LR.20160216.05709.fits.gz LR.20160216.13991.fits.gz LR.20160216.40478.fits.gz --det 2 --ignore_headers

keck_lris_blue (longslit + archived pixel flat)::

    pypeit_ql_mos keck_lris_blue /home/xavier/scratch/FRB190714/Raw b191228_1020.fits b191228_1066.fits b191228_1051.fits --det 2 --user_pixflat=/home/xavier/local/Python/PypeIt-development-suite//CALIBS/PYPEIT_LRISb_pixflat_B600_2x2_17sep2009.fits.gz

keck_deimos (multislit with one slit isolated)::

    pypeit_ql_mos keck_deimos /home/xavier/scratch/QL/2020-03-29-DEIMOS-TestData DE.20100913.56927.fits DE.20100913.57161.fits DE.20100913.22358.fits -d 7 --slit_spat 1132

It is possible all of the MOS :doc:`spectrographs` will work.
Give it a shot!

pypeit_ql_keck_nires
====================

This script performs a quick A-B reduction of a pair of
Keck/NIRES spectral images.  Currently, the code takes
2min and 20s to process two images with boxcar extractions.
Therefore, there is a first set of nires-output_ in
approximately 1 minute.

NIRES QL Setup
++++++++++++++

Before running this script, you will need to download the quick-look masters.
See the :ref:`data_installation` section of the :ref:`installing` instructions.

.. _nires-options:

NIRES QL Options
++++++++++++++++

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_ql_keck_nires.rst

NIRES QL Example
++++++++++++++++

Here is an example call::

    pypeit_ql_keck_nires /data/Keck_NIRES/Raw s180604_0089.fits.gz s180604_0090.fits.gz -b 0.5

.. _nires-output:

NIRES QL Output
+++++++++++++++

If all goes smoothly, the code will generate four spectral
output files, with 2 each with extensions of spec1d and
spec2d.  These can be viewed with :ref:`pypeit_show_1dspec`
and :ref:`pypeit_show_2dspec`.

pypeit_ql_keck_mosfire
======================

This script performs a quick A-B reduction of pairs of
Keck/MOSFIRE spectral images.  Currently only the "Y" filter is supported.

MOSFIRE QL Setup
++++++++++++++++

Before running this script, you will need to download the quick-look masters.
See the :ref:`data_installation` section of the :ref:`installing` instructions.

.. _mosfire-options:

MOSFIRE QL Options
++++++++++++++++++

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_ql_keck_mosfire.rst

MOSFIRE QL Example
++++++++++++++++++

Here is an example call::

    pypeit_ql_keck_mosfire /data/Keck_MOSFIRE/Raw m191120_0043.fits m191120_0044.fits m191120_0045.fits m191120_0046.fits --spec_samp_fact 2.0 --spat_samp_fact 2.0

.. _mosfire-output:

MOSFIRE QL Output
+++++++++++++++++

If all goes smoothly, a ginga window will open with the resulting image.


==============
Reduction Tips
==============

Overview
========

This document describes commonly adjusted
:doc:`pypeit_par` related to
object finding, sky-subtraction, and extraction of the spectra.

It assumes (but does not require):

1. You have already generated a set of :doc:`out_spec2D` files.

2. You have inspected the spectra wish to improve aspects of them.


Object Finding
==============

Refer to :doc:`object_finding` for full details on the algorithm.
This process is guided by the :ref:`pypeit_par:FindObjPar Keywords`.

The most common to modify is **sig_thresh** which sets the
search for any source with *peak* flux in excess of **sig_thresh**
times the RMS.  The default is 10 and you may wish to
reduce this parameter.   Add the following to the
:ref:`pypeit_file:Parameter Block`::

    [reduce]
      [[findobj]]
          sig_thresh = 3.

This will search for any source with peak flux 3-sigma above the
estimated RMS in the smashed slit profile.

No 1D Spectra Extracted
-----------------------
If you are missing 1D spectra, this means that PypeIt did not find any objects in the corresponding frame.  Here are some common modifications that you can make to your :ref:`pypeit_file:Parameter Block` to remedy this.  It may help to run the reduction on a few of your exposures in -s mode to make sure that your modifications are being implemented the way you intend.

-Ensure that the slits are correctly identified.  See :ref:`slit_tracing` for tips on how to adjust your slit edges (for example, modifying ``edge_thresh`` or ``minimum_slit_length``) and add or remove a slit.
-Modify the significance threshold for object finding (see above).
-Modify the maximum number of objects that you expect to see in your frames.  The default is 10, but, for example, if your exposure only contains one object of interest, you will want to change your :ref:`pypeit_file:Parameter Block` to look like this::
	
	[reduce]
      [[findobj]]
          maxnumber = 1

-Modify the FWHM of your object of interest in pixels.  The default is 10, but you may want to increase or decrease this, depending on number of pixels per spatial PSF::

	[reduce]
      [[findobj]]
          find\_fwhm = 8.


Extraction
==========

Emission Lines
--------------

It is common for bright emission lines to spatially extend
beyond the source continuum, especially for galaxies.  In
these cases, the code may reject the emission lines because
they present a different spatial profile from the majority
of the flux.

While this is a desired behavior for optimal extraction of
the continuum, it leads to incorrect and non-optimal fluxes
for the emission lines.

The current mitigation is to allow the code to reject the
pixels for profile estimation but then to include them in
extraction.  This may mean the incurrence of cosmic rays
in the extraction.

Here is the expert move.  Add the following to the
:ref:`pypeit_file:Parameter Block`::

    [reduce]
      [[extraction]]
          use_2dmodel_mask = False

And it is likely you will want to use the BOXCAR extractions
instead of OPTIMAL.  But do a comparison.
.. highlight:: rest

.. _standards:

**************
Standard Stars
**************

PypeIt has a set of standard stars used for flux
calibration that are mainly taken from the now
defunct STScI calspec package.

.. _standard_list:

calspec standards
=================

The following table is an incomplete list
of the standard stars we are using from
the dataset known as calspec, originally
maintained by STScI.


========================== ============= ============== ==============
  File                      Name            RA_2000      DEC_2000
========================== ============= ============== ==============
gd50_004.fits               GD50          03:48:50.10    -00:58:30.0
hz4_stis_001.fits           HZ4           03:55:21.77    +09:47:18.4
lb227_004.fits              LB227         04:09:28.50    +17:07:55.2
hz2_005.fits                HZ2           04:12:43.49    +11:51:50.6
g191b2b_mod_005.fits        G191B2B       05:05:30.61    +52:49:51.9
gd71_mod_005.fits           GD71          05:52:27.50    +15:53:17.0
bd_75d325_stis_001.fits     BD+75325      08:10:49.49    +74:57:57.9
agk_81d266_stis_001.fits    AGK+81266     09:21:19.18    +81:43:27.6
gd108_005.fits              GD108         10:00:47.00    -07:33:30.0
feige34_stis_001.fits       FEIGE34       10:39:36.74    +43:06:09.3
hd93521_stis_001.fits       HD93521       10:48:23.51    +37:34:13.1
hz21_stis_001.fits          HZ21          12:13:56.27    +32:56:31.4
feige66_002.fits            FEIGE66       12:37:23.52    +25:03:59.9
feige67_002.fits            FEIGE67       12:41:51.79    +17:31:19.8
gd153_mod_004.fits          GD153         12:57:02.00    +22:02:00.0
hz43_mod_004.fits           HZ43          13:16:21.85    +29:05:55.4
hz44_005.fits               HZ44          13:23:35.26    +36:07:59.5
grw_70d5824_stis_001.fits   GRW+705824    13:38:50.47    +70:17:07.6
p041c_stisnic_001.fits      P041C         14:51:58.19    +71:43:17.3
bd_33d2642_fos_003.fits     BD+332642     15:51:59.89    +32:56:54.3
p177d_stisnic_001.fits      P177D         15:59:13.59    +47:36:41.8
p330e_stisnic_001.fits      P330E         16:31:33.85    +30:08:47.1
wolf1346_iraf_001.fits      Wolf1346      20:34:21.90    +25:03:51.0
lds749b_005.fits            LDS749B       21:32:16.10    +00:15:15.0
bd_28d4211_stis_001.fits    BD+284211     21:51:11.02    +28:51:50.4
g93_48_004.fits             G93-48        21:52:25.38    +02:23:19.6
bd_25d4655_002.fits         BD+254655     21:59:41.97    +26:25:57.4
bd_17d4708_stis_001.fits    BD+174708     22:11:31.37    +18:05:34.2
ngc7293_005.fits            NGC7293       22:29:38.55    -20:50:13.6
ltt9491_002.fits            LTT9491       23:19:35.00    -17:05:30.0
feige110_005.fits           FEIGE110      23:19:58.40    -05:09:56.2
========================== ============= ============== ==============

Full list is available in pypeit/data/standards/calspec/README

ESO standards
=============

We now include a few ESO standard star files




.. _object_finding:

==============
Object Finding
==============

This document describes how the code identifies
objects within the slits/orders.

Overview
========

Object identification is a challenging process to
code, especially to allow for a large dynamic range
between bright continuum sources and faint emission
line sources.

Our general philosophy has been to err on the
bright side, i.e. detect more probable sources.

FindObj Parameters
==================

This reduction step is guided by the
:ref:`pypeit_par:FindObjPar Keywords`.

Algorithms
==========

Each of the algorithms described below attempt to
identify the peak location of objects in the slit
and then defines a left and right edge for each source.

In a standard run, these are performed twice.
Once before any sky subtraction and then again
after the global sky subtraction has been performed.

automatic
---------

The standard algorithm performs the following steps:

1. Rectify the sky-subtracted frame

2. Smooth this 2D image

3. Perform sigma clipping (median stat) down the wavelength dimension to further reject CRs.  This may eliminate bright emission lines.

4.  Smash the 2D image along the spectral dimension, to get a 1D array that represents the spatial profile of the exposure.

5. If **find_cont_fit** is True, fit a continuum to the profile and subtract it.

6.  Estimate the RMS scatter in the profile array.

7.  Find all objects with peak flux in excess of **sig_thresh** times the RMS.

8.  Eliminate any objects within a few percent of the slit edge. Parameterized by `trace object xedge`.

9.  Determine edges and background regions for each object.

10.  Restrict to **maxnumber** of objects, ordered by flux.

The most common modification that we recommend is to reduce
**sig_thresh** to enable the identification of fainter sources
(at the risk of false positives).  Reasonable results have been
obtained with **sig_thresh** as low as 3.0.

To make this modification, add the following to your
:doc:`pypeit_file`::

    [reduce]
      [[findobj]]
        sig_thresh = 3.



Interactive object finding/tracing
----------------------------------

.. warning::

    The ``pypeit_find_objects`` script has been deprecated until it can be
    updated.  The following description is outdated!!

THE FOLLOWING IS UNDER DEVELOPMENT.

In some cases, the code may not find the object that you're after,
or may find several spurious objects. To add/remove/modify object
traces interactively, there is an interactive GUI utility.

pypeit_find_objects Science/spec2d.fits

and this will launch an interactive GUI that will allow you to perform
several simple operations on the object tracing. The
tool will produce a few lines of text that you can insert
into your .pypeit file, and this will allow for a
reproducible data reduction.

Using this tool, you will be able to delete spurious traces, add new object traces,
and manually set the FWHM of the object profile. To view a complete list of
the supported functions, press the '?' key on your keyboard when the
mouse is hovering over the panel displaying the 2D image. The detailed
information will be printed to the terminal (i.e. it is not displayed
on the GUI). Below we discuss some of the operations you can perform
with this GUI.

The main panel displays the 2D sky subtracted image of the data.
Darker shades correspond to higher flux. The green/blue lines display
the left/right slit edges. Dashed red lines indicate the object traces
currently stored. You can select an object trace by clicking
(left mouse button) near an object trace; the selected object trace
will be highlighted by a solid thick red line.

The bottom right panel displays the object profile (the profile is
only displayed when an object is selected). By clicking (left mouse
button) on this panel, you can set the FWHM of the object trace. The
FWHM is indicated by the vertical red lines in this panel.

The top (information) panel will provide information about the current
status of the object tracing, and will sometimes prompt the user for
a yes/no response (e.g. "Are you sure you want to delete this trace?").
You can select the answer by clicking on the yes/no button when they
appear.

Finally, there are two buttons on the right hand side of the GUI that
allow you to exit the tracing and print out a script for you to
include in your .pypeit file. **Please use these exit buttons instead of killing the window
from the menu bar**. The button labelled "Continue (and save changes)"
will exit the session and print to screen the relevent text needed
for inclusion in the .pypeit file. The button labelled
"Continue (don't save changes)" will exit the interactive session and
all of your interactive changes will be ignored.

Just below these exit buttons there are four radio buttons that allow
you to select a method to trace the object profiles. Below is a
description of each of these models:

+ *Object* - If there is a bright object on the same slit,
  the trace of the bright object will be used.
+ *Standard Star* - If a standard star has been acquired,
  the trace defined by the standard star will be used.
+ *Slit Edges* - The object trace will follow the same functional
  form as the function that defines the slit edge tracing.
+ *Manual* - Allows the user to manually define an arbitrary slit.

You can use the matplotlib tools to zoom in on the data frame (e.g.
using the rectangular selection tool). To toggle the panning and
zoom feature with the mouse button, press the 'p' key. To return
back to the original plotting extent, press the 'h' or the 'r' key.

To define a new object trace, select one of the first three methods
above, hover the mouse to the location you would like to lay down an
object trace, and press the 'a' key on the keyboard.

When using the "manual" object trace method, you need to define the
anchor points of the object trace. To define the anchor points, hover
the mouse to a location where you see data for the object and press
the 'm' key. This will add a point that helps to identify the object
trace. Add as many points as needed to accurately define the object
trace (a green curve displays the fitted object trace, while single
bullet points define the anchor points). To increase/decrease the
fitting order of the polynomial, press the '+/-' keys on the keyboard.
To delete an individual anchor point, hover near the anchor point
you wish to delete and press the 'n' key. Alternatively, if you want
to clear all anchor points and start again, press the 'c' key. Once
you are satisfied with the green curve defining your object trace,
press the 'a' key to add this to the object tracing.

The delete an object trace, select the object trace by clicking the
left mouse button near the object trace. Once selected, press the
'd' key. If you're sure you want to delete this trace, select "Yes"
from the information panel.

.. The following lines are commented out.
.. The script usage can be displayed by calling the script with the
.. ``-h`` option:

.. .. include:: help/pypeit_find_objects.rst


.. _a-b_differencing:

======================
A-B image differencing
======================

Overview
========

PypeIt can reduce observations obtained using two or more nod
positions in an alternating pattern. In this case, the user needs to edit
the :ref:`pypeit_file` according to the desired reduction.
The good news is that the code has substantial flexibility,
the bad news is that setup is somewhat complex.

PypeIt file
===========

When running :ref:`pypeit_setup` for most near-IR spectrographs, the
:ref:`pypeit_file:Data Block` in the PypeIt file will include three extra 
parameters (``calib``, ``comb_id``, and ``bkg_id``), which should be edited 
according to the desired reduction. This can also
be obtained running :ref:`pypeit_setup` by adding the `-b` option.



Parameters
==========

The three additional columns (``calib``, ``comb_id``, and ``bkg_id``)
have the following meanings/definitions:

* ``calib`` assigns a calibration group ID to each frame. Calibration frames with the same calibration group number
  will be used to reduce a science frame with that calibration group number.
* ``comb_id`` represents a combination ID assigned to each science frame. Frames with the same value of ``comb_id``
  will be co-added together. Note that this is an unweighted co-add (and hence may not be necessarily be "optimal"
  in terms of S/N ratio).
* ``bkg_id`` represents a background ID assigned to each frame that will be used as a background image to be subtracted
  from the combined image created by co-adding all the frames with the same ``comb_id``.  Frames with the same value of
  ``bkg_id`` will be co-added together.



All of these should be assigned integer values (or ``all``, see below), and values less than or equal to 63.


Calibrations
============

Each calibration frame in the :ref:`pypeit_file:Data Block` should have the same ``calib`` ID value of
the science data that uses it, or be set to ``all`` if used by all of the science and standard frames in the pypeit
file.

For the calibration frames ``comb_id`` and ``bkg_id`` are irrelevant and their value
should be set to ``-1``.

Here is an example of a :ref:`pypeit_file:Data Block` for the ``illumflat``, ``pixelflat``, and ``trace`` frames::

    |          filename |                  frametype | ... | calib | comb_id | bkg_id |
    | m190627_0037.fits |  illumflat,pixelflat,trace | ... |   all |      -1 |     -1 |
    | m190627_0038.fits |  illumflat,pixelflat,trace | ... |   all |      -1 |     -1 |
    | m190627_0039.fits |  illumflat,pixelflat,trace | ... |   all |      -1 |     -1 |
    | m190627_0040.fits |  illumflat,pixelflat,trace | ... |   all |      -1 |     -1 |
    | m190627_0041.fits |  illumflat,pixelflat,trace | ... |   all |      -1 |     -1 |

For optical spectrographs, arc/tilt images would be treated similarly.

See below for near-IR spectrographs, where one typically derives the
wavelength and tilt solutions from sky lines in the science frames themselves.

Image Differencing
==================

The user needs to edit ``comb_id``, and ``bkg_id`` in order to
control how PypeIt combines and subtracts the spectroscopic data.

Here is an example of a portion of the :ref:`pypeit_file:Data Block` for the science files for a hypothetical
sequence which we could represent as an ABAB dither pattern::

    |          filename |        frametype | ... | calib | comb_id | bkg_id |
    | m190627_0001.fits | tilt,arc,science | ... |     0 |       1 |      2 |      # Position A
    | m190627_0002.fits | tilt,arc,science | ... |     1 |       2 |      1 |      # Position B
    | m190627_0003.fits | tilt,arc,science | ... |     2 |       3 |      4 |      # Position A
    | m190627_0004.fits | tilt,arc,science | ... |     3 |       4 |      3 |      # Position B

Note that given the values specified, PypeIt is going to compute tilts and arcs from each frame
individually, and it will use image `m190627_0002.fits` as the background to subtract from
image `m190627_0001.fits`, and similarly it will use `m190627_0001.fits` as the background to
subtract from image `m190627_0002.fits`. The values of the ``calib`` ID have no relation to the values for the
``comb_id``, and ``bkg_id``.

PypeIt always produces one set of reduced outputs (i.e. spec2d, spec1d, etc.) for every frame in the PypeIt file
which is labeled as a ``science`` in the PypeIt file.  In other words, the  "positive" and "negative" traces are not
combined into one output file, but rather only the "positive" traces are extracted (although the negative traces are
modeled). Thus for the example above, PypeIt produces four 2D spectral images::

    Science/spec2d-m190627_0001...fits      # m190627_0001.fits - m190627_0002.fits (A-B)
    Science/spec2d-m190627_0002...fits      # m190627_0002.fits - m190627_0001.fits (B-A)
    Science/spec2d-m190627_0003...fits      # m190627_0003.fits - m190627_0004.fits (A-B)
    Science/spec2d-m190627_0004...fits      # m190627_0004.fits - m190627_0003.fits (B-A)


If each frame has a unique ``comb_id`` (as in the example above) the images will *not* be combined before
the reduction.

Alternatively, frames with common values of ``comb_id`` can be co-added. In this case, a common ``bkg_id``
should be used for all frames to be subtracted from frames with common ``comb_id``.

Here is an example of the PypeIt file for combining frames which would represent an ABBA dither pattern where the user
wants to co-add the science frames and the background frames at the same dither position (i.e. AA-BB, and BB-AA)::

    |          filename |        frametype | ... | calib | comb_id | bkg_id |
    | m190627_0001.fits | tilt,arc,science | ... |     0 |      10 |     11 |       # Position A
    | m190627_0002.fits | tilt,arc,science | ... |     1 |      11 |     10 |       # Position B
    | m190627_0003.fits | tilt,arc,science | ... |     1 |      11 |     10 |       # Position B
    | m190627_0004.fits | tilt,arc,science | ... |     0 |      10 |     11 |       # Position A

We chose values of 10 and 11 for the  ``comb_id`` and ``bkg_id`` just to illustrate that these numbers are arbitrary.
Note also that we have assigned the science frames at the same dither position the same ``calib`` ID. This is the
sensible thing to do since those images are being combined and so better to also compute calibrations from the
combined images.

This produces only two spec2d (and spec1d) output images::

    Science/spec2d-m190627_0001...fits      # (m190627_0001+m190627_0004) - (m190627_0002+m190627_0003)  (AA-BB)
    Science/spec2d-m190627_0002...fits      # (m190627_0002+m190627_0003) - (m190627_0001+m190627_0004) (BB-AA)

Finally, let us consider science observations at two dither positions A and B with two exposures taken at each position,
i.e. an AABB dither pattern) but where the user wants to use an image at a third dither location C as the background
image. But since C is purely a background image, it should not be reduced::

    |          filename |        frametype | ... | calib | comb_id | bkg_id |
    | m190627_0001.fits | tilt,arc,science | ... |     0 |      10 |     12 |       # Position A
    | m190627_0002.fits | tilt,arc,science | ... |     0 |      10 |     12 |       # Position A
    | m190627_0003.fits | tilt,arc,science | ... |     1 |      11 |     12 |       # Position B
    | m190627_0004.fits | tilt,arc,science | ... |     1 |      11 |     12 |       # Position B
    | m190627_0005.fits |       background | ... |     2 |      12 |     -1 |       # Position C

This will combine the two A images for the purposes of computing arcs and tilts, and will also combine
them into one science frame. Likewise for the B images. The C image will be used as the background
for both sets of combined images.

The following spec2d (and spec1d) output images are generated::

    Science/spec2d-m190627_0001...fits      # m190627_0001+m190627_0002 - m190627_0005  (AA-C)
    Science/spec2d-m190627_0002...fits      # m190627_0003+m190627_0004 - m190627_0005  (BB-C)

Note that there is no output for image C (m190627_0005.fits). It is not reduced because it was assigned
the `background` frametype.



Summary
=======

* For the ``arc``, ``tilt``, ``illumflat``, ``pixelflat``, and ``trace`` frames, the user should assign
  the same ``calib`` values of the science data that uses them (or ``all``), while ``comb_id``
  and ``bkg_id`` should be set to ``-1``.
* A common ``comb_id`` should be used for all science frames that the user wishes to co-add before
  spectral extraction.
* A common ``bkg_id`` should be used for all frames that the user wishes to subtract from
  the frames with a common ``comb_id``.
* A unique ``calib`` value should be used for each set of images that the user wants to combine for measuring
  calibrations. It should be an integer <= 63.
* The `background` frametype can be used for images that are only to be used as a background for other `science`
  frames. Images with the `background` frametype will not be reduced... _deimos_howto:

============
DEIMOS HOWTO
============

Overview
========

This doc goes through a full run of ``PypeIt`` on a multi-slit
observation with Keck/DEIMOS.
The following was performed on a Macbook Pro with 8 GB RAM 
(we recommend 32GB+ for DEIMOS) and took ~45min for the
one detector.


Setup
=====

Organize data
-------------

Place all of the files in a single folder. Mine is named
``/home/xavier/Projects/PypeIt-development-suite/RAW_DATAkeck_deimos/1200G_M_7750``
(which I will refer to as ``RAW_PATH``).  A useful shortcut for this
can be to set an export variable (here it is in bash)::

    export RAW_PATH=`pwd`

The files within this folder are:

.. code-block:: bash

    $ ls
    DE.20170425.09554.fits.gz  DE.20170425.09803.fits.gz  DE.20170425.53065.fits.gz
    DE.20170425.09632.fits.gz  DE.20170425.50487.fits.gz  
    DE.20170425.09722.fits.gz  DE.20170425.51771.fits.gz

It is perfectly fine for the files to contain more than one mask 
or observations with various gratings.  But be sure to include
all of the calibrations for each. 

Run ``pypeit_setup``
--------------------

The first script you will run with ``PypeIt`` is :ref:`pypeit_setup` which
examines your raw files and generates a sorted list and (when instructed)
one :doc:`pypeit_file` per instrument configuration.

Complete instructions are provided in :doc:`setup`.

Here is my call for these data::

    cd folder_for_reducing   # this is usually *not* the raw data folder
    pypeit_setup -r RAW_PATH/DE. -s keck_deimos -c A

This creates a :doc:`pypeit_file` in the folder named
*keck_deimos_A* beneath where the script was run.
Note that RAW_PATH should be the *full* path, i.e. including a /
at the start.  

You will likely see a few WARNINGs about not determining 
frames of a few types (e.g. align).  You may ignore these (and
most other) WARNING messages of PypeIt.

If your files included more than one setup (including multiple
masks), then you may wish to replace ``A`` in the call to 
:ref:`pypeit_setup` with ``B`` or some
other setup indicator.  Inspect the .sorted file in the setup_files
folder to see all the options.

For this example, my .pypeit file in the keck_deimos_A directory 
looks like this::

    # Auto-generated PypeIt file
    # Tue 20 Apr 2021 12:37:45

    # User-defined execution parameters
    [rdx]
    spectrograph = keck_deimos

    # Setup
    setup read
        Setup A:
            dispname: 1200G
            decker: dra11
            binning: 1,1
            dispangle: 7699.95654297
                amp: SINGLE:B
    setup end

    # Read in the data
    data read
    path /home/xavier/Projects/PypeIt-development-suite/RAW_DATA/keck_deimos/1200G_M_7750
    |                  filename |                 frametype |                 ra |                dec |  target | dispname | decker | binning |          mjd |    airmass | exptime |     dispangle |      amp |    dateobs |         utc |
    | DE.20170425.09554.fits.gz |                  arc,tilt |  57.99999999999999 |               45.0 | unknown |    1200G |  dra11 |     1,1 | 57868.110529 | 1.41291034 |     1.0 | 7699.95654297 | SINGLE:B | 2017-04-25 | 02:39:14.41 |
    | DE.20170425.09632.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | unknown |    1200G |  dra11 |     1,1 | 57868.111418 | 1.41291034 |    12.0 | 7699.95654297 | SINGLE:B | 2017-04-25 | 02:40:32.06 |
    | DE.20170425.09722.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | unknown |    1200G |  dra11 |     1,1 | 57868.112443 | 1.41291034 |    12.0 | 7699.95654297 | SINGLE:B | 2017-04-25 | 02:42:02.26 |
    | DE.20170425.09803.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | unknown |    1200G |  dra11 |     1,1 | 57868.113392 | 1.41291034 |    12.0 | 7699.95654297 | SINGLE:B | 2017-04-25 | 02:43:23.16 |
    | DE.20170425.50487.fits.gz |                   science | 260.04999999999995 | 57.958444444444446 |   dra11 |    1200G |  dra11 |     1,1 | 57868.584271 |  1.2765523 |  1200.0 | 7699.95654297 | SINGLE:B | 2017-04-25 | 14:01:27.15 |
    | DE.20170425.51771.fits.gz |                   science | 260.04999999999995 | 57.958444444444446 |   dra11 |    1200G |  dra11 |     1,1 | 57868.599136 | 1.29137753 |  1200.0 | 7699.95654297 | SINGLE:B | 2017-04-25 | 14:22:51.01 |
    | DE.20170425.53065.fits.gz |                   science | 260.04999999999995 | 57.958444444444446 |   dra11 |    1200G |  dra11 |     1,1 |   57868.6141 | 1.31412428 |  1000.0 | 7699.95654297 | SINGLE:B | 2017-04-25 | 14:44:25.52 |
    data end


In this example, all of the frametypes were accurately assigned
in the :doc:`pypeit_file`, so there are no edits to be made.
This should generally be the case for DEIMOS. 
However, if frame types are not assigned correctly, 
you can edit them following these instructions on
the :ref:`data_block`.

On the other hand, it is the user's responsibility to remove
any bad (or undesired) calibration or science frames from the
list.  Either delete them altogether or comment out with a #.

Note:  we generally recommend to *not* use bias frames with DEIMOS.

I am going to restrict the reduction to only one of the 8 detectors
in the DEIMOS mosaic.  Here detector 7, which is one of the middle
chips and the redder spectra.  I do this by editing the PypeIt file
and its parameter block to now read::

    # User-defined execution parameters
    [rdx]
    spectrograph = keck_deimos
    detnum = 7

A full run with all 8 detectors (the default) is both long and may 
tax (or exceed) the RAM of your computer.  
Therefore, you may wish
to reduce 1 or 2 detectors at a time in this fashion.
For more than one detector, use a list for `detnum`
(e.g.  `detnum = 3,7`).

Main Run
========

Once the :doc:`pypeit_file` is ready, the main call is
simply::

    cd keck_deimos_A
    run_pypeit keck_deimos_A.pypeit -o

The "-o" specifies to over-write any existing science
output files.  As there are none, it is superflous but we
recommend (almost) always using it.

The :doc:`running` doc describes the process in some
more detail.

Inspecting Files
================

As the code runs, a series of files are written to the disk.

Calibrations
------------

The first set are :doc:`calibrations`.
What follows are a series of screen shots
and :doc:`qa` PNGs produced by *PypeIt*.


Slit Edges
++++++++++

The code will automatically assign edges to each slit on the
detector.  This includes using inform from the slitmask design
recorded in the FITS file, as described in :doc:`dev/slitmask_ids`

Here is a zoom-in screen shot from the first tab in the *ginga*
window after using
the :ref:`pypeit_chk_edges` script, with this explicit call
(be patient with *ginga*)::

    pypeit_chk_edges Masters/MasterEdges_A_1_07.fits.gz

.. image:: figures/deimos_edges_image.png

Note the 07 in the filename refers to the detector 7.

The data is the combined flat images and the green/red
lines indicate the left/right slit edges.  The dark blue
labels are the internal slit identifiers of PypeIt.
The cyan numbers are the user-assigned ID values of the slits.

See :doc:`master_edges` for further details.

Arc
+++

Here is a screen shot of most of the arc image as viewed
with *ginga*::

    ginga Masters/MasterArc_A_1_07.fits

As typical of most arc images, one sees a series
of arc lines, here oriented approximately horizontally. 

.. image:: figures/deimos_arc_image.png

See :doc:`master_arc` for further details.

Wavelengths
+++++++++++

One should inspect the :doc:`qa` for the wavelength
calibration.  These are PNGs in the QA/PNG/ folder.

Note:  there are multiple files generated for every slit.
When the reduction is complete, you may prefer to scan
through them by opening the HTML file under QA/.

1D
::

Here is an example of the 1D fits, written to
the QA/PNGs/Arc_1dfit_A_1_07_S0758.png file:

.. image:: figures/deimos_arc1d.png

What you hope to see in this QA is:

 - On the left, many of the blue arc lines marked with green IDs
 - In the upper right, an RMS < 0.1 pixels
 - In the lower right, a random scatter about 0 residuals

See :doc:`master_wvcalib` for further details.


2D
::

There are several QA files written for the 2D fits.
Here is QA/PNGs/Arc_tilts_2d_A_1_07_S0758.png:

.. image:: figures/deimos_arc2d.png

Each horizontal line of black dots is an arc line.
Red points were rejected in the 2D fitting.  Provided
most were not rejected, the fit should be good.
An RMS<0.1 is also desired for this fit.

See :doc:`master_wvcalib` for further details.

Flatfield
+++++++++

The code produces flat field images for correcting
pixel-to-pixel variations and illumination of the detector.

Here is a zoom-in screen shot from the first tab in the *ginga*
window (pixflat_norm) after using
:ref:`pypeit_chk_flats`, with this explicit call::

    pypeit_chk_flats Masters/MasterFlat_A_1_07.fits

.. image:: figures/deimos_flat.png

One notes the pixel-to-pixel variations;  these are
at the percent level.
The slit edges defined by the code
are also plotted (green/red lines).
The regions of the detector beyond the slit
boundaries have been set to unit value.

See :doc:`master_flat` for further details.

Spectra
-------

Eventually (be patient), the code will start
generating 2D and 1D spectra outputs.  One per standard
and science frame, located in the *Science/* folder.

Spec2D
++++++

Slit inspection
:::::::::::::::

It is frequently useful to view a summary of the slits
successfully reduced by PypeIt.  The
:ref:`pypeit_chk_2dslits`, with this explicit call::

    pypeit_chk_2dslits Science/spec2d_DE.20170425.50487-dra11_DEIMOS_2017Apr25T140121.014.fits 

this prints, detector by detector, the SpatID (internal PypeIt name),
MaskID (user ID), and Flags for each slit.  Those with *None* have been
successfully reduced.

Visual inspection
:::::::::::::::::

Here is a screen shot from the third tab in the *ginga*
window (sky_resid-det07) after using
:ref:`pypeit_show_2dspec`, with this explicit call::

    pypeit_show_2dspec Science/spec2d_DE.20170425.50487-dra11_DEIMOS_2017Apr25T140121.014.fits --det 7

.. image:: figures/deimos_spec2d.png

For DEIMOS masks with many slits, the display time is substantial.
You may prefer to limit viewing only a subset of the `channels`
with the `--channels` option.

The green/red lines are the slit edges.
The orange line shows the *PypeIt* trace
of the object and the orange text is the
*PypeIt* assigned name.  Yellow lines indicate
sources that were auto-magically extracted 
based on the mask design (i.e. they had insufficient
S/N for detection).
The night sky and emission lines have been subtracted.

See :doc:`out_spec2D` for further details.

Spec1D
++++++

You can see a summary of all the extracted sources in spec1d*.txt
files in the Science/ folder.  Here is the top of the one I've
produced named spec1d_DE.20170425.50487-dra11_DEIMOS_2017Apr25T140121.014.txt:

.. code-block:: bash

    | slit |                    name | maskdef_id | objname |     objra |   objdec | spat_pixpos | spat_fracpos | box_width | opt_fwhm |   s2n | maskdef_extract | wv_rms |
    |   34 | SPAT0036-SLIT0034-DET07 |    1039404 |    3394 | 260.08018 | 57.96760 |        36.4 |        0.561 |      3.00 |    0.935 | 16.78 |           False |  0.052 |
    |   91 | SPAT0097-SLIT0091-DET07 |    1039403 |    3347 | 260.08404 | 57.94896 |        96.9 |        0.630 |      3.00 |    0.868 | 11.74 |           False |  0.041 |
    |  139 | SPAT0139-SLIT0139-DET07 |    1039402 |    3309 | 260.08660 | 57.97074 |       138.8 |        0.496 |      3.00 |    0.593 |  2.49 |            True |  0.063 |
    |  183 | SPAT0185-SLIT0183-DET07 |    1039401 |    3290 | 260.08949 | 57.94758 |       185.0 |        0.531 |      3.00 |    0.849 | 10.12 |           False |  0.048 |
    |  241 | SPAT0229-SLIT0241-DET07 |    1039400 |    3273 | 260.09227 | 57.94045 |       229.5 |        0.284 |      3.00 |    0.802 |  1.73 |           False |  0.032 |
    |  311 | SPAT0329-SLIT0311-DET07 |    1039399 |    3212 | 260.09824 | 57.98572 |       329.2 |        0.812 |      3.00 |    0.906 | 17.72 |           False |  0.056 |

The *maskdef_id* and *objname* are user supplied in the mask design.
Serendipitous sources will be named SERENDIP.  The *maskdef_extract* flag
indicates whether the extraction was 'forced', i.e. the source was not 
detected by PypeIt so extraction was performed based on the mask design.

One can generate a similar, smaller set of output using the --list option
with :ref:`pypeit_show_1dspec`::

    pypeit_show_1dspec spec1d_DE.20170425.50487-dra11_DEIMOS_2017Apr25T140121.014.fits --list    

Last, here is a screen shot from the GUI showing the
1D spectrum after using
:ref:`pypeit_show_1dspec`, with this explicit call::

   pypeit_show_1dspec spec1d_DE.20170425.50487-dra11_DEIMOS_2017Apr25T140121.014.fits --exten 23

.. image:: figures/deimos_spec1d.png

This uses the
`XSpecGUI <https://linetools.readthedocs.io/en/latest/xspecgui.html>`_
from the *linetools* package.  The black line is the flux and the
red line is the estimated error.

See :doc:`out_spec1D` for further details.

Fluxing
=======

TO BE ADDED WHEN ARCHIVE FLUXING IS IMPLEMENTED

We are currently working to generate archived sensitivity
solutions.

Flexure
=======

The default run performs a flexure correction, slit-by-slit
based on analysis of the sky lines to impose a fixed pixel shift 
for each detector in the spectral dimension.  
For a more accurate solution,
it may be preferred to perform flexure across both detectors.

See :ref:`pypeit_multislit_flexure` for full details on this procedure.**********
NTT EFOSC2
**********


Overview
========

This file summarizes several instrument specific
settings that are related to the NTT/EFOSC2 spectrograph.

Arcs
====
Refer to https://www.eso.org/sci/facilities/lasilla/instruments/efosc/inst/Efosc2Grisms.html for each prism
And https://www.hq.eso.org/sci/facilities/lasilla/instruments/efosc/inst/Perf_HeArLine.list for the whole HeAr line list
Only support Gr#5 and Gr#6 for now.
Note that the 9113 line in Gr#5 given by ESO is wrong.

Flat
====
Fringes are affecting Gr#5 significantly, flat fielding is skipped. If would like to keep, add this to the pipet file:

[scienceframe]
[[process]]
use_illumflat = True
use_pixelflat = True

Overscan
========

Overscan subtraction is aborted for this instrument, we found it leads to a bad subtraction for ~20% of the data.
To allow it, add this to the pipet file:

[scienceframe]
[[process]]
use_overscan = True



==============
Bias and Darks
==============

Overview
========

This doc describes the `Bias Subtraction`_ (including
overscan subtraction)
and `Dark Subtraction`_ performed by PypeIt,
how to modify default implementation
and how to generate the images.


Bias Subtraction
================

All of the optical :doc:`spectrographs` supported by
PypeIt have a non-zero bias level.  This must be subtracted
prior to reduction.

The code allows for two approaches which may be
performed separtely or in tandem, as we now describe.

Bias Image
----------

If the user supplies set of bias images in the
:doc:`pypeit_file` *and* specifies their usage,
this image will be subtracted from the raw image
during reduction.

Generation
++++++++++

If one or more bias frames are provided in the :doc:`pypeit_file`,
these will be combined to generate a bias image.  And this image
will be written to disk as a :doc:`master_bias`. See those docs
on how to inspect the image and what to look for.

The :ref:`pypeit_par:ProcessImagesPar Keywords`
defaults are to:

- Skip cosmic ray rejection in the individual frames (*mask_cr=False*)
- Not apply a gain correction (*apply_gain = False*)
- Not apply an overscan correction (*use_overscan = False*)
- Combine images with a weighted mean (*combine = weightmean*)

Modify these at your discretion (and danger).

Application
+++++++++++

To perform bias image subtraction, the **use_biasimage**
flag in :ref:`pypeit_par:ProcessImagesPar Keywords` must
be *True*.  This is the default for all optical spectrographs.

If you wish to turn this option off (e.g. because you have
not taken any bias images), then add the following to
the :doc:`pypeit_file` :ref:`pypeit_file:Parameter Block`::

    [baseprocess]
        use_biasimage = False

Alternatively, you can turn this option on by setting to *True*,
although you should **not** do so for the bias images themselves.
This is the recommended incantation::

    [baseprocess]
        use_biasimage = True
    [calibrations]
        [[biasframe]]
            [[[process]]]
                use_biasimage = False

Overscan Subtraction
--------------------

The default for all optical :doc:`spectrographs` is to
estimate the bias level from the overscan region and
subtract this from raw image.

If **use_biasimage** was implemented, the overscan region will have been
reduced accordingly.  And the bias image corrected value will be
implemented.

If you wish to ignore the overscan, add the following to
the :doc:`pypeit_file` :ref:`pypeit_file:Parameter Block`::

    [baseprocess]
        use_overscan = False

This should be the default set for :doc:`spectrographs` with near-IR
detectors.

Dark Subtraction
================

PypeIt allows for the construction and subtraction of dark images
from any of its images, except `Bias Image`_.

The generation of a dark image has the following defaults:

- Do not subtract the overscan region (*use_overscan = False*)
- Trim (*trim = True*)
- Orient (*orient = True*)
- Do not subtract a bias image (*use_biasimage = False*)
- Skip cosmic ray rejection in the individual frames (*mask_cr=False*)
- Do not apply a gain correction (*apply_gain = False*)
- Combine images with a weighted mean (*combine = weightmean*)

To apply a dark, you will need to specify the :doc:`frametype`
accordingly.  Here is an example for the VLT/X-SHOOTER NIR arm::

    [calibrations]
      [[pixelflatframe]]
         [[[process]]]
            use_darkimage = True
      [[illumflatframe]]
         [[[process]]]
            use_darkimage = True
      [[traceframe]]
         [[[process]]]
            use_darkimage = True

This will subtract the dark image generated from the flat
and trace :doc:`frametype`.
.. _codeconduct:

***************
Code of Conduct
***************

Here follows the code of conduct for work related to PypeIt.
It is a modified version of
`the one adopted by the astropy community
<https://www.astropy.org/code_of_conduct.html>`_.


PypeIt Community Code of Conduct

The community of participants in open source PypeIt projects
is made up of members from around the globe with a diverse set
of skills, personalities, and experiences.
It is through these differences that our community experiences
success and continued growth. We expect everyone in our
community to follow these guidelines when interacting with
others both inside and outside of our community.
Our goal is to keep ours a positive, inclusive, successful,
and growing community.

As members of the community,

-    We pledge to treat all people with respect and provide a harassment- and bullying-free environment, regardless of sex, sexual orientation and/or gender identity, disability, physical appearance, body size, race, nationality, ethnicity, and religion. In particular, sexual language and imagery, sexist, racist, or otherwise exclusionary jokes are not appropriate.
-    We pledge to respect the work of others by recognizing acknowledgment/citation requests of original authors. As authors, we pledge to be explicit about how we want our own work to be cited or acknowledged.
-    We pledge to welcome those interested in joining the community, and realize that including people with a variety of opinions and backgrounds will only serve to enrich our community. In particular, discussions relating to pros/cons of various technologies, programming languages, and so on are welcome, but these should be done with respect, taking proactive measure to ensure that all participants are heard and feel confident that they can freely express their opinions.
-    We pledge to welcome questions and answer them respectfully, paying particular attention to those new to the community. We pledge to provide respectful criticisms and feedback in forums, especially in discussion threads resulting from code contributions.
-    We pledge to be conscientious of the perceptions of the wider community and to respond to criticism respectfully. We will strive to model behaviors that encourage productive debate and disagreement, both within our community and where we are criticized. We will treat those outside our community with the same respect as people within our community.
-    We pledge to help the entire community follow the code of conduct, and to
     not remain silent when we see violations of the code of conduct.
     We will take action when members of our community violate this code
     such as contacting confidential.pypeit@ucolick.org (all emails sent to this address
     will be treated with the strictest confidence)
     or talking privately with the person.

This code of conduct applies to all PypeIt community situations online and offline, including
mailing lists, forums, social media, conferences, meetings, associated social events,
and one-to-one interactions.
By using this software, we politely request that you abide by our code of conduct.

Any related activity or project organized by members of the PypeIt
community, including affiliated packages, are welcome to have their own codes
of conduct, but agree to also abide by the present code of conduct.

Parts of this code of conduct have been adapted from
the `PSF code of conduct <https://www.python.org/psf/conduct/>`_.
====================
Collating 1D Spectra
====================

Overview
========
``PypeIt`` provides a tool called ``pypeit_collate_1d`` to go through a large number 
of processed :ref:`out_spec1D:Spec1D Output` files, group the spectra by object, and 
coadd all matching spectra. It also creates metadata files about its input files and
coadded output files, and can create archive directories suitable for ingest into 
KOA.

Fluxing is planned to be added in a future release. 

Usage
=====
All collate options are accessible via either the command line or a .collate1d file.
Additional coadd 1D configuration can also be passed in via configuration files.

An example run of ``pypeit_collate_1d`` requires a tolerance and a list
of spec1d files::

   pypeit_collate_1d --tolerance 3 --spec1d_files Science/spec1d*.fits

``pypeit_collate_1d`` can also be run in dry run mode to try out different 
threshold values without doing any processing on the input::

      $ pypeit_collate_1d --tolerance 3 --spec1d_files Science/spec1d*

      Writing the parameters to collate1d.par
      UserWarning: Selected configuration file already exists and will be overwritten! (parset.py:649)
      [INFO]    :: Creating J132402.48+271212.38_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.20629-S13A-SDF-z6clus_DEIMOS_2013Apr09T054342.730.fits: SPAT0287-SLIT0284-DET01 (sbzk_1440)
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT0286-SLIT0284-DET01 (sbzk_1440)
      [INFO]    :: Creating J132401.95+271237.80_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.20629-S13A-SDF-z6clus_DEIMOS_2013Apr09T054342.730.fits: SPAT0363-SLIT0359-DET01 (sbzk_1796)
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT0360-SLIT0359-DET01 (sbzk_1796)
      [INFO]    :: Creating J132401.46+271303.86_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.20629-S13A-SDF-z6clus_DEIMOS_2013Apr09T054342.730.fits: SPAT0438-SLIT0433-DET01 (NB711_007606)
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT0438-SLIT0433-DET01 (NB711_007606)
      [INFO]    :: Creating J132401.22+271321.92_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.20629-S13A-SDF-z6clus_DEIMOS_2013Apr09T054342.730.fits: SPAT0503-SLIT0500-DET01 (NB921_024976)
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT0497-SLIT0494-DET05 (NB921_024976)
      [INFO]    :: Creating J132405.90+271402.23_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.20629-S13A-SDF-z6clus_DEIMOS_2013Apr09T054342.730.fits: SPAT1137-SLIT1134-DET01 (NB973_031779)
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT1136-SLIT1134-DET01 (NB973_031779)
      [INFO]    :: Creating J132407.49+271432.92_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.20629-S13A-SDF-z6clus_DEIMOS_2013Apr09T054342.730.fits: SPAT1434-SLIT1433-DET01 (photz_3929)
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT1434-SLIT1433-DET01 (photz_3929)
      [INFO]    :: Creating J132401.27+271430.39_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.20629-S13A-SDF-z6clus_DEIMOS_2013Apr09T054342.730.fits: SPAT0847-SLIT0838-DET05 (NB921_032374)
      [INFO]    :: Creating J132412.25+271322.19_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.20629-S13A-SDF-z6clus_DEIMOS_2013Apr09T054342.730.fits: SPAT1510-SLIT1544-DET05 (photz_2590)
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT1510-SLIT1544-DET05 (photz_2590)
      [INFO]    :: Creating J132401.80+271145.36_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT0079-SLIT0092-DET01 (photz_835)
      [INFO]    :: Creating J132404.67+271226.61_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT0561-SLIT0569-DET01 (photz_1674)
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT0558-SLIT0564-DET05 (photz_1674)
      [INFO]    :: Creating J132406.95+271357.19_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT1211-SLIT1207-DET01 (NB973_031059)
      [INFO]    :: Creating J132407.01+271649.64_DEIMOS_20130409.fits from the following sources:
      [INFO]    ::     Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_2013Apr09T061459.683.fits: SPAT2038-SLIT1998-DET05 (SERENDIP)
      [INFO]    :: Total duration: 0:00:03.043560
      
Command Line
------------

.. include:: help/pypeit_collate_1d.rst


``.collate1D`` Configuration File
---------------------------------
The cofiguration file for pypeit_collate_1d consists of a set of :ref:`pypeit_par:Collate1DPar Keywords`, 
followed by a list of spec1d files. An example configuration file is shown below::

    # User-defined coadding parameters
    [coadd1d]
    sn_clip = 20

    # User-defined collating parameters
    [collate1d]

    # Whether to match using ra/dec sky coordinates or via spatial pixel coordinates on the exposure.
    match_using ra/dec

    # How close two spectra must be in order to be considered the same object.
    # This can be specified in a variety of formats.

    # For ra/dec matching, this is an angular distance. For pixel matching it's an 
    # integer or floating point number.
    # For example:
    #     3.5      Arcseconds (the default unit)
    #     2m       Arcminutes
    #     0.0003d  Decimal degrees
    #     0d3m4.3s Degrees, arcminutes, arcseconds
    #     1h2m3s   Hours, minutes, seconds
    #     300      Pixel distance
    #     
    tolerance = 3.5

    # What slit bitmask flags to exclude from the matching.
    # If this list is not empty, each spec1d file to be coadded 
    # must have a matching spec2d file.

    slit_exclude_flags = BOXSLIT

    # Where to place coadded files and report files. Defaults to
    # current directory.
    #outdir = /work/output

    # Where to copy the input and output files, along with metadata
    # for archiving in KOA
    #archive_root = /work/archive

    # Where to look for .pypeit files when building an archive.
    # This only takes effect when archive_root is specified. If
    # not given the archiving code will look in the parent directory
    # of each spec1d.
    #pypeit_file = /work/pypeit_files

    
    # A list of the spec1d files. Wildcards are allowed.
    spec1d read
    Science/spec1d*.fits
    spec1d end

Coadd1D Configuration
--------------------- 
Coadd1d configuration can be configured in the ``.collate1d`` as shown above, or
in a separate ``.coadd1d`` file with the same base name as the ``.collate1d`` file.
:ref:`pypeit_par:Coadd1DPar Keywords`, 

Reporting
---------
``pypeit_collate_1d`` creates two files to report on the results of collating: ``collate_report.dat`` and
``collate_warnings.txt``.  

collate_report.dat
++++++++++++++++++
The ``collate_report.dat`` is an `IPAC <https://irsa.ipac.caltech.edu/applications/DDGEN/Doc/ipac_tbl.html>`_ file containing
metadata about what objects were coadded. The file is organized by the output file name, and has multiple rows per output 
file: one row per extracted spectra that was coadded to create the file. Below is a description of its columns.


+-----------------+-----------------------------------------------------------+
| Column Name     | Description                                               |
+=================+===========================================================+
| filename        | The filename of the coadded output file.                  |
+-----------------+-----------------------------------------------------------+
| maskdef_objname | The name of the object being coadded.                     |
+-----------------+-----------------------------------------------------------+
| maskdef_id      | The slit id for the according to the mask definition.     |
+-----------------+-----------------------------------------------------------+
| det             | The detector the spectrum was captured on.                |
+-----------------+-----------------------------------------------------------+
| objra           | The RA of the source object, determined from the mask     |
|                 | definition.                                               |
+-----------------+-----------------------------------------------------------+
| objdec          | The DEC of the source object, determined from the mask    |
|                 | definition.                                               |
+-----------------+-----------------------------------------------------------+
| med_s2n         | The signal to noise ratio of the extracted object.        |
+-----------------+-----------------------------------------------------------+
| wav_rms         | The RMS in pixels of the wavelength solution.             |
+-----------------+-----------------------------------------------------------+
| spec1d_filename | The name of the spec1d file containing the spectrum.      |
+-----------------+-----------------------------------------------------------+
| dispname        | The grating used for the source image.                    |
+-----------------+-----------------------------------------------------------+
| slmsknam        | The slitmask used for the source image.                   |
+-----------------+-----------------------------------------------------------+
| binning         | Binning from the source image header.                     |
+-----------------+-----------------------------------------------------------+
| mjd             | Modified Julian Date from the the source image header.    |
+-----------------+-----------------------------------------------------------+
| airmass         | Airmass from the the source image header.                 |
+-----------------+-----------------------------------------------------------+
| exptime         | Exposure time from the the source image header.           | 
+-----------------+-----------------------------------------------------------+
| guidfwhm        | Guide star FWHM value from the source image header.       |
+-----------------+-----------------------------------------------------------+
| progpi          | Program Principle Investigator from the source image      |
|                 | header.                                                   |
+-----------------+-----------------------------------------------------------+
| semester        | Semester from the source image header.                    |
+-----------------+-----------------------------------------------------------+
| progid          | Program ID from the source image header.                  |
+-----------------+-----------------------------------------------------------+

collate_warnings.txt
++++++++++++++++++++
The ``collate_warnings.txt`` file contains information about any failures that occurred during 
collating and/or archiving. Below is an example ``collate_warnings.txt``::

   pypeit_collate_1d warnings

   Started 2021-07-26 12:02:39.156118
   Duration: 0:00:47.245288

   Excluded Objects:

   Excluding SERENDIP object from SPAT1510-SLIT1544-DET05 in Science/spec1d_DE.20130409.20629-S13A-SDF-z6clus_DEIMOS_20130409T054342.730.fits
   Excluding SERENDIP object from SPAT0071-SLIT0086-DET05 in Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_20130409T061459.683.fits


   Failed to Coadd:


   Missing Archive Files:

   Could not archive matching text file for Science/spec1d_DE.20130409.20629-S13A-SDF-z6clus_DEIMOS_20130409T054342.730.fits, file not found.
   Could not archive matching text file for Science/spec1d_DE.20130409.22509-S13A-SDF-z6clus_DEIMOS_20130409T061459.683.fits, file not found.

Matching
========
To decide if two spectra match ``pypeit_collate_1d`` performs the following checks.

1. The slit_exclude_flags are checked against the slit the spectrum was found in. 
   If a match is found the spectrum is skipped and not coadded. 

2. The two spectra are compared to make sure they are from the same spectrograph, in
   the same configuration.

3. The position of the two spectra are compared to see that they are within a given
   tolerance of each other.

If a spectrum does not match any others, it is still output using the :ref:`coadd1d:Current Coadd1D Data Model`.

Step 1: Exclude by Slit Bitmask
-------------------------------
``PypeIt`` assigns a bitmask to each slit in a slit mask. Spectra from slits of certain
types can be excluded from coadding. If this feature is used, there must be a  
:ref:`out_spec2D:Spec2D Output` file corresponding for each ``spec1d`` file. The bitmask values:

  +-------------+--------------------------------------------------------------------------+ 
  |SHORTSLIT    |Slit formed by left and right edge is too short. Not ignored for flexure. |
  +-------------+--------------------------------------------------------------------------+ 
  |BOXSLIT      |Slit formed by left and right edge is valid (large enough to be a valid   |
  |             |slit), but too short to be a science slit.                                |
  +-------------+--------------------------------------------------------------------------+ 
  |USERIGNORE   |User has specified to ignore this slit. Not ignored for flexure.          |
  +-------------+--------------------------------------------------------------------------+ 
  |BADWVCALIB   |Wavelength calibration failed for this slit.                              |
  +-------------+--------------------------------------------------------------------------+ 
  |BADTILTCALIB |Tilts analysis failed for this slit.                                      |
  +-------------+--------------------------------------------------------------------------+ 
  |SKIPFLATCALIB|Flat field generation failed for this slit. Skip flat fielding.           |
  +-------------+--------------------------------------------------------------------------+ 
  |BADFLATCALIB |Flat field generation failed for this slit. Ignore it fully.              |
  +-------------+--------------------------------------------------------------------------+ 
  |BADREDUCE    |Skysub/extraction failed for this slit.                                   |
  +-------------+--------------------------------------------------------------------------+ 

Step 2: Match by Spectrograph Configuration
-------------------------------------------
There are a set of configuration keys that define a unique configuration for each 
spectrograph ``PypeIt`` supports. For example, for DEIMOS the keys are ``DISPNAME``, ``DECKER``, ``BINNING``, 
``DISPANGLE``, and ``AMP``. ``pypeit_collate_1d`` will only match spectra if the values
for their configuration keys, except for ``DECKER``, are the same. The ``DECKER`` 
keyword is *not* checked so that spectra from the same object through different
slit masks can be coadded.

Step 3: Match by Position
--------------------------

RA/DEC
++++++
If RA/DEC matching is being used, the tolerance is specified as an angular distance.
By default, it is treated as arcseconds, but any format supported by astropy `Angles <https://docs.astropy.org/en/stable/coordinates/angles.html>`_ 
can be used. The matching is done using the `Astropy SkyCoord separation method <https://docs.astropy.org/en/stable/api/astropy.coordinates.SkyCoord.html#astropy.coordinates.SkyCoord.separation>`_.

Currently only ``DEIMOS`` and ``MOSFIRE`` supports RA/DEC matching.

Pixel
+++++
If pixel matching is being used, the tolerance can be specified as an integer 
or floating point number.  The matching is done as the distance along the 
spatial axis of the exposure.

Archiving
=========
``pypeit_collate_1d`` can copy all of the input files it uses and all of the files
it creates into an archive directory suitable to be compressed and sent to KOA for
ingest.  Reduced data and associated files are stored in subdirectories based semester 
and program ID in data's header.  Additional metadata information is stored in
the top level of the directory.


Archived Files
--------------

spec1d
++++++
FITS files beginning with the prefix ``spec1d`` contain calibrated 1d spectra extracted from the science data. 
See https://pypeit.readthedocs.io/en/latest/out_spec1D.html for a detailed description of these files.


spec1d text files
+++++++++++++++++
Text files with extraction information about each spec1d file are also copied to the archive directory. 
More information about these files can be found at https://pypeit.readthedocs.io/en/latest/out_spec1D.html#extraction-information.


spec2d
++++++
FITS files with the ``spec2d`` prefix contain a 2d spectral image created by ``PypeIt`` during data reduction.
They are described in detail at https://pypeit.readthedocs.io/en/latest/out_spec2D.html.

coadd output files
++++++++++++++++++
FITS files that begin with a sky coordinate prefix are coadded spectra from multiple exposures of a single object.
They are described in detail at https://pypeit.readthedocs.io/en/latest/coadd1d.html#current-coadd1d-data-model.

pypeit files
++++++++++++
Files ending in ".pypeit" are the original ``PypeIt`` reduction files that were used to reduce the raw data.
By default ``pypeit_collate_1d`` searches for .pypeit files in the parent directory of each spec1d file.
``PypeIt`` files are described at https://pypeit.readthedocs.io/en/latest/pypeit_file.html.

Archive Metadata
----------------
``pypeit_collate_1d`` writes out two metadata files named ``reduced_files.dat`` and 
``coadded_files_meta.dat``. These files are written in the `IPAC <https://irsa.ipac.caltech.edu/applications/DDGEN/Doc/ipac_tbl.html>`_
format. 

``reduced_files.dat``
+++++++++++++++++++++
The ``reduced_files.dat`` file contains metadata from any spec1d or spec2d files in the archive.  This file is 
organized by KOAID. Below is the description of some of the columns in the ``reduced_files.dat`` file. All filenames
are relative to the top level of the archive directory.

+---------------+-------------------------------------------------------------+
| Column Name   | Description                                                 |
+===============+=============================================================+
| koaid         | The KOAID of the source image that was reduced to create the|
|               | reduced files.                                              |
+---------------+-------------------------------------------------------------+
| spec1d_file   | The filename of the spec1d file.                            |
+---------------+-------------------------------------------------------------+
| spec1d_info   | The filename of the extraction info text file associated    |
|               | with a spec1d file.                                         |
+---------------+-------------------------------------------------------------+
| spec2d_file   | The filename of the spec2d file.                            |
+---------------+-------------------------------------------------------------+
| pypeit_file   | The ``PypeIt`` reduction file used to reduce the file.      |
+---------------+-------------------------------------------------------------+
| ra            | RA from the source image header.                            |
+---------------+-------------------------------------------------------------+
| dec           | DEC from the source image header.                           |
+---------------+-------------------------------------------------------------+
| target        | TARGET from the source image header.                        |
+---------------+-------------------------------------------------------------+
| progpi        | Program Principle Investigator from the source image header.|
+---------------+-------------------------------------------------------------+
| semester      | Semester from the source image header.                      |
+---------------+-------------------------------------------------------------+
| progid        | Program ID from the source image header.                    |
+---------------+-------------------------------------------------------------+
| dispname      | The grating used for the source image.                      |
+---------------+-------------------------------------------------------------+
| slmsknam      | The slit mask used for the source image.                    | 
+---------------+-------------------------------------------------------------+
| binning       | Binning from the source image header.                       |
+---------------+-------------------------------------------------------------+
| mjd           | Modified Julian Date from the the source image header.      |
+---------------+-------------------------------------------------------------+
| airmass       | Airmass from the the source image header.                   | 
+---------------+-------------------------------------------------------------+
| exptime       | Exposure time from the the source image header.             |
+---------------+-------------------------------------------------------------+

``coadded_files.dat``
+++++++++++++++++++++
The ``coadded_files.dat`` file contains metadata about the coadded output files.
The file is organized by the output file name, and has multiple rows per output 
file: one row per extracted spectra that was coadded to create the file. Below 
is the description of the columns in the ``coadded_files.dat`` file. All filenames
are relative to the top level of the archive directory.

+-----------------+-----------------------------------------------------------+
| Column Name     | Description                                               |
+=================+===========================================================+
| filename        | The filename of the coadded output file.                  |
+-----------------+-----------------------------------------------------------+
| maskdef_objname | The name of the object being coadded.                     |
+-----------------+-----------------------------------------------------------+
| maskdef_id      | The slit id for the according to the mask definition.     |
+-----------------+-----------------------------------------------------------+
| det             | The detector the spectrum was captured on.                |
+-----------------+-----------------------------------------------------------+
| objra           | The RA of the source object, determined from the mask     |
|                 | definition.                                               |
+-----------------+-----------------------------------------------------------+
| objdec          | The DEC of the source object, determined from the mask    |
|                 | definition.                                               |
+-----------------+-----------------------------------------------------------+
| med_s2n         | The signal to noise ratio of the extracted object.        |
+-----------------+-----------------------------------------------------------+
| wav_rms         | The RMS in pixels of the wavelength solution.             |
+-----------------+-----------------------------------------------------------+
| source_id       | The KOAID of the original source image.                   |
+-----------------+-----------------------------------------------------------+
| spec1d_filename | The name of the spec1d file containing the spectrum.      |
+-----------------+-----------------------------------------------------------+
| dispname        | The grating used for the source image.                    |
+-----------------+-----------------------------------------------------------+
| slmsknam        | The slitmask used for the source image.                   |
+-----------------+-----------------------------------------------------------+
| binning         | Binning from the source image header.                     |
+-----------------+-----------------------------------------------------------+
| mjd             | Modified Julian Date from the the source image header.    |
+-----------------+-----------------------------------------------------------+
| airmass         | Airmass from the the source image header.                 |
+-----------------+-----------------------------------------------------------+
| exptime         | Exposure time from the the source image header.           | 
+-----------------+-----------------------------------------------------------+
| guidfwhm        | Guide star FWHM value from the source image header.       |
+-----------------+-----------------------------------------------------------+
| progpi          | Program Principle Investigator from the source image      |
|                 | header.                                                   |
+-----------------+-----------------------------------------------------------+
| semester        | Semester from the source image header.                    |
+-----------------+-----------------------------------------------------------+
| progid          | Program ID from the source image header.                  |
+-----------------+-----------------------------------------------------------+

.. _outputs:

=======
Outputs
=======

``PypeIt``, despite a pipeline for data *reduction*, is capable of generating an
inordinate amount of data products.  These pages document the various data
products and the means to control the output.  A full description of the naming
system is described :doc:`here </naming>`.

Contents
========

.. toctree:: 
   :maxdepth: 1 

   Naming <naming>
   master_bias
   master_dark
   master_align
   master_arc
   master_tilt
   master_edges
   master_slits
   master_wvcalib
   master_tilts
   master_flat
   out_spec1D
   out_spec2D
   out_masks
   detectors
   history

.. _standard-products:

Standard Products
=================

There are four standard types of output products generated by ``PypeIt``.  These
separate calibrations from spectra and QA plots.  Each type is designated by a
unique prefix in the filename:

===========  ===========  ===========
Output Type  Prefix       Description
===========  ===========  ===========
1D Spectra   spec1d-      1D arrays and meta data associated with extracted
                          1D spectra
Object info  objinfo-     ASCII table listing several object attributes
2D Spectra   spec2d-      2D arrays related to sources (e.g. sky-subtracted image)
Calibration  Master       Calibration images, fits, meta files, etc.
Reduction    N/A          Files that guide or describe the reduction
QA           variable     Quality assurance figures
===========  ===========  ===========

Follow the links in `Contents`_ for further details.

===========
MasterAlign
===========

Overview
========

This file describes the data model for the `MasterAlign`_ image.
It is generally a simple combination of all input alignment frames,
which are used to trace constant spatial position on a slit. These
frames are useful in slit-based IFUs (e.g. `cbar` frames for KCWI).

The image is written to disk as a multi-extension FITS file
prefixed by ``MasterAlignment`` in the Masters/ folder.
See :ref:`masters:Masters Naming` for the naming convention.


Inspecting
==========

The first extension is the combined image.
You can view it with any standard image viewer, e.g.::

    ginga Masters/MasterAlignment_A_1_01.fits

The image will also be a trimmed portion of the
raw image and also re-oriented
so that vertical is the spectral dimension with blue at the bottom.

Here is an screen shot of a `ginga` view for an example from
the `keck_kcwi` spectrograph.

.. image:: figures/align_image.png

The alignment traces are color-coded by the slit number (i.e. the
color alternates between orange and purple for each slit). In the
example above, each slit contains five contbars which are used for
the spatial alignment.

Trouble Shooting
================

If your image appears to be in err, here are the things to consider:

 - Is one or more of your input alignment frames junk?
 - Check each of your input alignment frames. Some might be mislabeled.
 - If some alignments are apparently missing, you might want to check
   that the slits are currently traced.

Current Alignments Data Model
=============================

Internally, the master image is held in
:class:`pypeit.images.buildimage.AlignImage`
which is a :class:`pypeit.images.pypeitimage.PypeItImage` and
:class:`pypeit.datamodel.DataContainer`.

The datamodel written to disk is:

.. include:: include/datamodel_alignments.rst

**************
PypeIt scripts
**************

``PypeIt`` is packaged with several scripts that should have been installed
directly into your path (e.g. ``~/anaconda/bin``).

**If you are developing a new script, see** :ref:`new_script`.

Installation Scripts
++++++++++++++++++++

pypeit_install_telluric
=======================

After downloading the atmospheric model grids for use in fitting telluric
absorption, this script "installs" the files by creating symlinks to them within
the ``PypeIt`` code base.  See :ref:`data_installation`.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_install_telluric.rst

pypeit_install_ql_masters
=========================

After downloading the ``QL_MASTERS`` directory for use with the quick-look
scripts, this script "installs" the files by creating a symlink to it within the
``PypeIt`` code base.  See :ref:`data_installation`.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_install_ql_masters.rst


Pipeline Scripts
++++++++++++++++

.. _pypeit-chk-for-calibs:

pypeit_chk_for_calibs
=====================

This script, which is similar to :ref:`pypeit-setup`, examines a set
of files for an input spectrograph and scans for the standard calibrations.
It raises warnings when these are not found.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_chk_for_calibs.rst

And a typical call::

    pypeit_chk_calibs /PypeIt-development-suite/RAW_DATA/not_alfosc/grism4/ALDc2 -s not_alfosc

After a running stream of detailed notes, it prints a table of results
to the screen::

    setups pass     scifiles
    ------ -------- ---------------
         A False ALDc200205.fits
      None True


.. _pypeit-parse-calib-id:

pypeit_parse_calib_id
=====================

The ``pypeit_parse_calib_id`` script prints a simple summary to the screen
of the calibration frames.  This enables you (hopefully) to parse the 
rather obscure PypeIt naming.  Here is a typical call::

    pypeit_parse_calib_id vlt_xshooter_vis_1x1.pypeit

And the associated output::

    {
        "1": {
            "A_1_01": {
                "arc": {
                    "master_key": "A_1_01",
                    "master_name": "MasterArc_A_1_01.fits",
                    "raw_files": [
                        "XSHOO.2010-04-28T14:36:27.000.fits.gz"
                    ]
                },
                "bias": {
                    "master_key": "A_1_01",
                    "master_name": "MasterBias_A_1_01.fits",
                    "raw_files": [
                        "XSHOO.2010-04-28T10:23:42.901.fits.gz",
                        "XSHOO.2010-04-28T10:26:26.465.fits.gz",
                        "XSHOO.2010-04-28T10:29:10.029.fits.gz"
                    ]
                },
                "tilt": {
                    "master_key": "A_1_01",
                    "master_name": "MasterTiltimg_A_1_01.fits",
                    "raw_files": [
                        "XSHOO.2010-04-28T14:36:27.000.fits.gz"
                    ]
                }
            }
        }
    }

Here, the first level is the calib_grp (1), the next level gives
the Master key (A_1_01) and then there is a listing of the files
contributing to each of the :ref:`masters`.  See those docs for more.

.. _pypeit-obslog:

pypeit_obslog
=============

The ``pypeit_obslog`` script allows you to see a simple listing of the data
files in a given directory (or directories) and the metadata that ``PypeIt``
will pull from their headers.  See :ref:`pypeit_obslog` for details.


.. _pypeit-setup:

pypeit_setup
============

This setups files for data reduction.  See :doc:`setup` for details

run_pypeit
==========

This is the main executable for PypeIt.  See :doc:`running` for details.

pypeit_view_fits
================

This is a wrapper to the Ginga image viewer.  It is a bit of a kludge
in that it writes a dummy tmp.fits file to the harddrive and sends
that into Ginga.  The dummy file is deleted afterwards.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_view_fits.rst


Data Processing Scripts
+++++++++++++++++++++++

pypeit_coadd_1dspec
===================

See :doc:`coadd1d` for further details.

pypeit_collate_1d
=================

This is a tool to help organize spectra in multiple spec1d files, group them
by source, and flux/coadd them.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_collate_1d.rst

Calibration Scripts
+++++++++++++++++++

pypeit_chk_edges
================

Inspect the slit/order edges identified by PypeIt in a RC Ginga
window.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_chk_edges.rst


pypeit_chk_flats
================

Inspect the flat field images produced by PypeIt in a RC Ginga
window.  This includes the stacked 'raw' image, the pixel flat,
the illumination flat, and the flat model.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_chk_flats.rst

.. _pypeit_chk_2dslits:

pypeit_chk_wavecalib
====================

See :ref:`pypeit-chk-wavecalib` for details.

pypeit_chk_2dslits
==================

This script prints a simple summary of the state of the reduction
for all of the slits in a given :doc:`out_spec2D` file.  
Here is a standard call::

    pypeit_chk_2dslits spec2d_d0315_45929-agsmsk_DEIMOS_2018Mar15T124523.587.fits 

And the output to screen will look like:

.. code-block:: bash

    ================ DET 04 ======================
    SpatID  MaskID  Flags
    0021    958445    None
    0073    958470    None
    0143    958434    None
    0212    958458    None
    0278    958410    None
    0479    958400    None
    1257    958466    None
    1352    958392    BOXSLIT
    1413    958396    None
    1492    958403    None
    1568    958457    None
    1640    958405    None
    1725    958435    None
    1818    958422    None
    1880    958390    BOXSLIT
    1984    958393    BOXSLIT

The MaskID will be populated only if the instrument includes
mask design (e.g. Keck/DEIMOS).  The Flags column describes
failure modes or reasons why the slit was not reduced.
*None* is the preferred state for a science slit.


pypeit_flux_setup
=================

This sets up files for fluxing, coadding and telluric corrections.
Note the pypeit files generated by this scripts need your changes:

    - Give sensfunc file name in the fluxing pypeit file
    - Give sensfunc file name in the coadding pypeit file
    - The coadding pypeit file includes all objects extracted from
      your main reduction, so you need to pick up the one you are
      interested in and remove all others in the coadding pypeit file
      (between coadd1d read and coadd1d end)

See :doc:`fluxing`, :doc:`coadd1d`, and :doc:`telluric` for details.

The script usage can be displayed by calling the script with the
``-h`` option:

.. include:: help/pypeit_flux_setup.rst


Version 1.1.0

================  =================  ==========  =======================================
HDU Name          Obj Type           Array Type  Description           
================  =================  ==========  =======================================
``ALIGNFRAME``    ndarray            floating    Main data image
``TRACES``        ndarray            floating    traces with shape [nspec,nalign,nslits]
``SPAT_ID``       ndarray            integer     Slit spatial ID
================  =================  ==========  =======================================

Version 1.0.0

===============  =========  ==========  ============================================================
HDU Name         Obj Type   Array Type  Description                                                 
===============  =========  ==========  ============================================================
``PYP_SPEC``     str                    PypeIt spectrograph name                                    
``ARC_SPECTRA``  ndarray    floating    2D array: 1D extracted spectra, slit by slit (nspec, nslits)
``LAMPS``        str                    List of arc lamps used for the wavelength calibration       
``NSLITS``       int                    Total number of slits.  This can include masked slits       
``SPAT_IDS``     ndarray    integer     Slit spat_ids. Named distinctly from that in WaveFit        
``STRPAR``       str                    Parameters as a string                                      
``WV_FIT2D``     PypeItFit              2D wavelength solution (echelle)                            
``WV_FITS``      ndarray    WaveFit     WaveFit to each 1D wavelength solution                      
===============  =========  ==========  ============================================================
=======================  =======================================================================================================================================================================================================================================================================
Python Version           ``>=3.7``                                                                                                                                                                                                                                                              
Required for users       ``IPython>=7.2.0``, ``PyYAML>=5.1``, ``astropy>=4.0``, ``bottleneck``, ``configobj>=5.0.6``, ``extension-helpers>=0.1``, ``ginga>=3.0``, ``linetools``, ``matplotlib>=3.1``, ``numpy>=1.18``, ``packaging>=0.19``, ``qtpy>=1.9``, ``scikit-learn>=0.2``, ``scipy>=1.4``
Required for developers  ``codecov``, ``coverage``, ``pyqt5``, ``pytest-astropy``, ``pytest-cov``, ``pytest>=6.0.0``, ``shapely>=1.7``, ``sphinx``, ``sphinx-automodapi``, ``sphinx_rtd_theme``, ``tox``                                                                                        
=======================  =======================================================================================================================================================================================================================================================================
.. code-block:: console

    # Auto-generated PypeIt file
    # 2021-11-19
    
    # User-defined execution parameters
    [rdx]
    spectrograph = shane_kast_blue
    
    # Setup
    setup read
        Setup A:
            dispname: 600/4310
            dichroic: d55
    setup end
    
    # Read in the data
    data read
     path /Users/westfall/Work/packages/PypeIt-development-suite/RAW_DATA/shane_kast_blue/600_4310_d55
    |    filename |                 frametype |                 ra |                dec |     target | dispname |     decker | binning |                mjd |        airmass | exptime | dichroic |
    |  b1.fits.gz |                  arc,tilt | 140.44166666666663 |  37.43222222222222 |       Arcs | 600/4310 | 0.5 arcsec |     1,1 |  57162.06664467593 |            1.0 |    30.0 |      d55 |
    | b14.fits.gz |                      bias | 172.34291666666664 |  36.86833333333333 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15420034722 |            1.0 |     0.0 |      d55 |
    | b15.fits.gz |                      bias | 172.41833333333332 |  36.94444444444444 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15440162037 |            1.0 |     0.0 |      d55 |
    | b16.fits.gz |                      bias | 172.49124999999995 |  36.97833333333333 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |    57162.154603125 |            1.0 |     0.0 |      d55 |
    | b17.fits.gz |                      bias |  172.5645833333333 |  37.04694444444444 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15480474537 |            1.0 |     0.0 |      d55 |
    | b18.fits.gz |                      bias | 172.63708333333332 |  37.11555555555556 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15500949074 |            1.0 |     0.0 |      d55 |
    | b19.fits.gz |                      bias | 172.71166666666664 |  37.18611111111111 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15521145833 |            1.0 |     0.0 |      d55 |
    | b20.fits.gz |                      bias | 172.78416666666666 | 37.254444444444445 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15541377315 |            1.0 |     0.0 |      d55 |
    | b21.fits.gz |                      bias | 172.85708333333332 |  37.32361111111111 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15561504629 |            1.0 |     0.0 |      d55 |
    | b22.fits.gz |                      bias |             172.93 |            37.3925 |       Bias | 600/4310 | 2.0 arcsec |     1,1 |  57162.15581597222 |            1.0 |     0.0 |      d55 |
    | b23.fits.gz |                      bias | 173.00166666666667 |            37.4225 |       Bias | 600/4310 | 2.0 arcsec |     1,1 | 57162.156018981485 |            1.0 |     0.0 |      d55 |
    | b10.fits.gz | pixelflat,illumflat,trace | 144.82041666666666 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07859895833 |            1.0 |    15.0 |      d55 |
    | b11.fits.gz | pixelflat,illumflat,trace |            144.955 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07897476852 |            1.0 |    15.0 |      d55 |
    | b12.fits.gz | pixelflat,illumflat,trace |  145.0908333333333 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.079351388886 |            1.0 |    15.0 |      d55 |
    | b13.fits.gz | pixelflat,illumflat,trace | 145.22791666666666 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.079728240744 |            1.0 |    15.0 |      d55 |
    |  b2.fits.gz | pixelflat,illumflat,trace | 143.36208333333335 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07473645834 |            1.0 |    30.0 |      d55 |
    |  b3.fits.gz | pixelflat,illumflat,trace | 143.86791666666667 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07596400463 |            1.0 |    15.0 |      d55 |
    |  b4.fits.gz | pixelflat,illumflat,trace | 144.00458333333333 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.076341782406 |            1.0 |    15.0 |      d55 |
    |  b5.fits.gz | pixelflat,illumflat,trace | 144.14041666666665 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07671956019 |            1.0 |    15.0 |      d55 |
    |  b6.fits.gz | pixelflat,illumflat,trace | 144.27708333333334 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.077096064815 |            1.0 |    15.0 |      d55 |
    |  b7.fits.gz | pixelflat,illumflat,trace | 144.41291666666666 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 |  57162.07747175926 |            1.0 |    15.0 |      d55 |
    |  b8.fits.gz | pixelflat,illumflat,trace | 144.54874999999996 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.077847569446 |            1.0 |    15.0 |      d55 |
    |  b9.fits.gz | pixelflat,illumflat,trace |  144.6845833333333 |  37.43222222222222 |  Dome Flat | 600/4310 | 2.0 arcsec |     1,1 | 57162.078222916665 |            1.0 |    15.0 |      d55 |
    | b27.fits.gz |                   science | 184.40291666666664 |  39.01111111111111 | J1217p3905 | 600/4310 | 2.0 arcsec |     1,1 |  57162.20663842592 |            1.0 |  1200.0 |      d55 |
    | b28.fits.gz |                   science | 184.40416666666664 |  39.01111111111111 | J1217p3905 | 600/4310 | 2.0 arcsec |     1,1 |  57162.22085034722 |            1.0 |  1200.0 |      d55 |
    | b24.fits.gz |                  standard | 189.47833333333332 |  24.99638888888889 |   Feige 66 | 600/4310 | 2.0 arcsec |     1,1 |  57162.17554351852 | 1.039999961853 |    30.0 |      d55 |
    data end
    



Version 1.1.0

=================  =================  ==========  ======================
HDU Name           Obj Type           Array Type  Description           
=================  =================  ==========  ======================
``DARK_IMAGE``     ndarray            floating    Primary image data    
``DARK_IVAR``      ndarray            floating    Inverse variance image
``DARK_DETECTOR``  DetectorContainer              Detector DataContainer
=================  =================  ==========  ======================

Version 1.1.0

================  =================  ==========  ======================
HDU Name          Obj Type           Array Type  Description           
================  =================  ==========  ======================
``ARC_IMAGE``     ndarray            floating    Primary image data    
``ARC_FULLMASK``  ndarray            integer     Full image bitmask    
``ARC_DETECTOR``  DetectorContainer              Detector DataContainer
================  =================  ==========  ======================
Version: 1.1.4

=====================  =================  ==========  ===========================================================================================================================
Obj Key                Obj Type           Array Type  Description                                                                                                                                                                         
=====================  =================  ==========  ===========================================================================================================================
``spat_id``            ndarray            int         Slit ID number from SPAT measured at half way point.
``maskdef_id``         ndarray            int         Slit ID number from slitmask design (implemented only for :doc:`deimos` and :doc:`mosfire`).
``left_init``          ndarray            float       Spatial coordinates (pixel indices) of all left edges, one per slit.
``right_init``         ndarray            float       Spatial coordinates (pixel indices) of all right edges, one per slit.
``left_tweak``         ndarray            float       Spatial coordinates (pixel indices) of all left edges, one per slit.  These traces have been adjusted by the flat-field.
``right_tweak``        ndarray            float       Spatial coordinates (pixel indices) of all right edges, one per slit.  These traces have been adjusted by the flat-field.
``center``             ndarray            float       Spatial coordinates of the slit centers from ``left_init`` and ``right_init``.
``mask_init``          ndarray            int         Bit mask for slits at instantiation. Used to reset.
``mask``               ndarray            int         Bit mask for slits (fully good slits have 0 value).
``specmin``            ndarray            float       Minimum spectral position allowed for each slit/order.
``specmax``            ndarray            float       Maximum spectral position allowed for each slit/order.
=====================  =================  ==========  ===========================================================================================================================

Additional `astropy.io.fits.BinTableHDU`_ for :doc:`deimos` and :doc:`mosfire` reduction.

=====================  =================  ==========  =================================================================================
Obj Key                Obj Type           Array Type  Description
=====================  =================  ==========  =================================================================================
``TRACEID``            ndarray            int         Trace ID Number.
``TRACESROW``          ndarray            int         Spectral row for provided left and right edges.
``TRACELPIX``          ndarray            float       Spatial pixel coordinate for left edge.
``TRACERPIX``          ndarray            float       Spatial pixel coordinate for right edge.
``SPAT_ID``            ndarray            int         Slit ID number from SPAT measured at half way point.
``SLITID``             ndarray            int         Slit ID Number (``maskdef_id``).
``SLITLOPT``           ndarray            float       Left edge of the slit in pixel from slitmask design before x-correlation.
``SLITROPT``           ndarray            float       Right edge of the slit in pixel from slitmask design before x-correlation.
``SLITRA``             ndarray            float       Right ascension of the slit center (deg).
``SLITDEC``            ndarray            float       Declination of the slit center (deg).
``SLITLEN``            ndarray            float       Slit length (arcsec).
``SLITWID``            ndarray            float       Slit width (arcsec).
``SLITPA``             ndarray            float       Slit position angle on sky (deg from N through E).
``ALIGN``              ndarray            int         Slit used for alignment (1-yes; 0-no).
``OBJID``              ndarray            int         Object ID Number.
``OBJRA``              ndarray            float       Right ascension of the object (deg).
``OBJDEC``             ndarray            float       Declination of the object (deg).
``OBJNAME``            ndarray            str         Object name assigned by the observer.
``OBJMAG``             ndarray            float       Object magnitude provided by the observer.
``OBJMAG_BAND``        ndarray            str         Band of the magnitude provided by the observer.
``OBJ_TOPDIST``        ndarray            float       Projected position of the object w.r.t. the top edge of the slit (arcsec).
``OBJ_BOTDIST``        ndarray            float       Projected position of the object w.r.t. the bottom edge of the slit (arcsec).
=====================  =================  ==========  =================================================================================
Version 1.1.0

===========================  ========  ==========  =================================================
HDU Name                     Obj Type  Array Type  Description                                      
===========================  ========  ==========  =================================================
``PYP_SPEC``                 str                   PypeIt spectrograph name                         
``ILLUMFLAT_BPM``            ndarray   integer     Mirrors SlitTraceSet mask for Flat-specific flags
``ILLUMFLAT_RAW``            ndarray   floating    Processed, combined illum flats                  
``ILLUMFLAT_SPAT_BSPLINES``  ndarray   bspline     B-spline models for illum flat                   
``PIXELFLAT_BPM``            ndarray   integer     Mirrors SlitTraceSet mask for Flat-specific flags
``PIXELFLAT_MODEL``          ndarray   floating    Model flat                                       
``PIXELFLAT_NORM``           ndarray   floating    Normalized pixel flat                            
``PIXELFLAT_RAW``            ndarray   floating    Processed, combined pixel flats                  
``PIXELFLAT_SPAT_BSPLINES``  ndarray   bspline     B-spline models for pixel flat                   
``PIXELFLAT_SPEC_ILLUM``     ndarray   floating    Relative spectral illumination                   
``SPAT_ID``                  ndarray   integer     Slit spat_id                                     
===========================  ========  ==========  =================================================


Version: 1.0.0

==============  ========  ==========  ========================================================
Obj Key         Obj Type  Array Type  Description                                             
==============  ========  ==========  ========================================================
``PYP_SPEC``    str                   PypeIt: Spectrograph name                               
``ext_mode``    str                   Extraction mode (options: BOX, OPT)                     
``flux``        ndarray   floating    Flux array in units of counts/s or 10^-17 erg/s/cm^2/Ang
``fluxed``      bool                  Boolean indicating if the spectrum is fluxed.           
``ivar``        ndarray   floating    Inverse variance array (matches units of flux)          
``mask``        ndarray   integer     Mask array (1=Good,0=Bad)                               
``obj_model``   ndarray   floating    Object model for tellurics                              
``spect_meta``  dict                  header dict                                             
``telluric``    ndarray   floating    Telluric model                                          
``wave``        ndarray   floating    Wavelength array (Ang)                                  
==============  ========  ==========  ========================================================

Version 1.1.0

=================  =================  ==========  ======================
HDU Name           Obj Type           Array Type  Description           
=================  =================  ==========  ======================
``BIAS_IMAGE``     ndarray            floating    Primary image data    
``BIAS_IVAR``      ndarray            floating    Inverse variance image
``BIAS_DETECTOR``  DetectorContainer              Detector DataContainer
=================  =================  ==========  ======================
========================  =========  =========  =========  =========  =========  =========  =========  =============  =============  ========  ============  ===========
Parameter                 Default    ``bias``   ``dark``   ``trace``  ``arc``    ``tilt``   ``align``  ``pixelflat``  ``illumflat``  ``sky``   ``standard``  ``science``
========================  =========  =========  =========  =========  =========  =========  =========  =============  =============  ========  ============  ===========
``apply_gain``            ``True``                                                                                                                                      
``use_pattern``           ``False``                                                                                                                                     
``empirical_rn``          ``False``                                                                                                                                     
``use_overscan``          ``True``                                                                                                                                      
``trim``                  ``True``                                                                                                                                      
``orient``                ``True``                                                                                                                                      
``use_biasimage``         ``True``   ``False``                                                                                                                          
``use_darkimage``         ``False``                                                                                                                                     
``spat_flexure_correct``  ``False``                                                                                                                                     
``use_pixelflat``         ``True``   ``False``  ``False``  ``False``  ``False``  ``False``  ``False``  ``False``      ``False``                                         
``use_illumflat``         ``True``   ``False``  ``False``  ``False``  ``False``  ``False``  ``False``  ``False``      ``False``                                         
``use_specillum``         ``False``                                                                                                                                     
``shot_noise``            ``True``   ``False``                                                                                                                          
``noise_floor``           ``0.0``                                                                                                    ``0.01``  ``0.01``      ``0.01``   
``mask_cr``               ``False``             ``True``                                                                             ``True``  ``True``      ``True``   
========================  =========  =========  =========  =========  =========  =========  =========  =============  =============  ========  ============  ===========
==========  ==========  =============  =====================================================
Bit Name    Bit Number  Decimal Value  Description                                          
==========  ==========  =============  =====================================================
BPM         0           1              Component of the instrument-specific bad pixel mask  
CR          1           2              Cosmic ray detected                                  
SATURATION  2           4              Saturated pixel                                      
MINCOUNTS   3           8              Pixel below the instrument-specific minimum counts   
OFFSLITS    4           16             Pixel does not belong to any slit                    
IS_NAN      5           32             Pixel value is undefined                             
IVAR0       6           64             Inverse variance is undefined                        
IVAR_NAN    7           128            Inverse variance is NaN                              
EXTRACT     8           256            Pixel masked during local skysub and extraction      
BADSCALE    9           512            Bad image rescaling operation (e.g., flat value <= 0)
STCKMASK    10          1024           All pixels masked in image stack                     
==========  ==========  =============  =====================================================

Version 1.1.0

================  ========  ==========  ====================================================================================
HDU Name          Obj Type  Array Type  Description                                                                         
================  ========  ==========  ====================================================================================
``PYP_SPEC``      str                   PypeIt spectrograph name                                                            
``BPMTILTS``      ndarray   integer     Bad pixel mask for tilt solutions. Keys are taken from SlitTraceSetBitmask          
``COEFFS``        ndarray   floating    2D coefficents for the fit on the initial slits.  One set per slit/order (3D array).
``FUNC2D``        str                   Function used for the 2D fit                                                        
``NSLIT``         int                   Total number of slits.  This can include masked slits                               
``SPAT_FLEXURE``  float                 Flexure shift from the input TiltImage                                              
``SPAT_ID``       ndarray   integer     Slit spat_id                                                                        
``SPAT_ORDER``    ndarray   integer     Order for spatial fit (nslit)                                                       
``SPEC_ORDER``    ndarray   integer     Order for spectral fit (nslit)                                                      
================  ========  ==========  ====================================================================================
=================  =========  ========================================================================================================================================================================================================================================================
Key                Type       Description                                                                                                                                                                                                                                             
=================  =========  ========================================================================================================================================================================================================================================================
``binning``        str        Binning in PypeIt orientation (not the original)                                                                                                                                                                                                        
``darkcurr``       int,float  Dark current (e-/pixel/hour)                                                                                                                                                                                                                            
``dataext``        int        Index of fits extension containing data                                                                                                                                                                                                                 
``datasec``        ndarray    Either the data sections or the header keyword where the valid data sections can be obtained, one per amplifier. If defined explicitly should be in FITS format (e.g., [1:2048,10:4096]).                                                               
``det``            int        PypeIt designation for detector number (1-based).                                                                                                                                                                                                       
``gain``           ndarray    Inverse gain (e-/ADU). A list should be provided if a detector contains more than one amplifier.                                                                                                                                                        
``mincounts``      int,float  Counts in a pixel below this value will be ignored as being unphysical                                                                                                                                                                                  
``nonlinear``      int,float  Percentage of detector range which is linear (i.e. everything above ``nonlinear*saturation`` will be flagged as saturated)                                                                                                                              
``numamplifiers``  int        Number of amplifiers                                                                                                                                                                                                                                    
``oscansec``       ndarray    Either the overscan section or the header keyword where the valid data sections can be obtained, one per amplifier. If defined explicitly should be in FITS format (e.g., [1:2048,10:4096]).                                                            
``platescale``     int,float  arcsec per pixel in the spatial dimension for an unbinned pixel                                                                                                                                                                                         
``ronoise``        ndarray    Read-out noise (e-). A list should be provided if a detector contains more than one amplifier. If any element of this list is <=0, the readout noise will be determined from the overscan regions defined by oscansec.                                  
``saturation``     int,float  The detector saturation level                                                                                                                                                                                                                           
``spatflip``       bool       If this is True then the spatial dimension will be flipped.  PypeIt expects echelle orders to increase with increasing pixel number.  I.e., setting spatflip=True can reorder images so that blue orders appear on the left and red orders on the right.
``specaxis``       int        Spectra are dispersed along this axis. Allowed values are 0 (first dimension for a numpy array shape) or 1 (second dimension for numpy array shape).                                                                                                    
``specflip``       bool       If this is True then the dispersion dimension (specified by the specaxis) will be flipped.  PypeIt expects wavelengths to increase with increasing pixel number.  If this is not the case for this instrument, set specflip to True.                    
``xgap``           int,float  Gap between the square detector pixels (expressed as a fraction of the x pixel size -- x is predominantly the spatial axis)                                                                                                                             
``ygap``           int,float  Gap between the square detector pixels (expressed as a fraction of the y pixel size -- y is predominantly the spectral axis)                                                                                                                            
``ysize``          int,float  The size of a pixel in the y-direction as a multiple of the x pixel size (i.e. xsize = 1.0 -- x is predominantly the dispersion axis)                                                                                                                   
=================  =========  ========================================================================================================================================================================================================================================================
.. code-block:: console

    ##########################################################
    Setup A
         dispname: 830G
           decker: LongMirr
          binning: 1,1
        dispangle: 8099.98291016
              amp: SINGLE:B
          filter1: OG550
    #---------------------------------------------------------
    |               filename |                 frametype |                 ra |                dec |     target | dispname |   decker | binning |          mjd |    airmass | exptime |     dispangle |      amp | filter1 |    dateobs |         utc | frameno |
    | DE.20170527.06713.fits |                  arc,tilt |  57.99999999999999 |               45.0 | DOME PHLAT |     830G | LongMirr |     1,1 | 57900.077631 | 1.41291034 |     1.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 01:51:53.87 |      30 |
    |     d0527_0030.fits.gz |                  arc,tilt |  57.99999999999999 |               45.0 | DOME PHLAT |     830G | LongMirr |     1,1 | 57900.077631 | 1.41291034 |     1.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 01:51:53.87 |      30 |
    |     d0527_0031.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | DOME PHLAT |     830G | LongMirr |     1,1 |  57900.07851 | 1.41291034 |     4.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 01:53:10.93 |      31 |
    | DE.20170527.06790.fits | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | DOME PHLAT |     830G | LongMirr |     1,1 |  57900.07851 | 1.41291034 |     4.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 01:53:10.93 |      31 |
    |     d0527_0032.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | DOME PHLAT |     830G | LongMirr |     1,1 | 57900.079356 | 1.41291034 |     4.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 01:54:24.03 |      32 |
    | DE.20170527.06864.fits | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | DOME PHLAT |     830G | LongMirr |     1,1 | 57900.079356 | 1.41291034 |     4.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 01:54:24.03 |      32 |
    |     d0527_0033.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | DOME PHLAT |     830G | LongMirr |     1,1 | 57900.080211 | 1.41291034 |     4.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 01:55:36.93 |      33 |
    | DE.20170527.06936.fits | pixelflat,illumflat,trace |  57.99999999999999 |               45.0 | DOME PHLAT |     830G | LongMirr |     1,1 | 57900.080211 | 1.41291034 |     4.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 01:55:36.93 |      33 |
    | DE.20170527.37601.fits |                   science |  261.0363749999999 | 19.028166666666667 |   P261_OFF |     830G | LongMirr |     1,1 | 57900.435131 | 1.03078874 |  1200.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 10:26:41.61 |      80 |
    |     d0527_0081.fits.gz |                   science |  261.0363749999999 | 19.028166666666667 |   P261_OFF |     830G | LongMirr |     1,1 | 57900.449842 | 1.01267696 |  1200.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 10:47:52.92 |      81 |
    | DE.20170527.38872.fits |                   science |  261.0363749999999 | 19.028166666666667 |   P261_OFF |     830G | LongMirr |     1,1 | 57900.449842 | 1.01267696 |  1200.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 10:47:52.92 |      81 |
    | DE.20170527.41775.fits |                   science |  261.0362916666666 | 19.028888888888886 |   P261_OFF |     830G | LongMirr |     1,1 | 57900.483427 | 1.00093023 |  1200.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 11:36:15.35 |      83 |
    |     d0527_0083.fits.gz |                   science |  261.0362916666666 | 19.028888888888886 |   P261_OFF |     830G | LongMirr |     1,1 | 57900.483427 | 1.00093023 |  1200.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 11:36:15.35 |      83 |
    | DE.20170527.43045.fits |                   science |  261.0362916666666 | 19.028888888888886 |   P261_OFF |     830G | LongMirr |     1,1 | 57900.498135 | 1.00838805 |  1200.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 11:57:25.35 |      84 |
    | DE.20170527.44316.fits |                   science |  261.0362916666666 | 19.028888888888886 |   P261_OFF |     830G | LongMirr |     1,1 | 57900.512854 | 1.02377681 |  1200.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 12:18:36.71 |      85 |
    | DE.20170527.53184.fits |                   science | 349.99316666666664 |           -5.16575 |  Feige 110 |     830G | LongMirr |     1,1 | 57900.615484 | 1.42505162 |    45.0 | 8099.98291016 | SINGLE:B |   OG550 | 2017-05-27 | 14:46:24.88 |      93 |
    ##########################################################
    Setup B
         dispname: 830G
           decker: LongMirr
          binning: 1,1
        dispangle: 8399.93554688
              amp: SINGLE:B
          filter1: OG550
    #---------------------------------------------------------
    |           filename |                 frametype |                 ra |               dec |         target | dispname |   decker | binning |          mjd |    airmass | exptime |     dispangle |      amp | filter1 |    dateobs |         utc | frameno |
    | d0914_0002.fits.gz |                      bias | 299.99999999999994 |              80.0 |        unknown |     830G |     None |     1,1 |  58010.07499 |  1.0153979 |     1.0 | 7499.97998047 | SINGLE:B |       R | 2017-09-14 | 01:48:05.53 |       2 |
    | d0914_0011.fits.gz |                  arc,tilt |  57.99999999999999 |              45.0 |        unknown |     830G | LongMirr |     1,1 | 58010.135443 | 1.41291034 |     1.0 | 8399.93554688 | SINGLE:B |   OG550 | 2017-09-14 | 03:15:07.98 |      11 |
    | d0914_0013.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |              45.0 |        unknown |     830G | LongMirr |     1,1 | 58010.137123 | 1.41291034 |     6.0 | 8399.93554688 | SINGLE:B |   OG550 | 2017-09-14 | 03:17:33.43 |      13 |
    | d0914_0014.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |              45.0 |        unknown |     830G | LongMirr |     1,1 | 58010.138113 | 1.41291034 |     6.0 | 8399.93554688 | SINGLE:B |   OG550 | 2017-09-14 | 03:18:59.03 |      14 |
    | d0914_0015.fits.gz | pixelflat,illumflat,trace |  57.99999999999999 |              45.0 |        unknown |     830G | LongMirr |     1,1 | 58010.138969 | 1.41291034 |     6.0 | 8399.93554688 | SINGLE:B |   OG550 | 2017-09-14 | 03:20:13.93 |      15 |
    | d0914_0036.fits.gz |                   science | 11.389749999999998 | 9.032555555555556 | PSOJ011p09_OFF |     830G | LongMirr |     1,1 |  58010.48501 | 1.01790951 |  1200.0 | 8399.93554688 | SINGLE:B |   OG550 | 2017-09-14 | 11:38:32.60 |      36 |
    | d0914_0037.fits.gz |                   science | 11.390166666666666 | 9.033277777777778 | PSOJ011p09_OFF |     830G | LongMirr |     1,1 | 58010.499726 | 1.02369591 |  1200.0 | 8399.93554688 | SINGLE:B |   OG550 | 2017-09-14 | 11:59:43.61 |      37 |
    | d0914_0038.fits.gz |                   science | 11.389333333333331 | 9.031833333333335 | PSOJ011p09_OFF |     830G | LongMirr |     1,1 | 58010.514673 |  1.0383931 |  1200.0 | 8399.93554688 | SINGLE:B |   OG550 | 2017-09-14 | 12:21:14.62 |      38 |
    | d0914_0047.fits.gz |                   science |  76.37762499999998 | 52.83063888888889 |        G191B2B |     830G | LongMirr |     1,1 | 58010.641261 | 1.19898553 |    60.0 | 8399.93554688 | SINGLE:B |   OG550 | 2017-09-14 | 15:23:31.06 |      47 |
    ##end


========================  ============================================================================  =========  ============  =================  =========  =======================================================================================
``PypeIt`` Name           ``PypeIt`` Class                                                              Telescope  Camera        Pipeline Approach  Supported  Comments                                                                               
========================  ============================================================================  =========  ============  =================  =========  =======================================================================================
bok_bc                    :class:`~pypeit.spectrographs.bok_bc.BokBCSpectrograph`                       BOK        BC            MultiSlit          True       Bok B&C spectrometer                                                                   
gemini_flamingos1         :class:`~pypeit.spectrographs.gemini_flamingos.GeminiFLAMINGOS1Spectrograph`  GEMINI-S   FLAMINGOS     MultiSlit          False                                                                                             
gemini_flamingos2         :class:`~pypeit.spectrographs.gemini_flamingos.GeminiFLAMINGOS2Spectrograph`  GEMINI-S   FLAMINGOS     MultiSlit          True       Flamingos-2 NIR spectrograph                                                           
gemini_gmos_north_e2v     :class:`~pypeit.spectrographs.gemini_gmos.GeminiGMOSNE2VSpectrograph`         GEMINI-N   GMOS-N        MultiSlit          True       E2V detector; see :doc:`gemini_gmos`                                                   
gemini_gmos_north_ham     :class:`~pypeit.spectrographs.gemini_gmos.GeminiGMOSNHamSpectrograph`         GEMINI-N   GMOS-N        MultiSlit          True       Hamamatsu detector (R400, B600, R831); Used since Feb 2017; see :doc:`gemini_gmos`     
gemini_gmos_north_ham_ns  :class:`~pypeit.spectrographs.gemini_gmos.GeminiGMOSNHamNSSpectrograph`       GEMINI-N   GMOS-N        MultiSlit          True       Same as gemini_gmos_north_ham when used in nod-and-shuffle mode; see :doc:`gemini_gmos`
gemini_gmos_south_ham     :class:`~pypeit.spectrographs.gemini_gmos.GeminiGMOSSHamSpectrograph`         GEMINI-S   GMOS-S        MultiSlit          True       Hamamatsu detector (R400, B600, R831); see :doc:`gemini_gmos`                          
gemini_gnirs              :class:`~pypeit.spectrographs.gemini_gnirs.GeminiGNIRSSpectrograph`           GEMINI-N   GNIRS         Echelle            True                                                                                              
gtc_osiris                :class:`~pypeit.spectrographs.gtc_osiris.GTCOSIRISSpectrograph`               GTC        OSIRIS        MultiSlit          True       See :doc:`gtc_osiris`                                                                  
keck_deimos               :class:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph`             KECK       DEIMOS        MultiSlit          True       Supported gratings: 600ZD, 830G, 900ZD, 1200B, 1200G; see :doc:`deimos`                
keck_hires_red            :class:`~pypeit.spectrographs.keck_hires.KECKHIRESRSpectrograph`              KECK       HIRES_R       Echelle            False                                                                                             
keck_kcwi                 :class:`~pypeit.spectrographs.keck_kcwi.KeckKCWISpectrograph`                 KECK       KCWI          IFU                True       Supported setups: BM, BH2; see :doc:`keck_kcwi`                                        
keck_lris_blue            :class:`~pypeit.spectrographs.keck_lris.KeckLRISBSpectrograph`                KECK       LRISb         MultiSlit          True       Blue camera; see :doc:`lris`                                                           
keck_lris_blue_orig       :class:`~pypeit.spectrographs.keck_lris.KeckLRISBOrigSpectrograph`            KECK       LRISb         MultiSlit          True       Original detector; replaced in 20??; see :doc:`lris`                                   
keck_lris_red             :class:`~pypeit.spectrographs.keck_lris.KeckLRISRSpectrograph`                KECK       LRISr         MultiSlit          True       Red camera;  LBNL detector, 2kx4k; see :doc:`lris`                                     
keck_lris_red_mark4       :class:`~pypeit.spectrographs.keck_lris.KeckLRISRMark4Spectrograph`           KECK       LRISr         MultiSlit          True       New Mark4 detector, circa Spring 2021; Supported setups = R400                         
keck_lris_red_orig        :class:`~pypeit.spectrographs.keck_lris.KeckLRISROrigSpectrograph`            KECK       LRISr         MultiSlit          True       Original detector; replaced in 2009; see :doc:`lris`                                   
keck_mosfire              :class:`~pypeit.spectrographs.keck_mosfire.KeckMOSFIRESpectrograph`           KECK       MOSFIRE       MultiSlit          True       Gratings tested: Y, J, K; see :doc:`mosfire`                                           
keck_nires                :class:`~pypeit.spectrographs.keck_nires.KeckNIRESSpectrograph`               KECK       NIRES         Echelle            True                                                                                              
keck_nirspec_low          :class:`~pypeit.spectrographs.keck_nirspec.KeckNIRSPECLowSpectrograph`        KECK       NIRSPEC       MultiSlit          True       Low-dispersion grating                                                                 
lbt_luci1                 :class:`~pypeit.spectrographs.lbt_luci.LBTLUCI1Spectrograph`                  LBT        LUCI1         MultiSlit          True                                                                                              
lbt_luci2                 :class:`~pypeit.spectrographs.lbt_luci.LBTLUCI2Spectrograph`                  LBT        LUCI2         MultiSlit          True                                                                                              
lbt_mods1b                :class:`~pypeit.spectrographs.lbt_mods.LBTMODS1BSpectrograph`                 LBT        MODS1B        MultiSlit          True       MODS-I blue spectrometer                                                               
lbt_mods1r                :class:`~pypeit.spectrographs.lbt_mods.LBTMODS1RSpectrograph`                 LBT        MODS1R        MultiSlit          True       MODS-I red spectrometer                                                                
lbt_mods2b                :class:`~pypeit.spectrographs.lbt_mods.LBTMODS2BSpectrograph`                 LBT        MODS2B        MultiSlit          True       MODS-II blue spectrometer                                                              
lbt_mods2r                :class:`~pypeit.spectrographs.lbt_mods.LBTMODS2RSpectrograph`                 LBT        MODS2R        MultiSlit          True       MODS-II red spectrometer                                                               
ldt_deveny                :class:`~pypeit.spectrographs.ldt_deveny.LDTDeVenySpectrograph`               LDT        deveny        MultiSlit          True       LDT DeVeny Optical Spectrograph                                                        
magellan_fire             :class:`~pypeit.spectrographs.magellan_fire.MagellanFIREEchelleSpectrograph`  MAGELLAN   FIRE          Echelle            True       Magellan/FIRE in echelle mode                                                          
magellan_fire_long        :class:`~pypeit.spectrographs.magellan_fire.MagellanFIRELONGSpectrograph`     MAGELLAN   FIRE          MultiSlit          True       Magellan/FIRE in long-slit/high-throughput mode                                        
magellan_mage             :class:`~pypeit.spectrographs.magellan_mage.MagellanMAGESpectrograph`         MAGELLAN   MagE          Echelle            True       See :doc:`mage`                                                                        
mdm_osmos_mdm4k           :class:`~pypeit.spectrographs.mdm_osmos.MDMOSMOSMDM4KSpectrograph`            KPNO       MDM4K         MultiSlit          True       MDM OSMOS spectrometer                                                                 
mmt_binospec              :class:`~pypeit.spectrographs.mmt_binospec.MMTBINOSPECSpectrograph`           MMT        BINOSPEC      MultiSlit          True                                                                                              
mmt_bluechannel           :class:`~pypeit.spectrographs.mmt_bluechannel.MMTBlueChannelSpectrograph`     MMT        Blue_Channel  MultiSlit          True                                                                                              
mmt_mmirs                 :class:`~pypeit.spectrographs.mmt_mmirs.MMTMMIRSSpectrograph`                 MMT        MMIRS         MultiSlit          True                                                                                              
not_alfosc                :class:`~pypeit.spectrographs.not_alfosc.NOTALFOSCSpectrograph`               NOT        ALFOSC        MultiSlit          True       Grisms 4, 19                                                                           
ntt_efosc2                :class:`~pypeit.spectrographs.ntt_efosc2.NTTEFOSC2Spectrograph`               NTT        EFOSC2        MultiSlit          True       The ESO Faint Object Spectrograph and Camera version 2                                 
p200_dbsp_blue            :class:`~pypeit.spectrographs.p200_dbsp.P200DBSPBlueSpectrograph`             P200       DBSPb         MultiSlit          True       Blue camera                                                                            
p200_dbsp_red             :class:`~pypeit.spectrographs.p200_dbsp.P200DBSPRedSpectrograph`              P200       DBSPr         MultiSlit          True       Red camera                                                                             
p200_tspec                :class:`~pypeit.spectrographs.p200_tspec.P200TSPECSpectrograph`               P200       TSPEC         Echelle            True       TripleSpec spectrograph                                                                
shane_kast_blue           :class:`~pypeit.spectrographs.shane_kast.ShaneKastBlueSpectrograph`           SHANE      KASTb         MultiSlit          True                                                                                              
shane_kast_red            :class:`~pypeit.spectrographs.shane_kast.ShaneKastRedSpectrograph`            SHANE      KASTr         MultiSlit          True                                                                                              
shane_kast_red_ret        :class:`~pypeit.spectrographs.shane_kast.ShaneKastRedRetSpectrograph`         SHANE      KASTr         MultiSlit          True       Red reticon                                                                            
soar_goodman_red          :class:`~pypeit.spectrographs.soar_goodman.SOARGoodmanRedSpectrograph`        SOAR       red           MultiSlit          True       Supported gratings: M1, M2 and 2x2 binning                                             
tng_dolores               :class:`~pypeit.spectrographs.tng_dolores.TNGDoloresSpectrograph`             TNG        DOLORES       MultiSlit          False      DOLORES (LRS) spectrograph; LR-R                                                       
vlt_fors2                 :class:`~pypeit.spectrographs.vlt_fors.VLTFORS2Spectrograph`                  VLT        FORS2         MultiSlit          True       300I, 300V gratings                                                                    
vlt_sinfoni               :class:`~pypeit.spectrographs.vlt_sinfoni.VLTSINFONISpectrograph`             VLT        SINFONI       MultiSlit          True       Gratings tested: K                                                                     
vlt_xshooter_nir          :class:`~pypeit.spectrographs.vlt_xshooter.VLTXShooterNIRSpectrograph`        VLT        XShooter_NIR  Echelle            True       See :doc:`xshooter`                                                                    
vlt_xshooter_uvb          :class:`~pypeit.spectrographs.vlt_xshooter.VLTXShooterUVBSpectrograph`        VLT        XShooter_UVB  Echelle            False      See :doc:`xshooter`                                                                    
vlt_xshooter_vis          :class:`~pypeit.spectrographs.vlt_xshooter.VLTXShooterVISSpectrograph`        VLT        XShooter_VIS  Echelle            True       See :doc:`xshooter`                                                                    
wht_isis_blue             :class:`~pypeit.spectrographs.wht_isis.WHTISISBlueSpectrograph`               WHT        ISISb         MultiSlit          False      Blue camera                                                                            
wht_isis_red              :class:`~pypeit.spectrographs.wht_isis.WHTISISRedSpectrograph`                WHT        ISISr         MultiSlit          False      Red camera                                                                             
========================  ============================================================================  =========  ============  =================  =========  =======================================================================================


Version: 1.0.3

====================  =================  ==========  ================================================================================================================================================================================
Obj Key               Obj Type           Array Type  Description                                                                                                                                                                     
====================  =================  ==========  ================================================================================================================================================================================
``bpmmask``           ndarray            integer     2D bad-pixel mask for the image                                                                                                                                                 
``det``               int                            Detector index                                                                                                                                                                  
``detector``          DetectorContainer              Detector DataContainer                                                                                                                                                          
``imgbitm``           str                            List of BITMASK keys from ImageBitMask                                                                                                                                          
``ivarmodel``         ndarray            floating    2D ivar model image (float32)                                                                                                                                                   
``ivarraw``           ndarray            floating    2D processed inverse variance image (float32)                                                                                                                                   
``objmodel``          ndarray            floating    2D object model image (float32)                                                                                                                                                 
``scaleimg``          ndarray            floating    2D multiplicative scale image that has been applied to the science image (float32)                                                                                              
``sci_spat_flexure``  float                          Shift, in spatial pixels, between this image and SlitTrace                                                                                                                      
``sci_spec_flexure``  Table                          Global shift of the spectrum to correct for spectralflexure (pixels). This is based on the sky spectrum atthe center of each slit                                               
``sciimg``            ndarray            floating    2D processed science image (float32)                                                                                                                                            
``skymodel``          ndarray            floating    2D sky model image (float32)                                                                                                                                                    
``slits``             SlitTraceSet                   SlitTraceSet defining the slits                                                                                                                                                 
``tilts``             ndarray            floating    2D tilts image (float64)                                                                                                                                                        
``vel_corr``          float                          Relativistic velocity correction for wavelengths                                                                                                                                
``vel_type``          str                            Type of reference frame correction (if any). Options are listed in the routine: WavelengthSolutionPar.valid_reference_frames() Current list: observed, heliocentric, barycentric
``waveimg``           ndarray            floating    2D wavelength image in vacuum (float64)                                                                                                                                         
====================  =================  ==========  ================================================================================================================================================================================

.. core
.. _glob.glob: https://docs.python.org/3/library/glob.html
.. _isinstance: https://docs.python.org/3/library/functions.html#isinstance
.. _logging.Logger: https://docs.python.org/3/library/logging.html
.. _logging.level: https://docs.python.org/3/library/logging.html#logging-levels
.. _PEP 8: https://www.python.org/dev/peps/pep-0008
.. _PEP 257: https://www.python.org/dev/peps/pep-0257
.. _argparse.Namespace: https://docs.python.org/3/library/argparse.html#argparse.Namespace
.. _argparse.ArgumentParser: https://docs.python.org/3/library/argparse.html#argparse.ArgumentParser
.. _argparse.HelpFormatter: https://docs.python.org/3/library/argparse.html#formatter-class
.. _collections.OrderedDict: https://docs.python.org/3/library/collections.html#collections.OrderedDict
.. _str.splitlines: https://docs.python.org/3/library/stdtypes.html#str.splitlines
.. _textwrap.wrap: https://docs.python.org/3/library/textwrap.html#textwrap.wrap

.. numpy
.. _numpy.ndarray: https://docs.scipy.org/doc/numpy/reference/generated/numpy.ndarray.html
.. _numpy.ma.MaskedArray: http://docs.scipy.org/doc/numpy/reference/maskedarray.baseclass.html
.. _numpy.ma.median: https://numpy.org/doc/stable/reference/generated/numpy.ma.median.html
.. _numpy.recarray: https://docs.scipy.org/doc/numpy/reference/generated/numpy.recarray.html
.. _numpy.meshgrid: http://docs.scipy.org/doc/numpy/reference/generated/numpy.meshgrid.html
.. _numpy.where: http://docs.scipy.org/doc/numpy/reference/generated/numpy.where.html
.. _numpy.random.Generator: https://numpy.org/doc/stable/reference/random/generator.html

.. scipy
.. _scipy.optimize.least_squares: http://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.least_squares.html
.. _scipy.optimize.OptimizeResult: http://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.OptimizeResult.html
.. _scipy.optimize.differential_evolution: https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.differential_evolution.html
.. _scipy.interpolate.interp1d: https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.interp1d.html
.. _scipy.sparse.spmatrix: http://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.spmatrix.html
.. _scipy.sparse.csr_matrix: http://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.csr_matrix.html
.. _scipy.sparse.coo_matrix: http://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.coo_matrix.html
.. _scipy.sparse.triu: http://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.triu.html
.. _scipy.linalg.lu_factor: http://docs.scipy.org/doc/scipy/reference/generated/scipy.linalg.lu_factor.html
.. _scipy.linalg.lu_solve: https://docs.scipy.org/doc/scipy/reference/generated/scipy.linalg.lu_solve.html
.. _scipy.ndimage.sobel: https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.sobel.html
.. _scipy.ndimage.convolve: https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.convolve.html#scipy.ndimage.convolve

.. matplotlib
.. _matplotlib.pyplot.imshow: http://matplotlib.org/api/pyplot_api.html#matplotlib.pyplot.imshow
.. _matplotlib.axes.Axes: https://matplotlib.org/api/axes_api.html#matplotlib.axes.Axes

.. configobj
.. _configobj: http://configobj.readthedocs.io/en/latest/

.. astropy
.. _astropy.io.fits: http://docs.astropy.org/en/stable/io/fits/index.html
.. _astropy.io.fits.open: http://docs.astropy.org/en/stable/io/fits/api/files.html#astropy.io.fits.open
.. _astropy.io.fits.HDUList: http://docs.astropy.org/en/stable/io/fits/api/hdulists.html
.. _astropy.io.fits.HDUList.writeto: http://docs.astropy.org/en/stable/io/fits/api/hdulists.html#astropy.io.fits.HDUList.writeto
.. _astropy.io.fits.Header: http://docs.astropy.org/en/stable/io/fits/api/headers.html#header
.. _astropy.io.fits.ImageHDU: https://docs.astropy.org/en/stable/io/fits/api/images.html#imagehdu
.. _astropy.io.fits.BinTableHDU: https://docs.astropy.org/en/stable/io/fits/api/tables.html#bintablehdu
.. _astropy.io.fits.Column: https://docs.astropy.org/en/stable/io/fits/api/tables.html#column
.. _astropy.table.Table: https://docs.astropy.org/en/stable/table/
.. _astropy.table.Table.read: https://docs.astropy.org/en/stable/api/astropy.table.Table.html#astropy.table.Table.read
.. _astropy.table.Row: https://docs.astropy.org/en/stable/api/astropy.table.Row.html
.. _astropy.wcs.wcs.WCS: http://docs.astropy.org/en/stable/api/astropy.wcs.WCS.html
.. _astropy.modeling: http://docs.astropy.org/en/stable/modeling/index.html
.. _astropy.modeling.polynomial.Legendre1D: http://docs.astropy.org/en/stable/api/astropy.modeling.polynomial.Legendre1D.html
.. _astropy.modeling.models.CompoundModel: http://docs.astropy.org/en/stable/modeling/compound-models.html
.. _astropy.modeling.FittableModel: http://docs.astropy.org/en/stable/api/astropy.modeling.FittableModel.html
.. _astropy.cosmology.FlatLambdaCDM: http://docs.astropy.org/en/stable/api/astropy.cosmology.FlatLambdaCDM.html#flatlambdacdm
.. _astropy.constants: http://docs.astropy.org/en/stable/constants/index.html
.. _astropy.time.Time: https://docs.astropy.org/en/stable/time/
.. _astropy.coordinates.SkyCoord: https://docs.astropy.org/en/stable/api/astropy.coordinates.SkyCoord.html
.. _astropy.coordinates.EarthLocation: https://docs.astropy.org/en/stable/api/astropy.coordinates.EarthLocation.html
.. _astropy.stats.SigmaClip: https://docs.astropy.org/en/stable/api/astropy.stats.SigmaClip.html

.. scikit-learn
.. _sklearn.decomposition.PCA: https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.PCA.html

.. pydl
.. _pydl.goddard.astro.airtovac: http://pydl.readthedocs.io/en/stable/api/pydl.goddard.astro.airtovac.html#pydl.goddard.astro.airtovac
.. _pydl.pydlutils.yanny: http://pydl.readthedocs.io/en/stable/api/pydl.pydlutils.yanny.yanny.html

.. linetools
.. _linetools.spectra.xspectrum1d.XSpectrum1D: https://linetools.readthedocs.io/en/latest/xspectrum1d.html

.. sphinx
.. _Sphinx: https://www.sphinx-doc.org/en/master/index.html
.. _reStructuredText: http://docutils.sourceforge.net/rst.html
.. _Google-format docstrings: https://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_google.html#example-google
.. _Numpy-format docstrings: https://sphinxcontrib-napoleon.readthedocs.io/en/latest/example_numpy.html#example-numpy

.. misc packages
.. _bumpversion: https://pypi.org/project/bumpversion/
.. _rclone: https://rclone.org/
.. _pip: https://pip.pypa.io/en/stable/
.. _anaconda: https://www.anaconda.com/products/individual
.. _conda: https://docs.conda.io/projects/conda/en/latest/index.html
.. _virtualenv: https://virtualenv.pypa.io/en/latest/
.. _pdb: https://docs.python.org/3/library/pdb.html
.. _IPython.embed: https://ipython.readthedocs.io/en/stable/api/generated/IPython.terminal.embed.html#function
.. _pytest: https://docs.pytest.org/en/latest/
.. _shapely: https://shapely.readthedocs.io/en/stable/manual.html
.. _scikit-image: https://scikit-image.org/

.. ginga

.. _ginga: https://ginga.readthedocs.io/en/stable/
.. _AstroImage: https://ginga.readthedocs.io/en/stable/dev_manual/image_wrappers.html#astroimage
.. _ginga GlobalPlugin: https://ginga.readthedocs.io/en/stable/dev_manual/developers.html#writing-a-global-plugin

.. pypeit
.. _repo: https://github.com/pypeit/PypeIt
.. _PypeIt-development-suite: https://github.com/pypeit/PypeIt-development-suite
.. _documentation: https://pypeit.readthedocs.io/en/latest/
.. _Submit an issue: https://github.com/pypeit/PypeIt/issues
.. _PypeIt dev-suite Google Drive: https://drive.google.com/drive/folders/1oh19siB1-F0jjmY-F_jr73eA-TQYEiFW?usp=sharing

.. emails
.. _Joe Hennawi: joe@physics.ucsb.edu
.. _X Prochaska: xavier@ucolick.org

.. misc
.. _SDSS bitmasks: https://www.sdss.org/dr16/algorithms/bitmasks/

============================  ===  ========  ========  ========  ========  ==========================  ======================  ========  ========  ============  =========  ==========
Instrument                    Det  specaxis  specflip  spatflip  namp      gain                        RN                      darkcurr  min       sat           nonlinear  platescale
============================  ===  ========  ========  ========  ========  ==========================  ======================  ========  ========  ============  =========  ==========
``bok_bc``                    1    1         False     False     1         1.5                         3.0                     5.4       -1.0e+10  65535.0       1.0000     0.2000    
``gemini_flamingos1``         1    0         False     False     1         3.8                         6.0                     0.01      -1.0e+10  320000.0      0.8750     0.1500    
``gemini_flamingos2``         1    0         True      False     1         4.44                        5.0                     0.5       -1.0e+10  700000.0      1.0000     0.1787    
``gemini_gmos_north_e2v``     1    1         False     False     2         2.27, 2.27                  3.32, 3.32              0.0       -1.0e+10  110900.0      0.9500     0.0728    
...                           2    1         False     False     2         2.27, 2.27                  3.32, 3.32              0.0       -1.0e+10  115500.0      0.9500     0.0728    
...                           3    1         False     False     2         2.27, 2.27                  3.32, 3.32              0.0       -1.0e+10  116700.0      0.9500     0.0728    
``gemini_gmos_north_ham``     1    1         False     False     4         1.63, 1.63, 1.63, 1.63      4.14, 4.14, 4.14, 4.14  0.0       -1.0e+10  129000.0      0.9500     0.0807    
...                           2    1         False     False     4         1.63, 1.63, 1.63, 1.63      4.14, 4.14, 4.14, 4.14  0.0       -1.0e+10  123000.0      0.9500     0.0807    
...                           3    1         False     False     4         1.63, 1.63, 1.63, 1.63      4.14, 4.14, 4.14, 4.14  0.0       -1.0e+10  125000.0      0.9500     0.0807    
``gemini_gmos_north_ham_ns``  1    1         False     False     4         1.63, 1.63, 1.63, 1.63      4.14, 4.14, 4.14, 4.14  0.0       -1.0e+10  129000.0      0.9500     0.0807    
...                           2    1         False     False     4         1.63, 1.63, 1.63, 1.63      4.14, 4.14, 4.14, 4.14  0.0       -1.0e+10  123000.0      0.9500     0.0807    
...                           3    1         False     False     4         1.63, 1.63, 1.63, 1.63      4.14, 4.14, 4.14, 4.14  0.0       -1.0e+10  125000.0      0.9500     0.0807    
``gemini_gmos_south_ham``     1    1         False     False     4         1.83, 1.83, 1.83, 1.83      3.98, 3.98, 3.98, 3.98  0.0       -1.0e+10  129000.0      0.9500     0.0800    
...                           2    1         False     False     4         1.83, 1.83, 1.83, 1.83      3.98, 3.98, 3.98, 3.98  0.0       -1.0e+10  123000.0      0.9500     0.0800    
...                           3    1         False     False     4         1.83, 1.83, 1.83, 1.83      3.98, 3.98, 3.98, 3.98  0.0       -1.0e+10  125000.0      0.9500     0.0800    
``gemini_gnirs``              1    0         True      True      1         13.5                        7.0                     0.15      -1.0e+10  150000.0      0.7100     0.1500    
``gtc_osiris``                1    0         False     False     1         0.95                        4.5                     0.0       0.0e+00   65535.0       0.9500     0.1270    
...                           2    0         False     False     1         0.95                        4.5                     0.0       0.0e+00   65535.0       0.9500     0.1270    
``keck_deimos``               1    0         False     False     1         1.226                       2.57                    4.19      -1.0e+10  65535.0       0.9500     0.1185    
...                           2    0         False     False     1         1.188                       2.491                   3.46      -1.0e+10  65535.0       0.9500     0.1185    
...                           3    0         False     False     1         1.248                       2.618                   4.03      -1.0e+10  65535.0       0.9500     0.1185    
...                           4    0         False     False     1         1.22                        2.557                   3.8       -1.0e+10  65535.0       0.9500     0.1185    
...                           5    0         False     False     1         1.184                       2.482                   4.71      -1.0e+10  65535.0       0.9500     0.1185    
...                           6    0         False     False     1         1.177                       2.469                   4.28      -1.0e+10  65535.0       0.9500     0.1185    
...                           7    0         False     False     1         1.201                       2.518                   3.33      -1.0e+10  65535.0       0.9500     0.1185    
...                           8    0         False     False     1         1.23                        2.58                    3.69      -1.0e+10  65535.0       0.9500     0.1185    
``keck_kcwi``                 1    0         None      False     ``None``  ``None``                    ``None``                0.0       -1.0e+10  65535.0       0.9500     0.1457    
``keck_lris_blue``            1    0         False     False     2         1.55, 1.56                  3.9, 4.2                0.0       -1.0e+10  65535.0       0.8600     0.1350    
...                           2    0         False     False     2         1.63, 1.7                   3.6, 3.6                0.0       -1.0e+10  65535.0       0.8600     0.1350    
``keck_lris_blue_orig``       1    0         True      False     2         1.55, 1.56                  3.9, 4.2                0.0       -1.0e+10  65535.0       0.8600     0.1350    
...                           2    0         True      False     2         1.63, 1.7                   3.6, 3.6                0.0       -1.0e+10  65535.0       0.8600     0.1350    
``keck_lris_red``             1    0         False     False     2         1.255, 1.18                 4.64, 4.76              0.0       -1.0e+10  65535.0       0.7600     0.1350    
...                           2    0         False     False     2         1.191, 1.162                4.54, 4.62              0.0       -1.0e+10  65535.0       0.7600     0.1350    
``keck_lris_red_mark4``       1    0         True      False     2         1.61, 1.60153               3.65, 3.52              0.0       -1.0e+10  65535.0       0.7600     0.1230    
``keck_lris_red_orig``        1    1         False     False     2         1.98, 2.17                  6.1, 6.3                0.0       -1.0e+10  65535.0       0.7600     0.2100    
``keck_mosfire``              1    1         False     False     1         2.15                        5.8                     0.8       -1.0e+10  1000000000.0  1.0000     0.1798    
``keck_nires``                1    1         True      False     1         3.8                         5.0                     0.01      -1.0e+10  1000000.0     0.7600     0.1500    
``keck_nirspec_low``          1    0         False     False     1         5.8                         23.0                    0.8       -1.0e+10  100000.0      1.0000     0.1930    
``lbt_luci1``                 1    1         False     False     1         2.0                         4.61                    0.0       -1.0e+10  100000000.0   0.8000     0.2500    
``lbt_luci2``                 1    1         False     False     1         2.0                         4.47                    0.0       -1.0e+10  100000000.0   0.8000     0.2500    
``lbt_mods1b``                1    0         True      False     4         2.55, 1.91, 2.09, 2.02      3.41, 2.93, 2.92, 2.76  0.5       -1.0e+10  65535.0       0.9900     0.1200    
``lbt_mods1r``                1    0         False     False     4         2.38, 2.5, 2.46, 2.81       3.78, 4.04, 4.74, 4.14  0.4       -1.0e+10  65535.0       0.9900     0.1230    
``lbt_mods2b``                1    0         True      False     4         1.99, 2.06, 1.96, 2.01      3.66, 3.62, 3.72, 3.64  0.5       -1.0e+10  65535.0       0.9900     0.1200    
``lbt_mods2r``                1    0         False     False     4         1.7, 1.67, 1.66, 1.66       2.95, 2.65, 2.78, 2.87  0.4       -1.0e+10  65535.0       0.9900     0.1230    
``ldt_deveny``                1    1         True      False     1         ``None``                    ``None``                4.5       -1.0e+10  65535.0       1.0000     0.3400    
``magellan_fire``             1    1         True      False     1         1.2                         5.0                     0.01      -1.0e+10  100000.0      1.0000     0.1800    
``magellan_fire_long``        1    0         False     False     1         3.8                         6.0                     0.01      -1.0e+10  320000.0      0.8750     0.1500    
``magellan_mage``             1    1         True      False     1         1.02                        2.9                     1.0       -1.0e+10  65535.0       0.9900     0.3000    
``mdm_osmos_mdm4k``           1    1         True      False     4         2.2, 2.2, 2.2, 2.2          5.0, 5.0, 5.0, 5.0      0.0       -1.0e+10  65535.0       0.8600     0.2730    
``mmt_binospec``              1    0         False     False     4         1.085, 1.046, 1.042, 0.975  3.2, 3.2, 3.2, 3.2      3.0       -1.0e+10  65535.0       0.9500     0.2400    
...                           2    0         False     False     4         1.028, 1.115, 1.047, 1.045  3.6, 3.6, 3.6, 3.6      3.0       -1.0e+10  65535.0       0.9500     0.2400    
``mmt_bluechannel``           1    0         False     False     1         ``None``                    ``None``                0.0       -1.0e+10  65535.0       0.9500     0.3000    
``mmt_mmirs``                 1    0         False     False     1         0.95                        3.14                    0.01      -1.0e+10  700000.0      1.0000     0.2012    
``not_alfosc``                1    0         True      False     1         ``None``                    ``None``                1.3       -1.0e+10  700000.0      0.8600     0.2138    
``ntt_efosc2``                1    0         False     False     1         0.91                        10.0                    0.0       -1.0e+10  65535         0.8000     0.1200    
``p200_dbsp_blue``            1    0         True      False     1         0.72                        2.5                     0.0       -1.0e+10  65000.0       0.9538     0.3890    
``p200_dbsp_red``             1    1         False     False     1         2.8                         8.5                     0.0       -1.0e+10  45000.0       0.8889     0.2930    
``p200_tspec``                1    1         True      False     1         3.8                         3.5                     0.085     -1.0e+10  28000         0.9000     0.3700    
``shane_kast_blue``           1    1         False     False     2         1.2, 1.2                    3.7, 3.7                0.0       -1.0e+10  65535.0       0.7600     0.4300    
``shane_kast_red``            1    0         False     False     2         1.9, 1.9                    3.8, 3.8                0.0       -1.0e+10  65535.0       0.7600     0.4300    
``shane_kast_red_ret``        1    1         False     False     1         3.0                         12.5                    0.0       -1.0e+10  120000.0      0.7600     0.7740    
``soar_goodman_red``          1    1         False     False     1         ``None``                    ``None``                8e-05     -1.0e+10  65535.0       1.0000     0.1500    
``tng_dolores``               1    1         False     False     1         0.97                        9.0                     0.0       -1.0e+10  65535.0       0.7600     0.2520    
``vlt_fors2``                 1    1         False     False     1         0.7                         2.9                     0.0       -1.0e+10  200000.0      0.8000     0.1260    
...                           2    1         False     False     1         0.7                         3.0                     0.0       -1.0e+10  200000.0      0.8000     0.1260    
``vlt_sinfoni``               1    0         True      False     1         2.42                        7.0                     0.15      -1.0e+10  1000000000.0  1.0000     0.0125    
``vlt_xshooter_nir``          1    1         False     False     1         2.12                        8.0                     0.0       -1.0e+10  200000.0      0.8600     0.1970    
``vlt_xshooter_uvb``          1    0         True      True      1         1.61                        2.6                     0.0       -1.0e+10  65000.0       0.8600     0.1610    
``vlt_xshooter_vis``          1    0         False     False     1         0.595                       3.1                     0.0       -1.0e+10  65535.0       0.8600     0.1600    
``wht_isis_blue``             1    0         False     False     1         1.2                         5.0                     0.0       -1.0e+10  65535.0       0.7600     0.2000    
``wht_isis_red``              1    0         False     False     1         0.98                        4.0                     0.0       -1.0e+10  65535.0       0.7600     0.2200    
============================  ===  ========  ========  ========  ========  ==========================  ======================  ========  ========  ============  =========  ==========

Version 1.1.0

=================  =================  ==========  ======================
HDU Name           Obj Type           Array Type  Description           
=================  =================  ==========  ======================
``TILT_IMAGE``     ndarray            floating    Primary image data    
``TILT_FULLMASK``  ndarray            integer     Full image bitmask    
``TILT_DETECTOR``  DetectorContainer              Detector DataContainer
=================  =================  ==========  ======================

Bitmasks allow you to define a set of bit values signified by strings,
and then toggle and interpret bits held by a `numpy.ndarray`_.  For
example, say you're processing an image and you want to set up a set of
bits that indicate that the pixel is part of a bad-pixel mask, has a
cosmic ray, or is saturated.  You can define the following::

    from pypeit.bitmask import BitMask

    bits = {'BPM':'Pixel is part of a bad-pixel mask',
            'COSMIC':'Pixel is contaminated by a cosmic ray',
            'SATURATED':'Pixel is saturated.'}
    image_bm = BitMask(list(bits.keys()), descr=list(bits.values()))

.. note::

    Consistency in the order of the dictionary keywords is *critical*
    to the repeatability of the :class:`~pypeit.bitmask.BitMask`
    instances. The above is possible because :obj:`dict` objects
    automatically maintain the order of the provided keywords since
    Python 3.7, the minimum required version for ``PypeIt``.
    
Or, better yet, define a derived class::

    from pypeit.bitmask import BitMask

    class ImageBitMask(BitMask):
        def __init__(self):
            bits = {'BPM':'Pixel is part of a bad-pixel mask',
                    'COSMIC':'Pixel is contaminated by a cosmic ray',
                    'SATURATED':'Pixel is saturated.'}
            super(ImageBitMask, self).__init__(list(bits.keys()), descr=list(bits.values()))

    image_bm = ImageBitMask()

In either case, you can see the list of bits and their bit numbers by
running::

    >>> image_bm.info()
             Bit: BPM = 0
     Description: Pixel is part of a bad-pixel mask

             Bit: COSMIC = 1
     Description: Pixel is contaminated by a cosmic ray

             Bit: SATURATED = 2
     Description: Pixel is saturated.
    >>> image_bm.bits
    {'BPM': 0, 'COSMIC': 1, 'SATURATED': 2}
    >>> image_bm.keys()
    ['BPM', 'COSMIC', 'SATURATED']

Now you can define a `numpy.ndarray`_ to hold the mask value for each
image pixel; the :func:`~pypeit.bitmask.BitMask.minimum_dtype`
returns the the smallest data type required to represent the list of
defined bits. The maximum number of bits that can be defined is 64.
Assuming you have an image ``img``::

    import numpy
    mask = numpy.zeros(img.shape, dtype=image_bm.minimum_dtype())

Assuming you have boolean or integer arrays that identify pixels to
mask, you can turn on the mask bits as follows::

    mask[cosmics_indx] = image_bm.turn_on(mask[cosmics_indx], 'COSMIC')
    mask[saturated_indx] = image_bm.turn_on(mask[saturated_indx], 'SATURATED')

or make sure certain bits are off::

    mask[not_a_cosmic] = image_bm.turn_off(mask[not_a_cosmic], 'COSMIC')

The form of these methods is such that the array passed to the method
are not altered.  Instead the altered bits are returned, which is why
the lines above have the form ``m = bm.turn_on(m, flag)``.

Some other short usage examples:

    - To find which flags are set for a single value::
        
        image_bm.flagged_bits(mask[0,10])

    - To find the list of unique flags set for any pixel::

        unique_flags = numpy.sort(numpy.unique(numpy.concatenate(
                            [image_bm.flagged_bits(b) for b in numpy.unique(mask)]))).tolist()

    - To get a boolean array that selects pixels with one or more
      mask bits::

        cosmics_indx = image_bm.flagged(mask, flag='COSMIC')
        all_but_bpm_indx = image_bm.flagged(mask, flag=['COSMIC', 'SATURATED'])
        any_flagged = image_bm.flagged(mask)

    - To construct masked arrays, following from the examples above::

        masked_img = numpy.ma.MaskedArray(img, mask=image_bm.flagged(mask))

:class:`~pypeit.bitmask.BitMask` objects can be defined
programmatically, as shown above for the ``ImageBitMask`` derived class,
but they can also be defined by reading formatted files.  The current
options are:

    #. Fits headers: There are both reading and writing methods for
       bitmask I/O using `astropy.io.fits.Header`_ objects.  Using the
       ``ImageBitMask`` class as an example::
       
            >>> from astropy.io import fits
            >>> hdr = fits.Header()
            >>> image_bm = ImageBitMask()
            >>> image_bm.to_header(hdr)
            >>> hdr
            BIT0    = 'BPM     '           / Pixel is part of a bad-pixel mask
            BIT1    = 'COSMIC  '           / Pixel is contaminated by a cosmic ray
            BIT2    = 'SATURATED'          / Pixel is saturated.
            >>> copy_bm = BitMask.from_header(hdr)



Version: 1.1.4

======================  =================  =================  ====================================================================================================================================================================================
Obj Key                 Obj Type           Array Type         Description                                                                                                                                                                         
======================  =================  =================  ====================================================================================================================================================================================
``BOX_CHI2``            ndarray            float              Reduced chi2 of the model fit for this spectral pixel                                                                                                                               
``BOX_COUNTS``          ndarray            float              Boxcar flux (counts)                                                                                                                                                                
``BOX_COUNTS_IVAR``     ndarray            float              Inverse variance of optimally extracted flux using modelivar image (counts^2)                                                                                                       
``BOX_COUNTS_NIVAR``    ndarray            float              Boxcar extracted noise variance, sky+read noise only (counts^2)                                                                                                                     
``BOX_COUNTS_SIG``      ndarray            float              Boxcar extracted noise from IVAR (counts)                                                                                                                                           
``BOX_COUNTS_SIG_DET``  ndarray            float              Boxcar extracted detector noise (counts)                                                                                                                                            
``BOX_COUNTS_SKY``      ndarray            float              Boxcar extracted sky (counts)                                                                                                                                                       
``BOX_FLAM``            ndarray            float              Boxcar flux (erg/s/cm^2/Ang)                                                                                                                                                        
``BOX_FLAM_IVAR``       ndarray            float              Boxcar flux inverse variance (1e-17 erg/s/cm^2/Ang)^-2                                                                                                                              
``BOX_FLAM_SIG``        ndarray            float              Boxcar flux uncertainty (1e-17 erg/s/cm^2/Ang)                                                                                                                                      
``BOX_FRAC_USE``        ndarray            float              Fraction of pixels in the object profile subimage used for this extraction                                                                                                          
``BOX_MASK``            ndarray            bool               Mask for boxcar extracted flux. True=good                                                                                                                                           
``BOX_NPIX``            ndarray            float              Number of pixels used for the boxcar extraction; can be fractional                                                                                                                  
``BOX_RADIUS``          float                                 Size of boxcar radius (pixels)                                                                                                                                                      
``BOX_WAVE``            ndarray            float              Boxcar Wavelengths in vacuum (Angstroms)                                                                                                                                            
``DEC``                 float                                 Declination (J2000) decimal degree                                                                                                                                                  
``DET``                 int, integer                          Detector number                                                                                                                                                                     
``DETECTOR``            DetectorContainer                     Detector DataContainer                                                                                                                                                              
``ECH_FRACPOS``         float, floating                       Synced echelle fractional location of the object on the slit                                                                                                                        
``ECH_NAME``            str                                   Name of the object for echelle data. Same as NAME above but order numbers are omitted giving a unique name per object.                                                              
``ECH_OBJID``           int, integer                          Object ID for echelle data. Each object is given an index in the order it appears increasing from from left to right. These are one based.                                          
``ECH_ORDER``           int, integer                          Physical echelle order                                                                                                                                                              
``ECH_ORDERINDX``       int, integer                          Order indx, analogous to SLITID for echelle. Zero based.                                                                                                                            
``FLEX_SHIFT_GLOBAL``   float                                 Global shift of the spectrum to correct for spectralflexure (pixels). This is based on the sky spectrum atthe center of the slit                                                    
``FLEX_SHIFT_LOCAL``    float                                 Local shift of the spectrum to correct for spectralflexure (pixels). This should be a small correction tothe global value, and is based on the sky spectrumextracted near the object
``FLEX_SHIFT_TOTAL``    float                                 Total shift of the spectrum to correct for spectralflexure (pixels). This is the sum of the global andlocal FLEX_SHIFT                                                              
``FWHM``                float                                 Spatial FWHM of the object (pixels)                                                                                                                                                 
``FWHMFIT``             ndarray                               Spatial FWHM across the detector (pixels)                                                                                                                                           
``MASKDEF_EXTRACT``     bool                                  Boolean indicating if this is a forced extraction at the expected location from slitmask design.                                                                                    
``MASKDEF_ID``          int, integer                          Slitmask definition ID                                                                                                                                                              
``MASKDEF_OBJNAME``     str                                   Name of the object from the slitmask definition                                                                                                                                     
``NAME``                str                                   Name of the object following the naming model                                                                                                                                       
``OBJID``               int, integer                          Object ID for multislit data. Each object is given an index for the slit it appears increasing from from left to right. These are one based.                                        
``OBJTYPE``             str                                   PypeIt type of object (standard, science)                                                                                                                                           
``OPT_CHI2``            ndarray            float              Reduced chi2 of the model fit for this spectral pixel                                                                                                                               
``OPT_COUNTS``          ndarray            float              Optimal flux (counts)                                                                                                                                                               
``OPT_COUNTS_IVAR``     ndarray            float              Inverse variance of optimally extracted flux using modelivar image (counts^2)                                                                                                       
``OPT_COUNTS_NIVAR``    ndarray            float              Optimally extracted noise variance, sky+read noise only (counts^2)                                                                                                                  
``OPT_COUNTS_SIG``      ndarray            float              Optimally extracted noise from IVAR (counts)                                                                                                                                        
``OPT_COUNTS_SIG_DET``  ndarray            float              Optimally extracted detector noise (counts)                                                                                                                                         
``OPT_COUNTS_SKY``      ndarray            float              Optimally extracted sky (counts)                                                                                                                                                    
``OPT_FLAM``            ndarray            float              Optimal flux (1e-17 erg/s/cm^2/Ang)                                                                                                                                                 
``OPT_FLAM_IVAR``       ndarray            float              Optimal flux inverse variance (1e-17 erg/s/cm^2/Ang)^-2                                                                                                                             
``OPT_FLAM_SIG``        ndarray            float              Optimal flux uncertainty (1e-17 erg/s/cm^2/Ang)                                                                                                                                     
``OPT_FRAC_USE``        ndarray            float              Fraction of pixels in the object profile subimage used for this extraction                                                                                                          
``OPT_MASK``            ndarray            bool               Mask for optimally extracted flux. True=good                                                                                                                                        
``OPT_WAVE``            ndarray            float              Optimal Wavelengths in vacuum (Angstroms)                                                                                                                                           
``PYPELINE``            str                                   Name of the PypeIt pipeline mode                                                                                                                                                    
``RA``                  float                                 Right Ascension (J2000) decimal degree                                                                                                                                              
``SLITID``              int, integer                          PypeIt slit ID (aka SPAT_ID).                                                                                                                                                       
``SPAT_FRACPOS``        float, floating                       Fractional location of the object on the slit                                                                                                                                       
``SPAT_PIXPOS``         float, floating                       Spatial location of the trace on detector (pixel) at half-way                                                                                                                       
``TRACE_SPAT``          ndarray            float              Object trace along the spec (spatial pixel)                                                                                                                                         
``VEL_CORR``            float                                 Relativistic velocity correction for wavelengths                                                                                                                                    
``VEL_TYPE``            str                                   Type of heliocentric correction (if any)                                                                                                                                            
``WAVE_RMS``            float, floating                       RMS (pix) for the wavelength solution for this slit.                                                                                                                                
``hand_extract_flag``   bool                                  Boolean indicating if this is a forced extraction at the location provided by the user.                                                                                             
``maskwidth``           float, floating                       Size (in units of fwhm) of the region used for local sky subtraction                                                                                                                
``trace_spec``          ndarray            int,numpy.integer  Array of pixels along the spectral direction                                                                                                                                        
======================  =================  =================  ====================================================================================================================================================================================
.. code-block:: console

    $ pypeit_identify -h
    usage: pypeit_identify [-h] [--lamps LAMPS] [-s] [--wmin WMIN] [--wmax WMAX]
                           [--slit SLIT] [--det DET] [--rmstol RMSTOL] [--fwhm FWHM]
                           [--pixtol PIXTOL] [--test] [--force_save]
                           arc_file slits_file
    
    Launch PypeIt identify tool, display extracted MasterArc, and load linelist.Run
    above the Masters/ folder.
    
    positional arguments:
      arc_file         PypeIt MasterArc file
      slits_file       PypeIt MasterSlits file
    
    optional arguments:
      -h, --help       show this help message and exit
      --lamps LAMPS    Comma separated list of calibration lamps (no spaces)
                       (default: None)
      -s, --solution   Load a wavelength solution from the arc_file (if it exists)
                       (default: False)
      --wmin WMIN      Minimum wavelength range (default: 3000.0)
      --wmax WMAX      Maximum wavelength range (default: 10000.0)
      --slit SLIT      Which slit to load for wavelength calibration (default: 0)
      --det DET        Detector index (default: 1)
      --rmstol RMSTOL  RMS tolerance (default: 0.1)
      --fwhm FWHM      FWHM for line finding (default: 4.0)
      --pixtol PIXTOL  Pixel tolerance for Auto IDs (default: 0.1)
      --test           Unit tests? (default: False)
      --force_save     Save the solutions, despite the RMS (default: False)
    .. code-block:: console

    $ pypeit_flux_setup -h
    usage: pypeit_flux_setup [-h] [--objmodel {qso,star,poly}] sci_path
    
    Setup to perform flux calibration
    
    positional arguments:
      sci_path              Path for Science folder
    
    optional arguments:
      -h, --help            show this help message and exit
      --objmodel {qso,star,poly}
                            science object model used in the telluric fitting. The
                            options are:
                             
                            qso = For quasars. You might need to set redshift,
                            bal_wv_min_max in the tell file.
                             
                            star = For stars. You need to set star_type, star_ra,
                            star_dec, and star_mag in the tell_file.
                             
                            poly = For other type object, You might need to set
                            fit_wv_min_max, and norder in the tell_file.
                             
    .. code-block:: console

    $ pypeit_coadd_2dspec -h
    usage: pypeit_coadd_2dspec [-h] [--file FILE] [--det DET] [--obj OBJ] [--show]
                               [--debug_offsets] [--peaks] [--basename BASENAME]
                               [--spec_samp_fact SPEC_SAMP_FACT]
                               [--spat_samp_fact SPAT_SAMP_FACT] [--debug]
    
    Coadd 2D spectra produced by PypeIt
    
    optional arguments:
      -h, --help            show this help message and exit
      --file FILE           File to guide 2d coadds (default: None)
      --det DET             Only coadd data from this detector (1-indexed) (default:
                            None)
      --obj OBJ             Object name in lieu of extension, e.g if the spec2d
                            files are named
                            'spec2d_J1234+5678_GNIRS_2017Mar31T085412.181.fits' then
                            use --obj J1234+5678 (default: None)
      --show                Show the reduction steps. Equivalent to the -s option
                            when running pypeit. (default: False)
      --debug_offsets       Show QA plots useful for debugging automatic offset
                            determination (default: False)
      --peaks               Show the peaks found by the object finding algorithm.
                            (default: False)
      --basename BASENAME   Basename of files to save the parameters, spec1d, and
                            spec2d (default: None)
      --spec_samp_fact SPEC_SAMP_FACT
                            Make the wavelength grid finer (spec_samp_fact < 1.0) or
                            coarser (spec_samp_fact > 1.0) by this sampling factor,
                            i.e. units of spec_samp_fact are pixels. (default: 1.0)
      --spat_samp_fact SPAT_SAMP_FACT
                            Make the spatial grid finer (spat_samp_fact < 1.0) or
                            coarser (spat_samp_fact > 1.0) by this sampling factor,
                            i.e. units of spat_samp_fact are pixels. (default: 1.0)
      --debug               show debug plots? (default: False)
    .. code-block:: console

    $ pypeit_install_ql_masters -h
    usage: pypeit_install_ql_masters [-h] [--zip ZIP | --ql_path QL_PATH]
                                     [--odir ODIR] [--rmzip]
    
    Script to install PypeIt QL Master files
    
    optional arguments:
      -h, --help         show this help message and exit
      --zip ZIP          Zip file of the full QL_MASTERS directory downloaded from
                         the PypeIt Google Drive (default: None)
      --ql_path QL_PATH  An existing directory to symlink as the QL_MASTERS
                         directory. (default: None)
      --odir ODIR        The directory in which to extract the zip file. Ignored if
                         a direct path is provided using --ql_path. (default:
                         /Users/westfall/Work/packages/pypeit/doc)
      --rmzip            Remove the downloaded zip file (default: False)
    .. code-block:: console

    $ pypeit_show_wvcalib -h
    usage: pypeit_show_wvcalib [-h] file slit
    
    Show the result of wavelength calibration
    
    positional arguments:
      file        WaveCalib JSON file
      slit
    
    optional arguments:
      -h, --help  show this help message and exit
    .. code-block:: console

    $ pypeit_show_1dspec -h
    usage: pypeit_show_1dspec [-h] [--list] [--exten EXTEN] [--obj OBJ]
                              [--extract EXTRACT] [--flux]
                              file
    
    Show a 1D spectrum
    
    positional arguments:
      file               Spectral file
    
    optional arguments:
      -h, --help         show this help message and exit
      --list             List the extensions only? (default: False)
      --exten EXTEN      FITS extension (default: 1)
      --obj OBJ          Object name in lieu of extension, e.g.
                         SPAT0424-SLIT0000-DET01 (default: None)
      --extract EXTRACT  Extraction method. Default is OPT. ['BOX', 'OPT'] (default:
                         OPT)
      --flux             Show fluxed spectrum? (default: False)
    .. code-block:: console

    $ pypeit_chk_wavecalib -h
    usage: pypeit_chk_wavecalib [-h] master_file
    
    Print QA on Wavelength Calib to the screen
    
    positional arguments:
      master_file  PypeIt MasterWaveCalib file [e.g. MasterWaveCalib_A_1_01.fits]
    
    optional arguments:
      -h, --help   show this help message and exit
    .. code-block:: console

    $ pypeit_lowrdx_skyspec -h
    usage: pypeit_lowrdx_skyspec [-h] lowrdx_sky new_file
    
    Print info on slits from a spec2D file
    
    positional arguments:
      lowrdx_sky  LowRedux Sky Spectrum (IDL save file)
      new_file    PYPIT FITS sky spectrum
    
    optional arguments:
      -h, --help  show this help message and exit
    .. code-block:: console

    $ pypeit_ql_keck_mosfire -h
    usage: pypeit_ql_keck_mosfire [-h] [--spec_samp_fact SPEC_SAMP_FACT]
                                  [--spat_samp_fact SPAT_SAMP_FACT] [--flux]
                                  [--mask_cr] [--writefits] [--no_gui]
                                  [--box_radius BOX_RADIUS] [--offset OFFSET]
                                  [--redux_path REDUX_PATH]
                                  [--master_dir MASTER_DIR] [--embed] [--show]
                                  full_rawpath files [files ...]
    
    Script to produce quick-look PypeIt reductions on a pair of MOSFIRE files (A-B)
    
    positional arguments:
      full_rawpath          Full path to the raw files
      files                 list of frames i.e. img1.fits img2.fits
    
    optional arguments:
      -h, --help            show this help message and exit
      --spec_samp_fact SPEC_SAMP_FACT
                            Make the wavelength grid finer (spec_samp_fact < 1.0) or
                            coarser (spec_samp_fact > 1.0) by this sampling factor,
                            i.e. units of spec_samp_fact are pixels. (default: 1.0)
      --spat_samp_fact SPAT_SAMP_FACT
                            Make the spatial grid finer (spat_samp_fact < 1.0) or
                            coarser (spat_samp_fact > 1.0) by this sampling factor,
                            i.e. units of spat_samp_fact are pixels. (default: 1.0)
      --flux                This option will multiply in sensitivity function to
                            obtain a flux calibrated 2d spectrum (default: False)
      --mask_cr             This option turns on cosmic ray rejection. This improves
                            the reduction but doubles runtime. (default: False)
      --writefits           Write the ouputs to a fits file (default: False)
      --no_gui              Do not display the results in a GUI (default: False)
      --box_radius BOX_RADIUS
                            Set the radius for the boxcar extraction (default: None)
      --offset OFFSET       Override the automatic offsets determined from the
                            headers. Offset is in pixels. This option is useful if a
                            standard dither pattern was not executed. The offset
                            convention is such that a negative offset will move the
                            (negative) B image to the left. (default: None)
      --redux_path REDUX_PATH
                            Location where reduction outputs should be stored.
                            (default: /Users/westfall/Work/packages/pypeit/doc)
      --master_dir MASTER_DIR
                            Location of PypeIt Master files used for the reduction.
                            (default: None)
      --embed               Upon completion embed in ipython shell (default: False)
      --show                Show the reduction steps. Equivalent to the -s option
                            when running pypeit. (default: False)
    .. code-block:: console

    $ pypeit_tellfit -h
    usage: pypeit_tellfit [-h] [--objmodel {qso,star,poly}] [-r REDSHIFT]
                          [-g TELL_GRID] [-p PCA_FILE] [-t TELL_FILE] [--debug]
                          [--plot] [--par_outfile PAR_OUTFILE]
                          spec1dfile
    
    Telluric correct a spectrum
    
    positional arguments:
      spec1dfile            spec1d file that will be used for telluric correction.
    
    optional arguments:
      -h, --help            show this help message and exit
      --objmodel {qso,star,poly}
                            science object model used in the fitting. The options
                            are:
                             
                            qso = For quasars. You might need to set redshift,
                            bal_wv_min_max in the tell file.
                             
                            star = For stars. You need to set star_type, star_ra,
                            star_dec, and star_mag in the tell_file.
                             
                            poly = For other type object, You might need to set
                            fit_wv_min_max, and norder in the tell_file.
                             
      -r REDSHIFT, --redshift REDSHIFT
                            Specify redshift. Used with the --objmodel qso option
                            above.
      -g TELL_GRID, --tell_grid TELL_GRID
                            Telluric grid. You should download the giant grid file
                            to the pypeit/data/telluric folder. It should only be
                            passed if you want to overwrite the default tell_grid
                            that is set via each spectrograph file.
      -p PCA_FILE, --pca_file PCA_FILE
                            Quasar PCA fits file with full path. The default file
                            (qso_pca_1200_3100.fits) is stored in the
                            pypeit/data/telluric folder. If you change the fits
                            file, make sure to set the pca_lower and pca_upper in
                            the tell_file to specify the wavelength coverage of your
                            model. The defaults are pca_lower=1220. and
                            pca_upper=3100.
      -t TELL_FILE, --tell_file TELL_FILE
                            Configuration file to change default telluric
                            parameters.  Note that the parameters in this file will
                            be overwritten if you set argument in your terminal.
                            The --tell_file option requires a .tell file with the
                            following format:
                             
                                [telluric]
                                     objmodel = qso
                                     redshift = 7.6
                                     bal_wv_min_max = 10825,12060
                            OR
                                [telluric]
                                     objmodel = star
                                     star_type = A0
                                     star_mag = 8.
                            OR
                                [telluric]
                                     objmodel = poly
                                     polyorder = 3
                                     fit_wv_min_max = 9000.,9500.
                             
      --debug               show debug plots?
      --plot                Show the telluric corrected spectrum
      --par_outfile PAR_OUTFILE
                            Name of output file to save the parameters used by the
                            fit
    .. code-block:: console

    $ pypeit_coadd_datacube -h
    usage: pypeit_coadd_datacube [-h] [--det DET] [-o] file
    
    Read in an array of spec2D files and convert them into a datacube
    
    positional arguments:
      file             filename.coadd3d file
    
    optional arguments:
      -h, --help       show this help message and exit
      --det DET        Detector (default: 1)
      -o, --overwrite  Overwrite any existing files/directories (default: False)
    .. code-block:: console

    $ pypeit_coadd_1dspec -h
    usage: pypeit_coadd_1dspec [-h] [--debug] [--show] [--par_outfile PAR_OUTFILE]
                               [--test_spec_path TEST_SPEC_PATH]
                               coadd1d_file
    
    Coadd 1D spectra produced by PypeIt
    
    positional arguments:
      coadd1d_file          File to guide coadding process. This file must have the
                            following format:
                             
                            [coadd1d]
                               coaddfile='output_filename.fits'
                               sensfuncfile = 'sensfunc.fits' # Required only for Echelle
                             
                               coadd1d read
                                 spec1dfile1 objid1
                                 spec1dfile2 objid2
                                 spec1dfile3 objid3
                                    ...    
                               coadd1d end
                             
                             OR the coadd1d read/end block can look like
                             
                              coadd1d read
                                 spec1dfile1 objid 
                                 spec1dfile2 
                                 spec1dfile3 
                                 ...    
                              coadd1d end
                             
                            That is the coadd1d block must either be a two column
                            list of spec1dfiles and objids, or you can specify a
                            single objid for all spec1dfiles on the first line
                             
                            Where:
                             
                            spec1dfile: full path to a PypeIt spec1dfile
                             
                            objid: the object identifier. To determine the objids
                            inspect the spec1d_*.txt files or run pypeit_show_1dspec
                            spec1dfile --list
                             
    
    optional arguments:
      -h, --help            show this help message and exit
      --debug               show debug plots?
      --show                show QA during coadding process
      --par_outfile PAR_OUTFILE
                            Output to save the parameters
      --test_spec_path TEST_SPEC_PATH
                            Path for testing
    .. code-block:: console

    $ pypeit_chk_flats -h
    usage: pypeit_chk_flats [-h] [--type TYPE] [--try_old] master_file
    
    Display MasterFlat images in Ginga viewer
    
    positional arguments:
      master_file  PypeIt MasterFlat file [e.g. MasterFlat_A_1_01.fits]
    
    optional arguments:
      -h, --help   show this help message and exit
      --type TYPE  Which flats to display. Must be one of: pixel, illum, all
                   (default: all)
      --try_old    Attempt to load old datamodel versions. A crash may ensue..
                   (default: False)
    .. code-block:: console

    $ pypeit_flux_calib -h
    usage: pypeit_flux_calib [-h] [--debug] [--par_outfile] flux_file
    
    Flux calibrate 1D spectra produced by PypeIt
    
    positional arguments:
      flux_file      File to guide fluxing process.  This file must have the
                     following format:
                      
                     flux read
                       spec1dfile1 sensfile
                       spec1dfile2
                          ...    
                     flux end
                      
                     OR
                      
                     flux read
                       spec1dfile1 sensfile1
                       spec1dfile2 sensfile2
                       spec1dfile3 sensfile3
                          ...    
                     flux end
                      
                     That is, you must specify either a sensfile for all spec1dfiles
                     on the first line, or create a two column list of spec1dfiles
                     and corresponding sensfiles
                      
    
    optional arguments:
      -h, --help     show this help message and exit
      --debug        show debug plots?
      --par_outfile  Output to save the parameters
    .. code-block:: console

    $ pypeit_chk_edges -h
    usage: pypeit_chk_edges [-h] [--chname CHNAME] [--mpl] [--try_old] trace_file
    
    Display MasterEdges image and trace data
    
    positional arguments:
      trace_file       PypeIt Master Trace file [e.g. MasterEdges_A_01_aa.fits.gz]
    
    optional arguments:
      -h, --help       show this help message and exit
      --chname CHNAME  Channel name for image in Ginga (default: MTrace)
      --mpl            Use a matplotlib window instead of ginga to show the trace
                       (default: False)
      --try_old        Attempt to load old datamodel versions. A crash may ensue..
                       (default: False)
    .. code-block:: console

    $ pypeit_setup -h
    usage: pypeit_setup [-h] [-s SPECTROGRAPH] [-r ROOT] [-e EXTENSION]
                        [-d OUTPUT_PATH] [-o] [-c CFG_SPLIT] [-b] [-v VERBOSITY]
    
    Parse data files to construct a pypeit file in preparation for reduction using
    'run_pypeit'
    
    optional arguments:
      -h, --help            show this help message and exit
      -s SPECTROGRAPH, --spectrograph SPECTROGRAPH
                            A valid spectrograph identifier: bok_bc,
                            gemini_flamingos1, gemini_flamingos2,
                            gemini_gmos_north_e2v, gemini_gmos_north_ham,
                            gemini_gmos_north_ham_ns, gemini_gmos_south_ham,
                            gemini_gnirs, gtc_osiris, keck_deimos, keck_hires_red,
                            keck_kcwi, keck_lris_blue, keck_lris_blue_orig,
                            keck_lris_red, keck_lris_red_mark4, keck_lris_red_orig,
                            keck_mosfire, keck_nires, keck_nirspec_low, lbt_luci1,
                            lbt_luci2, lbt_mods1b, lbt_mods1r, lbt_mods2b,
                            lbt_mods2r, ldt_deveny, magellan_fire,
                            magellan_fire_long, magellan_mage, mdm_osmos_mdm4k,
                            mmt_binospec, mmt_bluechannel, mmt_mmirs, not_alfosc,
                            ntt_efosc2, p200_dbsp_blue, p200_dbsp_red, p200_tspec,
                            shane_kast_blue, shane_kast_red, shane_kast_red_ret,
                            soar_goodman_red, tng_dolores, vlt_fors2, vlt_sinfoni,
                            vlt_xshooter_nir, vlt_xshooter_uvb, vlt_xshooter_vis,
                            wht_isis_blue, wht_isis_red (default: None)
      -r ROOT, --root ROOT  Root to search for data files. You can provide the top-
                            level directory (e.g., /data/Kast) or the search string
                            up through the wildcard (.e.g, /data/Kast/b). Use the
                            --extension option to set the types of files to search
                            for. Default is the current working directory. (default:
                            /Users/westfall/Work/packages/pypeit/doc)
      -e EXTENSION, --extension EXTENSION
                            File extension; compression indicators (e.g. .gz) not
                            required. (default: .fits)
      -d OUTPUT_PATH, --output_path OUTPUT_PATH
                            Path to top-level output directory. (default:
                            /Users/westfall/Work/packages/pypeit/doc)
      -o, --overwrite       Overwrite any existing files/directories (default:
                            False)
      -c CFG_SPLIT, --cfg_split CFG_SPLIT
                            Generate the PypeIt files and folders by input
                            configuration. To write all unique configurations
                            identifed, use 'all', otherwise provide the list of
                            configuration letters; e.g., 'A,B' or 'B,D,E' or 'E'.
                            (default: None)
      -b, --background      Include the background-pair columns for the user to edit
                            (default: False)
      -v VERBOSITY, --verbosity VERBOSITY
                            Level of verbosity from 0 to 2. (default: 2)
    .. code-block:: console

    $ pypeit_show_2dspec -h
    usage: pypeit_show_2dspec [-h] [--list] [--det DET] [--showmask] [--removetrace]
                              [--embed] [--ignore_extract_mask]
                              [--sensfunc SENSFUNC] [--channels CHANNELS]
                              [--prefix PREFIX] [--no_clear]
                              file
    
    Display sky subtracted, spec2d image in a Ginga viewer. Run above the Science/
    folder
    
    positional arguments:
      file                  PYPIT spec2d file
    
    optional arguments:
      -h, --help            show this help message and exit
      --list                List the extensions only? (default: False)
      --det DET             Detector number (default: 1)
      --showmask            Overplot masked pixels (default: False)
      --removetrace         Do not overplot traces in the skysub, sky_resid, and
                            resid channels (default: False)
      --embed               Upon completion embed in ipython shell (default: False)
      --ignore_extract_mask
                            Ignore the extraction mask (default: False)
      --sensfunc SENSFUNC   Pass in a sensfunc to display the sky-subtracted image
                            with a flux calibration (default: None)
      --channels CHANNELS   Only show a subset of the channels (0-indexed), e.g. 1,3
                            (default: None)
      --prefix PREFIX       Append this to the channel name [let's you do more than
                            one set] (default: )
      --no_clear            Do *not* clear all existing tabs (default: True)
    .. code-block:: console

    $ run_pypeit -h
    usage: run_pypeit [-h] [-v VERBOSITY] [-t] [-r REDUX_PATH] [-m] [-s] [-o]
                      [-d DETECTOR] [-c]
                      pypeit_file
    
    ##  [1;37;42mPypeIt : The Python Spectroscopic Data Reduction Pipeline v1.6.1.dev77+gd460d041b.d20211118[0m
    ##  
    ##  Available spectrographs include:
    ##   bok_bc, gemini_flamingos1, gemini_flamingos2, gemini_gmos_north_e2v,
    ##   gemini_gmos_north_ham, gemini_gmos_north_ham_ns,
    ##   gemini_gmos_south_ham, gemini_gnirs, gtc_osiris, keck_deimos,
    ##   keck_hires_red, keck_kcwi, keck_lris_blue, keck_lris_blue_orig,
    ##   keck_lris_red, keck_lris_red_mark4, keck_lris_red_orig, keck_mosfire,
    ##   keck_nires, keck_nirspec_low, lbt_luci1, lbt_luci2, lbt_mods1b,
    ##   lbt_mods1r, lbt_mods2b, lbt_mods2r, ldt_deveny, magellan_fire,
    ##   magellan_fire_long, magellan_mage, mdm_osmos_mdm4k, mmt_binospec,
    ##   mmt_bluechannel, mmt_mmirs, not_alfosc, ntt_efosc2, p200_dbsp_blue,
    ##   p200_dbsp_red, p200_tspec, shane_kast_blue, shane_kast_red,
    ##   shane_kast_red_ret, soar_goodman_red, tng_dolores, vlt_fors2,
    ##   vlt_sinfoni, vlt_xshooter_nir, vlt_xshooter_uvb, vlt_xshooter_vis,
    ##   wht_isis_blue, wht_isis_red
    
    positional arguments:
      pypeit_file           PypeIt reduction file (must have .pypeit extension)
    
    optional arguments:
      -h, --help            show this help message and exit
      -v VERBOSITY, --verbosity VERBOSITY
                            Verbosity level between 0 [none] and 2 [all]
      -t, --hdrframetype    Use file headers and the instument-specific keywords to
                            determine the type of each frame
      -r REDUX_PATH, --redux_path REDUX_PATH
                            Path to directory for the reduction. Only advised for
                            testing
      -m, --do_not_reuse_masters
                            Do not load previously generated MasterFrames, even ones
                            made during the run.
      -s, --show            Show reduction steps via plots (which will block further
                            execution until clicked on) and outputs to ginga.
                            Requires remote control ginga session via "ginga
                            --modules=RC,SlitWavelength &"
      -o, --overwrite       Overwrite any existing files/directories
      -d DETECTOR, --detector DETECTOR
                            Detector to limit reductions on. If the output files
                            exist and -o is used, the outputs for the input detector
                            will be replaced.
      -c, --calib_only      Only run on calibrations
    .. code-block:: console

    $ pypeit_obslog -h
    usage: pypeit_obslog [-h] [-r ROOT] [-k] [-c COLUMNS] [-b] [-t BAD_TYPES] [-g]
                         [-i] [-s SORT] [-e EXTENSION] [-d OUTPUT_PATH] [-o]
                         [-f FILE]
                         spec
    
    Construct an observing log for a set of files from the provided spectrograph
    using PypeItMetaData.
    
    positional arguments:
      spec                  A valid spectrograph identifier: bok_bc,
                            gemini_flamingos1, gemini_flamingos2,
                            gemini_gmos_north_e2v, gemini_gmos_north_ham,
                            gemini_gmos_north_ham_ns, gemini_gmos_south_ham,
                            gemini_gnirs, gtc_osiris, keck_deimos, keck_hires_red,
                            keck_kcwi, keck_lris_blue, keck_lris_blue_orig,
                            keck_lris_red, keck_lris_red_mark4, keck_lris_red_orig,
                            keck_mosfire, keck_nires, keck_nirspec_low, lbt_luci1,
                            lbt_luci2, lbt_mods1b, lbt_mods1r, lbt_mods2b,
                            lbt_mods2r, ldt_deveny, magellan_fire,
                            magellan_fire_long, magellan_mage, mdm_osmos_mdm4k,
                            mmt_binospec, mmt_bluechannel, mmt_mmirs, not_alfosc,
                            ntt_efosc2, p200_dbsp_blue, p200_dbsp_red, p200_tspec,
                            shane_kast_blue, shane_kast_red, shane_kast_red_ret,
                            soar_goodman_red, tng_dolores, vlt_fors2, vlt_sinfoni,
                            vlt_xshooter_nir, vlt_xshooter_uvb, vlt_xshooter_vis,
                            wht_isis_blue, wht_isis_red
    
    optional arguments:
      -h, --help            show this help message and exit
      -r ROOT, --root ROOT  Root to search for data files. You can provide the top-
                            level directory (e.g., /data/Kast) or the search string
                            up through the wildcard (.e.g, /data/Kast/b). Use the
                            --extension option to set the types of files to search
                            for. Default is the current working directory. (default:
                            /Users/westfall/Work/packages/pypeit/doc)
      -k, --keys            Do not produce the log; simply list the pypeit-specific
                            metadata keys available for this spectrograph and their
                            associated header cards. Metadata keys with header cards
                            that are None have no simple mapping between keyword and
                            header card. (default: False)
      -c COLUMNS, --columns COLUMNS
                            A comma-separated list of columns to include in the
                            output table. Each column must be a valid pypeit
                            metadata keyword specific to this spectrograph (run
                            pypeit_obslog with the -k argument to see the valid
                            list). Additional valid keywords are directory,
                            filename, frametype, framebit, setup, calib, and
                            calibbit. If 'all', all columns collected for the pypeit
                            metadata table are included. If 'pypeit', the columns
                            are the same as those included in the pypeit file.
                            (default: pypeit)
      -b, --bad_frames      Clean the output of bad frames that cannot be reduced by
                            pypeit. (default: False)
      -t BAD_TYPES, --bad_types BAD_TYPES
                            Dictates how frames that could not be given a valid type
                            should be treated. Options are: "keep" to include them
                            in the output, "rm" to remove them from the output,
                            "only" to only include the frames with unknown types in
                            the output (i.e, the frames with determined types are
                            excluded). (default: keep)
      -g, --groupings       Use this option to only determine the frame type. By
                            default, the script groups frames into expected
                            configuration and calibration groups, and it adds the
                            default combination groups. (default: True)
      -i, --interact        Once the metadata table is created, start an embedded
                            IPython session that you can use to interact with the
                            table (an Astropy.Table called fitstbl) directly.
                            (default: False)
      -s SORT, --sort SORT  Metadata keyword (pypeit-specific) to use to sort the
                            output table. (default: mjd)
      -e EXTENSION, --extension EXTENSION
                            File extension; compression indicators (e.g. .gz) not
                            required. (default: .fits)
      -d OUTPUT_PATH, --output_path OUTPUT_PATH
                            Path to top-level output directory. (default:
                            /Users/westfall/Work/packages/pypeit/doc)
      -o, --overwrite       Overwrite any existing files/directories (default:
                            False)
      -f FILE, --file FILE  Name for the ascii output file. Any leading directory
                            path is stripped; use -d to set the output directory. If
                            None, the table is just printed to stdout. If set to
                            'default', the file is set to [spectrograph].obslog.
                            Note the file will *not* be written if you also include
                            the -i option to embed and interact with the table (you
                            can write the table using the astropy.table.Table.write
                            method in the embedded IPython session). The table is
                            always written in ascii format using
                            format=ascii.fixed_with for the call to
                            Astropy.table.Table.write . (default: None)
    .. code-block:: console

    $ pypeit_skysub_regions -h
    usage: pypeit_skysub_regions [-h] [--det DET] [-o] [-i] [-f] [-s] file
    
    Display a Raw science image and interactively define the sky regions using a
    GUI. Run in the same folder as your .pypeit file
    
    positional arguments:
      file             PypeIt file
    
    optional arguments:
      -h, --help       show this help message and exit
      --det DET        Detector (default: 1)
      -o, --overwrite  Overwrite any existing files/directories (default: False)
      -i, --initial    Use initial slit edges? (default: False)
      -f, --flexure    Use flexure corrected slit edges? (default: False)
      -s, --standard   List standard stars as well? (default: False)
    .. code-block:: console

    $ pypeit_chk_for_calibs -h
    usage: pypeit_chk_for_calibs [-h] [-s SPECTROGRAPH] [-e EXTENSION]
                                 [--save_setups]
                                 root
    
    Script to check for calibrations
    
    positional arguments:
      root                  File path+root, e.g. /data/Kast/b
    
    optional arguments:
      -h, --help            show this help message and exit
      -s SPECTROGRAPH, --spectrograph SPECTROGRAPH
                            A valid spectrograph identifier: bok_bc,
                            gemini_flamingos1, gemini_flamingos2,
                            gemini_gmos_north_e2v, gemini_gmos_north_ham,
                            gemini_gmos_north_ham_ns, gemini_gmos_south_ham,
                            gemini_gnirs, gtc_osiris, keck_deimos, keck_hires_red,
                            keck_kcwi, keck_lris_blue, keck_lris_blue_orig,
                            keck_lris_red, keck_lris_red_mark4, keck_lris_red_orig,
                            keck_mosfire, keck_nires, keck_nirspec_low, lbt_luci1,
                            lbt_luci2, lbt_mods1b, lbt_mods1r, lbt_mods2b,
                            lbt_mods2r, ldt_deveny, magellan_fire,
                            magellan_fire_long, magellan_mage, mdm_osmos_mdm4k,
                            mmt_binospec, mmt_bluechannel, mmt_mmirs, not_alfosc,
                            ntt_efosc2, p200_dbsp_blue, p200_dbsp_red, p200_tspec,
                            shane_kast_blue, shane_kast_red, shane_kast_red_ret,
                            soar_goodman_red, tng_dolores, vlt_fors2, vlt_sinfoni,
                            vlt_xshooter_nir, vlt_xshooter_uvb, vlt_xshooter_vis,
                            wht_isis_blue, wht_isis_red (default: None)
      -e EXTENSION, --extension EXTENSION
                            File extension; compression indicators (e.g. .gz) not
                            required. (default: .fits)
      --save_setups         If not toggled, remove setup_files/ folder and its
                            files. (default: False)
    .. code-block:: console

    $ pypeit_compare_sky -h
    usage: pypeit_compare_sky [-h] [--exten EXTEN] [--optimal]
                              [--scale_user SCALE_USER] [--test]
                              file skyfile
    
    Compare the extracted sky spectrum against an archived sky model maintained by
    PypeIt.
    
    positional arguments:
      file                  spec1d Spectral file
      skyfile               Archived PypeIt sky file (e.g. paranal_sky.fits)
    
    optional arguments:
      -h, --help            show this help message and exit
      --exten EXTEN         FITS extension (default: None)
      --optimal             Show Optimal? Default is boxcar (default: False)
      --scale_user SCALE_USER
                            Scale user spectrum by a factor (default: 1.0)
      --test                Load files but do not show plot (default: False)
    .. code-block:: console

    $ pypeit_show_arxiv -h
    usage: pypeit_show_arxiv [-h] [--det DET] file
    
    Show an archived arc spectrum located in pypeit/data/arc_liens/reid_arxiv
    
    positional arguments:
      file        Arxiv filename, e.g. gemini_gmos_r831_ham.fits
    
    optional arguments:
      -h, --help  show this help message and exit
      --det DET   Detector number (default: 1)
    .. code-block:: console

    $ pypeit_install_telluric -h
    usage: pypeit_install_telluric [-h] [--path PATH]
    
    Script to install PypeIt telluric files
    
    optional arguments:
      -h, --help   show this help message and exit
      --path PATH  Path to directory with TelFit files downloaded from the PypeIt
                   Google Drive Telluric/ folder (default:
                   /Users/westfall/Work/packages/pypeit/doc)
    .. code-block:: console

    $ pypeit_trace_edges -h
    usage: pypeit_trace_edges [-h] (-f PYPEIT_FILE | -t TRACE_FILE) [-g GROUP]
                              [-d DETECTOR] [-s SPECTROGRAPH] [-b BINNING]
                              [-p REDUX_PATH] [-m MASTER_DIR] [-o] [--debug]
                              [--show]
    
    Trace slit edges
    
    optional arguments:
      -h, --help            show this help message and exit
      -f PYPEIT_FILE, --pypeit_file PYPEIT_FILE
                            PypeIt reduction file (default: None)
      -t TRACE_FILE, --trace_file TRACE_FILE
                            Image to trace (default: None)
      -g GROUP, --group GROUP
                            If providing a pypeit file, use the trace images for
                            this calibration group. If None, use the first
                            calibration group. (default: None)
      -d DETECTOR, --detector DETECTOR
                            Only analyze the specified detector; otherwise analyze
                            all or detectors selected by the pypeit file, if
                            provided. (default: None)
      -s SPECTROGRAPH, --spectrograph SPECTROGRAPH
                            A valid spectrograph identifier, which is only used if
                            providing files directly: bok_bc, gemini_flamingos1,
                            gemini_flamingos2, gemini_gmos_north_e2v,
                            gemini_gmos_north_ham, gemini_gmos_north_ham_ns,
                            gemini_gmos_south_ham, gemini_gnirs, gtc_osiris,
                            keck_deimos, keck_hires_red, keck_kcwi, keck_lris_blue,
                            keck_lris_blue_orig, keck_lris_red, keck_lris_red_mark4,
                            keck_lris_red_orig, keck_mosfire, keck_nires,
                            keck_nirspec_low, lbt_luci1, lbt_luci2, lbt_mods1b,
                            lbt_mods1r, lbt_mods2b, lbt_mods2r, ldt_deveny,
                            magellan_fire, magellan_fire_long, magellan_mage,
                            mdm_osmos_mdm4k, mmt_binospec, mmt_bluechannel,
                            mmt_mmirs, not_alfosc, ntt_efosc2, p200_dbsp_blue,
                            p200_dbsp_red, p200_tspec, shane_kast_blue,
                            shane_kast_red, shane_kast_red_ret, soar_goodman_red,
                            tng_dolores, vlt_fors2, vlt_sinfoni, vlt_xshooter_nir,
                            vlt_xshooter_uvb, vlt_xshooter_vis, wht_isis_blue,
                            wht_isis_red (default: None)
      -b BINNING, --binning BINNING
                            Image binning in spectral and spatial directions. Only
                            used if providing files directly; default is 1,1.
                            (default: None)
      -p REDUX_PATH, --redux_path REDUX_PATH
                            Path to top-level output directory. Default is the
                            current working directory. (default: None)
      -m MASTER_DIR, --master_dir MASTER_DIR
                            Name for directory in output path for Master file(s)
                            relative to the top-level directory. (default: Masters)
      -o, --overwrite       Overwrite any existing files/directories (default:
                            False)
      --debug               Run in debug mode. (default: False)
      --show                Show the stages of trace refinements (only for the new
                            code). (default: False)
    .. code-block:: console

    $ pypeit_qa_html -h
    usage: pypeit_qa_html [-h] [--qapath QAPATH] pypeit_file type
    
    Script to build HTML files for PYPIT QA.
    
    positional arguments:
      pypeit_file      PYPIT file
      type             QA Type (MF, exp, all)
    
    optional arguments:
      -h, --help       show this help message and exit
      --qapath QAPATH  Path the QA folder including QA/) (default: QA/)
    .. code-block:: console

    $ pypeit_ql_mos -h
    usage: pypeit_ql_mos [-h] [-b BOX_RADIUS] [-d DET] [--ignore_headers]
                         [--user_pixflat USER_PIXFLAT] [--slit_spat SLIT_SPAT]
                         spectrograph full_rawpath arc flat science
    
    Script to run PypeIt in QuickLook on a set of MOS files
    
    positional arguments:
      spectrograph          Name of spectograph, e.g. shane_kast_blue
      full_rawpath          Full path to the raw files
      arc                   Arc frame filename
      flat                  Flat frame filename
      science               Science frame filename
    
    optional arguments:
      -h, --help            show this help message and exit
      -b BOX_RADIUS, --box_radius BOX_RADIUS
                            Set the radius for the boxcar extraction (arcsec)
                            (default: None)
      -d DET, --det DET     Detector number. Cannot use with --slit_spat (default:
                            1)
      --ignore_headers      Ignore bad headers? (default: False)
      --user_pixflat USER_PIXFLAT
                            Use a user-supplied pixel flat (e.g. keck_lris_blue)
                            (default: None)
      --slit_spat SLIT_SPAT
                            Reduce only this slit on this detector DET:SPAT_ID, e.g.
                            1:175 (default: None)
    .. code-block:: console

    $ pypeit_multislit_flexure -h
    usage: pypeit_multislit_flexure [-h] [--clobber] [--debug] flex_file outroot
    
    Calculate and apply flexure corrections for 1D spectra produced by PypeIt.
    
    positional arguments:
      flex_file   File to guide flexure corrections for this multi-slit mode.  This
                  file must have the following format:
                   
                  flexure read
                    spec1dfile1
                    spec1dfile2
                       ...    
                  flexure end
                   
                   
      outroot     Output fileroot for the flexure fits saved as FITS.
    
    optional arguments:
      -h, --help  show this help message and exit
      --clobber   Clobber output files
      --debug     show debug plots?
    .. code-block:: console

    $ pypeit_sensfunc -h
    usage: pypeit_sensfunc [-h] [--algorithm {UVIS,IR}] [--multi MULTI] [-o OUTFILE]
                           [-s SENS_FILE] [--debug] [--par_outfile PAR_OUTFILE]
                           spec1dfile
    
    Compute a sensitivity function
    
    positional arguments:
      spec1dfile            spec1d file for the standard that will be used to
                            compute the sensitivity function
    
    optional arguments:
      -h, --help            show this help message and exit
      --algorithm {UVIS,IR}
                            Override the default algorithm for computing the
                            sensitivity function.  Note that it is not possible to
                            set --algorithm and simultaneously use a .sens file with
                            the --sens_file option. If you are using a .sens file,
                            set the algorithm there via:
                             
                                [sensfunc]
                                     algorithm = IR
                             
                            The algorithm options are:
                             
                            UVIS = Should be used for data with lambda < 7000A.  No
                            detailed model of telluric absorption but corrects for
                            atmospheric extinction.
                             
                            IR = Should be used for data with lambbda > 7000A.
                            Performs joint fit for sensitivity function and telluric
                            absorption using HITRAN models.
                             
      --multi MULTI         List of detector numbers to splice together for
                            instruments with multiple detectors arranged in the
                            spectral direction, e.g. --multi = '3,7'.  Note that it
                            is not possible to set --multi and simultaneously use a
                            .sens file with the --sens_file option.  If you are
                            using a .sens file, set the multi_spec_det param there
                            via:
                             
                                [sensfunc]
                                    multi_spec_det = 3,7
                             
      -o OUTFILE, --outfile OUTFILE
                            Output file for sensitivity function. If not specified,
                            the sensitivity function will be written out to a
                            standard filename in the current working directory, i.e.
                            if the standard spec1d file is named
                            spec1d_b24-Feige66_KASTb_foo.fits the sensfunc will be
                            written to sens_b24-Feige66_KASTb_foo.fits. A QA file
                            will also be written as
                            sens_spec1d_b24-Feige66_KASTb_foo_QA.pdf and a file
                            showing throughput plots to
                            sens_spec1d_b24-Feige66_KASTb_foo_throughput.pdf. The
                            same extensions for QA and throughput will be used if
                            outfile is provided but with .fits trimmed off if it is
                            in the filename.
      -s SENS_FILE, --sens_file SENS_FILE
                            Configuration file with sensitivity function parameters
      --debug               show debug plots?
      --par_outfile PAR_OUTFILE
                            Name of output file to save the parameters used by the
                            fit
    .. code-block:: console

    $ pypeit_collate_1d -h
    usage: pypeit_collate_1d [-h] [--spec1d_files [SPEC1D_FILES ...]]
                             [--par_outfile PAR_OUTFILE] [--outdir OUTDIR]
                             [--tolerance TOLERANCE] [--match MATCH] [--dry_run]
                             [--archive_dir ARCHIVE_DIR] [--pypeit_file PYPEIT_FILE]
                             [--exclude_slit_bm [EXCLUDE_SLIT_BM ...]]
                             [--exclude_serendip]
                             [input_file]
    
    Flux/Coadd multiple 1d spectra from multiple nights and prepare a directory for
    the KOA.
    
    positional arguments:
      input_file            (Optional) File for guiding the collate process.
                            Parameters in this file are overidden by the command
                            line. The file must have the following format:
                             
                            [collate1d]
                              tolerance             <tolerance>
                              outdir                <directory to place output files>
                              archive_root          <directory for archive files>
                              pypeit_file           <A pypeit file to include with archived files>
                              exclude_slit_trace_bm <slit types to exclude>
                              exclude_serendip      If set serendipitous objects are skipped.
                              match_using           Whether to match using "pixel" or
                                                    "ra/dec"
                              dry_run               If set the matches are displayed
                                                    without any processing
                             
                            spec1d read
                            <path to spec1d files, wildcards allowed>
                            ...
                            end
    
    optional arguments:
      -h, --help            show this help message and exit
      --spec1d_files [SPEC1D_FILES ...]
                            One or more spec1d files to flux/coadd/archive. Can
                            contain wildcards
      --par_outfile PAR_OUTFILE
                            Output to save the parameters
      --outdir OUTDIR       The path where all coadded output files and report files
                            will be placed. Defaults to the current directory.
      --tolerance TOLERANCE
                            The tolerance used when comparing the coordinates of
                            objects. If two objects are within this distance from
                            each other, they are considered the same object. If
                            match_using is 'ra/dec' (the default) this is an angular
                            distance. The defaults units are arcseconds but other
                            units supported by astropy.coordinates.Angle can be
                            used(e.g. '0.003d' or '0h1m30s'). If match_using is
                            'pixel' this is a float.
      --match MATCH         Determines how 1D spectra are matched as being the same
                            object. Must be either 'pixel' or 'ra/dec'.
      --dry_run             If set, the script will display the matching File and
                            Object Ids but will not flux, coadd or archive.
      --archive_dir ARCHIVE_DIR
                            The path where files and metadata will be archived.
      --pypeit_file PYPEIT_FILE
                            A .pypeit file to place into the archive. Only used if
                            archive_root is specified. Defaults to looking in the
                            parent directory of the spec1d files.
      --exclude_slit_bm [EXCLUDE_SLIT_BM ...]
                            A list of slit trace bitmask bits that should be
                            excluded.
      --exclude_serendip    Whether to exclude SERENDIP objects from collating.
    .. code-block:: console

    $ pypeit_chk_2dslits -h
    usage: pypeit_chk_2dslits [-h] spec2d_file
    
    Print info on slits from a spec2D file
    
    positional arguments:
      spec2d_file  spec2D filename
    
    optional arguments:
      -h, --help   show this help message and exit
    .. code-block:: console

    $ pypeit_chk_alignments -h
    usage: pypeit_chk_alignments [-h] [--chname CHNAME] master_file
    
    Display MasterAlignment image and the trace data
    
    positional arguments:
      master_file      PypeIt Master Alignment file [e.g.
                       MasterAlignment_A_1_01.fits]
    
    optional arguments:
      -h, --help       show this help message and exit
      --chname CHNAME  Channel name for image in Ginga (default: Alignments)
    .. code-block:: console

    $ pypeit_ql_keck_nires -h
    usage: pypeit_ql_keck_nires [-h] [-b BOX_RADIUS] full_rawpath fileA fileB
    
    Run PypeIt on an A-B pair of NIRES files
    
    positional arguments:
      full_rawpath          Full path to the raw files
      fileA                 A frame
      fileB                 B frame
    
    optional arguments:
      -h, --help            show this help message and exit
      -b BOX_RADIUS, --box_radius BOX_RADIUS
                            Set the radius for the boxcar extraction (default: None)
    .. code-block:: console

    $ pypeit_view_fits -h
    usage: pypeit_view_fits [-h] [--list] [--proc] [--exten EXTEN] [--det DET]
                            [--chname CHNAME]
                            spectrograph file
    
    View FITS files with ginga
    
    positional arguments:
      spectrograph     A valid spectrograph identifier: bok_bc, gemini_flamingos1,
                       gemini_flamingos2, gemini_gmos_north_e2v,
                       gemini_gmos_north_ham, gemini_gmos_north_ham_ns,
                       gemini_gmos_south_ham, gemini_gnirs, gtc_osiris, keck_deimos,
                       keck_hires_red, keck_kcwi, keck_lris_blue,
                       keck_lris_blue_orig, keck_lris_red, keck_lris_red_mark4,
                       keck_lris_red_orig, keck_mosfire, keck_nires,
                       keck_nirspec_low, lbt_luci1, lbt_luci2, lbt_mods1b,
                       lbt_mods1r, lbt_mods2b, lbt_mods2r, ldt_deveny,
                       magellan_fire, magellan_fire_long, magellan_mage,
                       mdm_osmos_mdm4k, mmt_binospec, mmt_bluechannel, mmt_mmirs,
                       not_alfosc, ntt_efosc2, p200_dbsp_blue, p200_dbsp_red,
                       p200_tspec, shane_kast_blue, shane_kast_red,
                       shane_kast_red_ret, soar_goodman_red, tng_dolores, vlt_fors2,
                       vlt_sinfoni, vlt_xshooter_nir, vlt_xshooter_uvb,
                       vlt_xshooter_vis, wht_isis_blue, wht_isis_red
      file             FITS file
    
    optional arguments:
      -h, --help       show this help message and exit
      --list           List the extensions only? (default: False)
      --proc           Process the image (i.e. orient, overscan subtract, multiply
                       by gain) using pypeit.images.buildimage. Note det=mosaic will
                       not work with this option (default: False)
      --exten EXTEN    Show a FITS extension in the raw file. Note --proc and
                       --mosaic will not work with this option. (default: None)
      --det DET        Detector number. To mosaic keck_deimos or keck_lris images,
                       set equal to mosaic. (default: 1)
      --chname CHNAME  Name of Ginga tab (default: Image)
    .. include:: ../include/links.rst

.. _development:

PypeIt Development Procedures and Guidelines
============================================

We encourage anyone to help us develop the ``PypeIt`` code base to better
suit your needs and to improve its algorithms.  If you do so, please
follow this list of procedures and guidelines.  In particular, please
note our :ref:`codeconduct`.

Installation
------------

If you plan to develop/alter the ``PypeIt`` code directly, you should
install the software via git.  You can fork the GitHub `repo`_, develop
within your own fork, and then perform a pull request from that fork.
Or you can clone the `repo`_ and work with it directly:

.. code-block:: console

    git clone https://github.com/pypeit/PypeIt
    cd PypeIt
    pip install -e .

It's important that you use the ``-e`` option when you run ``pip`` so that changes
made to your local installation are immediately available when you re-execute the code.
This will install the core dependencies, but not optional ones like PyQT, PySide2, or
any of the dependencies required for testing or building docs. To install everything you
might possibly need, do:

.. code-block:: console

    pip install -e ".[test,docs,pyside2,pyqt5,shapely]"

There is also a short-cut for this:

.. code-block:: console

    pip install -e ".[dev]"

.. warning::
    The quotes in the above installation lines are shell dependent.  For
    example, you need the quotes with zshell, but the quotes cause an error in
    bash.

It is very highly recommended to do your development install into its own clean
environment. See :ref:`installing` for examples of how to do this with either ``conda``
or ``virtualenv``.

This isn't required, but to simplify some of the commands below, I
assume that you have an environmental variable that points to your
installation of the ``PypeIt`` repository.  E.g., add the following to your
``~/.zshrc`` or ``~/.bash_profile``:

.. code-block:: console

    export PYPEIT_DIR=$HOME/Work/packages/PypeIt

Branches
--------

``PypeIt`` maintains two persistent branches:

 * ``release``: This is the primary stable version of the code.  Nominally, this
   is the version of the code that is installed when using `pip`_ and its the
   version that is used to produce latest `documentation`_.  Pull requests to
   this branch are only done before tagging a new release of the code or to
   perform critical bug hotfixes.  The release schedule is decided by the core
   developers.

 * ``develop``: This is the main development version of the code.  It should be
   stable enough to use, but it may contain experimental, unsupported code that
   is work in progress.

When editing the code, please create a new branch stemming from the
``develop`` branch:

.. code-block:: bash

    cd $PYPEIT_DIR
    git checkout develop
    git pull
    git checkout -b my_new_feature

Development Principles and Communication
----------------------------------------

The main thing to keep in mind when developing for ``PypeIt`` is that its
primary use is as an end-to-end reduction pipeline.  This has a few
implications that one should keep in mind:

 * By default, the execution of ``run_pypeit`` should continue either
   until a critical error is raised or the reduction is complete.  **No
   direct interaction with the code should be required at any point**,
   unless explicitly requested by the user.  ``PypeIt`` does have some
   interactive components, but most of these are executed via separate
   scripts.

 * Any input needed from the user for your feature should be provided by
   a parameter (preferred) or as a command-line argument.

 * When developing and debugging, you may need to interact with the code
   using `pdb`_ or `IPython.embed`_; however, these instances should be
   removed before performing a pull request.

 * The success or failure of any given procedure must be assessed via
   automatically generated quality-assessment figures (preferred) or via
   scripts that interact with the primary output files.

 * If your development includes adding a **new spectrograph** to the list of
   spectrograph data that ``PypeIt`` can reduce, see advice at :ref:`new_spec`.

 * If your development includes adding a **new executable script**, see advice
   at :ref:`new_script`.

Feature development in ``PypeIt`` is unlikely to be fully independent of
other development activities.  Your feature will likely depend on or
influence the outcome of other modules during the data-reduction
process.  This leads to a few important guidelines:

 * Make sure that your branch is always up-to-date with the ``develop``
   branch.  E.g.:

   .. code-block:: bash

        cd $PYPEIT_DIR
        git checkout develop
        git pull
        git checkout my_new_feature
        git merge --no-ff develop

 * Consider the effects of simultaneous development efforts on your work
   and vice versa.  For example, if you're working on a specific module
   of the code that depends on the result/datamodel of the
   wavelength-calibration module, you should communicate this and find
   out if someone else is developing that module and how/if they're
   changing it.  Depending on the scale of those changes, development
   priorities may need to be worked out to minimize merge conflicts and
   the need to immediately rework/refactor new code.

 * When you're ready to, you can submit a PR at any time, but the core
   development team will need to discuss the merge order to ensure a smooth
   process.

Our primary means of **communication** for development is the `PypeIt
developers Slack <https://pypeit.slack.com>`_.  Contact `X Prochaska`_ for
access.

Testing the Code
----------------

``PypeIt`` has two main methods for testing and verifying the code base,
unit tests and a dedicated development suite.

.. _dev-suite:

Development Suite
~~~~~~~~~~~~~~~~~

We have compiled a large suite of data from all instruments supported by
``PypeIt``.  These data are used to test that ``PypeIt`` is successful for *all*
instruments *anytime* new features are developed.  For access to the shared
Google TeamDrive, please contact `X Prochaska`_.

To test PypeIt using the data from the Google Drive:

 * Clone the `PypeIt-development-suite`_ repository:

   .. code-block:: bash

        git clone https://github.com/pypeit/PypeIt-development-suite.git

 * Download/sync the Drive to the repository.  The Drive ``CALIBS`` and
   ``RAW_DATA`` directories should be accessible.  For syncing, consider using
   `rclone`_.

   .. warning::

        The ``RAW_DATA`` directory currently contains about 43 Gb of data, and
        running the develop test below produces about 61 Gb (outdated) of
        reduced data.

 * Run the test suite on the setups designated for development purposes:

   .. code-block:: bash

        cd PypeIt-development-suite
        ./pypeit_test develop

   .. warning::

        The current script executes 89 (outdated) tests.  These tests are mostly
        reductions of example data, but they also include fluxing, flexure, and
        coadding tests.  The execution time is system dependent, but you should
        expect it to take approx. 14 hours (outdated).

   The test suite can be run in parallel using the -t option.

   .. code-block:: bash

        ./pypeit_test -t 2 develop

   The above runs tests using two processes run from parallel threads. The number of
   threads that can be used reliably depends on the amount of memory available. The
   below table shows the worst case amount of memory used per number of threads.

   +--------------+---------------+
   | # of threads | Memory used GB|
   +==============+===============+
   | 1            | 16            |
   +--------------+---------------+
   | 2            | 32            |
   +--------------+---------------+
   | 3            | 46            |
   +--------------+---------------+
   | 4            | 60            |
   +--------------+---------------+
   | 5            | 72            |
   +--------------+---------------+
   | 6            | 80            |
   +--------------+---------------+
   | 7            | 88            |
   +--------------+---------------+
   | 8            | 94            |
   +--------------+---------------+

To add new tests to the development suite

    #. Add the new data to shared Google Drive under ``RAW_DATA``. The tests are
       organized into setup directories under a directory named for the
       instrument.

    #. Add new a pypeit to the `PypeIt-development-suite`_ repo under
       ``pypeit_files``. The file name be lower case and named after the
       instrument and setup, for example: ``keck_deimos_1200g_m_7750.pypeit``.

    #. If desired, add any files for ``pypeit_sensfunc``, ``pypeit_flux_calib``,
       ``pypeit_coadd_1dspec``, ``pypeit_coadd_2dspec`` to the
       `PypeIt-development-suite`_ repo under ``sensfunc_files``,
       ``fluxing_files``, ``coadd1d_files``, ``coadd2d_files``, respectively.

    #. Edit ``test_setups.py`` in the `PypeIt-development-suite`_ under
       ``test_scripts``. Follow the instructions at the top of that file.

    #. Run the full development test suite to completion. Once all tests pass,
       the ``test_priority_file`` will be updated with the new test. This file
       tells the test scripts what order to run the tests in for optimum CPU
       utilization.  Commit ``test_priority_list`` and any other files added to
       the repository and submit a pull request.

.. _unit-tests:

Unit Tests
~~~~~~~~~~

Unit tests are located in the ``$PYPEIT_DIR/pypeit/tests`` directory.  To run
them, make sure you have `pytest`_ installed and then:

.. code-block:: bash

    cd $PYPEIT_DIR
    pytest

If some tests fail, you can run an individual test, e.g. ``test_wvcalib.py``
with

.. code-block:: bash

    cd $PYPEIT_DIR
    pytest -s pypeit/tests/test_wvcalib.py

Note that the "-s" option allows you to insert interactive debugging commands
into the test, here ``test_wvcalib.py``, to help determine why the test is
failing.

.. warning::

    Running these tests generates some files that should be ignored.  **Please
    do not add these test files to the repository.**  We're in the process of
    including some automatic clean-up in the testing functions.

Note also that the use of `pytest`_ requires the test dependencies to be
installed, e.g. via ``pip install -e .[test]``. It is also possible, and often
preferable, to run tests within their own isolated environments using `tox
<https://tox.readthedocs.io/en/latest/>`_. This provides the capability to
easily run tests against different versions of the various dependencies,
including different versions python. The available ``tox`` environments are
defined in ``$PYPEIT_DIR/tox.ini`` and can be listed by running ``tox -a``. To
run tests against the default dependencies using the default python, do:

.. code-block:: bash

    cd $PYPEIT_DIR
    tox -e test

To specify a python version, do something like:

.. code-block:: bash

    cd $PYPEIT_DIR
    tox -e py38-test

To test against, for example, the ``main`` branch for ``astropy`` on GitHub, you
can do:

.. code-block:: bash

    cd $PYPEIT_DIR
    tox -e py38-test-astropydev

Similar ``dev`` dependencies are configured for ``numpy``, ``ginga``, and
``linetools``, as well.

Some of the unit tests require the `Development Suite`_ and/or a set of "cooked"
data products with the expected result produced by testing ``PypeIt`` on
specific data.  The unit tests will skip the appropriate testing function if the
`Development Suite`_ path is not defined or if there is no ``Cooked/`` directory
in the relevant path.

For the unit tests to take advantage of the development-suite data,
``PYPEIT_DEV`` must be an environmental variable that points to the root
directory with the development suite data.  For example, include the following
line in your ``~/.zshrc`` or ``~/.bash_profile`` file:

.. code-block:: bash

    export PYPEIT_DEV=$HOME/Work/packages/PypeIt-development-suite

For unit tests that use the "cooked" data, ``PypeIt`` must find a directory
called ``$PYPEIT_DEV/Cooked/``.

Workflow
--------

A typical ``PypeIt`` development workflow is as follows:

 * Create a new branch stemming from the ``develop`` branch:

   .. code-block:: bash

        cd $PYPEIT_DIR
        git checkout develop
        git pull
        git checkout -b my_new_feature

 * Develop and debug the feature

 * Run the unit tests, fix any failures, add new tests that test your new
   feature(s), and/or modify the tests to accommodate your new feature:

   .. code-block:: bash

        cd $PYPEIT_DIR
        pytest

   or preferably:

   .. code-block:: bash

        cd $PYPEIT_DIR
        tox -e test

   The tests should be run so that they have access to the `Development
   Suite`_ (so that it can, e.g., test loading data), but this first
   round of tests can/should be run without the "cooked" output (e.g.,
   either delete or move the ``$PYPEIT_DEV/Cooked/`` directory).

 * Run the `Development Suite`_ and fix any failures:

   .. code-block:: bash

        cd $PYPEIT_DEV
        ./pypeit_test develop

 * (If needed) Build the cooked tar file (e.g., replace ``x.xx.x`` by
   incrementing the current version):

   .. code-block:: bash

        cd $PYPEIT_DEV
        ./build_cooked x.xx.x

 * Rerun and debug the tests (being sure to edit
   ``$PYPEIT_DIR/pypeit/tests/test_cooked.py`` to accept your cooked
   version):

   .. code-block:: bash

        cd $PYPEIT_DIR
        tox -e test

 * Edit ``$PYPEIT_DIR/CHANGES.rst`` to reflect your key developments and
   update the API `documentation`_.

   .. code-block:: bash

        cd $PYPEIT_DIR
        ./update_docs

 * Make sure all your edits are committed and pushed to the remote
   repository:

   .. code-block:: bash

        cd $PYPEIT_DIR
        git add -u
        git commit -m 'final prep for PR'
        git push

 * `Submit a Pull Request (PR)
   <https://github.com/pypeit/PypeIt/compare>`_. Unless otherwise
   requested, all PRs should be submitted to the ``develop`` branch.

Pull Request Acceptance Requirements
------------------------------------

Once you've submitted a pull request, we'll review your PR and provide
comments on the code.  The minimum requirements for acceptance of a PR
are as follows:

 * If your PR introduces a new instrument (see :ref:`new_spec`) that ``PypeIt``
   is to support for the long term, this instrument *must* be added to the
   `Development Suite`_.  That means raw data should be added to the Google
   Drive and a relevant test should be added to the ``$PYPEIT_DEV/pypeit_test``
   script (via a PR to the `PypeIt-development-suite`_) such that the new
   instrument is included in list of instruments tested by executing
   ``./pypeit_test develop``).

 * The Code Checks run by GitHub (see the Checks tab of the PR) on the remote
   repository must pass.

 * You have to post a successful report resulting from your execution of
   both the `Unit Tests`_ and the `Development Suite`_.  You should also
   have uploaded the "cooked" data to the TeamDrive; e.g.:

   .. code-block:: bash

        rclone copyto Cooked_pypeit_dev_vx.xx.x.tar.gz gdv:Cooked_pypeit_dev_vx.xx.x.tar.gz

   .. figure:: ../figures/tests_success.png

        Example posting of successful tests.

   For hotfixes, these tests can be circumvented at the discretion of
   the core developers in the cases where the hotfix is obviously
   correct.

 * All new methods and classes must be at least minimally documented.
   "Minimally documented" means that each method has a docstring that
   gives at least (1) a one sentence description of the purpose of the
   method, (2) a complete list of the required and optional arguments
   and their meaning, (3) a description of the returned objects, if
   there are any.  Documentation is expected to adhere to `Sphinx`_
   syntax; i.e., the docstrings should be `reStructuredText`_.  We
   accept both `Google-format docstrings`_ and `Numpy-format
   docstrings`_, but the former is preferred.

 * The docstrings for any changes to existing methods that were altered
   must have been modified so that they are up-to-date and accurate.

 * Spurious commented code used for debugging or testing is fine, but
   please let us know if you want it to be kept by adding a relevant
   comment, something like ``# TODO: Keep this around for now``, at the
   beginning of the commented block.  Otherwise, we're likely to remove
   the commented code when we come across it.

 * "Unsupported code," that is code that is experimental and still work
   in progress, should be minimized as much as is reasonable.  The
   relevant code block should be clearly marked as experimental or WIP,
   and it should not be executed by the main ``PypeIt`` executable,
   ``run_pypeit``.

 * At least two reviewers must accept the code.

Tagging Protocol
----------------

The core development team will regularly tag "release" versions of the
repository.  Tagging a release version of the code is triggered anytime the
development branch of the code is merged into the ``release`` branch.  The
tagging process is as follows:

 * At regular ``PypeIt`` telecons or over the ``PypeIt`` developers Slack, the
   core development team will decide to merge the ``develop`` branch into
   ``release``.

 * A branch is created off of ``develop`` (typically called ``staged``)
   and then a `PR <https://github.com/pypeit/PypeIt/compare>`_ is issued
   to merge ``staged`` into ``release``.  This merge must meet the same
   `Pull Request Acceptance Requirements`_ when merging new branches
   into ``develop``.  However, typically the unit and development-suite
   tests do not need to be run because ``develop`` has already passed
   these tests and ``staged`` will not make any substantive changes to
   the code.

   .. code-block:: bash

        cd $PYPEIT_DIR
        git checkout develop
        git pull
        git checkout -b staged

 * **Before being merged into master**, the code is tagged as follows:

    .. code-block:: bash

        cd $PYPEIT_DIR

        # Edit CHANGES.rst to reflect the ending of a development phase
        vi CHANGES.rst
        git add -u
        git commit -m 'tag CHANGES'

        # Create a tag of the form X.Y.Z (using 1.4.2 here as an example).
        # The current autogenerated version is found in pypeit/version.py
        # and the tag used here should be everything in front of the 'dev'
        # string in the current version.
        git tag 1.4.2

        # Push the changes and the new tag
        git push
        git push --tags

 * The PR is accepted and ``staged`` is merged into ``release``.  Hotfix
   branches are deleted, but the ``develop`` branch should not be.

 * The tag is released for `pip`_ installation.

    .. code-block:: bash

        # Make sure you have the most recent version of twine installed
        pip install twine --upgrade
        # Construct the pip distribution
        python setup.py sdist bdist_wheel
        # Test the upload
        twine upload --repository pypeit-test dist/*
        # Upload, this time it's for keeps
        twine upload --repository pypeit dist/*

    For the uploading, you need a ``~/.pypirc`` file that looks like this:

    .. code-block:: ini

        [distutils]
        index-servers =
            pypeit
            pypeit-test

        [pypeit]
        repository: https://upload.pypi.org/legacy/
        username = pypeit
        password = [ask for this]

        [pypeit-test]
        repository: https://test.pypi.org/legacy/
        username = pypeit
        password = [ask for this]

 * After a new version is uploaded to `pip`_, a new PR is automatically
   generated for the `conda-forge/pypeit-feedstock
   <https://github.com/conda-forge/pypeit-feedstock>`_ repository.  Follow the
   commit checklist there before merging that PR, which will trigger the release
   of a new pypeit package on conda-forge. For more information on how to
   manually update the conda-forge pypeit package, see :ref:`conda_forge`.

 * Now we need to advance the version of the code to a new development
   version and merge ``develop`` with the new ``release``:

    .. code-block:: bash

        cd $PYPEIT_DIR

        # Branch from release
        git checkout release
        git pull
        git checkout -b devup

        # Edit CHANGES.rst to begin the new dev section
        vi CHANGES.rst
        git add -u
        git commit -m 'CHANGES'

   The addition of this new commit will cause ``setuptools_scm`` to
   automatically increment the version based on the last tag that was pushed.
   This will be of the form ``{next_version}.dev{distance}+{scm letter}{revision
   hash}``.  See the `setuptools_scm documentation
   <https://github.com/pypa/setuptools_scm>`_ for more details.

 * Finally, a quick PR is issued that pulls ``devup`` into ``develop``.
   All of the `Pull Request Acceptance Requirements`_ should already be
   satisfied, meaning that the PR should be quickly accepted and merged.

DOI
---

If we wish to generate a new DOI for the code, it is as simple
as

 * Generate a `new release on GitHub
   <https://help.github.com/en/github/administering-a-repository/about-releases>`_.

 * Update the DOI in the README.md


----

This document was developed and mutually agreed upon by: Kyle Westfall,
J. Xavier Prochaska, Joseph Hennawi.

*Last Modified: 13 Jun 2021*

----


Additional Developer Links
--------------------------

.. Should move these rst files into the dev directory!

Here are some developer-specific docs:

.. toctree::
   :maxdepth: 1

   ../flow
   ../internals
   ../metadata
   ../new_script
   reports
   conda_forge
   fluxing
.. include:: ../include/links.rst

.. _slitmask_ids_report:

Slitmask ID assignment and missing slits
========================================

Version History
---------------

=========   ================   =========== ===========
*Version*   *Author*           *Date*      ``PypeIt``
=========   ================   =========== ===========
1.0         Debora Pelliccia   9 Oct 2020   1.1.2dev
1.1         Debora Pelliccia   5 Nov 2020   1.2.1dev
1.2         Debora Pelliccia   26 Jan 2021  1.3.1dev
1.3         Debora Pelliccia   21 Oct 2021  1.6.1dev
=========   ================   =========== ===========

----

Basics
------

The procedure used to assign slitmask ID to each slit is currently available for Keck/DEIMOS and Keck/MOSFIRE only,
and is part of the more general slit tracing procedure described in :ref:`slit_tracing`.

Procedure
---------

ID assignment and adding missing slits
++++++++++++++++++++++++++++++++++++++

Slitmask ID assignment is primarily performed by
:func:`pypeit.edgetrace.EdgeTraceSet.maskdesign_matching`. This function matches the slit 
edges traced by ``PypeIt`` to the slit edges predicted using the slitmask design information
stored in the observations. These predictions are generated by
:func:`pypeit.spectrographs.spectrograph.Spectrograph.get_maskdef_slitedges`. For DEIMOS, this function
uses the optical model to convert the slit positions from millimeter to pixels, which is done by
:func:`pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.mask_to_pixel_coordinates`,
and relies on the existence of pre-generated detectors maps pre- and post-grating,
called `amap` and `bmap`, respectively.
For MOSFIRE, the prediction about the slit edges are generated simply using the following information:
the number of slits, their length, and the fact that a MOSFIRE slitmask will always be constructed using 46 CSUs
(Configurable Slit Units), which have a fix length of 7.01" and multiple CSUs can be used together to
form longer slits.


The function :func:`~pypeit.edgetrace.EdgeTraceSet.maskdesign_matching` assigns to each slit 
a ``maskdef_id``, which corresponds to `dSlitId` and `Slit_Number` in the DEIMOS and
MOSFIRE slitmask design, respectively.
Moreover, :func:`~pypeit.edgetrace.EdgeTraceSet.maskdesign_matching` uses the predicted
slit edges positions to add slit traces that have not been found in the image.

Overlapping alignment slits
+++++++++++++++++++++++++++

Because ``PypeIt`` uses the predictions from the slitmask design to add missing slit edges,
it is able to trace overlapping alignment slits (often present in DEIMOS observations only) that
otherwise would be identified during :ref:`slit_tracing` as one large alignment slit, i.e., with width
larger than 4". To avoid that the edges of overlapping slits cross, those edges are placed adjacent to one other.

Application
-----------

To perform the slitmask ID assignment, the **use_maskdesign** flag in :ref:`pypeit_par:EdgeTracePar Keywords`
must be **True**.  This is the default for DEIMOS (except when the *LongMirr* or the *LVM* mask is used) and
MOSFIRE (except when the *LONGSLIT* mask is used).

Three other :ref:`pypeit_par:EdgeTracePar Keywords` control the slitmask ID assignment;
these are: **maskdesign_maxsep**, **maskdesign_sigrej**, **maskdesign_step**.


Access
------

The ``maskdef_id`` is recorded for each slits in the :class:`~pypeit.slittrace.SlitTraceSet` datamodel,
which is written to disk as a multi-extension FITS file prefixed by MasterSlits.
In addition, for DEIMOS and MOSFIRE a second `astropy.io.fits.BinTableHDU`_ is written to disk and contains
more slitmask design information. See :ref:`master_slits` for a description of the provided information
and for a way to visualize them.

Moreover, the ``maskdef_id`` assigned to each slit can be found, after a full reduction with ``PypeIt``
(see :ref:`step_by_step`), by running ``pypeit_chk_2dslits Science/spec2d_XXX.fits``, which lists all
the slits with their associated ``maskdef_id``.


Testing
-------
- PYPEIT-DEIMOS (PD)

    Requirement PD-9 states: "Ingest slitmask information into a data structure."

    Requirement PD-10 states: "Use mask information to determine initial guess for slits positions."

    Requirement PD-42 states: "Deal with overlapping alignment boxes that exceed 4”. "

- PYPEIT-MOSFIRE (PM)

    Requirement PM-10 states: "Ingest slitmask information into a data structure."

    Requirement PM-11 states: "Use slitmask information to determine initial guess for slits positions."

``PypeIt`` meets these requirements as demonstrated by the three tests at
``pypeit/tests/test_maskdesign_matching.py``.  To run the tests:

.. code-block:: bash

    cd pypeit/tests
    pytest test_maskdesign_matching.py::test_maskdef_id -W ignore
    pytest test_maskdesign_matching.py::test_add_missing_slits -W ignore
    pytest test_maskdesign_matching.py::test_overlapped_slits -W ignore

The tests require that you have downloaded the ``PypeIt`` :ref:`dev-suite` and defined
the ``PYPEIT_DEV`` environmental variable that points to the relevant directory. These tests are
run using only one instrument setup and for DEIMOS only one detector.

First test ``pytest test_maskdesign_matching.py::test_maskdef_id -W ignore``.
The algorithm of this test is repeated twice (once for a DEIMOS dataset and once for a MOSFIRE dataset)
and is as follows:

    1. Load the information relative to the specific instrument (DEIMOS, MOSFIRE).

    2. Load the :ref:`pypeit_par:Instrument-Specific Default Configuration` parameters and select the detector.

    3. Build a trace image using three flat-field images from a specific dataset in the :ref:`dev-suite`.

    4. Update the instrument configuration parameters to include configurations specific for the
       used instrument setup. Among others, this step sets the **use_maskdesign** flag in 
       :ref:`pypeit_par:EdgeTracePar Keywords` to *True*.

    5. Run the slit tracing procedure using :class:`~pypeit.edgetrace.EdgeTraceSet`, during which
       the slitmask ID assignment is performed, and record the ``maskdef_id`` associated to each slit
       in the :class:`~pypeit.slittrace.SlitTraceSet` datamodel.

    6. Read the ``maskdef_id`` for the first and last slits of the selected detector and check if
       those correspond to the expected values. The expected values for DEIMOS are determined by previously
       reducing the same dataset with the already existing *DEEP2 IDL-based pipeline*, which is 
       optimized to match the slits found on the DEIMOS detectors to the slitmask information.
       The expected values for MOSFIRE are determined by visual inspection.


Second test ``pytest test_maskdesign_matching.py::test_add_missing_slits -W ignore``.
The algorithm of this test is repeated twice (once for a DEIMOS dataset and once for a MOSFIRE dataset)
and is as follows:

    1. Load the information relative to the specific instrument (DEIMOS, MOSFIRE).

    2. Load the :ref:`pypeit_par:Instrument-Specific Default Configuration` parameters and select the detector.

    3. Build a trace image using three flat-field images from a specific dataset in the :ref:`dev-suite`.

    4. Update the instrument configuration parameters to include configurations specific for the
       used instrument setup. Among others, this step sets the **use_maskdesign** flag in
       :ref:`pypeit_par:EdgeTracePar Keywords` to **True**.

    5. Run step-by-step (lines 72-100) the slit tracing procedure performed by :class:`~pypeit.edgetrace.EdgeTraceSet`.
       This enable to add an extra step, where we remove 4 edges (lines 112-118) that were found
       by the slit tracing procedure.

    6. Continue with the remaining steps of :class:`~pypeit.edgetrace.EdgeTraceSet`, including
       :func:`~pypeit.edgetrace.EdgeTraceSet.maskdesign_matching`, which adds the missing slits and
       performs the the slitmask ID assignment.

    7. Check that the pixel position of the traces that were previously removed are now recovered.


Third test ``pytest test_maskdesign_matching.py::test_overlapped_slits -W ignore`` is performed only
on DEIMOS data.
The algorithm of this test is identical to the first test, but using a different DEIMOS dataset that shows
overlapping alignment slits. The algorithm, then, checks that the total number of slits and the number alignment
slits are as expected. The expected numbers are determined by visual inspection of the observations.

Because these tests are now included in the ``PypeIt`` :ref:`unit-tests`, these checks are performed by the
developers for every new version of the code.

The ``PypeIt`` team have carefully tested ~10 datasets, but more tests are welcome... include:: ../include/links.rst

.. _deimos_wavecalib:

DEIMOS Wavelength Calibration
=============================

Version History
---------------

=========   ================   =========== ===========
*Version*   *Author*           *Date*      ``PypeIt``
=========   ================   =========== ===========
1.0         Debora Pelliccia   23 Feb 2021  1.3.2dev
=========   ================   =========== ===========

----

Basics
------

The procedure used to wavelength calibrate DEIMOS spectra follows the ``PypeIt`` general
procedure described in :ref:`wave_calib`. The user can choose among three :ref:`wave_calib:Automated Algorithms`
, or a :ref:`wave_calib:By-Hand Approach`, to perform the wavelength calibration. :ref:`wave_calib:Full Template`
is the preferred algorithm for DEIMOS and it is set as the default one.


Procedure
---------
DEIMOS wavelength calibration is primarily performed by :func:`pypeit.core.wavecal.autoid.full_template`.
This function requires the existence of an archived calibrated arc spectrum (i.e., `template`) stored in
``pypeit/data/arc_lines/reid_arxiv``. For DEIMOS we created, using the procedure described in
:ref:`construct_template`, five `templates` (one per each grating) spanning a wide range of wavelengths:

    ======================== ===============================
     keck_deimos_600ZD.fits  (~3500-10000 |AA|)
     keck_deimos_830G.fits   (~4500-11000 |AA|)
     keck_deimos_900ZD.fits  (~3500-10000 |AA|)
     keck_deimos_1200G.fits  (~4200-10000 |AA|)
     keck_deimos_1200B.fits  (~3800-7000 |AA|)
    ======================== ===============================

The :ref:`wave_calib:Full Template` algorithm performs, first, a cross-correlation between each observed arc spectrum
and the relevant archived `template` to obtain a rough estimate of the shift in wavelengths. The input arc spectrum
is then divided into snippets (in order to reduce non-linearities) and the cross-correlation against the `template`
is performed again for each snippet to get a better estimate of the shift+stretch in wavelengths, which is then
applied to the input spectrum. The wavelength solution is determined by using arc lines, detected in the input
spectrum, that match the wavelengths recorded in the :ref:`wave_calib:Line Lists` (stored as as ASCII tables
in ``/pypeit/data/arc_lines/lists``).



Application
-----------

To wavelength calibrate DEIMOS spectra using the :ref:`wave_calib:Full Template` algorithm, the **method**
keyword in :ref:`pypeit_par:WavelengthSolutionPar Keywords` must be set to **full_template** and the file name of the
relevant `template` must be specified in the **reid_arxiv**.
These are by default set for DEIMOS.

Some of other relevant :ref:`pypeit_par:WavelengthSolutionPar Keywords` are: **nsnippet**, **sigdetect**, **fwhm**,
**fwhm_fromlines**.

- **nsnippet** sets the number of snippets the arc spectrum is divided into, when the second cross-correlation is
  performed. The default is **nsnippet=2**.

- **sigdetect** sets a threshold for the detection of the lines in the input arc spectrum. Only arc lines detected
  with a significance above this threshold will be used for the determination of the wavelength solution. The
  default is **sigdetect = 5.0**.

- **fwhm** is an assumed value of the arc lines FWHM (i.e., spectral resolution) in unbinned pixels. The default for
  DEIMOS is **fwhm = 6.0**, but it may not work well if wider slits are used (slit width >1"), or for LVM slits. The
  keyword **fwhm_fromlines** should take care of this and override the assumed **fwhm**.

- **fwhm_fromlines**, if set to **True**, allows ``PypeIt`` to compute the arc lines FWHM from the lines with the highest
  detection significance. The FWHM computed in this way will override the assumed **fwhm**, which will still be used
  as first guess. The default for DEIMOS is **fwhm_fromlines = True**.

See :ref:`pypeit_par:WavelengthSolutionPar Keywords` for all the parameters that guide the wavelength calibration.

Access
------

Users can access the DEIMOS wavelength calibration information in a couple of ways:

- Inspecting the Quality Assurance (QA) plot generated by ``PypeIt`` and saved in PNG files.
- Running ``pypeit_chk_wavecalib Masters/MasterWaveCalib_X_X_XX.fits``, which prints wavelength solution
  information for each slit.

See :ref:`master_wvcalib` for more information.

If the user prefers to manually wavelength calibrate, it can be done by running
``pypeit_identify MasterArc_X_X_XX.fits MasterSlits_X_X_XX.fits.gz``. See :ref:`wave_calib:By-Hand Approach`
for more details.

Testing
-------

Requirements state:

* PD-20: "As a user, I expect automatic wavelength calibration for all slits to succeed (for narrow slits, 0.7"-2")"

    * PD-21: "Use arcs to provide wavelength solutions for narrow slits (0.7" - 2")"

    * PD-22: "Use special blue arcs to cover the bluest observations"

* PD-37:  "The pipeline produces a wavelength solution as accurate as the one derived starting from an optical model"


``PypeIt`` meets these requirements as demonstrated by the tests performed by the ``PyPeIt`` team and described below.

Description
^^^^^^^^^^^

We performed the wavelength calibration on a large sample of 36 DEIMOS datasets spanning a wide range of wavelengths,
gratings, central wavelengths, and slit widths:

======== ==========================================================================================================
Grating    Central wavelength (slit width)
======== ==========================================================================================================
600ZD     5500 |AA| (1"), 6000 |AA| (1.5"), 6100 |AA| (1"), 6300 |AA| (1"), 6500 |AA| (1"), 7000 |AA| (0.8"),
          7200 |AA| (1"), 7500 |AA| (1"), 7900 |AA| (1"), 8000 |AA| (1.2")
830G      6720 |AA| (1"), 7500 |AA| (1"), 7800 |AA| (1"), 8100 |AA| (0.6"), 8100 |AA| (1"), 8580 |AA| (1"),
          8580 |AA| (1"), 9000 |AA| (1")
900ZD     5500 |AA| (0.7"), 6000 |AA| (1"), 8000 |AA| (0.75")
1200G     5500 |AA| (1"), 6700 |AA| (1"), 7200 |AA| (1"), 7750 |AA| (0.7"), 8800 |AA| (1")
1200B     5200 |AA| (1"), 5280 |AA| (1"), 5500 |AA| (0.85")
======== ==========================================================================================================

Including six datasets using LVM slitmask, which is a special slitmask composed of 5 slits with different widths
(0.7", 0.8", 1.", 1.2", 1.5"). These datasets were taken with the following gratings (and central wavelengths):
830G (8400 |AA|), 600ZD (7100 |AA|), 830G (7900 |AA|), 1200G (7800 |AA|), 1200B (5450 |AA|), 1200B (5200 |AA|).

Results
^^^^^^^

Out of the **4072 slits** that have been tested, for only **37 (0.9%)** the wavelength calibration failed or
was wrong. From a visual inspection, we found that the success of the wavelength calibration is mostly
influenced by the quality of the arc spectra. In particular, artifacts, noisy spectra, ghosts, and strong
emission from adjacent slits are the main responsible for failed or bad wavelength calibration. For these cases,
the only way to obtain a wavelength calibration may be to perform a wavelength calibration by hand (see
:ref:`wave_calib:By-Hand Approach`).

To further investigate the quality of the wavelength calibration, we inspected the distribution of the
wavelength solution RMS (in pixels), reported below (left panel), and we found that the majority of the
calibrated spectra have RMS<0.2 pixels.

Moreover, by comparing the wavelength calibration performed with ``PypeIt`` to the one performed with
the *DEEP2 IDL-based pipeline*, which produces wavelength solutions using the DEIMOS optical model, we found
very small wavelength offsets (~0.1 |AA|). See right panel below (dataset obtained with 600ZD grating, kindly
provided by Kevin McKinnon).

.. image:: ../figures/pypeit_DEIMOSwvcalib_performance.jpg
   :scale: 74%

.. image:: ../figures/comparisonDEEP2.jpg
   :scale: 130%











.. |AA|  unicode:: U+000C5 .. Angstrom.. include:: ../include/links.rst

.. _radec_object_report:

RA, Dec and object name assignment to 1D extracted spectra
==========================================================

Version History
---------------

=========   ================   =========== ===========
*Version*   *Author*           *Date*      ``PypeIt``
=========   ================   =========== ===========
1.0         Debora Pelliccia   25 Jan 2021  1.3.1dev
1.1         Debora Pelliccia   02 Apr 2021  1.3.4dev
1.2         Debora Pelliccia   28 Jul 2021  1.4.3dev
1.3         Debora Pelliccia   21 Oct 2021  1.6.1dev
=========   ================   =========== ===========

----

Basics
------

The procedure used to assign RA, Dec and object name to each 1D extracted spectrum
is currently available for Keck/DEIMOS and Keck/MOSFIRE only and is performed right after
the object finding procedure described in :ref:`object_finding`.


Procedure
---------

RA, Dec and object name assignment is primarily performed by
:func:`pypeit.slittrace.assign_addobjs_alldets`.

First, ``Pypeit``, using :func:`pypeit.slittrace.get_maskdef_objpos_offset_alldets`,
computes for every detectors that the user wants to reduce the offset of the observed
slitmask from the position expected by the design file (see :ref:`slitmask_ids_report`
for a description on how the slitmask design matching is performed), and stores it in
the :class:`~pypeit.slittrace.SlitTraceSet` datamodel (see :ref:`master_slits` for a
description of the provided information and for a way to visualize them). There are four
different options that the user can choose to compute the offset: using objects with high
significance detections, using only one bright object in a selected slit, using alignment stars,
or using the dither offset recorded in the science frame header (available only for MOSFIRE).
Or, alternatively, the user can input a known offset in pixels (see `Application`_).

Then, :func:`pypeit.slittrace.average_maskdef_offset` determines an average slitmask offset over all
the detectors (this does not happen for MOSFIRE observations, which have only one detector), which is
used by :func:`pypeit.slittrace.assign_addobjs_alldets` to assign RA, Dec and object name to detected
objects and to force extract objects that were not detected (for the latter see
:ref:`add_missing_obj_report`).

The function :func:`~pypeit.slittrace.assign_addobjs_alldets`, for each detector, goes through
all the slits and checks if the measured distance of the detected objects from the left edge
of the slit (corrected for the offset computed in the previous step) is within a certain tolerance
(see `Application`_ for details on how to control the value of this parameter) of the distance
expected from the slitmask design (differences between the expected and the measured slit length
are taken into account). Correcting for the slitmask offset allows ``PypeIt`` to deal also with
dithered observations.
If the measured distance is within the set tolerance, the ``RA``, ``DEC`` and ``MASKDEF_OBJNAME``
of the detected object are updated with the coordinates and name of the targeted object.
If the measured distance is not within the tolerance, the detected object is considered a
serendipitous object.
Using the coordinates of the slit center available from the slitmask design and the distance in pixels
(converted then in arcsec) between the traced object and the center of the slit, the coordinates
of the serendipitous object are estimates and recorded in  ``RA`` and ``DEC`` while
``MASKDEF_OBJNAME`` is set to "SERENDIP". For both cases, the ``MASKDEF_EXTRACT`` attribute
is set to **False** (see :ref:`add_missing_obj_report`).


Application
-----------

To perform the RA, Dec and object name assignment to extracted spectra, the parameters
described in the *Application* section of :ref:`slitmask_ids_report` must be set.
Moreover, the **assign_obj** flag in :ref:`pypeit_par:SlitMaskPar Keywords` must be **True**.
This is the default for DEIMOS (except when the *LongMirr* or the *LVM* mask is used) and
MOSFIRE (except when the *LONGSLIT* mask is used).
Seven other parameters control this procedure. Six are for the slitmask offset determination
and one is for the RA, Dec and object name assignment. They are the following.

- **nsig_thrshd**: objects detected above this significance threshold are used to
  compute the slitmask offset. This is the default behaviour for DEIMOS unless **slitmask_offset**,
  **bright_maskdef_id** or **use_alignbox** is set. Default value is **nsig_thrshd=50**.

- **bright_maskdef_id**: ``maskdef_id`` (corresponding to ``dSlitId`` and ``Slit_Number`` in the DEIMOS
  and MOSFIRE slitmask design, respectively) of a slit containing a bright object that will be used
  to compute the slitmask offset. This parameter is optional (default value is **bright_maskdef_id=None**)
  and is ignored if **slitmask_offset** is provided. However, this parameter is highly recommended
  for MOSFIRE observations if a bright object is present in the slitmask, since it allows to
  trace the small drifts of the objects position that have been typically seen in MOSFIRE data.

- **use_alignbox**: flag to use stars in alignment boxes to compute the slitmask offset. This is
  available only for DEIMOS observations. If this is set to True PypeIt will NOT compute the
  offset using **nsig_thrshd** or **bright_maskdef_id**. The default is **use_alignbox=False**.

- **use_dither_offset**: flag to use the dither offset recorded in the header of science frames as the
  value of the slitmask offset. This is currently only available for MOSFIRE reduction and
  it is set as the default for this instrument. When set to True PypeIt will NOT compute the
  offset using `nsig_thrshd` or `bright_maskdef_id`. However, it is ignored if ``slitmask_offset`` is provided.

- **slitmask_offset**: user-provided slitmask offset (pixels) from the position expected
  by the slitmask design. This is optional (default value is **slitmask_offset=None**),
  and if set PypeIt will NOT compute the offset, i.e., the above parameters will be ignored.

- **obj_toler**: sets the tolerance in arcsec for the matching process between the measured
  coordinates of the extracted spectrum and the expected coordinates of the targeted object.
  The default value is **obj_toler = 1**.


Access
------

``PypeIt`` users can access the objects information in several ways.

- Ra, Dec, object name and ``maskdef_id`` are visible in the .txt file with a list of all extracted spectra,
  generated at the end the ``PypeIt`` reduction.
- Ra, Dec, object name are also visible by running `pypeit_show_1d --list` (see :ref:`out_spec1D:pypeit_show_1dspec`)
- Object names are visible in `ginga` when running `pypeit_show_2d` (see :ref:`out_spec2D:pypeit_show_2dspec`)


Testing
-------
- PYPEIT-DEIMOS (PD)

    Requirement PD-8 states: "As a user, I expect products that are associated with my mask
    definition (object names, object positions)."

    Requirement PD-35 states: "As a user, I expect to be able to reduce data taken with a nodding pattern."

- PYPEIT-MOSFIRE (PM)

    Requirement PM-9 states: "As a user, I expect products that are associated with my mask
    definition (object names, object positions)."

    Requirement PM-12 states: "Use slitmask information to determine object position in the slit."

``PypeIt`` meets this requirement as demonstrated by the tests at ``pypeit/tests/test_slitmask.py``.
To run the test:

.. code-block:: bash

    cd pypeit/tests
    pytest test_slitmask.py::test_assign_maskinfo_add_missing -W ignore
    pytest test_slitmask.py::test_dith_obs -W ignore

The tests require that you have downloaded the ``PypeIt`` :ref:`dev-suite` (including the folder compressed in 
"Cooked_pypeit_dev_vX.XX.X.tar.gz", where vX.XX.X indicates the version of the file) and defined
the ``PYPEIT_DEV`` environmental variable that points to the relevant directory. These tests are
run using only one instrument setup and for DEIMOS only one detector.

First test ``pytest test_slitmask::test_assign_maskinfo -W ignore``.
The algorithm of the test is repeated twice (once for a DEIMOS dataset and once for a MOSFIRE dataset)
and is as follows:

    1. Load the information relative to the specific instrument (DEIMOS, MOSFIRE).

    2. Load the :ref:`pypeit_par:Instrument-Specific Default Configuration` parameters and select the detector.

    3. Build a trace image using three flat-field images from a specific dataset in the :ref:`dev-suite`.

    4. Update the instrument configuration parameters to include configurations specific for the
       used instrument setup. Among others, this step sets the **assign_obj** flag in
       :ref:`pypeit_par:SlitMaskPar Keywords` to **True**.

    5. Run the slit tracing procedure using :class:`~pypeit.edgetrace.EdgeTraceSet`, during which
       the slitmask ID assignment is performed (see :ref:`slitmask_ids_report`), and the ``maskdef_id``
       and object information associated to each slit are recorded in the
       :class:`~pypeit.slittrace.SlitTraceSet` datamodel.

    6. A file containing previously extracted 1D spectra is loaded from the **Cooked** folder in the :ref:`dev-suite` 
       and the objects information re-initialized, i.e.,  ``RA``, ``DEC`` and ``MASKDEF_OBJNAME`` are set to ``None``
       for each spectrum.

    7. :func:`pypeit.slittrace.average_maskdef_offset` is run to determine an average slitmask offset over
       all the detectors, which is used by :func:`pypeit.slittrace.assign_addobjs_alldets` to assign
       the object RA, Dec and object name to each extracted spectrum.

    8. Read  ``RA``, ``DEC`` and ``MASKDEF_OBJNAME`` for a selected slit and check if those correspond to
       the expected values. The expected values are taken from the :class:`~pypeit.slittrace.SlitTraceSet`
       datamodel. See :ref:`master_slits` for a description of the provided information and for a way
       to visualize them.


Second test ``pytest test_slitmask::test_dith_obs -W ignore`` is performed only on DEIMOS data.
The algorithm of this test is identical to the first test, but using a different DEIMOS dataset obtained with
dithered observations.

Because these tests are now included in the ``PypeIt`` :ref:`unit-tests`, this check is performed by the
developers for every new version of the code... include:: ../include/links.rst

.. _add_missing_obj_report:

Object position on the slit from slitmask design
=======================================================

Version History
---------------

=========   ================   =========== ===========
*Version*   *Author*           *Date*      ``PypeIt``
=========   ================   =========== ===========
1.0         Debora Pelliccia   02 Apr 2021  1.3.4dev
1.1         Debora Pelliccia   28 Jul 2021  1.4.3dev
1.3         Debora Pelliccia   21 Oct 2021  1.6.1dev
=========   ================   =========== ===========

----

Basics
------

The procedure to determine the location on the slit of undetected objects
using the slitmask design information is currently available for Keck/DEIMOS and Keck/MOSFIRE only
and it is performed right after the object finding (see :ref:`object_finding`)
and the RA, Dec and object name assignment procedures (see :ref:`radec_object_report`) have been completed.


Procedure
---------

The determination of the position on the slit of non detected objects is primarily performed by
:func:`pypeit.slittrace.assign_addobjs_alldets`. This function, first, assigns RA, Dec and object name
to the detected objects (see :ref:`radec_object_report`).

Then, ``PypeIt``, for each detector, goes through all the slits and for each slit checks if the
target object was detected (this is done by checking if ``MASKDEF_OBJNAME`` corresponds to the object
name of the target). If the answer is yes, it goes to the next slit. If the answer is no, a new
:class:`pypeit.specobj.SpecObj` is added to the :class:`pypeit.specobjs.SpecObjs` class. The expected
position on the slit (corrected for **slitmask_offset**, see :ref:`radec_object_report` for how
to compute this offset) is recorded in the :class:`~pypeit.specobjs.SpecObjs`'s attribute
``SPAT_PIXPOS``. Correcting for **slitmask_offset** allows ``PypeIt`` to deal also with dithered
observations. Other relevant attributes are also updated, i.e., ``TRACE_SPAT``, ``SPAT_FRACPOS``,
``OBJID``, ``FWHM``, ``RA``, ``DEC``, ``MASKDEF_OBJNAME``, ``MASKDEF_ID`` (see spec1D
:ref:`out_spec1D:Current Data Model` for a description of these parameters).
The attribute ``MASKDEF_EXTRACT`` is set to **True** to flag the spectra that have been extracted
from undetected objects.


Application
-----------

To perform the determination of the location on the slit of undetected objects, the parameters
described in the *Application* section of :ref:`slitmask_ids_report` and
:ref:`radec_object_report` must be set.
Moreover, **extract_missing_objs** flag in :ref:`pypeit_par:SlitMaskPar Keywords` must be **True**.
This is the default for DEIMOS (except when the *LongMirr* or the *LVM* mask is used) and
MOSFIRE (except when the *LONGSLIT* or the *long2pos* mask is used).

See :ref:`pypeit_par:SlitMaskPar Keywords` for more details.

Access
------

``PypeIt`` users can access the objects information resulted from this procedure in several ways.

- A flag that identifies the undetected objects for which the extraction was "forced" is visible in
  the .txt file with a list of all extracted spectra, generated at the end the ``PypeIt`` reduction.
- The same flag is also visible when running `pypeit_show_1d --list` (see :ref:`out_spec1D:pypeit_show_1dspec`)
- The forced extraction are shown in a different color than the detected objects (yellow vs. orange)
  in `ginga` when running `pypeit_show_2d` (see :ref:`out_spec2D:pypeit_show_2dspec`)
- the **slitmask_offset** value is reported when running ``pypeit_chk_2dslits Science/spec2d_XXX.fits``.


Testing
-------

- PYPEIT-DEIMOS (PD)

    Requirement PD-11 states: "Use slitmask information to determine object position in the slit."

    Requirement PD-12 states: "As a user, I expect the pipeline to extract 1d spectra using standard extraction
    method such as optimal extraction, even for sources that don’t have continuum using information contained
    in the mask definition"

- PYPEIT-MOSFIRE (PM)

    Requirement PM-9 states: "As a user, I expect products that are associated with my mask
    definition (object names, object positions)."

    Requirement PM-12 states: "Use slitmask information to determine object position in the slit."

    Requirement PM-14 states: "As a user, I expect the pipeline to extract 1d spectra using standard extraction
    method such as optimal extraction, even for sources that don’t have continuum using information contained
    in the mask definition"

    Requirement PM-16 states: "Use slitmask information to determine the location of the object in the slit."

``PypeIt`` meets these requirements as demonstrated by the test at ``pypeit/tests/test_slitmask.py``.
To run the test:

.. code-block:: bash

    cd pypeit/tests
    pytest test_slitmask.py::test_assign_maskinfo_add_missing -W ignore

The test requires that you have downloaded the ``PypeIt`` :ref:`dev-suite` (including the folder compressed in
"Cooked_pypeit_dev_vX.XX.X.tar.gz", where vX.XX.X indicates the version of the file) and defined
the ``PYPEIT_DEV`` environmental variable that points to the relevant directory. This test is
run using only one instrument setup and for DEIMOS only one detector.

The algorithm of the test is repeated twice (once for a DEIMOS dataset and once for a MOSFIRE dataset)
and is as follows:

    1. Load the information relative to the specific instrument (DEIMOS, MOSFIRE).

    2. Load the :ref:`pypeit_par:Instrument-Specific Default Configuration` parameters and select the detector.

    3. Build a trace image using three flat-field images from a specific dataset in the :ref:`dev-suite`.

    4. Update the instrument configuration parameters to include configurations specific for the
       used instrument setup. Among others, this step sets the **extract_missing_objs** flag in
       :ref:`pypeit_par:SlitMaskPar Keywords` to **True**.

    5. Run the slit tracing procedure using :class:`~pypeit.edgetrace.EdgeTraceSet`, during which
       the slitmask ID assignment is performed (see :ref:`slitmask_ids_report`), and the ``maskdef_id``
       and object information associated to each slit are recorded in the :class:`~pypeit.slittrace.SlitTraceSet`
       datamodel.

    6. A file containing previously extracted 1D spectra is loaded from the **Cooked** folder in the :ref:`dev-suite` 
       and the objects information re-initialized, i.e.,  ``RA``, ``DEC``, ``MASKDEF_OBJNAME`` and ``MASKDEF_EXTRACT``
       are set to ``None`` for the detected objects, while the spectra of undetected object are removed.

    7. :func:`pypeit.slittrace.average_maskdef_offset` is run to determine an average slitmask offset over
       all the detectors, which is used by :func:`pypeit.slittrace.assign_addobjs_alldets` to assign
       the object RA, Dec and object name to each extracted spectrum and to add a new
       :class:`~pypeit.specobj.SpecObj` to the :class:`~pypeit.specobjs.SpecObjs` class for each
       undetected object, updating all the relevant attributes (see `Procedure`_).

    9. Read ``SPAT_PIXPOS`` for two undetected objects and check if those correspond to
       the expected position of the object on the slit. The expected positions are verified by visual inspection
       of the 2D spectrum.


Because these tests are now included in the ``PypeIt`` :ref:`unit-tests`, this check is performed by the
developers for every new version of the code... include:: ../include/links.rst

.. IF IT ISN'T ALREADY, WE SHOULD MOVE THESE DETAILS SOMEWHERE RELEVANT IN THE
.. MAIN DOC PAGES.

.. _fluxcalib:

Flux Calibration
=================================

Version History
---------------

=========   =============   =========== ===========
*Version*   *Author*        *Date*      ``PypeIt``
=========   =============   =========== ===========
1.0         Joe Hennawi     25 Jan 2021 1.1.1
=========   =============   =========== ===========

----

Sensitivity Function Units and Definitions
------------------------------------------

The sensitivity function in PypeIt is defined to be the function :math:`S_\lambda` satisfying

:math:`S_\lambda  = \frac{F_\lambda}{N_\lambda}` with units of :math:`[{\rm erg/cm^2/photons}]`,

where

:math:`F_\lambda` is the specific energy flux in units of :math:`[{\rm erg/s/cm^2/\mathrm{\mathring{A}}}]`,

:math:`N_\lambda` is the specific photon flux with units :math:`[{\rm photons/s/\mathrm{\mathring{A}}}]`,

PypeIt spec1d files contain :math:`N_{\rm pix}` with units :math:`[{\rm photons/pixel}]`. To generate
flux calibrated spectra  :math:`F_\lambda`, :math:`S_\lambda` must be computed from a spectro-photometric standard
star observations (insert hyperlink to discussion below and fluxing.rst).

:math:`N_{\lambda}` must be determined from :math:`N_{\rm pix}`

via

:math:`N_\lambda = \frac{N_{\rm pix}}{\frac{d\lambda}{d{\rm pix} \Delta t}}`,

where :math:`\Delta t` is the exposure time and :math:`\frac{d\lambda}{d{\rm pix}}` is the wavelength
spacing per pixel, which is in general not a constant since PypeIt spec1d spectra (i.e. :math:`N_{\rm pix}`) are
extracted on an irregularly spaced wavelength grid.

After flux calibration, flux calibrated spectra (i.e. :math:`F_\lambda`) are reported in the spec1d
files as e.g. ``OPT_FLAM`` and ``BOX_FLAM`` for optimal and boxcar extractions, respectively, in units of
:math:`[10^{-17} {\rm erg/s/cm^2/\mathrm{\mathring{A}}}]`. See :ref:`fluxing` for additional details.


Spectroscopic Zeropoints
------------------------
Flux calibration of PypeIt spectra is expressed via the "spectroscopic zeropoint", which, by analogy
with the imaging zeropoint, is defined to be:

:math:`{\rm Zeropoint} \equiv -2.5 \log_{10}{\left[\frac{\frac{\lambda^2}{c}S_\lambda}{\left(\frac{3631 {\rm Jy}}{{\rm photons}/ {\rm s} / \mathrm{\mathring{A}}}\right)}\right]}`

With this definition we see that an astronomical source with a flat spectrum in frequency :math:`\nu`,
i.e. :math:`F_\nu = {\rm const}` and AB magnitude equal to the Zeropoint will produce
:math:`N_\lambda = 1 {\rm photon/s/\mathrm{\mathring{A}}}` on the detector, that is sum of the :math:`N_{\rm pix}` photons
per pixel over all pixels corresponding to a :math:`\Delta \lambda = 1 \mathrm{\mathring{A}}` interval will be
equal to unity.

From the definition of the spectroscopic zeropoint above, it follows that

:math:`\left(\frac{F_\lambda}{10^{-17} {\rm erg/s/cm^2/\mathrm{\mathring{A}}}}\right) = 10^{-0.4({\rm Zeropoint - ZPCONST})} \left(\frac{N_\lambda}{\rm photons/s/\mathrm{\mathring{A}}}\right)\left(\frac{\lambda}{\mathrm{\mathring{A}}}\right)^2`

where :math:`ZPCONST = 40.09` is a dimensionless number defined by

:math:`{\rm ZPCONST}\equiv \frac{\frac{\mathrm{\mathring{A}}^2}{c}\times 10^{-17}{\rm erg/s/cm^2/\mathrm{\mathring{A}}}}{3631 {\rm Jy}}`.

In practice PypeIt fits and stores the spectroscopic zerpoints and uses the equation above to compute
:math:`F_\lambda` from :math:`N_\lambda` and vice-versa.

The sensitivity function script :ref:`fluxing:pypeit_sensfunc` produces a QA plot showing the
the zeropoint fit, as shown below. For echelle observations this zeropoint QA is shown for each order.


Spectroscopic Throughput
------------------------

The zeropoint is closely related to the spectroscopic throughput. The number of counts per pixel in a spectrum
of an object with flux :math:`F_\lambda`


:math:`N_{\rm pix} = A T(\lambda){\rm Atm}(\lambda)\frac{d\lambda}{d_{\rm pix}}\frac{F_\lambda}{h\nu}\Delta t`,

where :math:`A` is the effective aperture of the telescope, :math:`T(\lambda)` is the spectroscopic throughput,
:math:`{\rm Atm(\lambda)}` is the attenuation caused by the Earth's atmosphere, :math:`\frac{d\lambda}{d_{\rm pix}}` is
the number of :math:`\mathrm{\mathring{A}}` per pixel defined above,  :math:`h\nu` is the photon energy, and
:math:`\Delta t` is the exposure time.

Based on this equation and the definintions above it follows that the spectroscopic throughput can be written

:math:`T(\lambda) = \frac{h\nu}{A S_\lambda}`,

Note :math:`T(\lambda)` is clearly dimensionless given the units of :math:`S_\lambda`: :math:`[{\rm erg/cm^2/photons}]`.
As :math:`S_\lambda` is specified by the zeropoint, throughput curves can be computed once the zeropoints given the
effective aperture of the telescope.

In addition to the zeropoint QA shown above, the sensitivity function script ``pypeit_sensfunc`` also produces a QA plot
showing throughput curve(s), computed directly from the spectroscopic zeropoints.

Note that we have defined the spectroscopic throughput above to be that of the telescope + instrument system, but
NOT include the attenuation caused by the Earth's atmosphere. Also, the zeropoints,  sensitivity functions, and PypeIt
flux calibration algorithms in general do not attempt to remove the impact of slit losses. In the limit where your standard
star observations and science observations have exactly the same seeing, the flux calibration will be perfect. In the more
realistic scenario where they differ, this will manifest as a wavelength dependent systematic error in the flux calibration,
with the direction of the error depending on the relative seeing between the standard star and science observations. In future
versions we hope to implement a better treatment of slit losses. For the time being we recommend that users that require
very accurate flux calibration force PypeIt flux calibrated spectra to agree with photometry. This can be done using the
`filter` parameter option for 1D coadding (see :ref:`pypeit_par:Coadd1DPar Keywords`), which can be set in the
.coadd1d file which is used to guide 1D coaddition with the ``pypeit_coadd1d`` script (see :ref:`coadd1d`).



.. include:: ../include/links.rst

.. _deimos_frames_report:

Automated typing of DEIMOS frames
=================================

Version History
---------------

=========   =============   =========== ===========
*Version*   *Author*        *Date*      ``PypeIt``
=========   =============   =========== ===========
1.0         Kyle Westfall   11 Sep 2020 1.1.1
1.1         Kyle Westfall   18 Sep 2020 1.1.2dev
1.2         Kyle Westfall   28 Sep 2020 1.1.2dev
1.3         Kyle Westfall   14 Oct 2020 1.2.1dev
1.4         Kyle Westfall   28 Jan 2021 1.3.1dev
=========   =============   =========== ===========

----

Basics
------

The general procedure used to assign frames a given type is described
here: :ref:`frame_types`.

DEIMOS frame typing
-------------------

The primary typing of DEIMOS frames is performed by
:func:`pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.check_frame_type`.
This function checks the values of various header keywords against a
set of criteria used to classify the frame type. The headers cards
required for the frame-typing and their associated keyword in the
:class:`~pypeit.metadata.PypeItMetaData` object are:

===============     ============
``fitstbl`` key     Header Key
===============     ============
``mode``            ``MOSMODE``
``exptime``         ``ELAPTIME``
``lampstat01``      ``LAMPS``
``hatch``           ``HATCHPOS``
``idname``          ``OBSTYPE``
===============     ============

The criteria used to select each frame type are as follows:

=============   ==========================================  ===========   ============    ============
Frame           ``OBSTYPE``                                 ``LAMPS``     ``HATCHPOS``    ``MOSMODE``
=============   ==========================================  ===========   ============    ============
``science``     ``'Object'``                                ``'Off'``     ``'open'``      ``'Spectral'``
``bias``        ``'Bias'``                                  ``'Off'``     ``'closed'``    ``'Spectral'``
``dark``        ``'Dark'``                                  ``'Off'``     ``'closed'``    ``'Spectral'``
``pixelflat``   ``'IntFlat'``                               ``!='Off'``   ``'closed'``    ``'Spectral'``
``pixelflat``   ``'DmFlat'``, ``'SkyFlat'``                 ``!='Off'``   ``'open'``      ``'Spectral'``
``trace``       ``'IntFlat'``                               ``!='Off'``   ``'closed'``    ``'Spectral'``
``trace``       ``'DmFlat'``, ``'SkyFlat'``                 ``!='Off'``   ``'open'``      ``'Spectral'``
``illumflat``   ``'IntFlat'``                               ``!='Off'``   ``'closed'``    ``'Spectral'``
``illumflat``   ``'DmFlat'``, ``'SkyFlat'``                 ``!='Off'``   ``'open'``      ``'Spectral'``
``arc``         ``'Line'``                                  ``!='Off'``   ``'closed'``    ``'Spectral'``
``tilt``        ``'Line'``                                  ``!='Off'``   ``'closed'``    ``'Spectral'``
=============   ==========================================  ===========   ============    ============

Note that, by default, the exposure time (``ELAPTIME``) is not used to
distinguish frame types; however, this can be changed using the ``exprng``
parameter in the :ref:`pypeit_file`; see also :ref:`frame_types`.

Importantly, note that a DEIMOS frame is never given a ``pinhole``
type. Also note that the criteria used to select ``pixelflat``,
``trace``, and ``illumflat`` are identical; the same is true for
``arc`` and ``tilt`` frames. No distinction is currently made between
``IntFlat``, ``DmFlat``, or ``SkyFlat`` and how they're used in the
code.

Also note that ``PypeIt`` will ignore frames observed under
conditions that do not meet the restricted values set by
:func:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.valid_configuration_values`.
This currently requires all frames to have ``MOSMODE == 'Spectral'``
and ``AMPMODE == 'SINGLE:B'``. Frames that do not meet these criteria
will not be included in the automatically generated
:ref:`pypeit_file` created by :ref:`pypeit_setup`.

Testing
-------

Requirement PD-1 states: "As a user, I want the pipeline to
automatically classify my calibrations."

``PypeIt`` meets this requirement as demonstrated by the test at
``pypeit/tests/test_frametype.py``.  To run the test:

.. code-block:: bash

    cd pypeit/tests
    pytest test_frametype.py::test_deimos -W ignore

The test requires that you have downloaded the ``PypeIt``
:ref:`dev-suite` and defined the ``PYPEIT_DEV`` environmental
variable that points to the relevant directory. The algorithm of the
test is as follows:

    1. Find all the directories in the :ref:`dev-suite` with Keck
       DEIMOS data.

    2. For each directory (i.e., instrument setup):

        a. Make sure there is a "by-hand" version of the pypeit file
           for this setup where a human (one of the pypeit
           developers) has ensured the frame types are correct.

        b. Effectively run :ref:`pypeit_setup` on each of the
           instrument setups to construct a new pypeit file with the
           automatically generated frame types.
           
        c. Read both the by-hand and automatically generated frame
           types from these two pypeit files and check that they are
           identical. This check is *only* performed for the
           calibration frames, not any ``science`` or ``standard``
           frames.

Because this test is now included in the ``PypeIt``
:ref:`unit-tests`, this frame-typing check is performed by the
developers for every new version of the code.
.. include:: ../include/links.rst

.. _deimos_config_report:

Automated sorting of DEIMOS frames by instrument configuration
==============================================================

Version History
---------------

=========   =============   =========== ===========
*Version*   *Author*        *Date*      ``PypeIt``
=========   =============   =========== ===========
1.0         Kyle Westfall   13 Oct 2020 1.1.2dev
=========   =============   =========== ===========

----

Basics
------

Sorting frames by the configuration of the instrument, ensuring that
this configuration is the same for all coupled sets of calibration and
science frames, is performed by the :ref:`pypeit_setup` script; see
:ref:`setup_doc`. :ref:`pypeit_setup` uses automated procedures to sort
the frames and write a :ref:`pypeit_file` for each unique
configuration (or for some down-selected set).

DEIMOS configuration identification
-----------------------------------

The DEIMOS instrument configuration is determined by a unique
combination of the following keywords:

===============     ====================================================================
``fitstbl`` key     Header Key
===============     ====================================================================
``dispname``        ``GRATENAM``
``dispangle``       ``G3TLTWAV`` or ``G4TLTWAV``, depending on the value of ``GRATEPOS``
``decker``          ``SLMSKNAM``
``binning``         ``BINNING``
``amp``             ``AMPMODE``
===============     ====================================================================

as determined by
:func:`pypeit.metadata.PypeItMetaData.unique_configurations`. The
``AMPMODE`` value is included, even though ``PypeIt`` (currently)
restricts itself to only attempting to reduce frames read by the B
amplifier; see
:func:`~pypeit.spectrographs.keck_deimos.KeckDEIMOSSpectrograph.valid_configuration_values`.
Additionally, ``PypeIt`` requires all frames to have ``MOSMODE ==
'Spectral'``. Frames that do not match these header keyword
restrictions will not be included in the automatically generated
:ref:`pypeit_file` created by :ref:`pypeit_setup`.

For DEIMOS, the unique configurations are determined by collating the
relevant metadata from the headers of all frames found by a run of
:ref:`pypeit_setup`, *except* those that are designated as bias or
dark frames. The reason is that bias and darks can have header data
(e.g., ``dispangle``) that do not match the instrument configuration
that an observer intended for their use; e.g., the frames were taken
before the instrument was fully configured for the night's
observations. To match these frames to a specific configuration,
``PypeIt`` uses the ``DATE-OBS`` header keyword to match the frames
to the first configuration with frames taken on the same date.

.. warning::

    The fact that the bias and dark frames are matched by date to a
    *single* configuration leads to a complication if the DEIMOS
    configuration is changed during the night. I.e., any biases/darks
    taken on the same date will only be associated with the first
    configuration. It will be up to the observer to edit the
    auto-generated pypeit files constructed for each configuration by
    :ref:`pypeit_setup` to ensure that the correct biases and darks
    are included for each configuration. It is possible to include
    the same biases/darks in multiple configurations in the case
    that, e.g., biases/darks were taken in the evening but not in the
    morning after the instrument configuration change.

DEIMOS calibration groups
-------------------------

``PypeIt`` uses the concept of a "calibration group" to define a
complete set of calibration frames (e.g., arcs, flats, biases) and
the science frame to which these calibration frames should be
applied. By default, :ref:`pypeit_setup` uses the configuration
identifier (e.g., ``A``) to assign frames to a single calibration
group. No automated procedure exists to do anything except this.
However, a user can edit the :ref:`pypeit_file` to, within a given
configuration, assign specific calibration frames to specific science
frames using the data in the ``calib`` column. For example, if the
observer takes both evening and morning calibration frames, the
``PypeIt`` user can use the :ref:`pypeit_file` to associate
calibrations taken at the end of the night with the morning
calibrations and vice versa. For DEIMOS specifically, columns with
the ``DATE-OBS`` and ``UTC`` header data for each frame are provided
to assist with this.

Testing
-------

Requirement PD-3 states: "As a user, I want the pipeline to
automatically and correctly associate calibrations with science
data."

``PypeIt`` meets this requirement in the majority of use cases. One
exception to this is given in the warning above with respect to how
bias and dark frames are assigned to "calibration groups".

The test used to demonstrate PD-1 is satisfied
(:ref:`deimos_frames_report`) is also relevant here in that each
directory in the ``PypeIt`` dev suite with DEIMOS data correctly
identifies the frame types and associates them with a single
configuration, all written to a single pypeit file.

To test that ``PypeIt`` can successfully identify multiple
configurations among a set of files, we have added the
``test_setup_keck_deimos_multiconfig`` and
``test_setup_keck_deimos_multiconfig_clean`` tests to
``pypeit/tests/test_setups.py``.

To run these tests:

.. code-block:: bash

    cd pypeit/tests
    pytest test_setup.py::test_setup_keck_deimos_multiconfig -W ignore
    pytest test_setup.py::test_setup_keck_deimos_multiconfig_clean -W ignore

The tests require that you have downloaded the ``PypeIt``
:ref:`dev-suite` and defined the ``PYPEIT_DEV`` environmental
variable that points to the relevant directory.

Both tests collect the names of all files in the following two
directories::

    ${PYPEIT_DEV}/RAW_DATA/keck_deimos/830G_L_8100
    ${PYPEIT_DEV}/RAW_DATA/keck_deimos/830G_L_8400

test_setup_keck_deimos_multiconfig
----------------------------------

The algorithm for this test is as follows:

    1. Use :class:`~pypeit.pypeitsetup.PypeItSetup` to automatically
       identify the configurations for these files.

    2. Check that the code found two configurations and wrote the
       pypeit files for each.

    3. For each configuration:

        a. Read the pypeit file

        b. Check that the name for the setup is correct ('A' or 'B')

        c. Check that the calibration group is the same for all frames ('0' or '1')

test_setup_keck_deimos_multiconfig_clean
----------------------------------------

The algorithm for this test is as follows:

    1. Similar to the previous test, use
       :class:`~pypeit.pypeitsetup.PypeItSetup` to automatically
       identify the configurations for these files.

    2. Check that the code found two configurations.

    3. Check that the only bias frame in the list was correctly
       identified.

    4. Check that the full table containing both configurations
       contains the correct number of files (25).

    5. Check that "cleaning" the configurations of frames that cannot
       be reduced by ``PypeIt`` (those with ``MOSMODE != 'Spectral'``
       or ``AMPMODE != SINGLE:B``), using
       :func:`~pypeit.metadata.PypeItMetaData.clean_configurations`
       does not remove any file because all of the dev-suite files
       are valid.

    6. After artificially changing the metadata for two files so that
       they *do not* satisfy the necessary metadata restrictions,
       check that
       :func:`~pypeit.metadata.PypeItMetaData.clean_configurations`
       removes both of these files.

Because these tests are now included in the ``PypeIt``
:ref:`unit-tests`, these configuration checks are performed by the
developers for every new version of the code.
.. include:: ../include/links.rst

.. _dev_reports:

PypeIt Development Reports
==========================

The following is a list of reports generated for instrument-specific
development of ``PypeIt``.

.. toctree::
   :maxdepth: 1
   
   deimosframes
   mosfireframes
   slitmask_ids
   deimosconfig
   radec_object
   deimos_wavecalib
   add_missing_obj

.. include:: ../include/links.rst

.. _conda_forge:

How to manually update the PypeIt conda-forge feedstock (what to do if the bots are broken)
===========================================================================================

1. Fork `conda-forge/pypeit-feedstock <https://github.com/conda-forge/pypeit-feedstock>`_.
2. Install required tools

.. code-block:: bash

    conda install -c conda-forge conda-smithy

3. Manually update the ``version`` variable in recipe/meta.yaml
4. Update the ``source.sha256`` field in recipe/meta.yaml with the sha256 hash available on
   `pypi <https://pypi.org/project/pypeit/#files>`_

.. code-block:: yaml

    source:
        sha256: new_hash_here

5. Reset the ``build.number`` field to 0 in recipe/meta.yaml

.. code-block:: yaml

    build:
        number: 0

6. Commit your changes
7. Rerender the feedstock

.. code-block:: bash

    conda smithy rerender -c auto

8. Update the dependencies in recipe/meta.yaml if PypeIt's dependencies have changed.
9. Open a PR with these changes.
10. Merge the PR after all tests pass.
.. include:: ../include/links.rst

.. _mosfire_frames_report:

Automated typing of Keck/MOSFIRE frames
=======================================

Version History
---------------

=========   ================   =========== ===========
*Version*   *Author*           *Date*      ``PypeIt``
=========   ================   =========== ===========
1.0         Debora Pelliccia   24 Oct 2021 1.6.1.dev
=========   ================   =========== ===========

----

Basics
------

The general procedure used to assign frames a given type is described
here: :ref:`frame_types`.

MOSFIRE frame typing
--------------------

The primary typing of MOSFIRE frames is performed by
:func:`pypeit.spectrographs.keck_mosfire.KeckMOSFIRESpectrograph.check_frame_type`.
This function checks the values of various header keywords against a
set of criteria used to classify the frame type. The header cards
required for the frame-typing and their associated keyword (when available)
in the :class:`~pypeit.metadata.PypeItMetaData` object are:

    ================   =================
       Header Key       ``fitstbl`` key
    ================   =================
      ``TRUITIME``        ``exptime``
      ``FLATSPEC``       ``lampstat01``
      ``PWSTATA7``          No key
      ``PWSTATA8``          No key
       ``OBJECT``         ``object``
       ``FILTER``         ``filter1``
         No key           ``idname``
    ================   =================

``idname`` is defined using a combination of header keys, including ``PWSTATA7`` and ``PWSTATA8`` (see below).


The criteria used to select each frame type are as follows:

=============   =====================   ============   ============   ============   ============   =============   =============================================
Frame           ``idname``              ``TRUITIME``   ``FLATSPEC``   ``PWSTATA7``   ``PWSTATA8``   ``FILTER``      ``OBJECT``
=============   =====================   ============   ============   ============   ============   =============   =============================================
``science``     ``'object'``              ``>20s``        ``0``          ``0``          ``0``       ``!= 'Dark'``   ``not include 'Flat:Off' or 'lamps off'``
``standard``    ``'object'``              ``<20s``        ``0``          ``0``          ``0``       ``!= 'Dark'``   ``not include 'Flat:Off' or 'lamps off'``
``dark``        ``'dark'``                Not used        ``0``         Not used       Not used      ``'Dark'``     Not used
``pixelflat``   ``'flatlamp'``            Not used        ``1``          ``0``          ``0``       ``!= 'Dark'``   Not used
``pixelflat``   ``'flatlampoff'``         Not used        ``0``          ``0``          ``0``       ``!= 'Dark'``   ``include 'Flat:Off' or 'lamps off'``
``trace``       ``'flatlamp'``            Not used        ``1``          ``0``          ``0``       ``!= 'Dark'``   Not used
``trace``       ``'flatlampoff'``         Not used        ``0``          ``0``          ``0``       ``!= 'Dark'``   ``include 'Flat:Off' or 'lamps off'``
``illumflat``   ``'flatlamp'``            Not used        ``1``          ``0``          ``0``       ``!= 'Dark'``   Not used
``arc``         ``'arclamp'``             Not used        ``0``          ``1``          ``1``       ``!= 'Dark'``   Not used
``arc``         ``'object'``              Not used        ``0``          ``0``          ``0``       ``!= 'Dark'``   ``not include 'Flat:Off' or 'lamps off'``
``tilt``        ``'arclamp'``             Not used        ``0``          ``1``          ``1``       ``!= 'Dark'``   Not used
``tilt``        ``'object'``              Not used        ``0``          ``0``          ``0``       ``!= 'Dark'``   ``not include 'Flat:Off' or 'lamps off'``
=============   =====================   ============   ============   ============   ============   =============   =============================================

Note that, by default, the exposure time (``TRUITIME``) is only used
to distinguish between ``science`` and ``standard`` frames; the criteria
for ``TRUITIME`` can be changed using the ``exprng``
parameter in the :ref:`pypeit_file`; see also :ref:`frame_types`.

Importantly, note that a MOSFIRE frame is never given a ``pinhole``
type. Also note that the criteria used to select ``arc`` and ``tilt``
frames are identical. The same is true for ``pixelflat`` and ``trace``,
while ``illumflat`` frame type is not given to ``'flatlampoff'`` frames.


Testing
-------
- PYPEIT-MOSFIRE
    Requirement PM-4 states: "As a user, I want the pipeline to
    automatically classify my calibrations."

``PypeIt`` meets this requirement as demonstrated by the test at
``pypeit/tests/test_frametype.py``.  To run the test:

.. code-block:: bash

    cd pypeit/tests
    pytest test_frametype.py::test_mosfire -W ignore

The test requires that you have downloaded the ``PypeIt``
:ref:`dev-suite` and defined the ``PYPEIT_DEV`` environmental
variable that points to the relevant directory. The algorithm of the
test is as follows:

    1. Find all the directories in the :ref:`dev-suite` where a selected
       sample of Keck MOSFIRE data is.

    2. For each directory (i.e., instrument setup):

        a. Make sure there is a "by-hand" version of the pypeit file
           for this setup where a human (one of the pypeit
           developers) has ensured the frame types are correct.

        b. Effectively run :ref:`pypeit_setup` on each of the
           instrument setups to construct a new pypeit file with the
           automatically generated frame types.

        c. Read both the by-hand and automatically generated frame
           types from these two pypeit files and check that they are
           identical.

Because this test is now included in the ``PypeIt``
:ref:`unit-tests`, this frame-typing check is performed by the
developers for every new version of the code.
pypeit.core.wavecal package
===========================

Submodules
----------

.. toctree::
   :maxdepth: 4

   pypeit.core.wavecal.autoid
   pypeit.core.wavecal.defs
   pypeit.core.wavecal.kdtree_generator
   pypeit.core.wavecal.patterns
   pypeit.core.wavecal.templates
   pypeit.core.wavecal.waveio
   pypeit.core.wavecal.wv_fitting
   pypeit.core.wavecal.wvutils

Module contents
---------------

.. automodule:: pypeit.core.wavecal
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit package
==============

Subpackages
-----------

.. toctree::
   :maxdepth: 4

   pypeit.bspline
   pypeit.core
   pypeit.display
   pypeit.images
   pypeit.par
   pypeit.scripts
   pypeit.spectrographs

Submodules
----------

.. toctree::
   :maxdepth: 4

   pypeit.alignframe
   pypeit.archive
   pypeit.biasframe
   pypeit.bitmask
   pypeit.calibrations
   pypeit.coadd1d
   pypeit.coadd2d
   pypeit.compiler_version
   pypeit.datamodel
   pypeit.edgetrace
   pypeit.flatfield
   pypeit.fluxcalibrate
   pypeit.history
   pypeit.io
   pypeit.masterframe
   pypeit.metadata
   pypeit.onespec
   pypeit.pypeit
   pypeit.pypeitsetup
   pypeit.pypmsgs
   pypeit.reduce
   pypeit.sampling
   pypeit.sensfunc
   pypeit.setup_package
   pypeit.slittrace
   pypeit.spec2dobj
   pypeit.specobj
   pypeit.specobjs
   pypeit.telescopes
   pypeit.tracepca
   pypeit.utils
   pypeit.wavecalib
   pypeit.wavemodel
   pypeit.wavetilts

Module contents
---------------

.. automodule:: pypeit
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.soar\_goodman module
=========================================

.. automodule:: pypeit.spectrographs.soar_goodman
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.fitting module
==========================

.. automodule:: pypeit.core.fitting
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.specobjs module
======================

.. automodule:: pypeit.specobjs
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.sensfunc module
==============================

.. automodule:: pypeit.scripts.sensfunc
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.sensfunc module
======================

.. automodule:: pypeit.sensfunc
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.load module
=======================

.. automodule:: pypeit.core.load
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.show\_wvcalib module
===================================

.. automodule:: pypeit.scripts.show_wvcalib
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.wavecalib module
=======================

.. automodule:: pypeit.wavecalib
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.arc module
======================

.. automodule:: pypeit.core.arc
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.spectrograph module
========================================

.. automodule:: pypeit.spectrographs.spectrograph
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.mmt\_binospec module
=========================================

.. automodule:: pypeit.spectrographs.mmt_binospec
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.chk\_edges module
================================

.. automodule:: pypeit.scripts.chk_edges
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.compiler\_version module
===============================

.. automodule:: pypeit.compiler_version
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.datacube module
===========================

.. automodule:: pypeit.core.datacube
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.pixels module
=========================

.. automodule:: pypeit.core.pixels
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.flat module
=======================

.. automodule:: pypeit.core.flat
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.p200\_tspec module
=======================================

.. automodule:: pypeit.spectrographs.p200_tspec
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.telescopes module
========================

.. automodule:: pypeit.telescopes
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.chk\_alignments module
=====================================

.. automodule:: pypeit.scripts.chk_alignments
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.obslog module
============================

.. automodule:: pypeit.scripts.obslog
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.chk\_2dslits module
==================================

.. automodule:: pypeit.scripts.chk_2dslits
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.keck\_mosfire module
=========================================

.. automodule:: pypeit.spectrographs.keck_mosfire
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.wht\_isis module
=====================================

.. automodule:: pypeit.spectrographs.wht_isis
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.wavecal.waveio module
=================================

.. automodule:: pypeit.core.wavecal.waveio
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.mmt\_bluechannel module
============================================

.. automodule:: pypeit.spectrographs.mmt_bluechannel
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.alignframe module
========================

.. automodule:: pypeit.alignframe
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.scriptbase module
================================

.. automodule:: pypeit.scripts.scriptbase
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.coadd module
========================

.. automodule:: pypeit.core.coadd
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.images.rawimage module
=============================

.. automodule:: pypeit.images.rawimage
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.procimg module
==========================

.. automodule:: pypeit.core.procimg
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.wavecal.wvutils module
==================================

.. automodule:: pypeit.core.wavecal.wvutils
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.edgetrace module
=======================

.. automodule:: pypeit.edgetrace
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.combine module
==========================

.. automodule:: pypeit.core.combine
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.flexure module
==========================

.. automodule:: pypeit.core.flexure
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.bspline.utilc module
===========================

.. automodule:: pypeit.bspline.utilc
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.telluric module
===========================

.. automodule:: pypeit.core.telluric
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.images package
=====================

Submodules
----------

.. toctree::
   :maxdepth: 4

   pypeit.images.buildimage
   pypeit.images.combineimage
   pypeit.images.detector_container
   pypeit.images.imagebitmask
   pypeit.images.pypeitimage
   pypeit.images.rawimage
   pypeit.images.sciencecube

Module contents
---------------

.. automodule:: pypeit.images
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.images.imagebitmask module
=================================

.. automodule:: pypeit.images.imagebitmask
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.not\_alfosc module
=======================================

.. automodule:: pypeit.spectrographs.not_alfosc
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.moment module
=========================

.. automodule:: pypeit.core.moment
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.extract module
==========================

.. automodule:: pypeit.core.extract
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.ldt\_deveny module
=======================================

.. automodule:: pypeit.spectrographs.ldt_deveny
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.display.display module
=============================

.. automodule:: pypeit.display.display
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.multislit\_flexure module
========================================

.. automodule:: pypeit.scripts.multislit_flexure
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.flatfield module
=======================

.. automodule:: pypeit.flatfield
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.images.pypeitimage module
================================

.. automodule:: pypeit.images.pypeitimage
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.images.combineimage module
=================================

.. automodule:: pypeit.images.combineimage
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.flux\_setup module
=================================

.. automodule:: pypeit.scripts.flux_setup
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.p200\_dbsp module
======================================

.. automodule:: pypeit.spectrographs.p200_dbsp
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.collate module
==========================

.. automodule:: pypeit.core.collate
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.display.ginga\_plugins module
====================================

.. automodule:: pypeit.display.ginga_plugins
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.identify module
==============================

.. automodule:: pypeit.scripts.identify
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.magellan\_fire module
==========================================

.. automodule:: pypeit.spectrographs.magellan_fire
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.gemini\_flamingos module
=============================================

.. automodule:: pypeit.spectrographs.gemini_flamingos
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.wavecal.kdtree\_generator module
============================================

.. automodule:: pypeit.core.wavecal.kdtree_generator
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.lbt\_mods module
=====================================

.. automodule:: pypeit.spectrographs.lbt_mods
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.setup\_package module
============================

.. automodule:: pypeit.setup_package
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.install\_ql\_masters module
==========================================

.. automodule:: pypeit.scripts.install_ql_masters
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.basis module
========================

.. automodule:: pypeit.core.basis
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.wavecal.templates module
====================================

.. automodule:: pypeit.core.wavecal.templates
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.parse module
========================

.. automodule:: pypeit.core.parse
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.specobj module
=====================

.. automodule:: pypeit.specobj
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.ntt\_efosc2 module
=======================================

.. automodule:: pypeit.spectrographs.ntt_efosc2
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.view\_fits module
================================

.. automodule:: pypeit.scripts.view_fits
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.images.detector\_container module
========================================

.. automodule:: pypeit.images.detector_container
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.bitmask module
=====================

.. automodule:: pypeit.bitmask
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.gui.skysub\_regions module
======================================

.. automodule:: pypeit.core.gui.skysub_regions
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.wavecal.wv\_fitting module
======================================

.. automodule:: pypeit.core.wavecal.wv_fitting
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.compare\_sky module
==================================

.. automodule:: pypeit.scripts.compare_sky
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.par.pypeitpar module
===========================

.. automodule:: pypeit.par.pypeitpar
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.keck\_lris module
======================================

.. automodule:: pypeit.spectrographs.keck_lris
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.coadd\_2dspec module
===================================

.. automodule:: pypeit.scripts.coadd_2dspec
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.show\_1dspec module
==================================

.. automodule:: pypeit.scripts.show_1dspec
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.pypeit module
====================

.. automodule:: pypeit.pypeit
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.flux\_calib module
=================================

.. automodule:: pypeit.scripts.flux_calib
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.vlt\_xshooter module
=========================================

.. automodule:: pypeit.spectrographs.vlt_xshooter
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.collate\_1d module
=================================

.. automodule:: pypeit.scripts.collate_1d
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts package
======================

Submodules
----------

.. toctree::
   :maxdepth: 4

   pypeit.scripts.chk_2dslits
   pypeit.scripts.chk_alignments
   pypeit.scripts.chk_edges
   pypeit.scripts.chk_flats
   pypeit.scripts.chk_for_calibs
   pypeit.scripts.chk_wavecalib
   pypeit.scripts.coadd_1dspec
   pypeit.scripts.coadd_2dspec
   pypeit.scripts.coadd_datacube
   pypeit.scripts.collate_1d
   pypeit.scripts.compare_sky
   pypeit.scripts.flux_calib
   pypeit.scripts.flux_setup
   pypeit.scripts.identify
   pypeit.scripts.install_ql_masters
   pypeit.scripts.install_telluric
   pypeit.scripts.lowrdx_skyspec
   pypeit.scripts.multislit_flexure
   pypeit.scripts.obslog
   pypeit.scripts.parse_calib_id
   pypeit.scripts.qa_html
   pypeit.scripts.ql_keck_mosfire
   pypeit.scripts.ql_keck_nires
   pypeit.scripts.ql_mos
   pypeit.scripts.run_pypeit
   pypeit.scripts.scriptbase
   pypeit.scripts.sensfunc
   pypeit.scripts.setup
   pypeit.scripts.show_1dspec
   pypeit.scripts.show_2dspec
   pypeit.scripts.show_arxiv
   pypeit.scripts.show_wvcalib
   pypeit.scripts.skysub_regions
   pypeit.scripts.tellfit
   pypeit.scripts.trace_edges
   pypeit.scripts.utils
   pypeit.scripts.view_fits

Module contents
---------------

.. automodule:: pypeit.scripts
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.images.buildimage module
===============================

.. automodule:: pypeit.images.buildimage
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.archive module
=====================

.. automodule:: pypeit.archive
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.opticalmodel module
========================================

.. automodule:: pypeit.spectrographs.opticalmodel
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.keck\_deimos module
========================================

.. automodule:: pypeit.spectrographs.keck_deimos
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.history module
=====================

.. automodule:: pypeit.history
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.tellfit module
=============================

.. automodule:: pypeit.scripts.tellfit
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.ql\_keck\_nires module
=====================================

.. automodule:: pypeit.scripts.ql_keck_nires
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.parse\_calib\_id module
======================================

.. automodule:: pypeit.scripts.parse_calib_id
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.run\_pypeit module
=================================

.. automodule:: pypeit.scripts.run_pypeit
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.wavecal.autoid module
=================================

.. automodule:: pypeit.core.wavecal.autoid
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.shane\_kast module
=======================================

.. automodule:: pypeit.spectrographs.shane_kast
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.fluxcalibrate module
===========================

.. automodule:: pypeit.fluxcalibrate
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.ql\_mos module
=============================

.. automodule:: pypeit.scripts.ql_mos
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.gtc\_osiris module
=======================================

.. automodule:: pypeit.spectrographs.gtc_osiris
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.display package
======================

Submodules
----------

.. toctree::
   :maxdepth: 4

   pypeit.display.display
   pypeit.display.ginga_plugins

Module contents
---------------

.. automodule:: pypeit.display
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.magellan\_mage module
==========================================

.. automodule:: pypeit.spectrographs.magellan_mage
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.slitdesign\_matching module
=======================================

.. automodule:: pypeit.core.slitdesign_matching
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core package
===================

Subpackages
-----------

.. toctree::
   :maxdepth: 4

   pypeit.core.gui
   pypeit.core.wavecal

Submodules
----------

.. toctree::
   :maxdepth: 4

   pypeit.core.arc
   pypeit.core.basis
   pypeit.core.coadd
   pypeit.core.collate
   pypeit.core.combine
   pypeit.core.convert_DEIMOSsavfiles
   pypeit.core.datacube
   pypeit.core.extract
   pypeit.core.fitting
   pypeit.core.flat
   pypeit.core.flexure
   pypeit.core.flux_calib
   pypeit.core.framematch
   pypeit.core.load
   pypeit.core.meta
   pypeit.core.moment
   pypeit.core.parse
   pypeit.core.pca
   pypeit.core.pixels
   pypeit.core.plot
   pypeit.core.procimg
   pypeit.core.pydl
   pypeit.core.qa
   pypeit.core.skysub
   pypeit.core.slitdesign_matching
   pypeit.core.telluric
   pypeit.core.trace
   pypeit.core.tracewave
   pypeit.core.wave

Module contents
---------------

.. automodule:: pypeit.core
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.show\_arxiv module
=================================

.. automodule:: pypeit.scripts.show_arxiv
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.chk\_flats module
================================

.. automodule:: pypeit.scripts.chk_flats
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.bspline.setup\_package module
====================================

.. automodule:: pypeit.bspline.setup_package
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.wavetilts module
=======================

.. automodule:: pypeit.wavetilts
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.par.util module
======================

.. automodule:: pypeit.par.util
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.util module
================================

.. automodule:: pypeit.spectrographs.util
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spec2dobj module
=======================

.. automodule:: pypeit.spec2dobj
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.reduce module
====================

.. automodule:: pypeit.reduce
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.bok\_bc module
===================================

.. automodule:: pypeit.spectrographs.bok_bc
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.gemini\_gnirs module
=========================================

.. automodule:: pypeit.spectrographs.gemini_gnirs
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.wave module
=======================

.. automodule:: pypeit.core.wave
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.flux\_calib module
==============================

.. automodule:: pypeit.core.flux_calib
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.calibrations module
==========================

.. automodule:: pypeit.calibrations
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.ql\_keck\_mosfire module
=======================================

.. automodule:: pypeit.scripts.ql_keck_mosfire
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.vlt\_sinfoni module
========================================

.. automodule:: pypeit.spectrographs.vlt_sinfoni
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.bspline.utilpy module
============================

.. automodule:: pypeit.bspline.utilpy
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.chk\_wavecalib module
====================================

.. automodule:: pypeit.scripts.chk_wavecalib
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.sampling module
======================

.. automodule:: pypeit.sampling
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.par package
==================

Submodules
----------

.. toctree::
   :maxdepth: 4

   pypeit.par.parset
   pypeit.par.pypeitpar
   pypeit.par.util

Module contents
---------------

.. automodule:: pypeit.par
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.utils module
===================

.. automodule:: pypeit.utils
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.plot module
=======================

.. automodule:: pypeit.core.plot
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.coadd\_1dspec module
===================================

.. automodule:: pypeit.scripts.coadd_1dspec
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.skysub\_regions module
=====================================

.. automodule:: pypeit.scripts.skysub_regions
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.pypeitsetup module
=========================

.. automodule:: pypeit.pypeitsetup
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.meta module
=======================

.. automodule:: pypeit.core.meta
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.convert\_DEIMOSsavfiles module
==========================================

.. automodule:: pypeit.core.convert_DEIMOSsavfiles
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.vlt\_fors module
=====================================

.. automodule:: pypeit.spectrographs.vlt_fors
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit
======

.. toctree::
   :maxdepth: 4

   pypeit
pypeit.core.framematch module
=============================

.. automodule:: pypeit.core.framematch
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.tng\_dolores module
========================================

.. automodule:: pypeit.spectrographs.tng_dolores
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.qa module
=====================

.. automodule:: pypeit.core.qa
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.bspline.bspline module
=============================

.. automodule:: pypeit.bspline.bspline
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.chk\_for\_calibs module
======================================

.. automodule:: pypeit.scripts.chk_for_calibs
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.skysub module
=========================

.. automodule:: pypeit.core.skysub
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.keck\_nires module
=======================================

.. automodule:: pypeit.spectrographs.keck_nires
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.io module
================

.. automodule:: pypeit.io
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.pypmsgs module
=====================

.. automodule:: pypeit.pypmsgs
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.utils module
===========================

.. automodule:: pypeit.scripts.utils
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.mmt\_mmirs module
======================================

.. automodule:: pypeit.spectrographs.mmt_mmirs
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.datamodel module
=======================

.. automodule:: pypeit.datamodel
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.lowrdx\_skyspec module
=====================================

.. automodule:: pypeit.scripts.lowrdx_skyspec
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.images.sciencecube module
================================

.. automodule:: pypeit.images.sciencecube
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.gemini\_gmos module
========================================

.. automodule:: pypeit.spectrographs.gemini_gmos
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.par.parset module
========================

.. automodule:: pypeit.par.parset
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.slittrace module
=======================

.. automodule:: pypeit.slittrace
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.keck\_kcwi module
======================================

.. automodule:: pypeit.spectrographs.keck_kcwi
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.wavecal.patterns module
===================================

.. automodule:: pypeit.core.wavecal.patterns
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.coadd\_datacube module
=====================================

.. automodule:: pypeit.scripts.coadd_datacube
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.coadd2d module
=====================

.. automodule:: pypeit.coadd2d
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.metadata module
======================

.. automodule:: pypeit.metadata
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.keck\_hires module
=======================================

.. automodule:: pypeit.spectrographs.keck_hires
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.mdm\_osmos module
======================================

.. automodule:: pypeit.spectrographs.mdm_osmos
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.biasframe module
=======================

.. automodule:: pypeit.biasframe
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.install\_telluric module
=======================================

.. automodule:: pypeit.scripts.install_telluric
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs package
============================

Submodules
----------

.. toctree::
   :maxdepth: 4

   pypeit.spectrographs.bok_bc
   pypeit.spectrographs.gemini_flamingos
   pypeit.spectrographs.gemini_gmos
   pypeit.spectrographs.gemini_gnirs
   pypeit.spectrographs.gtc_osiris
   pypeit.spectrographs.keck_deimos
   pypeit.spectrographs.keck_hires
   pypeit.spectrographs.keck_kcwi
   pypeit.spectrographs.keck_lris
   pypeit.spectrographs.keck_mosfire
   pypeit.spectrographs.keck_nires
   pypeit.spectrographs.keck_nirspec
   pypeit.spectrographs.lbt_luci
   pypeit.spectrographs.lbt_mods
   pypeit.spectrographs.ldt_deveny
   pypeit.spectrographs.magellan_fire
   pypeit.spectrographs.magellan_mage
   pypeit.spectrographs.mdm_osmos
   pypeit.spectrographs.mmt_binospec
   pypeit.spectrographs.mmt_bluechannel
   pypeit.spectrographs.mmt_mmirs
   pypeit.spectrographs.not_alfosc
   pypeit.spectrographs.ntt_efosc2
   pypeit.spectrographs.opticalmodel
   pypeit.spectrographs.p200_dbsp
   pypeit.spectrographs.p200_tspec
   pypeit.spectrographs.shane_kast
   pypeit.spectrographs.slitmask
   pypeit.spectrographs.soar_goodman
   pypeit.spectrographs.spectrograph
   pypeit.spectrographs.tng_dolores
   pypeit.spectrographs.util
   pypeit.spectrographs.vlt_fors
   pypeit.spectrographs.vlt_sinfoni
   pypeit.spectrographs.vlt_xshooter
   pypeit.spectrographs.wht_isis

Module contents
---------------

.. automodule:: pypeit.spectrographs
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.trace\_edges module
==================================

.. automodule:: pypeit.scripts.trace_edges
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.gui.object\_find module
===================================

.. automodule:: pypeit.core.gui.object_find
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.masterframe module
=========================

.. automodule:: pypeit.masterframe
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.show\_2dspec module
==================================

.. automodule:: pypeit.scripts.show_2dspec
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.qa\_html module
==============================

.. automodule:: pypeit.scripts.qa_html
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.wavemodel module
=======================

.. automodule:: pypeit.wavemodel
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.wavecal.defs module
===============================

.. automodule:: pypeit.core.wavecal.defs
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.tracewave module
============================

.. automodule:: pypeit.core.tracewave
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.pydl module
=======================

.. automodule:: pypeit.core.pydl
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.coadd1d module
=====================

.. automodule:: pypeit.coadd1d
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.onespec module
=====================

.. automodule:: pypeit.onespec
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.bspline package
======================

Submodules
----------

.. toctree::
   :maxdepth: 4

   pypeit.bspline.bspline
   pypeit.bspline.setup_package
   pypeit.bspline.utilc
   pypeit.bspline.utilpy

Module contents
---------------

.. automodule:: pypeit.bspline
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.pca module
======================

.. automodule:: pypeit.core.pca
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.scripts.setup module
===========================

.. automodule:: pypeit.scripts.setup
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.lbt\_luci module
=====================================

.. automodule:: pypeit.spectrographs.lbt_luci
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.gui package
=======================

Submodules
----------

.. toctree::
   :maxdepth: 4

   pypeit.core.gui.identify
   pypeit.core.gui.object_find
   pypeit.core.gui.skysub_regions

Module contents
---------------

.. automodule:: pypeit.core.gui
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.slitmask module
====================================

.. automodule:: pypeit.spectrographs.slitmask
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.gui.identify module
===============================

.. automodule:: pypeit.core.gui.identify
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.spectrographs.keck\_nirspec module
=========================================

.. automodule:: pypeit.spectrographs.keck_nirspec
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.tracepca module
======================

.. automodule:: pypeit.tracepca
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
pypeit.core.trace module
========================

.. automodule:: pypeit.core.trace
   :members:
   :private-members:
   :undoc-members:
   :show-inheritance:
