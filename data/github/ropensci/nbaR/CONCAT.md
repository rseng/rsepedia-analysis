# R client for the Netherlands Biodiversity API <img src="https://raw.githubusercontent.com/naturalis/nbaR/master/other/img/logo.png" height="150" align="right"/>

[![Build Status](https://travis-ci.org/ropensci/nbaR.svg?branch=master)](https://travis-ci.org/ropensci/nbaR)
[![Coverage Status](https://coveralls.io/repos/github/ropensci/nbaR/badge.svg?branch=master)](https://coveralls.io/github/ropensci/nbaR?branch=master)
[![Project Status: Active – The project has reached a stable, usable
state and is being actively
developed.](http://www.repostatus.org/badges/latest/active.svg)](http://www.repostatus.org/#active)
[![](https://badges.ropensci.org/257_status.svg)](https://github.com/ropensci/onboarding/issues/257)

## Overview 
This package provides access to the digitised Natural
History collection at the Naturalis Biodiversity Center via tha
[Netherlands Biodiversity API](http://docs.biodiversitydata.nl/en/latest).
- API version: v2
- Package version: 0.1.0

### Prerequisites
If not already done, install the `devtools` package with the following command
```R
if(!require(devtools)) { install.packages("devtools") }
```

### Installation of the API package
Execute
```R
library(devtools)
install_github("ropensci/nbaR", build_vignettes=TRUE)
```

### Using the package
After installation, the package can be loaded as follows:
```R
library(nbaR)
```

### Documentation 
Documentation is provided in the package vignettes,
see 
```R 
vignette(package='nbaR') 
``` 
Note that, due to size
limitations, not all documentation is in the package vignettes. Full
documentation can be found online
[here](https://docs.ropensci.org/nbaR/).

## Note 
Note: parts of this API client have been generated by the
[swagger-codegen](https://github.com/swagger-api/swagger-codegen)
project.  The code for classes and endpoints was generated using
customised *mustache* templates and a customised swagger codegen
engine. Information about the code generation process in this project
can be found
[here](https://github.com/ropensci/nbaR/tree/master/other/swagger/README.md).

## Support 
Bug reports, questions or suggestions can be submitted to
the [issue tracker](https://github.com/ropensci/nbaR/issues/new) or
via email to nba@naturalis.nl

----

[![ropensci_footer](https://ropensci.org/public_images/ropensci_footer.png)](https://ropensci.org)
nbaR 0.1.0 (2019-04-18)
=========================

### NEW FEATURES

  * Completed package changes for ROpenscince revisions
    [reviewer's comments here](https://github.com/ropensci/software-review/issues/257)
  * Implemented low-level API access through wrapper functions

### MINOR IMPROVEMENTS

### BUG FIXES

### DEPRECATED AND DEFUNCT

### DOCUMENTATION FIXES

   * Re-arrranged documentation in vignettes

nbaR 0.0.0 (2018-10-04)
=========================

### NEW FEATURES

  * Prepared for submission to ROpenScience according to the 
    [dev guide](https://ropensci.github.io/dev_guide/)

### MINOR IMPROVEMENTS

### BUG FIXES

### DEPRECATED AND DEFUNCT

### DOCUMENTATION FIXES

---
title: 'nbaR - R client library for the Netherlands Biodiversity API'
tags:
  - biodiversity informatics
  - web service
  - R
  - client library
authors:
 - name: Hannes Hettling
   orcid: 0000-0003-4144-2238
   affiliation: 1
 - name: Daphne Duin
   affiliation: 1
 - name: Maarten Schermer
   affiliation: 1
 - name: Rutger Aldo Vos
   orcid: 0000-0001-9254-7318
   affiliation: 1
affiliations:
 - name: Naturalis Biodiversity Center, P.O. Box 9517, 2300 RA Leiden, The Netherlands
   index: 1
date: 1 April 2019
bibliography: paper.bib
---

# Summary

## The Netherlands Biodiversity API

The Netherlands Biodiversity API (NBA) facilitates access to the
Natural History Collection at Naturalis Biodiversity Center. Next to
museum specimen records and metadata, access to taxonomic
classification and nomenclature, to geographical information, and to
multimedia files is provided. By using the powerful Elasticsearch
engine, the NBA facilitates searching for collection- and biodiversity
data in near real-time. Furthermore, by incorporating information from
taxonomic databases, taxonomic name resolution can be accomplished
with the NBA. Persistent Uniform Resource Identifiers (PURLs) ensure
that each specimen accessible via the NBA is represented by a citeable
unambiguous web reference. 

[detailed documentation](http://docs.biodiversitydata.nl/).

## R access

The R programming language is established as a common tool in
scientific research, with growing adoption in
biodiversity research.  To ease the threshold using our data via the  NBA for
researchers, we developed this R client. 
Hi @sckott @DomBennett @mbjoseph, 
thank you for the thorough evaluation of the package. 
The new version of the [nbaR package](https://github.com/naturalis/nbaR) 
aims to address all of these issues. For a better overview, I cpoied your comment into github issues summarised in the milestone [Ropenscience-revision](https://github.com/naturalis/nbaR/issues?q=is%3Aclosed+milestone%3ARopenscience-revision). 
This resulted in the following major changes: 

**Wrapper functions**
The package now features low-level API access using function wrappers which are 
more easy to use. For each endpoint, there is one wrapper which can be called directly without any `QuerySpec`, `QueryCondition` etc. objects. For complex structures, the wrappers return native R datatypes, such as `data.frame` (with list columns) or `list` (types are configurable by the user) instead of `R6` objects such as `Specimen` or `Taxon`. Documentation on the wrappers can be found in the [reference](https://naturalis.github.io/nbaR/reference/index.html) and further description is provided in the [get started vignette](https://naturalis.github.io/nbaR/articles/nbaR.html).

This is documented in the following issues: [#18](https://github.com/naturalis/nbaR/issues/18), [#32](https://github.com/naturalis/nbaR/issues/32), [#34](https://github.com/naturalis/nbaR/issues/34)

**Documentation**
* The main vignette has been split into smaller parts. Documentation is now spread over 5 pages: *Getting started*, *Objects and advanced queries*, *services summary*, *sharks workflow*, *tomato workflow* ([issue #17](https://github.com/naturalis/nbaR/issues/17), [issue #36](https://github.com/naturalis/nbaR/issues/36), [issue #34](https://github.com/naturalis/nbaR/issues/34)).
* Help files: Have been improved. Extended descriptions have been added for the main model datatypes (`Specimen`, `Taxon`, `Multimedia`, `Geo` and also for `QuerySpec` and `QueryCondition`). These changes have to be made in the code annotations of the API itself, therefore not yet all of the classes are documented in detail. Since I am not the developer of the API, this has to be communicated and done by someone else; we are working on completing more descriptions. However, many classes will never be used by the `nbaR` user: For example, almost no records have a `LithoStratigraphy` field, thus the user will in most cases not come across this object.([issue #24](https://github.com/naturalis/nbaR/issues/24)). 
* More information on operators is now given in the [vignette](https://naturalis.github.io/nbaR/articles/apiclient.html#operators) ([issue #28](https://github.com/naturalis/nbaR/issues/28)).
* Typos: [issue #46](https://github.com/naturalis/nbaR/issues/46), [issue #35](https://github.com/naturalis/nbaR/issues/35).
* Different clients are now better explained: ([issue #45](https://github.com/naturalis/nbaR/issues/45)).
* Pkdown issues have been resolved. In addition, client classes and model classes are now better organised in the [reference page](https://naturalis.github.io/nbaR/reference/index.html) ([issue #23](https://github.com/naturalis/nbaR/issues/23)).
* Character length in vignette code has been reduced to max 80 chrs per line ([issue #37](https://github.com/naturalis/nbaR/issues/37)).
* Empty query example at start of vignette has been removed ([issue #38](https://github.com/naturalis/nbaR/issues/38)).
* Size argument now better explained in shark vignette ([issue #47](https://github.com/naturalis/nbaR/issues/47)).

**Tests/Checks/Coverage**
* Unit tests failed if the NBA was down, thus we now do a ping in the unit tests to test beforehand if the NBA is alive ([issue #19](https://github.com/naturalis/nbaR/issues/19).
* Check results: `R CMD CHECK` now proceeds without errors, warnings or notes ([issue #20](https://github.com/naturalis/nbaR/issues/20)).
* Spell-check was done ([issue #22](https://github.com/naturalis/nbaR/issues/22)).
* Goodpractice results were improved ([issue #21](https://github.com/naturalis/nbaR/issues/21)). However, it was not possible to cut all lines of code to 80 characters, due to autogenerated code.

**Miscellaneuos** 
* dwca download functions now suppress excessive output ([issue #44](https://github.com/naturalis/nbaR/issues/44)).
* Much of the duplicated code is now avoided by having rewritten the `fromJSONString` and `fromList` methods in the templates ([issue #33](https://github.com/naturalis/nbaR/issues/37)).
* Classes now have a `print` method, which lists all members (and their datatypes) and available functions in a nice way ([issue #39](https://github.com/naturalis/nbaR/issues/39)).
* A `QueryCondition` object can now also be created with a named list ([issue #29](https://github.com/naturalis/nbaR/issues/29)).
* Warnings for function `geo_age` are now more clear ([issue #48](https://github.com/naturalis/nbaR/issues/48)).
* Function `find_by_ids` can now also take a vector of ids as argument ([issue #41](https://github.com/naturalis/nbaR/issues/41)).
* Map of tomatoes now added to tomato vignette ([issue #27](https://github.com/naturalis/nbaR/issues/27)).
* Reduced R package size etc., ([issue #31](https://github.com/naturalis/nbaR/issues/31)).

**What I did not do**
* Schematic code example for clients: Since we have now a *Getting Started* using the wrapper functions and instanciating clients is in the advanced parts, I believe this is not necessary anymore ([issue #26](https://github.com/naturalis/nbaR/issues/26)).
* Returning `data.frame` for `get_distinct_values_per_group` and `count_distinct_values_per_group`. This is now done in the wrappers.
* More ideomatic code for specifying query parameters: I think the way to pass query parameters as a list is sufficient, see also [issue #40](https://github.com/naturalis/nbaR/issues/40).

I hope you agree with me that these changes significantly improved the usage of this package. Thanks again for taking the time to review.

Best, 

Hannes

R client for the Netherlands Biodiversity API
---------------------------------------------
This is a placeholder for an 'application note', i.e. a short manuscript for scholarly publication that presents the
functionality of the package and functions as a citable resource. We aim to target MEE and produce a manuscript of
roughly the same scale as this: https://besjournals.onlinelibrary.wiley.com/doi/epdf/10.1111/2041-210X.12310
# Code generation for nbaR with Swagger

Parts of the package `nbaR` have been generated using 
[Swagger codegen](https://github.com/swagger-api/swagger-codegen).
Advantages of this processare:

 * Model classes and API endpoints are implemented in a standard, unified manner
 * Whenever the API (and annotations) is updated, the client can be automatically 
   re-generated using Swagger. 

## Swagger
[Swagger](https://swagger.io/) is an API developer suite 
to design, build, document, test, and standardize APIs and API workflows.
A central component of Swagger is to annotate the elements of an API, such as 
data models and endpoints according to the 
[OpenAPI specification](https://swagger.io/docs/specification/about/). 
Code annotation is done in the code of the API itsself, see 
[here](https://github.com/naturalis/naturalis_data_api/blob/V2_master/nl.naturalis.nba.rest/src/main/java/nl/naturalis/nba/rest/resource/SpecimenResource.java) 
for an example of an annotated resource class in the NBA. 
Swagger parses the annotations and stores a meta-description of the entire API
into a single `json` or `yaml` file. The NBA is specified by the *swagger file*
reachable via this endpoint: http://api.biodiversitydata.nl/v2/reference-doc
We use this description, among others, to auto-generate endpoint documentation
for the NBA: http://docs.biodiversitydata.nl/endpoints-reference/

## Swagger codegen
The [Swagger codegen project](https://github.com/swagger-api/swagger-codegen)
allows for automatic generation of API client code
using the *swagger file* containing the API specification, 
a *codegen engine*, and a number of template files. The below figure shows a
schematic overview of the swagger codegen process:

![](https://raw.githubusercontent.com/naturalis/nbaR/master/other/img/nbaR_codegen.png)

## Templates
R package file templates were taken from Swagger codegen and were adapted for this client.
Files can be found [here](https://github.com/naturalis/nbaR/tree/master/other/swagger/swagger-templates).

## Codegen engine
The Swagger codegen engine was modified to fit this client's needs.
The code of the customised codegen engine can be found 
[here](https://github.com/naturalis/nbaR/tree/master/other/swagger/codegen/nbaRcodegen).
# Swagger Codegen for the nbaRcodegen library

## Overview
This is a boiler-plate project to generate your own client library with Swagger.  Its goal is
to get you started with the basic plumbing so you can put in your own logic.  It won't work without
your changes applied.

## What's Swagger?
The goal of Swagger™ is to define a standard, language-agnostic interface to REST APIs which allows both humans and computers to discover and understand the capabilities of the service without access to source code, documentation, or through network traffic inspection. When properly defined via Swagger, a consumer can understand and interact with the remote service with a minimal amount of implementation logic. Similar to what interfaces have done for lower-level programming, Swagger removes the guesswork in calling the service.


Check out [OpenAPI-Spec](https://github.com/OAI/OpenAPI-Specification) for additional information about the Swagger project, including additional libraries with support for other languages and more. 

## How do I use this?
At this point, you've likely generated a client setup.  It will include something along these lines:

```
.
|- README.md    // this file
|- pom.xml      // build script
|-- src
|--- main
|---- java
|----- nl.naturalis.nba.codegen.NbarcodegenGenerator.java // generator file
|---- resources
|----- nbaRcodegen // template files
|----- META-INF
|------ services
|------- io.swagger.codegen.CodegenConfig
```

You _will_ need to make changes in at least the following:

`NbarcodegenGenerator.java`

Templates in this folder:

`src/main/resources/nbaRcodegen`

Once modified, you can run this:

```
mvn package
```

In your generator project.  A single jar file will be produced in `target`.  You can now use that with codegen:

```
java -cp /path/to/swagger-codegen-cli.jar:/path/to/your.jar io.swagger.codegen.Codegen -l nbaRcodegen -i /path/to/swagger.yaml -o ./test
```

Now your templates are available to the client generator and you can write output values

## But how do I modify this?
The `NbarcodegenGenerator.java` has comments in it--lots of comments.  There is no good substitute
for reading the code more, though.  See how the `NbarcodegenGenerator` implements `CodegenConfig`.
That class has the signature of all values that can be overridden.

For the templates themselves, you have a number of values available to you for generation.
You can execute the `java` command from above while passing different debug flags to show
the object you have available during client generation:

```
# The following additional debug options are available for all codegen targets:
# -DdebugSwagger prints the OpenAPI Specification as interpreted by the codegen
# -DdebugModels prints models passed to the template engine
# -DdebugOperations prints operations passed to the template engine
# -DdebugSupportingFiles prints additional data passed to the template engine

java -DdebugOperations -cp /path/to/swagger-codegen-cli.jar:/path/to/your.jar io.swagger.codegen.Codegen -l nbaRcodegen -i /path/to/swagger.yaml -o ./test
```

Will, for example, output the debug info for operations.  You can use this info
in the `api.mustache` file.<!-- IF THIS INVOLVES AUTHENTICATION: DO NOT SHARE YOUR USERNAME/PASSWORD, OR API KEYS/TOKENS IN THIS ISSUE - MOST LIKELY THE MAINTAINER WILL HAVE THEIR OWN EQUIVALENT KEY -->

<!-- If you've updated a file in the man-roxygen directory, make sure to update the man/ files by running devtools::document() or similar as .Rd files should be affected by your change -->

<!--- Provide a general summary of your changes in the Title above -->

## Description
<!--- Describe your changes in detail -->

## Related Issue
<!--- if this closes an issue make sure include e.g., "fix #4"
or similar - or if just relates to an issue make sure to mention
it like "#4" -->

## Example
<!--- if introducing a new feature or changing behavior of existing
methods/functions, include an example if possible to do in brief form -->

<!--- Did you remember to include tests? Unless you're just changing
grammar, please include new tests for your change -->
<!-- IF THIS INVOLVES AUTHENTICATION: DO NOT SHARE YOUR USERNAME/PASSWORD, OR API KEYS/TOKENS IN THIS ISSUE - MOST LIKELY THE MAINTAINER WILL HAVE THEIR OWN EQUIVALENT KEY -->

<!-- If this issue relates to usage of the package, whether a question, bug or similar, along with your query, please paste your devtools::session_info() or sessionInfo() into the code block below, AND include a reproducible example (consider using a "reprex" https://cran.rstudio.com/web/packages/reprex/) If not, delete all this and proceed :) -->

<details> <summary><strong>Session Info</strong></summary>

```r

```
</details>
